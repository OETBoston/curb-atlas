import{d as ks,a as gi,f as Zi,c as _x}from"../chunks/DfK64k8h.js";import{i as mE}from"../chunks/C20MRRI3.js";import{h as zo,F as _E,aG as bC,k as gx,J as lm,_ as gE,a as Mg,t as nt,N as tm,G as wC,H as TC,I as O2,K as cm,e as im,a9 as yE,ay as EC,ag as z2,c as SC,b as J0,s as IC,aH as vE,aw as yx,aI as xE,a5 as K0,aC as AC,aJ as CC,aK as MC,aL as PC,aM as Kl,r as bE,p as wE,aN as n0,a8 as TE,as as Q0,aO as LC,av as RC,d as DC,aP as OC,aA as vx,i as ra,a6 as zC,v as kC,aQ as FC,ao as BC,aR as NC,aS as VC,aT as UC,aU as jC,aV as GC,aW as qC,Q as Yr,O as ka,B as Ht,D as zi,C as Ut,y as Co,u as ms,aF as Xr,aD as ao,A as Mo,z as Sn,ah as Wd,j as um,aX as HC}from"../chunks/D0m3W1uE.js";import{o as qg}from"../chunks/BOgAmJJe.js";import{i as Fn,p as Nc}from"../chunks/DRBn7qDX.js";import{s as ZC}from"../chunks/BNPYCbKv.js";import{d as Fs,s as Qo,e as k2}from"../chunks/BbWRZkgL.js";import{B as $C}from"../chunks/Drf3laOX.js";let F2=!1;function WC(){F2||(F2=!0,document.addEventListener("reset",m=>{Promise.resolve().then(()=>{if(!m.defaultPrevented)for(const y of m.target.elements)y.__on_r?.()})},{capture:!0}))}function EE(m,y,b){zo&&_E();var S=new $C(m),M=!bC();gx(()=>{var R=y();M&&R!==null&&typeof R=="object"&&(R={}),S.ensure(R,b)})}function jc(m,y){return y}function XC(m,y,b){for(var S=[],M=y.length,R,k=y.length,o=0;o<M;o++){let ie=y[o];wE(ie,()=>{if(R){if(R.pending.delete(ie),R.done.add(ie),R.pending.size===0){var re=m.outrogroups;ex(yx(R.done)),re.delete(R),re.size===0&&(m.outrogroups=null)}}else k-=1},!1)}if(k===0){var G=S.length===0&&b!==null;if(G){var Z=b,ee=Z.parentNode;RC(ee),ee.append(Z),m.items.clear()}ex(y,!G)}else R={pending:new Set(y),done:new Set},(m.outrogroups??=new Set).add(R)}function ex(m,y=!0){for(var b=0;b<m.length;b++)DC(m[b],y)}var B2;function Gc(m,y,b,S,M,R=null){var k=m,o=new Map,G=(y&vE)!==0;if(G){var Z=m;k=zo?lm(gE(Z)):Z.appendChild(Mg())}zo&&_E();var ee=null,ie=tm(()=>{var Te=b();return xE(Te)?Te:Te==null?[]:yx(Te)}),re,ue=!0;function oe(){K.fallback=ee,YC(K,re,k,y,S),ee!==null&&(re.length===0?(ee.f&Kl)===0?bE(ee):(ee.f^=Kl,rm(ee,null,k)):wE(ee,()=>{ee=null}))}var ge=gx(()=>{re=nt(ie);var Te=re.length;let Le=!1;if(zo){var Oe=wC(k)===TC;Oe!==(Te===0)&&(k=O2(),lm(k),cm(!1),Le=!0)}for(var Ae=new Set,ze=SC,Fe=IC(),Ye=0;Ye<Te;Ye+=1){zo&&im.nodeType===yE&&im.data===EC&&(k=im,Le=!0,cm(!1));var it=re[Ye],jt=S(it,Ye),Rt=ue?null:o.get(jt);Rt?(Rt.v&&z2(Rt.v,it),Rt.i&&z2(Rt.i,Ye),Fe&&ze.skipped_effects.delete(Rt.e)):(Rt=JC(o,ue?k:B2??=Mg(),it,jt,Ye,M,y,b),ue||(Rt.e.f|=Kl),o.set(jt,Rt)),Ae.add(jt)}if(Te===0&&R&&!ee&&(ue?ee=J0(()=>R(k)):(ee=J0(()=>R(B2??=Mg())),ee.f|=Kl)),zo&&Te>0&&lm(O2()),!ue)if(Fe){for(const[li,Xt]of o)Ae.has(li)||ze.skipped_effects.add(Xt.e);ze.oncommit(oe),ze.ondiscard(()=>{})}else oe();Le&&cm(!0),nt(ie)}),K={effect:ge,items:o,outrogroups:null,fallback:ee};ue=!1,zo&&(k=im)}function YC(m,y,b,S,M){var R=(S&LC)!==0,k=y.length,o=m.items,G=m.effect.first,Z,ee=null,ie,re=[],ue=[],oe,ge,K,Te;if(R)for(Te=0;Te<k;Te+=1)oe=y[Te],ge=M(oe,Te),K=o.get(ge).e,(K.f&Kl)===0&&(K.nodes?.a?.measure(),(ie??=new Set).add(K));for(Te=0;Te<k;Te+=1){if(oe=y[Te],ge=M(oe,Te),K=o.get(ge).e,m.outrogroups!==null)for(const Rt of m.outrogroups)Rt.pending.delete(K),Rt.done.delete(K);if((K.f&Kl)!==0)if(K.f^=Kl,K===G)rm(K,null,b);else{var Le=ee?ee.next:G;K===m.effect.last&&(m.effect.last=K.prev),K.prev&&(K.prev.next=K.next),K.next&&(K.next.prev=K.prev),Fc(m,ee,K),Fc(m,K,Le),rm(K,Le,b),ee=K,re=[],ue=[],G=ee.next;continue}if((K.f&n0)!==0&&(bE(K),R&&(K.nodes?.a?.unfix(),(ie??=new Set).delete(K))),K!==G){if(Z!==void 0&&Z.has(K)){if(re.length<ue.length){var Oe=ue[0],Ae;ee=Oe.prev;var ze=re[0],Fe=re[re.length-1];for(Ae=0;Ae<re.length;Ae+=1)rm(re[Ae],Oe,b);for(Ae=0;Ae<ue.length;Ae+=1)Z.delete(ue[Ae]);Fc(m,ze.prev,Fe.next),Fc(m,ee,ze),Fc(m,Fe,Oe),G=Oe,ee=Fe,Te-=1,re=[],ue=[]}else Z.delete(K),rm(K,G,b),Fc(m,K.prev,K.next),Fc(m,K,ee===null?m.effect.first:ee.next),Fc(m,ee,K),ee=K;continue}for(re=[],ue=[];G!==null&&G!==K;)(Z??=new Set).add(G),ue.push(G),G=G.next;if(G===null)continue}(K.f&Kl)===0&&re.push(K),ee=K,G=K.next}if(m.outrogroups!==null){for(const Rt of m.outrogroups)Rt.pending.size===0&&(ex(yx(Rt.done)),m.outrogroups?.delete(Rt));m.outrogroups.size===0&&(m.outrogroups=null)}if(G!==null||Z!==void 0){var Ye=[];if(Z!==void 0)for(K of Z)(K.f&n0)===0&&Ye.push(K);for(;G!==null;)(G.f&n0)===0&&G!==m.fallback&&Ye.push(G),G=G.next;var it=Ye.length;if(it>0){var jt=(S&vE)!==0&&k===0?b:null;if(R){for(Te=0;Te<it;Te+=1)Ye[Te].nodes?.a?.measure();for(Te=0;Te<it;Te+=1)Ye[Te].nodes?.a?.fix()}XC(m,Ye,jt)}}R&&TE(()=>{if(ie!==void 0)for(K of ie)K.nodes?.a?.apply()})}function JC(m,y,b,S,M,R,k,o){var G=(k&MC)!==0?(k&PC)===0?AC(b,!1,!1):K0(b):null,Z=(k&CC)!==0?K0(M):null;return{v:G,i:Z,e:J0(()=>(R(y,G??b,Z??M,o),()=>{m.delete(S)}))}}function rm(m,y,b){if(m.nodes)for(var S=m.nodes.start,M=m.nodes.end,R=y&&(y.f&Kl)===0?y.nodes.start:b;S!==null;){var k=Q0(S);if(R.before(S),S===M)return;S=k}}function Fc(m,y,b){y===null?m.effect.first=b:y.next=b,b===null?m.effect.last=y:b.prev=y}function KC(m,y){let b=null,S=zo;var M;if(zo){b=im;for(var R=gE(document.head);R!==null&&(R.nodeType!==yE||R.data!==m);)R=Q0(R);if(R===null)cm(!1);else{var k=Q0(R);R.remove(),lm(k)}}zo||(M=document.head.appendChild(Mg()));try{gx(()=>y(M),OC)}finally{S&&(cm(!0),lm(b))}}function QC(m,y,b){vx(()=>{var S=ra(()=>y(m,b?.())||{});if(b&&S?.update){var M=!1,R={};zC(()=>{var k=b();kC(k),M&&FC(R,k)&&(R=k,S.update(k))}),M=!0}if(S?.destroy)return()=>S.destroy()})}function SE(m){var y,b,S="";if(typeof m=="string"||typeof m=="number")S+=m;else if(typeof m=="object")if(Array.isArray(m)){var M=m.length;for(y=0;y<M;y++)m[y]&&(b=SE(m[y]))&&(S&&(S+=" "),S+=b)}else for(b in m)m[b]&&(S&&(S+=" "),S+=b);return S}function eM(){for(var m,y,b=0,S="",M=arguments.length;b<M;b++)(m=arguments[b])&&(y=SE(m))&&(S&&(S+=" "),S+=y);return S}function Fo(m){return typeof m=="object"?eM(m):m??""}const N2=[...` 	
\r\fÂ \v\uFEFF`];function tM(m,y,b){var S=m==null?"":""+m;if(y&&(S=S?S+" "+y:y),b){for(var M in b)if(b[M])S=S?S+" "+M:M;else if(S.length)for(var R=M.length,k=0;(k=S.indexOf(M,k))>=0;){var o=k+R;(k===0||N2.includes(S[k-1]))&&(o===S.length||N2.includes(S[o]))?S=(k===0?"":S.substring(0,k))+S.substring(o+1):k=o}}return S===""?null:S}function iM(m,y){return m==null?null:String(m)}function Ao(m,y,b,S,M,R){var k=m.__className;if(zo||k!==b||k===void 0){var o=tM(b,S,R);(!zo||o!==m.getAttribute("class"))&&(o==null?m.removeAttribute("class"):m.className=o),m.__className=b}else if(R&&M!==R)for(var G in R){var Z=!!R[G];(M==null||Z!==!!M[G])&&m.classList.toggle(G,Z)}return R}function Dg(m,y,b,S){var M=m.__style;if(zo||M!==y){var R=iM(y);(!zo||R!==m.getAttribute("style"))&&(R==null?m.removeAttribute("style"):m.style.cssText=R),m.__style=y}return S}function IE(m,y,b=!1){if(m.multiple){if(y==null)return;if(!xE(y))return NC();for(var S of m.options)S.selected=y.includes(V2(S));return}for(S of m.options){var M=V2(S);if(VC(M,y)){S.selected=!0;return}}(!b||y!==void 0)&&(m.selectedIndex=-1)}function rM(m){var y=new MutationObserver(()=>{IE(m,m.__value)});y.observe(m,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),BC(()=>{y.disconnect()})}function V2(m){return"__value"in m?m.__value:m.value}const nM=Symbol("is custom element"),oM=Symbol("is html");function AE(m){if(zo){var y=!1,b=()=>{if(!y){if(y=!0,m.hasAttribute("value")){var S=m.value;Hc(m,"value",null),m.value=S}if(m.hasAttribute("checked")){var M=m.checked;Hc(m,"checked",null),m.checked=M}}};m.__on_r=b,TE(b),WC()}}function sM(m,y){var b=xx(m);b.value===(b.value=y??void 0)||m.value===y&&(y!==0||m.nodeName!=="PROGRESS")||(m.value=y??"")}function aM(m,y){var b=xx(m);b.checked!==(b.checked=y??void 0)&&(m.checked=y)}function Hc(m,y,b,S){var M=xx(m);zo&&(M[y]=m.getAttribute(y),y==="src"||y==="srcset"||y==="href"&&m.nodeName==="LINK")||M[y]!==(M[y]=b)&&(y==="loading"&&(m[UC]=b),b==null?m.removeAttribute(y):typeof b!="string"&&lM(m).includes(y)?m[y]=b:m.setAttribute(y,b))}function xx(m){return m.__attributes??={[nM]:m.nodeName.includes("-"),[oM]:m.namespaceURI===jC}}var U2=new Map;function lM(m){var y=m.getAttribute("is")||m.nodeName,b=U2.get(y);if(b)return b;U2.set(y,b=[]);for(var S,M=m,R=Element.prototype;R!==M;){S=qC(M);for(var k in S)S[k].set&&b.push(k);M=GC(M)}return b}class bx{#e=new WeakMap;#t;#i;static entries=new WeakMap;constructor(y){this.#i=y}observe(y,b){var S=this.#e.get(y)||new Set;return S.add(b),this.#e.set(y,S),this.#r().observe(y,this.#i),()=>{var M=this.#e.get(y);M.delete(b),M.size===0&&(this.#e.delete(y),this.#t.unobserve(y))}}#r(){return this.#t??(this.#t=new ResizeObserver(y=>{for(var b of y){bx.entries.set(b.target,b);for(var S of this.#e.get(b.target)||[])S(b)}}))}}var cM=new bx({box:"border-box"});function tx(m,y,b){var S=cM.observe(m,()=>b(m[y]));vx(()=>(ra(()=>b(m[y])),S))}function CE(m){var y=K0(0);return function(){return arguments.length===1?(Yr(y,nt(y)+1),arguments[0]):(nt(y),m())}}var oa=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ku(m){return m&&m.__esModule&&Object.prototype.hasOwnProperty.call(m,"default")?m.default:m}function uM(m){if(Object.prototype.hasOwnProperty.call(m,"__esModule"))return m;var y=m.default;if(typeof y=="function"){var b=function S(){var M=!1;try{M=this instanceof S}catch{}return M?Reflect.construct(y,arguments,this.constructor):y.apply(this,arguments)};b.prototype=y.prototype}else b={};return Object.defineProperty(b,"__esModule",{value:!0}),Object.keys(m).forEach(function(S){var M=Object.getOwnPropertyDescriptor(m,S);Object.defineProperty(b,S,M.get?M:{enumerable:!0,get:function(){return m[S]}})}),b}var o0,j2;function hM(){if(j2)return o0;j2=1;var m="Expected a function",y=NaN,b="[object Symbol]",S=/^\s+|\s+$/g,M=/^[-+]0x[0-9a-f]+$/i,R=/^0b[01]+$/i,k=/^0o[0-7]+$/i,o=parseInt,G=typeof oa=="object"&&oa&&oa.Object===Object&&oa,Z=typeof self=="object"&&self&&self.Object===Object&&self,ee=G||Z||Function("return this")(),ie=Object.prototype,re=ie.toString,ue=Math.max,oe=Math.min,ge=function(){return ee.Date.now()};function K(Fe,Ye,it){var jt,Rt,li,Xt,Pt,Ai,rr=0,Li=!1,di=!1,Bi=!0;if(typeof Fe!="function")throw new TypeError(m);Ye=ze(Ye)||0,Le(it)&&(Li=!!it.leading,di="maxWait"in it,li=di?ue(ze(it.maxWait)||0,Ye):li,Bi="trailing"in it?!!it.trailing:Bi);function jr(Ti){var ui=jt,ki=Rt;return jt=Rt=void 0,rr=Ti,Xt=Fe.apply(ki,ui),Xt}function Ln(Ti){return rr=Ti,Pt=setTimeout(yr,Ye),Li?jr(Ti):Xt}function Nn(Ti){var ui=Ti-Ai,ki=Ti-rr,wr=Ye-ui;return di?oe(wr,li-ki):wr}function An(Ti){var ui=Ti-Ai,ki=Ti-rr;return Ai===void 0||ui>=Ye||ui<0||di&&ki>=li}function yr(){var Ti=ge();if(An(Ti))return qn(Ti);Pt=setTimeout(yr,Nn(Ti))}function qn(Ti){return Pt=void 0,Bi&&jt?jr(Ti):(jt=Rt=void 0,Xt)}function ii(){Pt!==void 0&&clearTimeout(Pt),rr=0,jt=Ai=Rt=Pt=void 0}function Si(){return Pt===void 0?Xt:qn(ge())}function si(){var Ti=ge(),ui=An(Ti);if(jt=arguments,Rt=this,Ai=Ti,ui){if(Pt===void 0)return Ln(Ai);if(di)return Pt=setTimeout(yr,Ye),jr(Ai)}return Pt===void 0&&(Pt=setTimeout(yr,Ye)),Xt}return si.cancel=ii,si.flush=Si,si}function Te(Fe,Ye,it){var jt=!0,Rt=!0;if(typeof Fe!="function")throw new TypeError(m);return Le(it)&&(jt="leading"in it?!!it.leading:jt,Rt="trailing"in it?!!it.trailing:Rt),K(Fe,Ye,{leading:jt,maxWait:Ye,trailing:Rt})}function Le(Fe){var Ye=typeof Fe;return!!Fe&&(Ye=="object"||Ye=="function")}function Oe(Fe){return!!Fe&&typeof Fe=="object"}function Ae(Fe){return typeof Fe=="symbol"||Oe(Fe)&&re.call(Fe)==b}function ze(Fe){if(typeof Fe=="number")return Fe;if(Ae(Fe))return y;if(Le(Fe)){var Ye=typeof Fe.valueOf=="function"?Fe.valueOf():Fe;Fe=Le(Ye)?Ye+"":Ye}if(typeof Fe!="string")return Fe===0?Fe:+Fe;Fe=Fe.replace(S,"");var it=R.test(Fe);return it||k.test(Fe)?o(Fe.slice(2),it?2:8):M.test(Fe)?y:+Fe}return o0=Te,o0}var dM=hM();const ME=Ku(dM);var Pg={exports:{}},fM=Pg.exports,G2;function pM(){return G2||(G2=1,(function(m,y){(function(b,S){m.exports=S()})(fM,(function(){var b,S,M;function R(o,G){if(!b)b=G;else if(!S)S=G;else{var Z="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+b+")(sharedChunk); ("+S+")(sharedChunk); self.onerror = null;",ee={};b(ee),M=G(ee),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(M.workerUrl=window.URL.createObjectURL(new Blob([Z],{type:"text/javascript"})))}}R(["exports"],(function(o){var G=1e-6,Z=typeof Float32Array<"u"?Float32Array:Array;function ee(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=i*u-a*s;return h?(r[0]=u*(h=1/h),r[1]=-s*h,r[2]=-a*h,r[3]=i*h,r):null}function ie(){var r=new Z(9);return Z!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function re(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=e[4],f=e[5],g=e[6],x=e[7],T=e[8];return r[0]=h*T-f*x,r[1]=a*x-s*T,r[2]=s*f-a*h,r[3]=f*g-u*T,r[4]=i*T-a*g,r[5]=a*u-i*f,r[6]=u*x-h*g,r[7]=s*g-i*x,r[8]=i*h-s*u,r}function ue(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3],f=e[4],g=e[5],x=e[6],T=e[7],E=e[8],A=i[0],P=i[1],L=i[2],F=i[3],U=i[4],V=i[5],$=i[6],X=i[7],Q=i[8];return r[0]=A*s+P*h+L*x,r[1]=A*a+P*f+L*T,r[2]=A*u+P*g+L*E,r[3]=F*s+U*h+V*x,r[4]=F*a+U*f+V*T,r[5]=F*u+U*g+V*E,r[6]=$*s+X*h+Q*x,r[7]=$*a+X*f+Q*T,r[8]=$*u+X*g+Q*E,r}function oe(){var r=new Z(16);return Z!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function ge(r){var e=new Z(16);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e}function K(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Te(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=e[4],f=e[5],g=e[6],x=e[7],T=e[8],E=e[9],A=e[10],P=e[11],L=e[12],F=e[13],U=e[14],V=e[15],$=i*f-s*h,X=i*g-a*h,Q=i*x-u*h,de=s*g-a*f,ae=s*x-u*f,me=a*x-u*g,xe=T*F-E*L,Ee=T*U-A*L,Ge=T*V-P*L,Me=E*U-A*F,$e=E*V-P*F,Ke=A*V-P*U,Qe=$*Ke-X*$e+Q*Me+de*Ge-ae*Ee+me*xe;return Qe?(r[0]=(f*Ke-g*$e+x*Me)*(Qe=1/Qe),r[1]=(a*$e-s*Ke-u*Me)*Qe,r[2]=(F*me-U*ae+V*de)*Qe,r[3]=(A*ae-E*me-P*de)*Qe,r[4]=(g*Ge-h*Ke-x*Ee)*Qe,r[5]=(i*Ke-a*Ge+u*Ee)*Qe,r[6]=(U*Q-L*me-V*X)*Qe,r[7]=(T*me-A*Q+P*X)*Qe,r[8]=(h*$e-f*Ge+x*xe)*Qe,r[9]=(s*Ge-i*$e-u*xe)*Qe,r[10]=(L*ae-F*Q+V*$)*Qe,r[11]=(E*Q-T*ae-P*$)*Qe,r[12]=(f*Ee-h*Me-g*xe)*Qe,r[13]=(i*Me-s*Ee+a*xe)*Qe,r[14]=(F*X-L*de-U*$)*Qe,r[15]=(T*de-E*X+A*$)*Qe,r):null}function Le(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3],f=e[4],g=e[5],x=e[6],T=e[7],E=e[8],A=e[9],P=e[10],L=e[11],F=e[12],U=e[13],V=e[14],$=e[15],X=i[0],Q=i[1],de=i[2],ae=i[3];return r[0]=X*s+Q*f+de*E+ae*F,r[1]=X*a+Q*g+de*A+ae*U,r[2]=X*u+Q*x+de*P+ae*V,r[3]=X*h+Q*T+de*L+ae*$,r[4]=(X=i[4])*s+(Q=i[5])*f+(de=i[6])*E+(ae=i[7])*F,r[5]=X*a+Q*g+de*A+ae*U,r[6]=X*u+Q*x+de*P+ae*V,r[7]=X*h+Q*T+de*L+ae*$,r[8]=(X=i[8])*s+(Q=i[9])*f+(de=i[10])*E+(ae=i[11])*F,r[9]=X*a+Q*g+de*A+ae*U,r[10]=X*u+Q*x+de*P+ae*V,r[11]=X*h+Q*T+de*L+ae*$,r[12]=(X=i[12])*s+(Q=i[13])*f+(de=i[14])*E+(ae=i[15])*F,r[13]=X*a+Q*g+de*A+ae*U,r[14]=X*u+Q*x+de*P+ae*V,r[15]=X*h+Q*T+de*L+ae*$,r}function Oe(r,e,i){var s,a,u,h,f,g,x,T,E,A,P,L,F=i[0],U=i[1],V=i[2];return e===r?(r[12]=e[0]*F+e[4]*U+e[8]*V+e[12],r[13]=e[1]*F+e[5]*U+e[9]*V+e[13],r[14]=e[2]*F+e[6]*U+e[10]*V+e[14],r[15]=e[3]*F+e[7]*U+e[11]*V+e[15]):(a=e[1],u=e[2],h=e[3],f=e[4],g=e[5],x=e[6],T=e[7],E=e[8],A=e[9],P=e[10],L=e[11],r[0]=s=e[0],r[1]=a,r[2]=u,r[3]=h,r[4]=f,r[5]=g,r[6]=x,r[7]=T,r[8]=E,r[9]=A,r[10]=P,r[11]=L,r[12]=s*F+f*U+E*V+e[12],r[13]=a*F+g*U+A*V+e[13],r[14]=u*F+x*U+P*V+e[14],r[15]=h*F+T*U+L*V+e[15]),r}function Ae(r,e,i){var s=i[0],a=i[1],u=i[2];return r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r[3]=e[3]*s,r[4]=e[4]*a,r[5]=e[5]*a,r[6]=e[6]*a,r[7]=e[7]*a,r[8]=e[8]*u,r[9]=e[9]*u,r[10]=e[10]*u,r[11]=e[11]*u,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function ze(r,e,i){var s=Math.sin(i),a=Math.cos(i),u=e[4],h=e[5],f=e[6],g=e[7],x=e[8],T=e[9],E=e[10],A=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=u*a+x*s,r[5]=h*a+T*s,r[6]=f*a+E*s,r[7]=g*a+A*s,r[8]=x*a-u*s,r[9]=T*a-h*s,r[10]=E*a-f*s,r[11]=A*a-g*s,r}function Fe(r,e,i){var s=Math.sin(i),a=Math.cos(i),u=e[0],h=e[1],f=e[2],g=e[3],x=e[8],T=e[9],E=e[10],A=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=u*a-x*s,r[1]=h*a-T*s,r[2]=f*a-E*s,r[3]=g*a-A*s,r[8]=u*s+x*a,r[9]=h*s+T*a,r[10]=f*s+E*a,r[11]=g*s+A*a,r}function Ye(r,e,i){var s=Math.sin(i),a=Math.cos(i),u=e[0],h=e[1],f=e[2],g=e[3],x=e[4],T=e[5],E=e[6],A=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=u*a+x*s,r[1]=h*a+T*s,r[2]=f*a+E*s,r[3]=g*a+A*s,r[4]=x*a-u*s,r[5]=T*a-h*s,r[6]=E*a-f*s,r[7]=A*a-g*s,r}function it(r,e){return r[0]=e[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function jt(r,e,i){var s,a,u,h=i[0],f=i[1],g=i[2],x=Math.sqrt(h*h+f*f+g*g);return x<G?null:(h*=x=1/x,f*=x,g*=x,s=Math.sin(e),a=Math.cos(e),r[0]=h*h*(u=1-a)+a,r[1]=f*h*u+g*s,r[2]=g*h*u-f*s,r[3]=0,r[4]=h*f*u-g*s,r[5]=f*f*u+a,r[6]=g*f*u+h*s,r[7]=0,r[8]=h*g*u+f*s,r[9]=f*g*u-h*s,r[10]=g*g*u+a,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function Rt(r,e){var i=e[0],s=e[1],a=e[2],u=e[4],h=e[5],f=e[6],g=e[8],x=e[9],T=e[10];return r[0]=Math.sqrt(i*i+s*s+a*a),r[1]=Math.sqrt(u*u+h*h+f*f),r[2]=Math.sqrt(g*g+x*x+T*T),r}function li(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=i+i,f=s+s,g=a+a,x=i*h,T=s*h,E=s*f,A=a*h,P=a*f,L=a*g,F=u*h,U=u*f,V=u*g;return r[0]=1-E-L,r[1]=T+V,r[2]=A-U,r[3]=0,r[4]=T-V,r[5]=1-x-L,r[6]=P+F,r[7]=0,r[8]=A+U,r[9]=P-F,r[10]=1-x-E,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}var Xt=Le;function Pt(){var r=new Z(3);return Z!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function Ai(r){var e=new Z(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function rr(r){var e=r[0],i=r[1],s=r[2];return Math.sqrt(e*e+i*i+s*s)}function Li(r,e,i){var s=new Z(3);return s[0]=r,s[1]=e,s[2]=i,s}function di(r,e,i,s){return r[0]=e,r[1]=i,r[2]=s,r}function Bi(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r[2]=e[2]+i[2],r}function jr(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],r}function Ln(r,e,i){return r[0]=e[0]*i[0],r[1]=e[1]*i[1],r[2]=e[2]*i[2],r}function Nn(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r}function An(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r}function yr(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r}function qn(r,e,i,s){return r[0]=e[0]+i[0]*s,r[1]=e[1]+i[1]*s,r[2]=e[2]+i[2]*s,r}function ii(r,e){var i=e[0]-r[0],s=e[1]-r[1],a=e[2]-r[2];return Math.sqrt(i*i+s*s+a*a)}function Si(r,e){var i=e[0]-r[0],s=e[1]-r[1],a=e[2]-r[2];return i*i+s*s+a*a}function si(r){var e=r[0],i=r[1],s=r[2];return e*e+i*i+s*s}function Ti(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}function ui(r,e){var i=e[0],s=e[1],a=e[2],u=i*i+s*s+a*a;return u>0&&(u=1/Math.sqrt(u)),r[0]=e[0]*u,r[1]=e[1]*u,r[2]=e[2]*u,r}function ki(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function wr(r,e,i){var s=e[0],a=e[1],u=e[2],h=i[0],f=i[1],g=i[2];return r[0]=a*g-u*f,r[1]=u*h-s*g,r[2]=s*f-a*h,r}function Hn(r,e,i,s){var a=e[0],u=e[1],h=e[2];return r[0]=a+s*(i[0]-a),r[1]=u+s*(i[1]-u),r[2]=h+s*(i[2]-h),r}function kr(r,e,i){var s=e[0],a=e[1],u=e[2],h=i[3]*s+i[7]*a+i[11]*u+i[15];return r[0]=(i[0]*s+i[4]*a+i[8]*u+i[12])/(h=h||1),r[1]=(i[1]*s+i[5]*a+i[9]*u+i[13])/h,r[2]=(i[2]*s+i[6]*a+i[10]*u+i[14])/h,r}function Rn(r,e,i){var s=e[0],a=e[1],u=e[2];return r[0]=s*i[0]+a*i[3]+u*i[6],r[1]=s*i[1]+a*i[4]+u*i[7],r[2]=s*i[2]+a*i[5]+u*i[8],r}function yo(r,e,i){var s=i[0],a=i[1],u=i[2],h=i[3],f=e[0],g=e[1],x=e[2],T=a*x-u*g,E=u*f-s*x,A=s*g-a*f;return r[0]=f+h*(T+=T)+a*(A+=A)-u*(E+=E),r[1]=g+h*E+u*T-s*A,r[2]=x+h*A+s*E-a*T,r}function Gr(r){return r[0]=0,r[1]=0,r[2]=0,r}function Jr(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]}var Kr=jr,yl=Ln,Vo=rr;function _s(){var r=new Z(4);return Z!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function Ns(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r[3]=e[3]*i,r}function ja(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=i*i+s*s+a*a+u*u;return h>0&&(h=1/Math.sqrt(h)),r[0]=i*h,r[1]=s*h,r[2]=a*h,r[3]=u*h,r}function Jn(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3];return r[0]=i[0]*s+i[4]*a+i[8]*u+i[12]*h,r[1]=i[1]*s+i[5]*a+i[9]*u+i[13]*h,r[2]=i[2]*s+i[6]*a+i[10]*u+i[14]*h,r[3]=i[3]*s+i[7]*a+i[11]*u+i[15]*h,r}function la(){var r=new Z(4);return Z!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function tc(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function gs(r,e,i){i*=.5;var s=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g+h*f,r[1]=a*g+u*f,r[2]=u*g-a*f,r[3]=h*g-s*f,r}function ca(r,e,i){i*=.5;var s=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g-u*f,r[1]=a*g+h*f,r[2]=u*g+s*f,r[3]=h*g-a*f,r}Pt(),_s();var lo,vl,xl,bl=ja,ic=(lo=Pt(),vl=Li(1,0,0),xl=Li(0,1,0),function(r,e,i){var s=ki(e,i);return s<-.999999?(wr(lo,vl,e),Vo(lo)<1e-6&&wr(lo,xl,e),ui(lo,lo),(function(a,u,h){h*=.5;var f=Math.sin(h);a[0]=f*u[0],a[1]=f*u[1],a[2]=f*u[2],a[3]=Math.cos(h)})(r,lo,Math.PI),r):s>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(wr(lo,e,i),r[0]=lo[0],r[1]=lo[1],r[2]=lo[2],r[3]=1+s,bl(r,r))});function Vn(){var r=new Z(2);return Z!=Float32Array&&(r[0]=0,r[1]=0),r}function vo(r,e){var i=new Z(2);return i[0]=r,i[1]=e,i}function Xc(r,e,i){return r[0]=e,r[1]=i,r}function Ga(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r}function Vs(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r}function ua(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r}function ys(r){var e=r[0],i=r[1];return Math.sqrt(e*e+i*i)}function Yc(r,e){var i=e[0],s=e[1],a=i*i+s*s;return a>0&&(a=1/Math.sqrt(a)),r[0]=e[0]*a,r[1]=e[1]*a,r}function wl(r,e){return r[0]*e[0]+r[1]*e[1]}la(),la(),ie();var qr,Zn,eh=Vs;function Tl(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}Vn();var vs=(function(){if(Zn)return qr;function r(e,i,s,a){this.cx=3*e,this.bx=3*(s-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(a-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=s,this.p2y=a}return Zn=1,qr=r,r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var s=e,a=0;a<8;a++){var u=this.sampleCurveX(s)-e;if(Math.abs(u)<i)return s;var h=this.sampleCurveDerivativeX(s);if(Math.abs(h)<1e-6)break;s-=u/h}var f=0,g=1;for(s=e,a=0;a<20&&(u=this.sampleCurveX(s),!(Math.abs(u-e)<i));a++)e>u?f=s:g=s,s=.5*(g-f)+f;return s},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},qr})(),th=Tl(vs);function st(r,e){this.x=r,this.y=e}function ha(r,e){if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(!ha(r[i],e[i]))return!1;return!0}if(typeof r=="object"&&r!==null&&e!==null){if(typeof e!="object"||Object.keys(r).length!==Object.keys(e).length)return!1;for(const i in r)if(!ha(r[i],e[i]))return!1;return!0}return r===e}st.prototype={clone(){return new st(this.x,this.y)},add(r){return this.clone()._add(r)},sub(r){return this.clone()._sub(r)},multByPoint(r){return this.clone()._multByPoint(r)},divByPoint(r){return this.clone()._divByPoint(r)},mult(r){return this.clone()._mult(r)},div(r){return this.clone()._div(r)},rotate(r){return this.clone()._rotate(r)},rotateAround(r,e){return this.clone()._rotateAround(r,e)},matMult(r){return this.clone()._matMult(r)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(r){return this.x===r.x&&this.y===r.y},dist(r){return Math.sqrt(this.distSqr(r))},distSqr(r){const e=r.x-this.x,i=r.y-this.y;return e*e+i*i},angle(){return Math.atan2(this.y,this.x)},angleTo(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith(r){return this.angleWithSep(r.x,r.y)},angleWithSep(r,e){return Math.atan2(this.x*e-this.y*r,this.x*r+this.y*e)},_matMult(r){const e=r[2]*this.x+r[3]*this.y;return this.x=r[0]*this.x+r[1]*this.y,this.y=e,this},_add(r){return this.x+=r.x,this.y+=r.y,this},_sub(r){return this.x-=r.x,this.y-=r.y,this},_mult(r){return this.x*=r,this.y*=r,this},_div(r){return this.x/=r,this.y/=r,this},_multByPoint(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint(r){return this.x/=r.x,this.y/=r.y,this},_unit(){return this._div(this.mag()),this},_perp(){const r=this.y;return this.y=this.x,this.x=-r,this},_rotate(r){const e=Math.cos(r),i=Math.sin(r),s=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=s,this},_rotateAround(r,e){const i=Math.cos(r),s=Math.sin(r),a=e.y+s*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-s*(this.y-e.y),this.y=a,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:st},st.convert=function(r){if(r instanceof st)return r;if(Array.isArray(r))return new st(+r[0],+r[1]);if(r.x!==void 0&&r.y!==void 0)return new st(+r.x,+r.y);throw new Error("Expected [x, y] or {x, y} point format")};const ef=Math.PI/180,El=180/Math.PI;function Yi(r){return r*ef}function no(r){return r*El}const tf=[[0,0],[1,0],[1,1],[0,1]];function Sl(r){if(r<=0)return 0;if(r>=1)return 1;const e=r*r,i=e*r;return 4*(r<.5?i:3*(r-e)+i-.75)}function Jc(r,e,i,s){const a=new th(r,e,i,s);return function(u){return a.solve(u)}}const De=Jc(.25,.1,.25,1);function j(r,e,i){return Math.min(i,Math.max(e,r))}function W(r,e,i){return(i=j((i-r)/(e-r),0,1))*i*(3-2*i)}function ne(r,e,i){const s=i-e,a=((r-e)%s+s)%s+e;return a===e?i:a}function be(r,e,i){if(!r.length)return i(null,[]);let s=r.length;const a=new Array(r.length);let u=null;r.forEach(((h,f)=>{e(h,((g,x)=>{g&&(u=g),a[f]=x,--s==0&&i(u,a)}))}))}let ve=1;function Ie(){return ve++}function Ve(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log2(r)))}function Pe(r,e){r.forEach((i=>{e[i]&&(e[i]=e[i].bind(e))}))}function Ne(r,e,i){const s={};for(const a in r)s[a]=e.call(this,r[a],a,r);return s}function ut(r,e,i){const s={};for(const a in r)e.call(this,r[a],a,r)&&(s[a]=r[a]);return s}function Je(r){return Array.isArray(r)?r.map(Je):typeof r=="object"&&r?Ne(r,Je):r}function Mt(r,e){for(let i=0;i<r.length;i++)if(e.indexOf(r[i])>=0)return!0;return!1}const $t={};function It(r){$t[r]||(typeof console<"u"&&console.warn(r),$t[r]=!0)}function yi(r,e,i){return(i.y-r.y)*(e.x-r.x)>(e.y-r.y)*(i.x-r.x)}function mi(r){let e=0;for(let i,s,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],s=r[h],e+=(s.x-i.x)*(i.y+s.y);return e}function fi([r,e,i]){const s=Yi(e+90),a=Yi(i);return{x:r*Math.cos(s)*Math.sin(a),y:r*Math.sin(s)*Math.sin(a),z:r*Math.cos(a),azimuthal:e,polar:i}}function Ui(r){return(typeof self<"u"||r!==void 0)&&typeof WorkerGlobalScope<"u"&&(r!==void 0?r:self)instanceof WorkerGlobalScope}function Qr(r){const e={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((i,s,a,u)=>{const h=a||u;return e[s]=!h||h.toLowerCase(),""})),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let fn=null;function nn(r,e){return[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]]}function gn(r,e,i,s){for(;e<i;){const a=e+i>>1;r[a]<s?e=a+1:i=a}return e}function Hr(r,e,i,s){for(;e<i;){const a=e+i>>1;r[a]<=s?e=a+1:i=a}return e}function $i(r){return r>0?1/(1.001-r):1+r}function Zr(r){return r>0?1-1/(1.001-r):-r}function Tr(r,e,i){return(r-e.min)*(i.max-i.min)/(e.max-e.min)+i.min}const Ri={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Ri.API_URL)return null;try{const r=new URL(Ri.API_URL);return r.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":r.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.4.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function on(r){return Ri.API_URL_REGEX.test(r)}function Wn(r){return Ri.API_SPRITE_REGEX.test(r)}let Kn,xo,Il,Un,Uo,oo;function Us(){return Kn==null&&(Kn=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Kn}const Dn={now:()=>Un!==void 0?Un:performance.now(),setNow(r){Un=r},restoreNow(){Un=void 0},frame(r){const e=requestAnimationFrame(r);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(r,e=0){const{width:i,height:s}=r;Uo||(Uo=document.createElement("canvas"));const a=Uo.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("failed to create canvas 2d context");return(i>Uo.width||s>Uo.height)&&(Uo.width=i,Uo.height=s),a.clearRect(-e,-e,i+2*e,s+2*e),a.drawImage(r,0,0,i,s),a.getImageData(-e,-e,i+2*e,s+2*e)},resolveURL:r=>(xo||(xo=document.createElement("a")),xo.href=r,xo.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Il==null&&(Il=window.matchMedia("(prefers-reduced-motion: reduce)")),Il.matches)},hasCanvasFingerprintNoise(){if(oo!==void 0)return oo;if(!Us())return oo=!1,!1;const r=new OffscreenCanvas(85,1),e=r.getContext("2d",{willReadFrequently:!0});let i=0;for(let a=0;a<r.width;++a)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(a,0,1,1);const s=e.getImageData(0,0,r.width,r.height);i=0;for(let a=0;a<s.data.length;++a)if(a%4!=3&&i++!==s.data[a])return oo=!0,!0;return oo=!1,!1}};function Al(r,e){const i=r.indexOf("?");if(i<0)return`${r}?${new URLSearchParams(e).toString()}`;const s=new URLSearchParams(r.slice(i));for(const a in e)s.set(a,e[a]);return`${r.slice(0,i)}?${s.toString()}`}function rc(r,e={persistentParams:[]}){const i=r.indexOf("?");if(i<0)return r;const s=new URLSearchParams,a=new URLSearchParams(r.slice(i));for(const h of e.persistentParams){const f=a.get(h);f&&s.set(h,f)}const u=s.toString();return`${r.slice(0,i)}${u.length>0?`?${u}`:""}`}const ih="mapbox-tiles";let rh=500,nh=50;const Kc=["language","worldview","jobid"];let js,bo;function xs(){try{return caches}catch{}}function bs(){const r=xs();r&&js==null&&(js=r.open(ih))}let is=1/0;const Gs={supported:!1,testSupport:function(r){!oh&&Cl&&(Ml?bm(r):qa=r)}};let qa,Cl,oh=!1,Ml=!1;const sh=typeof self<"u"?self:{};function bm(r){const e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,Cl),r.isContextLost())return;Gs.supported=!0}catch{}r.deleteTexture(e),oh=!0}sh.document&&(Cl=sh.document.createElement("img"),Cl.onload=function(){qa&&bm(qa),qa=null,Ml=!0},Cl.onerror=function(){oh=!0,qa=null},Cl.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Qc={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Qc);class Po extends Error{constructor(e,i,s){i===401&&on(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=s}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const ah=Ui()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Pl=function(r,e){if(!(/^file:/.test(i=r.url)||/^file:/.test(ah())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return(function(s,a){const u=new AbortController,h=new Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:ah(),referrerPolicy:s.referrerPolicy,signal:u.signal});let f=!1,g=!1;const x=(T=h.url).indexOf("sku=")>0&&on(T);var T;s.type==="json"&&h.headers.set("Accept","application/json");const E=(P,L,F)=>{if(g)return;if(P&&P.message!=="SecurityError"&&It(P.toString()),L&&F)return A(L);const U=Date.now();fetch(h).then((V=>{if(V.ok){const $=x?V.clone():null;return A(V,$,U)}return a(new Po(V.statusText,V.status,s.url))})).catch((V=>{V.name!=="AbortError"&&a(new Error(`${V.message} ${s.url}`))}))},A=(P,L,F)=>{(s.type==="arrayBuffer"?P.arrayBuffer():s.type==="json"?P.json():P.text()).then((U=>{g||(L&&F&&(function(V,$,X){if(bs(),js==null)return;const Q=Qr($.headers.get("Cache-Control")||"");if(Q["no-store"])return;const de={status:$.status,statusText:$.statusText,headers:new Headers};$.headers.forEach(((xe,Ee)=>de.headers.set(Ee,xe))),Q["max-age"]&&de.headers.set("Expires",new Date(X+1e3*Q["max-age"]).toUTCString());const ae=de.headers.get("Expires");if(!ae||new Date(ae).getTime()-X<42e4)return;let me=rc(V.url,{persistentParams:Kc});if($.status===206){const xe=V.headers.get("Range");if(!xe)return;de.status=200,me=Al(me,{range:xe})}(function(xe,Ee){if(bo===void 0)try{new Response(new ReadableStream),bo=!0}catch{bo=!1}bo?Ee(xe.body):xe.blob().then(Ee).catch((Ge=>It(Ge.message)))})($,(xe=>{const Ee=new Response((Ge=$.status)!==200&&Ge!==404&&[101,103,204,205,304].includes(Ge)?null:xe,de);var Ge;bs(),js?.then((Me=>Me.put(me,Ee))).catch((Me=>It(Me.message)))}))})(h,L,F),f=!0,a(null,U,P.headers))})).catch((U=>{g||a(new Error(U.message))}))};return x?(function(P,L){if(bs(),js==null)return L(null);js.then((F=>{let U=rc(P.url,{persistentParams:Kc});const V=P.headers.get("Range");V&&(U=Al(U,{range:V})),F.match(U).then(($=>{const X=(function(Q){if(!Q)return!1;const de=new Date(Q.headers.get("Expires")||0),ae=Qr(Q.headers.get("Cache-Control")||"");return Number(de)>Date.now()&&!ae["no-cache"]})($);F.delete(U).catch(L),X&&F.put(U,$.clone()).catch(L),L(null,$,X)})).catch(L)})).catch(L)})(h,E):E(null,null),{cancel:()=>{g=!0,f||u.abort()}}})(r,e);if(Ui(self)&&self.worker.actor)return self.worker.actor.send("getResource",r,e,void 0,!0)}var i;return(function(s,a){const u=new XMLHttpRequest;u.open(s.method||"GET",s.url,!0),s.type==="arrayBuffer"&&(u.responseType="arraybuffer");for(const h in s.headers)u.setRequestHeader(h,s.headers[h]);return s.type==="json"&&(u.responseType="text",u.setRequestHeader("Accept","application/json")),u.withCredentials=s.credentials==="include",u.onerror=()=>{a(new Error(u.statusText))},u.onload=()=>{if((u.status>=200&&u.status<300||u.status===0)&&u.response!==null){let h=u.response;if(s.type==="json")try{h=JSON.parse(u.response)}catch(g){return a(g)}const f=new Headers;u.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach((g=>{const x=g.split(": "),T=x.shift(),E=x.join(": ");f.append(T,E)})),a(null,h,f)}else a(new Po(u.statusText,u.status,s.url))},u.send(s.body),{cancel:()=>u.abort()}})(r,e)},da=function(r,e){return Pl(Object.assign(r,{type:"arrayBuffer"}),e)};function oy(r){const e=document.createElement("a");return e.href=r,e.protocol===location.protocol&&e.host===location.host}const wm="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let eu,Wi;eu=[],Wi=0;const lh=function(r,e){if(Gs.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),Wi>=Ri.MAX_PARALLEL_IMAGE_REQUESTS){const u={requestParameters:r,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return eu.push(u),u}Wi++;let i=!1;const s=()=>{if(!i)for(i=!0,Wi--;eu.length&&Wi<Ri.MAX_PARALLEL_IMAGE_REQUESTS;){const u=eu.shift(),{requestParameters:h,callback:f,cancelled:g}=u;g||(u.cancel=lh(h,f).cancel)}},a=da(r,((u,h,f)=>{s(),u?e(u):h&&(self.createImageBitmap?(function(g,x){const T=new Blob([new Uint8Array(g)],{type:"image/png"});createImageBitmap(T).then((E=>{x(null,E)})).catch((E=>{x(new Error(`Could not load image because of ${E.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))})(h,((g,x)=>e(g,x,f))):(function(g,x){const T=new Image;T.onload=()=>{x(null,T),URL.revokeObjectURL(T.src),T.onload=null,requestAnimationFrame((()=>{T.src=wm}))},T.onerror=()=>x(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const E=new Blob([new Uint8Array(g)],{type:"image/png"});T.src=g.byteLength?URL.createObjectURL(E):wm})(h,((g,x)=>e(g,x,f))))}));return{cancel:()=>{a.cancel(),s()}}};var rf,Tm,Em,Ha={exports:{}},tu={exports:{}},iu={exports:{}},nf=(function(){if(Em)return Ha.exports;Em=1;var r=(rf||(rf=1,tu.exports=function(i,s){var a,u,h,f,g,x,T,E;for(u=i.length-(a=3&i.length),h=s,g=3432918353,x=461845907,E=0;E<u;)T=255&i.charCodeAt(E)|(255&i.charCodeAt(++E))<<8|(255&i.charCodeAt(++E))<<16|(255&i.charCodeAt(++E))<<24,++E,h=27492+(65535&(f=5*(65535&(h=(h^=T=(65535&(T=(T=(65535&T)*g+(((T>>>16)*g&65535)<<16)&4294967295)<<15|T>>>17))*x+(((T>>>16)*x&65535)<<16)&4294967295)<<13|h>>>19))+((5*(h>>>16)&65535)<<16)&4294967295))+((58964+(f>>>16)&65535)<<16);switch(T=0,a){case 3:T^=(255&i.charCodeAt(E+2))<<16;case 2:T^=(255&i.charCodeAt(E+1))<<8;case 1:h^=T=(65535&(T=(T=(65535&(T^=255&i.charCodeAt(E)))*g+(((T>>>16)*g&65535)<<16)&4294967295)<<15|T>>>17))*x+(((T>>>16)*x&65535)<<16)&4294967295}return h^=i.length,h=2246822507*(65535&(h^=h>>>16))+((2246822507*(h>>>16)&65535)<<16)&4294967295,h=3266489909*(65535&(h^=h>>>13))+((3266489909*(h>>>16)&65535)<<16)&4294967295,(h^=h>>>16)>>>0}),tu.exports),e=(Tm||(Tm=1,iu.exports=function(i,s){for(var a,u=i.length,h=s^u,f=0;u>=4;)a=1540483477*(65535&(a=255&i.charCodeAt(f)|(255&i.charCodeAt(++f))<<8|(255&i.charCodeAt(++f))<<16|(255&i.charCodeAt(++f))<<24))+((1540483477*(a>>>16)&65535)<<16),h=1540483477*(65535&h)+((1540483477*(h>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),u-=4,++f;switch(u){case 3:h^=(255&i.charCodeAt(f+2))<<16;case 2:h^=(255&i.charCodeAt(f+1))<<8;case 1:h=1540483477*(65535&(h^=255&i.charCodeAt(f)))+((1540483477*(h>>>16)&65535)<<16)}return h=1540483477*(65535&(h^=h>>>13))+((1540483477*(h>>>16)&65535)<<16),(h^=h>>>15)>>>0}),iu.exports);return Ha.exports=r,Ha.exports.murmur3=r,Ha.exports.murmur2=e,Ha.exports})(),ch=Tl(nf);class qs{constructor(e,...i){Object.assign(this,i[0]||{}),this.type=e}}class ru extends qs{constructor(e,i={}){super("error",Object.assign({error:e},i))}}function of(r,e,i){i[r]&&i[r].indexOf(e)!==-1||(i[r]=i[r]||[],i[r].push(e))}function Za(r,e,i){if(i&&i[r]){const s=i[r].indexOf(e);s!==-1&&i[r].splice(s,1)}}class Ll{on(e,i){return this._listeners=this._listeners||{},of(e,i,this._listeners),this}off(e,i){return Za(e,i,this._listeners),Za(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},of(e,i,this._oneTimeListeners),this):new Promise((s=>{this.once(e,s)}))}fire(e,i){const s=typeof e=="string"?new qs(e,i):e,a=s.type;if(this.listens(a)){s.target=this;const u=this._listeners&&this._listeners[a]?this._listeners[a].slice():[];for(const g of u)g.call(this,s);const h=this._oneTimeListeners&&this._oneTimeListeners[a]?this._oneTimeListeners[a].slice():[];for(const g of h)Za(a,g,this._oneTimeListeners),g.call(this,s);const f=this._eventedParent;if(f){const g=typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData;Object.assign(s,g),f.fire(s)}}else s instanceof ru&&console.error(s.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class so{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new so(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){const[i,s]=e.split("");return new so({name:i,iconsetId:s})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return so.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var uh,nu={},rs=(function(){if(uh)return nu;uh=1;var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(u){return(u=Math.round(u))<0?0:u>255?255:u}function i(u){return e(u[u.length-1]==="%"?parseFloat(u)/100*255:parseInt(u))}function s(u){return(h=u[u.length-1]==="%"?parseFloat(u)/100:parseFloat(u))<0?0:h>1?1:h;var h}function a(u,h,f){return f<0?f+=1:f>1&&(f-=1),6*f<1?u+(h-u)*f*6:2*f<1?h:3*f<2?u+(h-u)*(2/3-f)*6:u}try{nu.parseCSSColor=function(u){var h,f=u.replace(/ /g,"").toLowerCase();if(f in r)return r[f].slice();if(f[0]==="#")return f.length===4?(h=parseInt(f.substr(1),16))>=0&&h<=4095?[(3840&h)>>4|(3840&h)>>8,240&h|(240&h)>>4,15&h|(15&h)<<4,1]:null:f.length===7&&(h=parseInt(f.substr(1),16))>=0&&h<=16777215?[(16711680&h)>>16,(65280&h)>>8,255&h,1]:null;var g=f.indexOf("("),x=f.indexOf(")");if(g!==-1&&x+1===f.length){var T=f.substr(0,g),E=f.substr(g+1,x-(g+1)).split(","),A=1;switch(T){case"rgba":if(E.length!==4)return null;A=s(E.pop());case"rgb":return E.length!==3?null:[i(E[0]),i(E[1]),i(E[2]),A];case"hsla":if(E.length!==4)return null;A=s(E.pop());case"hsl":if(E.length!==3)return null;var P=(parseFloat(E[0])%360+360)%360/360,L=s(E[1]),F=s(E[2]),U=F<=.5?F*(L+1):F+L-F*L,V=2*F-U;return[e(255*a(V,U,P+1/3)),e(255*a(V,U,P)),e(255*a(V,U,P-1/3)),A];default:return null}}return null}}catch{}return nu})();class lr{constructor(e,i,s,a=1){this.r=e,this.g=i,this.b=s,this.a=a}static parse(e){if(!e)return;if(e instanceof lr)return e;if(typeof e!="string")return;const i=rs.parseCSSColor(e);return i?new lr(i[0]/255,i[1]/255,i[2]/255,i[3]):void 0}toString(){const[e,i,s,a]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*s)},${a})`}toNonPremultipliedRenderColor(e){const{r:i,g:s,b:a,a:u}=this;return new Im(e,i,s,a,u)}toPremultipliedRenderColor(e){const{r:i,g:s,b:a,a:u}=this;return new Am(e,i*u,s*u,a*u,u)}clone(){return new lr(this.r,this.g,this.b,this.a)}}class Sm{constructor(e,i,s,a,u,h=!1){if(this.premultiplied=!1,this.premultiplied=h,e){const f=e.image.height,g=f*f;this.premultiplied?(i=u===0?0:i/u*(f-1),s=u===0?0:s/u*(f-1),a=u===0?0:a/u*(f-1)):(i*=f-1,s*=f-1,a*=f-1);const x=Math.floor(i),T=Math.floor(s),E=Math.floor(a),A=Math.ceil(i),P=Math.ceil(s),L=Math.ceil(a),F=i-x,U=s-T,V=a-E,$=e.image.data,X=4*(x+T*g+E*f),Q=4*(x+T*g+L*f),de=4*(x+P*g+E*f),ae=4*(x+P*g+L*f),me=4*(A+T*g+E*f),xe=4*(A+T*g+L*f),Ee=4*(A+P*g+E*f),Ge=4*(A+P*g+L*f);if(X<0||Ge>=$.length)throw new Error("out of range");this.r=ei(ei(ei($[X],$[Q],V),ei($[de],$[ae],V),U),ei(ei($[me],$[xe],V),ei($[Ee],$[Ge],V),U),F)/255*(this.premultiplied?u:1),this.g=ei(ei(ei($[X+1],$[Q+1],V),ei($[de+1],$[ae+1],V),U),ei(ei($[me+1],$[xe+1],V),ei($[Ee+1],$[Ge+1],V),U),F)/255*(this.premultiplied?u:1),this.b=ei(ei(ei($[X+2],$[Q+2],V),ei($[de+2],$[ae+2],V),U),ei(ei($[me+2],$[xe+2],V),ei($[Ee+2],$[Ge+2],V),U),F)/255*(this.premultiplied?u:1),this.a=u}else this.r=i,this.g=s,this.b=a,this.a=u}toArray(){const{r:e,g:i,b:s,a}=this;return[255*e,255*i,255*s,a]}toHslaArray(){let{r:e,g:i,b:s,a}=this;if(this.premultiplied){if(a===0)return[0,0,0,0];const L=1/a;e*=L,i*=L,s*=L}const u=Math.min(Math.max(e,0),1),h=Math.min(Math.max(i,0),1),f=Math.min(Math.max(s,0),1),g=Math.min(u,h,f),x=Math.max(u,h,f),T=x-g,E=.5*(g+x);if(T===0)return[0,0,100*E,a];const A=E>.5?T/(2-x-g):T/(x+g);let P;switch(x){case u:P=60*((h-f)/T+(h<f?6:0));break;case h:P=60*((f-u)/T+2);break;default:P=60*((u-h)/T+4)}return[P,100*A,100*E,a]}toArray01(){const{r:e,g:i,b:s,a}=this;return[e,i,s,a]}toArray01Scaled(e){const{r:i,g:s,b:a}=this;return[i*e,s*e,a*e]}toArray01Linear(){const{r:e,g:i,b:s,a}=this;return[Math.pow(e,2.2),Math.pow(i,2.2),Math.pow(s,2.2),a]}}class Im extends Sm{constructor(e,i,s,a,u){super(e,i,s,a,u,!1)}}class Am extends Sm{constructor(e,i,s,a,u){super(e,i,s,a,u,!0)}}function ei(r,e,i){return r*(1-i)+e*i}function sf(r,e,i){return r.map(((s,a)=>ei(s,e[a],i)))}lr.black=new lr(0,0,0,1),lr.white=new lr(1,1,1,1),lr.transparent=new lr(0,0,0,0),lr.red=new lr(1,0,0,1),lr.blue=new lr(0,0,1,1);var ou=Object.freeze({__proto__:null,array:sf,color:function(r,e,i){return new lr(ei(r.r,e.r,i),ei(r.g,e.g,i),ei(r.b,e.b,i),ei(r.a,e.a,i))},number:ei});class ns extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class nc{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[s,a]of i)this.bindings[s]=a}concat(e){return new nc(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const ws={kind:"null"},Gt={kind:"number"},Vi={kind:"string"},dr={kind:"boolean"},wo={kind:"color"},Hs={kind:"object"},ar={kind:"value"},hh={kind:"collator"},su={kind:"formatted"},au={kind:"resolvedImage"};function Qn(r,e){return{kind:"array",itemType:r,N:e}}function pn(r){if(r.kind==="array"){const e=pn(r.itemType);return typeof r.N=="number"?`array<${e}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${e}>`}return r.kind}const sy=[ws,Gt,Vi,dr,wo,su,Hs,Qn(ar),au];function $a(r,e){if(e.kind==="error")return null;if(r.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!$a(r.itemType,e.itemType))&&(typeof r.N!="number"||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if(r.kind==="value"){for(const i of sy)if(!$a(i,e))return null}}return`Expected ${pn(r)} but found ${pn(e)} instead.`}function af(r,e){return e.some((i=>i.kind===r.kind))}function lu(r,e){return e.some((i=>i==="null"?r===null:i==="array"?Array.isArray(r):i==="object"?r&&!Array.isArray(r)&&typeof r=="object":i===typeof r))}function dh(r,e){return r.kind==="array"&&e.kind==="array"?r.N===e.N&&dh(r.itemType,e.itemType):r.kind===e.kind}class lf{constructor(e,i,s){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class fh{constructor(e,i,s,a,u){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=s,this.fontStack=a,this.textColor=u}}class co{constructor(e){this.sections=e}static fromString(e){return new co([new fh(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some((e=>e.text.length!==0||!!e.image&&e.image.hasPrimary()))}static factory(e){return e instanceof co?e:co.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map((e=>e.text)).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){const a=i.image.getPrimary().id.toString();e.push(["image",a]);continue}e.push(i.text);const s={};i.fontStack&&(s["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(s["font-scale"]=i.scale),i.textColor&&(s["text-color"]=["rgba"].concat(i.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(s)}return e}}class fa{constructor(e,i={}){this.id=so.from(e),this.params=i.params,this.sx=i.sx||1,this.sy=i.sy||1}toString(){return JSON.stringify(this)}static parse(e){let i,s,a,u;try{({id:i,params:s,sx:a,sy:u}=JSON.parse(e)||{})}catch{return null}return i?new fa(i,{params:s,sx:a,sy:u}):null}scaleSelf(e,i=e){return this.sx*=e,this.sy*=i,this}}class uo{constructor(e,i,s,a,u=!1){this.primaryId=so.from(e),this.primaryOptions=i,s&&(this.secondaryId=so.from(s)),this.secondaryOptions=a,this.available=u}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new fa(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new fa(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?uo.build({name:e}):e}static build(e,i,s,a){return!e||typeof e=="object"&&!("name"in e)?null:new uo(e,s,i,a)}}function Rl(r,e,i,s){return typeof r=="number"&&r>=0&&r<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?s===void 0||typeof s=="number"&&s>=0&&s<=1?null:`Invalid rgba value [${[r,e,i,s].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof s=="number"?[r,e,i,s]:[r,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function oc(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof lr||r instanceof lf||r instanceof co||r instanceof uo)return!0;if(Array.isArray(r)){for(const e of r)if(!oc(e))return!1;return!0}if(typeof r=="object"){for(const e in r)if(!oc(r[e]))return!1;return!0}return!1}function On(r){if(r===null)return ws;if(typeof r=="string")return Vi;if(typeof r=="boolean")return dr;if(typeof r=="number")return Gt;if(r instanceof lr)return wo;if(r instanceof lf)return hh;if(r instanceof co)return su;if(r instanceof uo)return au;if(Array.isArray(r)){const e=r.length;let i;for(const s of r){const a=On(s);if(i){if(i===a)continue;i=ar;break}i=a}return Qn(i||ar,e)}return Hs}function os(r){const e=typeof r;return r===null?"":e==="string"||e==="number"||e==="boolean"?String(r):r instanceof co||r instanceof uo||r instanceof lr?r.toString():JSON.stringify(r)}class pa{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!oc(e[1]))return i.error("invalid value");const s=e[1];let a=On(s);const u=i.expectedType;return a.kind!=="array"||a.N!==0||!u||u.kind!=="array"||typeof u.N=="number"&&u.N!==0||(a=u),new pa(a,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof lr?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof co?this.value.serialize():this.value}}class Cn{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const cf={string:Vi,number:Gt,boolean:dr,object:Hs};class Ts{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s,a=1;const u=e[0];if(u==="array"){let f,g;if(e.length>2){const x=e[1];if(typeof x!="string"||!(x in cf)||x==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);f=cf[x],a++}else f=ar;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);g=e[2],a++}s=Qn(f,g)}else s=cf[u];const h=[];for(;a<e.length;a++){const f=i.parse(e[a],a,ar);if(!f)return null;h.push(f)}return new Ts(s,h)}evaluate(e){for(let i=0;i<this.args.length;i++){const s=this.args[i].evaluate(e);if(!$a(this.type,On(s)))return s;if(i===this.args.length-1)throw new Cn(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${pn(On(s))} but was expected to be of type ${pn(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const s=e.itemType;if(s.kind==="string"||s.kind==="number"||s.kind==="boolean"){i.push(s.kind);const a=e.N;(typeof a=="number"||this.args.length>1)&&i.push(a)}}return i.concat(this.args.map((s=>s.serialize())))}}class Zs{constructor(e){this.type=su,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const s=e[1];if(!Array.isArray(s)&&typeof s=="object")return i.error("First argument must be an image or text section.");const a=[];let u=!1;for(let h=1;h<=e.length-1;++h){const f=e[h];if(u&&typeof f=="object"&&!Array.isArray(f)){u=!1;let g=null;if(f["font-scale"]&&(g=i.parseObjectValue(f["font-scale"],h,"font-scale",Gt),!g))return null;let x=null;if(f["text-font"]&&(x=i.parseObjectValue(f["text-font"],h,"text-font",Qn(Vi)),!x))return null;let T=null;if(f["text-color"]&&(T=i.parseObjectValue(f["text-color"],h,"text-color",wo),!T))return null;const E=a[a.length-1];E.scale=g,E.font=x,E.textColor=T}else{const g=i.parse(e[h],h,ar);if(!g)return null;const x=g.type.kind;if(x!=="string"&&x!=="value"&&x!=="null"&&x!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");u=!0,a.push({content:g,scale:null,font:null,textColor:null})}}return new Zs(a)}evaluate(e){return new co(this.sections.map((i=>{const s=i.content.evaluate(e);return dh(On(s),au)?new fh("",s,null,null,null):new fh(os(s),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)})))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const s={};i.scale&&(s["font-scale"]=i.scale.serialize()),i.font&&(s["text-font"]=i.font.serialize()),i.textColor&&(s["text-color"]=i.textColor.serialize()),e.push(s)}return e}}class _i{constructor(e,i,s,a){this._imageWarnHistory={},this.type=au,this.namePrimary=e,this.nameSecondary=i,s&&(this.paramsPrimary=s.params,this.iconsetIdPrimary=s.iconset?s.iconset.id:void 0),a&&(this.paramsSecondary=a.params,this.iconsetIdSecondary=a.iconset?a.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let s=1;const a=[];function u(){if(s<e.length){const f=i.parse(e[s],s++,Vi);return f?(a.push({image:f,options:{}}),!0):(i.error(a.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function h(){if(s<e.length){const g=e[s];if((f=g)===null||typeof f!="object"||Array.isArray(f))return!0;const x=g.params,T=g.iconset,E=i.concat(s);if(!x&&!T)return s++,!0;if(x){if(typeof x!="object"||x.constructor!==Object)return E.error('Image options "params" should be an object'),!1;const A={},P=E.concat(void 0,"params");for(const L in x){if(!L)return P.error("Image parameter name should be non-empty"),!1;const F=P.concat(void 0,L).parse(x[L],void 0,wo,void 0,{typeAnnotation:"coerce"});if(!F)return!1;A[L]=F}a[a.length-1].options.params=A}if(T){if(typeof T!="object"||T.constructor!==Object)return E.error('Image options "iconset" should be an object'),!1;if(!T.id)return E.error('Image options "iconset" should have an "id" property'),!1;a[a.length-1].options.iconset=T}return s++,!0}var f;return!0}for(let f=0;f<2;f++)if(!u()||!h())return;return new _i(a[0].image,a[1]?a[1].image:void 0,a[0].options,a[1]?a[1].options:void 0)}evaluateParams(e,i){const s={};if(i){for(const a in i)if(i[a])try{s[a]=i[a].evaluate(e)}catch{continue}if(Object.keys(s).length!==0)return{params:s}}}evaluate(e){const i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},s=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,a=uo.build(i,s,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(a&&e.availableImages){const u=a.getPrimary().id;if(a.available=e.availableImages.some((h=>so.isEqual(h,u))),a.available){const h=a.getSecondary()?a.getSecondary().id:null;h&&(a.available=e.availableImages.some((f=>so.isEqual(f,h))))}}return a}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){const s={};if(i&&(s.iconset={id:i}),e){s.params={};for(const a in e)e[a]&&(s.params[a]=e[a].serialize())}return Object.keys(s).length>0?s:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function Bt(r){return ri(r)?"string":sc(r)?"number":mh(r)?"boolean":Array.isArray(r)?"array":r===null?"null":ph(r)?"object":typeof r}function ph(r){return r!=null&&!Array.isArray(r)&&typeof r!="function"&&!(r instanceof String||r instanceof Number||r instanceof Boolean)&&typeof r=="object"}function ri(r){return typeof r=="string"||r instanceof String}function sc(r){return typeof r=="number"||r instanceof Number}function mh(r){return typeof r=="boolean"||r instanceof Boolean}const ti={"to-boolean":dr,"to-color":wo,"to-number":Gt,"to-string":Vi};class $s{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const s=e[0],a=[];let u=ws;if(s==="to-array"){if(!Array.isArray(e[1]))return null;const h=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);u=Qn(i.expectedType.itemType,h)}else{if(!(h>0&&oc(e[1][0])))return null;u=Qn(On(e[1][0]),h)}for(let f=0;f<h;f++){const g=e[1][f];let x;if(Array.isArray(g))x=i.parse(g,void 0,u.itemType);else{const T=Bt(g);if(T!==u.itemType.kind)return i.error(`Expected ${u.itemType.kind} but found ${T}.`);x=i.registry.literal.parse(["literal",g===void 0?null:g],i)}if(!x)return null;a.push(x)}}else{if((s==="to-boolean"||s==="to-string")&&e.length!==2)return i.error("Expected one argument.");u=ti[s];for(let h=1;h<e.length;h++){const f=i.parse(e[h],h,ar);if(!f)return null;a.push(f)}}return new $s(u,a)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,s;for(const a of this.args){if(i=a.evaluate(e),s=null,i instanceof lr)return i;if(typeof i=="string"){const u=e.parseColor(i);if(u)return u}else if(Array.isArray(i)&&(s=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:Rl(i[0],i[1],i[2],i[3]),!s))return new lr(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new Cn(s||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(const s of this.args){if(i=s.evaluate(e),i===null)return 0;const a=Number(i);if(!isNaN(a))return a}throw new Cn(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?co.fromString(os(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?uo.build(os(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map((i=>i.evaluate(e))):os(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){if(this.type.kind==="formatted")return new Zs([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new _i(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild((i=>{e.push(i.serialize())})),e}}const uf=["Unknown","Point","LineString","Polygon"];class _h{constructor(e,i,s){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i,this.iconImageUseTheme=s}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?uf[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:s,y:a}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*i-e[0])+this.featureDistanceData.bearing[1]*(a*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=lr.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class ho{constructor(e,i,s,a,u){this.name=e,this.type=i,this._evaluate=s,this.args=a,this._overloadIndex=u}evaluate(e){if(!this._evaluate){const i=ho.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((e=>e.serialize())))}static parse(e,i){const s=e[0],a=ho.definitions[s];if(!a)return i.error(`Unknown expression "${s}". If you wanted a literal array, use ["literal", [...]].`,0);const u=Array.isArray(a)?a[0]:a.type,h=Array.isArray(a)?[[a[1],a[2]]]:a.overloads,f=[];let g=null,x=-1;for(const[T,E]of h){if(Array.isArray(T)&&T.length!==e.length-1)continue;f.push(T),x++,g=new Ch(i.registry,i.path,null,i.scope,void 0,i._scope,i.options,i.iconImageUseTheme);const A=[];let P=!1;for(let L=1;L<e.length;L++){const F=e[L],U=Array.isArray(T)?T[L-1]:T.type,V=g.parse(F,1+A.length,U);if(!V){P=!0;break}A.push(V)}if(!P)if(Array.isArray(T)&&T.length!==A.length)g.error(`Expected ${T.length} arguments, but found ${A.length} instead.`);else{for(let L=0;L<A.length;L++){const F=Array.isArray(T)?T[L]:T.type,U=A[L];g.concat(L+1).checkSubtype(F,U.type)}if(g.errors.length===0)return new ho(s,u,E,A,x)}}if(f.length===1)i.errors.push(...g.errors);else{const T=(f.length?f:h.map((([A])=>A))).map(gh).join(" | "),E=[];for(let A=1;A<e.length;A++){const P=i.parse(e[A],1+E.length);if(!P)return null;E.push(pn(P.type))}i.error(`Expected arguments of type ${T}, but found (${E.join(", ")}) instead.`)}return null}static register(e,i){ho.definitions=i;for(const s in i)e[s]=ho}}function gh(r){return Array.isArray(r)?`(${r.map(pn).join(", ")})`:`(${pn(r.type)}...)`}class jn{constructor(e,i,s){this.type=hh,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const s=e[1];if(typeof s!="object"||Array.isArray(s))return i.error("Collator options argument must be an object.");const a=s["case-sensitive"]===void 0?i.parse(!1,1,dr):i.parseObjectValue(s["case-sensitive"],1,"case-sensitive",dr);if(!a)return null;const u=s["diacritic-sensitive"]===void 0?i.parse(!1,1,dr):i.parseObjectValue(s["diacritic-sensitive"],1,"diacritic-sensitive",dr);if(!u)return null;let h=null;return s.locale&&(h=i.parseObjectValue(s.locale,1,"locale",Vi),!h)?null:new jn(a,u,h)}evaluate(e){return new lf(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function yh(r,e,i=0,s=r.length-1,a=hf){for(;s>i;){if(s-i>600){const g=s-i+1,x=e-i+1,T=Math.log(g),E=.5*Math.exp(2*T/3),A=.5*Math.sqrt(T*E*(g-E)/g)*(x-g/2<0?-1:1);yh(r,e,Math.max(i,Math.floor(e-x*E/g+A)),Math.min(s,Math.floor(e+(g-x)*E/g+A)),a)}const u=r[e];let h=i,f=s;for(Es(r,i,e),a(r[s],u)>0&&Es(r,i,s);h<f;){for(Es(r,h,f),h++,f--;a(r[h],u)<0;)h++;for(;a(r[f],u)>0;)f--}a(r[i],u)===0?Es(r,i,f):(f++,Es(r,f,s)),f<=e&&(i=f+1),e<=f&&(s=f-1)}}function Es(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}function hf(r,e){return r<e?-1:r>e?1:0}function Wa(r){let e=0;for(let i,s,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],s=r[h],e+=(s.x-i.x)*(i.y+s.y);return e}function ss(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function cu(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function ay(r,e,i){const s=r[0]-e[0],a=r[1]-e[1],u=r[0]-i[0],h=r[1]-i[1];return s*h-u*a==0&&s*u<=0&&a*h<=0}function ac(r,e,i=!1){let s=!1;for(let f=0,g=e.length;f<g;f++){const x=e[f];for(let T=0,E=x.length,A=E-1;T<E;A=T++){const P=x[A],L=x[T];if(ay(r,P,L))return i;(u=P)[1]>(a=r)[1]!=(h=L)[1]>a[1]&&a[0]<(h[0]-u[0])*(a[1]-u[1])/(h[1]-u[1])+u[0]&&(s=!s)}}var a,u,h;return s}function uu(r,e,i,s){const a=s[0]-i[0],u=s[1]-i[1],h=(r[0]-i[0])*u-a*(r[1]-i[1]),f=(e[0]-i[0])*u-a*(e[1]-i[1]);return h>0&&f<0||h<0&&f>0}function hu(r,e,i,s){return(a=[s[0]-i[0],s[1]-i[1]])[0]*(u=[e[0]-r[0],e[1]-r[1]])[1]-a[1]*u[0]!=0&&!(!uu(r,e,i,s)||!uu(i,s,r,e));var a,u}function ma(r){const e=new st(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new st(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const s of r[0])e.x>s.x&&(e.x=s.x),e.y>s.y&&(e.y=s.y),i.x<s.x&&(i.x=s.x),i.y<s.y&&(i.y=s.y);return{min:e,max:i}}const Xa=8192;function ly(r,e){const i=(180+r[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,a=Math.pow(2,e.z);return[Math.round(i*a*Xa),Math.round(s*a*Xa)]}function df(r,e){for(let i=0;i<e.length;i++)if(ac(r,e[i]))return!0;return!1}function cy(r,e,i){for(const s of i)for(let a=0,u=s.length,h=u-1;a<u;h=a++)if(hu(r,e,s[h],s[a]))return!0;return!1}function Cm(r,e){for(let i=0;i<r.length;++i)if(!ac(r[i],e))return!1;for(let i=0;i<r.length-1;++i)if(cy(r[i],r[i+1],e))return!1;return!0}function Mm(r,e){for(let i=0;i<e.length;i++)if(Cm(r,e[i]))return!0;return!1}function ff(r,e,i){const s=[];for(let a=0;a<r.length;a++){const u=[];for(let h=0;h<r[a].length;h++){const f=ly(r[a][h],i);ss(e,f),u.push(f)}s.push(u)}return s}function Ya(r,e,i){const s=[];for(let a=0;a<r.length;a++){const u=ff(r[a],e,i);s.push(u)}return s}function Pm(r,e,i,s){if(r[0]<i[0]||r[0]>i[2]){const a=.5*s;let u=r[0]-i[0]>a?-s:i[0]-r[0]>a?s:0;u===0&&(u=r[0]-i[2]>a?-s:i[2]-r[0]>a?s:0),r[0]+=u}ss(e,r)}function Lm(r,e,i,s){const a=Math.pow(2,s.z)*Xa,u=[s.x*Xa,s.y*Xa],h=[];if(!r)return h;for(const f of r)for(const g of f){const x=[g.x+u[0],g.y+u[1]];Pm(x,e,i,a),h.push(x)}return h}function vh(r,e,i,s){const a=Math.pow(2,s.z)*Xa,u=[s.x*Xa,s.y*Xa],h=[];if(!r)return h;for(const g of r){const x=[];for(const T of g){const E=[T.x+u[0],T.y+u[1]];ss(e,E),x.push(E)}h.push(x)}if(e[2]-e[0]<=a/2){(f=e)[0]=f[1]=1/0,f[2]=f[3]=-1/0;for(const g of h)for(const x of g)Pm(x,e,i,a)}var f;return h}class Ja{constructor(e,i){this.type=dr,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(oc(e[1])){const s=e[1];if(s.type==="FeatureCollection")for(let a=0;a<s.features.length;++a){const u=s.features[a].geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new Ja(s,s.features[a].geometry)}else if(s.type==="Feature"){const a=s.geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new Ja(s,s.geometry)}else if(s.type==="Polygon"||s.type==="MultiPolygon")return new Ja(s,s)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return(function(i,s){const a=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(s.type==="Polygon"){const f=ff(s.coordinates,u,h),g=Lm(i.geometry(),a,u,h);if(!cu(a,u))return!1;for(const x of g)if(!ac(x,f))return!1}if(s.type==="MultiPolygon"){const f=Ya(s.coordinates,u,h),g=Lm(i.geometry(),a,u,h);if(!cu(a,u))return!1;for(const x of g)if(!df(x,f))return!1}return!0})(e,this.geometries);if(e.geometryType()==="LineString")return(function(i,s){const a=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(s.type==="Polygon"){const f=ff(s.coordinates,u,h),g=vh(i.geometry(),a,u,h);if(!cu(a,u))return!1;for(const x of g)if(!Cm(x,f))return!1}if(s.type==="MultiPolygon"){const f=Ya(s.coordinates,u,h),g=vh(i.geometry(),a,u,h);if(!cu(a,u))return!1;for(const x of g)if(!Mm(x,f))return!1}return!0})(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const du={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},as=1/298.257223563,Rm=as*(2-as),lc=Math.PI/180;class cc{static fromTile(e,i,s){const a=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),u=Math.atan(.5*(Math.exp(a)-Math.exp(-a)))/lc;return new cc(u,s)}static get units(){return du}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!du[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(du).join(", ")}`);const s=6378.137*lc*(i?du[i]:1),a=Math.cos(e*lc),u=1/(1-Rm*(1-a*a)),h=Math.sqrt(u);this.kx=s*h*a,this.ky=s*h*u*(1-Rm)}distance(e,i){const s=jo(e[0]-i[0])*this.kx,a=(e[1]-i[1])*this.ky;return Math.sqrt(s*s+a*a)}bearing(e,i){const s=jo(i[0]-e[0])*this.kx;return Math.atan2(s,(i[1]-e[1])*this.ky)/lc}destination(e,i,s){const a=s*lc;return this.offset(e,Math.sin(a)*i,Math.cos(a)*i)}offset(e,i,s){return[e[0]+i/this.kx,e[1]+s/this.ky]}lineDistance(e){let i=0;for(let s=0;s<e.length-1;s++)i+=this.distance(e[s],e[s+1]);return i}area(e){let i=0;for(let s=0;s<e.length;s++){const a=e[s];for(let u=0,h=a.length,f=h-1;u<h;f=u++)i+=jo(a[u][0]-a[f][0])*(a[u][1]+a[f][1])*(s?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let s=0;if(i<=0)return e[0];for(let a=0;a<e.length-1;a++){const u=e[a],h=e[a+1],f=this.distance(u,h);if(s+=f,s>i)return xh(u,h,(i-(s-f))/f)}return e[e.length-1]}pointToSegmentDistance(e,i,s){let[a,u]=i,h=jo(s[0]-a)*this.kx,f=(s[1]-u)*this.ky;if(h!==0||f!==0){const g=(jo(e[0]-a)*this.kx*h+(e[1]-u)*this.ky*f)/(h*h+f*f);g>1?(a=s[0],u=s[1]):g>0&&(a+=h/this.kx*g,u+=f/this.ky*g)}return h=jo(e[0]-a)*this.kx,f=(e[1]-u)*this.ky,Math.sqrt(h*h+f*f)}pointOnLine(e,i){let s=1/0,a=e[0][0],u=e[0][1],h=0,f=0;for(let g=0;g<e.length-1;g++){let x=e[g][0],T=e[g][1],E=jo(e[g+1][0]-x)*this.kx,A=(e[g+1][1]-T)*this.ky,P=0;E===0&&A===0||(P=(jo(i[0]-x)*this.kx*E+(i[1]-T)*this.ky*A)/(E*E+A*A),P>1?(x=e[g+1][0],T=e[g+1][1]):P>0&&(x+=E/this.kx*P,T+=A/this.ky*P)),E=jo(i[0]-x)*this.kx,A=(i[1]-T)*this.ky;const L=E*E+A*A;L<s&&(s=L,a=x,u=T,h=g,f=P)}return{point:[a,u],index:h,t:Math.max(0,Math.min(1,f))}}lineSlice(e,i,s){let a=this.pointOnLine(s,e),u=this.pointOnLine(s,i);if(a.index>u.index||a.index===u.index&&a.t>u.t){const x=a;a=u,u=x}const h=[a.point],f=a.index+1,g=u.index;!pf(s[f],h[0])&&f<=g&&h.push(s[f]);for(let x=f+1;x<=g;x++)h.push(s[x]);return pf(s[g],u.point)||h.push(u.point),h}lineSliceAlong(e,i,s){let a=0;const u=[];for(let h=0;h<s.length-1;h++){const f=s[h],g=s[h+1],x=this.distance(f,g);if(a+=x,a>e&&u.length===0&&u.push(xh(f,g,(e-(a-x))/x)),a>=i)return u.push(xh(f,g,(i-(a-x))/x)),u;a>e&&u.push(g)}return u}bufferPoint(e,i){const s=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-s,e[0]+a,e[1]+s]}bufferBBox(e,i){const s=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-s,e[2]+a,e[3]+s]}insideBBox(e,i){return jo(e[0]-i[0])>=0&&jo(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function pf(r,e){return r[0]===e[0]&&r[1]===e[1]}function xh(r,e,i){const s=jo(e[0]-r[0]);return[r[0]+s*i,r[1]+(e[1]-r[1])*i]}function jo(r){for(;r<-180;)r+=360;for(;r>180;)r-=360;return r}class bh{constructor(e=[],i=((s,a)=>s<a?-1:s>a?1:0)){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let s=(this.length>>1)-1;s>=0;s--)this._down(s)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:s}=this,a=i[e];for(;e>0;){const u=e-1>>1,h=i[u];if(s(a,h)>=0)break;i[e]=h,e=u}i[e]=a}_down(e){const{data:i,compare:s}=this,a=this.length>>1,u=i[e];for(;e<a;){let h=1+(e<<1);const f=h+1;if(f<this.length&&s(i[f],i[h])<0&&(h=f),s(i[h],u)>=0)break;i[e]=i[h],e=h}i[e]=u}}var gt=8192;function mf(r,e){return e.dist-r.dist}const wh=100,Th=50;function _f(r){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==r.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==r[i])return!1;return!0}function fu(r){return r[1]-r[0]+1}function Ws(r,e){const i=r[1]>=r[0]&&r[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function gf(r,e){if(r[0]>r[1])return[null,null];const i=fu(r);if(e){if(i===2)return[r,null];const s=Math.floor(i/2);return[[r[0],r[0]+s],[r[0]+s,r[1]]]}{if(i===1)return[r,null];const s=Math.floor(i/2)-1;return[[r[0],r[0]+s],[r[0]+s+1,r[1]]]}}function Dl(r,e){const i=[1/0,1/0,-1/0,-1/0];if(!Ws(e,r.length))return i;for(let s=e[0];s<=e[1];++s)ss(i,r[s]);return i}function Ol(r){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<r.length;++i)for(let s=0;s<r[i].length;++s)ss(e,r[i][s]);return e}function Ka(r,e,i){if(_f(r)||_f(e))return NaN;let s=0,a=0;return r[2]<e[0]&&(s=e[0]-r[2]),r[0]>e[2]&&(s=r[0]-e[2]),r[1]>e[3]&&(a=r[1]-e[3]),r[3]<e[1]&&(a=e[1]-r[3]),i.distance([0,0],[s,a])}function Eh(r){return 360*r-180}function Dm(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Sh(r,e){const i=Math.pow(2,e.z),s=(r.y/gt+e.y)/i;return[Eh((r.x/gt+e.x)/i),Dm(s)]}function uy(r,e){const i=[];for(let s=0;s<r.length;++s)i.push(Sh(r[s],e));return i}function Om(r,e,i){const s=i.pointOnLine(e,r).point;return i.distance(r,s)}function yf(r,e,i,s,a){const u=i.slice(s[0],s[1]+1);let h=1/0;for(let f=e[0];f<=e[1];++f)if((h=Math.min(h,Om(r[f],u,a)))===0)return 0;return h}function Qa(r,e,i,s,a){const u=Math.min(a.pointToSegmentDistance(r,i,s),a.pointToSegmentDistance(e,i,s)),h=Math.min(a.pointToSegmentDistance(i,r,e),a.pointToSegmentDistance(s,r,e));return Math.min(u,h)}function ji(r,e,i,s,a){if(!Ws(e,r.length)||!Ws(s,i.length))return NaN;let u=1/0;for(let h=e[0];h<e[1];++h)for(let f=s[0];f<s[1];++f){if(hu(r[h],r[h+1],i[f],i[f+1]))return 0;u=Math.min(u,Qa(r[h],r[h+1],i[f],i[f+1],a))}return u}function hy(r,e,i,s,a){if(!Ws(e,r.length)||!Ws(s,i.length))return NaN;let u=1/0;for(let h=e[0];h<=e[1];++h)for(let f=s[0];f<=s[1];++f)if((u=Math.min(u,a.distance(r[h],i[f])))===0)return u;return u}function dy(r,e,i){if(ac(r,e,!0))return 0;let s=1/0;for(const a of e){const u=a.length;if(u<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(a[0]!==a[u-1]&&(s=Math.min(s,i.pointToSegmentDistance(r,a[u-1],a[0])))===0||(s=Math.min(s,Om(r,a,i)))===0)return s}return s}function fy(r,e,i,s){if(!Ws(e,r.length))return NaN;for(let u=e[0];u<=e[1];++u)if(ac(r[u],i,!0))return 0;let a=1/0;for(let u=e[0];u<e[1];++u)for(const h of i)for(let f=0,g=h.length,x=g-1;f<g;x=f++){if(hu(r[u],r[u+1],h[x],h[f]))return 0;a=Math.min(a,Qa(r[u],r[u+1],h[x],h[f],s))}return a}function vf(r,e){for(const i of r)for(let s=0;s<=i.length-1;++s)if(ac(i[s],e,!0))return!0;return!1}function py(r,e,i,s=1/0){const a=Ol(r),u=Ol(e);if(s!==1/0&&Ka(a,u,i)>=s)return s;if(cu(a,u)){if(vf(r,e))return 0}else if(vf(e,r))return 0;let h=s;for(const f of r)for(let g=0,x=f.length,T=x-1;g<x;T=g++)for(const E of e)for(let A=0,P=E.length,L=P-1;A<P;L=A++){if(hu(f[T],f[g],E[L],E[A]))return 0;h=Math.min(h,Qa(f[T],f[g],E[L],E[A],i))}return h}function Or(r,e,i,s,a,u,h){if(u===null||h===null)return;const f=Ka(Dl(s,u),Dl(a,h),i);f<e&&r.push({dist:f,range1:u,range2:h})}function my(r,e,i,s,a=1/0){let u=Math.min(s.distance(r[0],i[0][0]),a);if(u===0)return u;const h=new bh([{dist:0,range1:[0,r.length-1],range2:[0,0]}],mf),f=e?Th:wh,g=Ol(i);for(;h.length;){const x=h.pop();if(x.dist>=u)continue;const T=x.range1;if(fu(T)<=f){if(!Ws(T,r.length))return NaN;if(e){const E=fy(r,T,i,s);if((u=Math.min(u,E))===0)return u}else for(let E=T[0];E<=T[1];++E){const A=dy(r[E],i,s);if((u=Math.min(u,A))===0)return u}}else{const E=gf(T,e);if(E[0]!==null){const A=Ka(Dl(r,E[0]),g,s);A<u&&h.push({dist:A,range1:E[0],range2:[0,0]})}if(E[1]!==null){const A=Ka(Dl(r,E[1]),g,s);A<u&&h.push({dist:A,range1:E[1],range2:[0,0]})}}}return u}function zm(r,e,i,s,a,u=1/0){let h=Math.min(u,a.distance(r[0],i[0]));if(h===0)return h;const f=new bh([{dist:0,range1:[0,r.length-1],range2:[0,i.length-1]}],mf),g=e?Th:wh,x=s?Th:wh;for(;f.length;){const T=f.pop();if(T.dist>=h)continue;const E=T.range1,A=T.range2;if(fu(E)<=g&&fu(A)<=x){if(!Ws(E,r.length)||!Ws(A,i.length))return NaN;if(e&&s?h=Math.min(h,ji(r,E,i,A,a)):e||s?e&&!s?h=Math.min(h,yf(i,A,r,E,a)):!e&&s&&(h=Math.min(h,yf(r,E,i,A,a))):h=Math.min(h,hy(r,E,i,A,a)),h===0)return h}else{const P=gf(E,e),L=gf(A,s);Or(f,h,a,r,i,P[0],L[0]),Or(f,h,a,r,i,P[0],L[1]),Or(f,h,a,r,i,P[1],L[0]),Or(f,h,a,r,i,P[1],L[1])}}return h}function xf(r,e,i,s,a=1/0){let u=a;const h=Dl(r,[0,r.length-1]);for(const f of i)if(!(u!==1/0&&Ka(h,Dl(f,[0,f.length-1]),s)>=u)&&(u=Math.min(u,zm(r,e,f,!0,s,u)),u===0))return u;return u}function Ih(r,e,i,s,a=1/0){let u=a;const h=Dl(r,[0,r.length-1]);for(const f of i){if(u!==1/0&&Ka(h,Ol(f),s)>=u)continue;const g=my(r,e,f,s,u);if(isNaN(g))return g;if((u=Math.min(u,g))===0)return u}return u}function bf(r){return r==="Point"||r==="MultiPoint"||r==="LineString"||r==="MultiLineString"||r==="Polygon"||r==="MultiPolygon"}class zl{constructor(e,i){this.type=Gt,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(oc(e[1])){const s=e[1];if(s.type==="FeatureCollection"){for(let a=0;a<s.features.length;++a)if(bf(s.features[a].geometry.type))return new zl(s,s.features[a].geometry)}else if(s.type==="Feature"){if(bf(s.geometry.type))return new zl(s,s.geometry)}else if(bf(s.type))return new zl(s,s)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),s=e.canonicalID();if(i!=null&&s!=null){if(e.geometryType()==="Point")return(function(a,u,h){const f=[];for(const x of a)for(const T of x)f.push(Sh(T,u));const g=new cc(f[0][1],"meters");return h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString"?zm(f,!1,h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",g):h.type==="MultiLineString"?xf(f,!1,h.coordinates,g):h.type==="Polygon"||h.type==="MultiPolygon"?Ih(f,!1,h.type==="Polygon"?[h.coordinates]:h.coordinates,g):null})(i,s,this.geometries);if(e.geometryType()==="LineString")return(function(a,u,h){const f=[];for(const x of a){const T=[];for(const E of x)T.push(Sh(E,u));f.push(T)}const g=new cc(f[0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return xf(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",f,g);if(h.type==="MultiLineString"){let x=1/0;for(let T=0;T<h.coordinates.length;T++){const E=xf(h.coordinates[T],!0,f,g,x);if(isNaN(E))return E;if((x=Math.min(x,E))===0)return x}return x}if(h.type==="Polygon"||h.type==="MultiPolygon"){let x=1/0;for(let T=0;T<f.length;T++){const E=Ih(f[T],!0,h.type==="Polygon"?[h.coordinates]:h.coordinates,g,x);if(isNaN(E))return E;if((x=Math.min(x,E))===0)return x}return x}return null})(i,s,this.geometries);if(e.geometryType()==="Polygon")return(function(a,u,h){const f=[];for(const x of(function(T,E){const A=T.length;if(A<=1)return[T];const P=[];let L,F;for(let U=0;U<A;U++){const V=Wa(T[U]);V!==0&&(T[U].area=Math.abs(V),F===void 0&&(F=V<0),F===V<0?(L&&P.push(L),L=[T[U]]):L.push(T[U]))}return L&&P.push(L),P})(a)){const T=[];for(let E=0;E<x.length;++E)T.push(uy(x[E],u));f.push(T)}const g=new cc(f[0][0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return Ih(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",f,g);if(h.type==="MultiLineString"){let x=1/0;for(let T=0;T<h.coordinates.length;T++){const E=Ih(h.coordinates[T],!0,f,g,x);if(isNaN(E))return E;if((x=Math.min(x,E))===0)return x}return x}return h.type==="Polygon"||h.type==="MultiPolygon"?(function(x,T,E){let A=1/0;for(const P of x)for(const L of T){const F=py(P,L,E,A);if(isNaN(F))return F;if((A=Math.min(A,F))===0)return A}return A})(h.type==="Polygon"?[h.coordinates]:h.coordinates,f,g):null})(i,s,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function uc(r){if(r instanceof ho&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof Ja||r instanceof zl)return!1;if(r instanceof dc)return r.featureConstant;let e=!0;return r.eachChild((i=>{e&&!uc(i)&&(e=!1)})),e}function pu(r){if(r instanceof ho&&r.name==="feature-state")return!1;let e=!0;return r.eachChild((i=>{e&&!pu(i)&&(e=!1)})),e}function hc(r,e){if(r instanceof ho&&e.indexOf(r.name)>=0)return!1;let i=!0;return r.eachChild((s=>{i&&!hc(s,e)&&(i=!1)})),i}function km(r,e,i){return[r,e,i].filter(Boolean).join("")}function wf(r,e){switch(r){case"string":return os(e);case"number":return+e;case"boolean":return!!e;case"color":return lr.parse(e);case"formatted":return co.fromString(os(e));case"resolvedImage":return uo.build(os(e))}return e}function Fm(r,e,i,s){return s!==void 0&&(r=s*Math.round(r/s)),e!==void 0&&r<e&&(r=e),i!==void 0&&r>i&&(r=i),r}class dc{constructor(e,i,s,a=!1){this.type=e,this.key=i,this.scope=s,this.featureConstant=a}static parse(e,i){let s=i.expectedType;if(s==null&&(s=ar),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const a=i.parse(e[1],1);if(!(a instanceof pa))return i.error("Key name of 'config' expression must be a string literal.");let u,h=!0;const f=os(a.value);if(e.length>=3){const g=i.parse(e[2],2);if(!(g instanceof pa))return i.error("Scope of 'config' expression must be a string literal.");u=os(g.value)}if(i.options){const g=km(f,u,i._scope),x=i.options.get(g);x&&(h=uc(x.value||x.default))}return new dc(s,f,u,h)}evaluate(e){const i=km(this.key,this.scope,e.scope),s=e.getConfig(i);if(!s)return null;const{type:a,value:u,values:h,minValue:f,maxValue:g,stepValue:x}=s,T=s.default.evaluate(e);let E=T;if(u){const A=e.scope;e.scope=(A||"").split("").slice(1).join(""),E=u.evaluate(e),e.scope=A}return a&&(E=wf(a,E)),E===void 0||f===void 0&&g===void 0&&x===void 0||(typeof E=="number"?E=Fm(E,f,g,x):Array.isArray(E)&&(E=E.map((A=>typeof A=="number"?Fm(A,f,g,x):A)))),u!==void 0&&E!==void 0&&h&&!h.includes(E)&&(E=T,a&&(E=wf(a,E))),(a&&a!==this.type||E!==void 0&&!dh(On(E),this.type))&&(E=wf(this.type.kind,E)),E}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Ah{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const s=e[1];return i.scope.has(s)?new Ah(s,i.scope.get(s)):i.error(`Unknown variable "${s}". Make sure "${s}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ch{constructor(e,i=[],s,a=new nc,u=[],h,f,g){this.registry=e,this.path=i,this.key=i.map((x=>typeof x=="string"?`['${x}']`:`[${x}]`)).join(""),this.scope=a,this.errors=u,this.expectedType=s,this._scope=h,this.options=f,this.iconImageUseTheme=g}parse(e,i,s,a,u={}){return i||s?this.concat(i,null,s,a)._parse(e,u):this._parse(e,u)}parseObjectValue(e,i,s,a,u,h={}){return this.concat(i,s,a,u)._parse(e,h)}_parse(e,i){function s(a,u,h){return h==="assert"?new Ts(u,[a]):h==="coerce"?new $s(u,[a]):a}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const a=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(a){let u=a.parse(e,this);if(!u)return null;if(this.expectedType){const h=this.expectedType,f=u.type;if(h.kind!=="string"&&h.kind!=="number"&&h.kind!=="boolean"&&h.kind!=="object"&&h.kind!=="array"||f.kind!=="value")if(h.kind!=="color"&&h.kind!=="formatted"&&h.kind!=="resolvedImage"||f.kind!=="value"&&f.kind!=="string"){if(this.checkSubtype(h,f))return null}else u=s(u,h,i.typeAnnotation||"coerce");else u=s(u,h,i.typeAnnotation||"assert")}if(!(u instanceof pa)&&u.type.kind!=="resolvedImage"&&Tf(u)){const h=new _h(this._scope,this.options,this.iconImageUseTheme);try{u=new pa(u.type,u.evaluate(h))}catch(f){return this.error(f.message),null}}return u}return $s.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,s,a){let u=typeof e=="number"?this.path.concat(e):this.path;u=typeof i=="string"?u.concat(i):u;const h=a?this.scope.concat(a):this.scope;return new Ch(this.registry,u,s||null,h,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(e,...i){const s=`${this.key}${i.map((a=>`[${a}]`)).join("")}`;this.errors.push(new ns(s,e))}checkSubtype(e,i){const s=$a(e,i);return s&&this.error(s),s}}function Tf(r){if(r instanceof Ah)return Tf(r.boundExpression);if(r instanceof ho&&r.name==="error"||r instanceof jn||r instanceof Ja||r instanceof zl||r instanceof dc)return!1;const e=r instanceof $s||r instanceof Ts;let i=!0;return r.eachChild((s=>{i=e?i&&Tf(s):i&&s instanceof pa})),!!i&&uc(r)&&hc(r,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Mh(r,e){const i=r.length-1;let s,a,u=0,h=i,f=0;for(;u<=h;)if(f=Math.floor((u+h)/2),s=r[f],a=r[f+1],s<=e){if(f===i||e<a)return f;u=f+1}else{if(!(s>e))throw new Cn("Input is not a number.");h=f-1}return 0}class mu{constructor(e,i,s){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[a,u]of s)this.labels.push(a),this.outputs.push(u)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const s=i.parse(e[1],1,Gt);if(!s)return null;const a=[];let u=null;i.expectedType&&i.expectedType.kind!=="value"&&(u=i.expectedType);for(let h=1;h<e.length;h+=2){const f=h===1?-1/0:e[h],g=e[h+1],x=h,T=h+1;if(typeof f!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',x);if(a.length&&a[a.length-1][0]>=f)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',x);const E=i.parse(g,T,u);if(!E)return null;u=u||E.type,a.push([f,E])}return new mu(u,s,a)}evaluate(e){const i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);const a=this.input.evaluate(e);if(a<=i[0])return s[0].evaluate(e);const u=i.length;return a>=i[u-1]?s[u-1].evaluate(e):s[Mh(i,a)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const Bm=.95047,Nm=1.08883,Vm=4/29,fc=6/29,Um=3*fc*fc,_y=fc*fc*fc,gy=Math.PI/180,yy=180/Math.PI;function Ef(r){return r>_y?Math.pow(r,1/3):r/Um+Vm}function Sf(r){return r>fc?r*r*r:Um*(r-Vm)}function If(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function Af(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function jm(r){const e=Af(r.r),i=Af(r.g),s=Af(r.b),a=Ef((.4124564*e+.3575761*i+.1804375*s)/Bm),u=Ef((.2126729*e+.7151522*i+.072175*s)/1);return{l:116*u-16,a:500*(a-u),b:200*(u-Ef((.0193339*e+.119192*i+.9503041*s)/Nm)),alpha:r.a}}function Ph(r){let e=(r.l+16)/116,i=isNaN(r.a)?e:e+r.a/500,s=isNaN(r.b)?e:e-r.b/200;return e=1*Sf(e),i=Bm*Sf(i),s=Nm*Sf(s),new lr(If(3.2404542*i-1.5371385*e-.4985314*s),If(-.969266*i+1.8760108*e+.041556*s),If(.0556434*i-.2040259*e+1.0572252*s),r.alpha)}function Lh(r,e,i){const s=e-r;return r+i*(s>180||s<-180?s-360*Math.round(s/360):s)}const pc={forward:jm,reverse:Ph,interpolate:function(r,e,i){return{l:ei(r.l,e.l,i),a:ei(r.a,e.a,i),b:ei(r.b,e.b,i),alpha:ei(r.alpha,e.alpha,i)}}},_u={forward:function(r){const{l:e,a:i,b:s}=jm(r),a=Math.atan2(s,i)*yy;return{h:a<0?a+360:a,c:Math.sqrt(i*i+s*s),l:e,alpha:r.a}},reverse:function(r){const e=r.h*gy,i=r.c;return Ph({l:r.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:r.alpha})},interpolate:function(r,e,i){return{h:Lh(r.h,e.h,i),c:ei(r.c,e.c,i),l:ei(r.l,e.l,i),alpha:ei(r.alpha,e.alpha,i)}}};var Gm=Object.freeze({__proto__:null,hcl:_u,lab:pc});class Go{constructor(e,i,s,a,u){this.type=e,this.operator=i,this.interpolation=s,this.input=a,this.labels=[],this.outputs=[];for(const[h,f]of u)this.labels.push(h),this.outputs.push(f)}static interpolationFactor(e,i,s,a){let u=0;if(e.name==="exponential")u=Rh(i,e.base,s,a);else if(e.name==="linear")u=Rh(i,1,s,a);else if(e.name==="cubic-bezier"){const h=e.controlPoints;u=new th(h[0],h[1],h[2],h[3]).solve(Rh(i,1,s,a))}return u}static parse(e,i){let[s,a,u,...h]=e;if(!Array.isArray(a)||a.length===0)return i.error("Expected an interpolation type expression.",1);if(a[0]==="linear")a={name:"linear"};else if(a[0]==="exponential"){const x=a[1];if(typeof x!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);a={name:"exponential",base:x}}else{if(a[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(a[0])}`,1,0);{const x=a.slice(1);if(x.length!==4||x.some((T=>typeof T!="number"||T<0||T>1)))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);a={name:"cubic-bezier",controlPoints:x}}}if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(u=i.parse(u,2,Gt),!u)return null;const f=[];let g=null;s==="interpolate-hcl"||s==="interpolate-lab"?g=wo:i.expectedType&&i.expectedType.kind!=="value"&&(g=i.expectedType);for(let x=0;x<h.length;x+=2){const T=h[x],E=h[x+1],A=x+3,P=x+4;if(typeof T!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',A);if(f.length&&f[f.length-1][0]>=T)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',A);const L=i.parse(E,P,g);if(!L)return null;g=g||L.type,f.push([T,L])}return g.kind==="number"||g.kind==="color"||g.kind==="array"&&g.itemType.kind==="number"&&typeof g.N=="number"?new Go(g,s,a,u,f):i.error(`Type ${pn(g)} is not interpolatable.`)}evaluate(e){const i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);const a=this.input.evaluate(e);if(a<=i[0])return s[0].evaluate(e);const u=i.length;if(a>=i[u-1])return s[u-1].evaluate(e);const h=Mh(i,a),f=Go.interpolationFactor(this.interpolation,a,i[h],i[h+1]),g=s[h].evaluate(e),x=s[h+1].evaluate(e);return this.operator==="interpolate"?ou[this.type.kind.toLowerCase()](g,x,f):this.operator==="interpolate-hcl"?_u.reverse(_u.interpolate(_u.forward(g),_u.forward(x),f)):pc.reverse(pc.interpolate(pc.forward(g),pc.forward(x),f))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const i=[this.operator,e,this.input.serialize()];for(let s=0;s<this.labels.length;s++)i.push(this.labels[s],this.outputs[s].serialize());return i}}function Rh(r,e,i,s){const a=s-i,u=r-i;return a===0?0:e===1?u/a:(Math.pow(e,u)-1)/(Math.pow(e,a)-1)}class gu{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let s=null;const a=i.expectedType;a&&a.kind!=="value"&&(s=a);const u=[];for(const f of e.slice(1)){const g=i.parse(f,1+u.length,s,void 0,{typeAnnotation:"omit"});if(!g)return null;s=s||g.type,u.push(g)}const h=a&&u.some((f=>$a(a,f.type)));return new gu(h?ar:s,u)}evaluate(e){let i,s=null,a=0;for(const u of this.args){if(a++,s=u.evaluate(e),s&&s instanceof uo&&!s.available&&(i||(i=s),s=null,a===this.args.length))return i;if(s!==null)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=["coalesce"];return this.eachChild((i=>{e.push(i.serialize())})),e}}class _a{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const s=[];for(let u=1;u<e.length-1;u+=2){const h=e[u];if(typeof h!="string")return i.error(`Expected string, but found ${typeof h} instead.`,u);if(/[^a-zA-Z0-9_]/.test(h))return i.error("Variable names must contain only alphanumeric characters or '_'.",u);const f=i.parse(e[u+1],u+1);if(!f)return null;s.push([h,f])}const a=i.parse(e[e.length-1],e.length-1,i.expectedType,s);return a?new _a(s,a):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,s]of this.bindings)e.push(i,s.serialize());return e.push(this.result.serialize()),e}}class Dh{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Gt),a=i.parse(e[2],2,Qn(i.expectedType||ar));return s&&a?new Dh(a.type.itemType,s,a):null}evaluate(e){const i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new Cn("Array index out of bounds: negative index");if(i>=s.length)throw new Cn("Array index out of bounds: index exceeds array size");if(i!==Math.floor(i))throw new Cn("Array index must be an integer. Use at-interpolated for fractional indices");return s[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Oh{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Gt),a=i.parse(e[2],2,Qn(i.expectedType||ar));return s&&a?new Oh(a.type.itemType,s,a):null}evaluate(e){const i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new Cn(`Array index out of bounds: ${i} < 0.`);if(i>s.length-1)throw new Cn(`Array index out of bounds: ${i} > ${s.length-1}.`);if(i===Math.floor(i))return s[i];const a=Math.floor(i),u=Math.ceil(i),h=s[a],f=s[u];if(typeof h!="number"||typeof f!="number")throw new Cn(`Cannot interpolate between non-number values at index ${i}.`);const g=i-a;return h*(1-g)+f*g}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Cf{constructor(e,i){this.type=dr,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,ar),a=i.parse(e[2],2,ar);return s&&a?af(s.type,[dr,Vi,Gt,ws,ar])?new Cf(s,a):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${pn(s.type)} instead`):null}evaluate(e){const i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(s==null)return!1;if(!lu(i,["boolean","string","number","null"]))throw new Cn(`Expected first argument to be of type boolean, string, number or null, but found ${pn(On(i))} instead.`);if(!lu(s,["string","array"]))throw new Cn(`Expected second argument to be of type array or string, but found ${pn(On(s))} instead.`);return s.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class mc{constructor(e,i,s){this.type=Gt,this.needle=e,this.haystack=i,this.fromIndex=s}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,ar),a=i.parse(e[2],2,ar);if(!s||!a)return null;if(!af(s.type,[dr,Vi,Gt,ws,ar]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${pn(s.type)} instead`);if(e.length===4){const u=i.parse(e[3],3,Gt);return u?new mc(s,a,u):null}return new mc(s,a)}evaluate(e){const i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!lu(i,["boolean","string","number","null"]))throw new Cn(`Expected first argument to be of type boolean, string, number or null, but found ${pn(On(i))} instead.`);if(!lu(s,["string","array"]))throw new Cn(`Expected second argument to be of type array or string, but found ${pn(On(s))} instead.`);if(this.fromIndex){const a=this.fromIndex.evaluate(e);return s.indexOf(i,a)}return s.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class yu{constructor(e,i,s,a,u,h){this.inputType=e,this.type=i,this.input=s,this.cases=a,this.outputs=u,this.otherwise=h}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let s,a;i.expectedType&&i.expectedType.kind!=="value"&&(a=i.expectedType);const u={},h=[];for(let x=2;x<e.length-1;x+=2){let T=e[x];const E=e[x+1];Array.isArray(T)||(T=[T]);const A=i.concat(x);if(T.length===0)return A.error("Expected at least one branch label.");for(const L of T){if(typeof L!="number"&&typeof L!="string")return A.error("Branch labels must be numbers or strings.");if(typeof L=="number"&&Math.abs(L)>Number.MAX_SAFE_INTEGER)return A.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof L=="number"&&Math.floor(L)!==L)return A.error("Numeric branch labels must be integer values.");if(s){if(A.checkSubtype(s,On(L)))return null}else s=On(L);if(u[String(L)]!==void 0)return A.error("Branch labels must be unique.");u[String(L)]=h.length}const P=i.parse(E,x,a);if(!P)return null;a=a||P.type,h.push(P)}const f=i.parse(e[1],1,ar);if(!f)return null;const g=i.parse(e[e.length-1],e.length-1,a);return g?f.type.kind!=="value"&&i.concat(1).checkSubtype(s,f.type)?null:new yu(s,a,f,u,h,g):null}evaluate(e){const i=this.input.evaluate(e);return(dh(On(i),this.inputType)&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),s=[],a={};for(const h of i){const f=a[this.cases[h]];f===void 0?(a[this.cases[h]]=s.length,s.push([this.cases[h],[h]])):s[f][1].push(h)}const u=h=>this.inputType.kind==="number"?Number(h):h;for(const[h,f]of s)e.push(f.length===1?u(f[0]):f.map(u)),e.push(this.outputs[h].serialize());return e.push(this.otherwise.serialize()),e}}class vu{constructor(e,i,s){this.type=e,this.branches=i,this.otherwise=s}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let s;i.expectedType&&i.expectedType.kind!=="value"&&(s=i.expectedType);const a=[];for(let h=1;h<e.length-1;h+=2){const f=i.parse(e[h],h,dr);if(!f)return null;const g=i.parse(e[h+1],h+1,s);if(!g)return null;a.push([f,g]),s=s||g.type}const u=i.parse(e[e.length-1],e.length-1,s);return u?new vu(s,a,u):null}evaluate(e){for(const[i,s]of this.branches)if(i.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,s]of this.branches)e(i),e(s);e(this.otherwise)}outputDefined(){return this.branches.every((([e,i])=>i.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild((i=>{e.push(i.serialize())})),e}}class zh{constructor(e,i,s,a){this.type=e,this.input=i,this.beginIndex=s,this.endIndex=a}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,ar),a=i.parse(e[2],2,Gt);if(!s||!a)return null;if(!af(s.type,[Qn(ar),Vi,ar]))return i.error(`Expected first argument to be of type array or string, but found ${pn(s.type)} instead`);if(e.length===4){const u=i.parse(e[3],3,Gt);return u?new zh(s.type,s,a,u):null}return new zh(s.type,s,a)}evaluate(e){const i=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!lu(i,["string","array"]))throw new Cn(`Expected first argument to be of type array or string, but found ${pn(On(i))} instead.`);if(this.endIndex){const a=this.endIndex.evaluate(e);return i.slice(s,a)}return i.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class Mf{constructor(e,i){this.type=Qn(Vi),this.str=e,this.delimiter=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Vi),a=i.parse(e[2],2,Vi);return s&&a?new Mf(s,a):void 0}evaluate(e){const i=this.str.evaluate(e),s=this.delimiter.evaluate(e);return i.split(s)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function Pf(r,e){return r==="=="||r==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Lf(r,e,i,s){return s.compare(e,i)===0}function _c(r,e,i){const s=r!=="=="&&r!=="!=";return class PE{constructor(u,h,f){this.type=dr,this.lhs=u,this.rhs=h,this.collator=f,this.hasUntypedArgument=u.type.kind==="value"||h.type.kind==="value"}static parse(u,h){if(u.length!==3&&u.length!==4)return h.error("Expected two or three arguments.");const f=u[0];let g=h.parse(u[1],1,ar);if(!g)return null;if(!Pf(f,g.type))return h.concat(1).error(`"${f}" comparisons are not supported for type '${pn(g.type)}'.`);let x=h.parse(u[2],2,ar);if(!x)return null;if(!Pf(f,x.type))return h.concat(2).error(`"${f}" comparisons are not supported for type '${pn(x.type)}'.`);if(g.type.kind!==x.type.kind&&g.type.kind!=="value"&&x.type.kind!=="value")return h.error(`Cannot compare types '${pn(g.type)}' and '${pn(x.type)}'.`);s&&(g.type.kind==="value"&&x.type.kind!=="value"?g=new Ts(x.type,[g]):g.type.kind!=="value"&&x.type.kind==="value"&&(x=new Ts(g.type,[x])));let T=null;if(u.length===4){if(g.type.kind!=="string"&&x.type.kind!=="string"&&g.type.kind!=="value"&&x.type.kind!=="value")return h.error("Cannot use collator to compare non-string types.");if(T=h.parse(u[3],3,hh),!T)return null}return new PE(g,x,T)}evaluate(u){const h=this.lhs.evaluate(u),f=this.rhs.evaluate(u);if(s&&this.hasUntypedArgument){const g=On(h),x=On(f);if(g.kind!==x.kind||g.kind!=="string"&&g.kind!=="number")throw new Cn(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${g.kind}, ${x.kind}) instead.`)}if(this.collator&&!s&&this.hasUntypedArgument){const g=On(h),x=On(f);if(g.kind!=="string"||x.kind!=="string")return e(u,h,f)}return this.collator?i(u,h,f,this.collator.evaluate(u)):e(u,h,f)}eachChild(u){u(this.lhs),u(this.rhs),this.collator&&u(this.collator)}outputDefined(){return!0}serialize(){const u=[r];return this.eachChild((h=>{u.push(h.serialize())})),u}}}const vy=_c("==",(function(r,e,i){return e===i}),Lf),xy=_c("!=",(function(r,e,i){return e!==i}),(function(r,e,i,s){return!Lf(0,e,i,s)})),qm=_c("<",(function(r,e,i){return e<i}),(function(r,e,i,s){return s.compare(e,i)<0})),Hm=_c(">",(function(r,e,i){return e>i}),(function(r,e,i,s){return s.compare(e,i)>0})),kh=_c("<=",(function(r,e,i){return e<=i}),(function(r,e,i,s){return s.compare(e,i)<=0})),by=_c(">=",(function(r,e,i){return e>=i}),(function(r,e,i,s){return s.compare(e,i)>=0}));class Fh{constructor(e,i,s,a,u,h){this.type=Vi,this.number=e,this.locale=i,this.currency=s,this.unit=a,this.minFractionDigits=u,this.maxFractionDigits=h}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const s=i.parse(e[1],1,Gt);if(!s)return null;const a=e[2];if(typeof a!="object"||Array.isArray(a))return i.error("NumberFormat options argument must be an object.");let u=null;if(a.locale&&(u=i.parseObjectValue(a.locale,2,"locale",Vi),!u))return null;let h=null;if(a.currency&&(h=i.parseObjectValue(a.currency,2,"currency",Vi),!h))return null;let f=null;if(a.unit&&(f=i.parseObjectValue(a.unit,2,"unit",Vi),!f))return null;let g=null;if(a["min-fraction-digits"]&&(g=i.parseObjectValue(a["min-fraction-digits"],2,"min-fraction-digits",Gt),!g))return null;let x=null;return a["max-fraction-digits"]&&(x=i.parseObjectValue(a["max-fraction-digits"],2,"max-fraction-digits",Gt),!x)?null:new Fh(s,u,h,f,g,x)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Rf{constructor(e){this.type=Gt,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);const s=i.parse(e[1],1);return s?s.type.kind!=="array"&&s.type.kind!=="string"&&s.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${pn(s.type)} instead.`):new Rf(s):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new Cn(`Expected value to be of type string or array, but found ${pn(On(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild((i=>{e.push(i.serialize())})),e}}function Zm(r){return function(){r=1831565813+(r|=0)|0;let e=Math.imul(r^r>>>15,1|r);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const gc={"==":vy,"!=":xy,">":Hm,"<":qm,">=":by,"<=":kh,array:Ts,at:Dh,"at-interpolated":Oh,boolean:Ts,case:vu,coalesce:gu,collator:jn,format:Zs,image:_i,in:Cf,"index-of":mc,interpolate:Go,"interpolate-hcl":Go,"interpolate-lab":Go,length:Rf,let:_a,literal:pa,match:yu,number:Ts,"number-format":Fh,object:Ts,slice:zh,step:mu,string:Ts,"to-boolean":$s,"to-color":$s,"to-number":$s,"to-string":$s,var:Ah,within:Ja,distance:zl,config:dc,split:Mf};function Df(r,[e,i,s,a]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);const u=a?a.evaluate(r):1,h=Rl(e,i,s,u);if(h)throw new Cn(h);return new lr(e/255,i/255,s/255,u)}function Of(r,[e,i,s,a]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);const u=a?a.evaluate(r):1,h=(function(x,T,E,A){return typeof x=="number"&&x>=0&&x<=360?typeof T=="number"&&T>=0&&T<=100&&typeof E=="number"&&E>=0&&E<=100?A===void 0||typeof A=="number"&&A>=0&&A<=1?null:`Invalid hsla value [${[x,T,E,A].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof A=="number"?[x,T,E,A]:[x,T,E]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof A=="number"?[x,T,E,A]:[x,T,E]).join(", ")}]: 'h' must be between 0 and 360.`})(e,i,s,u);if(h)throw new Cn(h);const f=`hsla(${e}, ${i}%, ${s}%, ${u})`,g=lr.parse(f);if(!g)throw new Cn(`Failed to parse HSLA color: ${f}`);return g}function $m(r,e){return r in e}function zf(r,e){const i=e[r];return i===void 0?null:i}function el(r){return{type:r}}function kl(r){if(r instanceof dc)return new Set([r.key]);let e=new Set;return r.eachChild((i=>{e=new Set([...e,...kl(i)])})),e}function Bh(r){if(r instanceof ho&&r.name==="is-active-floor")return!0;let e=!1;return r.eachChild((i=>{!e&&Bh(i)&&(e=!0)})),e}function Wm(r){return{result:"success",value:r}}function tl(r){return{result:"error",value:r}}function kf(r,e){return!!r&&!!r.parameters&&r.parameters.indexOf(e)>-1}function xu(r){return r["property-type"]==="data-driven"}function Xm(r){return kf(r.expression,"measure-light")}function Ym(r){return kf(r.expression,"zoom")}function Nh(r){return!!r.expression&&r.expression.interpolated}function Vh(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function Jm(r){return r}function Km(r,e){const i=e.type==="color",s=r.stops&&typeof r.stops[0][0]=="object",a=s||!(s||r.property!==void 0),u=r.type||(Nh(e)?"exponential":"interval");if(i&&((r=Object.assign({},r)).stops&&(r.stops=r.stops.map((x=>[x[0],lr.parse(x[1])]))),r.default=lr.parse(r.default?r.default:e.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!Gm[r.colorSpace])throw new Error(`Unknown color space: ${r.colorSpace}`);let h,f,g;if(u==="exponential")h=Qm;else if(u==="interval")h=Ty;else if(u==="categorical"){h=wy,f=Object.create(null);for(const x of r.stops)f[x[0]]=x[1];g=typeof r.stops[0][0]}else{if(u!=="identity")throw new Error(`Unknown function type "${u}"`);h=e_}if(s){const x={},T=[];for(let P=0;P<r.stops.length;P++){const L=r.stops[P],F=L[0].zoom;x[F]===void 0&&(x[F]={zoom:F,type:r.type,property:r.property,default:r.default,stops:[]},T.push(F)),x[F].stops.push([L[0].value,L[1]])}const E=[];for(const P of T)E.push([x[P].zoom,Km(x[P],e)]);const A={name:"linear"};return{kind:"composite",interpolationType:A,interpolationFactor:Go.interpolationFactor.bind(void 0,A),zoomStops:E.map((P=>P[0])),evaluate:({zoom:P},L)=>Qm({stops:E,base:r.base},e,P).evaluate(P,L)}}if(a){const x=u==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:x,interpolationFactor:Go.interpolationFactor.bind(void 0,x),zoomStops:r.stops.map((T=>T[0])),evaluate:({zoom:T})=>h(r,e,T,f,g)}}return{kind:"source",evaluate(x,T){const E=T&&T.properties?T.properties[r.property]:void 0;return E===void 0?Xs(r.default,e.default):h(r,e,E,f,g)}}}function Xs(r,e,i){return r!==void 0?r:e!==void 0?e:i!==void 0?i:void 0}function wy(r,e,i,s,a){return Xs(typeof i===a?s[i]:void 0,r.default,e.default)}function Ty(r,e,i){if(!sc(i))return Xs(r.default,e.default);const s=r.stops.length;if(s===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[s-1][0])return r.stops[s-1][1];const a=Mh(r.stops.map((u=>u[0])),i);return r.stops[a][1]}function Qm(r,e,i){const s=r.base!==void 0?r.base:1;if(!sc(i))return Xs(r.default,e.default);const a=r.stops.length;if(a===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[a-1][0])return r.stops[a-1][1];const u=Mh(r.stops.map((T=>T[0])),i),h=(function(T,E,A,P){const L=P-A,F=T-A;return L===0?0:E===1?F/L:(Math.pow(E,F)-1)/(Math.pow(E,L)-1)})(i,s,r.stops[u][0],r.stops[u+1][0]),f=r.stops[u][1],g=r.stops[u+1][1];let x=ou[e.type]||Jm;if(r.colorSpace&&r.colorSpace!=="rgb"){const T=Gm[r.colorSpace];x=(E,A)=>T.reverse(T.interpolate(T.forward(E),T.forward(A),h))}return typeof f.evaluate=="function"?{evaluate(...T){const E=f.evaluate.apply(void 0,T),A=g.evaluate.apply(void 0,T);if(E!==void 0&&A!==void 0)return x(E,A,h)}}:x(f,g,h)}function e_(r,e,i){return e.type==="color"?i=lr.parse(i):e.type==="formatted"?i=co.fromString(i.toString()):e.type==="resolvedImage"?i=uo.build(i.toString()):Bt(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),Xs(i,r.default,e.default)}ho.register(gc,{error:[{kind:"error"},[Vi],(r,[e])=>{throw new Cn(e.evaluate(r))}],typeof:[Vi,[ar],(r,[e])=>pn(On(e.evaluate(r)))],"to-rgba":[Qn(Gt,4),[wo],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[Qn(Gt,4),[wo],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[wo,[Gt,Gt,Gt],Df],rgba:[wo,[Gt,Gt,Gt,Gt],Df],hsl:[wo,[Gt,Gt,Gt],Of],hsla:[wo,[Gt,Gt,Gt,Gt],Of],has:{type:dr,overloads:[[[Vi],(r,[e])=>$m(e.evaluate(r),r.properties())],[[Vi,Hs],(r,[e,i])=>$m(e.evaluate(r),i.evaluate(r))]]},get:{type:ar,overloads:[[[Vi],(r,[e])=>zf(e.evaluate(r),r.properties())],[[Vi,Hs],(r,[e,i])=>zf(e.evaluate(r),i.evaluate(r))]]},"feature-state":[ar,[Vi],(r,[e])=>zf(e.evaluate(r),r.featureState||{})],properties:[Hs,[],r=>r.properties()],"geometry-type":[Vi,[],r=>r.geometryType()],worldview:[Vi,[],r=>r.globals.worldview||""],"is-active-floor":[dr,el(Vi),(r,e)=>{if(!(r.globals.activeFloors&&r.globals.activeFloors.size>0))return!1;const i=r.globals.activeFloors;return e.some((s=>{const a=s.evaluate(r);return i.has(a)}))}],id:[ar,[],r=>r.id()],zoom:[Gt,[],r=>r.globals.zoom],pitch:[Gt,[],r=>r.globals.pitch||0],"distance-from-center":[Gt,[],r=>r.distanceFromCenter()],"measure-light":[Gt,[Vi],(r,[e])=>r.measureLight(e.evaluate(r))],"heatmap-density":[Gt,[],r=>r.globals.heatmapDensity||0],"line-progress":[Gt,[],r=>r.globals.lineProgress||0],"raster-value":[Gt,[],r=>r.globals.rasterValue||0],"raster-particle-speed":[Gt,[],r=>r.globals.rasterParticleSpeed||0],"sky-radial-progress":[Gt,[],r=>r.globals.skyRadialProgress||0],accumulated:[ar,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[Gt,el(Gt),(r,e)=>{let i=0;for(const s of e)i+=s.evaluate(r);return i}],"*":[Gt,el(Gt),(r,e)=>{let i=1;for(const s of e)i*=s.evaluate(r);return i}],"-":{type:Gt,overloads:[[[Gt,Gt],(r,[e,i])=>e.evaluate(r)-i.evaluate(r)],[[Gt],(r,[e])=>-e.evaluate(r)]]},"/":[Gt,[Gt,Gt],(r,[e,i])=>e.evaluate(r)/i.evaluate(r)],"%":[Gt,[Gt,Gt],(r,[e,i])=>e.evaluate(r)%i.evaluate(r)],ln2:[Gt,[],()=>Math.LN2],pi:[Gt,[],()=>Math.PI],e:[Gt,[],()=>Math.E],"^":[Gt,[Gt,Gt],(r,[e,i])=>Math.pow(e.evaluate(r),i.evaluate(r))],sqrt:[Gt,[Gt],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[Gt,[Gt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[Gt,[Gt],(r,[e])=>Math.log(e.evaluate(r))],log2:[Gt,[Gt],(r,[e])=>Math.log2(e.evaluate(r))],sin:[Gt,[Gt],(r,[e])=>Math.sin(e.evaluate(r))],cos:[Gt,[Gt],(r,[e])=>Math.cos(e.evaluate(r))],tan:[Gt,[Gt],(r,[e])=>Math.tan(e.evaluate(r))],asin:[Gt,[Gt],(r,[e])=>Math.asin(e.evaluate(r))],acos:[Gt,[Gt],(r,[e])=>Math.acos(e.evaluate(r))],atan:[Gt,[Gt],(r,[e])=>Math.atan(e.evaluate(r))],min:[Gt,el(Gt),(r,e)=>Math.min(...e.map((i=>i.evaluate(r))))],max:[Gt,el(Gt),(r,e)=>Math.max(...e.map((i=>i.evaluate(r))))],abs:[Gt,[Gt],(r,[e])=>Math.abs(e.evaluate(r))],round:[Gt,[Gt],(r,[e])=>{const i=e.evaluate(r);return i<0?-Math.round(-i):Math.round(i)}],floor:[Gt,[Gt],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[Gt,[Gt],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[dr,[Vi,ar],(r,[e,i])=>r.properties()[e.value]===i.value],"filter-id-==":[dr,[ar],(r,[e])=>r.id()===e.value],"filter-type-==":[dr,[Vi],(r,[e])=>r.geometryType()===e.value],"filter-<":[dr,[Vi,ar],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s<a}],"filter-id-<":[dr,[ar],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i<s}],"filter->":[dr,[Vi,ar],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s>a}],"filter-id->":[dr,[ar],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i>s}],"filter-<=":[dr,[Vi,ar],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s<=a}],"filter-id-<=":[dr,[ar],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i<=s}],"filter->=":[dr,[Vi,ar],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s>=a}],"filter-id->=":[dr,[ar],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i>=s}],"filter-has":[dr,[ar],(r,[e])=>e.value in r.properties()],"filter-has-id":[dr,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[dr,[Qn(Vi)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[dr,[Qn(ar)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[dr,[Vi,Qn(ar)],(r,[e,i])=>i.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[dr,[Vi,Qn(ar)],(r,[e,i])=>(function(s,a,u,h){for(;u<=h;){const f=u+h>>1;if(a[f]===s)return!0;a[f]>s?h=f-1:u=f+1}return!1})(r.properties()[e.value],i.value,0,i.value.length-1)],all:{type:dr,overloads:[[[dr,dr],(r,[e,i])=>e.evaluate(r)&&i.evaluate(r)],[el(dr),(r,e)=>{for(const i of e)if(!i.evaluate(r))return!1;return!0}]]},any:{type:dr,overloads:[[[dr,dr],(r,[e,i])=>e.evaluate(r)||i.evaluate(r)],[el(dr),(r,e)=>{for(const i of e)if(i.evaluate(r))return!0;return!1}]]},"!":[dr,[dr],(r,[e])=>!e.evaluate(r)],"is-supported-script":[dr,[Vi],(r,[e])=>{const i=r.globals&&r.globals.isSupportedScript;return!i||i(e.evaluate(r))}],upcase:[Vi,[Vi],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[Vi,[Vi],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[Vi,el(ar),(r,e)=>e.map((i=>os(i.evaluate(r)))).join("")],"resolved-locale":[Vi,[hh],(r,[e])=>e.evaluate(r).resolvedLocale()],random:[Gt,[Gt,Gt,ar],(r,e)=>{const[i,s,a]=e.map((h=>h.evaluate(r)));if(i>s||i===s)return i;let u;if(typeof a=="string")u=(function(h){let f=0;if(h.length===0)return f;for(let g=0;g<h.length;g++)f=(f<<5)-f+h.charCodeAt(g),f|=0;return f})(a);else{if(typeof a!="number")throw new Cn(`Invalid seed input: ${a}`);u=a}return i+Zm(u)()*(s-i)}]});class Uh{constructor(e,i,s,a,u){this.expression=e,this._warningHistory={},this._scope=s,this._options=a,this._iconImageUseTheme=u,this._evaluator=new _h(s,a,u),this._defaultValue=i?(function(h){return h.type==="color"&&(Vh(h.default)||Array.isArray(h.default))?new lr(0,0,0,0):h.type==="color"?lr.parse(h.default)||null:h.default===void 0?null:h.default})(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=kl(e),this.isIndoorDependent=Bh(e)}evaluateWithoutErrorHandling(e,i,s,a,u,h,f,g){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=s,this._evaluator.canonical=a||null,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=h,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=g||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,s,a,u,h,f,g,x){this._evaluator||(this._evaluator=new _h(this._scope,this._options,this._iconImageUseTheme)),this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=s||null,this._evaluator.canonical=a||null,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=h||null,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=g||null,this._evaluator.iconImageUseTheme=x||null;try{const T=this.expression.evaluate(this._evaluator);if(T==null||typeof T=="number"&&T!=T)return this._defaultValue;if(this._enumValues&&!(T in this._enumValues))throw new Cn(`Expected value to be one of ${Object.keys(this._enumValues).map((E=>JSON.stringify(E))).join(", ")}, but found ${JSON.stringify(T)} instead.`);return T}catch(T){const E=T;return this._warningHistory[E.message]||(this._warningHistory[E.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${E.message}`)),this._defaultValue}}}function bu(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in gc}function il(r,e,i,s,a){const u=new Ch(gc,[],e?(function(f){const g={color:wo,string:Vi,number:Gt,enum:Vi,boolean:dr,formatted:su,resolvedImage:au};return f.type==="array"?Qn(g[f.value]||ar,f.length):g[f.type]})(e):void 0,void 0,void 0,i,s,a),h=u.parse(r,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return h?Wm(new Uh(h,e,i,s,a)):tl(u.errors)}class yc{constructor(e,i,s,a){this.kind=e,this._styleExpression=i,this.isLightConstant=s,this.isLineProgressConstant=a,this.isStateDependent=e!=="constant"&&!pu(i.expression),this.configDependencies=kl(i.expression),this.isIndoorDependent=Bh(i.expression)}evaluateWithoutErrorHandling(e,i,s,a,u,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,a,u,h)}evaluate(e,i,s,a,u,h,f){return this._styleExpression.evaluate(e,i,s,a,u,h,void 0,void 0,f)}}class Fl{constructor(e,i,s,a,u,h){this.kind=e,this.zoomStops=s,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!pu(i.expression),this.isIndoorDependent=Bh(i.expression),this.isLightConstant=u,this.isLineProgressConstant=h,this.configDependencies=kl(i.expression),this.interpolationType=a}evaluateWithoutErrorHandling(e,i,s,a,u,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,a,u,h)}evaluate(e,i,s,a,u,h){return this._styleExpression.evaluate(e,i,s,a,u,h)}interpolationFactor(e,i,s){return this.interpolationType?Go.interpolationFactor(this.interpolationType,e,i,s):0}}function Ff(r,e,i,s,a){if((r=il(r,e,i,s,a)).result==="error")return r;const u=r.value.expression,h=uc(u);if(!h&&!xu(e))return tl([new ns("","data expressions not supported")]);const f=hc(u,["zoom","pitch","distance-from-center"]);if(!f&&!Ym(e))return tl([new ns("","zoom expressions not supported")]);const g=hc(u,["measure-light"]);if(!g&&!Xm(e))return tl([new ns("","measure-light expression not supported")]);const x=hc(u,["line-progress"]);if(!x&&!(function(A){return kf(A.expression,"line-progress")})(e))return tl([new ns("","line-progress expression not supported")]);const T=e.expression&&e.expression.relaxZoomRestriction,E=Ss(u);return E||f||T?E instanceof ns?tl([E]):E instanceof Go&&!Nh(e)?tl([new ns("",'"interpolate" expressions cannot be used with this property')]):Wm(E?new Fl(h&&x?"camera":"composite",r.value,E.labels,E instanceof Go?E.interpolation:void 0,g,x):new yc(h&&x?"constant":"source",r.value,g,x)):tl([new ns("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class jh{constructor(e,i){this._parameters=e,this._specification=i,Object.assign(this,Km(this._parameters,this._specification))}static deserialize(e){return new jh(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Ss(r){let e=null;if(r instanceof _a)e=Ss(r.result);else if(r instanceof gu){for(const i of r.args)if(e=Ss(i),e)break}else(r instanceof mu||r instanceof Go)&&r.input instanceof ho&&r.input.name==="zoom"&&(e=r);return e instanceof ns||r.eachChild((i=>{const s=Ss(i);s instanceof ns?e=s:e&&s&&e!==s&&(e=new ns("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),e}var Bf,t_,i_=(function(){if(t_)return Bf;t_=1,Bf=e;var r=3;function e(i,s,a){var u=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var h=new Int32Array(this.arrayBuffer);i=h[0],this.d=(s=h[1])+2*(a=h[2]);for(var f=0;f<this.d*this.d;f++){var g=h[r+f],x=h[r+f+1];u.push(g===x?null:h.subarray(g,x))}var T=h[r+u.length+1];this.keys=h.subarray(h[r+u.length],T),this.bboxes=h.subarray(T),this.insert=this._insertReadonly}else{this.d=s+2*a;for(var E=0;E<this.d*this.d;E++)u.push([]);this.keys=[],this.bboxes=[]}this.n=s,this.extent=i,this.padding=a,this.scale=s/i,this.uid=0;var A=a/s*i;this.min=-A,this.max=i+A}return e.prototype.insert=function(i,s,a,u,h){this._forEachCell(s,a,u,h,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(s),this.bboxes.push(a),this.bboxes.push(u),this.bboxes.push(h)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,s,a,u,h,f){this.cells[h].push(f)},e.prototype.query=function(i,s,a,u,h){var f=this.min,g=this.max;if(i<=f&&s<=f&&g<=a&&g<=u&&!h)return Array.prototype.slice.call(this.keys);var x=[];return this._forEachCell(i,s,a,u,this._queryCell,x,{},h),x},e.prototype._queryCell=function(i,s,a,u,h,f,g,x){var T=this.cells[h];if(T!==null)for(var E=this.keys,A=this.bboxes,P=0;P<T.length;P++){var L=T[P];if(g[L]===void 0){var F=4*L;(x?x(A[F+0],A[F+1],A[F+2],A[F+3]):i<=A[F+2]&&s<=A[F+3]&&a>=A[F+0]&&u>=A[F+1])?(g[L]=!0,f.push(E[L])):g[L]=!1}}},e.prototype._forEachCell=function(i,s,a,u,h,f,g,x){for(var T=this._convertToCellCoord(i),E=this._convertToCellCoord(s),A=this._convertToCellCoord(a),P=this._convertToCellCoord(u),L=T;L<=A;L++)for(var F=E;F<=P;F++){var U=this.d*F+L;if((!x||x(this._convertFromCellCoord(L),this._convertFromCellCoord(F),this._convertFromCellCoord(L+1),this._convertFromCellCoord(F+1)))&&h.call(this,i,s,a,u,U,f,g,x))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,s=r+this.cells.length+1+1,a=0,u=0;u<this.cells.length;u++)a+=this.cells[u].length;var h=new Int32Array(s+a+this.keys.length+this.bboxes.length);h[0]=this.extent,h[1]=this.n,h[2]=this.padding;for(var f=s,g=0;g<i.length;g++){var x=i[g];h[r+g]=f,h.set(x,f),f+=x.length}return h[r+i.length]=f,h.set(this.keys,f),h[r+i.length+1]=f+=this.keys.length,h.set(this.bboxes,f),f+=this.bboxes.length,h.buffer},Bf})(),vc=Tl(i_);const Bl={};function Lt(r,e,i={}){Object.defineProperty(r,"_classRegistryKey",{value:e,writable:!1}),Bl[e]={klass:r,omit:i.omit||[]}}Lt(Object,"Object"),vc.serialize=function(r,e){const i=r.toArrayBuffer();return e&&e.add(i),{buffer:i}},vc.deserialize=function(r){return new vc(r.buffer)},Object.defineProperty(vc,"name",{value:"Grid"}),Lt(vc,"Grid"),delete st.prototype.constructor,Lt(lr,"Color"),Lt(Error,"Error"),Lt(co,"Formatted"),Lt(fh,"FormattedSection"),Lt(Po,"AJAXError"),Lt(uo,"ResolvedImage"),Lt(jh,"StylePropertyFunction"),Lt(Uh,"StyleExpression",{omit:["_evaluator"]}),Lt(so,"ImageId"),Lt(fa,"ImageVariant"),Lt(Fl,"ZoomDependentExpression"),Lt(yc,"ZoomConstantExpression"),Lt(ho,"CompoundExpression",{omit:["_evaluate"]});for(const r in gc)Bl[gc[r]._classRegistryKey]||Lt(gc[r],`Expression${r}`);function wu(r){return r&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function ga(r,e){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(wu(r)||r instanceof ImageBitmap)return e&&e.add(r),r;if(ArrayBuffer.isView(r))return e&&e.add(r.buffer),r;if(r instanceof ImageData)return e&&e.add(r.data.buffer),r;if(Array.isArray(r)){const i=[];for(const s of r)i.push(ga(s,e));return i}if(r instanceof Map){const i={$name:"Map",entries:[]};for(const[s,a]of r.entries())i.entries.push(ga(s),ga(a,e));return i}if(r instanceof Set){const i={$name:"Set"};let s=0;for(const a of r.values())i[++s]=ga(a);return i}if(typeof r=="bigint")return{$name:"BigInt",value:r.toString()};if(typeof r=="object"){const i=r.constructor,s=i._classRegistryKey;if(!s)throw new Error(`Can't serialize object of unregistered class "${i.name}".`);const a=i.serialize?i.serialize(r,e):{};if(!i.serialize){for(const u in r)r.hasOwnProperty(u)&&(Bl[s].omit.indexOf(u)>=0||(a[u]=ga(r[u],e)));r instanceof Error&&(a.message=r.message)}if(a.$name)throw new Error("$name property is reserved for worker serialization logic.");return s!=="Object"&&(a.$name=s),a}throw new Error("can't serialize object of type "+typeof r)}function rl(r){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||wu(r)||r instanceof ImageBitmap||ArrayBuffer.isView(r)||r instanceof ImageData)return r;if(Array.isArray(r))return r.map(rl);if(typeof r=="object"){const e=r.$name||"Object";if(e==="Map"){const a=r.entries||[],u=new Map;for(let h=0;h<a.length;h+=2)u.set(rl(a[h]),rl(a[h+1]));return u}if(e==="Set"){const a=new Set;for(const u of Object.keys(r))u!=="$name"&&a.add(rl(r[u]));return a}if(e==="BigInt")return BigInt(r.value);const{klass:i}=Bl[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(r);const s=Object.create(i.prototype);for(const a of Object.keys(r))a!=="$name"&&(s[a]=rl(r[a]));return s}throw new Error("can't deserialize object of type "+typeof r)}const Yt={"Latin-1 Supplement":r=>r>=128&&r<=255,Arabic:r=>r>=1536&&r<=1791,"Arabic Supplement":r=>r>=1872&&r<=1919,"Arabic Extended-A":r=>r>=2208&&r<=2303,"Hangul Jamo":r=>r>=4352&&r<=4607,"Unified Canadian Aboriginal Syllabics":r=>r>=5120&&r<=5759,Khmer:r=>r>=6016&&r<=6143,"Unified Canadian Aboriginal Syllabics Extended":r=>r>=6320&&r<=6399,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"CJK Radicals Supplement":r=>r>=11904&&r<=12031,"Kangxi Radicals":r=>r>=12032&&r<=12255,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Bopomofo:r=>r>=12544&&r<=12591,"Hangul Compatibility Jamo":r=>r>=12592&&r<=12687,Kanbun:r=>r>=12688&&r<=12703,"Bopomofo Extended":r=>r>=12704&&r<=12735,"CJK Strokes":r=>r>=12736&&r<=12783,"Katakana Phonetic Extensions":r=>r>=12784&&r<=12799,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"CJK Unified Ideographs Extension A":r=>r>=13312&&r<=19903,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Yi Syllables":r=>r>=40960&&r<=42127,"Yi Radicals":r=>r>=42128&&r<=42191,"Hangul Jamo Extended-A":r=>r>=43360&&r<=43391,"Hangul Syllables":r=>r>=44032&&r<=55215,"Hangul Jamo Extended-B":r=>r>=55216&&r<=55295,"Private Use Area":r=>r>=57344&&r<=63743,"CJK Compatibility Ideographs":r=>r>=63744&&r<=64255,"Arabic Presentation Forms-A":r=>r>=64336&&r<=65023,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Arabic Presentation Forms-B":r=>r>=65136&&r<=65279,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519,Osage:r=>r>=66736&&r<=66815,"CJK Unified Ideographs Extension B":r=>r>=131072&&r<=173791};function Tu(r){for(const e of r)if(Gh(e.charCodeAt(0)))return!0;return!1}function Nf(r){for(const e of r)if(!r_(e.charCodeAt(0)))return!1;return!0}function r_(r){return!(Yt.Arabic(r)||Yt["Arabic Supplement"](r)||Yt["Arabic Extended-A"](r)||Yt["Arabic Presentation Forms-A"](r)||Yt["Arabic Presentation Forms-B"](r))}function Gh(r){return!(r!==746&&r!==747&&(r<4352||!(Yt["Bopomofo Extended"](r)||Yt.Bopomofo(r)||Yt["CJK Compatibility Forms"](r)&&!(r>=65097&&r<=65103)||Yt["CJK Compatibility Ideographs"](r)||Yt["CJK Compatibility"](r)||Yt["CJK Radicals Supplement"](r)||Yt["CJK Strokes"](r)||!(!Yt["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||Yt["CJK Unified Ideographs Extension A"](r)||Yt["CJK Unified Ideographs"](r)||Yt["Enclosed CJK Letters and Months"](r)||Yt["Hangul Compatibility Jamo"](r)||Yt["Hangul Jamo Extended-A"](r)||Yt["Hangul Jamo Extended-B"](r)||Yt["Hangul Jamo"](r)||Yt["Hangul Syllables"](r)||Yt.Hiragana(r)||Yt["Ideographic Description Characters"](r)||Yt.Kanbun(r)||Yt["Kangxi Radicals"](r)||Yt["Katakana Phonetic Extensions"](r)||Yt.Katakana(r)&&r!==12540||!(!Yt["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!Yt["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||Yt["Unified Canadian Aboriginal Syllabics"](r)||Yt["Unified Canadian Aboriginal Syllabics Extended"](r)||Yt["Vertical Forms"](r)||Yt["Yijing Hexagram Symbols"](r)||Yt["Yi Syllables"](r)||Yt["Yi Radicals"](r))))}function qh(r){return!(Gh(r)||(function(e){return!!(Yt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Yt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Yt["Letterlike Symbols"](e)||Yt["Number Forms"](e)||Yt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Yt["Control Pictures"](e)&&e!==9251||Yt["Optical Character Recognition"](e)||Yt["Enclosed Alphanumerics"](e)||Yt["Geometric Shapes"](e)||Yt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Yt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Yt["CJK Symbols and Punctuation"](e)||Yt.Katakana(e)||Yt["Private Use Area"](e)||Yt["CJK Compatibility Forms"](e)||Yt["Small Form Variants"](e)||Yt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)})(r))}function Hh(r){return Yt.Arabic(r)||Yt["Arabic Supplement"](r)||Yt["Arabic Extended-A"](r)||Yt["Arabic Presentation Forms-A"](r)||Yt["Arabic Presentation Forms-B"](r)}function Vf(r){return r>=1424&&r<=2303||Yt["Arabic Presentation Forms-A"](r)||Yt["Arabic Presentation Forms-B"](r)}function ya(r,e){return!(!e&&Vf(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||Yt.Khmer(r))}function Ey(r){for(const e of r)if(Vf(e.charCodeAt(0)))return!0;return!1}const Lo={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let Uf=null,fo=Lo.unavailable,va=null;const Eu=function(r){r&&typeof r=="string"&&r.indexOf("NetworkError")>-1&&(fo=Lo.error),Uf&&Uf(r)};function Zh(){$h.fire(new qs("pluginStateChange",{pluginStatus:fo,pluginURL:va}))}const $h=new Ll,Su=function(){return fo},n_=function(){if(fo!==Lo.deferred||!va)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");fo=Lo.loading,Zh(),va&&da({url:va},(r=>{r?Eu(r):(fo=Lo.loaded,Zh())}))},xa={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>fo===Lo.loaded||xa.applyArabicShaping!=null,isLoading:()=>fo===Lo.loading,setState(r){fo=r.pluginStatus,va=r.pluginURL},isParsing:()=>fo===Lo.parsing,isParsed:()=>fo===Lo.parsed,getPluginURL:()=>va};class Ar{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness,this.worldview=i.worldview,this.activeFloors=i.activeFloors):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return(function(i,s){for(const a of i)if(!ya(a.charCodeAt(0),s))return!1;return!0})(e,xa.isLoaded())}}class Wh{constructor(e,i,s,a,u){this.property=e,this.value=i,this.expression=(function(h,f,g,x,T){if(Vh(h))return new jh(h,f);if(bu(h)||Array.isArray(h)&&h.length>0){const E=Ff(h,f,g,x,T);if(E.result==="error")throw new Error(E.value.map((A=>`${A.key}: ${A.message}`)).join(", "));return E.value}{let E=h;return typeof h=="string"&&f.type==="color"&&(E=lr.parse(h)),{kind:"constant",configDependencies:new Set,isIndoorDependent:!1,evaluate:()=>E}}})(i===void 0?e.specification.default:i,e.specification,s,a,u)}isIndoorDependent(){return this.expression.isIndoorDependent}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,s,a){return this.property.possiblyEvaluate(this,e,i,s,a)}}class jf{constructor(e,i,s,a){this.property=e,this.value=new Wh(e,void 0,i,s,a)}transitioned(e,i){return new s_(this.property,this.value,i,Object.assign({},e.transition,this.transition),e.now)}untransitioned(){return new s_(this.property,this.value,null,{},0)}}class o_{constructor(e,i,s,a){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=s,this._iconImageUseTheme=a,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return Je(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new jf(this._values[e].property,this._scope,this._options,this._iconImageUseTheme)),this._values[e].value=new Wh(this._values[e].property,i===null?void 0:Je(i),this._scope,this._options,this._iconImageUseTheme),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].value.isIndoorDependent())}setTransitionOrValue(e,i){i&&(this._options=i);const s=this._properties.properties;if(e)for(const a in e){const u=e[a];if(a.endsWith("-transition")){const h=a.slice(0,-11);s[h]&&this.setTransition(h,u)}else s.hasOwnProperty(a)&&this.setValue(a,u)}}getTransition(e){return Je(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new jf(this._values[e].property)),this._values[e].transition=Je(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const s=this.getValue(i);s!==void 0&&(e[i]=s);const a=this.getTransition(i);a!==void 0&&(e[`${i}-transition`]=a)}return e}transitioned(e,i){const s=new a_(this._properties);for(const a of Object.keys(this._values))s._values[a]=this._values[a].transitioned(e,i._values[a]);return s}untransitioned(){const e=new a_(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}isIndoorDependent(){return this._isIndoorDependent}}class s_{constructor(e,i,s,a,u){const h=a.delay||0,f=a.duration||0;u=u||0,this.property=e,this.value=i,this.begin=u+h,this.end=this.begin+f,e.specification.transition&&(a.delay||a.duration)&&(this.prior=s)}possiblyEvaluate(e,i,s){const a=e.now||0,u=this.value.possiblyEvaluate(e,i,s),h=this.prior;if(h){if(a>this.end)return this.prior=null,u;if(this.value.isDataDriven())return this.prior=null,u;if(a<this.begin)return h.possiblyEvaluate(e,i,s);{const f=(a-this.begin)/(this.end-this.begin);return this.property.interpolate(h.possiblyEvaluate(e,i,s),u,Sl(f))}}return u}}class a_{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,s){const a=new Vl(this._properties);for(const u of Object.keys(this._values))a._values[u]=this._values[u].possiblyEvaluate(e,i,s);return a}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class l_{constructor(e,i,s,a){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=s,this._iconImageUseTheme=a,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return Je(this._values[e].value)}setValue(e,i){this._values[e]=new Wh(this._values[e].property,i===null?void 0:Je(i),this._scope,this._options,this._iconImageUseTheme),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].isIndoorDependent())}serialize(){const e={};for(const i of Object.keys(this._values)){const s=this.getValue(i);s!==void 0&&(e[i]=s)}return e}possiblyEvaluate(e,i,s,a){const u=new Vl(this._properties);for(const h of Object.keys(this._values))u._values[h]=this._values[h].possiblyEvaluate(e,i,s,a);return u}isIndoorDependent(){return this._isIndoorDependent}}class Nl{constructor(e,i,s,a){this.property=e,this.value=i,this.parameters=s,this.iconImageUseTheme=a}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,s,a){return this.property.evaluate(this.value,this.parameters,e,i,s,a,this.iconImageUseTheme)}}class Vl{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class mt{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,s){const a=ou[this.specification.type];return a?a(e,i,s):e}}class xt{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,s,a,u){return e.expression.kind==="constant"||e.expression.kind==="camera"?new Nl(this,{kind:"constant",value:e.expression.evaluate(i,null,{},s,a,void 0,u)},i):new Nl(this,e.expression,i,u)}interpolate(e,i,s){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new Nl(this,{kind:"constant",value:void 0},e.parameters);const a=ou[this.specification.type];return a?new Nl(this,{kind:"constant",value:a(e.value.value,i.value.value,s)},e.parameters):e}evaluate(e,i,s,a,u,h,f){return e.kind==="constant"?e.value:e.evaluate(i,s,a,u,h,void 0,f)}}class Ul{constructor(e){this.specification=e}possiblyEvaluate(e,i,s,a){return!!e.expression.evaluate(i,null,{},s,a)}interpolate(){return!1}}class en{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new Ar(0,{});for(const s in e){const a=e[s];a.specification.overridable&&this.overridableProperties.push(s);const u=this.defaultPropertyValues[s]=new Wh(a,void 0),h=this.defaultTransitionablePropertyValues[s]=new jf(a);this.defaultTransitioningPropertyValues[s]=h.untransitioned(),this.defaultPossiblyEvaluatedValues[s]=u.possiblyEvaluate(i)}}}Lt(xt,"DataDrivenProperty"),Lt(mt,"DataConstantProperty"),Lt(Ul,"ColorRampProperty");var Re=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"interpolated":true,"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor_source":{"sourceId":{"type":"string"},"sourceLayers":{"type":"array","value":"string"}},"indoor":{"*":{"type":"indoor_source"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function c_(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function Xh(r){if(Array.isArray(r))return r.map(Xh);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){const e={};for(const i in r)e[i]=Xh(r[i]);return e}return c_(r)}function Ys(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(const e of r.slice(1))if(!Ys(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function Yh(r,e="",i=null,s="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Ys(r)||(r=Jh(r));const a=r;let u=!0;try{u=(function(T){if(!xc(T))return T;let E=Xh(T);return u_(E),E=jl(E),E})(a)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(a,null,2)}
        `)}let h=null,f=null;if(s!=="background"&&s!=="sky"&&s!=="slot"){f=Re[`filter_${s}`];const T=il(u,f,e,i);if(T.result==="error")throw new Error(T.value.map((E=>`${E.key}: ${E.message}`)).join(", "));h=(E,A,P)=>T.value.evaluate(E,A,{},P)}let g=null,x=null;if(u!==a){const T=il(a,f,e,i);if(T.result==="error")throw new Error(T.value.map((E=>`${E.key}: ${E.message}`)).join(", "));g=(E,A,P,L,F)=>T.value.evaluate(E,A,{},P,void 0,void 0,L,F),x=!uc(T.value.expression)}return{filter:h,dynamicFilter:g||void 0,needGeometry:h_(u),needFeature:!!x}}function jl(r){if(!Array.isArray(r))return r;const e=(function(i){if(Sy.has(i[0])){for(let s=1;s<i.length;s++)if(xc(i[s]))return!0}return i})(r);return e===!0?e:e.map((i=>jl(i)))}function u_(r){let e=!1;const i=[];if(r[0]==="case"){for(let s=1;s<r.length-1;s+=2)e=e||xc(r[s]),i.push(r[s+1]);i.push(r[r.length-1])}else if(r[0]==="match"){e=e||xc(r[1]);for(let s=2;s<r.length-1;s+=2)i.push(r[s+1]);i.push(r[r.length-1])}else if(r[0]==="step"){e=e||xc(r[1]);for(let s=1;s<r.length-1;s+=2)i.push(r[s+1])}e&&(r.length=0,r.push("any",...i));for(let s=1;s<r.length;s++)u_(r[s])}function xc(r){if(!Array.isArray(r))return!1;if((e=r[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<r.length;i++)if(xc(r[i]))return!0;return!1}const Sy=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Iy(r,e){return r<e?-1:r>e?1:0}function h_(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let e=1;e<r.length;e++)if(h_(r[e]))return!0;return!1}function Jh(r){if(!r)return!0;const e=r[0];return r.length<=1?e!=="any":e==="=="?Kh(r[1],r[2],"=="):e==="!="?Iu(Kh(r[1],r[2],"==")):e==="<"||e===">"||e==="<="||e===">="?Kh(r[1],r[2],e):e==="any"?(i=r.slice(1),["any"].concat(i.map(Jh))):e==="all"?["all"].concat(r.slice(1).map(Jh)):e==="none"?["all"].concat(r.slice(1).map(Jh).map(Iu)):e==="in"?Qh(r[1],r.slice(2)):e==="!in"?Iu(Qh(r[1],r.slice(2))):e==="has"?ed(r[1]):e!=="!has"||Iu(ed(r[1]));var i}function Kh(r,e,i){switch(r){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,r,e]}}function Qh(r,e){if(e.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some((i=>typeof i!=typeof e[0]))?["filter-in-large",r,["literal",e.sort(Iy)]]:["filter-in-small",r,["literal",e]]}}function ed(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function Iu(r){return["!",r]}const Gl="";function Is(r,e){return e?`${r}${Gl}${e}`:r}let d_;const f_=()=>d_||(d_=new en({"icon-size":new xt(Re.layout_symbol["icon-size"]),"icon-image":new xt(Re.layout_symbol["icon-image"]),"icon-rotate":new xt(Re.layout_symbol["icon-rotate"]),"icon-offset":new xt(Re.layout_symbol["icon-offset"]),"text-size":new xt(Re.layout_symbol["text-size"]),"text-rotate":new xt(Re.layout_symbol["text-rotate"]),"text-offset":new xt(Re.layout_symbol["text-offset"])}));class p_{constructor(e,i,s,a,u,h){const f=il(e,Re.appearance.condition);if(f.result==="success"&&(this.condition=f.value),this.name=i,s){this.properties=new Vl(f_()),this.unevaluatedLayout=new l_(f_(),a,u,h);for(const g in s)this.unevaluatedLayout.setValue(g,s[g])}}isActive(e){return!(this.condition||!e.isHidden||this.name!=="hidden")||this.condition.evaluate(e.globals,e.feature,e.featureState,e.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(e){return this.properties.get(e)}getUnevaluatedProperties(){return this.unevaluatedLayout}getUnevaluatedProperty(e){return this.unevaluatedLayout._values[e]}recalculate(e,i,s){this.unevaluatedLayout&&(this.properties=this.unevaluatedLayout.possiblyEvaluate(e,void 0,i,s))}serialize(){const e={};return e.condition=this.condition.expression.serialize(),this.name&&(e.name=this.name),this.unevaluatedLayout&&(e.properties=this.unevaluatedLayout.serialize()),e}hasIconProperties(){const e=this.hasProperty("icon-image"),i=this.hasProperty("icon-size"),s=this.hasProperty("icon-offset"),a=this.hasProperty("icon-rotate");return e||i||s||a}hasTextProperties(){const e=this.hasProperty("text-size"),i=this.hasProperty("text-offset"),s=this.hasProperty("text-rotate");return e||i||s}hasProperty(e){return this.getUnevaluatedProperty(e).value!==void 0}}const m_="-transition",Js=new Set(["fill","line","background","hillshade","raster"]);class po extends Ll{constructor(e,i,s,a,u,h){if(super(),this.id=e.id,this.fqid=Is(this.id,s),this.type=e.type,this.scope=s,this.lut=a,this.options=u,this.iconImageUseTheme=h,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.expressionDependencies={isIndoorDependent:!1,configDependencies:new Set},e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const f=il(this.filter,Re[`filter_${e.type}`]);f.result!=="error"&&(this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...f.value.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||f.value.isIndoorDependent)}if(e.slot&&(this.slot=e.slot),e.appearances&&this.setAppearances(e.appearances),i.layout&&(this._unevaluatedLayout=new l_(i.layout,this.scope,u,this.iconImageUseTheme),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._unevaluatedLayout.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._unevaluatedLayout.isIndoorDependent()),i.paint){this._transitionablePaint=new o_(i.paint,this.scope,u);for(const f in e.paint)this.setPaintProperty(f,e.paint[f]);for(const f in e.layout)this.setLayoutProperty(f,e.layout[f]);this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._transitionablePaint.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._transitionablePaint.isIndoorDependent(),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Vl(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Js.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const s=this._unevaluatedLayout;s._properties.properties[e]&&(s.setValue(e,i),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...s.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||s.isIndoorDependent(),e==="visibility"&&this.possiblyEvaluateVisibility())}setAppearances(e){this.appearances=[],e.forEach((i=>{this.appearances.push(new p_(i.condition,i.name,i.properties,this.scope,this.options,this.iconImageUseTheme))}))}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(m_)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}isPaintProperty(e){return!!this._transitionablePaint._properties.properties[e]}setPaintProperty(e,i){const s=this._transitionablePaint,a=s._properties.properties;if(e.endsWith(m_)){const E=e.slice(0,-11);return a[E]&&s.setTransition(E,i||void 0),!1}if(!a[e])return!1;const u=s._values[e],h=u.value.isDataDriven(),f=u.value;s.setValue(e,i),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...s.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||s.isIndoorDependent(),this._handleSpecialPaintPropertyUpdate(e);const g=s._values[e].value,x=g.isDataDriven(),T=e.endsWith("pattern")||e==="line-dasharray";return x||h||T||this._handleOverridablePaintPropertyUpdate(e,f,g)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,s){return null}_handleOverridablePaintPropertyUpdate(e,i,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){const e={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.appearances.length!==0&&(e.appearances=this.appearances.map((i=>i.serialize()))),ut(e,((i,s)=>!(i===void 0||s==="layout"&&!Object.keys(i).length||s==="paint"&&!Object.keys(i).length)))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof Nl&&xu(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}for(const e of this.appearances)if(!pu(e.condition.expression))return!0;return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=Yh(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRenderedFeatures(e,i,s){return{}}queryRadius(e){}queryIntersectsFeature(e,i,s,a,u,h,f,g,x){}}const __={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Au{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}const Ay=new ArrayBuffer(0);class Lr{constructor(){this._reallocCount=0,this.capacity=0,this.length=0}static serialize(e,i){return e._trim(),i&&e.arrayBuffer&&i.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,e.arrayBuffer?i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement:(i.capacity=0,i.arrayBuffer=Ay),i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this._reallocCount++,this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}reserveForAdditional(e){this.reserve(this.length+e)}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Ci(r,e=1){let i=0,s=0;return{members:r.map((a=>{const u=__[a.type].BYTES_PER_ELEMENT,h=i=g_(i,Math.max(e,u)),f=a.components||1;return s=Math.max(s,u),i+=u*f,{name:a.name,type:a.type,components:f,offset:h}})),size:g_(i,Math.max(s,e)),alignment:e}}function g_(r,e){return Math.ceil(r/e)*e}class nl extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const a=2*e;return this.int16[a+0]=i,this.int16[a+1]=s,e}}nl.prototype.bytesPerElement=4,Lt(nl,"StructArrayLayout2i4");class bc extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=3*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.int16[u+2]=a,e}}bc.prototype.bytesPerElement=6,Lt(bc,"StructArrayLayout3i6");class wc extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=4*e;return this.int16[h+0]=i,this.int16[h+1]=s,this.int16[h+2]=a,this.int16[h+3]=u,e}}wc.prototype.bytesPerElement=8,Lt(wc,"StructArrayLayout4i8");class ba extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}ba.prototype.bytesPerElement=4,Lt(ba,"StructArrayLayout1f4");class Gf extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=4*e,h=2*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.float32[h+1]=a,e}}Gf.prototype.bytesPerElement=8,Lt(Gf,"StructArrayLayout2i1f8");class qf extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=4*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.int16[u+2]=a,e}}qf.prototype.bytesPerElement=8,Lt(qf,"StructArrayLayout3i8");class Hf extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const f=5*e;return this.int16[f+0]=i,this.int16[f+1]=s,this.int16[f+2]=a,this.int16[f+3]=u,this.int16[f+4]=h,e}}Hf.prototype.bytesPerElement=10,Lt(Hf,"StructArrayLayout5i10");class td extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f){const g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,u,h,f)}emplace(e,i,s,a,u,h,f,g){const x=6*e,T=12*e,E=3*e;return this.int16[x+0]=i,this.int16[x+1]=s,this.uint8[T+4]=a,this.uint8[T+5]=u,this.uint8[T+6]=h,this.uint8[T+7]=f,this.float32[E+2]=g,e}}td.prototype.bytesPerElement=12,Lt(td,"StructArrayLayout2i4ub1f12");class qo extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=3*e;return this.float32[u+0]=i,this.float32[u+1]=s,this.float32[u+2]=a,e}}qo.prototype.bytesPerElement=12,Lt(qo,"StructArrayLayout3f12");class To extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const f=6*e,g=3*e;return this.uint16[f+0]=i,this.uint16[f+1]=s,this.uint16[f+2]=a,this.uint16[f+3]=u,this.float32[g+2]=h,e}}To.prototype.bytesPerElement=12,Lt(To,"StructArrayLayout4ui1f12");class ql extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=4*e;return this.uint16[h+0]=i,this.uint16[h+1]=s,this.uint16[h+2]=a,this.uint16[h+3]=u,e}}ql.prototype.bytesPerElement=8,Lt(ql,"StructArrayLayout4ui8");class id extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,f){const g=6*e;return this.int16[g+0]=i,this.int16[g+1]=s,this.int16[g+2]=a,this.int16[g+3]=u,this.int16[g+4]=h,this.int16[g+5]=f,e}}id.prototype.bytesPerElement=12,Lt(id,"StructArrayLayout6i12");class Zf extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,g,x,T,E,A){const P=this.length;return this.resize(P+1),this.emplace(P,e,i,s,a,u,h,f,g,x,T,E,A)}emplace(e,i,s,a,u,h,f,g,x,T,E,A,P){const L=12*e;return this.int16[L+0]=i,this.int16[L+1]=s,this.int16[L+2]=a,this.int16[L+3]=u,this.uint16[L+4]=h,this.uint16[L+5]=f,this.uint16[L+6]=g,this.uint16[L+7]=x,this.int16[L+8]=T,this.int16[L+9]=E,this.int16[L+10]=A,this.int16[L+11]=P,e}}Zf.prototype.bytesPerElement=24,Lt(Zf,"StructArrayLayout4i4ui4i24");class $f extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,f){const g=10*e,x=5*e;return this.int16[g+0]=i,this.int16[g+1]=s,this.int16[g+2]=a,this.float32[x+2]=u,this.float32[x+3]=h,this.float32[x+4]=f,e}}$f.prototype.bytesPerElement=20,Lt($f,"StructArrayLayout3i3f20");class ol extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=4*e;return this.float32[h+0]=i,this.float32[h+1]=s,this.float32[h+2]=a,this.float32[h+3]=u,e}}ol.prototype.bytesPerElement=16,Lt(ol,"StructArrayLayout4f16");class rd extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}rd.prototype.bytesPerElement=4,Lt(rd,"StructArrayLayout1ul4");class Ho extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const a=2*e;return this.uint16[a+0]=i,this.uint16[a+1]=s,e}}Ho.prototype.bytesPerElement=4,Lt(Ho,"StructArrayLayout2ui4");class nd extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,g,x,T,E,A,P){const L=this.length;return this.resize(L+1),this.emplace(L,e,i,s,a,u,h,f,g,x,T,E,A,P)}emplace(e,i,s,a,u,h,f,g,x,T,E,A,P,L){const F=20*e,U=10*e;return this.int16[F+0]=i,this.int16[F+1]=s,this.int16[F+2]=a,this.int16[F+3]=u,this.int16[F+4]=h,this.float32[U+3]=f,this.float32[U+4]=g,this.float32[U+5]=x,this.float32[U+6]=T,this.int16[F+14]=E,this.uint32[U+8]=A,this.uint16[F+18]=P,this.uint16[F+19]=L,e}}nd.prototype.bytesPerElement=40,Lt(nd,"StructArrayLayout5i4f1i1ul2ui40");class od extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f){const g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,u,h,f)}emplace(e,i,s,a,u,h,f,g){const x=8*e;return this.int16[x+0]=i,this.int16[x+1]=s,this.int16[x+2]=a,this.int16[x+4]=u,this.int16[x+5]=h,this.int16[x+6]=f,this.int16[x+7]=g,e}}od.prototype.bytesPerElement=16,Lt(od,"StructArrayLayout3i2i2i16");class sd extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const f=4*e,g=8*e;return this.float32[f+0]=i,this.float32[f+1]=s,this.float32[f+2]=a,this.int16[g+6]=u,this.int16[g+7]=h,e}}sd.prototype.bytesPerElement=16,Lt(sd,"StructArrayLayout2f1f2i16");class Wf extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,f){const g=20*e,x=5*e;return this.uint8[g+0]=i,this.uint8[g+1]=s,this.float32[x+1]=a,this.float32[x+2]=u,this.float32[x+3]=h,this.float32[x+4]=f,e}}Wf.prototype.bytesPerElement=20,Lt(Wf,"StructArrayLayout2ub4f20");class xn extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=3*e;return this.uint16[u+0]=i,this.uint16[u+1]=s,this.uint16[u+2]=a,e}}xn.prototype.bytesPerElement=6,Lt(xn,"StructArrayLayout3ui6");class Tc extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U,V,$,X,Q,de){const ae=this.length;return this.resize(ae+1),this.emplace(ae,e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U,V,$,X,Q,de)}emplace(e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U,V,$,X,Q,de,ae){const me=30*e,xe=15*e,Ee=60*e;return this.int16[me+0]=i,this.int16[me+1]=s,this.int16[me+2]=a,this.float32[xe+2]=u,this.float32[xe+3]=h,this.uint16[me+8]=f,this.uint16[me+9]=g,this.uint32[xe+5]=x,this.uint32[xe+6]=T,this.uint32[xe+7]=E,this.uint16[me+16]=A,this.uint16[me+17]=P,this.uint16[me+18]=L,this.float32[xe+10]=F,this.float32[xe+11]=U,this.uint8[Ee+48]=V,this.uint8[Ee+49]=$,this.uint8[Ee+50]=X,this.uint32[xe+13]=Q,this.int16[me+28]=de,this.uint8[Ee+58]=ae,e}}Tc.prototype.bytesPerElement=60,Lt(Tc,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Xf extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U,V,$,X,Q,de,ae,me,xe,Ee,Ge,Me,$e,Ke,Qe,at,ct,tt){const rt=this.length;return this.resize(rt+1),this.emplace(rt,e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U,V,$,X,Q,de,ae,me,xe,Ee,Ge,Me,$e,Ke,Qe,at,ct,tt)}emplace(e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U,V,$,X,Q,de,ae,me,xe,Ee,Ge,Me,$e,Ke,Qe,at,ct,tt,rt){const Ze=20*e,qe=40*e,ot=80*e;return this.float32[Ze+0]=i,this.float32[Ze+1]=s,this.int16[qe+4]=a,this.int16[qe+5]=u,this.int16[qe+6]=h,this.int16[qe+7]=f,this.int16[qe+8]=g,this.int16[qe+9]=x,this.int16[qe+10]=T,this.int16[qe+11]=E,this.int16[qe+12]=A,this.uint16[qe+13]=P,this.uint16[qe+14]=L,this.uint16[qe+15]=F,this.uint16[qe+16]=U,this.uint16[qe+17]=V,this.uint16[qe+18]=$,this.uint16[qe+19]=X,this.uint16[qe+20]=Q,this.uint16[qe+21]=de,this.uint16[qe+22]=ae,this.uint16[qe+23]=me,this.uint16[qe+24]=xe,this.uint16[qe+25]=Ee,this.uint16[qe+26]=Ge,this.uint16[qe+27]=Me,this.uint32[Ze+14]=$e,this.float32[Ze+15]=Ke,this.float32[Ze+16]=Qe,this.float32[Ze+17]=at,this.float32[Ze+18]=ct,this.uint8[ot+76]=tt,this.uint16[qe+39]=rt,e}}Xf.prototype.bytesPerElement=80,Lt(Xf,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Yf extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,f){const g=6*e;return this.float32[g+0]=i,this.float32[g+1]=s,this.float32[g+2]=a,this.float32[g+3]=u,this.float32[g+4]=h,this.float32[g+5]=f,e}}Yf.prototype.bytesPerElement=24,Lt(Yf,"StructArrayLayout6f24");class Hl extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const f=5*e;return this.float32[f+0]=i,this.float32[f+1]=s,this.float32[f+2]=a,this.float32[f+3]=u,this.float32[f+4]=h,e}}Hl.prototype.bytesPerElement=20,Lt(Hl,"StructArrayLayout5f20");class Jf extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f){const g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,u,h,f)}emplace(e,i,s,a,u,h,f,g){const x=7*e;return this.float32[x+0]=i,this.float32[x+1]=s,this.float32[x+2]=a,this.float32[x+3]=u,this.float32[x+4]=h,this.float32[x+5]=f,this.float32[x+6]=g,e}}Jf.prototype.bytesPerElement=28,Lt(Jf,"StructArrayLayout7f28");class Kf extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,g,x,T,E){const A=this.length;return this.resize(A+1),this.emplace(A,e,i,s,a,u,h,f,g,x,T,E)}emplace(e,i,s,a,u,h,f,g,x,T,E,A){const P=11*e;return this.float32[P+0]=i,this.float32[P+1]=s,this.float32[P+2]=a,this.float32[P+3]=u,this.float32[P+4]=h,this.float32[P+5]=f,this.float32[P+6]=g,this.float32[P+7]=x,this.float32[P+8]=T,this.float32[P+9]=E,this.float32[P+10]=A,e}}Kf.prototype.bytesPerElement=44,Lt(Kf,"StructArrayLayout11f44");class Ec extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,g,x){const T=this.length;return this.resize(T+1),this.emplace(T,e,i,s,a,u,h,f,g,x)}emplace(e,i,s,a,u,h,f,g,x,T){const E=9*e;return this.float32[E+0]=i,this.float32[E+1]=s,this.float32[E+2]=a,this.float32[E+3]=u,this.float32[E+4]=h,this.float32[E+5]=f,this.float32[E+6]=g,this.float32[E+7]=x,this.float32[E+8]=T,e}}Ec.prototype.bytesPerElement=36,Lt(Ec,"StructArrayLayout9f36");class Ks extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const a=2*e;return this.float32[a+0]=i,this.float32[a+1]=s,e}}Ks.prototype.bytesPerElement=8,Lt(Ks,"StructArrayLayout2f8");class Eo extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=6*e;return this.uint32[3*e+0]=i,this.uint16[h+2]=s,this.uint16[h+3]=a,this.uint16[h+4]=u,e}}Eo.prototype.bytesPerElement=12,Lt(Eo,"StructArrayLayout1ul3ui12");class sl extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}sl.prototype.bytesPerElement=2,Lt(sl,"StructArrayLayout1ui2");class Qf extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U){const V=this.length;return this.resize(V+1),this.emplace(V,e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U)}emplace(e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U,V){const $=16*e;return this.float32[$+0]=i,this.float32[$+1]=s,this.float32[$+2]=a,this.float32[$+3]=u,this.float32[$+4]=h,this.float32[$+5]=f,this.float32[$+6]=g,this.float32[$+7]=x,this.float32[$+8]=T,this.float32[$+9]=E,this.float32[$+10]=A,this.float32[$+11]=P,this.float32[$+12]=L,this.float32[$+13]=F,this.float32[$+14]=U,this.float32[$+15]=V,e}}Qf.prototype.bytesPerElement=64,Lt(Qf,"StructArrayLayout16f64");class ad extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f){const g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,u,h,f)}emplace(e,i,s,a,u,h,f,g){const x=10*e,T=5*e;return this.uint16[x+0]=i,this.uint16[x+1]=s,this.uint16[x+2]=a,this.uint16[x+3]=u,this.float32[T+2]=h,this.float32[T+3]=f,this.float32[T+4]=g,e}}ad.prototype.bytesPerElement=20,Lt(ad,"StructArrayLayout4ui3f20");class ep extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}ep.prototype.bytesPerElement=2,Lt(ep,"StructArrayLayout1i2");class ld extends Lr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}ld.prototype.bytesPerElement=1,Lt(ld,"StructArrayLayout1ub1");class cd extends Au{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}cd.prototype.size=40;class y_ extends nd{get(e){return new cd(this,e)}}Lt(y_,"CollisionBoxArray");class ud extends Au{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}ud.prototype.size=60;class v_ extends Tc{get(e){return new ud(this,e)}}Lt(v_,"PlacedSymbolArray");class x_ extends Au{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}x_.prototype.size=80;class tp extends Xf{get(e){return new x_(this,e)}}Lt(tp,"SymbolInstanceArray");class hd extends ba{getoffsetX(e){return this.float32[1*e+0]}}Lt(hd,"GlyphOffsetArray");class b_ extends nl{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}Lt(b_,"SymbolLineVertexArray");class ip extends Au{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}ip.prototype.size=12;class rp extends Eo{get(e){return new ip(this,e)}}Lt(rp,"FeatureIndexArray");class w_ extends Ho{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}Lt(w_,"FillExtrusionCentroidArray");class dd extends Au{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}dd.prototype.size=6;class Cu extends bc{get(e){return new dd(this,e)}}Lt(Cu,"FillExtrusionWallArray");const T_=Ci([{name:"a_pos",components:2,type:"Int16"}],4),Cy=Ci([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),E_=Ci([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Fr{constructor(e=[]){this.segments=e}_prepareSegment(e,i,s,a){let u=this.segments[this.segments.length-1];return e>Fr.MAX_VERTEX_ARRAY_LENGTH&&It(`Max vertices per segment is ${Fr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!u||u.vertexLength+e>Fr.MAX_VERTEX_ARRAY_LENGTH||u.sortKey!==a)&&(u={vertexOffset:i,primitiveOffset:s,vertexLength:0,primitiveLength:0},a!==void 0&&(u.sortKey=a),this.segments.push(u)),u}prepareSegment(e,i,s,a){return this._prepareSegment(e,i.length,s.length,a)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,s,a){return new Fr([{vertexOffset:e,primitiveOffset:i,vertexLength:s,primitiveLength:a,vaos:{},sortKey:0}])}}function fd(r,e){return 256*(r=j(Math.floor(r),0,255))+j(Math.floor(e),0,255)}Fr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Lt(Fr,"SegmentVector");const My=Ci([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Py=Ci([{name:"a_pattern_b",components:4,type:"Uint16"}]),Ly=Ci([{name:"a_dash",components:4,type:"Uint16"}]);class Mu{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,s,a){this.ids.push(np(e)),this.positions.push(i,s,a)}eachPosition(e,i){const s=np(e);let a=0,u=this.ids.length-1;for(;a<u;){const h=a+u>>1;this.ids[h]>=s?u=h:a=h+1}for(;this.ids[a]===s;)i(this.positions[3*a],this.positions[3*a+1],this.positions[3*a+2]),a++}static serialize(e,i){const s=new Float64Array(e.ids),a=new Uint32Array(e.positions);return op(s,a,0,s.length-1),i&&(i.add(s.buffer),i.add(a.buffer)),{ids:s,positions:a}}static deserialize(e){const i=new Mu;let s;i.ids=e.ids,i.positions=e.positions;for(const a of i.ids)a!==s&&i.uniqueIds.push(a),s=a;return i.indexed=!0,i}}function np(r){const e=+r;return Number.isSafeInteger(e)?e:ch(String(r))}function op(r,e,i,s){for(;i<s;){const a=r[i+s>>1];let u=i-1,h=s+1;for(;;){do u++;while(r[u]<a);do h--;while(r[h]>a);if(u>=h)break;pd(r,u,h),pd(e,3*u,3*h),pd(e,3*u+1,3*h+1),pd(e,3*u+2,3*h+2)}h-i<s-h?(op(r,e,i,h),i=h+1):(op(r,e,h+1,s),s=h)}}function pd(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}Lt(Mu,"FeaturePositionMap");class wa{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,s){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class md extends wa{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}}class bn extends wa{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class Qs extends wa{constructor(e){super(e),this.current=[0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}}class Pu extends wa{constructor(e){super(e),this.current=[0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}}class _d extends wa{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3])))}}class Lu extends wa{constructor(e){super(e),this.current=lr.transparent.toPremultipliedRenderColor(null)}set(e,i,s){this.fetchUniformLocation(e,i)&&(s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a)))}}const Ry=new Float32Array(16);class Ru extends wa{constructor(e){super(e),this.current=Ry}set(e,i,s){if(this.fetchUniformLocation(e,i)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let a=1;a<16;a++)if(s[a]!==this.current[a]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}}const gd=new Float32Array(9),Dy=new Float32Array(4);class yd extends wa{constructor(e){super(e),this.current=Dy}set(e,i,s){if(this.fetchUniformLocation(e,i)){for(let a=0;a<4;a++)if(s[a]!==this.current[a]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}}function sp(r){return[fd(255*r.r,255*r.g),fd(255*r.b,255*r.a)]}function Du(r,e,i,s,a,u,h,f){return!!r&&(r.kind==="composite"||r.kind==="source"?r.evaluate(new Ar(0,{brightness:u,worldview:f}),e,i,a,s,h)==="none":r.value==="none")}class Ou{constructor(e,i,s,a){this.value=e,this.uniformNames=i.map((u=>`u_${u}`)),this.type=s,this.context=a}setUniform(e,i,s,a,u){const h=a.constantOr(this.value);i.set(e,u,h instanceof lr?h.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.kind==="constant"&&this.lutExpression.value==="none"?null:this.context.lut):h)}getBinding(e,i){return this.type==="color"?new Lu(e):new bn(e)}}class Sc{constructor(e,i){this.uniformNames=i.map((s=>`u_${s}`)),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,i){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=i?i.tl.concat(i.br):this.pattern}setUniform(e,i,s,a,u){let h=null;u!=="u_pattern"&&u!=="u_dash"||(h=this.pattern),u==="u_pattern_b"&&(h=this.patternTransition),u==="u_pixel_ratio"&&(h=this.pixelRatio),h&&i.set(e,u,h)}getBinding(e,i){return i==="u_pattern"||i==="u_pattern_b"||i==="u_dash"?new _d(e):new bn(e)}}class Ta{constructor(e,i,s,a){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=i.map((u=>({name:`a_${u}`,type:"Float32",components:s==="color"?2:1,offset:0}))),this.paintVertexArray=new a}populatePaintArray(e,i,s,a,u,h,f,g){const x=this.paintVertexArray.length,T=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new Ar(0,{brightness:h,worldview:g}),i,{},u,a,f):this.expression.kind==="constant"&&this.expression.value,E=Du(this.lutExpression,i,{},a,u,h,f,g);this.paintVertexArray.resize(e),this._setPaintValue(x,e,T,E?null:this.context.lut)}updatePaintArray(e,i,s,a,u,h,f,g){const x=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:f,worldview:g},s,a,void 0,u):this.expression.kind==="constant"&&this.expression.value,T=Du(this.lutExpression,s,a,u,void 0,f,void 0,g);this._setPaintValue(e,i,x,T?null:this.context.lut)}_setPaintValue(e,i,s,a){if(this.type==="color"){const u=sp(s.toPremultipliedRenderColor(a));for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,u[0],u[1])}else{for(let u=e;u<i;u++)this.paintVertexArray.emplace(u,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ea{constructor(e,i,s,a,u,h){this.expression=e,this.uniformNames=i.map((f=>`u_${f}_t`)),this.type=s,this.useIntegerZoom=a,this.context=u,this.maxValue=0,this.paintVertexAttributes=i.map((f=>({name:`a_${f}`,type:"Float32",components:s==="color"?4:2,offset:0}))),this.paintVertexArray=new h}populatePaintArray(e,i,s,a,u,h,f,g){const x=this.expression.evaluate(new Ar(this.context.zoom,{brightness:h,worldview:g}),i,{},u,a,f),T=this.expression.evaluate(new Ar(this.context.zoom+1,{brightness:h,worldview:g}),i,{},u,a,f),E=Du(this.lutExpression,i,{},a,u,h,f,g),A=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(A,e,x,T,E?null:this.context.lut)}updatePaintArray(e,i,s,a,u,h,f,g){const x=this.expression.evaluate({zoom:this.context.zoom,brightness:f,worldview:g},s,a,void 0,u),T=this.expression.evaluate({zoom:this.context.zoom+1,brightness:f,worldview:g},s,a,void 0,u),E=Du(this.lutExpression,s,a,u,void 0,f,void 0,g);this._setPaintValue(e,i,x,T,E?null:this.context.lut)}_setPaintValue(e,i,s,a,u){if(this.type==="color"){const h=sp(s.toPremultipliedRenderColor(u)),f=sp(s.toPremultipliedRenderColor(u));for(let g=e;g<i;g++)this.paintVertexArray.emplace(g,h[0],h[1],f[0],f[1])}else{for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,s,a);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,s,a,u){const h=this.useIntegerZoom?Math.floor(s.zoom):s.zoom,f=j(this.expression.interpolationFactor(h,this.context.zoom,this.context.zoom+1),0,1);i.set(e,u,f)}getBinding(e,i){return new bn(e)}}class Sa{constructor(e,i,s,a,u){this.expression=e,this.layerId=u,this.paintVertexAttributes=(s==="array"?Ly:My).members;for(let h=0;h<i.length;++h);this.paintVertexArray=new a,this.paintTransitionVertexArray=new ql}populatePaintArray(e,i,s,a){const u=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(u,e,i.patterns&&i.patterns[this.layerId],s)}updatePaintArray(e,i,s,a,u,h,f){this._setPaintValues(e,i,s.patterns&&s.patterns[this.layerId],h)}_setPaintValues(e,i,s,a){if(!a||!s)return;const u=a[s[0]],h=a[s[1]];if(u){if(u){const{tl:f,br:g,pixelRatio:x}=u;for(let T=e;T<i;T++)this.paintVertexArray.emplace(T,f[0],f[1],g[0],g[1],x)}if(h){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:f,br:g}=h;for(let x=e;x<i;x++)this.paintTransitionVertexArray.emplace(x,f[0],f[1],g[0],g[1])}}}upload(e){const i=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,i)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,Py.members,i))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class al{constructor(e,i,s=(()=>!0)){this.binders={},this._buffers=[],this.context=i;const a=[];for(const u in e.paint._values){const h=e.paint.get(u);if(u.endsWith("-use-theme")||!s(u)||!(h instanceof Nl&&xu(h.property.specification)))continue;const f=zy(u,e.type),g=h.value,x=h.property.specification.type,T=!!h.property.useIntegerZoom,E=u==="line-dasharray"||u.endsWith("pattern"),A=e.paint.get(`${u}-use-theme`),P=u==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||A&&A.value.kind!=="constant";if(g.kind!=="constant"||P)if(g.kind==="source"||P||E){const L=ap(u,x,"source");this.binders[u]=E?new Sa(g,f,x,L,e.id):new Ta(g,f,x,L),a.push(`/a_${u}`)}else{const L=ap(u,x,"composite");this.binders[u]=new Ea(g,f,x,T,i,L),a.push(`/z_${u}`)}else this.binders[u]=E?new Sc(g.value,f):new Ou(g.value,f,x,i),a.push(`/u_${u}`);A&&(this.binders[u].lutExpression=A.value)}this.cacheKey=a.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof Ta||i instanceof Ea?i.maxValue:0}populatePaintArrays(e,i,s,a,u,h,f,g){for(const x in this.binders){const T=this.binders[x];T.context=this.context,(T instanceof Ta||T instanceof Ea||T instanceof Sa)&&T.populatePaintArray(e,i,s,a,u,h,f,g)}}setConstantPatternPositions(e,i){for(const s in this.binders){const a=this.binders[s];a instanceof Sc&&a.setConstantPatternPositions(e,i)}}getPatternTransitionVertexBuffer(e){const i=this.binders[e];return i instanceof Sa?i.paintTransitionVertexBuffer:null}updatePaintArrays(e,i,s,a,u,h,f,g,x,T){let E=!1;const A=Object.keys(e),P=A.length!==0&&!g,L=P?A:i.uniqueIds;this.context.lut=u.lut;for(const F in this.binders){const U=this.binders[F];if(U.context=this.context,(U instanceof Ta||U instanceof Ea||U instanceof Sa)&&U.expression&&U.expression.kind&&U.expression.kind!=="constant"&&(U.expression.isStateDependent===!0||U.expression.isLightConstant===!1)){const V=u.paint.get(F);U.expression=V.value;for(const $ of L){const X=e[$.toString()];i.eachPosition($,((Q,de,ae)=>{const me=a.feature(Q);U.updatePaintArray(de,ae,me,X,h,f,x,T)}))}if(!P)for(const $ of s.uniqueIds){const X=e[$.toString()];s.eachPosition($,((Q,de,ae)=>{const me=a.feature(Q);U.updatePaintArray(de,ae,me,X,h,f,x,T)}))}E=!0}}return E}defines(){const e=[];for(const i in this.binders){const s=this.binders[i];(s instanceof Ou||s instanceof Sc)&&e.push(...s.uniformNames.map((a=>`#define HAS_UNIFORM_${a}`)))}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const s in this.binders){const a=this.binders[s];if(a instanceof Ou||a instanceof Sc||a instanceof Ea)for(const u of a.uniformNames)i.push({name:u,property:s,binding:a.getBinding(e,u)})}return i}setUniforms(e,i,s,a,u){for(const{name:h,property:f,binding:g}of s)this.binders[f].setUniform(e,g,u,a.get(f),h)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof Ta||i instanceof Ea||i instanceof Sa)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer),i instanceof Sa&&i.paintTransitionVertexBuffer&&this._buffers.push(i.paintTransitionVertexBuffer)}}upload(e){for(const i in this.binders){const s=this.binders[i];(s instanceof Ta||s instanceof Ea||s instanceof Sa)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof Ta||i instanceof Ea||i instanceof Sa)&&i.destroy()}}}class As{constructor(e,i,s=(()=>!0)){this.programConfigurations={};for(const a of e)this.programConfigurations[a.id]=new al(a,i,s);this.needsUpload=!1,this._featureMap=new Mu,this._featureMapWithoutIds=new Mu,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,s,a,u,h,f,g,x){for(const T in this.programConfigurations)this.programConfigurations[T].populatePaintArrays(e,i,a,u,h,f,g,x);i.id!==void 0?this._featureMap.add(i.id,s,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,s,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,s,a,u,h,f,g){for(const x of s)this.needsUpload=this.programConfigurations[x.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,x,a,u,h,f||0,g)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const Oy={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function zy(r,e){return Oy[r]||[r.replace(`${e}-`,"").replace(/-/g,"_")]}const ky={"line-pattern":{source:To,composite:To},"fill-pattern":{source:To,composite:To},"fill-extrusion-pattern":{source:To,composite:To},"line-dasharray":{source:ql,composite:ql}},Fy={color:{source:Ks,composite:ol},number:{source:ba,composite:Ks}};function ap(r,e,i){const s=ky[r];return s&&s[i]||Fy[e][i]}Lt(Ou,"ConstantBinder"),Lt(Sc,"PatternConstantBinder"),Lt(Ta,"SourceExpressionBinder"),Lt(Sa,"PatternCompositeBinder"),Lt(Ea,"CompositeExpressionBinder"),Lt(al,"ProgramConfiguration",{omit:["_buffers"]}),Lt(As,"ProgramConfigurationSet");const eo=gt/Math.PI/2,ls=5,vd=6,By=16383,Ic=64,lp=[Ic,32,16],cs=-eo,us=eo;function Zl(r,e,i,s=eo){return i=Yi(i),[r*Math.sin(i)*s,-e*s,r*Math.cos(i)*s]}function Ac(r,e,i){return Zl(Math.cos(Yi(r)),Math.sin(Yi(r)),e,i)}const l=63710088e-1,t=2*Math.PI*l;class n{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new n(ne(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const i=Math.PI/180,s=this.lat*i,a=e.lat*i,u=Math.sin(s)*Math.sin(a)+Math.cos(s)*Math.cos(a)*Math.cos((e.lng-this.lng)*i);return l*Math.acos(Math.min(u,1))}toBounds(e=0){const i=360*e/40075017,s=i/Math.cos(Math.PI/180*this.lat);return new c({lng:this.lng-s,lat:this.lat-i},{lng:this.lng+s,lat:this.lat+i})}toEcef(e){return Ac(this.lat,this.lng,eo+e*eo/l)}static convert(e){if(e instanceof n)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new n(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new n(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class c{constructor(e,i){e&&(i?this.setSouthWest(e).setNorthEast(i):Array.isArray(e)&&e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof n?new n(e.lng,e.lat):n.convert(e),this}setSouthWest(e){return this._sw=e instanceof n?new n(e.lng,e.lat):n.convert(e),this}extend(e){const i=this._sw,s=this._ne;let a,u;if(e instanceof n)a=e,u=e;else{if(!(e instanceof c))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(c.convert(e)):this.extend(n.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(n.convert(e)):this;if(a=e._sw,u=e._ne,!a||!u)return this}return i||s?(i.lng=Math.min(a.lng,i.lng),i.lat=Math.min(a.lat,i.lat),s.lng=Math.max(u.lng,s.lng),s.lat=Math.max(u.lat,s.lat)):(this._sw=new n(a.lng,a.lat),this._ne=new n(u.lng,u.lat)),this}getCenter(){return new n((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new n(this.getWest(),this.getNorth())}getSouthEast(){return new n(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:s}=n.convert(e);let a=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(a=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&a}static convert(e){if(e)return e instanceof c?e:new c(e)}}const d=0,p=25.5;function _(r){return t*Math.cos(r*Math.PI/180)}function v(r){return(180+r)/360}function w(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function I(r,e){return r/_(e)}function C(r){return 360*r-180}function O(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function D(r,e){return r*_(O(e))}const z=85.051129;function N(r){return Math.cos(Yi(j(r,-z,z)))}function B(r,e){const i=j(e,d,p),s=Math.pow(2,i);return N(r)*t/(512*s)}function H(r){return 1/Math.cos(r*Math.PI/180)}function q(r,e=0){const i=Math.exp(Math.PI*(1-(r.y+e/gt)/(1<<r.z)*2));return 80150034*i/(i*i+1)/gt/(1<<r.z)}class Y{constructor(e,i,s=0){this.x=+e,this.y=+i,this.z=+s}static fromLngLat(e,i=0){const s=n.convert(e);return new Y(v(s.lng),w(s.lat),I(i,s.lat))}toLngLat(){return new n(C(this.x),O(this.y))}toAltitude(){return D(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/t*H(O(this.y))}}function te(r,e,i,s,a,u,h,f,g){const x=(e+s)/2,T=(i+a)/2,E=new st(x,T);f(E),(function(A,P,L,F,U,V){const $=L-U,X=F-V;return Math.abs((F-P)*$-(L-A)*X)/Math.hypot($,X)})(E.x,E.y,u.x,u.y,h.x,h.y)>=g?(te(r,e,i,x,T,u,E,f,g),te(r,x,T,s,a,E,h,f,g)):r.push(h)}function J(r,e,i){let s=r[0],a=s.x,u=s.y;e(s);const h=[s];for(let f=1;f<r.length;f++){const g=r[f],{x,y:T}=g;e(g),te(h,a,u,x,T,s,g,e,i),a=x,u=T,s=g}return h}function _e(r,e,i,s){if(s(e,i)){const a=e.add(i)._mult(.5);_e(r,e,a,s),_e(r,a,i,s)}else r.push(i)}function he(r,e){let i=r[0];const s=[i];for(let a=1;a<r.length;a++){const u=r[a];_e(s,i,u,e),i=u}return s}const pe=Math.pow(2,14)-1,ce=-pe-1;function se(r,e){const i=Math.round(r.x*e),s=Math.round(r.y*e);return r.x=j(i,ce,pe),r.y=j(s,ce,pe),(i<r.x||i>r.x+1||s<r.y||s>r.y+1)&&It("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function ye(r,e,i){const s=r.loadGeometry(),a=r.extent,u=gt/a;if(e&&i&&i.projection.isReprojectedInTileSpace){const h=1<<e.z,{scale:f,x:g,y:x,projection:T}=i,E=A=>{const P=C((e.x+A.x/a)/h),L=O((e.y+A.y/a)/h),F=T.project(P,L);A.x=(F.x*f-g)*a,A.y=(F.y*f-x)*a};for(let A=0;A<s.length;A++)if(r.type!==1)s[A]=J(s[A],E,1);else{const P=[];for(const L of s[A])L.x<0||L.x>=a||L.y<0||L.y>=a||(E(L),P.push(L));s[A]=P}}for(const h of s)for(const f of h)se(f,u);return s}function Ce(r,e){return{type:r.type,id:r.id,properties:r.properties,geometry:e?ye(r):[]}}class Se{constructor(e,i,s,a,u){this.properties={},this.extent=s,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=a,this._values=u,e.readFields(Ue,this,i)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos,s=[];let a,u=1,h=0,f=0,g=0;for(;e.pos<i;){if(h<=0){const x=e.readVarint();u=7&x,h=x>>3}if(h--,u===1||u===2)f+=e.readSVarint(),g+=e.readSVarint(),u===1&&(a&&s.push(a),a=[]),a&&a.push(new st(f,g));else{if(u!==7)throw new Error(`unknown command ${u}`);a&&a.push(a[0].clone())}}return a&&s.push(a),s}bbox(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos;let s=1,a=0,u=0,h=0,f=1/0,g=-1/0,x=1/0,T=-1/0;for(;e.pos<i;){if(a<=0){const E=e.readVarint();s=7&E,a=E>>3}if(a--,s===1||s===2)u+=e.readSVarint(),h+=e.readSVarint(),u<f&&(f=u),u>g&&(g=u),h<x&&(x=h),h>T&&(T=h);else if(s!==7)throw new Error(`unknown command ${s}`)}return[f,x,g,T]}toGeoJSON(e,i,s){const a=this.extent*Math.pow(2,s),u=this.extent*e,h=this.extent*i,f=this.loadGeometry();function g(A){return[360*(A.x+u)/a-180,360/Math.PI*Math.atan(Math.exp((1-2*(A.y+h)/a)*Math.PI))-90]}function x(A){return A.map(g)}let T;if(this.type===1){const A=[];for(const L of f)A.push(L[0]);const P=x(A);T=A.length===1?{type:"Point",coordinates:P[0]}:{type:"MultiPoint",coordinates:P}}else if(this.type===2){const A=f.map(x);T=A.length===1?{type:"LineString",coordinates:A[0]}:{type:"MultiLineString",coordinates:A}}else{if(this.type!==3)throw new Error("unknown feature type");{const A=(function(L){const F=L.length;if(F<=1)return[L];const U=[];let V,$;for(let X=0;X<F;X++){const Q=je(L[X]);Q!==0&&($===void 0&&($=Q<0),$===Q<0?(V&&U.push(V),V=[L[X]]):V&&V.push(L[X]))}return V&&U.push(V),U})(f),P=[];for(const L of A)P.push(L.map(x));T=P.length===1?{type:"Polygon",coordinates:P[0]}:{type:"MultiPolygon",coordinates:P}}}const E={type:"Feature",geometry:T,properties:this.properties};return this.id!=null&&(E.id=this.id),E}}function Ue(r,e,i){r===1?e.id=i.readVarint():r===2?(function(s,a){const u=s.readVarint()+s.pos;for(;s.pos<u;){const h=a._keys[s.readVarint()],f=a._values[s.readVarint()];a.properties[h]=f}})(i,e):r===3?e.type=i.readVarint():r===4&&(e._geometry=i.pos)}function je(r){let e=0;for(let i,s,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],s=r[h],e+=(s.x-i.x)*(i.y+s.y);return e}Se.types=["Unknown","Point","LineString","Polygon"];class Xe{constructor(e,i){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(ht,this,i),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const i=this._pbf.readVarint()+this._pbf.pos;return new Se(this._pbf,i,this.extent,this._keys,this._values)}}function ht(r,e,i){r===15?e.version=i.readVarint():r===1?e.name=i.readString():r===5?e.extent=i.readVarint():r===2?e._features.push(i.pos):r===3?e._keys.push(i.readString()):r===4&&e._values.push((function(s){let a=null;const u=s.readVarint()+s.pos;for(;s.pos<u;){const h=s.readVarint()>>3;a=h===1?s.readString():h===2?s.readFloat():h===3?s.readDouble():h===4?s.readVarint64():h===5?s.readVarint():h===6?s.readSVarint():h===7?s.readBoolean():null}if(a==null)throw new Error("unknown feature value");return a})(i))}class ke{constructor(e,i){this.layers=e.readFields(we,{},i)}}function we(r,e,i){if(r===3){const s=new Xe(i,i.readVarint()+i.pos);s.length&&(e[s.name]=s)}}const He="3d_elevation_id",Be="level";class et{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,s){return this.get(e,!0,i,s)}optional(e,i,s){return this.get(e,!1,i,s)}success(){return this._valid}get(e,i,s,a){const u=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&u!==void 0&&!Number.isNaN(u)?s(a?a(u):u):i&&(this._valid=!1),this}}class vt{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,s){return this.featureFunc(e,i,s)}parseVertex(e,i,s){return this.vertexFunc(e,i,s)}}const St=new vt(((r,e,i)=>r.reset(e).require(He,(s=>{i.id=s})).optional("fixed_height_relative",(s=>{i.constantHeight=s}),dt.decodeRelativeHeight).geometry((s=>{i.bounds=s}),ma).success()),((r,e,i)=>r.reset(e).require(He,(s=>{i.id=s})).require("elevation_idx",(s=>{i.idx=s})).require("extent",(s=>{i.extent=s})).require("height_relative",(s=>{i.height=s}),dt.decodeRelativeHeight).geometry((s=>{i.position=s}),dt.getPoint).success())),_t=new vt(((r,e,i)=>r.reset(e).require(He,(s=>{i.id=s})).optional("fixed_height",(s=>{i.constantHeight=s}),dt.decodeMetricHeight).geometry((s=>{i.bounds=s}),ma).success()),((r,e,i)=>r.reset(e).require(He,(s=>{i.id=s})).require("elevation_idx",(s=>{i.idx=s})).require("extent",(s=>{i.extent=s})).require("height",(s=>{i.height=s}),dt.decodeMetricHeight).geometry((s=>{i.position=s}),dt.getPoint).success()));class dt{static getPoint(e){return vo(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static getVersionSchema(e){return e?e==="1.0.1"?_t:void 0:St}static parse(e){const i=[],s=[],a=e.length,u=new et;for(let h=0;h<a;h++){const f=e.feature(h),g=f.properties.version,x=dt.getVersionSchema(g);if(x===void 0){It(`Unknown elevation feature version number ${g||"(unknown)"}`);continue}const T=f.properties.type;if(!T)continue;const E=Se.types[f.type];if(E==="Point"&&T==="curve_point"){const A={};x.parseVertex(u,f,A)&&i.push(A)}else if(E==="Polygon"&&T==="curve_meta"){const A={};x.parseFeature(u,f,A)&&s.push(A)}}return{vertices:i,features:s}}}class kt{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){const a=wl(i,this.dir);if(Math.abs(a)<1e-6)return!1;const u=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/a;return s[0]=this.pos[0]+this.dir[0]*u,s[1]=this.pos[1]+this.dir[1]*u,!0}}class Dt{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){const a=ki(i,this.dir);if(Math.abs(a)<1e-6)return!1;const u=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/a;return s[0]=this.pos[0]+this.dir[0]*u,s[1]=this.pos[1]+this.dir[1]*u,s[2]=this.pos[2]+this.dir[2]*u,!0}closestPointOnSphere(e,i,s){if((function(P,L){var F=P[0],U=P[1],V=P[2],$=L[0],X=L[1],Q=L[2];return Math.abs(F-$)<=G*Math.max(1,Math.abs(F),Math.abs($))&&Math.abs(U-X)<=G*Math.max(1,Math.abs(U),Math.abs(X))&&Math.abs(V-Q)<=G*Math.max(1,Math.abs(V),Math.abs(Q))})(this.pos,e)||i===0)return s[0]=s[1]=s[2]=0,!1;const[a,u,h]=this.dir,f=this.pos[0]-e[0],g=this.pos[1]-e[1],x=this.pos[2]-e[2],T=a*a+u*u+h*h,E=2*(f*a+g*u+x*h),A=E*E-4*T*(f*f+g*g+x*x-i*i);if(A<0){const P=Math.max(-E/2,0),L=f+a*P,F=g+u*P,U=x+h*P,V=Math.hypot(L,F,U);return s[0]=L*i/V,s[1]=F*i/V,s[2]=U*i/V,!1}{const P=(-E-Math.sqrt(A))/(2*T);if(P<0){const L=Math.hypot(f,g,x);return s[0]=f*i/L,s[1]=g*i/L,s[2]=x*i/L,!1}return s[0]=f+a*P,s[1]=g+u*P,s[2]=x+h*P,!0}}}class Tt{constructor(e,i,s,a,u){this.TL=e,this.TR=i,this.BR=s,this.BL=a,this.horizon=u}static fromInvProjectionMatrix(e,i,s){const a=[-1,1,1],u=[1,1,1],h=[1,-1,1],f=[-1,-1,1],g=kr(a,a,e),x=kr(u,u,e),T=kr(h,h,e),E=kr(f,f,e);return new Tt(g,x,T,E,i/s)}}function At(r,e,i){let s=1/0,a=-1/0;const u=[];for(const h of r){Kr(u,h,e);const f=ki(u,i);s=Math.min(s,f),a=Math.max(a,f)}return[s,a]}function Wt(r,e){let i=!0;for(let s=0;s<r.planes.length;s++){const a=r.planes[s];let u=0;for(let h=0;h<e.length;h++)u+=+(ki(a,e[h])+a[3]>=0);if(u===0)return 0;u!==e.length&&(i=!1)}return i?2:1}function ci(r,e){for(const i of r.projections){const s=At(e,r.points[0],i.axis);if(i.projection[1]<s[0]||i.projection[0]>s[1])return 0}return 1}function Di(r,e){let i=0;const s=[0,0,0,0];for(let h=0;h<r.length;h++)s[0]=r[h][0],s[1]=r[h][1],s[2]=r[h][2],s[3]=1,(a=s)[0]*(u=e)[0]+a[1]*u[1]+a[2]*u[2]+a[3]*u[3]>=0&&i++;var a,u;return i}class er{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=Ft.fromPoints(this.points),this.projections=[],this.frustumEdges=[Kr([],this.points[2],this.points[3]),Kr([],this.points[0],this.points[3]),Kr([],this.points[4],this.points[0]),Kr([],this.points[5],this.points[1]),Kr([],this.points[6],this.points[2]),Kr([],this.points[7],this.points[3])];for(const s of this.frustumEdges){const a=[0,-s[2],s[1]],u=[s[2],0,-s[0]];this.projections.push({axis:a,projection:At(this.points,this.points[0],a)}),this.projections.push({axis:u,projection:At(this.points,this.points[0],u)})}}static fromInvProjectionMatrix(e,i,s,a){const u=Math.pow(2,s),h=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((x=>{const T=Jn([],x,e),E=1/T[3]/i*u;return(A=T)[0]=(P=T)[0]*(L=[E,E,a?1/T[3]:E,E])[0],A[1]=P[1]*L[1],A[2]=P[2]*L[2],A[3]=P[3]*L[3],A;var A,P,L})),f=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((x=>{const T=ui([],wr([],Kr([],h[x[0]],h[x[1]]),Kr([],h[x[2]],h[x[1]]))),E=-ki(T,h[x[1]]);return T.concat(E)})),g=[];for(let x=0;x<h.length;x++)g.push([h[x][0],h[x][1],h[x][2]]);return new er(g,f)}intersectsPrecise(e,i,s){for(let a=0;a<i.length;a++)if(!Di(e,i[a]))return 0;for(let a=0;a<this.planes.length;a++)if(!Di(e,this.planes[a]))return 0;for(const a of s)for(const u of this.frustumEdges){const h=wr([],a,u),f=rr(h);if(f===0)continue;yr(h,h,1/f);const g=At(this.points,this.points[0],h),x=At(e,this.points[0],h);if(g[0]>x[1]||x[0]>g[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const s=i[3];if(ki([i[0],i[1],i[2]],e)+s<0)return!1}return!0}}class Ft{static fromPoints(e){const i=[1/0,1/0,1/0],s=[-1/0,-1/0,-1/0];for(const a of e)Nn(i,i,a),An(s,s,a);return new Ft(i,s)}static fromTileIdAndHeight(e,i,s){const a=1<<e.canonical.z,u=e.canonical.x,h=e.canonical.y;return new Ft([u/a,h/a,i],[(u+1)/a,(h+1)/a,s])}static applyTransform(e,i){const s=e.getCorners();for(let a=0;a<s.length;++a)kr(s[a],s[a],i);return Ft.fromPoints(s)}static applyTransformFast(e,i){const s=[i[12],i[13],i[14]],a=[...s];for(let u=0;u<3;u++)for(let h=0;h<3;h++){const f=i[4*h+u],g=f*e.min[h],x=f*e.max[h];s[u]+=Math.min(g,x),a[u]+=Math.max(g,x)}return new Ft(s,a)}static projectAabbCorners(e,i){const s=e.getCorners();for(let a=0;a<s.length;++a)kr(s[a],s[a],i);return s}constructor(e,i){this.min=e,this.max=i,this.center=yr([],Bi([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],s=Ai(this.min),a=Ai(this.max);for(let u=0;u<i.length;u++)s[u]=i[u]?this.min[u]:this.center[u],a[u]=i[u]?this.center[u]:this.max[u];return a[2]=this.max[2],new Ft(s,a)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Wt(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Wt(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?ci(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?ci(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}Lt(Ft,"Aabb");class Ji{constructor(e,i){this.feature=e,this.metersToTile=i,this.index=0}get(){const e=this.feature.vertices[this.index],i=this.feature.vertexProps[this.index].dir,s=i[1],a=-i[0],u=(e.extent+1)*this.metersToTile;return[new st(Math.trunc(e.position[0]+s*u),Math.trunc(e.position[1]+a*u)),new st(Math.trunc(e.position[0]-s*u),Math.trunc(e.position[1]-a*u))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class ai{constructor(e,i,s,a,u,h){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[Vn(),Vn(),Vn(),Vn(),Vn(),Vn(),Vn()],this.id=e,this.heightRange={min:s,max:s},this.safeArea=i,this.constantHeight=s,this.constantHeight==null&&(this.constantHeight!=null||a.length!==0)){this.vertices=a,this.edges=u,this.edges=this.edges.filter((f=>{return f.a<this.vertices.length&&f.b<this.vertices.length&&!((g=this.vertices[f.a].position)[0]===(x=this.vertices[f.b].position)[0]&&g[1]===x[1]);var g,x})),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const f of this.vertices)this.vertexProps.push({dir:vo(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,f.height),this.heightRange.max=Math.max(this.heightRange.max,f.height);for(const f of this.edges){const g=this.vertices[f.a].position,x=this.vertices[f.b].position,T=Vs(Vn(),x,g),E=ys(T),A=ua(Vn(),T,1/E);this.edgeProps.push({vec:T,dir:A,len:E});const P=this.vertexProps[f.a].dir,L=this.vertexProps[f.b].dir;Ga(P,P,A),Ga(L,L,A)}for(const f of this.vertexProps)f.dir[0]===0&&f.dir[1]===0||Yc(f.dir,f.dir);this.tessellate(h)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;const i=this.getClosestEdge(e);if(i==null)return 0;const[s,a]=i;return ei(this.vertices[this.edges[s].a].height,this.vertices[this.edges[s].b].height,a)}computeSlopeNormal(e,i){const s=this.getClosestEdge(e);if(!s)return Li(0,0,1);const a=s[0],u=this.edges[a],h=this.edgeProps[a].vec,f=Li(h[0],h[1],(this.vertices[u.b].height-this.vertices[u.a].height)*i),g=Li(f[1],-f[0],0);wr(g,g,f);const x=rr(g);return x>0?yr(g,g,1/x):di(g,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,s=Number.POSITIVE_INFINITY,a=0;const[u,h,f,g,x,T,E]=this._tmpVec2;Xc(E,e.x,e.y);const A=new kt(E,null);for(let P=0;P<this.edges.length;P++){const L=this.edges[P],F=this.edgeProps[P].dir;A.dir=F;const U=this.vertices[L.a].position,V=this.vertices[L.b].position,$=A.intersectsPlane(U,this.vertexProps[L.a].dir,u),X=A.intersectsPlane(V,this.vertexProps[L.b].dir,h);if(!$||!X)continue;Vs(f,h,u),Vs(g,E,u);const Q=wl(f,f),de=Q>0?wl(g,f)/Q:0,ae=j(de,0,1),me=Math.abs((de-ae)*this.edgeProps[P].len);Vs(x,E,U),Xc(T,F[1],-F[0]);const xe=me+Math.abs(wl(x,T));xe<s&&(i=P,s=xe,a=ae)}return[i,a]}tessellate(e){const i=Pt(),s=Pt(),a=Pt(),u=Pt();for(let h=this.edges.length-1;h>=0;--h){const f=this.edges[h].a,g=this.edges[h].b,{position:x,height:T,extent:E}=this.vertices[f],{position:A,height:P,extent:L}=this.vertices[g],F=this.vertexProps[f].dir,U=this.vertexProps[g].dir;if(di(i,x[0]/e,x[1]/e,T),di(s,A[0]/e,A[1]/e,P),di(a,F[1],-F[0],0),yr(a,a,E),di(u,U[1],-U[0],0),yr(u,u,L),this.distSqLines(Li(i[0]+.5*a[0],i[1]+.5*a[1],i[2]+.5*a[2]),Li(s[0]-.5*u[0],s[1]-.5*u[1],s[2]-.5*u[2]),Li(i[0]-.5*a[0],i[1]-.5*a[1],i[2]-.5*a[2]),Li(s[0]+.5*u[0],s[1]+.5*u[1],s[2]+.5*u[2]))<=.0025000000000000005)continue;const V=this.vertices.length,$=Ga(Vn(),x,A);this.vertices.push({position:ua($,$,.5),height:.5*(T+P),extent:.5*(E+L)});const X=Ga(Vn(),F,U);this.vertexProps.push({dir:Yc(X,X)}),this.edges.splice(h,1),this.edgeProps.splice(h,1),this.edges.push({a:f,b:V}),this.edges.push({a:V,b:g});const Q=Vs(Vn(),this.vertices[V].position,x),de=ys(Q),ae={vec:Q,dir:ua(Vn(),Q,1/de),len:de};this.edgeProps.push(ae),this.edgeProps.push(ae)}}distSqLines(e,i,s,a){const u=jr(Pt(),i,e),h=jr(Pt(),a,s),f=jr(Pt(),e,s),g=ki(u,u),x=ki(u,h),T=ki(u,f),E=ki(h,h),A=ki(h,f),P=g*E-x*x;if(P===0)return Si(Hn(u,s,a,ki(f,h)/ki(h,h)),e);const L=(g*A-x*T)/P;return Si(Hn(u,e,i,(x*A-T*E)/P),Hn(h,s,a,L))}}class nr{static parseFrom(e,i){const s=dt.parse(e);if(!s)return[];let{vertices:a,features:u}=s;const h=1/q(i);u.sort(((T,E)=>T.id-E.id)),a.sort(((T,E)=>T.id-E.id||T.idx-E.idx)),a=a.filter(((T,E,A)=>E===A.findIndex((P=>P.id===T.id&&P.idx===T.idx))));const f=new Array;let g=0;const x=a.length;for(const T of u){if(T.constantHeight){f.push(new ai(T.id,T.bounds,T.constantHeight));continue}for(;g!==x&&a[g].id<T.id;)g++;if(g===x||a[g].id!==T.id)continue;const E=new Array,A=new Array,P=g;for(;g!==x&&a[g].id===T.id;){const L=a[g];if(E.push({position:L.position,height:L.height,extent:L.extent}),g!==P&&a[g-1].idx===L.idx-1){const F=g-P;A.push({a:F-1,b:F})}g++}f.push(new ai(T.id,T.bounds,void 0,E,A,h))}return f}static getElevationFeature(e,i){if(!i)return;const s=+e.properties[He];return Number.isNaN(s)?void 0:i.find((a=>a.id===s))}}class fr{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*gt,this.yOffset=(e.y*this.zScale-i.y)*gt)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,s){const a=this.constantElevation(i,s);return a??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),s))}computeBiasedHeight(e,i){return i<=0?e:e+i*W(0,i,e>=0?e:Math.abs(.5*e))}}Lt(ai,"ElevationFeature");class cr{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new nl,this.indexArray=new xn,this.segments=new Fr,this.programConfigurations=new As(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new ba),this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,s,a){}populate(e,i,s,a){const u=this.layers[0],h=[];let f=null;u.type==="circle"&&(f=u.layout.get("circle-sort-key"));for(const{feature:x,id:T,index:E,sourceLayerIndex:A}of e){const P=this.layers[0]._featureFilter.needGeometry,L=Ce(x,P);if(!this.layers[0]._featureFilter.filter(new Ar(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),L,s))continue;const F=f?f.evaluate(L,{},s):void 0,U={id:T,properties:x.properties,type:x.type,sourceLayerIndex:A,index:E,geometry:P?L.geometry:ye(x,s,a),patterns:{},sortKey:F};h.push(U)}f&&h.sort(((x,T)=>x.sortKey-T.sortKey));let g=null;a.projection.name==="globe"&&(this.globeExtVertexArray=new id,g=a.projection);for(const x of h){const{geometry:T,index:E,sourceLayerIndex:A}=x,P=e[E].feature;this.addFeature(x,T,E,i.availableImages,s,g,i.brightness,i.elevationFeatures),i.featureIndex.insert(P,T,E,A,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,i,s,a,u,h,f){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,T_.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,E_.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Cy.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,i,s,a,u,h,f,g){let x;this.elevationMode!=="none"&&(x=nr.getElevationFeature(e,g));for(const T of i)for(const E of T){const A=E.x,P=E.y;if(A<0||A>=gt||P<0||P>=gt)continue;if(h){const U=h.projectTilePoint(A,P,u),V=h.upVector(u,A,P);this.addGlobeExtVertex(U,V),this.addGlobeExtVertex(U,V),this.addGlobeExtVertex(U,V),this.addGlobeExtVertex(U,V)}const L=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),F=L.vertexLength;if(this.addCircleVertex(A,P,-1,-1),this.addCircleVertex(A,P,1,-1),this.addCircleVertex(A,P,1,1),this.addCircleVertex(A,P,-1,1),this.elevationMode!=="none"){const U=x?x.pointElevation(new st(A,P)):0;this.hasElevation=this.hasElevation||U!==0;for(let V=0;V<4;V++)this.elevatedLayoutVertexArray.emplaceBack(U)}this.indexArray.emplaceBack(F,F+1,F+2),this.indexArray.emplaceBack(F,F+2,F+3),L.vertexLength+=4,L.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},a,u,f,void 0,this.worldview)}addCircleVertex(e,i,s,a){this.layoutVertexArray.emplaceBack(2*e+(s+1)/2,2*i+(a+1)/2)}addGlobeExtVertex(e,i){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}}function Xi(r,e){for(let i=0;i<r.length;i++)if(vr(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(vr(r,e[i]))return!0;return!!Rr(r,e)}function vi(r,e,i){return!!vr(r,e)||!!Mr(e,r,i)}function ir(r,e){if(r.length===1)return Br(e,r[0]);for(let i=0;i<e.length;i++){const s=e[i];for(let a=0;a<s.length;a++)if(vr(r,s[a]))return!0}for(let i=0;i<r.length;i++)if(Br(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(Rr(r,e[i]))return!0;return!1}function $r(r,e,i){if(r.length>1){if(Rr(r,e))return!0;for(let s=0;s<e.length;s++)if(Mr(e[s],r,i))return!0}for(let s=0;s<r.length;s++)if(Mr(r[s],e,i))return!0;return!1}function Rr(r,e){if(r.length===0||e.length===0)return!1;for(let i=0;i<r.length-1;i++){const s=r[i],a=r[i+1];for(let u=0;u<e.length-1;u++)if(or(s,a,e[u],e[u+1]))return!0}return!1}function or(r,e,i,s){return yi(r,i,s)!==yi(e,i,s)&&yi(r,e,i)!==yi(r,e,s)}function Gi(r,e,i){return(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x)}function xi(r,e,i,s){const a=Gi(r,e,s),u=Gi(r,e,i);if(Math.sign(a)===Math.sign(u))return;const h=Gi(i,s,r),f=h+u-a;return Math.sign(h)!==Math.sign(f)?[h/(h-f),u/(u-a)]:void 0}function Mr(r,e,i){const s=i*i;if(e.length===1)return r.distSqr(e[0])<s;for(let a=1;a<e.length;a++)if(sn(r,e[a-1],e[a])<s)return!0;return!1}function sn(r,e,i){const s=e.distSqr(i);if(s===0)return r.distSqr(e);const a=((r.x-e.x)*(i.x-e.x)+(r.y-e.y)*(i.y-e.y))/s;return r.distSqr(a<0?e:a>1?i:i.sub(e)._mult(a)._add(e))}function Br(r,e){let i,s,a,u=!1;for(let h=0;h<r.length;h++){i=r[h];for(let f=0,g=i.length-1;f<i.length;g=f++)s=i[f],a=i[g],s.y>e.y!=a.y>e.y&&e.x<(a.x-s.x)*(e.y-s.y)/(a.y-s.y)+s.x&&(u=!u)}return u}function vr(r,e){let i=!1;for(let s=0,a=r.length-1;s<r.length;a=s++){const u=r[s],h=r[a];u.y>e.y!=h.y>e.y&&e.x<(h.x-u.x)*(e.y-u.y)/(h.y-u.y)+u.x&&(i=!i)}return i}function mo(r,e,i,s,a){for(const h of r)if(e<=h.x&&i<=h.y&&s>=h.x&&a>=h.y)return!0;const u=[new st(e,i),new st(e,a),new st(s,a),new st(s,i)];if(r.length>2){for(const h of u)if(vr(r,h))return!0}for(let h=0;h<r.length-1;h++)if(Xn(r[h],r[h+1],u))return!0;return!1}function Xn(r,e,i){const s=i[0],a=i[2];if(r.x<s.x&&e.x<s.x||r.x>a.x&&e.x>a.x||r.y<s.y&&e.y<s.y||r.y>a.y&&e.y>a.y)return!1;const u=yi(r,e,i[0]);return u!==yi(r,e,i[1])||u!==yi(r,e,i[2])||u!==yi(r,e,i[3])}function wn(r,e,i,s,a,u){let h=e.y-r.y,f=r.x-e.x;if(u=u||0){const g=h*h+f*f;if(g===0)return!0;const x=Math.sqrt(g);h/=x,f/=x}return!((i.x-r.x)*h+(i.y-r.y)*f-u<0||(s.x-r.x)*h+(s.y-r.y)*f-u<0||(a.x-r.x)*h+(a.y-r.y)*f-u<0)}function to(r,e,i,s,a,u,h){return!(wn(r,e,s,a,u,h)||wn(e,i,s,a,u,h)||wn(i,r,s,a,u,h)||wn(s,a,r,e,i,h)||wn(a,u,r,e,i,h)||wn(u,s,r,e,i,h))}function io(r,e,i){const s=e.paint.get(r).value;return s.kind==="constant"?s.value:i.programConfigurations.get(e.id).getMaxValue(r)}function $n(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function Zo(r,e,i,s,a){if(!e[0]&&!e[1])return r;const u=st.convert(e)._mult(a);i==="viewport"&&u._rotate(-s);const h=[];for(let f=0;f<r.length;f++)h.push(r[f].sub(u));return h}function hs(r,e,i,s){const a=st.convert(r)._mult(s);return e==="viewport"&&a._rotate(-i),a}let So,tn;function ln(r,e,i){var s=2*Math.PI*6378137/256/Math.pow(2,i);return[r*s-2*Math.PI*6378137/2,e*s-2*Math.PI*6378137/2]}Lt(cr,"CircleBucket",{omit:["layers"]});class xr{constructor(e,i,s){this.z=e,this.x=i,this.y=s,this.key=Nr(0,e,e,i,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){const i=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>i&&e.y===this.y>>i}url(e,i){const s=(function(u,h,f){var g=ln(256*u,256*(h=Math.pow(2,f)-h-1),f),x=ln(256*(u+1),256*(h+1),f);return g[0]+","+g[1]+","+x[0]+","+x[1]})(this.x,this.y,this.z),a=(function(u,h,f){let g,x="";for(let T=u;T>0;T--)g=1<<T-1,x+=(h&g?1:0)+(f&g?2:0);return x})(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",a).replace("{bbox-epsg-3857}",s)}toString(){return`${this.z}/${this.x}/${this.y}`}}class dn{constructor(e,i){this.wrap=e,this.canonical=i,this.key=Nr(e,i.z,i.z,i.x,i.y)}}class Wr{constructor(e,i,s,a,u){this.overscaledZ=e,this.wrap=i,this.canonical=new xr(s,+a,+u),this.key=i===0&&e===s?this.canonical.key:Nr(i,e,s,a,u)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new Wr(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Wr(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return Nr(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const s=this.canonical.z-e;return Nr(this.wrap*+i,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new Wr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,s=2*this.canonical.x,a=2*this.canonical.y;return[new Wr(i,this.wrap,i,s,a),new Wr(i,this.wrap,i,s+1,a),new Wr(i,this.wrap,i,s,a+1),new Wr(i,this.wrap,i,s+1,a+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Wr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Wr(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new dn(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Nr(r,e,i,s,a){const u=1<<Math.min(i,22);let h=u*(a%u)+s%u;return r&&i<22&&(h+=u*u*((r<0?-2*r-1:2*r)%(1<<2*(22-i)))),16*(32*h+i)+(e-i)}const ds=[r=>{let e=r.canonical.x-1,i=r.wrap;return e<0&&(e=(1<<r.canonical.z)-1,i--),new Wr(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>{let e=r.canonical.x+1,i=r.wrap;return e===1<<r.canonical.z&&(e=0,i++),new Wr(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>new Wr(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,(r.canonical.y===0?1<<r.canonical.z:r.canonical.y)-1),r=>new Wr(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y===(1<<r.canonical.z)-1?0:r.canonical.y+1)];Lt(xr,"CanonicalTileID"),Lt(Wr,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const zu=Ci([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Cs}=zu,ku=Ci([{name:"a_pos_3",components:3,type:"Int16"}]);var Cc=Ci([{name:"a_pos",type:"Int16",components:2}]);function ea(r){return r*eo/l}const Ia=[new Ft([cs,cs,cs],[us,us,us]),new Ft([cs,cs,cs],[0,0,us]),new Ft([0,cs,cs],[us,0,us]),new Ft([cs,0,cs],[0,us,us]),new Ft([0,0,cs],[us,us,us])];function Mc(r,e,i,s=!0){const a=yr([],r._camera.position,r.worldSize),u=[e,i,1,1];Jn(u,u,r.pixelMatrixInverse),Ns(u,u,1/u[3]);const h=ui([],Kr([],u,a)),f=r.globeMatrix,g=[f[12],f[13],f[14]],x=Kr([],g,a),T=rr(x),E=ui([],x),A=r.worldSize/(2*Math.PI),P=ki(E,h),L=Math.asin(A/T);if(L<Math.acos(P)){if(!s)return null;const Ge=[],Me=[];yr(Ge,h,T/P),ui(Me,Kr(Me,Ge,x)),ui(h,Bi(h,x,yr(h,Me,Math.tan(L)*T)))}const F=[];new Dt(a,h).closestPointOnSphere(g,A,F);const U=ui([],nn(f,0)),V=ui([],nn(f,1)),$=ui([],nn(f,2)),X=ki(U,F),Q=ki(V,F),de=ki($,F),ae=no(Math.asin(-Q/A));let me=no(Math.atan2(X,de));me=r.center.lng+(function(Ge,Me){const $e=(Me-Ge+180)%360-180;return $e<-180?$e+360:$e})(r.center.lng,me);const xe=v(me),Ee=j(w(ae),0,1);return new Y(xe,Ee)}class ll{constructor(e,i,s){this.a=Kr([],e,s),this.b=Kr([],i,s),this.center=s;const a=ui([],this.a),u=ui([],this.b);this.angle=Math.acos(ki(a,u))}}function Aa(r,e){if(r.angle===0)return null;let i;return i=r.a[e]===0?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[e]/r.a[e]/Math.sin(r.angle)-1/Math.tan(r.angle)),i<0||i>1?null:(function(s,a,u,h){const f=Math.sin(u);return s*(Math.sin((1-h)*u)/f)+a*(Math.sin(h*u)/f)})(r.a[e],r.b[e],r.angle,j(i,0,1))+r.center[e]}function Ms(r){if(r.z<=1)return Ia[r.z+2*r.y+r.x];const e=Ny(S_(r));return Ft.fromPoints(e)}function Ca(r,e,i){return yr(r,r,1-i),qn(r,r,e,i)}function Bx(r,e,i){for(const s of r)kr(s,s,e),yr(s,s,i)}function Nx(r,e,i,s){const a=e/r.worldSize,u=r.globeMatrix;if(i.z<=1){const Ee=Ms(i).getCorners();return Bx(Ee,u,a),Ft.fromPoints(Ee)}const h=S_(i,s),f=Ny(h,eo+ea(r._tileCoverLift));Bx(f,u,a);const g=Number.MAX_VALUE,x=[-g,-g,-g],T=[g,g,g];if(h.contains(r.center)){for(const Me of f)Nn(T,T,Me),An(x,x,Me);x[2]=0;const Ee=r.point,Ge=[Ee.x*a,Ee.y*a,0];return Nn(T,T,Ge),An(x,x,Ge),new Ft(T,x)}if(r._tileCoverLift>0){for(const Ee of f)Nn(T,T,Ee),An(x,x,Ee);return new Ft(T,x)}const E=[u[12]*a,u[13]*a,u[14]*a],A=h.getCenter(),P=j(r.center.lat,-z,z),L=j(A.lat,-z,z),F=v(r.center.lng),U=w(P);let V=F-v(A.lng);const $=U-w(L);V>.5?V-=1:V<-.5&&(V+=1);let X=0;Math.abs(V)>Math.abs($)?X=V>=0?1:3:(X=$>=0?0:2,qn(E,E,[u[4]*a,u[5]*a,u[6]*a],-Math.sin(Yi($>=0?h.getSouth():h.getNorth()))*eo));const Q=f[X],de=f[(X+1)%4],ae=new ll(Q,de,E),me=[Aa(ae,0)||Q[0],Aa(ae,1)||Q[1],Aa(ae,2)||Q[2]],xe=Pc(r.zoom);if(xe>0){const Ee=(function({x:Me,y:$e,z:Ke},Qe,at,ct,tt){const rt=1/(1<<Ke);let Ze=Me*rt,qe=Ze+rt,ot=$e*rt,yt=ot+rt,ft=0;const Nt=(Ze+qe)/2-ct;return Nt>.5?ft=-1:Nt<-.5&&(ft=1),Ze=((Ze+ft)*Qe-(ct*=Qe))*at+ct,qe=((qe+ft)*Qe-ct)*at+ct,ot=(ot*Qe-(tt*=Qe))*at+tt,yt=(yt*Qe-tt)*at+tt,[[Ze,yt,0],[qe,yt,0],[qe,ot,0],[Ze,ot,0]]})(i,e,r._pixelsPerMercatorPixel,F,U);for(let Me=0;Me<f.length;Me++)Ca(f[Me],Ee[Me],xe);const Ge=Bi([],Ee[X],Ee[(X+1)%4]);yr(Ge,Ge,.5),Ca(me,Ge,xe)}for(const Ee of f)Nn(T,T,Ee),An(x,x,Ee);return T[2]=Math.min(Q[2],de[2]),Nn(T,T,me),An(x,x,me),new Ft(T,x)}function S_({x:r,y:e,z:i},s=!1){const a=1/(1<<i),u=new n(C(r*a),e===(1<<i)-1&&s?-90:O((e+1)*a)),h=new n(C((r+1)*a),e===0&&s?90:O(e*a));return new c(u,h)}function Ny(r,e=eo){const i=Yi(r.getNorth()),s=Yi(r.getSouth()),a=Math.cos(i),u=Math.cos(s),h=Math.sin(i),f=Math.sin(s),g=r.getWest(),x=r.getEast();return[Zl(u,f,g,e),Zl(u,f,x,e),Zl(a,h,x,e),Zl(a,h,g,e)]}function cp(r,e,i,s){const a=1<<i.z,u=(r/gt+i.x)/a;return Ac(O((e/gt+i.y)/a),C(u),s)}function I_({min:r,max:e}){return By/Math.max(e[0]-r[0],e[1]-r[1],e[2]-r[2])}const Vx=new Float64Array(16);function A_(r){const e=I_(r),i=it(Vx,[e,e,e]);return Oe(i,i,Ti([],r.min))}function Vy(r){const e=(s=r.min,(i=Vx)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=s[0],i[13]=s[1],i[14]=s[2],i[15]=1,i);var i,s;const a=1/I_(r);return Ae(e,e,[a,a,a])}function Uy(r){const e=gt/(2*Math.PI);return r/(2*Math.PI)/e}function Ux(r,e){return gt/(512*Math.pow(2,r))*I_(Ms(e))}function jx(r,e,i,s,a){const u=Uy(i),h=[r,e,-i/(2*Math.PI)],f=K(new Float64Array(16));return Oe(f,f,h),Ae(f,f,[u,u,u]),ze(f,f,Yi(-a)),Fe(f,f,Yi(-s)),f}function Pc(r){return W(ls,vd,r)}function Gx(r,e){const i=Ac(e.lat,e.lng),s=(function(L){const F=Ac(L._center.lat,L._center.lng);let U=wr([],Li(0,1,0),F);const V=jt([],-L.angle,F);U=kr(U,U,V),jt(V,-L._pitch,U);const $=ui([],F);return yr($,$,ea(L.cameraToCenterDistance/L.pixelsPerMeter)),kr($,$,V),Bi([],F,$)})(r);return h=(a=jr([],s,i))[0],f=a[1],g=a[2],x=(u=i)[0],T=u[1],E=u[2],P=(A=Math.sqrt((h*h+f*f+g*g)*(x*x+T*T+E*E)))&&ki(a,u)/A,Math.acos(Math.min(Math.max(P,-1),1));var a,u,h,f,g,x,T,E,A,P}function jy(r,e){return Gx(r,e)>Math.PI/2*1.01}const qx=Yi(85),FS=Math.cos(qx),BS=Math.sin(qx),NS=oe(),Hx=r=>{const e=[];return r.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),r.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function Zx(r,e,i,s,a,u,h,f,g){if(u&&r.queryGeometry.isAboveHorizon)return!1;u&&(g*=r.pixelToTileUnitsFactor);const x=r.tileID.canonical,T=i.projection.upVectorScale(x,i.center.lat,i.worldSize).metersToTile;for(const E of e)for(const A of E){const P=A.add(f),L=a&&i.elevation?i.elevation.exaggeration()*a.getElevationAt(P.x,P.y,!0):0,F=i.projection.projectTilePoint(P.x,P.y,x);if(L>0){const X=i.projection.upVector(x,P.x,P.y);F.x+=X[0]*T*L,F.y+=X[1]*T*L,F.z+=X[2]*T*L}const U=u?P:VS(F.x,F.y,F.z,s),V=u?r.tilespaceRays.map((X=>jS(X,L))):r.queryGeometry.screenGeometry,$=Jn([],[F.x,F.y,F.z,1],s);if(!h&&u?g*=$[3]/i.cameraToCenterDistance:h&&!u&&(g*=i.cameraToCenterDistance/$[3]),u){const X=O((A.y/gt+x.y)/(1<<x.z));g/=i.projection.pixelsPerMeter(X,1)/I(1,X)}if(vi(V,U,g))return!0}return!1}function VS(r,e,i,s){const a=Jn([],[r,e,i,1],s);return new st(a[0]/a[3],a[1]/a[3])}const $x=Li(0,0,0),US=Li(0,0,1);function jS(r,e){const i=Pt();return $x[2]=e,r.intersectsPlane($x,US,i),new st(i[0],i[1])}class Wx extends cr{}let Xx,Yx,Jx,Kx;function Qx(r,{width:e,height:i},s,a){if(a){if(a instanceof Uint8ClampedArray)a=new Uint8Array(a.buffer);else if(a.length!==e*i*s)throw new RangeError("mismatched image size")}else a=new Uint8Array(e*i*s);return r.width=e,r.height=i,r.data=a,r}function e1(r,e,i){const{width:s,height:a}=e;s===r.width&&a===r.height||(Gy(r,e,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,s),height:Math.min(r.height,a)},i,null),r.width=s,r.height=a,r.data=e.data)}function Gy(r,e,i,s,a,u,h,f){if(a.width===0||a.height===0)return e;if(a.width>r.width||a.height>r.height||i.x>r.width-a.width||i.y>r.height-a.height)throw new RangeError("out of range source coordinates for image copy");if(a.width>e.width||a.height>e.height||s.x>e.width-a.width||s.y>e.height-a.height)throw new RangeError("out of range destination coordinates for image copy");const g=r.data,x=e.data,T=u===4&&f;for(let E=0;E<a.height;E++){const A=((i.y+E)*r.width+i.x)*u,P=((s.y+E)*e.width+s.x)*u;if(T)for(let L=0;L<a.width;L++){const F=A+L*u+3,U=P+L*u;x[U+0]=255,x[U+1]=255,x[U+2]=255,x[U+3]=g[F]}else if(h)for(let L=0;L<a.width;L++){const F=A+L*u,U=P+L*u,V=new lr(g[F+0]/255,g[F+1]/255,g[F+2]/255,g[F+3]).toNonPremultipliedRenderColor(h).toArray();x[U+0]=V[0],x[U+1]=V[1],x[U+2]=V[2],x[U+3]=V[3]}else for(let L=0;L<a.width*u;L++)x[P+L]=g[A+L]}return e}Lt(Wx,"HeatmapBucket",{omit:["layers"]});class Lc{constructor(e,i){Qx(this,e,1,i)}resize(e){e1(this,new Lc(e),1)}clone(){return new Lc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,a,u){Gy(e,i,s,a,u,1,null)}}class ro{constructor(e,i){Qx(this,e,4,i)}resize(e){e1(this,new ro(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new ro({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,a,u,h,f){Gy(e,i,s,a,u,4,h,f)}}class t1{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function up(r){const e={},i=r.resolution||256,s=r.clips?r.clips.length:1,a=r.image||new ro({width:i,height:s}),u=(h,f,g)=>{e[r.evaluationKey]=g;const x=r.expression.evaluate(e),T=x?x.toNonPremultipliedRenderColor(null):null;T&&(a.data[h+f+0]=Math.floor(255*T.r),a.data[h+f+1]=Math.floor(255*T.g),a.data[h+f+2]=Math.floor(255*T.b),a.data[h+f+3]=Math.floor(255*T.a))};if(r.clips)for(let h=0,f=0;h<s;++h,f+=4*i)for(let g=0,x=0;g<i;g++,x+=4){const T=g/(i-1),{start:E,end:A}=r.clips[h];u(f,x,E*(1-T)+A*T)}else for(let h=0,f=0;h<i;h++,f+=4)u(0,f,h/(i-1));return a}Lt(Lc,"AlphaImage"),Lt(ro,"RGBAImage");const GS=Ci([{name:"a_pos",components:2,type:"Int16"}],4),qS=Ci([{name:"a_road_z_offset",components:1,type:"Float32"}],4),HS=Ci([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),ZS=Ci([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function xd(r,e,i=2){const s=e&&e.length,a=s?e[0]*i:r.length;let u=i1(r,0,a,i,!0);const h=[];if(!u||u.next===u.prev)return h;let f,g,x;if(s&&(u=(function(T,E,A,P){const L=[];for(let F=0,U=E.length;F<U;F++){const V=i1(T,E[F]*P,F<U-1?E[F+1]*P:T.length,P,!1);V===V.next&&(V.steiner=!0),L.push(eI(V))}L.sort(JS);for(let F=0;F<L.length;F++)A=KS(L[F],A);return A})(r,e,u,i)),r.length>80*i){f=r[0],g=r[1];let T=f,E=g;for(let A=i;A<a;A+=i){const P=r[A],L=r[A+1];P<f&&(f=P),L<g&&(g=L),P>T&&(T=P),L>E&&(E=L)}x=Math.max(T-f,E-g),x=x!==0?32767/x:0}return hp(u,h,i,f,g,x,0),h}function i1(r,e,i,s,a){let u;if(a===(function(h,f,g,x){let T=0;for(let E=f,A=g-x;E<g;E+=x)T+=(h[A]-h[E])*(h[E+1]+h[A+1]),A=E;return T})(r,e,i,s)>0)for(let h=e;h<i;h+=s)u=s1(h/s|0,r[h],r[h+1],u);else for(let h=i-s;h>=e;h-=s)u=s1(h/s|0,r[h],r[h+1],u);return u&&bd(u,u.next)&&(pp(u),u=u.next),u}function Fu(r,e){if(!r)return r;e||(e=r);let i,s=r;do if(i=!1,s.steiner||!bd(s,s.next)&&Gn(s.prev,s,s.next)!==0)s=s.next;else{if(pp(s),s=e=s.prev,s===s.next)break;i=!0}while(i||s!==e);return e}function hp(r,e,i,s,a,u,h){if(!r)return;!h&&u&&(function(g,x,T,E){let A=g;do A.z===0&&(A.z=qy(A.x,A.y,x,T,E)),A.prevZ=A.prev,A.nextZ=A.next,A=A.next;while(A!==g);A.prevZ.nextZ=null,A.prevZ=null,(function(P){let L,F=1;do{let U,V=P;P=null;let $=null;for(L=0;V;){L++;let X=V,Q=0;for(let ae=0;ae<F&&(Q++,X=X.nextZ,X);ae++);let de=F;for(;Q>0||de>0&&X;)Q!==0&&(de===0||!X||V.z<=X.z)?(U=V,V=V.nextZ,Q--):(U=X,X=X.nextZ,de--),$?$.nextZ=U:P=U,U.prevZ=$,$=U;V=X}$.nextZ=null,F*=2}while(L>1)})(A)})(r,s,a,u);let f=r;for(;r.prev!==r.next;){const g=r.prev,x=r.next;if(u?WS(r,s,a,u):$S(r))e.push(g.i,r.i,x.i),pp(r),r=x.next,f=x.next;else if((r=x)===f){h?h===1?hp(r=XS(Fu(r),e),e,i,s,a,u,2):h===2&&YS(r,e,i,s,a,u):hp(Fu(r),e,i,s,a,u,1);break}}}function $S(r){const e=r.prev,i=r,s=r.next;if(Gn(e,i,s)>=0)return!1;const a=e.x,u=i.x,h=s.x,f=e.y,g=i.y,x=s.y,T=Math.min(a,u,h),E=Math.min(f,g,x),A=Math.max(a,u,h),P=Math.max(f,g,x);let L=s.next;for(;L!==e;){if(L.x>=T&&L.x<=A&&L.y>=E&&L.y<=P&&dp(a,f,u,g,h,x,L.x,L.y)&&Gn(L.prev,L,L.next)>=0)return!1;L=L.next}return!0}function WS(r,e,i,s){const a=r.prev,u=r,h=r.next;if(Gn(a,u,h)>=0)return!1;const f=a.x,g=u.x,x=h.x,T=a.y,E=u.y,A=h.y,P=Math.min(f,g,x),L=Math.min(T,E,A),F=Math.max(f,g,x),U=Math.max(T,E,A),V=qy(P,L,e,i,s),$=qy(F,U,e,i,s);let X=r.prevZ,Q=r.nextZ;for(;X&&X.z>=V&&Q&&Q.z<=$;){if(X.x>=P&&X.x<=F&&X.y>=L&&X.y<=U&&X!==a&&X!==h&&dp(f,T,g,E,x,A,X.x,X.y)&&Gn(X.prev,X,X.next)>=0||(X=X.prevZ,Q.x>=P&&Q.x<=F&&Q.y>=L&&Q.y<=U&&Q!==a&&Q!==h&&dp(f,T,g,E,x,A,Q.x,Q.y)&&Gn(Q.prev,Q,Q.next)>=0))return!1;Q=Q.nextZ}for(;X&&X.z>=V;){if(X.x>=P&&X.x<=F&&X.y>=L&&X.y<=U&&X!==a&&X!==h&&dp(f,T,g,E,x,A,X.x,X.y)&&Gn(X.prev,X,X.next)>=0)return!1;X=X.prevZ}for(;Q&&Q.z<=$;){if(Q.x>=P&&Q.x<=F&&Q.y>=L&&Q.y<=U&&Q!==a&&Q!==h&&dp(f,T,g,E,x,A,Q.x,Q.y)&&Gn(Q.prev,Q,Q.next)>=0)return!1;Q=Q.nextZ}return!0}function XS(r,e){let i=r;do{const s=i.prev,a=i.next.next;!bd(s,a)&&n1(s,i,i.next,a)&&fp(s,a)&&fp(a,s)&&(e.push(s.i,i.i,a.i),pp(i),pp(i.next),i=r=a),i=i.next}while(i!==r);return Fu(i)}function YS(r,e,i,s,a,u){let h=r;do{let f=h.next.next;for(;f!==h.prev;){if(h.i!==f.i&&tI(h,f)){let g=o1(h,f);return h=Fu(h,h.next),g=Fu(g,g.next),hp(h,e,i,s,a,u,0),void hp(g,e,i,s,a,u,0)}f=f.next}h=h.next}while(h!==r)}function JS(r,e){let i=r.x-e.x;return i===0&&(i=r.y-e.y,i===0)&&(i=(r.next.y-r.y)/(r.next.x-r.x)-(e.next.y-e.y)/(e.next.x-e.x)),i}function KS(r,e){const i=(function(a,u){let h=u;const f=a.x,g=a.y;let x,T=-1/0;if(bd(a,h))return h;do{if(bd(a,h.next))return h.next;if(g<=h.y&&g>=h.next.y&&h.next.y!==h.y){const F=h.x+(g-h.y)*(h.next.x-h.x)/(h.next.y-h.y);if(F<=f&&F>T&&(T=F,x=h.x<h.next.x?h:h.next,F===f))return x}h=h.next}while(h!==u);if(!x)return null;const E=x,A=x.x,P=x.y;let L=1/0;h=x;do{if(f>=h.x&&h.x>=A&&f!==h.x&&r1(g<P?f:T,g,A,P,g<P?T:f,g,h.x,h.y)){const F=Math.abs(g-h.y)/(f-h.x);fp(h,a)&&(F<L||F===L&&(h.x>x.x||h.x===x.x&&QS(x,h)))&&(x=h,L=F)}h=h.next}while(h!==E);return x})(r,e);if(!i)return e;const s=o1(i,r);return Fu(s,s.next),Fu(i,i.next)}function QS(r,e){return Gn(r.prev,r,e.prev)<0&&Gn(e.next,r,r.next)<0}function qy(r,e,i,s,a){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-i)*a|0)|r<<8))|r<<4))|r<<2))|r<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*a|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function eI(r){let e=r,i=r;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==r);return i}function r1(r,e,i,s,a,u,h,f){return(a-h)*(e-f)>=(r-h)*(u-f)&&(r-h)*(s-f)>=(i-h)*(e-f)&&(i-h)*(u-f)>=(a-h)*(s-f)}function dp(r,e,i,s,a,u,h,f){return!(r===h&&e===f)&&r1(r,e,i,s,a,u,h,f)}function tI(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!(function(i,s){let a=i;do{if(a.i!==i.i&&a.next.i!==i.i&&a.i!==s.i&&a.next.i!==s.i&&n1(a,a.next,i,s))return!0;a=a.next}while(a!==i);return!1})(r,e)&&(fp(r,e)&&fp(e,r)&&(function(i,s){let a=i,u=!1;const h=(i.x+s.x)/2,f=(i.y+s.y)/2;do a.y>f!=a.next.y>f&&a.next.y!==a.y&&h<(a.next.x-a.x)*(f-a.y)/(a.next.y-a.y)+a.x&&(u=!u),a=a.next;while(a!==i);return u})(r,e)&&(Gn(r.prev,r,e.prev)||Gn(r,e.prev,e))||bd(r,e)&&Gn(r.prev,r,r.next)>0&&Gn(e.prev,e,e.next)>0)}function Gn(r,e,i){return(e.y-r.y)*(i.x-e.x)-(e.x-r.x)*(i.y-e.y)}function bd(r,e){return r.x===e.x&&r.y===e.y}function n1(r,e,i,s){const a=M_(Gn(r,e,i)),u=M_(Gn(r,e,s)),h=M_(Gn(i,s,r)),f=M_(Gn(i,s,e));return a!==u&&h!==f||!(a!==0||!C_(r,i,e))||!(u!==0||!C_(r,s,e))||!(h!==0||!C_(i,r,s))||!(f!==0||!C_(i,e,s))}function C_(r,e,i){return e.x<=Math.max(r.x,i.x)&&e.x>=Math.min(r.x,i.x)&&e.y<=Math.max(r.y,i.y)&&e.y>=Math.min(r.y,i.y)}function M_(r){return r>0?1:r<0?-1:0}function fp(r,e){return Gn(r.prev,r,r.next)<0?Gn(r,e,r.next)>=0&&Gn(r,r.prev,e)>=0:Gn(r,e,r.prev)<0||Gn(r,r.next,e)<0}function o1(r,e){const i=Hy(r.i,r.x,r.y),s=Hy(e.i,e.x,e.y),a=r.next,u=e.prev;return r.next=e,e.prev=r,i.next=a,a.prev=i,s.next=i,i.prev=s,u.next=s,s.prev=u,s}function s1(r,e,i,s){const a=Hy(r,e,i);return s?(a.next=s.next,a.prev=s,s.next.prev=a,s.next=a):(a.prev=a,a.next=a),a}function pp(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Hy(r,e,i){return{i:r,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function mp(r,e){const i=r.length;if(i<=1)return[r];const s=[];let a,u;for(let h=0;h<i;h++){const f=mi(r[h]);f!==0&&(r[h].area=Math.abs(f),u===void 0&&(u=f<0),u===f<0?(a&&s.push(a),a=[r[h]]):a.push(r[h]))}if(a&&s.push(a),e>1)for(let h=0;h<s.length;h++)s[h].length<=e||(yh(s[h],e,1,s[h].length-1,iI),s[h]=s[h].slice(0,e));return s}function iI(r,e){return e.area-r.area}function a1(r,e,i=1){if(!r)return null;const s=typeof r=="string"?uo.from(r).getPrimary():r.getPrimary(),a=typeof r=="string"?null:r.getSecondary();for(const u of[s,a]){if(!u)continue;const h=u.id.toString();e.has(h)||e.set(h,[]),u.scaleSelf(i),e.get(h).push(u)}return{primary:s.toString(),secondary:a?a.toString():null}}function Zy(r,e,i,s){const a=s.patternDependencies;let u=!1;for(const h of e){const f=h.paint.get(`${r}-pattern`);f.isConstant()||(u=!0),a1(f.constantOr(null),a,i)&&(u=!0)}return u}function $y(r,e,i,s,a,u){const h=u.patternDependencies;for(const f of e){const g=f.paint.get(`${r}-pattern`).value;if(g.kind!=="constant"){let x=g.evaluate({zoom:s},i,{},u.availableImages);x=x&&x.name?x.name:x;const T=a1(x,h,a);if(!T)continue;const{primary:E,secondary:A}=T;E&&(i.patterns[f.id]=[E,A].filter(Boolean))}}return i}class l1{constructor(){this.polygons=new Map}add(e,...i){const s=this.polygons.get(e);s?s.push(...i):this.polygons.set(e,i)}merge(e){for(const[i,s]of e.polygons)this.add(i,...s)}}class $l{constructor(){this.portals=[]}static isOnBorder(e,i){return e<=0&&i<=0||e>=gt&&i>=gt}static evaluate(e){if(e.length===0)return new $l;let i=[];for(const g of e)i.push(...g.portals);if(i.length===0)return new $l;for(const g of i){const x=g.va,T=g.vb;($l.isOnBorder(x.x,T.x)||$l.isOnBorder(x.y,T.y))&&(g.type="border")}const s=i.filter((g=>g.type!=="unevaluated")),a=i.filter((g=>g.type==="unevaluated"));if(a.length===0)return new $l;a.sort(((g,x)=>g.hash===x.hash?g.isTunnel===x.isTunnel?0:g.isTunnel?-1:1:g.hash<x.hash?1:-1)),i=s.concat(a);let u=s.length,h=u,f=u;do if(h++,h===i.length||i[u].hash!==i[h].hash){if(h-u==2){f<u&&(i[f]=i[u],i[u]=null);const g=i[f],x=i[h-1];g.type=g.isTunnel!==x.isTunnel?"tunnel":"polygon",g.connection={a:g.connection.a,b:x.connection.a},f++}u=h}while(u!==i.length);return i.splice(f),i.sort(((g,x)=>g.hash<x.hash?1:-1)),{portals:i}}}Lt($l,"ElevationPortalGraph"),Lt(l1,"ElevationPolygons");class rI{constructor(e,i,s){this.outPositions=e,this.outNormals=i,this.outIndices=s,this.vertexLookup=new Map}addVertex(e,i,s){let a=e[2];s!=null&&(a*=s);const u=`${e[0]},${e[1]},${e[2]},${i[0]},${i[1]},${i[2]}`,h=this.vertexLookup.get(u);if(h!=null)return h;const f=this.outPositions.length;this.vertexLookup.set(u,f);const g=Math.trunc(16384*i[0]),x=Math.trunc(16384*i[1]),T=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],a),this.outNormals.emplaceBack(g,x,T),f}addTriangle(e,i,s){this.outIndices.emplaceBack(e,i,s)}addTriangles(e,i,s){if(e.length===0)return;const a=s.length===1,u=Pt(),h=Pt();for(let f=0;f<e.length;f+=3){const g=i[e[f+0]],x=i[e[f+1]],T=i[e[f+2]],E=a?s[0]:s[e[f+1]],A=a?s[0]:s[e[f+2]];di(u,g.x,g.y,a?s[0]:s[e[f+0]]);const P=this.addVertex(u,h);di(u,x.x,x.y,E);const L=this.addVertex(u,h);di(u,T.x,T.y,A);const F=this.addVertex(u,h);this.outIndices.emplaceBack(P,L,F)}}addQuad(e,i,s,a,u,h){const f=this.addVertex(e,u,h),g=this.addVertex(i,u,h),x=this.addVertex(s,u,h),T=this.addVertex(a,u,h);this.addTriangle(f,g,x),this.addTriangle(x,T,f)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class $o{constructor(e,i,s,a){this.unevaluatedPortals=new $l,this.portalPolygons=new l1,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new Gf,this.vertexNormals=new qf,this.indexArray=new xn,this.tileToMeters=q(e),this.bridgeProgramConfigurations=new As(i,{zoom:s,lut:a},(u=>u!=="fill-tunnel-structure-color")),this.tunnelProgramConfigurations=new As(i,{zoom:s,lut:a},(u=>u!=="fill-bridge-guard-rail-color"))}addVertices(e,i){const s=this.unevalVertices.length;for(let a=0;a<e.length;a++)this.unevalVertices.push(e[a]),this.unevalHeights.push(i[a]);return s}addTriangles(e,i,s){const a=s?this.unevalTunnelTriangles:this.unevalTriangles;for(const u of e)a.push(u+i)}addRenderableRing(e,i,s,a,u,h){const f=[new st(u.min.x,u.min.y),new st(u.max.x,u.min.y),new st(u.max.x,u.max.y),new st(u.min.x,u.max.y)];for(let g=0;g<s-1;g++){const x=i+g,T=x+1,E=this.unevalVertices[x],A=this.unevalVertices[T];if(!(E.x>=u.min.x&&E.x<=u.max.x&&E.y>=u.min.y&&E.y<=u.max.y||A.x>=u.min.x&&A.x<=u.max.x&&A.y>=u.min.y&&A.y<=u.max.y||Xn(E,A,f))||this.isOnBorder(E.x,A.x)||this.isOnBorder(E.y,A.y))continue;const P=$o.computeEdgeHash(this.unevalVertices[x],this.unevalVertices[T]);let L,F=this.vertexHashLookup.get($o.computePosHash(E));F!=null?L=F.next:(F=this.vertexHashLookup.get($o.computePosHash(A)),L=F!=null?F.prev:P),this.unevalEdges.push({polygonIdx:e,a:x,b:T,hash:P,portalHash:L,isTunnel:a,type:"unevaluated",featureInfo:h})}}addPortalCandidates(e,i,s,a,u){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:u});const h=i[0];this.vertexHashLookup.clear();let f=$o.computeEdgeHash(h[h.length-2],h[h.length-1]);for(let g=0;g<h.length-1;g++){const x=h[g+0],T=h[g+1],E=vo(T.x-x.x,T.y-x.y),A=ys(E);if(A===0)continue;let P="unevaluated";const L=a.pointElevation(x),F=a.pointElevation(T);Math.abs(L)<.01&&Math.abs(F)<.01?P="entrance":(this.isOnBorder(x.x,T.x)||this.isOnBorder(x.y,T.y))&&(P="border");const U=$o.computeEdgeHash(x,T);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:x,vb:T,vab:E,length:A,hash:U,isTunnel:s,type:P});const V=$o.computePosHash(x);this.vertexHashLookup.set(V,{prev:f,next:U}),f=U}}construct(e){if(this.unevalVertices.length===0)return;const i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),s=A=>{A.primitiveLength=this.indexArray.length-A.primitiveOffset},a=new rI(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const u=i(),h=i(),f=i(),g=(A,P)=>{A.sort(((F,U)=>F.type===P&&U.type!==P?-1:F.type!==P&&U.type===P?1:0));const L=A.findIndex((F=>F.type!==P));return L>=0?L:A.length};let x=0;this.unevalEdges.length>0&&(x=g(this.unevalEdges,"none"),this.constructBridgeStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:x},this.tileToMeters)),s(f);const T=i(),E=i();if(this.unevalEdges.length>0){const A=this.unevalEdges.splice(x),P=g(A,"tunnel")+x;this.unevalEdges.push(...A),this.constructTunnelStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:x},{min:x,max:P})}s(T),a.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),s(E),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),s(h),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),s(u),this.maskSegments=Fr.simpleSegment(0,E.primitiveOffset,0,E.primitiveLength),this.depthSegments=Fr.simpleSegment(0,h.primitiveOffset,0,h.primitiveLength),this.renderableBridgeSegments=Fr.simpleSegment(0,f.primitiveOffset,0,f.primitiveLength),this.renderableTunnelSegments=Fr.simpleSegment(0,T.primitiveOffset,0,T.primitiveLength),this.shadowCasterSegments=Fr.simpleSegment(0,u.primitiveOffset,0,u.primitiveLength)}update(e,i,s,a,u,h,f,g){this.bridgeProgramConfigurations.updatePaintArrays(e,i,u,s,a,h,f,g),this.tunnelProgramConfigurations.updatePaintArrays(e,i,u,s,a,h,f,g)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,HS.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,ZS.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,i,s,a,u){const h=(f,g)=>{for(let x=0;x<g.length-1;x++){const T=g[x].featureIndex,E=g[x+1].vertexStart,A=e.feature(T);f.populatePaintArrays(E,A,T,{},s,i,a,void 0,u)}};h(this.bridgeProgramConfigurations,this.bridgeFeatureSections),h(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,i,s,a,u){const h=new Map;for(let f=a;f<u;f++){const g=s[f],x=g.a,T=g.b,E=$o.computePosHash(e[x]),A=$o.computePosHash(e[T]);let P=h.get(E);P||(P={},h.set(E,P));let L=h.get(A);L||(L={},h.set(A,L)),i[x]<=0&&i[T]<=0||(P.to=T,L.from=x)}return h}isTerminalVertex(e,i){const s=$o.computePosHash(this.unevalVertices[e]),a=i.get(s);return!a||!a.from||!a.to}constructBridgeStructures(e,i,s,a,u,h){e.clearVertexLookup();const f=this.computeVertexConnections(i,s,a,u.min,u.max),g=1/h,x=.5*g,T=(at,ct)=>di(at,i[ct].x,i[ct].y,s[ct]*g),E=Pt(),A=Pt(),P=Pt(),L=Pt(),F=Pt(),U=(at,ct)=>{const tt=f.get($o.computePosHash(i[ct])),rt=tt.from,Ze=tt.to;if(!rt||!Ze)return;T(E,rt),T(A,ct),T(P,Ze),Gr(L),Jr(E,A)||(Kr(F,A,E),ui(L,F)),Jr(P,A)||(Kr(F,P,A),Bi(L,L,ui(F,F)));const qe=Vo(L);return qe>0?yr(at,L,1/qe):void 0};let V=Number.POSITIVE_INFINITY;this.sortSubarray(a,u.min,u.max,((at,ct)=>at.featureInfo.featureIndex-ct.featureInfo.featureIndex));const $=Pt(),X=Pt(),Q=Pt(),de=Pt(),ae=Pt(),me=Pt(),xe=Pt(),Ee=Pt(),Ge=Pt(),Me=[Pt(),Pt(),Pt(),Pt()],$e=[Pt(),Pt(),Pt(),Pt()],Ke=[{coord:new st(0,0),height:0},{coord:new st(0,0),height:0}],Qe=(at,ct)=>at>ct;for(let at=u.min;at<u.max;at++){const ct=a[at];if(!ct.featureInfo.guardRailEnabled||!this.prepareEdgePoints(Ke,i,s,ct,Qe))continue;const[tt,rt]=Ke;if(di($,tt.coord.x,tt.coord.y,g*tt.height),di(X,rt.coord.x,rt.coord.y,g*rt.height),Jr($,X))continue;Kr(Q,X,$),ui(Q,Q);const Ze=U(Ee,ct.a)||Q,qe=U(Ge,ct.b)||Q;di(de,Ze[1],-Ze[0],0),ui(de,de),di(ae,qe[1],-qe[0],0),ui(ae,ae),wr(Ee,de,Ze),ui(me,Ee),wr(Ee,ae,qe),ui(xe,Ee),Bi(Me[0],$,yr(Ee,Kr(Ee,de,me),x)),Bi(Me[1],$,yr(Ee,Bi(Ee,de,me),x)),Bi(Me[2],$,yr(Ee,me,x)),Me[3]=$,Bi($e[0],X,yr(Ee,Kr(Ee,ae,xe),x)),Bi($e[1],X,yr(Ee,Bi(Ee,ae,xe),x)),Bi($e[2],X,yr(Ee,xe,x)),$e[3]=X,V=this.addFeatureSection(ct.featureInfo.featureIndex,V,this.bridgeFeatureSections,e);const ot=e.addVertex(Me[0],de,h),yt=e.addVertex(Me[1],de,h),ft=e.addVertex($e[0],ae,h),Nt=e.addVertex($e[1],ae,h);e.addTriangle(ot,yt,ft),e.addTriangle(yt,Nt,ft);const Et=e.addVertex(Me[1],me,h),Ct=e.addVertex(Me[2],me,h),Ot=e.addVertex($e[1],xe,h),Ii=e.addVertex($e[2],xe,h);e.addTriangle(Et,Ct,Ot),e.addTriangle(Ct,Ii,Ot),Ti(de,de),Ti(ae,ae);const pt=e.addVertex(Me[2],de,h),zt=e.addVertex(Me[3],de,h),oi=e.addVertex($e[2],ae,h),Oi=e.addVertex($e[3],ae,h);e.addTriangle(pt,zt,oi),e.addTriangle(zt,Oi,oi);const Ni=this.isTerminalVertex(ct.a,f),pi=this.isTerminalVertex(ct.b,f);tt.height<.01&&Ni&&e.addQuad(Me[3],Me[2],Me[1],Me[0],Ti(Ze,Ze),h),rt.height<.01&&pi&&e.addQuad($e[0],$e[1],$e[2],$e[3],qe,h)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,i,s,a,u,h){e.clearVertexLookup();let f=Number.POSITIVE_INFINITY;const g=(V,$)=>V.featureInfo.featureIndex-$.featureInfo.featureIndex;this.sortSubarray(a,u.min,u.max,g),this.sortSubarray(a,h.min,h.max,g);const x=V=>ui(V,V),T=[{coord:new st(0,0),height:0},{coord:new st(0,0),height:0}],E=(V,$)=>V<$,A=Pt(),P=Pt(),L=Pt(),F=Pt(),U=Pt();for(let V=u.min;V<u.max;V++){if(!this.prepareEdgePoints(T,i,s,a[V],E))continue;const[$,X]=T,Q=x(di(U,-(X.coord.y-$.coord.y),X.coord.x-$.coord.x,0));f=this.addFeatureSection(a[V].featureInfo.featureIndex,f,this.tunnelFeatureSections,e),e.addQuad(di(A,$.coord.x,$.coord.y,$.height),di(P,X.coord.x,X.coord.y,X.height),di(L,X.coord.x,X.coord.y,a[V].isTunnel?-.1:0),di(F,$.coord.x,$.coord.y,a[V].isTunnel?-.1:0),Q)}for(let V=h.min;V<h.max;V++){const $=a[V];$.isTunnel&&([$.a,$.b]=[$.b,$.a]);const X=i[$.a],Q=i[$.b],de=x(di(U,-(Q.y-X.y),Q.x-X.x,0));f=this.addFeatureSection($.featureInfo.featureIndex,f,this.tunnelFeatureSections,e),e.addQuad(di(A,Q.x,Q.y,0),di(P,X.x,X.y,0),di(L,X.x,X.y,s[$.a]+4),di(F,Q.x,Q.y,s[$.b]+4),de),e.addQuad(di(A,X.x,X.y,0),di(P,Q.x,Q.y,0),di(L,Q.x,Q.y,s[$.b]+4),di(F,X.x,X.y,s[$.a]+4),de)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,i,s,a){e.coord.x=i,e.coord.y=s,e.height=a}prepareEdgePoints(e,i,s,a,u){let h=i[a.a].x,f=i[a.a].y,g=i[a.b].x,x=i[a.b].y,T=s[a.a],E=s[a.b];const A=u(T,0),P=u(E,0);if(A&&P)return this.setElevatedPoint(e[0],h,f,T),this.setElevatedPoint(e[1],g,x,E),!0;if(!A&&!P)return!1;if(A){if(!P){const L=E/(E-T);g=ei(g,h,L),x=ei(x,f,L),E=ei(E,T,L)}}else{const L=T/(T-E);h=ei(h,g,L),f=ei(f,x,L),T=ei(T,E,L)}return this.setElevatedPoint(e[0],h,f,T),this.setElevatedPoint(e[1],g,x,E),!0}prepareEdges(e,i){if(i.length===0)return;i.sort(((f,g)=>f.hash===g.hash?g.polygonIdx-f.polygonIdx:g.hash>f.hash?1:-1));let s=0,a=0,u=0,h=i[s].polygonIdx;do a++,(a===i.length||i[s].hash!==i[a].hash)&&((a-s==1||i[a-1].polygonIdx!==h)&&(u<s&&(i[u]=i[s],i[s]=null),i[u].type="none",u++),s=a,s!==i.length&&(h=i[s].polygonIdx));while(s!==i.length);if(i.splice(u),i.length!==0&&e.length!==0){i.sort(((x,T)=>x.portalHash<T.portalHash?1:-1));let f=0,g=0;for(;f!==i.length&&g!==e.length;){const x=i[f],T=e[g];x.portalHash>T.hash?f++:T.hash>x.portalHash?g++:(x.type=T.type,f++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=gt&&i>=gt}addFeatureSection(e,i,s,a){return e!==i&&(i=e,s.push({featureIndex:e,vertexStart:a.getVertexCount()}),a.clearVertexLookup()),i}sortSubarray(e,i,s,a){const u=e.slice(i,s);u.sort(a),e.splice(i,u.length,...u)}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt($o.computePosHash(e))<<32n|BigInt($o.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var c1,u1={exports:{}},h1=(c1||(c1=1,(function(r){function e(le,fe){return le>fe?1:le<fe?-1:0}var i=function(le,fe){le===void 0&&(le=e),fe===void 0&&(fe=!1),this._compare=le,this._root=null,this._size=0,this._noDuplicates=!!fe},s={size:{configurable:!0}};function a(le,fe,We,lt,bt){var wt=bt-lt;if(wt>0){var Vt=lt+Math.floor(wt/2),qt={key:fe[Vt],data:We[Vt],parent:le};return qt.left=a(qt,fe,We,lt,Vt),qt.right=a(qt,fe,We,Vt+1,bt),qt}return null}function u(le,fe,We,lt,bt){if(!(We>=lt)){for(var wt=le[We+lt>>1],Vt=We-1,qt=lt+1;;){do Vt++;while(bt(le[Vt],wt)<0);do qt--;while(bt(le[qt],wt)>0);if(Vt>=qt)break;var hi=le[Vt];le[Vt]=le[qt],le[qt]=hi,hi=fe[Vt],fe[Vt]=fe[qt],fe[qt]=hi}u(le,fe,We,qt,bt),u(le,fe,qt+1,lt,bt)}}i.prototype.rotateLeft=function(le){var fe=le.right;fe&&(le.right=fe.left,fe.left&&(fe.left.parent=le),fe.parent=le.parent),le.parent?le===le.parent.left?le.parent.left=fe:le.parent.right=fe:this._root=fe,fe&&(fe.left=le),le.parent=fe},i.prototype.rotateRight=function(le){var fe=le.left;fe&&(le.left=fe.right,fe.right&&(fe.right.parent=le),fe.parent=le.parent),le.parent?le===le.parent.left?le.parent.left=fe:le.parent.right=fe:this._root=fe,fe&&(fe.right=le),le.parent=fe},i.prototype._splay=function(le){for(;le.parent;){var fe=le.parent;fe.parent?fe.left===le&&fe.parent.left===fe?(this.rotateRight(fe.parent),this.rotateRight(fe)):fe.right===le&&fe.parent.right===fe?(this.rotateLeft(fe.parent),this.rotateLeft(fe)):fe.left===le&&fe.parent.right===fe?(this.rotateRight(fe),this.rotateLeft(fe)):(this.rotateLeft(fe),this.rotateRight(fe)):fe.left===le?this.rotateRight(fe):this.rotateLeft(fe)}},i.prototype.splay=function(le){for(var fe,We,lt,bt,wt;le.parent;)(We=(fe=le.parent).parent)&&We.parent?((lt=We.parent).left===We?lt.left=le:lt.right=le,le.parent=lt):(le.parent=null,this._root=le),bt=le.left,wt=le.right,le===fe.left?(We&&(We.left===fe?(fe.right?(We.left=fe.right,We.left.parent=We):We.left=null,fe.right=We,We.parent=fe):(bt?(We.right=bt,bt.parent=We):We.right=null,le.left=We,We.parent=le)),wt?(fe.left=wt,wt.parent=fe):fe.left=null,le.right=fe,fe.parent=le):(We&&(We.right===fe?(fe.left?(We.right=fe.left,We.right.parent=We):We.right=null,fe.left=We,We.parent=fe):(wt?(We.left=wt,wt.parent=We):We.left=null,le.right=We,We.parent=le)),bt?(fe.right=bt,bt.parent=fe):fe.right=null,le.left=fe,fe.parent=le)},i.prototype.replace=function(le,fe){le.parent?le===le.parent.left?le.parent.left=fe:le.parent.right=fe:this._root=fe,fe&&(fe.parent=le.parent)},i.prototype.minNode=function(le){if(le===void 0&&(le=this._root),le)for(;le.left;)le=le.left;return le},i.prototype.maxNode=function(le){if(le===void 0&&(le=this._root),le)for(;le.right;)le=le.right;return le},i.prototype.insert=function(le,fe){var We=this._root,lt=null,bt=this._compare;if(this._noDuplicates)for(;We;){if(lt=We,bt(We.key,le)===0)return;We=bt(We.key,le)<0?We.right:We.left}else for(;We;)lt=We,We=bt(We.key,le)<0?We.right:We.left;return We={key:le,data:fe,left:null,right:null,parent:lt},lt?bt(lt.key,We.key)<0?lt.right=We:lt.left=We:this._root=We,this.splay(We),this._size++,We},i.prototype.find=function(le){for(var fe=this._root,We=this._compare;fe;){var lt=We(fe.key,le);if(lt<0)fe=fe.right;else{if(!(lt>0))return fe;fe=fe.left}}return null},i.prototype.contains=function(le){for(var fe=this._root,We=this._compare;fe;){var lt=We(le,fe.key);if(lt===0)return!0;fe=lt<0?fe.left:fe.right}return!1},i.prototype.remove=function(le){var fe=this.find(le);if(!fe)return!1;if(this.splay(fe),fe.left)if(fe.right){var We=this.minNode(fe.right);We.parent!==fe&&(this.replace(We,We.right),We.right=fe.right,We.right.parent=We),this.replace(fe,We),We.left=fe.left,We.left.parent=We}else this.replace(fe,fe.left);else this.replace(fe,fe.right);return this._size--,!0},i.prototype.removeNode=function(le){if(!le)return!1;if(this.splay(le),le.left)if(le.right){var fe=this.minNode(le.right);fe.parent!==le&&(this.replace(fe,fe.right),fe.right=le.right,fe.right.parent=fe),this.replace(le,fe),fe.left=le.left,fe.left.parent=fe}else this.replace(le,le.left);else this.replace(le,le.right);return this._size--,!0},i.prototype.erase=function(le){var fe=this.find(le);if(fe){this.splay(fe);var We=fe.left,lt=fe.right,bt=null;We&&(We.parent=null,bt=this.maxNode(We),this.splay(bt),this._root=bt),lt&&(We?bt.right=lt:this._root=lt,lt.parent=bt),this._size--}},i.prototype.pop=function(){var le=this._root,fe=null;if(le){for(;le.left;)le=le.left;fe={key:le.key,data:le.data},this.remove(le.key)}return fe},i.prototype.next=function(le){var fe=le;if(fe)if(fe.right)for(fe=fe.right;fe&&fe.left;)fe=fe.left;else for(fe=le.parent;fe&&fe.right===le;)le=fe,fe=fe.parent;return fe},i.prototype.prev=function(le){var fe=le;if(fe)if(fe.left)for(fe=fe.left;fe&&fe.right;)fe=fe.right;else for(fe=le.parent;fe&&fe.left===le;)le=fe,fe=fe.parent;return fe},i.prototype.forEach=function(le){for(var fe=this._root,We=[],lt=!1,bt=0;!lt;)fe?(We.push(fe),fe=fe.left):We.length>0?(le(fe=We.pop(),bt++),fe=fe.right):lt=!0;return this},i.prototype.range=function(le,fe,We,lt){for(var bt=[],wt=this._compare,Vt=this._root;bt.length!==0||Vt;)if(Vt)bt.push(Vt),Vt=Vt.left;else{if(wt((Vt=bt.pop()).key,fe)>0)break;if(wt(Vt.key,le)>=0&&We.call(lt,Vt))return this;Vt=Vt.right}return this},i.prototype.keys=function(){for(var le=this._root,fe=[],We=[],lt=!1;!lt;)le?(fe.push(le),le=le.left):fe.length>0?(le=fe.pop(),We.push(le.key),le=le.right):lt=!0;return We},i.prototype.values=function(){for(var le=this._root,fe=[],We=[],lt=!1;!lt;)le?(fe.push(le),le=le.left):fe.length>0?(le=fe.pop(),We.push(le.data),le=le.right):lt=!0;return We},i.prototype.at=function(le){for(var fe=this._root,We=[],lt=!1,bt=0;!lt;)if(fe)We.push(fe),fe=fe.left;else if(We.length>0){if(fe=We.pop(),bt===le)return fe;bt++,fe=fe.right}else lt=!0;return null},i.prototype.load=function(le,fe,We){if(le===void 0&&(le=[]),fe===void 0&&(fe=[]),We===void 0&&(We=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var lt=le.length;return We&&u(le,fe,0,lt-1,this._compare),this._root=a(null,le,fe,0,lt),this._size=lt,this},i.prototype.min=function(){var le=this.minNode(this._root);return le?le.key:null},i.prototype.max=function(){var le=this.maxNode(this._root);return le?le.key:null},i.prototype.isEmpty=function(){return this._root===null},s.size.get=function(){return this._size},i.createTree=function(le,fe,We,lt,bt){return new i(We,bt).load(le,fe,lt)},Object.defineProperties(i.prototype,s);var h=0,f=1,g=2,x=3,T=0,E=1,A=2,P=3;function L(le,fe,We){fe===null?(le.inOut=!1,le.otherInOut=!0):(le.isSubject===fe.isSubject?(le.inOut=!fe.inOut,le.otherInOut=fe.otherInOut):(le.inOut=!fe.otherInOut,le.otherInOut=fe.isVertical()?!fe.inOut:fe.inOut),fe&&(le.prevInResult=!F(fe,We)||fe.isVertical()?fe.prevInResult:fe));var lt=F(le,We);le.resultTransition=lt?(function(bt,wt){var Vt,qt=!bt.inOut,hi=!bt.otherInOut;switch(wt){case T:Vt=qt&&hi;break;case E:Vt=qt||hi;break;case P:Vt=qt^hi;break;case A:Vt=bt.isSubject?qt&&!hi:hi&&!qt}return Vt?1:-1})(le,We):0}function F(le,fe){switch(le.type){case h:switch(fe){case T:return!le.otherInOut;case E:return le.otherInOut;case A:return le.isSubject&&le.otherInOut||!le.isSubject&&!le.otherInOut;case P:return!0}break;case g:return fe===T||fe===E;case x:return fe===A;case f:return!1}return!1}var U=function(le,fe,We,lt,bt){this.left=fe,this.point=le,this.otherEvent=We,this.isSubject=lt,this.type=bt||h,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},V={inResult:{configurable:!0}};function $(le,fe){return le[0]===fe[0]&&le[1]===fe[1]}U.prototype.isBelow=function(le){var fe=this.point,We=this.otherEvent.point;return this.left?(fe[0]-le[0])*(We[1]-le[1])-(We[0]-le[0])*(fe[1]-le[1])>0:(We[0]-le[0])*(fe[1]-le[1])-(fe[0]-le[0])*(We[1]-le[1])>0},U.prototype.isAbove=function(le){return!this.isBelow(le)},U.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},V.inResult.get=function(){return this.resultTransition!==0},U.prototype.clone=function(){var le=new U(this.point,this.left,this.otherEvent,this.isSubject,this.type);return le.contourId=this.contourId,le.resultTransition=this.resultTransition,le.prevInResult=this.prevInResult,le.isExteriorRing=this.isExteriorRing,le.inOut=this.inOut,le.otherInOut=this.otherInOut,le},Object.defineProperties(U.prototype,V);var X=11102230246251565e-32,Q=134217729,de=(3+8*X)*X;function ae(le,fe,We,lt,bt){var wt,Vt,qt,hi,bi=fe[0],Ei=lt[0],Mi=0,Qt=0;Ei>bi==Ei>-bi?(wt=bi,bi=fe[++Mi]):(wt=Ei,Ei=lt[++Qt]);var ni=0;if(Mi<le&&Qt<We)for(Ei>bi==Ei>-bi?(qt=wt-((Vt=bi+wt)-bi),bi=fe[++Mi]):(qt=wt-((Vt=Ei+wt)-Ei),Ei=lt[++Qt]),wt=Vt,qt!==0&&(bt[ni++]=qt);Mi<le&&Qt<We;)Ei>bi==Ei>-bi?(qt=wt-((Vt=wt+bi)-(hi=Vt-wt))+(bi-hi),bi=fe[++Mi]):(qt=wt-((Vt=wt+Ei)-(hi=Vt-wt))+(Ei-hi),Ei=lt[++Qt]),wt=Vt,qt!==0&&(bt[ni++]=qt);for(;Mi<le;)qt=wt-((Vt=wt+bi)-(hi=Vt-wt))+(bi-hi),bi=fe[++Mi],wt=Vt,qt!==0&&(bt[ni++]=qt);for(;Qt<We;)qt=wt-((Vt=wt+Ei)-(hi=Vt-wt))+(Ei-hi),Ei=lt[++Qt],wt=Vt,qt!==0&&(bt[ni++]=qt);return wt===0&&ni!==0||(bt[ni++]=wt),ni}function me(le){return new Float64Array(le)}var xe=33306690738754716e-32,Ee=22204460492503146e-32,Ge=11093356479670487e-47,Me=me(4),$e=me(8),Ke=me(12),Qe=me(16),at=me(4);function ct(le,fe,We){var lt=(function(bt,wt,Vt,qt,hi,bi){var Ei=(wt-bi)*(Vt-hi),Mi=(bt-hi)*(qt-bi),Qt=Ei-Mi;if(Ei===0||Mi===0||Ei>0!=Mi>0)return Qt;var ni=Math.abs(Ei+Mi);return Math.abs(Qt)>=xe*ni?Qt:-(function(Hi,Ki,Qi,ur,br,mr,tr){var sr,wi,Fi,zr,Jt,Pi,_r,Er,Cr,cn,Sr,Kt,Vr,hr,Dr,Tn,kn,mn,_n=Hi-br,Pn=Qi-br,Io=Ki-mr,Ir=ur-mr;Me[0]=(Dr=(Er=_n-(_r=(Pi=Q*_n)-(Pi-_n)))*(cn=Ir-(Cr=(Pi=Q*Ir)-(Pi-Ir)))-((hr=_n*Ir)-_r*Cr-Er*Cr-_r*cn))-((Sr=Dr-(kn=(Er=Io-(_r=(Pi=Q*Io)-(Pi-Io)))*(cn=Pn-(Cr=(Pi=Q*Pn)-(Pi-Pn)))-((Tn=Io*Pn)-_r*Cr-Er*Cr-_r*cn)))+(Jt=Dr-Sr))+(Jt-kn),Me[1]=(Vr=hr-((Kt=hr+Sr)-(Jt=Kt-hr))+(Sr-Jt))-((Sr=Vr-Tn)+(Jt=Vr-Sr))+(Jt-Tn),Me[2]=Kt-((mn=Kt+Sr)-(Jt=mn-Kt))+(Sr-Jt),Me[3]=mn;var an=(function(hl,Yn){for(var _o=Yn[0],Xo=1;Xo<4;Xo++)_o+=Yn[Xo];return _o})(0,Me),un=Ee*tr;if(an>=un||-an>=un||(sr=Hi-(_n+(Jt=Hi-_n))+(Jt-br),Fi=Qi-(Pn+(Jt=Qi-Pn))+(Jt-br),wi=Ki-(Io+(Jt=Ki-Io))+(Jt-mr),zr=ur-(Ir+(Jt=ur-Ir))+(Jt-mr),sr===0&&wi===0&&Fi===0&&zr===0)||(un=Ge*tr+de*Math.abs(an),(an+=_n*zr+Ir*sr-(Io*Fi+Pn*wi))>=un||-an>=un))return an;at[0]=(Dr=(Er=sr-(_r=(Pi=Q*sr)-(Pi-sr)))*(cn=Ir-(Cr=(Pi=Q*Ir)-(Pi-Ir)))-((hr=sr*Ir)-_r*Cr-Er*Cr-_r*cn))-((Sr=Dr-(kn=(Er=wi-(_r=(Pi=Q*wi)-(Pi-wi)))*(cn=Pn-(Cr=(Pi=Q*Pn)-(Pi-Pn)))-((Tn=wi*Pn)-_r*Cr-Er*Cr-_r*cn)))+(Jt=Dr-Sr))+(Jt-kn),at[1]=(Vr=hr-((Kt=hr+Sr)-(Jt=Kt-hr))+(Sr-Jt))-((Sr=Vr-Tn)+(Jt=Vr-Sr))+(Jt-Tn),at[2]=Kt-((mn=Kt+Sr)-(Jt=mn-Kt))+(Sr-Jt),at[3]=mn;var Ro=ae(4,Me,4,at,$e);at[0]=(Dr=(Er=_n-(_r=(Pi=Q*_n)-(Pi-_n)))*(cn=zr-(Cr=(Pi=Q*zr)-(Pi-zr)))-((hr=_n*zr)-_r*Cr-Er*Cr-_r*cn))-((Sr=Dr-(kn=(Er=Io-(_r=(Pi=Q*Io)-(Pi-Io)))*(cn=Fi-(Cr=(Pi=Q*Fi)-(Pi-Fi)))-((Tn=Io*Fi)-_r*Cr-Er*Cr-_r*cn)))+(Jt=Dr-Sr))+(Jt-kn),at[1]=(Vr=hr-((Kt=hr+Sr)-(Jt=Kt-hr))+(Sr-Jt))-((Sr=Vr-Tn)+(Jt=Vr-Sr))+(Jt-Tn),at[2]=Kt-((mn=Kt+Sr)-(Jt=mn-Kt))+(Sr-Jt),at[3]=mn;var En=ae(Ro,$e,4,at,Ke);at[0]=(Dr=(Er=sr-(_r=(Pi=Q*sr)-(Pi-sr)))*(cn=zr-(Cr=(Pi=Q*zr)-(Pi-zr)))-((hr=sr*zr)-_r*Cr-Er*Cr-_r*cn))-((Sr=Dr-(kn=(Er=wi-(_r=(Pi=Q*wi)-(Pi-wi)))*(cn=Fi-(Cr=(Pi=Q*Fi)-(Pi-Fi)))-((Tn=wi*Fi)-_r*Cr-Er*Cr-_r*cn)))+(Jt=Dr-Sr))+(Jt-kn),at[1]=(Vr=hr-((Kt=hr+Sr)-(Jt=Kt-hr))+(Sr-Jt))-((Sr=Vr-Tn)+(Jt=Vr-Sr))+(Jt-Tn),at[2]=Kt-((mn=Kt+Sr)-(Jt=mn-Kt))+(Sr-Jt),at[3]=mn;var ia=ae(En,Ke,4,at,Qe);return Qe[ia-1]})(bt,wt,Vt,qt,hi,bi,ni)})(le[0],le[1],fe[0],fe[1],We[0],We[1]);return lt>0?-1:lt<0?1:0}function tt(le,fe){var We=le.point,lt=fe.point;return We[0]>lt[0]?1:We[0]<lt[0]?-1:We[1]!==lt[1]?We[1]>lt[1]?1:-1:(function(bt,wt,Vt,qt){return bt.left!==wt.left?bt.left?1:-1:ct(Vt,bt.otherEvent.point,wt.otherEvent.point)!==0?bt.isBelow(wt.otherEvent.point)?-1:1:!bt.isSubject&&wt.isSubject?1:-1})(le,fe,We)}function rt(le,fe,We){var lt=new U(fe,!1,le,le.isSubject),bt=new U(fe,!0,le.otherEvent,le.isSubject);return $(le.point,le.otherEvent.point)&&console.warn("what is that, a collapsed segment?",le),lt.contourId=bt.contourId=le.contourId,tt(bt,le.otherEvent)>0&&(le.otherEvent.left=!0,bt.left=!1),le.otherEvent.otherEvent=bt,le.otherEvent=lt,We.push(bt),We.push(lt),We}function Ze(le,fe){return le[0]*fe[1]-le[1]*fe[0]}function qe(le,fe){return le[0]*fe[0]+le[1]*fe[1]}function ot(le,fe,We){var lt=(function(hi,bi,Ei,Mi,Qt){var ni=[bi[0]-hi[0],bi[1]-hi[1]],Hi=[Mi[0]-Ei[0],Mi[1]-Ei[1]];function Ki(Pi,_r,Er){return[Pi[0]+_r*Er[0],Pi[1]+_r*Er[1]]}var Qi=[Ei[0]-hi[0],Ei[1]-hi[1]],ur=Ze(ni,Hi),br=ur*ur,mr=qe(ni,ni);if(br>0){var tr=Ze(Qi,Hi)/ur;if(tr<0||tr>1)return null;var sr=Ze(Qi,ni)/ur;return sr<0||sr>1?null:tr===0||tr===1?[Ki(hi,tr,ni)]:sr===0||sr===1?[Ki(Ei,sr,Hi)]:[Ki(hi,tr,ni)]}if((br=(ur=Ze(Qi,ni))*ur)>0)return null;var wi=qe(ni,Qi)/mr,Fi=wi+qe(ni,Hi)/mr,zr=Math.min(wi,Fi),Jt=Math.max(wi,Fi);return zr<=1&&Jt>=0?zr===1?[Ki(hi,zr>0?zr:0,ni)]:Jt===0?[Ki(hi,Jt<1?Jt:1,ni)]:[Ki(hi,zr>0?zr:0,ni),Ki(hi,Jt<1?Jt:1,ni)]:null})(le.point,le.otherEvent.point,fe.point,fe.otherEvent.point),bt=lt?lt.length:0;if(bt===0||bt===1&&($(le.point,fe.point)||$(le.otherEvent.point,fe.otherEvent.point))||bt===2&&le.isSubject===fe.isSubject)return 0;if(bt===1)return $(le.point,lt[0])||$(le.otherEvent.point,lt[0])||rt(le,lt[0],We),$(fe.point,lt[0])||$(fe.otherEvent.point,lt[0])||rt(fe,lt[0],We),1;var wt=[],Vt=!1,qt=!1;return $(le.point,fe.point)?Vt=!0:tt(le,fe)===1?wt.push(fe,le):wt.push(le,fe),$(le.otherEvent.point,fe.otherEvent.point)?qt=!0:tt(le.otherEvent,fe.otherEvent)===1?wt.push(fe.otherEvent,le.otherEvent):wt.push(le.otherEvent,fe.otherEvent),Vt&&qt||Vt?(fe.type=f,le.type=fe.inOut===le.inOut?g:x,Vt&&!qt&&rt(wt[1].otherEvent,wt[0].point,We),2):qt?(rt(wt[0],wt[1].point,We),3):wt[0]!==wt[3].otherEvent?(rt(wt[0],wt[1].point,We),rt(wt[1],wt[2].point,We),3):(rt(wt[0],wt[1].point,We),rt(wt[3].otherEvent,wt[2].point,We),3)}function yt(le,fe){if(le===fe)return 0;if(ct(le.point,le.otherEvent.point,fe.point)!==0||ct(le.point,le.otherEvent.point,fe.otherEvent.point)!==0)return $(le.point,fe.point)?le.isBelow(fe.otherEvent.point)?-1:1:le.point[0]===fe.point[0]?le.point[1]<fe.point[1]?-1:1:tt(le,fe)===1?fe.isAbove(le.point)?-1:1:le.isBelow(fe.point)?-1:1;if(le.isSubject!==fe.isSubject)return le.isSubject?-1:1;var We=le.point,lt=fe.point;return We[0]===lt[0]&&We[1]===lt[1]?(We=le.otherEvent.point)[0]===(lt=fe.otherEvent.point)[0]&&We[1]===lt[1]?0:le.contourId>fe.contourId?1:-1:tt(le,fe)===1?1:-1}var ft=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function Nt(le,fe,We,lt){var bt,wt=le+1,Vt=fe[le].point,qt=fe.length;for(wt<qt&&(bt=fe[wt].point);wt<qt&&bt[0]===Vt[0]&&bt[1]===Vt[1];){if(!We[wt])return wt;++wt<qt&&(bt=fe[wt].point)}for(wt=le-1;We[wt]&&wt>lt;)wt--;return wt}ft.prototype.isExterior=function(){return this.holeOf==null};var Et=Ot,Ct=Ot;function Ot(le,fe){if(!(this instanceof Ot))return new Ot(le,fe);if(this.data=le||[],this.length=this.data.length,this.compare=fe||Ii,this.length>0)for(var We=(this.length>>1)-1;We>=0;We--)this._down(We)}function Ii(le,fe){return le<fe?-1:le>fe?1:0}Ot.prototype={push:function(le){this.data.push(le),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var le=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),le}},peek:function(){return this.data[0]},_up:function(le){for(var fe=this.data,We=this.compare,lt=fe[le];le>0;){var bt=le-1>>1,wt=fe[bt];if(We(lt,wt)>=0)break;fe[le]=wt,le=bt}fe[le]=lt},_down:function(le){for(var fe=this.data,We=this.compare,lt=this.length>>1,bt=fe[le];le<lt;){var wt=1+(le<<1),Vt=wt+1,qt=fe[wt];if(Vt<this.length&&We(fe[Vt],qt)<0&&(wt=Vt,qt=fe[Vt]),We(qt,bt)>=0)break;fe[le]=qt,le=wt}fe[le]=bt}},Et.default=Ct;var pt=Math.max,zt=Math.min,oi=0;function Oi(le,fe,We,lt,bt,wt){var Vt,qt,hi,bi,Ei,Mi;for(Vt=0,qt=le.length-1;Vt<qt;Vt++)if(bi=le[Vt+1],Ei=new U(hi=le[Vt],!1,void 0,fe),Mi=new U(bi,!1,Ei,fe),Ei.otherEvent=Mi,hi[0]!==bi[0]||hi[1]!==bi[1]){Ei.contourId=Mi.contourId=We,wt||(Ei.isExteriorRing=!1,Mi.isExteriorRing=!1),tt(Ei,Mi)>0?Mi.left=!0:Ei.left=!0;var Qt=hi[0],ni=hi[1];bt[0]=zt(bt[0],Qt),bt[1]=zt(bt[1],ni),bt[2]=pt(bt[2],Qt),bt[3]=pt(bt[3],ni),lt.push(Ei),lt.push(Mi)}}var Ni=[];function pi(le,fe,We){typeof le[0][0][0]=="number"&&(le=[le]),typeof fe[0][0][0]=="number"&&(fe=[fe]);var lt=(function(ni,Hi,Ki){var Qi=null;return ni.length*Hi.length==0&&(Ki===T?Qi=Ni:Ki===A?Qi=ni:Ki!==E&&Ki!==P||(Qi=ni.length===0?Hi:ni)),Qi})(le,fe,We);if(lt)return lt===Ni?null:lt;var bt=[1/0,1/0,-1/0,-1/0],wt=[1/0,1/0,-1/0,-1/0],Vt=(function(ni,Hi,Ki,Qi,ur){var br,mr,tr,sr,wi,Fi,zr=new Et(null,tt);for(tr=0,sr=ni.length;tr<sr;tr++)for(wi=0,Fi=(br=ni[tr]).length;wi<Fi;wi++)(mr=wi===0)&&oi++,Oi(br[wi],!0,oi,zr,Ki,mr);for(tr=0,sr=Hi.length;tr<sr;tr++)for(wi=0,Fi=(br=Hi[tr]).length;wi<Fi;wi++)mr=wi===0,ur===A&&(mr=!1),mr&&oi++,Oi(br[wi],!1,oi,zr,Qi,mr);return zr})(le,fe,bt,wt,We);if(lt=(function(ni,Hi,Ki,Qi,ur){var br=null;return(Ki[0]>Qi[2]||Qi[0]>Ki[2]||Ki[1]>Qi[3]||Qi[1]>Ki[3])&&(ur===T?br=Ni:ur===A?br=ni:ur!==E&&ur!==P||(br=ni.concat(Hi))),br})(le,fe,bt,wt,We))return lt===Ni?null:lt;for(var qt=(function(ni){var Hi,Ki,Qi=(function(tr){var sr,wi,Fi,zr,Jt=[];for(wi=0,Fi=tr.length;wi<Fi;wi++)((sr=tr[wi]).left&&sr.inResult||!sr.left&&sr.otherEvent.inResult)&&Jt.push(sr);for(var Pi=!1;!Pi;)for(Pi=!0,wi=0,Fi=Jt.length;wi<Fi;wi++)wi+1<Fi&&tt(Jt[wi],Jt[wi+1])===1&&(zr=Jt[wi],Jt[wi]=Jt[wi+1],Jt[wi+1]=zr,Pi=!1);for(wi=0,Fi=Jt.length;wi<Fi;wi++)(sr=Jt[wi]).otherPos=wi;for(wi=0,Fi=Jt.length;wi<Fi;wi++)(sr=Jt[wi]).left||(zr=sr.otherPos,sr.otherPos=sr.otherEvent.otherPos,sr.otherEvent.otherPos=zr);return Jt})(ni),ur={},br=[],mr=function(){if(!ur[Hi]){var tr=br.length,sr=(function(Jt,Pi,_r){var Er=new ft;if(Jt.prevInResult!=null){var Cr=Jt.prevInResult,cn=Cr.outputContourId;if(Cr.resultTransition>0){var Sr=Pi[cn];if(Sr.holeOf!=null){var Kt=Sr.holeOf;Pi[Kt].holeIds.push(_r),Er.holeOf=Kt,Er.depth=Pi[cn].depth}else Pi[cn].holeIds.push(_r),Er.holeOf=cn,Er.depth=Pi[cn].depth+1}else Er.holeOf=null,Er.depth=Pi[cn].depth}else Er.holeOf=null,Er.depth=0;return Er})(Qi[Hi],br,tr),wi=function(Jt){ur[Jt]=!0,Jt<Qi.length&&Qi[Jt]&&(Qi[Jt].outputContourId=tr)},Fi=Hi,zr=Hi;for(sr.points.push(Qi[Hi].point);wi(Fi),wi(Fi=Qi[Fi].otherPos),sr.points.push(Qi[Fi].point),!((Fi=Nt(Fi,Qi,ur,zr))==zr||Fi>=Qi.length)&&Qi[Fi];);br.push(sr)}};for(Hi=0,Ki=Qi.length;Hi<Ki;Hi++)mr();return br})((function(ni,Hi,Ki,Qi,ur,br){for(var mr,tr,sr,wi=new i(yt),Fi=[],zr=Math.min(Qi[2],ur[2]);ni.length!==0;){var Jt=ni.pop();if(Fi.push(Jt),br===T&&Jt.point[0]>zr||br===A&&Jt.point[0]>Qi[2])break;if(Jt.left){tr=mr=wi.insert(Jt),mr=mr!==(sr=wi.minNode())?wi.prev(mr):null,tr=wi.next(tr);var Pi=mr?mr.key:null;if(L(Jt,Pi,br),tr&&ot(Jt,tr.key,ni)===2&&(L(Jt,Pi,br),L(tr.key,Jt,br)),mr&&ot(mr.key,Jt,ni)===2){var _r=mr;L(Pi,(_r=_r!==sr?wi.prev(_r):null)?_r.key:null,br),L(Jt,Pi,br)}}else tr=mr=wi.find(Jt=Jt.otherEvent),mr&&tr&&(mr=mr!==sr?wi.prev(mr):null,tr=wi.next(tr),wi.remove(Jt),tr&&mr&&ot(mr.key,tr.key,ni))}return Fi})(Vt,0,0,bt,wt,We)),hi=[],bi=0;bi<qt.length;bi++){var Ei=qt[bi];if(Ei.isExterior()){for(var Mi=[Ei.points],Qt=0;Qt<Ei.holeIds.length;Qt++)Mi.push(qt[Ei.holeIds[Qt]].points);hi.push(Mi)}}return hi}var pr={UNION:E,DIFFERENCE:A,INTERSECTION:T,XOR:P};r.diff=function(le,fe){return pi(le,fe,A)},r.intersection=function(le,fe){return pi(le,fe,T)},r.operations=pr,r.union=function(le,fe){return pi(le,fe,E)},r.xor=function(le,fe){return pi(le,fe,P)},Object.defineProperty(r,"__esModule",{value:!0})})(u1.exports)),u1.exports);function P_(r,e,i,s){const a=[],u=s===0?(h,f,g,x,T,E)=>{h.push(new st(E,g+(E-f)/(x-f)*(T-g)))}:(h,f,g,x,T,E)=>{h.push(new st(f+(E-g)/(T-g)*(x-f),E))};for(const h of r){const f=[];for(const g of h){if(g.length<=2)continue;const x=[];for(let A=0;A<g.length-1;A++){const P=g[A].x,L=g[A].y,F=g[A+1].x,U=g[A+1].y,V=s===0?P:L,$=s===0?F:U;V<e?$>e&&u(x,P,L,F,U,e):V>i?$<i&&u(x,P,L,F,U,i):x.push(g[A]),$<e&&V>=e&&u(x,P,L,F,U,e),$>i&&V<=i&&u(x,P,L,F,U,i)}let T=g[g.length-1];const E=s===0?T.x:T.y;E>=e&&E<=i&&x.push(T),x.length&&(T=x[x.length-1],x[0].x===T.x&&x[0].y===T.y||x.push(x[0]),f.push(x))}f.length&&a.push(f)}return a}function nI(r,e){const i=Wy(r),s=Wy([e]),a=h1.intersection(i,s);return a==null?[]:d1(a)}function oI(r,e){let s=Wy(r,65536);const a=[];for(;e.valid();e.next()){const[u,h]=e.get(),f=u.x*65536,g=u.y*65536,x=h.x*65536,T=h.y*65536,E=x-f,A=T-g,P=Math.hypot(E,A);if(P===0)continue;const L=Math.trunc(A/P*3),F=-Math.trunc(E/P*3);a.push([[[f,g],[x,T],[x+L,T+F],[f+L,g+F],[f,g]]])}return a.length>0&&(s=h1.diff(s,a)),d1(s,1/65536)}function Wy(r,e=1){return[r.map((i=>i.map((s=>[s.x*e,s.y*e]))))]}function d1(r,e=1){return r.map((i=>i.map(((s,a)=>{const u=s.map((h=>new st(h[0]*e,h[1]*e).round()));return a>0&&u.reverse(),u}))))}class Xy{constructor(e,i){this.layoutVertexArray=new nl,this.indexArray=new xn,this.lineIndexArray=new Ho,this.triangleSegments=new Fr,this.lineSegments=new Fr,this.programConfigurations=new As(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new ba)}update(e,i,s,a,u,h,f,g){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,g)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,GS.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,qS.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,s,a,u,h,f){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,s,a,u,h,void 0,f)}}class Yy{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new Xy(e,!1),this.elevationBufferData=new Xy(e,!0),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,s,a){}populate(e,i,s,a){this.hasPattern=Zy("fill",this.layers,this.pixelRatio,i);const u=this.layers[0].layout.get("fill-sort-key"),h=[];for(const{feature:f,id:g,index:x,sourceLayerIndex:T}of e){const E=this.layers[0]._featureFilter.needGeometry,A=Ce(f,E);if(!this.layers[0]._featureFilter.filter(new Ar(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),A,s))continue;const P=u?u.evaluate(A,{},s,i.availableImages):void 0,L={id:g,properties:f.properties,type:f.type,sourceLayerIndex:T,index:x,geometry:E?A.geometry:ye(f,s,a),patterns:{},sortKey:P};h.push(L)}u&&h.sort(((f,g)=>f.sortKey-g.sortKey));for(const f of h){const{geometry:g,index:x,sourceLayerIndex:T}=f;if(this.hasPattern){const E=$y("fill",this.layers,f,this.zoom,this.pixelRatio,i);this.patternFeatures.push(E)}else this.addFeature(f,g,x,s,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[x].feature,g,x,T,this.index)}}update(e,i,s,a,u,h,f){this.bufferData.update(e,i,s,a,u,h,f,this.worldview),this.elevationBufferData.update(e,i,s,a,u,h,f,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,i,s,a,u,h,f,this.worldview)}addFeatures(e,i,s,a,u,h){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,i,s,a,h,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,s,a,u,h=[],f,g){const x=mp(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,x,a,s,g):this.addGeometry(x,this.bufferData),this.bufferData.populatePaintArrays(e,s,u,h,a,f,this.worldview),this.elevationBufferData.populatePaintArrays(e,s,u,h,a,f,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,i,s,a,u){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(i,s,a,u,this.worldview))}addElevatedRoadFeature(e,i,s,a,u){const h=new Array,f=nr.getElevationFeature(e,u);if(!f)return void this.addGeometry(i,this.bufferData);{const x=this.clipPolygonsToTile(i,1);x.length>0&&h.push({polygons:x,elevationFeature:f,elevationTileID:s})}const g={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},s),featureIndex:a};for(const x of h)if(x.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new $o(x.elevationTileID,this.layers,this.zoom,this.lut));const E=x.elevationFeature.isTunnel();let A=0;e.properties.hasOwnProperty(Be)&&(A=+e.properties[Be]);for(const P of x.polygons)this.elevatedStructures.addPortalCandidates(x.elevationFeature.id,P,E,x.elevationFeature,A)}x.elevationFeature.constantHeight==null&&(x.polygons=this.prepareElevatedPolygons(x.polygons,x.elevationFeature,x.elevationTileID));const T=new fr(s,x.elevationTileID);this.addElevatedGeometry(x.polygons,T,x.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,a,g)}}addElevatedGeometry(e,i,s,a,u,h){const f={elevation:s,elevationSampler:i,bias:a,index:u,featureInfo:h},[g,x]=this.addGeometry(e,this.elevationBufferData,f);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:g,max:x}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,g),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,x))}addGeometry(e,i,s){let a=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,h=null;s&&(h=s.elevationSampler.constantElevation(s.elevation,s.bias),h!=null&&(a=h,u=h));const f=(g,x,T)=>{if(s!=null)if(x.push(g),h!=null)i.elevatedLayoutVertexArray.emplaceBack(h),T.push(h);else{const E=s.elevationSampler.pointElevation(g,s.elevation,s.bias);i.elevatedLayoutVertexArray.emplaceBack(E),T.push(E),a=Math.min(a,E),u=Math.max(u,E)}};for(const g of e){let x=0;for(const X of g)x+=X.length;const T=i.triangleSegments.prepareSegment(x,i.layoutVertexArray,i.indexArray),E=T.vertexLength,A=[],P=[],L=[],F=[],U=[],V=i.layoutVertexArray.length;for(const X of g){if(X.length===0)continue;X!==g[0]&&P.push(A.length/2);const Q=i.lineSegments.prepareSegment(X.length,i.layoutVertexArray,i.lineIndexArray),de=Q.vertexLength;s&&U.push(i.layoutVertexArray.length-V),f(X[0],L,F),i.layoutVertexArray.emplaceBack(X[0].x,X[0].y),i.lineIndexArray.emplaceBack(de+X.length-1,de),A.push(X[0].x),A.push(X[0].y);for(let ae=1;ae<X.length;ae++)f(X[ae],L,F),i.layoutVertexArray.emplaceBack(X[ae].x,X[ae].y),i.lineIndexArray.emplaceBack(de+ae-1,de+ae),A.push(X[ae].x),A.push(X[ae].y);Q.vertexLength+=X.length,Q.primitiveLength+=X.length}const $=xd(A,P);for(let X=0;X<$.length;X+=3)i.indexArray.emplaceBack(E+$[X],E+$[X+1],E+$[X+2]);if($.length>0&&s&&this.elevationMode==="hd-road-base"){const X=s.elevation.isTunnel(),Q=s.elevation.safeArea,de=this.elevatedStructures.addVertices(L,F);this.elevatedStructures.addTriangles($,de,X);const ae=U.length;if(ae>0){for(let me=0;me<ae-1;me++)this.elevatedStructures.addRenderableRing(s.index,U[me]+de,U[me+1]-U[me],X,Q,s.featureInfo);this.elevatedStructures.addRenderableRing(s.index,U[ae-1]+de,L.length-U[ae-1],X,Q,s.featureInfo)}}T.vertexLength+=x,T.primitiveLength+=$.length/3}return[a,u]}prepareElevatedPolygons(e,i,s){const a=1/q(s),u=[];for(const h of e){const f=oI(h,new Ji(i,a));u.push(...f)}return u}clipPolygonsToTile(e,i){const s=-i,a=-i,u=gt+i,h=gt+i;let f=0;const g=[],x=[];for(;f<e.length;f++){const A=e[f],P=ma(A);(P.min.x>=s&&P.max.x<=u&&P.min.y>=a&&P.max.y<=h?g:x).push(A)}if(g.length===e.length)return e;const T=[new st(s,a),new st(u,a),new st(u,h),new st(s,h),new st(s,a)],E=g;for(const A of x)E.push(...nI(A,T));return E}}let f1,p1,m1,_1;Lt(Yy,"FillBucket",{omit:["layers","patternFeatures"]}),Lt(Xy,"FillBufferData"),Lt($o,"ElevatedStructures");class L_{constructor(e,i,s,a){if(this.triangleCount=i.length/3,this.min=new st(0,0),this.max=new st(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[u,h]=[e[0].clone(),e[0].clone()];for(let E=1;E<e.length;++E){const A=e[E];u.x=Math.min(u.x,A.x),u.y=Math.min(u.y,A.y),h.x=Math.max(h.x,A.x),h.y=Math.max(h.y,A.y)}if(a){const E=Math.ceil(Math.max(h.x-u.x,h.y-u.y)/a);s=Math.max(s,E)}if(s===0)return;this.min=u,this.max=h;const f=this.max.sub(this.min);f.x=Math.max(f.x,1),f.y=Math.max(f.y,1);const g=Math.max(f.x,f.y)/s;this.cellsX=Math.max(1,Math.ceil(f.x/g)),this.cellsY=Math.max(1,Math.ceil(f.y/g)),this.xScale=1/g,this.yScale=1/g;const x=[];for(let E=0;E<this.triangleCount;E++){const A=e[i[3*E+0]].sub(this.min),P=e[i[3*E+1]].sub(this.min),L=e[i[3*E+2]].sub(this.min),F=cl(Math.floor(Math.min(A.x,P.x,L.x)),this.xScale,this.cellsX),U=cl(Math.floor(Math.max(A.x,P.x,L.x)),this.xScale,this.cellsX),V=cl(Math.floor(Math.min(A.y,P.y,L.y)),this.yScale,this.cellsY),$=cl(Math.floor(Math.max(A.y,P.y,L.y)),this.yScale,this.cellsY),X=new st(0,0),Q=new st(0,0),de=new st(0,0),ae=new st(0,0);for(let me=V;me<=$;++me){X.y=Q.y=me*g,de.y=ae.y=(me+1)*g;for(let xe=F;xe<=U;++xe)X.x=de.x=xe*g,Q.x=ae.x=(xe+1)*g,(to(A,P,L,X,Q,ae)||to(A,P,L,X,ae,de))&&x.push({cellIdx:me*this.cellsX+xe,triIdx:E})}}if(x.length===0)return;x.sort(((E,A)=>E.cellIdx-A.cellIdx||E.triIdx-A.triIdx));let T=0;for(;T<x.length;){const E=x[T].cellIdx,A={start:this.payload.length,len:0};for(;T<x.length&&x[T].cellIdx===E;)++A.len,this.payload.push(x[T++].triIdx);this.cells[E]=A}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const s=cl(e.x-this.min.x,this.xScale,this.cellsX),a=cl(e.y-this.min.y,this.yScale,this.cellsY),u=this.cells[a*this.cellsX+s];if(u){this._lazyInitLookup();for(let h=0;h<u.len;h++){const f=this.payload[u.start+h],g=Math.floor(f/8),x=1<<f%8;if(!(this.lookup[g]&x)&&(this.lookup[g]|=x,i.push(f),i.length===this.triangleCount))return}}}query(e,i,s){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const a=cl(e.x-this.min.x,this.xScale,this.cellsX),u=cl(i.x-this.min.x,this.xScale,this.cellsX),h=cl(e.y-this.min.y,this.yScale,this.cellsY),f=cl(i.y-this.min.y,this.yScale,this.cellsY);for(let g=h;g<=f;g++)for(let x=a;x<=u;x++){const T=this.cells[g*this.cellsX+x];if(T)for(let E=0;E<T.len;E++){const A=this.payload[T.start+E],P=Math.floor(A/8),L=1<<A%8;if(!(this.lookup[P]&L)&&(this.lookup[P]|=L,s.push(A),s.length===this.triangleCount))return}}}}function cl(r,e,i){return Math.max(0,Math.min(i-1,Math.floor(r*e)))}Lt(L_,"TriangleGridIndex");class g1{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.footprints=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){for(const s of this.footprints)i.push({footprint:s,id:e})}updateAppearances(e,i,s,a){}populate(e,i,s,a){const u=[];for(const{feature:h,id:f,index:g,sourceLayerIndex:x}of e){const T=this.layers[0]._featureFilter.needGeometry,E=Ce(h,T);if(!this.layers[0]._featureFilter.filter(new Ar(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),E,s))continue;const A={id:f,properties:h.properties,type:h.type,sourceLayerIndex:x,index:g,geometry:T?E.geometry:ye(h,s,a),patterns:{}};u.push(A)}for(const h of u){const{geometry:f,index:g,sourceLayerIndex:x}=h;this.addFeature(h,f,g,s,{},i.availableImages,i.brightness),i.featureIndex.insert(e[g].feature,f,g,x,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,s,a,u,h,f){}destroy(){}addFeature(e,i,s,a,u,h=[],f){for(const g of mp(i,2)){const x=[],T=[],E=[],A=new st(1/0,1/0),P=new st(-1/0,-1/0);for(const U of g)if(U.length!==0){U!==g[0]&&E.push(T.length/2);for(let V=0;V<U.length;V++)T.push(U[V].x),T.push(U[V].y),x.push(U[V]),A.x=Math.min(A.x,U[V].x),A.y=Math.min(A.y,U[V].y),P.x=Math.max(P.x,U[V].x),P.y=Math.max(P.y,U[V].y)}const L=xd(T,E),F=new L_(x,L,8,256);this.footprints.push({vertices:x,indices:L,grid:F,min:A,max:P})}}}Lt(g1,"ClipBucket",{omit:["layers"]});const sI=Ci([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),aI=Ci([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),lI=Ci([{name:"a_flood_light_ground_radius",components:1,type:"Float32"}]),cI=Ci([{name:"a_centroid_pos",components:2,type:"Uint16"}]),uI=Ci([{name:"a_join_normal_inside",components:3,type:"Int16"}]),hI=Ci([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),dI=Ci([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:fI}=sI,_p=Number.MAX_SAFE_INTEGER,y1=_p-1;function v1(r,e,i,s){return r.order<e||r.order===_p||!(r.clipMask&i)||(function(a,u){return u.length!==0&&u.find((h=>h===a))===void 0})(s,r.clipScope)}function R_(r,e){return r.x-e.x||r.y-e.y}function x1(r,e){return R_(r.min,e.min)===0&&R_(r.max,e.max)===0}function Jy(r,e){return!(r.min.x>e.max.x||r.max.x<e.min.x||r.min.y>e.max.y||r.max.y<e.min.y)}function D_(r,e){if(r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(r[i].sourceId!==e[i].sourceId||!x1(r[i],e[i])||r[i].order!==e[i].order||r[i].clipMask!==e[i].clipMask||!ha(r[i].clipScope,e[i].clipScope))return!1;return!0}function b1(r,e,i){const s=1/gt,a=1/(1<<i.canonical.z),u=(e.x*s+i.canonical.x)*a+i.wrap,h=(e.y*s+i.canonical.y)*a;return{min:new st((r.x*s+i.canonical.x)*a+i.wrap,(r.y*s+i.canonical.y)*a),max:new st(u,h)}}function pI(r,e,i){const s=1<<i.canonical.z,a=((e.x-i.wrap)*s-i.canonical.x)*gt,u=(e.y*s-i.canonical.y)*gt;return{min:new st(((r.x-i.wrap)*s-i.canonical.x)*gt,(r.y*s-i.canonical.y)*gt),max:new st(a,u)}}function Ky(r,e,i,s,a,u,h){const f=r.indices,g=r.vertices,x=[];for(let T=s;T<s+a;T+=3){const E=e[i[T+0]+u],A=e[i[T+1]+u],P=e[i[T+2]+u],L=Math.min(E.x,A.x,P.x),F=Math.max(E.x,A.x,P.x),U=Math.min(E.y,A.y,P.y),V=Math.max(E.y,A.y,P.y);x.length=0,r.grid.query(new st(L,U),new st(F,V),x);for(let $=0;$<x.length;$++){const X=x[$];if(to(g[f[3*X+0]],g[f[3*X+1]],g[f[3*X+2]],E,A,P,h))return!0}}return!1}function w1(r,e,i,s){if(!r||!i)return!1;let a=r.vertices;if(!e.canonical.equals(s.canonical)||e.wrap!==s.wrap){if(i.vertices.length<r.vertices.length)return w1(i,s,r,e);const u=e.canonical,h=s.canonical,f=Math.pow(2,h.z-u.z);a=r.vertices.map((g=>new st((g.x+u.x*gt)*f-h.x*gt,(g.y+u.y*gt)*f-h.y*gt)))}return Ky(i,a,r.indices,0,r.indices.length,0,0)}function T1(r,e,i,s){const a=Math.pow(2,s.z-i.z);return new st((r+i.x*gt)*a-s.x*gt,(e+i.y*gt)*a-s.y*gt)}function E1(r,e){const i=[];e.grid.queryPoint(r,i);const s=e.indices,a=e.vertices;for(let u=0;u<i.length;u++){const h=i[u];if(vr([a[s[3*h+0]],a[s[3*h+1]],a[s[3*h+2]]],r))return!0}return!1}const Qy=[new st(0,0),new st(gt,0),new st(gt,gt),new st(0,gt)];function S1(r,e){const i=[];let s=[];if(!e||r.length<2)return[r];if(r.length===2)return Xn(r[0],r[1],Qy)?[r]:[];for(let a=0;a<r.length+2;a++){const u=r[a%r.length],h=r[(a+1)%r.length],f=Xn(a===0?r[r.length-1]:r[(a-1)%r.length],u,Qy),g=Xn(u,h,Qy),x=f||g;x&&s.push(u),x&&g||s.length>0&&(s.length>1&&i.push(s),s=[])}return s.length>1&&i.push(s),i}const ev=Se.types,mI=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],_I=["fill-extrusion-flood-light-ground-radius"],gI=Math.pow(2,13),yI=Math.pow(2,15)-1,I1=new st(0,1),Wl=2147483648,A1=7,C1=450;function gp(r,e,i,s,a,u,h,f){r.emplaceBack((e<<1)+h,(i<<1)+u,(Math.floor(s*gI)<<1)+a,Math.round(f))}function yp(r,e,i){r.emplaceBack(e.x*gt,e.y*gt,i?1:0)}function O_(r,e,i,s,a,u){r.emplaceBack(e.x,e.y,(i.x<<1)+s,(i.y<<1)+a,u)}function vp(r,e,i){r.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class M1{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class P1{constructor(){this.centroidXY=new st(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new st(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new st(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new st(this.max.x-this.min.x,this.max.y-this.min.y)}}class L1{constructor(){this.acc=new st(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,s){this.accCount++,this.acc._add(i);let a=!!this.borders;i.x<e.min.x?(e.min.x=i.x,a=!0):i.x>e.max.x&&(e.max.x=i.x,a=!0),i.y<e.min.y?(e.min.y=i.y,a=!0):i.y>e.max.y&&(e.max.y=i.y,a=!0),((i.x===0||i.x===gt)&&i.x===s.x)!=((i.y===0||i.y===gt)&&i.y===s.y)&&this.processBorderOverlap(i,s),a&&this.checkBorderIntersection(i,s)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,ei(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>gt!=e.x>gt&&this.addBorderIntersection(1,ei(i.y,e.y,(gt-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,ei(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>gt!=e.y>gt&&this.addBorderIntersection(3,ei(i.x,e.x,(gt-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const s=this.borders[e];i<s[0]&&(s[0]=i),i>s[1]&&(s[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const s=e.x===0?0:1;this.addBorderIntersection(s,i.y),this.addBorderIntersection(s,e.y)}else{const s=e.y===0?2:3;this.addBorderIntersection(s,i.x),this.addBorderIntersection(s,e.x)}}centroid(){return this.accCount===0?new st(0,0):new st(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((e,i)=>e+ +(i[0]!==Number.MAX_VALUE)),0):0}}function R1(r,e){const i=r.add(e)._unit(),s=j(r.x*i.x+r.y*i.y,-1,1);var a,u,h;return a=Math.acos(s),Math.min(4,Math.max(-4,Math.tan(a)))/4*yI*((u=r).x*(h=e).y-u.y*h.x<0?-1:1)}const vI=[r=>r.x<0,r=>r.x>gt,r=>r.y<0,r=>r.y>gt];function xI(r,e,i,s){const a=[4];if(s===0)return a;i._mult(s);const u=r.sub(i),h=e.sub(i),f=[r,e,u,h];for(let g=0;g<4;g++)for(const x of f)if(vI[g](x)){a.push(g);break}return a}class tv{constructor(e){this.groundRadiusArray=null,this.groundRadiusBuffer=null,this.vertexArray=new Hf,this.indexArray=new xn,this.programConfigurations=new As(e.layers,{zoom:e.zoom,lut:e.lut},(i=>_I.includes(i))),this._segments=new Fr,this.hiddenByLandmarkVertexArray=new ld,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Fr}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,s,a=!1){const u=e.length;if(u>2){let h=Math.max(0,this._segments.get().length-1);const f=this._segments._prepareSegment(4*u,this.vertexArray.length,2*this._segmentToGroundQuads[h].length);let g;h!==this._segments.get().length-1&&(h++,this._segmentToGroundQuads[h]=[],this._segmentToRegionTriCounts[h]=[0,0,0,0,0]);{const x=e[0],T=e[1];g=R1(x.sub(e[u-1])._perp()._unit(),T.sub(x)._perp()._unit())}for(let x=0;x<u;x++){const T=x===u-1?0:x+1,E=e[x],A=e[T],P=e[T===u-1?0:T+1],L=A.sub(E)._perp()._unit(),F=R1(L,P.sub(A)._perp()._unit()),U=g,V=F;if(iv(E,A,i)||a&&z1(E,i)&&z1(A,i)){g=F;continue}const $=f.vertexLength;O_(this.vertexArray,E,A,1,1,U),O_(this.vertexArray,E,A,1,0,U),O_(this.vertexArray,E,A,0,1,V),O_(this.vertexArray,E,A,0,0,V),f.vertexLength+=4;const X=xI(E,A,L,s);for(const Q of X)this._segmentToGroundQuads[h].push({id:$,region:Q}),this._segmentToRegionTriCounts[h][Q]+=2,f.primitiveLength+=2;g=F}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let s=0;s<i;s++)this._segmentToGroundQuads[s].sort(((a,u)=>a.region-u.region));for(let s=0;s<i;s++){const a=this._segmentToGroundQuads[s],u=e[s],h=this._segmentToRegionTriCounts[s];h.reduce(((g,x)=>g+x),0);let f=0;for(let g=0;g<=4;g++){const x=h[g];if(x!==0){let T=this.regionSegments[g];T||(T=this.regionSegments[g]=new Fr);const E={vertexOffset:u.vertexOffset,primitiveOffset:u.primitiveOffset+f,vertexLength:u.vertexLength,primitiveLength:x};T.get().push(E)}f+=x}for(let g=0;g<a.length;g++){const x=a[g].id;this.indexArray.emplaceBack(x,x+1,x+3),this.indexArray.emplaceBack(x,x+3,x+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,s,a,u,h,f){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,s,a,u,h,void 0,f)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,aI.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.groundRadiusArray!=null&&(this.groundRadiusBuffer=e.createVertexBuffer(this.groundRadiusArray,lI.members)))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,s,a,u,h,f,g){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,s,a,u,h,f,g)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&Wl))}updateHiddenByLandmarkRange(e,i,s){if(!this.hasData())return;const a=i+e;if(i!==0){for(let u=e;u<a;++u)this.hiddenByLandmarkVertexArray.emplace(u,s?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,hI.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.groundRadiusBuffer&&this.groundRadiusBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class z_{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new xn,this.footprintVertices=new nl,this.footprintSegments=[],this.layoutVertexArray=new wc,this.centroidVertexArray=new w_,this.wallVertexArray=new Cu,this.indexArray=new xn,this.programConfigurations=new As(e.layers,{zoom:e.zoom,lut:e.lut},(i=>mI.includes(i))),this.segments=new Fr,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.groundEffect=new tv(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,s,a){}populate(e,i,s,a){this.features=[],this.hasPattern=Zy("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=q(s),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:u,id:h,index:f,sourceLayerIndex:g}of e){const x=this.layers[0]._featureFilter.needGeometry,T=Ce(u,x);if(!this.layers[0]._featureFilter.filter(new Ar(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),T,s))continue;const E={id:h,sourceLayerIndex:g,index:f,geometry:x?T.geometry:ye(u,s,a),properties:u.properties,type:u.type,patterns:{}},A=this.layoutVertexArray.length,P=ev[E.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:u.id,feature:$y("fill-extrusion",this.layers,E,this.zoom,this.pixelRatio,i)});else if(this.wallMode)for(const L of E.geometry)for(const F of S1(L,P))this.addFeature(u.id,E,[F],f,s,{},i.availableImages,a,i.brightness);else this.addFeature(u.id,E,E.geometry,f,s,{},i.availableImages,a,i.brightness);i.featureIndex.insert(u,E.geometry,f,g,this.index,A)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,s,a,u,h){for(const{featureId:f,feature:g}of this.features){const x=ev[g.type]==="Polygon",{geometry:T}=g;if(this.wallMode)for(const E of T)for(const A of S1(E,x))this.addFeature(f,g,[A],g.index,i,s,a,u,h);else this.addFeature(f,g,T,g.index,i,s,a,u,h)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,s,a,u,h,f){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,this.worldview),this.groundEffect.update(e,i,u,s,a,h,f,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,fI),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,uI.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,dI.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,cI.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,s,a,u,h,f,g,x){const T=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(i,{})/this.tileToMeter,E=[new st(0,0),new st(gt,gt)],A=g.projection,P=A.name==="globe",L=this.wallMode||ev[i.type]==="Polygon",F=new L1;F.centroidDataIndex=this.centroidData.length;const U=new P1;U.buildingId=e,i.properties&&i.properties.hasOwnProperty("building_id")&&(U.buildingId=i.properties.building_id);const V=this.layers[0].paint.get("fill-extrusion-base").evaluate(i,{},u)<=0,$=this.layers[0].paint.get("fill-extrusion-height").evaluate(i,{},u);let X;if(U.height=$,U.vertexArrayOffset=this.layoutVertexArray.length,U.groundVertexArrayOffset=this.groundEffect.vertexArray.length,P&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new id),this.wallMode){if(P)return void It("Non zero fill-extrusion-line-width is not yet supported on globe.");if(s.length!==1)return;X=(function(Me){const $e=Me[0].x===Me[Me.length-1].x&&Me[0].y===Me[Me.length-1].y;(function(Ct){let Ot=0;const Ii=Ct.length;for(let pt=0;pt<Ii;pt++)Ot+=(Ct[(pt+1)%Ii].x-Ct[pt].x)*(Ct[(pt+1)%Ii].y+Ct[pt].y);return Ot>=0})(Me)||(Me=Me.reverse());const Qe={geometry:[],joinNormals:[],indices:[]},at=[],ct=[],tt=[];let rt=Me.length;for(;rt>=2&&Me[rt-1].equals(Me[rt-2]);)rt--;if(rt<($e?3:2))return Qe;let Ze,qe,ot,yt,ft,Nt=0;for(;Nt<rt-1&&Me[Nt].equals(Me[Nt+1]);)Nt++;$e&&(Ze=Me[rt-2],ft=Me[Nt].sub(Ze)._unit()._perp());for(let Ct=Nt;Ct<rt;Ct++){if(ot=Ct===rt-1?$e?Me[Nt+1]:void 0:Me[Ct+1],ot&&Me[Ct].equals(ot))continue;ft&&(yt=ft),Ze&&(qe=Ze),Ze=Me[Ct],ft=ot?ot.sub(Ze)._unit()._perp():yt,yt=yt||ft;let Ot=yt.add(ft);Ot.x===0&&Ot.y===0||Ot._unit();const Ii=Ot.x*ft.x+Ot.y*ft.y,pt=Ii!==0?1/Ii:1/0,zt=yt.x*ft.y-yt.y*ft.x>0;let oi="miter";const Oi=2;oi==="miter"&&pt>Oi&&(oi="bevel"),oi==="bevel"&&(pt>100&&(oi="flipbevel"),pt<Oi&&(oi="miter"));const Ni=(pi,pr,le,fe)=>{const We=new st(pi.x,pi.y),lt=new st(pi.x,pi.y);We.x+=pr.x*fe,We.y+=pr.y*fe,lt.x-=pr.x*Math.max(le,1),lt.y-=pr.y*Math.max(le,1),tt.push(pr),at.push(We),ct.push(lt)};if(oi==="miter")Ot._mult(pt),Ni(Ze,Ot,0,0);else if(oi==="flipbevel")Ot=ft.mult(-1),Ni(Ze,Ot,0,0),Ni(Ze,Ot.mult(-1),0,0);else{const pi=-Math.sqrt(pt*pt-1),pr=zt?pi:0,le=zt?0:pi;qe&&Ni(Ze,yt,pr,le),ot&&Ni(Ze,ft,pr,le)}}Qe.geometry=[...at,...ct.reverse(),at[0]],Qe.joinNormals=[...tt,...tt.reverse(),tt[tt.length-1]];const Et=Qe.geometry.length-1;for(let Ct=0;Ct<Et/2;Ct++)if(Ct+1<Et/2){let Ot=Ct,Ii=Ct+1,pt=Et-1-Ct,zt=Et-2-Ct;Ot=Ot===0?Et-1:Ot-1,Ii=Ii===0?Et-1:Ii-1,pt=pt===0?Et-1:pt-1,zt=zt===0?Et-1:zt-1,Qe.indices.push(pt),Qe.indices.push(Ii),Qe.indices.push(Ot),Qe.indices.push(pt),Qe.indices.push(zt),Qe.indices.push(Ii)}return Qe})(s[0]),s=[X.geometry]}const Q=(Me,$e)=>Me<($e.length-1)/2||Me===$e.length-1,de=this.wallMode?[s]:mp(s,500);for(let Me=de.length-1;Me>=0;Me--){const $e=de[Me];($e.length===0||(ae=$e[0]).every((Ke=>Ke.x<=0))||ae.every((Ke=>Ke.x>=gt))||ae.every((Ke=>Ke.y<=0))||ae.every((Ke=>Ke.y>=gt)))&&de.splice(Me,1)}var ae;let me;if(P)me=N1(de,E,u);else{me=[];for(const Me of de)me.push({polygon:Me,bounds:E})}const xe=L?this.edgeRadius:0,Ee=xe>0&&this.zoom<17,Ge=(Me,$e)=>{if(Me.length===0)return!1;const Ke=Me[Me.length-1];return $e.x===Ke.x&&$e.y===Ke.y};for(const{polygon:Me,bounds:$e}of me){let Ke=0,Qe=0;for(const rt of Me)L&&!rt[0].equals(rt[rt.length-1])&&rt.push(rt[0]),Qe+=L?rt.length-1:rt.length;const at=this.segments.prepareSegment((L?5:4)*Qe,this.layoutVertexArray,this.indexArray);U.footprintSegIdx<0&&(U.footprintSegIdx=this.footprintSegments.length),U.polygonSegIdx<0&&(U.polygonSegIdx=this.polygonSegments.length);const ct={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},tt=new M1;if(tt.vertexOffset=this.footprintVertices.length,tt.indexOffset=3*this.footprintIndices.length,tt.ringIndices=[],L){const rt=[],Ze=[];Ke=at.vertexLength;for(let ot=0;ot<Me.length;ot++){const yt=Me[ot];yt.length&&ot!==0&&Ze.push(rt.length/2);const ft=[];let Nt,Et;Nt=yt[1].sub(yt[0])._perp()._unit(),tt.ringIndices.push(yt.length-1);for(let Ct=1;Ct<yt.length;Ct++){const Ot=yt[Ct],Ii=yt[Ct===yt.length-1?1:Ct+1],pt=Ot.clone();if(xe){Et=Ii.sub(Ot)._perp()._unit();const zt=Nt.add(Et)._unit(),oi=xe*Math.min(4,1/(Nt.x*zt.x+Nt.y*zt.y));pt.x+=oi*zt.x,pt.y+=oi*zt.y,pt.x=Math.round(pt.x),pt.y=Math.round(pt.y),Nt=Et}if(!V||xe!==0&&!Ee||Ge(ft,pt)||ft.push(pt),gp(this.layoutVertexArray,pt.x,pt.y,0,0,1,1,0),this.wallMode){const zt=Q(Ct,yt);yp(this.wallVertexArray,X.joinNormals[Ct],!zt)}at.vertexLength++,this.footprintVertices.emplaceBack(Ot.x,Ot.y),rt.push(Ot.x,Ot.y),P&&vp(this.layoutVertexExtArray,A.projectTilePoint(pt.x,pt.y,u),A.upVector(u,pt.x,pt.y))}V&&(xe===0||Ee)&&(ft.length!==0&&Ge(ft,ft[0])&&ft.pop(),this.groundEffect.addData(ft,$e,T))}const qe=this.wallMode?X.indices:xd(rt,Ze);for(let ot=0;ot<qe.length;ot+=3)this.footprintIndices.emplaceBack(tt.vertexOffset+qe[ot+0],tt.vertexOffset+qe[ot+1],tt.vertexOffset+qe[ot+2]),this.indexArray.emplaceBack(Ke+qe[ot],Ke+qe[ot+2],Ke+qe[ot+1]),at.primitiveLength++;tt.indexCount+=qe.length,tt.vertexCount+=this.footprintVertices.length-tt.vertexOffset}for(let rt=0;rt<Me.length;rt++){const Ze=Me[rt];F.startRing(U,Ze[0]);let qe=Ze.length>4&&k1(Ze[Ze.length-2],Ze[0],Ze[1]),ot=xe?bI(Ze[Ze.length-2],Ze[0],Ze[1],xe):0;const yt=[];let ft,Nt,Et;Nt=Ze[1].sub(Ze[0])._perp()._unit();let Ct=!0;for(let Ot=1,Ii=0;Ot<Ze.length;Ot++){let pt=Ze[Ot-1],zt=Ze[Ot];const oi=Ze[Ot===Ze.length-1?1:Ot+1];if(F.appendEdge(U,zt,pt),iv(zt,pt,$e)){xe&&(Nt=oi.sub(zt)._perp()._unit(),Ct=!Ct);continue}const Oi=zt.sub(pt)._perp(),Ni=Oi.x/(Math.abs(Oi.x)+Math.abs(Oi.y)),pi=Oi.y>0?1:0,pr=pt.dist(zt);if(Ii+pr>32768&&(Ii=0),xe){Et=oi.sub(zt)._perp()._unit();let lt=O1(pt,zt,oi,D1(Nt,Et),xe);isNaN(lt)&&(lt=0);const bt=zt.sub(pt)._unit();pt=pt.add(bt.mult(ot))._round(),zt=zt.add(bt.mult(-lt))._round(),ot=lt,Nt=Et,V&&this.zoom>=17&&(Ge(yt,pt)||yt.push(pt),Ge(yt,zt)||yt.push(zt))}const le=at.vertexLength,fe=Ze.length>4&&k1(pt,zt,oi);let We=F1(Ii,qe,Ct);if(gp(this.layoutVertexArray,pt.x,pt.y,Ni,pi,0,0,We),gp(this.layoutVertexArray,pt.x,pt.y,Ni,pi,0,1,We),this.wallMode){const lt=Q(Ot-1,Ze),bt=X.joinNormals[Ot-1];yp(this.wallVertexArray,bt,lt),yp(this.wallVertexArray,bt,lt)}if(Ii+=pr,We=F1(Ii,fe,!Ct),qe=fe,gp(this.layoutVertexArray,zt.x,zt.y,Ni,pi,0,0,We),gp(this.layoutVertexArray,zt.x,zt.y,Ni,pi,0,1,We),this.wallMode){const lt=Q(Ot,Ze),bt=X.joinNormals[Ot];yp(this.wallVertexArray,bt,lt),yp(this.wallVertexArray,bt,lt)}if(at.vertexLength+=4,this.indexArray.emplaceBack(le+0,le+1,le+2),this.indexArray.emplaceBack(le+1,le+3,le+2),at.primitiveLength+=2,xe){const lt=Ke+(Ot===1?Ze.length-2:Ot-2),bt=Ot===1?Ke:lt+1;if(this.indexArray.emplaceBack(le+1,lt,le+3),this.indexArray.emplaceBack(lt,bt,le+3),at.primitiveLength+=2,ft===void 0&&(ft=le),!iv(oi,Ze[Ot],$e)){const wt=Ot===Ze.length-1?ft:at.vertexLength;this.indexArray.emplaceBack(le+2,le+3,wt),this.indexArray.emplaceBack(le+3,wt+1,wt),this.indexArray.emplaceBack(le+3,bt,wt+1),at.primitiveLength+=3}Ct=!Ct}if(P){const lt=this.layoutVertexExtArray,bt=A.projectTilePoint(pt.x,pt.y,u),wt=A.projectTilePoint(zt.x,zt.y,u),Vt=A.upVector(u,pt.x,pt.y),qt=A.upVector(u,zt.x,zt.y);vp(lt,bt,Vt),vp(lt,bt,Vt),vp(lt,wt,qt),vp(lt,wt,qt)}}L&&(Ke+=Ze.length-1),V&&xe&&this.zoom>=17&&(yt.length!==0&&Ge(yt,yt[0])&&yt.pop(),this.groundEffect.addData(yt,$e,T,xe>0))}this.footprintSegments.push(tt),ct.triangleCount=this.indexArray.length-ct.triangleArrayOffset,this.polygonSegments.push(ct),++U.footprintSegLen,++U.polygonSegLen}if(U.vertexCount=this.layoutVertexArray.length-U.vertexArrayOffset,U.groundVertexCount=this.groundEffect.vertexArray.length-U.groundVertexArrayOffset,U.vertexCount!==0){if(U.centroidXY=F.borders?I1:this.encodeCentroid(F,U),this.centroidData.push(U),F.borders){this.featuresOnBorder.push(F);const Me=this.featuresOnBorder.length-1;for(let $e=0;$e<F.borders.length;$e++)F.borders[$e][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[$e].push(Me)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,a,h,f,u,x,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(i,a,h,f,u,x,this.worldview),this.maxHeight=Math.max(this.maxHeight,$)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort(((i,s)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[s].borders[e][0]))}splitToSubtiles(){const e=[];for(let f=0;f<this.centroidData.length;f++){const g=this.centroidData[f],x=+(g.min.y+g.max.y>gt),T=2*x+(+(g.min.x+g.max.x>gt)^x);for(let E=0;E<g.polygonSegLen;E++){const A=g.polygonSegIdx+E;e.push({centroidIdx:f,subtile:T,polygonSegmentIdx:A,triangleSegmentIdx:this.polygonSegments[A].triangleSegIdx})}}const i=new xn;e.sort(((f,g)=>f.triangleSegmentIdx===g.triangleSegmentIdx?f.subtile-g.subtile:f.triangleSegmentIdx-g.triangleSegmentIdx));let s=0,a=0,u=0;for(const f of e){if(f.triangleSegmentIdx!==s)break;u++}const h=e.length;for(;a!==e.length;){s=e[a].triangleSegmentIdx;let f=0,g=a,x=a;for(let T=g;T<u&&e[T].subtile===f;T++)x++;for(;g!==u;){const T=e[g];f=T.subtile;const E=this.centroidData[T.centroidIdx].min.clone(),A=this.centroidData[T.centroidIdx].max.clone(),P={vertexOffset:this.segments.segments[s].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[s].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let L=g;L<x;L++){const F=e[L],U=this.polygonSegments[F.polygonSegmentIdx],V=this.centroidData[F.centroidIdx].min,$=this.centroidData[F.centroidIdx].max,X=this.indexArray.uint16;for(let Q=U.triangleArrayOffset;Q<U.triangleArrayOffset+U.triangleCount;Q++)i.emplaceBack(X[3*Q],X[3*Q+1],X[3*Q+2]);P.primitiveLength+=U.triangleCount,E.x=Math.min(E.x,V.x),E.y=Math.min(E.y,V.y),A.x=Math.max(A.x,$.x),A.y=Math.max(A.y,$.y)}P.primitiveLength>0&&this.triangleSubSegments.push({segment:P,min:E,max:A}),g=x;for(let L=g;L<u&&e[L].subtile===e[g].subtile;L++)x++}a=u;for(let T=a;T<h&&e[T].triangleSegmentIdx===e[a].triangleSegmentIdx;T++)u++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,s){const a=new Fr;if(this.wallMode){for(const F of this.triangleSubSegments)a.segments.push(F.segment);return a}let u=0,h=0;const f=1<<e.canonical.z;if(i){const F=i.getMinMaxForTile(e);F&&(u=F.min,h=F.max)}h+=this.maxHeight;const g=e.toUnwrapped();let x;const T=[g.canonical.x/f+g.wrap,g.canonical.y/f],E=[(g.canonical.x+1)/f+g.wrap,(g.canonical.y+1)/f],A=(F,U,V)=>[F[0]*(1-V[0])+U[0]*V[0],F[1]*(1-V[1])+U[1]*V[1]],P=[],L=[];for(const F of this.triangleSubSegments){P[0]=F.min.x/gt,P[1]=F.min.y/gt,L[0]=F.max.x/gt,L[1]=F.max.y/gt;const U=A(T,E,P),V=A(T,E,L);if(new Ft([U[0],U[1],u],[V[0],V[1],h]).intersectsPrecise(s)===0){x&&(a.segments.push(x),x=void 0);continue}const $=F.segment;x&&x.vertexOffset!==$.vertexOffset&&(a.segments.push(x),x=void 0),x?(x.vertexLength+=$.vertexLength,x.primitiveLength+=$.primitiveLength):x={vertexOffset:$.vertexOffset,primitiveLength:$.primitiveLength,vertexLength:$.vertexLength,primitiveOffset:$.primitiveOffset,sortKey:void 0,vaos:{}}}return x&&a.segments.push(x),a}encodeCentroid(e,i){const s=e.centroid(),a=i.span(),u=Math.min(7,Math.round(a.x*this.tileToMeter/10)),h=Math.min(7,Math.round(a.y*this.tileToMeter/10));return new st(j(s.x,1,gt-1)<<3|u,j(s.y,1,gt-1)<<3|h)}encodeBorderCentroid(e){if(!e.borders)return new st(0,0);const i=e.borders,s=Number.MAX_VALUE;if(i[0][0]!==s||i[1][0]!==s){const a=i[0][0]!==s?0:1;return new st(6|(i[0][0]!==s?0:65528),(i[a][0]+i[a][1])/2<<3|6)}{const a=i[2][0]!==s?2:3;return new st((i[a][0]+i[a][1])/2<<3|6,6|(i[2][0]!==s?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=2147483647,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,s=e.vertexCount+e.vertexArrayOffset,a=e.flags&Wl?I1:e.centroidXY,u=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==a.y||u!==a.x){for(let h=i;h<s;++h)this.centroidVertexArray.emplace(h,a.x,a.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,s){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped());if(D_(this.activeReplacements,a))return;if(this.activeReplacements=a,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const h of this.centroidData)h.flags&=2147483647;const u=[];for(const h of this.activeReplacements){if(h.order<s)continue;const f=Math.max(1,Math.pow(2,h.footprintTileId.canonical.z-e.canonical.z));if(h.footprint.buildingIds)for(const g of this.centroidData)g.flags&Wl||h.min.x>g.max.x||g.min.x>h.max.x||h.min.y>g.max.y||g.min.y>h.max.y||h.footprint.buildingIds.has(g.buildingId)&&(g.flags|=Wl);else for(const g of this.centroidData)if(!(g.flags&Wl||h.min.x>g.max.x||g.min.x>h.max.x||h.min.y>g.max.y||g.min.y>h.max.y))for(let x=0;x<g.footprintSegLen;x++){const T=this.footprintSegments[g.footprintSegIdx+x];if(u.length=0,wI(this.footprintVertices,T.vertexOffset,T.vertexCount,h.footprintTileId.canonical,e.canonical,u),Ky(h.footprint,u,this.footprintIndices.uint16,T.indexOffset,T.indexCount,-T.vertexOffset,-f)){g.flags|=Wl;break}}}for(const h of this.centroidData)this.writeCentroidToBuffer(h);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,s){let a=!1;for(let u=0;u<s.footprintSegLen;u++){const h=this.footprintSegments[s.footprintSegIdx+u];let f=0;for(const g of h.ringIndices){for(let x=f,T=g+f-1;x<g+f;T=x++){const E=this.footprintVertices.int16[2*(x+h.vertexOffset)+0],A=this.footprintVertices.int16[2*(x+h.vertexOffset)+1],P=this.footprintVertices.int16[2*(T+h.vertexOffset)+1];A>i!=P>i&&e<(this.footprintVertices.int16[2*(T+h.vertexOffset)+0]-E)*(i-A)/(P-A)+E&&(a=!a)}f=g}}return a}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,a=!0;const u=4*(e+gt)*gt+(i+gt);if(this.partLookup.hasOwnProperty(u)){const h=this.partLookup[u];return h?{height:h.height,hidden:!!(h.flags&Wl)}:void 0}for(const h of this.centroidData)e>h.max.x||h.min.x>e||i>h.max.y||h.min.y>i||h.height<=s||this.footprintContainsPoint(e,i,h)&&(s=h.height,this.partLookup[u]=h,a=!!(h.flags&Wl));if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:a};this.partLookup[u]=void 0}}function D1(r,e){const i=r.add(e)._unit();return r.x*i.x+r.y*i.y}function bI(r,e,i,s){const a=e.sub(r)._perp()._unit(),u=i.sub(e)._perp()._unit();return O1(r,e,i,D1(a,u),s)}function O1(r,e,i,s,a){const u=Math.sqrt(1-s*s);return Math.min(r.dist(e)/3,e.dist(i)/3,a*u/s)}function iv(r,e,i){return r.x<i[0].x&&e.x<i[0].x||r.x>i[1].x&&e.x>i[1].x||r.y<i[0].y&&e.y<i[0].y||r.y>i[1].y&&e.y>i[1].y}function z1(r,e){return r.x<e[0].x||r.x>e[1].x||r.y<e[0].y||r.y>e[1].y}function k1(r,e,i){if(r.x<0||r.x>=gt||e.x<0||e.x>=gt||i.x<0||i.x>=gt)return!1;const s=i.sub(e),a=s.perp(),u=r.sub(e);return(s.x*u.x+s.y*u.y)/Math.sqrt((s.x*s.x+s.y*s.y)*(u.x*u.x+u.y*u.y))>-.866&&a.x*u.x+a.y*u.y<0}function F1(r,e,i){const s=e?2|r:-3&r;return i?1|s:-2&s}function B1(){const r=Math.PI/32,e=Math.tan(r),i=l;return i*Math.sqrt(1+2*e*e)-i}function N1(r,e,i){const s=1<<i.z,a=C(i.x/s),u=C((i.x+1)/s),h=O(i.y/s),f=O((i.y+1)/s);return(function(g,x,T,E,A=0,P){const L=[];if(!g.length||!T||!E)return L;const F=(ae,me)=>{for(const xe of ae)L.push({polygon:xe,bounds:me})},U=Math.ceil(Math.log2(T)),V=Math.ceil(Math.log2(E)),$=U-V,X=[];for(let ae=0;ae<Math.abs($);ae++)X.push($>0?0:1);for(let ae=0;ae<Math.min(U,V);ae++)X.push(0),X.push(1);let Q=g;if(Q=P_(Q,x[0].y-A,x[1].y+A,1),Q=P_(Q,x[0].x-A,x[1].x+A,0),!Q.length)return L;const de=[];for(X.length?de.push({polygons:Q,bounds:x,depth:0}):F(Q,x);de.length;){const ae=de.pop(),me=ae.depth,xe=X[me],Ee=ae.bounds[0],Ge=ae.bounds[1],Me=xe===0?Ee.x:Ee.y,$e=xe===0?Ge.x:Ge.y,Ke=P?P(xe,Me,$e):.5*(Me+$e),Qe=P_(ae.polygons,Me-A,Ke+A,xe),at=P_(ae.polygons,Ke-A,$e+A,xe);if(Qe.length){const ct=[Ee,new st(xe===0?Ke:Ge.x,xe===1?Ke:Ge.y)];X.length>me+1?de.push({polygons:Qe,bounds:ct,depth:me+1}):F(Qe,ct)}if(at.length){const ct=[new st(xe===0?Ke:Ee.x,xe===1?Ke:Ee.y),Ge];X.length>me+1?de.push({polygons:at,bounds:ct,depth:me+1}):F(at,ct)}}return L})(r,e,Math.ceil((u-a)/11.25),Math.ceil((h-f)/11.25),1,((g,x,T)=>{if(g===0)return .5*(x+T);{const E=O((i.y+x/gt)/s);return(w(.5*(O((i.y+T/gt)/s)+E))*s-i.y)*gt}}))}function wI(r,e,i,s,a,u){const h=Math.pow(2,s.z-a.z);for(let f=0;f<i;f++){let g=r.int16[2*(f+e)+0],x=r.int16[2*(f+e)+1];g=(g+a.x*gt)*h-s.x*gt,x=(x+a.y*gt)*h-s.y*gt,u.push(new st(g,x))}}let V1,U1;Lt(z_,"FillExtrusionBucket",{omit:["layers","features"]}),Lt(P1,"PartData"),Lt(M1,"FootprintSegment"),Lt(L1,"BorderCentroidData"),Lt(tv,"GroundEffect");class Bu extends st{constructor(e,i,s){super(e,i),this.z=s}}class j1 extends Bu{constructor(e,i,s,a){super(e,i,s),this.w=a}}function G1(r,e,i,s){const a=i==="x"?"y":"x",u=(s-r[i])/(e[i]-r[i]);r[a]=Math.round(r[a]+(e[a]-r[a])*u),r[i]=s,r.hasOwnProperty("z")&&(r.z=ei(r.z,e.z,u)),r.hasOwnProperty("w")&&(r.w=ei(r.w,e.w,u))}function q1(r,e,i,s){const a=i,u=s;for(const h of["x","y"]){let f=r,g=e;f[h]>=g[h]&&(f=e,g=r),f[h]<a&&g[h]>a&&G1(f,g,h,a),f[h]<u&&g[h]>u&&G1(g,f,h,u)}}function k_(r,e,i,s,a,u){const h=[];for(let f=0;f<r.length;f++){const g=r[f];let x;const T=h.length;let E=0;for(let A=0;A<g.length-1;A++){let P=g[A],L=g[A+1],F=0;const U=E;let V,$;u&&(F=Math.hypot(L.x-P.x,L.y-P.y),E+=F,V=P,$=L),P.x<e&&L.x<e||(P.x<e?P=new st(e,P.y+(e-P.x)/(L.x-P.x)*(L.y-P.y))._round():L.x<e&&(L=new st(e,P.y+(e-P.x)/(L.x-P.x)*(L.y-P.y))._round()),P.y<i&&L.y<i||(P.y<i?P=new st(P.x+(i-P.y)/(L.y-P.y)*(L.x-P.x),i)._round():L.y<i&&(L=new st(P.x+(i-P.y)/(L.y-P.y)*(L.x-P.x),i)._round()),P.x>=s&&L.x>=s||(P.x>=s?P=new st(s,P.y+(s-P.x)/(L.x-P.x)*(L.y-P.y))._round():L.x>=s&&(L=new st(s,P.y+(s-P.x)/(L.x-P.x)*(L.y-P.y))._round()),P.y>=a&&L.y>=a||(P.y>=a?P=new st(P.x+(a-P.y)/(L.y-P.y)*(L.x-P.x),a)._round():L.y>=a&&(L=new st(P.x+(a-P.y)/(L.y-P.y)*(L.x-P.x),a)._round()),x&&P.equals(x[x.length-1])||(x=[P],h.push(x),u&&u.push({progress:{min:U+H1(V,$,P)*F,max:1},parentIndex:f,prevPoint:V,nextPoint:$})),x.push(L),u&&(u[u.length-1].progress.max=U+H1(V,$,L)*F,u[u.length-1].nextPoint=$)))))}if(u&&E>0)for(let A=T;A<h.length;A++)u[A].progress.min/=E,u[A].progress.max/=E}return h}function TI(r,e,i,s,a){if(r.length<2)return void s.push(r);const u=[];for(;e.valid();){const[x,T]=e.get();for(let E=0;E<r.length-1;E++){const A=r[E],P=r[E+1],L=xi(A,P,x,T);if(L){const[F]=L,U=new st(ei(A.x,P.x,F),ei(A.y,P.y,F));u.push({t:E+F,distance:0,point:U})}}e.next()}if(u.length===0)return void s.push(r);u.sort(((x,T)=>x.t-T.t));let h=0,f=0,g=[];for(s.push(g);h!==r.length;){if(f===u.length){for(;h!==r.length;)g.length!==0&&g[g.length-1].equals(r[h])||g.push(r[h]),h++;break}u[f].t<=h?(g.length!==0&&g[g.length-1].equals(u[f].point)||g.push(u[f].point),Math.trunc(u[f].t),f++):(g.length!==0&&g[g.length-1].equals(r[h])||g.push(r[h]),h++)}}function H1(r,e,i){return r.x!==e.x?(i.x-r.x)/(e.x-r.x):r.y!==e.y?(i.y-r.y)/(e.y-r.y):0}function xp(r,e){return r.x*e.x+r.y*e.y}function Z1(r,e){if(r.length===1){let i=0;const s=e[i++];let a;for(;!a||s.equals(a);)if(a=e[i++],!a)return 1/0;for(;i<e.length;i++){const u=e[i],h=r[0],f=a.sub(s),g=u.sub(s),x=h.sub(s),T=xp(f,f),E=xp(f,g),A=xp(g,g),P=xp(x,f),L=xp(x,g),F=T*A-E*E,U=(A*P-E*L)/F,V=(T*L-E*P)/F,$=s.z*(1-U-V)+a.z*U+u.z*V;if(isFinite($))return $}return 1/0}{let i=1/0;for(const s of e)i=Math.min(i,s.z);return i}}function $1(r,e,i){let s=1/0;ir(i,e)&&(s=Z1(i,e[0]));for(let a=0;a<e.length;a++){const u=e[a],h=r[a];for(let f=0;f<u.length-1;f++){const g=u[f],x=[g,u[f+1],h[f+1],h[f],g];Xi(i,x)&&(s=Math.min(s,Z1(i,x)))}}return s!==1/0&&s}function W1(r,e,i,s,a,u,h,f,g,x,T){return r.projection.name==="globe"?(function(E,A,P,L,F,U,V,$,X,Q,de){const ae=[],me=[],xe=E.projection.upVectorScale(de,E.center.lat,E.worldSize).metersToTile,Ee=[0,0,0,1],Ge=[0,0,0,1],Me=(Ke,Qe,at,ct)=>{Ke[0]=Qe,Ke[1]=at,Ke[2]=ct,Ke[3]=1},$e=B1();P>0&&(P+=$e),L+=$e;for(const Ke of A){const Qe=[],at=[];for(const ct of Ke){const tt=ct.x+F.x,rt=ct.y+F.y,Ze=E.projection.projectTilePoint(tt,rt,de),qe=E.projection.upVector(de,ct.x,ct.y);let ot=P,yt=L;if(V){const ft=X1(tt,rt,P,L,V,$,X,Q);ot+=ft.base,yt+=ft.top}P!==0?Me(Ee,Ze.x+qe[0]*xe*ot,Ze.y+qe[1]*xe*ot,Ze.z+qe[2]*xe*ot):Me(Ee,Ze.x,Ze.y,Ze.z),Me(Ge,Ze.x+qe[0]*xe*yt,Ze.y+qe[1]*xe*yt,Ze.z+qe[2]*xe*yt),kr(Ee,Ee,U),kr(Ge,Ge,U),Qe.push(new Bu(Ee[0],Ee[1],Ee[2])),at.push(new Bu(Ge[0],Ge[1],Ge[2]))}ae.push(Qe),me.push(at)}return[ae,me]})(r,e,i,s,a,u,h,f,g,x,T):h?(function(E,A,P,L,F,U,V,$,X){const Q=[],de=[],ae=[0,0,0,1];for(const me of E){const xe=[],Ee=[];for(const Ge of me){const Me=Ge.x+L.x,$e=Ge.y+L.y,Ke=X1(Me,$e,A,P,U,V,$,X);ae[0]=Me,ae[1]=$e,ae[2]=Ke.base,ae[3]=1,Jn(ae,ae,F),ae[3]=Math.max(ae[3],1e-5);const Qe=new Bu(ae[0]/ae[3],ae[1]/ae[3],ae[2]/ae[3]);ae[0]=Me,ae[1]=$e,ae[2]=Ke.top,ae[3]=1,Jn(ae,ae,F),ae[3]=Math.max(ae[3],1e-5);const at=new Bu(ae[0]/ae[3],ae[1]/ae[3],ae[2]/ae[3]);xe.push(Qe),Ee.push(at)}Q.push(xe),de.push(Ee)}return[Q,de]})(e,i,s,a,u,h,f,g,x):(function(E,A,P,L,F){const U=[],V=[],$=F[8]*A,X=F[9]*A,Q=F[10]*A,de=F[11]*A,ae=F[8]*P,me=F[9]*P,xe=F[10]*P,Ee=F[11]*P;for(const Ge of E){const Me=[],$e=[];for(const Ke of Ge){const Qe=Ke.x+L.x,at=Ke.y+L.y,ct=F[0]*Qe+F[4]*at+F[12],tt=F[1]*Qe+F[5]*at+F[13],rt=F[2]*Qe+F[6]*at+F[14],Ze=F[3]*Qe+F[7]*at+F[15],qe=ct+$,ot=tt+X,yt=rt+Q,ft=Math.max(Ze+de,1e-5),Nt=ct+ae,Et=tt+me,Ct=rt+xe,Ot=Math.max(Ze+Ee,1e-5);Me.push(new Bu(qe/ft,ot/ft,yt/ft)),$e.push(new Bu(Nt/Ot,Et/Ot,Ct/Ot))}U.push(Me),V.push($e)}return[U,V]})(e,i,s,a,u)}function X1(r,e,i,s,a,u,h,f){const g=h*a.getElevationAt(r,e,!0,!0),x=u[0]!==0,T=x?u[1]===0?h*(u[0]/A1-C1):h*(function(E,A,P){const L=Math.floor(A[0]/8),F=Math.floor(A[1]/8),U=10*(A[0]-8*L),V=10*(A[1]-8*F),$=E.getElevationAt(L,F,!0,!0),X=E.getMeterToDEM(P),Q=Math.floor(.5*(U*X-1)),de=Math.floor(.5*(V*X-1)),ae=E.tileCoordToPixel(L,F),me=2*Q+1,xe=2*de+1,Ee=(function(at,ct,tt,rt,Ze){return[at.getElevationAtPixel(ct,tt,!0),at.getElevationAtPixel(ct+Ze,tt,!0),at.getElevationAtPixel(ct,tt+Ze,!0),at.getElevationAtPixel(ct+rt,tt+Ze,!0)]})(E,ae.x-Q,ae.y-de,me,xe),Ge=Math.abs(Ee[0]-Ee[1]),Me=Math.abs(Ee[2]-Ee[3]),$e=Math.abs(Ee[0]-Ee[2])+Math.abs(Ee[1]-Ee[3]),Ke=Math.min(.25,.5*X*(Ge+Me)/me),Qe=Math.min(.25,.5*X*$e/xe);return $+Math.max(Ke*U,Qe*V)})(a,u,f):g;return{base:g+(i===0?-1:i),top:x?Math.max(T+s,g+i+2):g+s}}class EI{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class SI{constructor(){this.tasks={},this.taskQueue=[],Pe(["process"],this),this.invoker=new EI(this.process),this.nextId=0}add(e,i){const s=this.nextId++,a=(function({type:u,isSymbolTile:h,zoom:f}){return f=f||0,u==="message"?0:u!=="maybePrepare"||h?u!=="parseTile"||h?u==="parseTile"&&h?300-f:u==="maybePrepare"&&h?400-f:500:200-f:100-f})(i);return a===0?(e(),null):(this.tasks[s]={fn:e,metadata:i,priority:a,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}})}process(){{if(this.taskQueue=this.taskQueue.filter((s=>!!this.tasks[s])),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}}pick(){let e=null,i=1/0;for(let a=0;a<this.taskQueue.length;a++){const u=this.tasks[this.taskQueue[a]];u.priority<i&&(i=u.priority,e=a)}if(e===null)return null;const s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}class Y1{constructor(e,i,s){this.target=e,this.parent=i,this.mapId=s,this.callbacks={},this.cancelCallbacks={},Pe(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new SI}send(e,i,s,a,u=!1,h){const f=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=h,this.callbacks[f]=s);const g=new Set;return this.target.postMessage({id:f,type:e,hasCallback:!!s,targetMapId:a,mustQueue:u,sourceMapId:this.mapId,data:ga(i,g)},g),{cancel:()=>{s&&delete this.callbacks[f],this.target.postMessage({id:f,type:"<cancel>",targetMapId:a,sourceMapId:this.mapId})}}}receive(e){const i=e.data;if(!i)return;const s=i.id;if(s&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const a=this.cancelCallbacks[s];delete this.cancelCallbacks[s],a&&a.cancel()}else if(i.mustQueue||Ui(self)){const a=this.callbacks[s],u=this.scheduler.add((()=>this.processTask(s,i)),a&&a.metadata||{type:"message"});u&&(this.cancelCallbacks[s]=u)}else this.processTask(s,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const s=this.callbacks[e];delete this.callbacks[e],s&&(i.error?s(rl(i.error)):s(null,rl(i.data)))}else{const s=new Set,a=i.hasCallback?(h,f)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:h?ga(h):null,data:ga(f,s)},s)}:()=>{},u=rl(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,u,a);else if(this.parent.getWorkerSource){const h=i.type.split("."),{source:f,scope:g}=u;this.parent.getWorkerSource(i.sourceMapId,h[0],f,g)[h[1]](u,a)}else a(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var bp={workerUrl:"",workerClass:null,workerParams:void 0};const rv="mapboxgl_preloaded_worker_pool";class Nu{constructor(e){this.active={},this.name=e}acquire(e,i=Nu.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;){const a=(s=`${this.name||""}WorkerPool: ${e}-${this.workers.length}`,bp.workerClass!=null?new bp.workerClass:new self.Worker(bp.workerUrl,Object.assign({name:s},bp.workerParams)));this.workers.push(a)}var s;return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach((i=>{i.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[rv]}numActive(){return Object.keys(this.active).length}}Nu.workerCount=2;class wd{constructor(e,i,s="Worker",a=Nu.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Ie();const u=this.workerPool.acquire(this.id,a);for(let h=0;h<u.length;h++){const f=new wd.Actor(u[h],i,this.id);f.name=`${s} ${h}`,this.actors.push(f)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(e,i,s){be(this.actors,((a,u)=>{a.send(e,i,u)}),s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((e=>{e.remove()})),this.actors=[],this.workerPool.release(this.id)}}let wp,nv;function F_(){return wp||(wp=new Nu),wp}wd.Actor=Y1;const ov=4096;class II{constructor(e){this.module=e,this.memoryStack=this.module.malloc(ov),this.memoryStackNextFree=this.memoryStack}createIntArray(e){const i=this.memoryStackNextFree;return this.memoryStackNextFree+=e.length*Int32Array.BYTES_PER_ELEMENT,this.memoryStackNextFree-this.memoryStack>ov?-1:(new Int32Array(this.module.heap32.buffer,i,e.length).set(e),i)}createFloatArray(e){const i=this.memoryStackNextFree;return this.memoryStackNextFree+=e.length*Float32Array.BYTES_PER_ELEMENT,this.memoryStackNextFree-this.memoryStack>ov?-1:(new Float32Array(this.module.heapF32.buffer,i,e.length).set(e),i)}readStringBuffer(e){let i="";for(;this.module.heapU8[e]!==0;)i+=String.fromCharCode(this.module.heapU8[e]),++e;return i}setStyle(e){const i=e.normalScale;this.module.setStyle(i[0],i[1],i[2],e.tileToMeters)}setAOOptions(e,i){this.module.setAOOptions(e?1:0,i)}setMetricOptions(e,i){this.module.setMetricOptions(e?1:0,i)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,i){this.module.setFacadeOptions(e,i?1:0)}setFauxFacadeOptions(e,i,s){this.module.setFauxFacadeOptions(e?1:0,i?1:0,s)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,i){this.memoryStackNextFree=this.memoryStack;for(const f of e){const g=this.createIntArray(f.ringIndices),x=this.createFloatArray(f.coordinates);if(g===-1||x===-1)return`building_gen: Out of stack memory: ${this.memoryStackNextFree-this.memoryStack}/4096`;this.module.addFeature(f.id,f.sourceId,f.minHeight,f.height,f.roofType,x,g,f.ringIndices.length-1)}for(const f of i){let g;g=f.entrances?JSON.parse(f.entrances):[];const x=this.createFloatArray(g),T=this.createFloatArray(f.coordinates);if(x===-1||T===-1)return`building_gen: Out of stack memory: ${this.memoryStackNextFree-this.memoryStack}/4096`;this.module.addFacade(f.sourceId,f.crossPerc,f.distanceToRoad,x,g.length,T,f.coordinates.length)}if(!this.module.generateMesh()){const f=this.module.getLastError();return this.readStringBuffer(f)}const s=this.module.getMeshCount(),a=new Array(s);for(let f=0;f<s;f++){const g=this.module.getPositionsPtr(f),x=this.module.getPositionsLength(f),T=new Float32Array(this.module.heapF32.buffer,g,x),E=this.module.getNormalsPtr(f),A=this.module.getNormalsLength(f),P=new Float32Array(this.module.heapF32.buffer,E,A),L=this.module.getAOPtr(f),F=this.module.getAOLength(f),U=new Float32Array(this.module.heapF32.buffer,L,F),V=this.module.getUVPtr(f),$=this.module.getUVLength(f),X=new Float32Array(this.module.heapF32.buffer,V,$),Q=this.module.getFauxFacadePtr(f),de=this.module.getFauxFacadeLength(f),ae=new Uint8Array(this.module.heapU8.buffer,Q,de),me=this.module.getIndicesPtr(f),xe=this.module.getIndicesLength(f),Ee=new Int16Array(this.module.heap16.buffer,me,xe),Ge=this.module.getBuildingPart(f);a[f]={positions:T,normals:P,ao:U,uv:X,isFauxFacade:ae,indices:Ee,buildingPart:Ge}}const u=this.module.getRingCount(),h=[];for(let f=0;f<u;f++){const g=this.module.getRingPtr(f),x=this.module.getRingLength(f),T=new Float32Array(this.module.heapF32.buffer,g,x);h.push(T)}return{meshes:a,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:h}}}let Tp,sv,Ma,Td,av,Ed=null,Sd=null,J1=null,B_=null;function K1(){return Ui(self)&&self.worker.dracoUrl?self.worker.dracoUrl:sv||Ri.DRACO_URL}function Q1(){if(Ui(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Td)return Td;const r=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Td=WebAssembly.validate(r)?Ri.MESHOPT_SIMD_URL:Ri.MESHOPT_URL,Td}function AI(){return B_}const N_={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},CI={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Ep={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function eb(r,e,i){const s=i.json.bufferViews.length,a=i.buffers.length;e.bufferView=s,i.json.bufferViews[s]={buffer:a,byteLength:r.byteLength},i.buffers[a]=r}const lv="KHR_draco_mesh_compression";function MI(r,e){const i=r.extensions&&r.extensions[lv];if(!i)return;const s=new Ma.Decoder,a=nb(e,i.bufferView),u=new Ma.Mesh;if(!s.DecodeArrayToMesh(a,a.byteLength,u))throw new Error("Failed to decode Draco mesh");const h=e.json.accessors[r.indices],f=N_[h.componentType],g=h.count*f.BYTES_PER_ELEMENT,x=Ma._malloc(g);f===Uint16Array?s.GetTrianglesUInt16Array(u,g,x):s.GetTrianglesUInt32Array(u,g,x),eb(Ma.memory.buffer.slice(x,x+g),h,e),Ma._free(x);for(const T of Object.keys(i.attributes)){const E=s.GetAttributeByUniqueId(u,i.attributes[T]),A=e.json.accessors[r.attributes[T]],P=CI[A.componentType],L=A.count*Ep[A.type]*N_[A.componentType].BYTES_PER_ELEMENT,F=Ma._malloc(L);s.GetAttributeDataArrayForAllPoints(u,E,Ma[P],L,F),eb(Ma.memory.buffer.slice(F,F+L),A,e),Ma._free(F)}s.destroy(),u.destroy(),delete r.extensions[lv]}const V_="EXT_meshopt_compression";function PI(r,e){if(!r.extensions||!r.extensions[V_])return;const i=r.extensions[V_],s=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),a=new Uint8Array(i.count*i.byteStride);av.decodeGltfBuffer(a,i.count,i.byteStride,s,i.mode,i.filter),r.buffer=e.buffers.length,r.byteOffset=0,e.buffers[r.buffer]=a.buffer,delete r.extensions[V_]}const tb=1179937895,ib=new TextDecoder("utf8");function rb(r,e){return new URL(r,e).href}function LI(r,e,i,s){return fetch(rb(r.uri,s)).then((a=>a.arrayBuffer())).then((a=>{e.buffers[i]=a}))}function nb(r,e){const i=r.json.bufferViews[e];return new Uint8Array(r.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function RI(r,e,i,s){if(r.uri){const a=rb(r.uri,s);return fetch(a).then((u=>u.blob())).then((u=>createImageBitmap(u))).then((u=>{e.images[i]=u}))}if(r.bufferView!==void 0){const a=nb(e,r.bufferView),u=new Blob([a],{type:r.mimeType});return createImageBitmap(u).then((h=>{e.images[i]=h}))}}function ob(r,e=0,i){const s={json:null,images:[],buffers:[]};if(new Uint32Array(r,e,1)[0]===tb){const T=new Uint32Array(r,e);let E=2;const A=(T[E++]>>2)-3,P=T[E++]>>2;if(E++,s.json=JSON.parse(ib.decode(T.subarray(E,E+P))),E+=P,E<A){const L=T[E++];E++;const F=e+(E<<2);s.buffers[0]=r.slice(F,F+L)}}else s.json=JSON.parse(ib.decode(new Uint8Array(r,e)));const{buffers:a,images:u,meshes:h,extensionsUsed:f,bufferViews:g}=s.json;let x=Promise.resolve();if(a){const T=[];for(let E=0;E<a.length;E++){const A=a[E];A.uri?T.push(LI(A,s,E,i)):s.buffers[E]||(s.buffers[E]=null)}x=Promise.all(T)}return x.then((()=>{const T=[],E=f&&f.includes(lv),A=f&&f.includes(V_);if(E&&T.push((function(){if(!Ma)return Tp??(Tp=(function(P){let L,F=null;function U(){L=new Uint8Array(F.buffer)}function V(){throw new Error("Unexpected Draco error.")}const $={a:{a:V,d:function(X,Q,de){return L.copyWithin(X,Q,Q+de)},c:function(X){const Q=L.length,de=Math.max(X>>>0,Math.ceil(1.2*Q)),ae=Math.ceil((de-Q)/65536);try{return F.grow(ae),U(),!0}catch{return!1}},b:V}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(P,$):P.then((X=>X.arrayBuffer())).then((X=>WebAssembly.instantiate(X,$)))).then((X=>{const{Rb:Q,Qb:de,P:ae,T:me,X:xe,Ja:Ee,La:Ge,Qa:Me,Va:$e,Wa:Ke,eb:Qe,jb:at,f:ct,e:tt,yb:rt,zb:Ze,Ab:qe,Bb:ot,Db:yt,Gb:ft}=X.instance.exports;F=tt;const Nt=(()=>{let Et=0,Ct=0,Ot=0,Ii=0;return pt=>{Ot&&(Q(Ii),Q(Et),Ct+=Ot,Ot=Et=0),Et||(Ct+=128,Et=de(Ct));const zt=pt.length+7&-8;let oi=Et;zt>=Ct&&(Ot=zt,oi=Ii=de(zt));for(let Oi=0;Oi<pt.length;Oi++)L[oi+Oi]=pt[Oi];return oi}})();return U(),ct(),{memory:tt,_free:Q,_malloc:de,Mesh:class{constructor(){this.ptr=ae()}destroy(){me(this.ptr)}},Decoder:class{constructor(){this.ptr=Ee()}destroy(){at(this.ptr)}DecodeArrayToMesh(Et,Ct,Ot){const Ii=Nt(Et),pt=Ge(this.ptr,Ii,Ct,Ot.ptr);return!!xe(pt)}GetAttributeByUniqueId(Et,Ct){return{ptr:Me(this.ptr,Et.ptr,Ct)}}GetTrianglesUInt16Array(Et,Ct,Ot){$e(this.ptr,Et.ptr,Ct,Ot)}GetTrianglesUInt32Array(Et,Ct,Ot){Ke(this.ptr,Et.ptr,Ct,Ot)}GetAttributeDataArrayForAllPoints(Et,Ct,Ot,Ii,pt){Qe(this.ptr,Et.ptr,Ct.ptr,Ot,Ii,pt)}},DT_INT8:rt(),DT_UINT8:Ze(),DT_INT16:qe(),DT_UINT16:ot(),DT_UINT32:yt(),DT_FLOAT32:ft()}}))})(fetch(K1())),Tp.then((P=>{Ma=P,Tp=void 0})))})()),A&&T.push((function(){if(av)return;const P=(function(L){let F;const U=WebAssembly.instantiateStreaming(L,{}).then((X=>{F=X.instance,F.exports.__wasm_call_ctors()})),V={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},$={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:U,supported:!0,decodeGltfBuffer(X,Q,de,ae,me,xe){(function(Ee,Ge,Me,$e,Ke,Qe,at){const ct=Ee.exports.sbrk,tt=$e+3&-4,rt=ct(tt*Ke),Ze=ct(Qe.length),qe=new Uint8Array(Ee.exports.memory.buffer);qe.set(Qe,Ze);const ot=Ge(rt,$e,Ke,Ze,Qe.length);if(ot===0&&at&&at(rt,tt,Ke),Me.set(qe.subarray(rt,rt+$e*Ke)),ct(rt-ct(0)),ot!==0)throw new Error(`Malformed buffer data: ${ot}`)})(F,F.exports[$[me]],X,Q,de,ae,F.exports[V[xe]])}}})(fetch(Q1()));return P.ready.then((()=>{av=P}))})()),u)for(let P=0;P<u.length;P++)T.push(RI(u[P],s,P,i));return(T.length?Promise.all(T):Promise.resolve()).then((()=>{if(E&&h)for(const{primitives:P}of h)for(const L of P)MI(L,s);if(A&&h&&g)for(const P of g)PI(P,s);return s}))}))}function sb(r){return fetch(r).then((e=>e.arrayBuffer())).then((e=>ob(e,0,r)))}function cv(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function uv(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class hv{constructor(e,i,s,a){this.context=e,this.format=s,this.useMipmap=a&&a.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:a&&a.premultiply})}update(e,i){const s=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,a=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:u}=this,{gl:h}=u,{x:f,y:g}=i&&i.position?i.position:{x:0,y:0},x=f+s,T=g+a;!this.size||this.size[0]===x&&this.size[1]===T||(h.bindTexture(h.TEXTURE_2D,null),h.deleteTexture(this.texture),this.texture=h.createTexture(),this.size=null),h.bindTexture(h.TEXTURE_2D,this.texture),u.pixelStoreUnpackFlipY.set(!1),u.pixelStoreUnpack.set(1),u.pixelStoreUnpackPremultiplyAlpha.set(this.format===h.RGBA8&&(!i||i.premultiply!==!1));const E=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&x>0&&T>0){const A=this.useMipmap?Math.floor(Math.log2(Math.max(x,T)))+1:1;h.texStorage2D(h.TEXTURE_2D,A,this.format,x,T),this.size=[x,T]}this.size&&(E?h.texSubImage2D(h.TEXTURE_2D,0,f,g,cv(this.format),uv(this.format),e):"data"in e&&e.data&&h.texSubImage2D(h.TEXTURE_2D,0,f,g,s,a,cv(this.format),uv(this.format),e.data)),this.useMipmap&&h.generateMipmap(h.TEXTURE_2D)}bind(e,i,s=!1){const{context:a}=this,{gl:u}=a;u.bindTexture(u.TEXTURE_2D,this.texture),e!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,e),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,this.useMipmap&&!s?e===u.NEAREST?u.NEAREST_MIPMAP_NEAREST:u.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,i),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,s,a,u){const{context:h}=this,{gl:f}=h;f.bindTexture(f.TEXTURE_2D,this.texture),i!==this.magFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,this.useMipmap?e===f.NEAREST?f.NEAREST_MIPMAP_NEAREST:f.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),s!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,s),this.wrapS=s),a!==this.wrapT&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,a),this.wrapT=a),u!==this.compareMode&&(u?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_MODE,f.COMPARE_REF_TO_TEXTURE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_FUNC,u)):f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_MODE,f.NONE),this.compareMode=u)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Sp{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:s}=this,{gl:a}=s;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapS=i)}}const DI=Ci([{name:"a_pos_3f",components:3,type:"Float32"}]),OI=Ci([{name:"a_color_3f",components:3,type:"Float32"}]),zI=Ci([{name:"a_color_4f",components:4,type:"Float32"}]),kI=Ci([{name:"a_uv_2f",components:2,type:"Float32"}]),FI=Ci([{name:"a_normal_3f",components:3,type:"Float32"}]),BI=Ci([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),NI=Ci([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function ab(r,e){const i=U_(r.projection,r.zoom,r.width,r.height),s=(function(u,h,f,g,x){const T=new n(f.lng-180*Rc,f.lat),E=new n(f.lng+180*Rc,f.lat),A=u.project(T.lng,T.lat),P=u.project(E.lng,E.lat),L=-Math.atan2(P.y-A.y,P.x-A.x),F=Y.fromLngLat(f);F.y=j(F.y,-1+Rc,1-Rc);const U=F.toLngLat(),V=u.project(U.lng,U.lat),$=Y.fromLngLat(U);$.x+=Rc;const X=$.toLngLat(),Q=u.project(X.lng,X.lat),de=cb(Q.x-V.x,Q.y-V.y,L),ae=Y.fromLngLat(U);ae.y+=Rc;const me=ae.toLngLat(),xe=u.project(me.lng,me.lat),Ee=cb(xe.x-V.x,xe.y-V.y,L),Ge=Math.abs(de.x)/Math.abs(Ee.y),Me=K([]);Ye(Me,Me,-L*(1-(x?0:g)));const $e=K([]);return Ae($e,$e,[1,1-(1-Ge)*g,1]),$e[4]=-Ee.x/Ee.y*g,Ye($e,$e,L),Le($e,Me,$e),$e})(r.projection,0,r.center,i,e),a=lb(r);return Ae(s,s,[a,a,1]),s}function lb(r){const e=r.projection,i=U_(r.projection,r.zoom,r.width,r.height),s=dv(e,r.center),a=dv(e,n.convert(e.center));return Math.pow(2,s*i+(1-i)*a)}function U_(r,e,i,s,a=1/0){const u=r.range;if(!u)return 0;const h=Math.min(a,Math.max(i,s)),f=Math.log2(h/1024);return W(u[0]+f,u[1]+f,e)}const Rc=1/4e4;function dv(r,e){const i=j(e.lat,-z,z),s=new n(e.lng-180*Rc,i),a=new n(e.lng+180*Rc,i),u=r.project(s.lng,i),h=r.project(a.lng,i),f=Y.fromLngLat(s),g=Y.fromLngLat(a),x=h.x-u.x,T=h.y-u.y,E=g.x-f.x,A=g.y-f.y,P=Math.sqrt((E*E+A*A)/(x*x+T*T));return Math.log2(P)}function cb(r,e,i){const s=Math.cos(i),a=Math.sin(i);return{x:r*s-e*a,y:r*a+e*s}}function ub(r,e,i){K(r),Ye(r,r,Yi(e[2])),ze(r,r,Yi(e[0])),Fe(r,r,Yi(e[1])),Ae(r,r,i),Le(r,r,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function j_(r,e,i,s,a,u,h,f){const g=[i[0]-e[0],i[1]-e[1],0],x=[s[0]-e[0],s[1]-e[1],0];if(rr(g)<1e-12||rr(x)<1e-12)return tc(r);const T=wr([],g,x);ui(T,T),jr(x,s,e),g[2]=(u-a)*f,x[2]=(h-a)*f;const E=g;return wr(E,g,x),ui(E,E),ic(r,T,E)}function G_(r,e,i=!1){const s=Pc(e.zoom),a=(function(u,h,f){const g=h.worldSize,x=[u[12],u[13],u[14]],T=O(x[1]/g),E=C(x[0]/g),A=K([]),P=I(1,T)*g,L=I(1,0)*g*B(T,h.zoom),F=1/Uy(g);let U=L*F;if(f){const Q=U_(h.projection,h.zoom,h.width,h.height,1024);U=F*h.projection.pixelSpaceConversion(h.center.lat,g,Q)}const V=Ac(T,E);Bi(V,V,yr([],ui([],V),P*U*x[2]));const $=(function(Q){const de=[Q[0],Q[1],Q[2]];let ae=[0,1,0];const me=wr([],ae,de);return wr(ae,de,me),si(ae)===0&&(ae=[0,1,0],wr(me,de,ae)),ui(me,me),ui(ae,ae),ui(de,de),[me[0],me[1],me[2],0,ae[0],ae[1],ae[2],0,de[0],de[1],de[2],0,Q[0],Q[1],Q[2],1]})(V);Ae(A,A,[U,U,U*P]),Oe(A,A,[-x[0],-x[1],-x[2]]);const X=Le([],h.globeMatrix,$);return Le(X,X,A),Le(X,X,u),X})(r,e,i);if(s>0){const u=(function(h,f){const g=f.worldSize,x=I(1,0)*g*B(f.center.lat,f.zoom)/Uy(g),T=I(1,f.center.lat)*g,E=K([]);Fe(E,E,Yi(f.center.lng)),ze(E,E,Yi(f.center.lat)),Oe(E,E,[0,0,eo]),Ae(E,E,[x,x,x*T]);const A=f.point;return Oe(E,E,[-A.x,-A.y,0]),Le(E,E,h),Le(E,f.globeMatrix,E)})(r,e);return(function(h,f,g){const x=(L,F,U)=>{const V=rr(L),$=rr(F),X=Ca(L,F,U);return yr(X,X,1/rr(X)*ei(V,$,U))},T=x([h[0],h[1],h[2]],[f[0],f[1],f[2]],g),E=x([h[4],h[5],h[6]],[f[4],f[5],f[6]],g),A=x([h[8],h[9],h[10]],[f[8],f[9],f[10]],g),P=Ca([h[12],h[13],h[14]],[f[12],f[13],f[14]],g);return[T[0],T[1],T[2],0,E[0],E[1],E[2],0,A[0],A[1],A[2],0,P[0],P[1],P[2],1]})(a,u,s)}return a}function fv(r,e,i,s){const a=Ft.projectAabbCorners(s,i);let u=Number.MAX_VALUE;for(let f=0;f<a.length;++f){const g=a[f];g[0]=(.5*g[0]+.5)*e.width,g[1]=(.5-.5*g[1])*e.height,g[2]<u&&(u=g[2])}const h=(function(f){const g=[];let x=0;for(let P=1;P<f.length;P++)(f[P][0]<f[x][0]||f[P][0]===f[x][0]&&f[P][1]<f[x][1])&&(x=P);let T,E=x;const A=new Uint8Array(f.length);do{if(A[E])break;g.push(new st(f[E][0],f[E][1])),A[E]=1,T=(E+1)%f.length;for(let P=0;P<f.length;P++){if(f[P][0]===f[T][0]&&f[P][1]===f[T][1]||f[P][0]===f[E][0]&&f[P][1]===f[E][1])continue;const L=[f[P][0]-f[E][0],f[P][1]-f[E][1]],F=[f[T][0]-f[E][0],f[T][1]-f[E][1]],U=L[0]*F[1]-L[1]*F[0];(U>0||U===0&&L[0]*F[0]+L[1]*F[1]>=0&&L[0]*L[0]+L[1]*L[1]>F[0]*F[0]+F[1]*F[1])&&(T=P)}E=T}while(E!==x);return g.length>0&&g.push(g[0]),g})(a);if(Xi(r,h))return u}const Vu=64,Id={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function q_(r,e,i,s,a,u,h,f,g,x=!1){const T=i.zoom,E=i.project(s),A=B(s.lat,T),P=1/A;K(r),Oe(r,r,[E.x+h[0]*P,E.y+h[1]*P,h[2]]);let L=1,F=1;const U=i.worldSize;if(x){if(i.projection.name==="mercator"){let Q=0;i.elevation&&(Q=i.elevation.getAtPointOrZero(new Y(E.x/U,E.y/U),0));const de=Jn([],[E.x,E.y,Q,1],i.projMatrix)[3]/i.cameraToCenterDistance;L=de,F=de*B(i.center.lat,T)}else if(i.projection.name==="globe"){const Q=G_(r,i),de=[0,0,0,1];Jn(de,de,Le([],i.projMatrix,Q));const ae=de[3]/i.cameraToCenterDistance,me=Pc(T),xe=i.projection.pixelsPerMeter(s.lat,U)*B(s.lat,T),Ee=i.projection.pixelsPerMeter(i.center.lat,U)*B(i.center.lat,T);L=ae/ei(xe,N(i.center.lat),me),F=ae*A/xe,L*=Ee,F*=Ee}}else L=P;Ae(r,r,[L,L,F]);const V=[...r],$=e.orientation,X=[];if(ub(X,[$[0]+(a?a[0]:0),$[1]+(a?a[1]:0),$[2]+(a?a[2]:0)],u),Le(r,V,X),f&&i.elevation){let Q=0;const de=[];if(g&&i.elevation){Q=(function(me,xe,Ee,Ge,Me){const $e=xe.elevation;if(!$e)return 0;const Ke=Ft.projectAabbCorners(Ee,Ge),Qe=I(1,Me.lat)*xe.worldSize,at=(function(Ct,Ot){const Ii=[0,0,1],pt=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const zt of pt){const oi=Ct[zt.corners[0]],Oi=Ct[zt.corners[1]],Ni=Ct[zt.corners[2]],pi=[Oi[0]-oi[0],Oi[1]-oi[1],Ot*(Oi[2]-oi[2])],pr=wr(pi,pi,[Ni[0]-oi[0],Ni[1]-oi[1],Ot*(Ni[2]-oi[2])]);ui(pr,pr),zt.dotProductWithUp=ki(pr,Ii)}return pt.sort(((zt,oi)=>zt.dotProductWithUp-oi.dotProductWithUp)),pt[0].corners})(Ke,Qe),ct=Ke[at[0]],tt=Ke[at[1]],rt=Ke[at[2]],Ze=Ke[at[3]],qe=$e.getAtPointOrZero(new Y(ct[0]/xe.worldSize,ct[1]/xe.worldSize),0),ot=$e.getAtPointOrZero(new Y(tt[0]/xe.worldSize,tt[1]/xe.worldSize),0),yt=$e.getAtPointOrZero(new Y(rt[0]/xe.worldSize,rt[1]/xe.worldSize),0),ft=$e.getAtPointOrZero(new Y(Ze[0]/xe.worldSize,Ze[1]/xe.worldSize),0),Nt=(qe+ft)/2,Et=(ot+yt)/2;return Nt>Et?ot<yt?j_(me,tt,Ze,ct,ot,ft,qe,Qe):j_(me,rt,ct,Ze,yt,qe,ft,Qe):qe<ft?j_(me,ct,tt,rt,qe,ot,yt,Qe):j_(me,Ze,rt,tt,ft,yt,ot,Qe),Math.max(Nt,Et)})(de,i,e.aabb,r,s);const ae=Le([],li([],de),X);Le(r,V,ae)}else Q=i.elevation.getAtPointOrZero(new Y(E.x/U,E.y/U),0);Q!==0&&(r[14]+=Q)}}class hb{constructor(e,i,s,a,u){this.materialOverrides=new Map,this.nodeOverrides=new Map,this.materialOverrideNames=[],this.nodeOverrideNames=[],this.featureProperties={},this.id=e,this.uri=i,this.position=s!=null?new n(s[0],s[1]):new n(0,0),this.orientation=a??[0,0,0],this.nodes=u,this.uploaded=!1,this.aabb=new Ft([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(e,i){Le(e.globalMatrix,i,e.localMatrix);const s=this.nodeOverrides.get(e.name);if(s!==void 0){const h=[];u=s.orientation,K(a=h),Fe(a,a,Yi(u[1])),Ye(a,a,Yi(u[2])),ze(a,a,Yi(u[0])),Le(e.globalMatrix,e.globalMatrix,h)}var a,u;if(e.meshes)for(const h of e.meshes){const f=Ft.applyTransformFast(h.aabb,e.globalMatrix);this.aabb.encapsulate(f)}if(e.children)for(const h of e.children)this._applyTransformations(h,e.globalMatrix)}computeBoundsAndApplyParent(){const e=K([]);this.aabb=new Ft([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const i of this.nodes)this._applyTransformations(i,e)}computeModelMatrix(e,i,s,a,u,h,f=!1){q_(this.matrix,this,e.transform,this.position,i,s,a,u,h,f)}upload(e){if(!this.uploaded){for(const i of this.nodes)pv(i,e);for(const i of this.nodes)H_(i);this.uploaded=!0}}destroy(){for(const e of this.nodes)mv(e)}}function Ip(r,e,i=!1){r.uploaded||(r.gfxTexture=new hv(e,r.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:r.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),r.uploaded=!0,r.image=null)}function VI(r,e,i){r.indexBuffer=e.createIndexBuffer(r.indexArray,!1,!0),r.vertexBuffer=e.createVertexBuffer(r.vertexArray,DI.members,!1,!0),r.normalArray&&(r.normalBuffer=e.createVertexBuffer(r.normalArray,FI.members,!1,!0)),r.texcoordArray&&(r.texcoordBuffer=e.createVertexBuffer(r.texcoordArray,kI.members,!1,!0)),r.colorArray&&(r.colorBuffer=e.createVertexBuffer(r.colorArray,(r.colorArray.bytesPerElement===12?OI:zI).members,!1,!0)),r.featureArray&&(r.pbrBuffer=e.createVertexBuffer(r.featureArray,NI.members,!0)),r.segments=Fr.simpleSegment(0,0,r.vertexArray.length,r.indexArray.length);const s=r.material;s.pbrMetallicRoughness.baseColorTexture&&Ip(s.pbrMetallicRoughness.baseColorTexture,e),s.pbrMetallicRoughness.metallicRoughnessTexture&&Ip(s.pbrMetallicRoughness.metallicRoughnessTexture,e),s.normalTexture&&Ip(s.normalTexture,e),s.occlusionTexture&&Ip(s.occlusionTexture,e,i),s.emissionTexture&&Ip(s.emissionTexture,e)}function pv(r,e,i){if(r.meshes)for(const s of r.meshes)VI(s,e,i);if(r.children)for(const s of r.children)pv(s,e,i)}function H_(r){if(r.meshes)for(const e of r.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(r.children)for(const e of r.children)H_(e)}function mv(r){if(r.meshes)for(const i of r.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(r.children)for(const i of r.children)mv(i)}function Uu(r,e){const i=r.json.bufferViews[e.bufferView],s=N_[e.componentType];return new s(r.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==Ep[e.type]*s.BYTES_PER_ELEMENT?i.byteStride/s.BYTES_PER_ELEMENT:Ep[e.type]))}function _v(r,e,i,s){const a=N_[e.componentType],u=(function(T){switch(T){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}})(a),h=r.json.bufferViews[e.bufferView],f=h.byteStride?h.byteStride/a.BYTES_PER_ELEMENT:Ep[e.type],g=i.float32,x=g.length/i.capacity;for(let T=0,E=0;T<e.count*f;T+=f,E+=x)for(let A=0;A<x;A++)g[E+A]=s[T+A]*u;i._trim()}function UI(r,e,i){const s=r.indices,a=r.attributes,u={};u.indexArray=new xn;const h=e.json.accessors[s],f=h.count/3;u.indexArray.reserve(f);const g=Uu(e,h);for(let A=0;A<f;A++)u.indexArray.emplaceBack(g[3*A],g[3*A+1],g[3*A+2]);u.indexArray._trim(),u.vertexArray=new qo;const x=e.json.accessors[a.POSITION];u.vertexArray.reserve(x.count);const T=Uu(e,x);for(let A=0;A<x.count;A++)u.vertexArray.emplaceBack(T[3*A],T[3*A+1],T[3*A+2]);if(u.vertexArray._trim(),u.aabb=new Ft(x.min,x.max),u.centroid=(function(A,P){const L=[0,0,0],F=A.length;if(F>0){for(let U=0;U<F;U++){const V=3*A[U];L[0]+=P[V],L[1]+=P[V+1],L[2]+=P[V+2]}L[0]/=F,L[1]/=F,L[2]/=F}return L})(g,T),a.COLOR_0!==void 0){const A=e.json.accessors[a.COLOR_0],P=Ep[A.type],L=Uu(e,A);u.colorArray=P===3?new qo:new ol,u.colorArray.resize(A.count),_v(e,A,u.colorArray,L)}if(a.NORMAL!==void 0){u.normalArray=new qo;const A=e.json.accessors[a.NORMAL];u.normalArray.resize(A.count);const P=Uu(e,A);_v(e,A,u.normalArray,P)}if(a.TEXCOORD_0!==void 0&&i.length>0){u.texcoordArray=new Ks;const A=e.json.accessors[a.TEXCOORD_0];u.texcoordArray.resize(A.count);const P=Uu(e,A);_v(e,A,u.texcoordArray,P)}if(a._FEATURE_ID_RGBA4444!==void 0){const A=e.json.accessors[a._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(u.featureData=Uu(e,A))}a._FEATURE_RGBA4444!==void 0&&(u.featureData=new Uint32Array(Uu(e,e.json.accessors[a._FEATURE_RGBA4444]).buffer));const E=r.material;return u.material=(function(A,P){const{emissiveFactor:L=[0,0,0],alphaMode:F="OPAQUE",alphaCutoff:U=.5,normalTexture:V,occlusionTexture:$,emissiveTexture:X,doubleSided:Q,name:de}=A,{baseColorFactor:ae=[1,1,1,1],metallicFactor:me=1,roughnessFactor:xe=1,baseColorTexture:Ee,metallicRoughnessTexture:Ge}=A.pbrMetallicRoughness||{},Me=$?P[$.index]:void 0;if($&&$.extensions&&$.extensions.KHR_texture_transform&&Me){const $e=$.extensions.KHR_texture_transform;Me.offsetScale=[$e.offset[0],$e.offset[1],$e.scale[0],$e.scale[1]]}return{name:de,pbrMetallicRoughness:{baseColorFactor:new lr(...ae),metallicFactor:me,roughnessFactor:xe,baseColorTexture:Ee?P[Ee.index]:void 0,metallicRoughnessTexture:Ge?P[Ge.index]:void 0},doubleSided:Q,emissiveFactor:new lr(...L),alphaMode:F,alphaCutoff:U,normalTexture:V?P[V.index]:void 0,occlusionTexture:Me,emissionTexture:X?P[X.index]:void 0,defined:A.defined===void 0}})(E!==void 0?e.json.materials[E]:{defined:!1},i),u}function db(r,e,i){const{matrix:s,rotation:a,translation:u,scale:h,mesh:f,extras:g,children:x,name:T}=r,E={};if(E.name=T,E.localMatrix=s||(function(A,P,L,F){var U=P[0],V=P[1],$=P[2],X=P[3],Q=U+U,de=V+V,ae=$+$,me=U*Q,xe=U*de,Ee=U*ae,Ge=V*de,Me=V*ae,$e=$*ae,Ke=X*Q,Qe=X*de,at=X*ae,ct=F[0],tt=F[1],rt=F[2];return A[0]=(1-(Ge+$e))*ct,A[1]=(xe+at)*ct,A[2]=(Ee-Qe)*ct,A[3]=0,A[4]=(xe-at)*tt,A[5]=(1-(me+$e))*tt,A[6]=(Me+Ke)*tt,A[7]=0,A[8]=(Ee+Qe)*rt,A[9]=(Me-Ke)*rt,A[10]=(1-(me+Ge))*rt,A[11]=0,A[12]=L[0],A[13]=L[1],A[14]=L[2],A[15]=1,A})([],a||[0,0,0,1],u||[0,0,0],h||[1,1,1]),E.globalMatrix=ge(E.localMatrix),f!==void 0){E.meshes=i[f];const A=E.anchor=[0,0];for(const P of E.meshes){const{min:L,max:F}=P.aabb;A[0]+=L[0]+F[0],A[1]+=L[1]+F[1]}A[0]=Math.floor(A[0]/E.meshes.length/2),A[1]=Math.floor(A[1]/E.meshes.length/2)}if(g&&(g.id&&(E.id=g.id),g.lights&&(E.lights=(function(A){if(!A.length)return[];const P=(function($){const X=atob($),Q=new Uint8Array(X.length);for(let de=0;de<X.length;de++)Q[de]=X.codePointAt(de);return Q})(A),L=[],F=P.length/24,U=new Uint16Array(P.buffer),V=new Float32Array(P.buffer);for(let $=0;$<F;$++){const X=U[2*$*6]/30,Q=U[2*$*6+1]/30,de=U[2*$*6+10]/100,ae=V[6*$+1],me=V[6*$+2],xe=V[6*$+3],Ee=V[6*$+4],Ge=xe-ae,Me=Ee-me,$e=Math.hypot(Ge,Me);L.push({pos:[ae+.5*Ge,me+.5*Me,Q],normal:[Me/$e,-Ge/$e,0],width:$e,height:X,depth:de,points:[ae,me,xe,Ee]})}return L})(g.lights)),g.MAPBOX_geometry_bloom&&(E.isGeometryBloom=g.MAPBOX_geometry_bloom)),x){const A=[];for(const P of x)A.push(db(e.json.nodes[P],e,i));E.children=A}return E}function jI(r){if(r.vertices.length===0||r.indices.length===0)return null;const e=new L_(r.vertices,r.indices,8,256),[i,s]=[e.min.clone(),e.max.clone()];return{vertices:r.vertices,indices:r.indices,grid:e,min:i,max:s}}function GI(r){if(!r.extras||!r.extras.ground)return null;const e=r.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const s=[];for(const h of i){if(!Array.isArray(h)||h.length!==2)continue;const f=h[0],g=h[1];typeof f=="number"&&typeof g=="number"&&s.push(new st(f,g))}if(s.length<3)return null;s.length>1&&s[s.length-1].equals(s[0])&&s.pop();let a=0;for(let h=0;h<s.length;h++){const f=s[h],g=s[(h+1)%s.length],x=s[(h+2)%s.length];a+=(f.x-g.x)*(x.y-g.y)-(x.x-g.x)*(f.y-g.y)}a>0&&s.reverse();const u=xd(s.flatMap((h=>[h.x,h.y])),[]);return u.length===0?null:{vertices:s,indices:u}}function qI(r,e){const i=[],s=[];let a=0;const u=[];for(const h of r){a=i.length;const f=h.vertexArray.float32,g=h.indexArray.uint16;for(let x=0;x<h.vertexArray.length;x++)u[0]=f[3*x+0],u[1]=f[3*x+1],u[2]=f[3*x+2],kr(u,u,e),i.push(new st(u[0],u[1]));for(let x=0;x<3*h.indexArray.length;x++)s.push(g[x]+a)}if(s.length%3!=0)return null;for(let h=0;h<s.length;h+=3){const f=i[s[h+0]],g=i[s[h+1]],x=i[s[h+2]];(f.x-g.x)*(x.y-g.y)-(x.x-g.x)*(f.y-g.y)>0&&([s[h+1],s[h+2]]=[s[h+2],s[h+1]])}return{vertices:i,indices:s}}function gv(r){const e=(function(g,x){const T=[],E=WebGL2RenderingContext;if(g.json.textures)for(const A of g.json.textures){const P={magFilter:E.LINEAR,minFilter:E.NEAREST,wrapS:E.REPEAT,wrapT:E.REPEAT};A.sampler!==void 0&&Object.assign(P,g.json.samplers[A.sampler]),T.push({image:x[A.source],sampler:P,uploaded:!1})}return T})(r,r.images),i=(function(g,x){const T=[];for(const E of g.json.meshes){const A=[];for(const P of E.primitives)A.push(UI(P,g,x));T.push(A)}return T})(r,e),{scenes:s,scene:a,nodes:u}=r.json,h=s?s[a||0].nodes:[...u.keys()],f=[];for(const g of h)f.push(db(u[g],r,i));return(function(g,x,T){const E={},A=new Set;for(let P=0;P<g.length;P++){const L=T[x[P]];if(!L.extras)continue;const F=L.extras["mapbox:footprint:version"],U=L.extras["mapbox:footprint:id"];(F||U)&&A.add(P),F==="1.0.0"&&U&&(E[U]=P)}for(let P=0;P<g.length;P++){if(A.has(P))continue;const L=g[P],F=T[x[P]];if(!F.extras)continue;let U=null;L.id in E&&(U=qI(g[E[L.id]].meshes,L.localMatrix)),U||(U=GI(F)),U&&(L.footprint=jI(U))}if(A.size>0){const P=Array.from(A.values()).sort(((L,F)=>L-F));for(let L=P.length-1;L>=0;L--)g.splice(P[L],1)}})(f,h,r.json.nodes),f}function HI(r){r.heightmap=new Float32Array(4096),r.heightmap.fill(-1);const e=r.vertexArray.float32,i=r.aabb.min[0]-1,s=r.aabb.min[1]-1,a=Vu/(r.aabb.max[0]-i+2),u=Vu/(r.aabb.max[1]-s+2);for(let h=0;h<e.length;h+=3){const f=e[h+2],g=(e[h+0]-i)*a|0,x=(e[h+1]-s)*u|0;f>r.heightmap[x*Vu+g]&&(r.heightmap[x*Vu+g]=f)}}function fb(r,e,i,s,a){i.reserve(i.length+4*r.length),s.reserve(s.length+10*r.length),a.reserve(a.length+10*r.length);let u=s.length;for(const h of r){const f=Math.min(10,Math.max(4,1.3*h.height))*e,g=[-h.normal[1],h.normal[0],0],x=Math.min(.29,.1*h.width/h.depth),T=h.width-2*h.depth*e*(x+.01),E=qn([],h.pos,g,T/2),A=qn([],h.pos,g,-T/2),P=[E[0],E[1],E[2]+h.height],L=[A[0],A[1],A[2]+h.height],F=qn([],h.normal,g,x);yr(F,F,f);const U=qn([],h.normal,g,-x);yr(U,U,f),Bi(F,E,F),Bi(U,A,U),E[2]+=.1,A[2]+=.1,s.emplaceBack(F[0],F[1],F[2]),s.emplaceBack(U[0],U[1],U[2]),s.emplaceBack(E[0],E[1],E[2]),s.emplaceBack(A[0],A[1],A[2]),s.emplaceBack(P[0],P[1],P[2]),s.emplaceBack(L[0],L[1],L[2]),s.emplaceBack(E[0],E[1],E[2]),s.emplaceBack(A[0],A[1],A[2]),s.emplaceBack(F[0],F[1],F[2]),s.emplaceBack(U[0],U[1],U[2]);const V=T/f/2;a.emplaceBack(-V-x,-1,V,.8),a.emplaceBack(V+x,-1,V,.8),a.emplaceBack(-V,0,V,1.3),a.emplaceBack(V,0,V,1.3),a.emplaceBack(V+x,-.8,V,.7),a.emplaceBack(V+x,-.8,V,.7),a.emplaceBack(0,0,V,1.3),a.emplaceBack(0,0,V,1.3),a.emplaceBack(V+x,-1.2,V,.8),a.emplaceBack(V+x,-1.2,V,.8),i.emplaceBack(6+u,4+u,8+u),i.emplaceBack(7+u,9+u,5+u),i.emplaceBack(0+u,1+u,2+u),i.emplaceBack(1+u,3+u,2+u),u+=10}}function ZI(r,e){const i={};i.indexArray=new xn,i.vertexArray=new qo,i.colorArray=new ol,fb(r,e,i.indexArray,i.vertexArray,i.colorArray);const s={defined:!0};s.emissiveFactor=lr.black;const a={};return a.baseColorFactor=lr.white,s.pbrMetallicRoughness=a,i.material=s,i.aabb=new Ft([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}const pb=Ci([{name:"a_pos_3f",components:3,type:"Float32"}]),$I=Ci([{name:"a_normal_3",components:3,type:"Int16"}]),WI=Ci([{name:"a_centroid_3",components:3,type:"Int16"}]),mb=Ci([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),XI=Ci([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),YI=Ci([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),JI=Ci([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),KI=Ci([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),QI=Ci([{name:"a_flood_light_wall_radius_1i16",components:1,type:"Uint16"}]),_b=Se.types,Z_=32767;function eA(r,e){const i=gt+e;for(const s of r)for(const a of s)if(a.x<-e||a.x>i||a.y<-e||a.y>i)return!1;return!0}function tA(r){switch(r){case"flat":return 3;case"hipped":return 1;case"gabled":return 2;case"parapet":return 0;case"mansard":return 4;case"skillion":return 5;case"pyramidal":return 6;default:throw new Error(`Unknown roof shape: ${r}`)}}class yv{constructor(){this.layoutVertexArray=new qo,this.layoutAttenuationArray=new ol,this.layoutColorArray=new Ho,this.indexArray=new xn,this.indexArrayForConflation=new xn,this.segmentsBucket=new Fr}}class vv{constructor(e){this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.segmentsBucket=new Fr,this.entranceBloom=new yv;const i=66560;this.layoutVertexArray=new qo,this.layoutVertexArray.reserve(i),this.layoutNormalArray=new bc,this.layoutNormalArray.reserve(i),this.layoutCentroidArray=new bc,this.layoutCentroidArray.reserve(i),this.layoutColorArray=new Ho,this.layoutColorArray.reserve(i),this.layoutFloodLightDataArray=new sl,this.layoutFloodLightDataArray.reserve(i),this.layoutAOArray=new ld,this.layoutAOArray.reserve(i),this.indexArray=new xn,this.indexArray.reserve(66560),this.indexArrayForConflation=new xn,this.segmentsBucket=new Fr,this.entranceBloom=new yv,e&&(this.layoutFacadePaintArray=new Ho,this.layoutFacadeDataArray=new ql,this.layoutFacadeVerticalRangeArray=new Ho)}reserve(e,i,s){this.layoutVertexArray.reserveForAdditional(e),this.layoutCentroidArray.reserveForAdditional(e),this.layoutFloodLightDataArray.reserveForAdditional(e),this.layoutNormalArray.reserveForAdditional(e),this.layoutAOArray.reserveForAdditional(e),this.layoutColorArray.reserveForAdditional(e),this.indexArray.reserveForAdditional(i),s&&(this.layoutFacadePaintArray.reserveForAdditional(e),this.layoutFacadeDataArray.reserveForAdditional(e),this.layoutFacadeVerticalRangeArray.reserveForAdditional(e))}}class gb{constructor(e){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.footprintsVertices=new Ks,this.footprintsIndices=new sl,this.footprintsMin=new st(1/0,1/0),this.footprintsMax=new st(-1/0,-1/0),this.featuresOnBorder=[],this.buildingWithoutFacade=new vv(!1),this.buildingWithFacade=new vv(!0),this.indexArrayForConflationUploaded=!1,this.featureFootprintLookup=new Map,this.buildingIds=new Set,this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.lut=e.lut,this.programConfigurations=new As(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.projection=e.projection,this.groundEffect=new tv(e),this.groundEffect.groundRadiusArray=new ba,this.hasAppearances=null}updateFootprints(e,i){const s=new L_([],[],1),a={vertices:[],indices:new Uint32Array(0),grid:s,min:this.footprintsMin,max:this.footprintsMax,buildingIds:this.buildingIds};i.push({footprint:a,id:e})}updateAppearances(e,i,s,a){}prepare(){return(function(){if(B_!=null||J1!=null)return null;if(Sd!=null)return Sd;const e=fetch(Ri.BUILDING_GEN_URL);return Sd=(function(i){let s,a,u,h,f;function g(){s=new Uint8Array(f.buffer),a=new Int16Array(f.buffer),u=new Int32Array(f.buffer),h=new Float32Array(f.buffer)}function x(){throw new Error("Unexpected BuildingGen error.")}const T=()=>{},E={a:{a:x,f:function(A){const P=s.length,L=Math.max(A>>>0,Math.ceil(1.2*P)),F=Math.ceil((L-P)/65536);try{return f.grow(F),g(),!0}catch{return!1}},g:x,b:T,c:T,d:T,e:T}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(i,E):i.then((A=>A.arrayBuffer())).then((A=>WebAssembly.instantiate(A,E)))).then((A=>{const P=A.instance.exports;return(0,P.g)(),f=P.f,g(),new II({setStyle:P.h,setAOOptions:P.i,setMetricOptions:P.j,setStructuralOptions:P.k,setFacadeOptions:P.l,setFauxFacadeOptions:P.m,setFacadeClassifierOptions:P.n,addFeature:P.o,addFacade:P.p,generateMesh:P.q,getLastError:P.r,getOuterRingLength:P.s,getMeshCount:P.t,getPositionsPtr:P.u,getPositionsLength:P.v,getNormalsPtr:P.w,getNormalsLength:P.x,getAOPtr:P.y,getAOLength:P.z,getUVPtr:P.A,getUVLength:P.B,getFauxFacadePtr:P.C,getFauxFacadeLength:P.D,getIndicesPtr:P.E,getIndicesLength:P.F,getBuildingPart:P.G,getRingCount:P.H,getRingPtr:P.I,getRingLength:P.J,malloc:P.K,free:P.L,heapU8:s,heap16:a,heap32:u,heapF32:h})}))})(e).then((i=>(Sd=null,B_=i,B_))).catch((i=>{It("Could not load building-gen"),Sd=null,J1=i})),Sd})()}populate(e,i,s,a){const u=AI();if(!u)return;const h=q(s);this.tileToMeter=h,this.brightness=i.brightness,u.setStyle({normalScale:[1,-1,h],tileToMeters:h}),u.setAOOptions(!1,.3),u.setMetricOptions(!1,16),u.setStructuralOptions(!0),u.setFacadeClassifierOptions(3);const f=new Map,g=new Map;let x=0;for(const{feature:V}of e){if(_b[V.type]!=="LineString"){f.set(V.id,V.properties.source_id);continue}const $=this.layers[0]._featureFilter.needGeometry;if($&&!this.layers[0]._featureFilter.filter(new Ar(this.zoom),V,s))continue;const X=Ce(V,$);if(!$&&!this.layers[0]._featureFilter.filter(new Ar(this.zoom),X,s))continue;const Q=$?X.geometry:ye(V,s,a),de=[];for(const Ee of Q)for(const Ge of Ee)de.push(Ge.x),de.push(Ge.y);const ae={coordinates:de,crossPerc:V.properties.cross_perc,distanceToRoad:V.properties.distance_to_road,entrances:V.properties.entrances,sourceId:0},me=V.properties.source_id;let xe=g.get(me);xe||(xe=[],g.set(me,xe)),xe.push(ae),++x}this.maxHeight=0;const T=new Array,E=new Set,A=V=>{V!=null&&E.add(V)},P=(V,$)=>{V!=null&&T.push({buildingId:V,footprintIndex:$})},L=64*(e.length-x),F=L/2;this.buildingWithFacade.reserve(L,F,!0),this.buildingWithoutFacade.reserve(2*L,2*F,!1),this.footprintsIndices.reserve(16*(e.length-x)),this.footprintsVertices.reserve(8*(e.length-x));for(const{feature:V,id:$,index:X,sourceLayerIndex:Q}of e){if(_b[V.type]==="LineString")continue;const de=this.layers[0]._featureFilter.needGeometry;if(de&&!this.layers[0]._featureFilter.filter(new Ar(this.zoom),V,s))continue;let ae=null;if(V.properties&&V.properties.hasOwnProperty("building_id")&&(ae=V.properties.building_id,E.has(ae)))continue;const me=Ce(V,de);if(!de&&!this.layers[0]._featureFilter.filter(new Ar(this.zoom),me,s))continue;const xe=de?me.geometry:ye(V,s,a),Ee=mp(xe,500);let Ge=!1;for(const Kt of Ee)if(Kt.length!==1){Ge=!0;break}if(Ge){A(ae);continue}if(!eA(xe,163)){A(ae);continue}const Me=this.layers[0],$e=tA(Me.layout.get("building-roof-shape").evaluate(V,{},s)),Ke=Me.layout.get("building-base").evaluate(V,{},s),Qe=Me.layout.get("building-height").evaluate(V,{},s),at=Me.layout.get("building-flood-light-ground-radius").evaluate(V,{},s),ct=Me.paint.get("building-ambient-occlusion-intensity"),tt=at/this.tileToMeter;V.properties["building-part"]="roof";const rt=Me.paint.get("building-color").evaluate(V,{},this.canonical).toPremultipliedRenderColor(this.lut),Ze=Me.paint.get("building-emissive-strength").evaluate(V,{},this.canonical);V.properties["building-part"]="wall";const qe=Me.paint.get("building-color").evaluate(V,{},this.canonical).toPremultipliedRenderColor(this.lut),ot=Me.paint.get("building-emissive-strength").evaluate(V,{},this.canonical);V.properties["building-part"]="window";const yt=Me.paint.get("building-color").evaluate(V,{},this.canonical).toPremultipliedRenderColor(this.lut),ft=Me.paint.get("building-emissive-strength").evaluate(V,{},this.canonical);V.properties["building-part"]="door";const Nt=Me.paint.get("building-color").evaluate(V,{},this.canonical).toPremultipliedRenderColor(this.lut),Et=Me.paint.get("building-emissive-strength").evaluate(V,{},this.canonical);let Ct=Me.layout.get("building-flood-light-wall-radius").evaluate(V,{},s);Ct=j(Ct,0,2048);const Ot=Ct/2048*Z_,Ii=f.get($),pt=g.get(Ii)||[],zt=pt.length!==0&&Me.layout.get("building-facade").evaluate(V,{},s);u.setFacadeOptions(4,!0),u.setFauxFacadeOptions(zt,!1,1);let oi=0,Oi=0,Ni=0,pi=0,pr=0,le=0,fe=0,We=0,lt=0,bt=0,wt=0;if(zt){let Kt=Math.round(Me.layout.get("building-facade-floors").evaluate(V,{},s));if(Ke===0){Kt=Math.max(1,Kt-(pt.length>0?1:0));let hr=4;if(Qe>100){const Dr=[10,13,15];hr=Dr[V.id?V.id%Dr.length:0]}else Qe<=10&&(hr=3);u.setFacadeOptions(hr,!0),pr=(Qe<15?1.3:1.61803)*hr/h}else pr=Ke/h;le=Qe/h,pr=Math.min(pr,le),Ni=Me.layout.get("building-facade-unit-width").evaluate(V,{},s)/h,pi=(le-pr)/Kt,u.setFauxFacadeOptions(!0,!0,Ni);const Vr=Me.layout.get("building-facade-window").evaluate(V,{},s);oi=Vr[0],Oi=Vr[1],fe=Math.floor(65535*Math.min(1,pr/gt)),We=Math.floor(65535*Math.min(1,le/gt)),lt=Math.floor(255*oi)<<8|Math.floor(255*Oi),bt=Math.floor(65535*Math.min(1,Ni/gt)),wt=Math.floor(65535*Math.min(1,pi/gt))}const Vt=Array(Ee.length),qt={x:1/0,y:1/0},hi={x:-1/0,y:-1/0},bi={x:0,y:0};let Ei=0;for(let Kt=0;Kt<Ee.length;Kt++){const Vr=Ee[Kt];if(Vr.length>0){const hr=[],Dr=Array(Vr.length+1);Dr[0]=0;for(let Tn=0;Tn<Vr.length;Tn++){const kn=Vr[Tn];for(let mn=0;mn<kn.length;mn++){const _n=kn[kn.length-mn-1];qt.x=Math.min(qt.x,_n.x),qt.y=Math.min(qt.y,_n.y),hi.x=Math.max(hi.x,_n.x),hi.y=Math.max(hi.y,_n.y),bi.x+=_n.x,bi.y+=_n.y,Ei++,hr.push(_n.x),hr.push(_n.y)}Dr[Tn+1]=hr.length}Vt[Kt]={id:V.id?V.id:0,height:Qe,minHeight:Ke,sourceId:0,roofType:$e,coordinates:hr,ringIndices:Dr}}}bi.x/=Ei||1,bi.y/=Ei||1;const Mi=u.generateMesh(Vt,pt);if(typeof Mi=="string"){It(`Unable to generate building ${V.id}: ${Mi}`),A(ae);continue}if(Mi.meshes.length===0||Mi.modifiedPolygonRings.length===0){A(ae);continue}const Qt=zt?this.buildingWithFacade:this.buildingWithoutFacade;let ni=0;for(const Kt of Mi.meshes)ni+=Kt.positions.length/3;const Hi=Qt.segmentsBucket.prepareSegment(ni,Qt.layoutVertexArray,Qt.indexArray),Ki=[];let Qi=null,ur=0,br=-1;const mr=Qt.layoutVertexArray.length,tr=mr+ni;Qt.layoutVertexArray.resize(tr),Qt.layoutCentroidArray.resize(tr),Qt.layoutNormalArray.resize(tr),Qt.layoutAOArray.resize(tr),Qt.layoutColorArray.resize(tr),Qt.layoutFloodLightDataArray.resize(tr),zt&&(Qt.layoutFacadePaintArray.resize(tr),Qt.layoutFacadeDataArray.resize(tr),Qt.layoutFacadeVerticalRangeArray.resize(tr));const sr=Qt.indexArray.length;let wi=0,Fi=mr;for(const Kt of Mi.meshes){let Vr,hr;if(Kt.buildingPart===1)Vr=rt,hr=Ze;else if(Kt.buildingPart===0)Vr=qe,hr=ot;else if(Kt.buildingPart===2)Vr=yt,hr=ft;else{if(Kt.buildingPart!==3)continue;Vr=Nt,hr=Et}if(hr=j(hr,0,1),Kt.buildingPart===3){const Ir=new Array;for(let En=0;En<Kt.positions.length;En+=12){const ia=Kt.positions[En+0],hl=Kt.positions[En+1],Yn=Kt.positions[En+3],_o=Kt.positions[En+4],Xo=Kt.positions[En+2],kc=Kt.positions[En+8]-Xo,Nd=1,Oa=Yn-ia,za=_o-hl,Yp=Math.hypot(Oa,za);Ir.push({pos:[ia+.5*Oa,hl+.5*za,Xo],normal:[za/Yp,-Oa/Yp,0],width:Yp,height:kc,depth:Nd,points:[ia,hl,Yn,_o]})}const an=Qt.entranceBloom.segmentsBucket.prepareSegment(10*Ir.length,Qt.entranceBloom.layoutVertexArray,Qt.entranceBloom.indexArray),un=Qt.entranceBloom.layoutVertexArray.length;ur=Qt.entranceBloom.indexArray.length,fb(Ir,.5/this.tileToMeter,Qt.entranceBloom.indexArray,Qt.entranceBloom.layoutVertexArray,Qt.entranceBloom.layoutAttenuationArray);const Ro=Qt.entranceBloom.layoutVertexArray.length-un;br=Qt.entranceBloom.indexArray.length-ur;for(let En=0;En<Ro;En++)Qt.entranceBloom.layoutColorArray.emplaceBack(255*Nt.r<<8|255*Nt.g,255*Nt.b<<8|51*Et);an.vertexLength+=Ro,an.primitiveLength+=br,Qi={part:Kt.buildingPart,vertexOffset:un,vertexLength:Ro}}Qt.layoutVertexArray.float32.set(Kt.positions,3*Fi);const Dr=Kt.positions.length/3;for(let Ir=0;Ir<Dr;++Ir){const an=3*Ir;wi=Math.max(wi,Kt.positions[an+2]);const un=Kt.normals[an+1]*Z_,Ro=Kt.normals[an+2]*Z_,En=3*(Fi+Ir);Qt.layoutNormalArray.int16[En]=Kt.normals[an]*Z_,Qt.layoutNormalArray.int16[En+1]=un,Qt.layoutNormalArray.int16[En+2]=Ro;const ia=Kt.ao[Ir];Qt.layoutAOArray.uint8[Fi+Ir]=255*ia;const hl=1+(ia-1)*ct,Yn=255*Vr.b*hl<<8|255*hr;Qt.layoutColorArray.uint16[2*(Fi+Ir)]=255*Vr.r*hl<<8|255*Vr.g*hl,Qt.layoutColorArray.uint16[2*(Fi+Ir)+1]=Yn}const Tn=Math.floor(bi.x),kn=Math.floor(bi.y),mn=Math.floor(Qe);for(let Ir=0;Ir<Dr;++Ir){const an=3*(Fi+Ir);Qt.layoutCentroidArray.int16[an]=Tn,Qt.layoutCentroidArray.int16[an+1]=kn,Qt.layoutCentroidArray.int16[an+2]=mn}if(Qt.layoutFloodLightDataArray.uint16.fill(Kt.buildingPart===0?Ot:0,Fi,Fi+Dr),zt){const Ir=255*yt.r<<8|255*yt.g,an=255*yt.b<<8|255*ft;for(let un=0;un<Dr;++un){const Ro=2*(Fi+un);Qt.layoutFacadePaintArray.uint16[Ro]=Ir,Qt.layoutFacadePaintArray.uint16[Ro+1]=an}for(let un=0;un<Dr;++un)if(Kt.isFauxFacade[un]){const Ro=Math.min(65535,Math.floor(Kt.uv[2*un]*Mi.outerRingLength));Qt.layoutFacadeDataArray.emplace(Fi+un,1|Ro,lt,bt,wt),Qt.layoutFacadeVerticalRangeArray.emplace(Fi+un,fe,We)}else Qt.layoutFacadeDataArray.emplace(Fi+un,0,0,0,0),Qt.layoutFacadeVerticalRangeArray.emplace(Fi+un,0,0)}const _n=Hi.vertexLength,Pn=Kt.indices.length/3,Io=Qt.indexArray.length;Qt.indexArray.resize(Io+Pn);for(let Ir=0;Ir<Pn;++Ir){const an=3*Ir,un=3*Io+an;Qt.indexArray.uint16[un]=_n+Kt.indices[an],Qt.indexArray.uint16[un+1]=_n+Kt.indices[an+1],Qt.indexArray.uint16[un+2]=_n+Kt.indices[an+2]}Kt.buildingPart!==1&&Kt.buildingPart!==0&&Kt.buildingPart!==2&&Kt.buildingPart!==3||Ki.push({part:Kt.buildingPart,vertexOffset:Fi,vertexLength:Kt.positions.length/3}),Fi+=Dr,Hi.vertexLength+=Dr,Hi.primitiveLength+=Kt.indices.length/3}this.maxHeight=Math.max(this.maxHeight,wi);const zr=Qt.indexArray.length-sr,Jt=this.footprintsIndices.length,Pi=this.footprintsVertices.length,_r=[],Er=new st(1/0,1/0),Cr=new st(-1/0,-1/0),cn=this.groundEffect.vertexArray.length;for(const Kt of Mi.modifiedPolygonRings){const Vr=[],hr=new st(1/0,1/0),Dr=new st(-1/0,-1/0);for(let Tn=0;Tn<Kt.length;Tn+=2){const kn=Kt.length-Tn-2;hr.x=Math.min(hr.x,Kt[kn]),hr.y=Math.min(hr.y,Kt[kn+1]),Dr.x=Math.max(Dr.x,Kt[kn]),Dr.y=Math.max(Dr.y,Kt[kn+1]);const mn=new st(Kt[kn],Kt[kn+1]);Vr.push(mn),_r.push(mn.x,mn.y),this.footprintsVertices.emplaceBack(mn.x,mn.y)}Er.x=Math.min(Er.x,hr.x),Er.y=Math.min(Er.y,hr.y),Cr.x=Math.max(Cr.x,Dr.x),Cr.y=Math.max(Cr.y,Dr.y),this.groundEffect.addData(Vr,[hr,Dr],tt)}const Sr=this.groundEffect.vertexArray.length-cn;this.groundEffect.groundRadiusArray.reserveForAdditional(Sr);for(let Kt=0;Kt<Sr;Kt++)this.groundEffect.groundRadiusArray.emplaceBack(at);(qt.x<0||hi.x>gt||qt.y<0||hi.y>gt)&&this.featuresOnBorder.push({featureId:V.id,footprintIndex:this.footprints.length});{const Kt=xd(_r,null,2);this.footprintsIndices.resize(this.footprintsIndices.length+Kt.length),this.footprintsIndices.uint16.set(Kt,Jt),this.buildingIds.add(ae??V.id),this.footprintsMin.x=Math.min(this.footprintsMin.x,Er.x),this.footprintsMin.y=Math.min(this.footprintsMin.y,Er.y),this.footprintsMax.x=Math.max(this.footprintsMax.x,Cr.x),this.footprintsMax.y=Math.max(this.footprintsMax.y,Cr.y);const Vr={footprintVertexOffset:Pi,footprintVertexLength:this.footprintsVertices.length-Pi,footprintIndexOffset:Jt,footprintIndexLength:this.footprintsIndices.length-Jt,min:Er,max:Cr,hiddenFlags:0,indicesOffset:sr,indicesLength:zr,bloomIndicesOffset:ur,bloomIndicesLength:br,groundEffectVertexOffset:cn,groundEffectVertexLength:Sr,hasFauxFacade:zt,height:wi,promoteId:$,feature:me,parts:Ki,buildingBloom:Qi},hr=this.footprints.length;V.id!==void 0&&this.featureFootprintLookup.set(V.id,hr),P(ae,hr),this.footprints.push(Vr)}this.programConfigurations.populatePaintArrays(Qt.layoutVertexArray.length,V,X,{},i.availableImages,s,i.brightness),this.groundEffect.addPaintPropertiesData(V,X,{},i.availableImages,s,i.brightness),i.featureIndex.insert(V,xe,X,Q,this.index,mr)}T.forEach((({buildingId:V,footprintIndex:$})=>{E.has(V)&&(this.footprints[$].hiddenFlags|=4)}));const U=new Set;this.buildingIds.forEach(((V,$,X)=>{E.has(V)||U.add(V)})),this.buildingIds=U,this.groundEffect.prepareBorderSegments()}update(e,i,s,a,u,h,f){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f),this.groundEffect.update(e,i,u,s,a,h,f),this.evaluate(this.layers[0],e),this.colorBufferUploaded=!1}isEmpty(){return this.buildingWithoutFacade.layoutVertexArray.length===0&&this.buildingWithFacade.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){const i=s=>{s.layoutVertexBuffer=e.createVertexBuffer(s.layoutVertexArray,pb.members),s.layoutNormalBuffer=e.createVertexBuffer(s.layoutNormalArray,$I.members),s.layoutCentroidBuffer=e.createVertexBuffer(s.layoutCentroidArray,WI.members),s.layoutFloodLightDataBuffer=e.createVertexBuffer(s.layoutFloodLightDataArray,QI.members),s.layoutFacadeDataArray&&s.layoutFacadeDataArray.length&&(s.layoutFacadeDataBuffer=e.createVertexBuffer(s.layoutFacadeDataArray,YI.members)),s.layoutFacadeVerticalRangeArray&&s.layoutFacadeVerticalRangeArray.length&&(s.layoutFacadeVerticalRangeBuffer=e.createVertexBuffer(s.layoutFacadeVerticalRangeArray,JI.members)),s.entranceBloom.layoutVertexArray.length&&(s.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(s.entranceBloom.layoutVertexArray,pb.members),s.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(s.entranceBloom.layoutAttenuationArray,KI.members)),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e)};this.uploaded||(i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){const e=i=>{i.layoutVertexBuffer&&(i.layoutVertexBuffer.destroy(),i.layoutNormalBuffer.destroy(),i.layoutColorBuffer.destroy(),i.segmentsBucket.destroy(),i.indexBuffer&&i.indexBuffer.destroy(),i.entranceBloom.layoutVertexBuffer&&(i.entranceBloom.layoutVertexBuffer.destroy(),i.entranceBloom.layoutColorBuffer.destroy(),i.entranceBloom.layoutAttenuationBuffer.destroy(),i.entranceBloom.indexBuffer.destroy(),i.entranceBloom.segmentsBucket.destroy()))};e(this.buildingWithoutFacade),e(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(e,i,s=!0){let a=!1;const u=s?i:0,h=0|(s?-1:~i);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const f of e){const g=this.footprints[f],x=g.hiddenFlags&h|u;g.hiddenFlags!==x&&(g.hiddenFlags=x,a=!0,this.groundEffect.updateHiddenByLandmarkRange(g.groundEffectVertexOffset,g.groundEffectVertexLength,g.hiddenFlags!==0))}return a&&(this.indexArrayForConflationUploaded=!1),a}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),this.indexArrayForConflationUploaded)return;const i=a=>{a.indexArray.length!==0&&(a.indexArrayForConflation.resize(a.indexArray.length),a.indexArrayForConflation.uint16.set(a.indexArray.uint16),a.entranceBloom.indexArrayForConflation.resize(a.entranceBloom.indexArray.length),a.entranceBloom.indexArrayForConflation.uint16.set(a.entranceBloom.indexArray.uint16))};i(this.buildingWithoutFacade),i(this.buildingWithFacade);for(const a of this.footprints){const u=a.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,h=a.indicesOffset+a.indicesLength;if(a.hiddenFlags!==0){for(let g=a.indicesOffset;g<h;g++)u.indexArrayForConflation.uint16[3*g+0]=0,u.indexArrayForConflation.uint16[3*g+1]=0,u.indexArrayForConflation.uint16[3*g+2]=0;const f=a.bloomIndicesOffset+a.bloomIndicesLength;for(let g=a.bloomIndicesOffset;g<f;g++)u.entranceBloom.indexArrayForConflation.uint16[3*g+0]=0,u.entranceBloom.indexArrayForConflation.uint16[3*g+1]=0,u.entranceBloom.indexArrayForConflation.uint16[3*g+2]=0}}const s=a=>{a.indexArray.length!==0&&(a.indexBuffer?a.indexBuffer.updateData(a.indexArrayForConflation):a.indexBuffer=e.createIndexBuffer(a.indexArrayForConflation,!0),a.entranceBloom.indexBuffer?a.entranceBloom.indexBuffer.updateData(a.entranceBloom.indexArrayForConflation):a.entranceBloom.indexBuffer=e.createIndexBuffer(a.entranceBloom.indexArrayForConflation,!0))};s(this.buildingWithoutFacade),s(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(e){const i=s=>{s.layoutColorBuffer?s.layoutColorBuffer.updateData(s.layoutColorArray):s.layoutColorBuffer=e.createVertexBuffer(s.layoutColorArray,mb.members,!0),s.layoutFacadePaintArray&&(s.layoutFacadePaintBuffer?s.layoutFacadePaintBuffer.updateData(s.layoutFacadePaintArray):s.layoutFacadePaintBuffer=e.createVertexBuffer(s.layoutFacadePaintArray,XI.members,!0)),s.entranceBloom.layoutColorBuffer?s.entranceBloom.layoutColorBuffer.updateData(s.entranceBloom.layoutColorArray):s.entranceBloom.layoutColorBuffer=e.createVertexBuffer(s.entranceBloom.layoutColorArray,mb.members,!0)};i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(e,i){const s=e.paint.get("building-ambient-occlusion-intensity");for(const a of this.footprints){if(4&a.hiddenFlags)continue;const u=i[a.promoteId],h=a.feature;h.properties["building-part"]="roof";const f=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),g=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical);h.properties["building-part"]="wall";const x=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),T=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical);h.properties["building-part"]="window";const E=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),A=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical);h.properties["building-part"]="door";const P=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),L=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical),F=a.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(const V of a.parts){let $,X=f;V.part===1?(X=f,$=g):V.part===0?(X=x,$=T):V.part===2?(X=E,$=A):V.part===3&&(X=P,$=L),$=j($,0,1);for(let Q=0;Q<V.vertexLength;Q++){const de=V.vertexOffset+Q,ae=1+(F.layoutAOArray.uint8[de]/255-1)*s;F.layoutColorArray.emplace(de,X.r*ae*255<<8|X.g*ae*255,X.b*ae*255<<8|255*$),a.hasFauxFacade&&F.layoutFacadePaintArray.emplace(de,255*E.r<<8|255*E.g,255*E.b<<8|255*A)}}const U=a.buildingBloom;if(U)for(let V=0;V<U.vertexLength;V++)F.entranceBloom.layoutColorArray.emplace(U.vertexOffset+V,255*P.r<<8|255*P.g,255*P.b<<8|51*L)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(e,i,s){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped());if(D_(this.activeReplacements,a))return;this.activeReplacements=a;for(const h of this.footprints)h.hiddenFlags&=-2;const u=[];for(const h of this.activeReplacements){if(h.order<=y1)continue;const f=Math.max(1,Math.pow(2,h.footprintTileId.canonical.z-e.canonical.z));for(const g of this.footprints)g.min.x>h.max.x||g.max.x<h.min.x||g.min.y>h.max.y||g.max.y<h.min.y||(u.length=0,rA(this.footprintsVertices,g.footprintVertexOffset,g.footprintVertexLength,h.footprintTileId.canonical,e.canonical,u),Ky(h.footprint,u,this.footprintsIndices.uint16,g.footprintIndexOffset,g.footprintIndexLength,0,-f)&&(g.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const h of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(h.groundEffectVertexOffset,h.groundEffectVertexLength,h.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getFootprint(e){if(e.id!==void 0){const i=this.featureFootprintLookup.get(e.id);return this.footprints[i]}return null}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,a=!0;const u=4*(e+gt)*gt+(i+gt);if(this.footprintLookup.hasOwnProperty(u)){const f=this.footprintLookup[u];return f?{height:f.height,hidden:f.hiddenFlags!==0}:void 0}const h=new st(e,i);for(const f of this.footprints)e>f.max.x||f.min.x>e||i>f.max.y||f.min.y>i||f.height<=s||iA(h,this.footprintsVertices.float32.subarray(2*f.footprintVertexOffset,2*(f.footprintVertexOffset+f.footprintVertexLength)),this.footprintsIndices.uint16.subarray(f.footprintIndexOffset,f.footprintIndexOffset+f.footprintIndexLength))&&(s=f.height,this.footprintLookup[u]=f,a=f.hiddenFlags!==0);if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:a};this.footprintLookup[u]=void 0}}function iA(r,e,i){for(let s=0;s<i.length;s+=3){const a=i[s],u=i[s+1],h=i[s+2],f=e[2*a+0],g=e[2*a+1],x=e[2*u+0],T=e[2*u+1],E=e[2*h+0],A=e[2*h+1],P=(f-E)*(r.y-A)-(g-A)*(r.x-E),L=(x-f)*(r.y-g)-(T-g)*(r.x-f);if(P<0!=L<0&&P!==0&&L!==0)continue;const F=(E-x)*(r.y-T)-(A-T)*(r.x-x);if(F===0||F<0==P+L<=0)return!0}return!1}function rA(r,e,i,s,a,u){const h=Math.pow(2,s.z-a.z);for(let f=0;f<i;f++){let g=r.float32[2*(f+e)+0],x=r.float32[2*(f+e)+1];g=(g+a.x*gt)*h-s.x*gt,x=(x+a.y*gt)*h-s.y*gt,u.push(new st(g,x))}}let yb,vb;Lt(gb,"BuildingBucket",{omit:["layers"]}),Lt(vv,"BuildingGeometry"),Lt(yv,"BuildingBloomGeometry");const nA=Ci([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),oA=Ci([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:sA}=nA,aA=Ci([{name:"a_packed",components:3,type:"Float32"}]),{members:lA}=aA,cA=Ci([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:uA}=cA;class xb{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new Lc({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const s=this.getKey(e,i);return this.positions[s]}trim(){const e=this.width,i=this.height=Ve(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,s){const a=[];let u=e.length%2==1?-e[e.length-1]*s:0,h=e[0]*s,f=!0;a.push({left:u,right:h,isDash:f,zeroLength:e[0]===0});let g=e[0];for(let x=1;x<e.length;x++){f=!f;const T=e[x];u=g*s,g+=T,h=g*s,a.push({left:u,right:h,isDash:f,zeroLength:T===0})}return a}addRoundDash(e,i,s){const a=i/2;for(let u=-s;u<=s;u++){const h=this.width*(this.nextRow+s+u);let f=0,g=e[f];for(let x=0;x<this.width;x++){x/g.right>1&&(g=e[++f]);const T=Math.abs(x-g.left),E=Math.abs(x-g.right),A=Math.min(T,E);let P;const L=u/s*(a+1);if(g.isDash){const F=a-Math.abs(L);P=Math.sqrt(A*A+F*F)}else P=a-Math.sqrt(A*A+L*L);this.image.data[h+x]=Math.max(0,Math.min(255,P+128))}}}addRegularDash(e,i){for(let g=e.length-1;g>=0;--g){const x=e[g],T=e[g+1];x.zeroLength?e.splice(g,1):T&&T.isDash===x.isDash&&(T.left=x.left,e.splice(g,1))}const s=e[0],a=e[e.length-1];s.isDash===a.isDash&&(s.left=a.left-this.width,a.right=s.right+this.width);const u=this.width*this.nextRow;let h=0,f=e[h];for(let g=0;g<this.width;g++){g/f.right>1&&(f=e[++h]);const x=Math.abs(g-f.left),T=Math.abs(g-f.right),E=Math.min(x,T);this.image.data[u+g]=Math.max(0,Math.min(255,(f.isDash?E:-E)+i+128))}}addDash(e,i){const s=this.getKey(e,i);if(this.positions[s])return this.positions[s];const a=i==="round",u=a?7:0,h=2*u+1;if(this.nextRow+h>this.height)return It("LineAtlas out of space"),null;e.length===0&&e.push(1);let f=0;for(let T=0;T<e.length;T++)e[T]<0&&(It("Negative value is found in line dasharray, replacing values with 0"),e[T]=0),f+=e[T];if(f!==0){const T=this.width/f,E=this.getDashRanges(e,this.width,T);a?this.addRoundDash(E,T,u):this.addRegularDash(E,i==="square"?.5*T:0)}const g=this.nextRow+u;this.nextRow+=h;const x={tl:[g,u],br:[f,0]};return this.positions[s]=x,x}}Lt(xb,"LineAtlas");const hA=Se.types,dA=Math.cos(Math.PI/180*37.5),fA=Math.cos(Math.PI/180*5);class xv{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((i=>{this.gradients[i.id]={}})),this.layoutVertexArray=new td,this.layoutVertexArray2=new qo,this.patternVertexArray=new qo,this.indexArray=new xn,this.programConfigurations=new As(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Fr,this.maxLineLength=0,this.zOffsetVertexArray=new qo,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.tessellationStep=e.tessellationStep?e.tessellationStep:gt/64,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,s,a){}populate(e,i,s,a){this.hasPattern=Zy("line",this.layers,this.pixelRatio,i);const u=this.layers[0].layout.get("line-sort-key");this.tileToMeter=q(s);const h=this.layers[0].layout.get("line-elevation-reference");if(h==="hd-road-markup")this.elevationType="road";else{const A=this.layers[0].layout.get("line-z-offset"),P=A.isConstant()&&!A.constantOr(0);this.elevationType=h!=="sea"&&h!=="ground"&&P?"none":"offset",this.elevationType==="offset"&&h==="none"&&It(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const f=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&f!==void 0;const g=[];for(const{feature:A,id:P,index:L,sourceLayerIndex:F}of e){const U=this.layers[0]._featureFilter.needGeometry,V=Ce(A,U);if(!this.layers[0]._featureFilter.filter(new Ar(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),V,s))continue;const $=u?u.evaluate(V,{},s):void 0,X={id:P,properties:A.properties,type:A.type,sourceLayerIndex:F,index:L,geometry:U?V.geometry:ye(A,s,a),patterns:{},sortKey:$};g.push(X)}u&&g.sort(((A,P)=>A.sortKey-P.sortKey));const{lineAtlas:x,featureIndex:T}=i,E=this.addConstantDashes(x);for(const A of g){const{geometry:P,index:L,sourceLayerIndex:F}=A;if(E&&this.addFeatureDashes(A,x),this.hasPattern){const U=$y("line",this.layers,A,this.zoom,this.pixelRatio,i);this.patternFeatures.push(U)}else this.addFeature(A,P,L,s,x.positions,i.availableImages,i.brightness,i.elevationFeatures);T.insert(e[L].feature,P,L,F,this.index)}}addConstantDashes(e){let i=!1;for(const s of this.layers){const a=s.paint.get("line-dasharray").value,u=s.layout.get("line-cap").value;if(a.kind!=="constant"||u.kind!=="constant")i=!0;else{const h=u.value,f=a.value;if(!f)continue;e.addDash(f,h)}}return i}addFeatureDashes(e,i){const s=this.zoom;for(const a of this.layers){const u=a.paint.get("line-dasharray").value,h=a.layout.get("line-cap").value;if(u.kind==="constant"&&h.kind==="constant")continue;let f,g;if(u.kind==="constant"){if(f=u.value,!f)continue}else f=u.evaluate({zoom:s},e);g=h.kind==="constant"?h.value:h.evaluate({zoom:s},e),i.addDash(f,g),e.patterns[a.id]=[i.getKey(f,g)]}}update(e,i,s,a,u,h,f,g){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,g)}addFeatures(e,i,s,a,u,h){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,i,s,a,h,e.elevationFeatures)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,lA)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,uA)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,oA.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,sA),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e,i){let s,a;if(i&&i>0?(s=`mapbox_clip_start_${i}`,a=`mapbox_clip_end_${i}`):(s="mapbox_clip_start",a="mapbox_clip_end"),e.properties&&e.properties.hasOwnProperty(s)&&e.properties.hasOwnProperty(a))return{start:+e.properties[s],end:+e.properties[a]}}addFeature(e,i,s,a,u,h,f,g){const x=this.layers[0].layout,T=x.get("line-join").evaluate(e,{}),E=x.get("line-cap").evaluate(e,{}),A=x.get("line-miter-limit"),P=x.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e;const L=!(!e.properties||!e.properties.hasOwnProperty("mapbox_line_metrics"))&&e.properties.mapbox_line_metrics;this.zOffsetValue=x.get("line-z-offset").value;const F=this.layers[0].paint.get("line-width").value;if(F.kind!=="constant"&&F.isLineProgressConstant===!1&&(this.variableWidthValue=F),this.elevationType==="road"){const U=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,i,a,g,T,E,A,P)){const[V,$]=this.clipRuntimeLinesToTile(i,1);for(let X=0;X<V.length;X++){const Q=V[X],de=$[X],ae={progress:{min:de.progress.min,max:de.progress.max},nextDir:this.computeSegNextDir(de,Q),prevDir:this.computeSegPrevDir(de,Q)};this.addLine(Q,e,a,T,E,A,P,ae,L&&de.parentIndex>0?de.parentIndex:null)}this.fillNonElevatedRoadSegment(U)}}else for(let U=0;U<i.length;U++)this.addLine(i[U],e,a,T,E,A,P,void 0,L&&U>0?U:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,u,h,a,f,void 0,this.worldview)}computeSegNextDir(e,i){return e.nextPoint.sub(i.at(-2)).unit()}computeSegPrevDir(e,i){return i[1].sub(e.prevPoint).unit()}clipLinesToTile(e,i){return k_(e,-i,-i,gt+i,gt+i)}clipRuntimeLinesToTile(e,i){const s=[];return[k_(e,-i,-i,gt+i,gt+i,s),s]}addElevatedRoadFeature(e,i,s,a,u,h,f,g){const x=[],T=nr.getElevationFeature(e,a);if(T){const E=this.clipLinesToTile(i,1),A=this.prepareElevatedLines(E,T,s);for(const P of A)x.push({geometry:P,elevation:T,elevationTileID:s,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(x.length===0)return!1;for(const E of x){const A=this.layoutVertexArray.length;this.addLine(E.geometry,e,s,u,h,f,g);const P=new fr(s,E.elevationTileID);if(E.elevation)for(let L=A;L<this.layoutVertexArray.length;L++){const F=new st(this.layoutVertexArray.int16[6*L]>>1,this.layoutVertexArray.int16[6*L+1]>>1),U=P.pointElevation(F,E.elevation,.05);this.updateHeightRange(U),this.zOffsetVertexArray.emplaceBack(U,0,0)}else this.fillNonElevatedRoadSegment(A)}return!0}prepareElevatedLines(e,i,s){if(i.constantHeight!=null)return e;const a=[],u=1/q(s);for(const h of e)TI(h,new Ji(i,u),0,a);return a}fillNonElevatedRoadSegment(e){for(let i=e;i<this.layoutVertexArray.length;i++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,i,s,a,u,h,f,g,x){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=x?this.lineFeatureClips(i,x):this.lineClips;const T=a==="none";this.patternJoinNone=this.hasPattern&&T,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const E=g&&g.progress.min>0,A=g&&g.progress.max<1;if(this.lineClips){let Ee={min:this.lineClips.start,max:this.lineClips.end},Ge=1;if(g){const Ke=this.lineClips.end-this.lineClips.start;Ee=(function(Qe,at,ct){return{min:Tr(Qe.min,at,ct),max:Tr(Qe.max,at,ct)}})(g.progress,{min:0,max:1},Ee),Ke>0&&(Ge=(Ee.max-Ee.min)/Ke)}const Me=+i.properties.mapbox_clip_feature_len,$e=+i.properties.mapbox_clip_seg_len;if(Number.isNaN(Me)||Number.isNaN($e)){for(let Qe=0;Qe<e.length-1;Qe++)this.totalDistance+=e[Qe].dist(e[Qe+1]);const Ke=this.totalDistance/(Ee.max-Ee.min);this.totalFeatureLength=Number.isFinite(Ke)?Ke:0,this.lineClips.start=Ee.min,this.lineClips.end=Ee.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=Me,this.distance=$e*Ge,this.lineClips.start=Ee.min,this.lineClips.end=Ee.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const P=hA[i.type]==="Polygon";let L=e.length;for(;L>=2&&e[L-1].equals(e[L-2]);)L--;let F=0;for(;F<L-1&&e[F].equals(e[F+1]);)F++;if(L<(P?3:2))return;a==="bevel"&&(h=1.05);const U=this.segments.prepareSegment(10*L,this.layoutVertexArray,this.indexArray);let V,$,X,Q,de,ae,me,xe;g&&g.prevDir&&(ae=g.prevDir.perp()),g&&g.nextDir&&(me=g.nextDir.perp()),this.e1=this.e2=-1,P&&(V=e[L-2],de=e[F].sub(V)._unit()._perp());for(let Ee=F;Ee<L;Ee++){if(X=Ee===L-1?P?e[F+1]:void 0:e[Ee+1],X&&e[Ee].equals(X))continue;de&&(Q=de),V&&($=V),V=e[Ee],xe=this.evaluateLineProgressFeatures($?$.dist(V):0),de=X?X.sub(V)._unit()._perp():Q,Q=Q||de;const Ge=$&&X;let Me=Ge?a:P||T?"butt":u;const $e=Q.x*de.x+Q.y*de.y;if(T){const qe=function(ot){if(ot.patternJoinNone){const yt=ot.segmentPoints.length/2,ft=ot.lineSoFar-ot.segmentStart;for(let Nt=0;Nt<yt;++Nt){const Et=ot.segmentPoints[2*Nt+1],Ct=Math.round(ot.segmentPoints[2*Nt])+.5+.25*Et;ot.patternVertexArray.emplaceBack(Ct,ft,ot.segmentStart),ot.patternVertexArray.emplaceBack(Ct,ft,ot.segmentStart)}ot.segmentPoints.length=0}ot.e1=ot.e2=-1};if(Ge&&$e<fA){this.updateDistance($,V),this.addCurrentVertex(V,Q,1,1,U,xe),qe(this),this.addCurrentVertex(V,de,-1,-1,U,xe);continue}if($){if(!X){this.updateDistance($,V),this.addCurrentVertex(V,Q,1,1,U,xe),qe(this);continue}Me="miter"}}let Ke=Q.add(de);Ke.x===0&&Ke.y===0||Ke._unit();const Qe=Ke.x*de.x+Ke.y*de.y,at=Qe!==0?1/Qe:1/0,ct=2*Math.sqrt(2-2*Qe),tt=Qe<dA&&$&&X,rt=Q.x*de.y-Q.y*de.x>0,Ze=this.overscaling<=16?15*gt/(512*this.overscaling):0;if(Ge&&Me==="round"){if(at<f)Me="miter";else if(at<=2){const qe=bv(V,-10,gt+10);Me=this.elevationType==="offset"&&(qe||this.hasCrossSlope)?"miter":"fakeround"}}if(Me==="miter"&&at>h&&(Me="bevel"),Me==="bevel"&&(at>2&&(Me="flipbevel"),at<h&&(Me="miter")),$&&!(Me==="miter"&&tt)&&this.updateDistance($,V),Me==="miter")if(tt){const qe=V.dist($);if(qe>2*Ze){const yt=V.sub(V.sub($)._mult(Ze/qe)._round());this.updateDistance($,yt),this.addCurrentVertex(yt,Q,0,0,U,xe),$=yt}this.updateDistance($,V),Ke._mult(at),this.addCurrentVertex(V,Ke,0,0,U,xe);const ot=V.dist(X);if(ot>2*Ze){const yt=V.add(X.sub(V)._mult(Ze/ot)._round());this.updateDistance(V,yt),this.addCurrentVertex(yt,de,0,0,U,xe),V=yt}}else Ke._mult(at),this.addCurrentVertex(V,Ke,0,0,U,xe);else if(Me==="flipbevel"){if(at>100)Ke=de.mult(-1);else{const qe=at*Q.add(de).mag()/Q.sub(de).mag();Ke._perp()._mult(qe*(rt?-1:1))}this.addCurrentVertex(V,Ke,0,0,U,xe),this.addCurrentVertex(V,Ke.mult(-1),0,0,U,xe)}else if(Me==="bevel"||Me==="fakeround"){xe!=null&&$&&this.addCurrentVertex(V,me||Q,-1,-1,U,xe);const qe=V.dist($)<=2*Ze&&Me!=="bevel",ot=Ke.mult(rt?1:-1);ot._mult(at);const yt=de.mult(rt?-1:1),ft=Q.mult(rt?-1:1),Nt=this.evaluateLineProgressFeatures(this.distance);if(xe==null&&(this.addHalfVertex(V,ot.x,ot.y,!1,!rt,0,U,Nt),qe||this.addHalfVertex(V,ot.x+2*ft.x,ot.y+2*ft.y,!1,rt,0,U,Nt)),Me==="fakeround"){const Et=Math.round(180*ct/Math.PI/20);this.addHalfVertex(V,ft.x,ft.y,!1,rt,0,U,Nt);for(let Ct=0;Ct<Et;Ct++){let Ot=Ct/Et;if(Ot!==.5){const pt=Ot-.5;Ot+=Ot*pt*(Ot-1)*((1.0904+$e*($e*(3.55645-1.43519*$e)-3.2452))*pt*pt+(.848013+$e*(.215638*$e-1.06021)))}const Ii=yt.sub(ft)._mult(Ot)._add(ft)._unit();this.addHalfVertex(V,Ii.x,Ii.y,!1,rt,0,U,Nt)}this.addHalfVertex(V,yt.x,yt.y,!1,rt,0,U,Nt)}qe||xe!=null||this.addHalfVertex(V,ot.x+2*yt.x,ot.y+2*yt.y,!1,rt,0,U,Nt),xe!=null&&X&&this.addCurrentVertex(V,ae||de,1,1,U,xe)}else if(Me==="butt")this.addCurrentVertex(V,Ke,0,0,U,xe);else if(Me==="square"){if(!$){const qe=E?0:-1;this.addCurrentVertex(V,Ke,qe,qe,U,xe)}if(this.addCurrentVertex(V,Ke,0,0,U,xe),$){const qe=A?0:1;this.addCurrentVertex(V,Ke,qe,qe,U,xe)}}else if(Me==="round"){if($){const qe=!Ge&&me?me:Q;this.addCurrentVertex(V,qe,0,0,U,xe),!Ge&&A||this.addCurrentVertex(V,qe,1,1,U,xe,!0)}if(X){const qe=!Ge&&ae?ae:de;!Ge&&E||this.addCurrentVertex(V,qe,-1,-1,U,xe,!0),this.addCurrentVertex(V,qe,0,0,U,xe)}}}}addVerticesTo(e,i,s,a,u,h,f,g,x,T){const E=(i.w-e.w)/this.tessellationStep|0;let A=0;const P=this.scaledDistance;if(E>1){this.lineSoFar=e.w;const F=(i.x-e.x)/E,U=(i.y-e.y)/E,V=(i.z-e.z)/E,$=(i.w-e.w)/E;for(let X=1;X<E;++X){e.x+=F,e.y+=U,e.z+=V,this.lineSoFar+=$,A+=$;const Q=this.evaluateLineProgressFeatures(this.prevDistance+A);this.scaledDistance=(this.prevDistance+A)/this.totalDistance,this.addHalfVertex(e,s,a,T,!1,f,x,Q),this.addHalfVertex(e,u,h,T,!0,-g,x,Q)}}this.lineSoFar=i.w,this.scaledDistance=P;const L=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,s,a,T,!1,f,x,L),this.addHalfVertex(i,u,h,T,!0,-g,x,L)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):It(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:i}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}}addCurrentVertex(e,i,s,a,u,h,f=!1){const g=i.x+i.y*s,x=i.y-i.x*s,T=i.y*a-i.x,E=-i.y-i.x*a;if(h!=null){const A=this.elevationType==="offset",P=-10,L=gt+10,F=h.zOffset,U=new j1(e.x,e.y,F,this.lineSoFar),V=!!A&&bv(e,P,L),$=this.lineSoFar,X=this.distance;if(this.currentVertex)if(V){const Q=this.currentVertexIsOutside,de=this.currentVertex,ae=new j1(e.x,e.y,F,this.lineSoFar);if(q1(de,ae,P,L),!bv(ae,P,L)){if(Q){this.e1=this.e2=-1,this.distance-=de.dist(U),this.lineSoFar=de.w;const me=this.evaluateLineProgressFeatures(de.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(de,g,x,f,!1,s,u,me),this.addHalfVertex(de,T,E,f,!0,-a,u,me),this.prevDistance=this.distance}this.distance=this.prevDistance+de.dist(ae),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(de,ae,g,x,T,E,s,a,u,f),this.distance=X,this.scaledDistance=this.distance/this.totalDistance}}else{const Q=this.currentVertex;if(this.currentVertexIsOutside){q1(Q,U,P,L),this.e1=this.e2=-1,this.distance-=Q.dist(U),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=Q.w;const de=this.evaluateLineProgressFeatures(Q.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(Q,g,x,f,!1,s,u,de),this.addHalfVertex(Q,T,E,f,!0,-a,u,de),this.prevDistance=this.distance,this.distance=X,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(Q,U,g,x,T,E,s,a,u,f)}else V||(this.addHalfVertex(e,g,x,f,!1,s,u,h),this.addHalfVertex(e,T,E,f,!0,-a,u,h));this.currentVertex=U,this.currentVertexIsOutside=V,this.lineSoFar=$}else this.addHalfVertex(e,g,x,f,!1,s,u,h),this.addHalfVertex(e,T,E,f,!0,-a,u,h)}addHalfVertex({x:e,y:i},s,a,u,h,f,g,x){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),h||this.segmentPoints.push(this.lineSoFar-this.segmentStart,f)),this.layoutVertexArray.emplaceBack((e<<1)+(u?1:0),(i<<1)+(h?1:0),Math.round(63*s)+128,Math.round(63*a)+128,1+(f===0?0:f<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const E=ei(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,E)}const T=g.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,T),g.primitiveLength++),h?this.e2=T:this.e1=T,x!=null&&this.zOffsetVertexArray.emplaceBack(x.zOffset,x.variableWidth,x.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function bv(r,e,i){return r.x<e||r.x>i||r.y<e||r.y>i}let bb,wb;function Tb(r,e,i){return e*(gt/(r.tileSize*Math.pow(2,i-r.tileID.overscaledZ)))}Lt(xv,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const Eb=(r,e,i)=>(1-i)*r+i*e;function Sb(r,e){return 1/Tb(r,1,e.tileZoom)}function Ib(r,e,i,s){return r.translatePosMatrix(s||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const Ab=r=>{const e=[];Cb(r)&&e.push("RENDER_LINE_DASH"),r.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=r.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),r.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const s=r.layout.get("line-join").constantOr("miter")==="none",a=!!r.paint.get("line-pattern").constantOr(1);return s&&a&&e.push("LINE_JOIN_NONE"),e};function Cb(r){const e=r.paint.get("line-dasharray").value;return e.kind!=="constant"||e.value}let wv;const Mb=()=>wv||(wv={layout:bb||(bb=new en({"line-cap":new xt(Re.layout_line["line-cap"]),"line-join":new xt(Re.layout_line["line-join"]),"line-miter-limit":new mt(Re.layout_line["line-miter-limit"]),"line-round-limit":new mt(Re.layout_line["line-round-limit"]),"line-sort-key":new xt(Re.layout_line["line-sort-key"]),"line-z-offset":new xt(Re.layout_line["line-z-offset"]),"line-elevation-reference":new mt(Re.layout_line["line-elevation-reference"]),"line-cross-slope":new mt(Re.layout_line["line-cross-slope"]),visibility:new mt(Re.layout_line.visibility),"line-width-unit":new mt(Re.layout_line["line-width-unit"])})),paint:wb||(wb=new en({"line-opacity":new xt(Re.paint_line["line-opacity"]),"line-color":new xt(Re.paint_line["line-color"]),"line-translate":new mt(Re.paint_line["line-translate"]),"line-translate-anchor":new mt(Re.paint_line["line-translate-anchor"]),"line-width":new xt(Re.paint_line["line-width"]),"line-gap-width":new xt(Re.paint_line["line-gap-width"]),"line-offset":new xt(Re.paint_line["line-offset"]),"line-blur":new xt(Re.paint_line["line-blur"]),"line-dasharray":new xt(Re.paint_line["line-dasharray"]),"line-pattern":new xt(Re.paint_line["line-pattern"]),"line-pattern-cross-fade":new mt(Re.paint_line["line-pattern-cross-fade"]),"line-gradient":new Ul(Re.paint_line["line-gradient"]),"line-trim-offset":new mt(Re.paint_line["line-trim-offset"]),"line-trim-fade-range":new mt(Re.paint_line["line-trim-fade-range"]),"line-trim-color":new mt(Re.paint_line["line-trim-color"]),"line-emissive-strength":new xt(Re.paint_line["line-emissive-strength"]),"line-border-width":new xt(Re.paint_line["line-border-width"]),"line-border-color":new xt(Re.paint_line["line-border-color"]),"line-occlusion-opacity":new mt(Re.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},wv);class pA extends xt{possiblyEvaluate(e,i){return i=new Ar(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition,worldview:i.worldview}),super.possiblyEvaluate(e,i)}evaluate(e,i,s,a){return i=Object.assign({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,s,a)}}let Ap;function Pb(r,e){return e>0?e+2*r:r}const mA=Ci([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),_A=Ci([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),gA=Ci([{name:"a_projected_pos",components:4,type:"Float32"}],4);Ci([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const yA=Ci([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),vA=Ci([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),xA=Ci([{name:"a_texb",components:2,type:"Uint16"}]),bA=Ci([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),wA=Ci([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);Ci([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Lb=Ci([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),TA=Ci([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Ci([{name:"triangle",components:3,type:"Uint16"}]),Ci([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Ci([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),Ci([{type:"Float32",name:"offsetX"}]),Ci([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var zn=24;function EA(r,e,i){return r.sections.forEach((s=>{s.text=(function(a,u,h){const f=u.layout.get("text-transform").evaluate(h,{});return f==="uppercase"?a=a.toLocaleUpperCase():f==="lowercase"&&(a=a.toLocaleLowerCase()),xa.applyArabicShaping&&(a=xa.applyArabicShaping(a)),a})(s.text,e,i)})),r}const Cp={"!":"ï¸","#":"ï¼",$:"ï¼","%":"ï¼","&":"ï¼","(":"ï¸µ",")":"ï¸¶","*":"ï¼","+":"ï¼",",":"ï¸","-":"ï¸²",".":"ã»","/":"ï¼",":":"ï¸",";":"ï¸","<":"ï¸¿","=":"ï¼",">":"ï¹","?":"ï¸","@":"ï¼ ","[":"ï¹","\\":"ï¼¼","]":"ï¹","^":"ï¼¾",_:"ï¸³","`":"ï½","{":"ï¸·","|":"â","}":"ï¸¸","~":"ï½","Â¢":"ï¿ ","Â£":"ï¿¡","Â¥":"ï¿¥","Â¦":"ï¿¤","Â¬":"ï¿¢","Â¯":"ï¿£","â":"ï¸²","â":"ï¸±","â":"ï¹","â":"ï¹","â":"ï¹","â":"ï¹","â¦":"ï¸","â§":"ã»","â©":"ï¿¦","ã":"ï¸","ã":"ï¸","ã":"ï¸¿","ã":"ï¹","ã":"ï¸½","ã":"ï¸¾","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¸»","ã":"ï¸¼","ã":"ï¸¹","ã":"ï¸º","ã":"ï¸","ã":"ï¸","ï¼":"ï¸","ï¼":"ï¸µ","ï¼":"ï¸¶","ï¼":"ï¸","ï¼":"ï¸²","ï¼":"ã»","ï¼":"ï¸","ï¼":"ï¸","ï¼":"ï¸¿","ï¼":"ï¹","ï¼":"ï¸","ï¼»":"ï¹","ï¼½":"ï¹","ï¼¿":"ï¸³","ï½":"ï¸·","ï½":"â","ï½":"ï¸¸","ï½":"ï¸µ","ï½ ":"ï¸¶","ï½¡":"ï¸","ï½¢":"ï¹","ï½£":"ï¹","â":"â","â":"â"};function SA(r){return r==="ï¸¶"||r==="ï¹"||r==="ï¸¸"||r==="ï¹"||r==="ï¹"||r==="ï¸¾"||r==="ï¸¼"||r==="ï¸º"||r==="ï¸"||r==="ï¹"||r==="ï¸"||r==="ï¸"||r==="ï¸"||r==="ï½"||r==="ï¿£"||r==="ï¸"||r==="ï¸"}function IA(r){return r==="ï¸µ"||r==="ï¹"||r==="ï¸·"||r==="ï¹"||r==="ï¹"||r==="ï¸½"||r==="ï¸»"||r==="ï¸¹"||r==="ï¸"||r==="ï¸¿"}const Tv=4294967296,Rb=1/Tv,Db=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let $_=class{constructor(r=new Uint8Array(16)){this.buf=ArrayBuffer.isView(r)?r:new Uint8Array(r),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(r,e,i=this.length){for(;this.pos<i;){const s=this.readVarint(),a=s>>3,u=this.pos;this.type=7&s,r(a,e,this),this.pos===u&&this.skip(s)}return e}readMessage(r,e){return this.readFields(r,e,this.readVarint()+this.pos)}readFixed32(){const r=this.dataView.getUint32(this.pos,!0);return this.pos+=4,r}readSFixed32(){const r=this.dataView.getInt32(this.pos,!0);return this.pos+=4,r}readFixed64(){const r=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*Tv;return this.pos+=8,r}readSFixed64(){const r=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*Tv;return this.pos+=8,r}readFloat(){const r=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,r}readDouble(){const r=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,r}readVarint(r){const e=this.buf;let i,s;return s=e[this.pos++],i=127&s,s<128?i:(s=e[this.pos++],i|=(127&s)<<7,s<128?i:(s=e[this.pos++],i|=(127&s)<<14,s<128?i:(s=e[this.pos++],i|=(127&s)<<21,s<128?i:(s=e[this.pos],i|=(15&s)<<28,(function(a,u,h){const f=h.buf;let g,x;if(x=f[h.pos++],g=(112&x)>>4,x<128||(x=f[h.pos++],g|=(127&x)<<3,x<128)||(x=f[h.pos++],g|=(127&x)<<10,x<128)||(x=f[h.pos++],g|=(127&x)<<17,x<128)||(x=f[h.pos++],g|=(127&x)<<24,x<128)||(x=f[h.pos++],g|=(1&x)<<31,x<128))return Ad(a,g,u);throw new Error("Expected varint not more than 10 bytes")})(i,r,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const r=this.readVarint();return r%2==1?(r+1)/-2:r/2}readBoolean(){return!!this.readVarint()}readString(){const r=this.readVarint()+this.pos,e=this.pos;return this.pos=r,r-e>=12&&Db?Db.decode(this.buf.subarray(e,r)):(function(i,s,a){let u="",h=s;for(;h<a;){const f=i[h];let g,x,T,E=null,A=f>239?4:f>223?3:f>191?2:1;if(h+A>a)break;A===1?f<128&&(E=f):A===2?(g=i[h+1],(192&g)==128&&(E=(31&f)<<6|63&g,E<=127&&(E=null))):A===3?(g=i[h+1],x=i[h+2],(192&g)==128&&(192&x)==128&&(E=(15&f)<<12|(63&g)<<6|63&x,(E<=2047||E>=55296&&E<=57343)&&(E=null))):A===4&&(g=i[h+1],x=i[h+2],T=i[h+3],(192&g)==128&&(192&x)==128&&(192&T)==128&&(E=(15&f)<<18|(63&g)<<12|(63&x)<<6|63&T,(E<=65535||E>=1114112)&&(E=null))),E===null?(E=65533,A=1):E>65535&&(E-=65536,u+=String.fromCharCode(E>>>10&1023|55296),E=56320|1023&E),u+=String.fromCharCode(E),h+=A}return u})(this.buf,e,r)}readBytes(){const r=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,r);return this.pos=r,e}readPackedVarint(r=[],e){const i=this.readPackedEnd();for(;this.pos<i;)r.push(this.readVarint(e));return r}readPackedSVarint(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSVarint());return r}readPackedBoolean(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readBoolean());return r}readPackedFloat(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFloat());return r}readPackedDouble(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readDouble());return r}readPackedFixed32(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed32());return r}readPackedSFixed32(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed32());return r}readPackedFixed64(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed64());return r}readPackedSFixed64(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed64());return r}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(r){const e=7&r;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(r,e){this.writeVarint(r<<3|e)}realloc(r){let e=this.length||16;for(;e<this.pos+r;)e*=2;if(e!==this.length){const i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.dataView=new DataView(i.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeSFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*Rb),!0),this.pos+=8}writeSFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*Rb),!0),this.pos+=8}writeVarint(r){(r=+r||0)>268435455||r<0?(function(e,i){let s,a;if(e>=0?(s=e%4294967296|0,a=e/4294967296|0):(s=~(-e%4294967296),a=~(-e/4294967296),4294967295^s?s=s+1|0:(s=0,a=a+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");i.realloc(10),(function(u,h,f){f.buf[f.pos++]=127&u|128,u>>>=7,f.buf[f.pos++]=127&u|128,u>>>=7,f.buf[f.pos++]=127&u|128,u>>>=7,f.buf[f.pos++]=127&u|128,f.buf[f.pos]=127&(u>>>=7)})(s,0,i),(function(u,h){const f=(7&u)<<4;h.buf[h.pos++]|=f|((u>>>=3)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u)))))})(a,i)})(r,this):(this.realloc(4),this.buf[this.pos++]=127&r|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=r>>>7&127))))}writeSVarint(r){this.writeVarint(r<0?2*-r-1:2*r)}writeBoolean(r){this.writeVarint(+r)}writeString(r){r=String(r),this.realloc(4*r.length),this.pos++;const e=this.pos;this.pos=(function(s,a,u){for(let h,f,g=0;g<a.length;g++){if(h=a.charCodeAt(g),h>55295&&h<57344){if(!f){h>56319||g+1===a.length?(s[u++]=239,s[u++]=191,s[u++]=189):f=h;continue}if(h<56320){s[u++]=239,s[u++]=191,s[u++]=189,f=h;continue}h=f-55296<<10|h-56320|65536,f=null}else f&&(s[u++]=239,s[u++]=191,s[u++]=189,f=null);h<128?s[u++]=h:(h<2048?s[u++]=h>>6|192:(h<65536?s[u++]=h>>12|224:(s[u++]=h>>18|240,s[u++]=h>>12&63|128),s[u++]=h>>6&63|128),s[u++]=63&h|128)}return u})(this.buf,r,this.pos);const i=this.pos-e;i>=128&&Ob(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i}writeFloat(r){this.realloc(4),this.dataView.setFloat32(this.pos,r,!0),this.pos+=4}writeDouble(r){this.realloc(8),this.dataView.setFloat64(this.pos,r,!0),this.pos+=8}writeBytes(r){const e=r.length;this.writeVarint(e),this.realloc(e);for(let i=0;i<e;i++)this.buf[this.pos++]=r[i]}writeRawMessage(r,e){this.pos++;const i=this.pos;r(e,this);const s=this.pos-i;s>=128&&Ob(i,s,this),this.pos=i-1,this.writeVarint(s),this.pos+=s}writeMessage(r,e,i){this.writeTag(r,2),this.writeRawMessage(e,i)}writePackedVarint(r,e){e.length&&this.writeMessage(r,AA,e)}writePackedSVarint(r,e){e.length&&this.writeMessage(r,CA,e)}writePackedBoolean(r,e){e.length&&this.writeMessage(r,LA,e)}writePackedFloat(r,e){e.length&&this.writeMessage(r,MA,e)}writePackedDouble(r,e){e.length&&this.writeMessage(r,PA,e)}writePackedFixed32(r,e){e.length&&this.writeMessage(r,RA,e)}writePackedSFixed32(r,e){e.length&&this.writeMessage(r,DA,e)}writePackedFixed64(r,e){e.length&&this.writeMessage(r,OA,e)}writePackedSFixed64(r,e){e.length&&this.writeMessage(r,zA,e)}writeBytesField(r,e){this.writeTag(r,2),this.writeBytes(e)}writeFixed32Field(r,e){this.writeTag(r,5),this.writeFixed32(e)}writeSFixed32Field(r,e){this.writeTag(r,5),this.writeSFixed32(e)}writeFixed64Field(r,e){this.writeTag(r,1),this.writeFixed64(e)}writeSFixed64Field(r,e){this.writeTag(r,1),this.writeSFixed64(e)}writeVarintField(r,e){this.writeTag(r,0),this.writeVarint(e)}writeSVarintField(r,e){this.writeTag(r,0),this.writeSVarint(e)}writeStringField(r,e){this.writeTag(r,2),this.writeString(e)}writeFloatField(r,e){this.writeTag(r,5),this.writeFloat(e)}writeDoubleField(r,e){this.writeTag(r,1),this.writeDouble(e)}writeBooleanField(r,e){this.writeVarintField(r,+e)}};function Ad(r,e,i){return i?4294967296*e+(r>>>0):4294967296*(e>>>0)+(r>>>0)}function Ob(r,e,i){const s=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(s);for(let a=i.pos-1;a>=r;a--)i.buf[a+s]=i.buf[a]}function AA(r,e){for(let i=0;i<r.length;i++)e.writeVarint(r[i])}function CA(r,e){for(let i=0;i<r.length;i++)e.writeSVarint(r[i])}function MA(r,e){for(let i=0;i<r.length;i++)e.writeFloat(r[i])}function PA(r,e){for(let i=0;i<r.length;i++)e.writeDouble(r[i])}function LA(r,e){for(let i=0;i<r.length;i++)e.writeBoolean(r[i])}function RA(r,e){for(let i=0;i<r.length;i++)e.writeFixed32(r[i])}function DA(r,e){for(let i=0;i<r.length;i++)e.writeSFixed32(r[i])}function OA(r,e){for(let i=0;i<r.length;i++)e.writeFixed64(r[i])}function zA(r,e){for(let i=0;i<r.length;i++)e.writeSFixed64(r[i])}const Ev=3;function kA(r,e,i){e.glyphs=[],r===1&&i.readMessage(FA,e)}function FA(r,e,i){if(r===3){const{id:s,bitmap:a,width:u,height:h,left:f,top:g,advance:x}=i.readMessage(BA,{});e.glyphs.push({id:s,bitmap:new Lc({width:u+2*Ev,height:h+2*Ev},a),metrics:{width:u,height:h,left:f,top:g,advance:x}})}else r===4?e.ascender=i.readSVarint():r===5&&(e.descender=i.readSVarint())}function BA(r,e,i){r===1?e.id=i.readVarint():r===2?e.bitmap=i.readBytes():r===3?e.width=i.readVarint():r===4?e.height=i.readVarint():r===5?e.left=i.readSVarint():r===6?e.top=i.readSVarint():r===7&&(e.advance=i.readVarint())}const zb=Ev,Wo={horizontal:1,vertical:2,horizontalOnly:3};class Mp{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const s=new Mp;return s.scale=e||1,s.fontStack=i,s}static forImage(e){const i=new Mp;return i.image=e,i}}class Cd{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,s){const a=new Cd;for(let u=0;u<e.sections.length;u++){const h=e.sections[u];h.image?a.addImageSection(h,s):a.addTextSection(h,i)}return a}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=(function(i,s){let a="";for(let u=0;u<i.length;u++){const h=i.charCodeAt(u+1)||null,f=i.charCodeAt(u-1)||null;a+=!s&&(h&&qh(h)&&!Cp[i[u+1]]||f&&qh(f)&&!Cp[i[u-1]])||!Cp[i[u]]?i[u]:Cp[i[u]]}return a})(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&W_[this.text.charCodeAt(s)];s++)e++;let i=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&W_[this.text.charCodeAt(s)];s--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const s=new Cd;return s.text=this.text.substring(e,i),s.sectionIndex=this.sectionIndex.slice(e,i),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((e,i)=>Math.max(e,this.sections[i].scale)),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(Mp.forText(e.scale,e.fontStack||i));const s=this.sections.length-1;for(let a=0;a<e.text.length;++a)this.sectionIndex.push(s)}addImageSection(e,i){const s=e.image?e.image.getPrimary():null;if(!s)return void It("Can't add FormattedSection with an empty image.");s.scaleSelf(i);const a=this.getNextImageSectionCharCode();a?(this.text+=String.fromCodePoint(a),this.sections.push(Mp.forImage(s)),this.sectionIndex.push(this.sections.length-1)):It("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Sv(r,e,i,s,a,u,h,f,g,x,T,E,A,P,L,F=1){const U=Cd.fromFeature(r,a,F);E===Wo.vertical&&U.verticalizePunctuation(A);let V=[];const $=(function(me,xe,Ee,Ge,Me,$e){if(!me)return[];const Ke=[],Qe=(function(rt,Ze,qe,ot,yt,ft){let Nt=0;for(let Et=0;Et<rt.length();Et++){const Ct=rt.getSection(Et);Nt+=kb(rt.getCodePoint(Et),Ct,ot,yt,Ze,ft)}return Nt/Math.max(1,Math.ceil(Nt/qe))})(me,xe,Ee,Ge,Me,$e),at=me.text.indexOf("â")>=0;let ct=0;for(let rt=0;rt<me.length();rt++){const Ze=me.getSection(rt),qe=me.getCodePoint(rt);if(W_[qe]||(ct+=kb(qe,Ze,Ge,Me,xe,$e)),rt<me.length()-1){const ot=!((tt=qe)<11904||!(Yt["Bopomofo Extended"](tt)||Yt.Bopomofo(tt)||Yt["CJK Compatibility Forms"](tt)||Yt["CJK Compatibility Ideographs"](tt)||Yt["CJK Compatibility"](tt)||Yt["CJK Radicals Supplement"](tt)||Yt["CJK Strokes"](tt)||Yt["CJK Symbols and Punctuation"](tt)||Yt["CJK Unified Ideographs Extension A"](tt)||Yt["CJK Unified Ideographs"](tt)||Yt["Enclosed CJK Letters and Months"](tt)||Yt["Halfwidth and Fullwidth Forms"](tt)||Yt.Hiragana(tt)||Yt["Ideographic Description Characters"](tt)||Yt["Kangxi Radicals"](tt)||Yt["Katakana Phonetic Extensions"](tt)||Yt.Katakana(tt)||Yt["Vertical Forms"](tt)||Yt["Yi Radicals"](tt)||Yt["Yi Syllables"](tt)));(NA[qe]||ot||Ze.image)&&Ke.push(Bb(rt+1,ct,Qe,Ke,VA(qe,me.getCodePoint(rt+1),ot&&at),!1))}}var tt;return Nb(Bb(me.length(),ct,Qe,Ke,0,!0))})(U,x,u,e,s,P),{processBidirectionalText:X,processStyledBidirectionalText:Q}=xa;if(X&&U.sections.length===1){const me=X(U.toString(),$);for(const xe of me){const Ee=new Cd;Ee.text=xe,Ee.sections=U.sections;for(let Ge=0;Ge<xe.length;Ge++)Ee.sectionIndex.push(0);V.push(Ee)}}else if(Q){const me=Q(U.text,U.sectionIndex,$);for(const xe of me){const Ee=new Cd;Ee.text=xe[0],Ee.sectionIndex=xe[1],Ee.sections=U.sections,V.push(Ee)}}else V=(function(me,xe){const Ee=[],Ge=me.text;let Me=0;for(const $e of xe)Ee.push(me.substring(Me,$e)),Me=$e;return Me<Ge.length&&Ee.push(me.substring(Me,Ge.length)),Ee})(U,$);const de=[],ae={positionedLines:de,text:U.toString(),top:T[1],bottom:T[1],left:T[0],right:T[0],writingMode:E,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if((function(me,xe,Ee,Ge,Me,$e,Ke,Qe,at,ct,tt,rt){let Ze=0,qe=0,ot=0;const yt=Qe==="right"?1:Qe==="left"?0:.5;let ft=!1;for(const pt of Me){const zt=pt.getSections();for(const oi of zt){if(oi.image)continue;const Oi=xe[oi.fontStack];if(Oi&&(ft=Oi.ascender!==void 0&&Oi.descender!==void 0,!ft))break}if(!ft)break}let Nt=0;for(const pt of Me){pt.trim();const zt=pt.getMaxScale(),oi=(zt-1)*zn,Oi={positionedGlyphs:[],lineOffset:0};me.positionedLines[Nt]=Oi;const Ni=Oi.positionedGlyphs;let pi=0;if(!pt.length()){qe+=$e,++Nt;continue}let pr=0,le=0;for(let We=0;We<pt.length();We++){const lt=pt.getSection(We),bt=pt.getSectionIndex(We),wt=pt.getCodePoint(We);let Vt=lt.scale,qt=null,hi=null,bi=null,Ei=zn,Mi=0,Qt=at;Qt===Wo.vertical&&((Et=wt)===12312||Et===12313||Et===12316||Et===12540||Et===12448)&&(Qt=Wo.horizontal);const ni=!(Qt===Wo.horizontal||!tt&&!Gh(wt)||tt&&(W_[wt]||Hh(wt)));if(lt.image){const Hi=Ge.get(lt.image.toString());if(!Hi)continue;bi=lt.image,me.iconsInText=me.iconsInText||!0,hi=Hi.paddedRect;const Ki=Hi.displaySize;Vt=Vt*zn/rt,qt={width:Ki[0],height:Ki[1],left:0,top:-zb,advance:ni?Ki[1]:Ki[0],localGlyph:!1},Mi=ft?-qt.height*Vt:zt*zn-17-Ki[1]*Vt,Ei=qt.advance;const Qi=(ni?Ki[0]:Ki[1])*Vt-zn*zt;Qi>0&&Qi>pi&&(pi=Qi)}else{const Hi=Ee[lt.fontStack];if(!Hi)continue;Hi[wt]&&(hi=Hi[wt]);const Ki=xe[lt.fontStack];if(!Ki)continue;const Qi=Ki.glyphs[wt];if(!Qi)continue;if(qt=Qi.metrics,Ei=wt!==8203?zn:0,ft){const ur=Ki.ascender!==void 0?Math.abs(Ki.ascender):0,br=Ki.descender!==void 0?Math.abs(Ki.descender):0,mr=(ur+br)*Vt;pr<mr&&(pr=mr,le=(ur-br)/2*Vt),Mi=-ur*Vt}else Mi=(zt-Vt)*zn-17}ni?(me.verticalizable=!0,Ni.push({glyph:wt,image:bi,x:Ze,y:qe+Mi,vertical:ni,scale:Vt,localGlyph:qt.localGlyph,fontStack:lt.fontStack,sectionIndex:bt,metrics:qt,rect:hi}),Ze+=Ei*Vt+ct):(Ni.push({glyph:wt,image:bi,x:Ze,y:qe+Mi,vertical:ni,scale:Vt,localGlyph:qt.localGlyph,fontStack:lt.fontStack,sectionIndex:bt,metrics:qt,rect:hi}),Ze+=qt.advance*Vt+ct)}Ni.length!==0&&(ot=Math.max(Ze-ct,ot),ft?Vb(Ni,yt,pi,le,$e*zt/2):Vb(Ni,yt,pi,0,$e/2)),Ze=0;const fe=$e*zt+pi;Oi.lineOffset=Math.max(pi,oi),qe+=fe,++Nt}var Et;const Ct=qe,{horizontalAlign:Ot,verticalAlign:Ii}=Iv(Ke);(function(pt,zt,oi,Oi,Ni,pi){const pr=(zt-oi)*Ni,le=-pi*Oi;for(const fe of pt)for(const We of fe.positionedGlyphs)We.x+=pr,We.y+=le})(me.positionedLines,yt,Ot,Ii,ot,Ct),me.top+=-Ii*Ct,me.bottom=me.top+Ct,me.left+=-Ot*ot,me.right=me.left+ot,me.hasBaseline=ft})(ae,e,i,s,V,h,f,g,E,x,A,L),!(function(me){for(const xe of me)if(xe.positionedGlyphs.length!==0)return!1;return!0})(de))return ae}const W_={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},NA={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function kb(r,e,i,s,a,u){if(e.image){const h=s.get(e.image.toString());return h?h.displaySize[0]*e.scale*zn/u+a:0}{const h=i[e.fontStack],f=h&&h.glyphs[r];return f?f.metrics.advance*e.scale+a:0}}function Fb(r,e,i,s){const a=Math.pow(r-e,2);return s?r<e?a/2:2*a:a+Math.abs(i)*i}function VA(r,e,i){let s=0;return r===10&&(s-=1e4),i&&(s+=150),r!==40&&r!==65288||(s+=50),e!==41&&e!==65289||(s+=50),s}function Bb(r,e,i,s,a,u){let h=null,f=Fb(e,i,a,u);for(const g of s){const x=Fb(e-g.x,i,a,u)+g.badness;x<=f&&(h=g,f=x)}return{index:r,x:e,priorBreak:h,badness:f}}function Nb(r){return r?Nb(r.priorBreak).concat(r.index):[]}function Iv(r){let e=.5,i=.5;switch(r){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function Vb(r,e,i,s,a){if(!(e||i||s||a))return;const u=r.length-1,h=r[u],f=(h.x+h.metrics.advance*h.scale)*e;for(let g=0;g<=u;g++)r[g].x-=f,r[g].y+=i+s+a}function Av(r){return r.imagePrimary!==void 0&&r.top!==void 0&&r.bottom!==void 0&&r.left!==void 0&&r.right!==void 0}function X_(r,e,i,s){const{horizontalAlign:a,verticalAlign:u}=Iv(s),h=i[0]-r.displaySize[0]*a,f=i[1]-r.displaySize[1]*u;return{imagePrimary:r,imageSecondary:e,top:f,bottom:f+r.displaySize[1],left:h,right:h+r.displaySize[0]}}function Cv(r,e,i,s,a,u){const h=r.imagePrimary;let f;if(h.content){const U=h.content,V=h.pixelRatio||1;f=[U[0]/V,U[1]/V,h.displaySize[0]-U[2]/V,h.displaySize[1]-U[3]/V]}const g=e.left*u,x=e.right*u;let T,E,A,P;i==="width"||i==="both"?(P=a[0]+g-s[3],E=a[0]+x+s[1]):(P=a[0]+(g+x-h.displaySize[0])/2,E=P+h.displaySize[0]);const L=e.top*u,F=e.bottom*u;return i==="height"||i==="both"?(T=a[1]+L-s[0],A=a[1]+F+s[2]):(T=a[1]+(L+F-h.displaySize[1])/2,A=T+h.displaySize[1]),{imagePrimary:h,imageSecondary:void 0,top:T,right:E,bottom:A,left:P,collisionPadding:f}}function Ub(r){return!r.imagePrimary.stretchX}function jb(r){return!r.imagePrimary.stretchY}function Gb(r){return{width:r.right-r.left,height:r.bottom-r.top}}const Pa=128;function Md(r,e,i){const{expression:s}=e;if(s.kind==="constant")return{kind:"constant",layoutSize:s.evaluate(new Ar(r+1,{worldview:i}))};if(s.kind==="source")return{kind:"source"};{const{zoomStops:a,interpolationType:u}=s;let h=0;for(;h<a.length&&a[h]<=r;)h++;h=Math.max(0,h-1);let f=h;for(;f<a.length&&a[f]<r+1;)f++;f=Math.min(a.length-1,f);const g=a[h],x=a[f];return s.kind==="composite"?{kind:"composite",minZoom:g,maxZoom:x,interpolationType:u}:{kind:"camera",minZoom:g,maxZoom:x,minSize:s.evaluate(new Ar(g,{worldview:i})),maxSize:s.evaluate(new Ar(x,{worldview:i})),interpolationType:u}}}function Mv(r,{uSize:e,uSizeT:i},{lowerSize:s,upperSize:a}){return r.kind==="source"?s/Pa:r.kind==="composite"?ei(s/Pa,a/Pa,i):e}function Pd(r,e,i=1){let s=0,a=0;if(r.kind==="constant")a=r.layoutSize*i;else if(r.kind!=="source"){const{interpolationType:u,minZoom:h,maxZoom:f}=r,g=u?j(Go.interpolationFactor(u,e,h,f),0,1):0;r.kind==="camera"?a=ei(r.minSize,r.maxSize,g)*i:s=g*i}return{uSizeT:s,uSize:a}}class Xl extends st{constructor(e,i,s,a,u){super(e,i),this.angle=a,this.z=s,u!==void 0&&(this.segment=u)}clone(){return new Xl(this.x,this.y,this.z,this.angle,this.segment)}}function qb(r,e,i,s,a){if(e.segment===void 0)return!0;let u=e,h=e.segment+1,f=0;for(;f>-i/2;){if(h--,h<0)return!1;f-=r[h].dist(u),u=r[h]}f+=r[h].dist(r[h+1]),h++;const g=[];let x=0;for(;f<i/2;){const T=r[h],E=r[h+1];if(!E)return!1;let A=r[h-1].angleTo(T)-T.angleTo(E);for(A=Math.abs((A+3*Math.PI)%(2*Math.PI)-Math.PI),g.push({distance:f,angleDelta:A}),x+=A;f-g[0].distance>s;)x-=g.shift().angleDelta;if(x>a)return!1;h++,f+=T.dist(E)}return!0}function Hb(r){let e=0;for(let i=0;i<r.length-1;i++)e+=r[i].dist(r[i+1]);return e}function Zb(r,e,i){return r?.6*e*i:0}function $b(r,e){return Math.max(r?r.right-r.left:0,e?e.right-e.left:0)}function UA(r,e,i,s,a,u){const h=Zb(i,a,u),f=$b(i,s)*u;let g=0;const x=Hb(r)/2;for(let T=0;T<r.length-1;T++){const E=r[T],A=r[T+1],P=E.dist(A);if(g+P>x){const L=(x-g)/P,F=ei(E.x,A.x,L),U=ei(E.y,A.y,L),V=new Xl(F,U,0,A.angleTo(E),T);return!h||qb(r,V,f,h,e)?V:void 0}g+=P}}function jA(r,e,i,s,a,u,h,f,g){const x=Zb(s,u,h),T=$b(s,a),E=T*h,A=r[0].x===0||r[0].x===g||r[0].y===0||r[0].y===g;return e-E<e/4&&(e=E+e/4),Wb(r,A?e/2*f%e:(T/2+2*u)*h*f%e,e,x,i,E,A,!1,g)}function Wb(r,e,i,s,a,u,h,f,g){const x=u/2,T=Hb(r);let E=0,A=e-i,P=[];for(let L=0;L<r.length-1;L++){const F=r[L],U=r[L+1],V=F.dist(U),$=U.angleTo(F);for(;A+i<E+V;){A+=i;const X=(A-E)/V,Q=ei(F.x,U.x,X),de=ei(F.y,U.y,X);if(Q>=0&&Q<g&&de>=0&&de<g&&A-x>=0&&A+x<=T){const ae=new Xl(Q,de,0,$,L);s&&!qb(r,ae,u,s,a)||P.push(ae)}}E+=V}return f||P.length||h||(P=Wb(r,E/2,i,s,a,u,h,!0,g)),P}function Xb(r){let e=0,i=0;for(const h of r)e+=h.w*h.h,i=Math.max(i,h.w);r.sort(((h,f)=>f.h-h.h));const s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let a=0,u=0;for(const h of r)for(let f=s.length-1;f>=0;f--){const g=s[f];if(!(h.w>g.w||h.h>g.h)){if(h.x=g.x,h.y=g.y,u=Math.max(u,h.y+h.h),a=Math.max(a,h.x+h.w),h.w===g.w&&h.h===g.h){const x=s.pop();x&&f<s.length&&(s[f]=x)}else h.h===g.h?(g.x+=h.w,g.w-=h.w):h.w===g.w?(g.y+=h.h,g.h-=h.h):(s.push({x:g.x+h.w,y:g.y,w:g.w-h.w,h:h.h}),g.y+=h.h,g.h-=h.h);break}}return{w:a,h:u,fill:e/(a*u)||0}}Lt(Xl,"Anchor");const ju=1;class Pp{static getImagePositionScale(e,i,s){if(i&&e){const{sx:a,sy:u}=e;return{x:a,y:u}}return{x:s,y:s}}constructor(e,i,s,a){this.paddedRect=e;const{pixelRatio:u,version:h,stretchX:f,stretchY:g,content:x,sdf:T,usvg:E}=i;this.pixelRatio=u,this.stretchX=f,this.stretchY=g,this.content=x,this.version=h,this.padding=s,this.sdf=T,this.usvg=E,this.scale=Pp.getImagePositionScale(a,E,u)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function Pv(r,e,i){const s=fa.parse(r),a=(function(u,h,f=[1,1]){return{x:0,y:0,w:(u.data?u.data.width:u.width*f[0])+2*h,h:(u.data?u.data.height:u.height*f[1])+2*h}})(e,i,[s.sx,s.sy]);return{bin:a,imagePosition:new Pp(a,e,i,s),imageVariant:s}}class Yb{constructor(e,i,s){const a=new Map,u=new Map;this.haveRenderCallbacks=[];const h=[];this.addImages(e,a,ju,h),this.addImages(i,u,2,h);const{w:f,h:g}=Xb(h),x=new ro({width:f||1,height:g||1});for(const[T,E]of e.entries()){const A=a.get(T).paddedRect;ro.copy(E.data,x,{x:0,y:0},{x:A.x+ju,y:A.y+ju},E.data,null,E.sdf)}for(const[T,E]of i.entries()){const A=u.get(T),P=A.paddedRect;let L=A.padding;const F=P.x+L,U=P.y+L,V=E.data.width,$=E.data.height;L=L>1?L-1:L,ro.copy(E.data,x,{x:0,y:0},{x:F,y:U},E.data,s),ro.copy(E.data,x,{x:0,y:$-L},{x:F,y:U-L},{width:V,height:L},s),ro.copy(E.data,x,{x:0,y:0},{x:F,y:U+$},{width:V,height:L},s),ro.copy(E.data,x,{x:V-L,y:0},{x:F-L,y:U},{width:L,height:$},s),ro.copy(E.data,x,{x:0,y:0},{x:F+V,y:U},{width:L,height:$},s),ro.copy(E.data,x,{x:V-L,y:$-L},{x:F-L,y:U-L},{width:L,height:L},s),ro.copy(E.data,x,{x:0,y:$-L},{x:F+V,y:U-L},{width:L,height:L},s),ro.copy(E.data,x,{x:0,y:0},{x:F+V,y:U+$},{width:L,height:L},s),ro.copy(E.data,x,{x:V-L,y:0},{x:F-L,y:U+$},{width:L,height:L},s)}this.lut=s,this.image=x,this.iconPositions=a,this.patternPositions=u}addImages(e,i,s,a){for(const[u,h]of e.entries()){const{bin:f,imagePosition:g,imageVariant:x}=Pv(u,h,s);i.set(u,g),a.push(f),h.hasRenderCallback&&this.haveRenderCallbacks.push(x.id)}}patchUpdatedImages(e,i,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((a=>e.hasImage(a,s))),e.dispatchRenderCallbacks(this.haveRenderCallbacks,s);for(const a of e.getUpdatedImages(s)){for(const u of this.iconPositions.keys()){const h=fa.parse(u);if(so.isEqual(h.id,a)){const f=e.getImage(a,s);this.patchUpdatedImage(this.iconPositions.get(u),f,i,null)}}for(const u of this.patternPositions.keys()){const h=fa.parse(u);if(so.isEqual(h.id,a)){const f=e.getImage(a,s);this.patchUpdatedImage(this.patternPositions.get(u),f,i,this.lut)}}}}patchUpdatedImage(e,i,s,a=null){if(!e||!i||e.version===i.version)return;e.version=i.version;const[u,h]=e.tl,f=e.sdf;if(this.lut||f){const g={width:i.data.width,height:i.data.height},x=new ro(g);ro.copy(i.data,x,{x:0,y:0},{x:0,y:0},g,a,f),s.update(x,{position:{x:u,y:h}})}else s.update(i.data,{position:{x:u,y:h}})}}Lt(Pp,"ImagePosition"),Lt(Yb,"ImageAtlas");const Lp=1e20;function Jb(r,e,i,s,a,u,h,f,g){for(let x=e;x<e+s;x++)Kb(r,i*u+x,u,a,h,f,g);for(let x=i;x<i+a;x++)Kb(r,x*u+e,1,s,h,f,g)}function Kb(r,e,i,s,a,u,h){u[0]=0,h[0]=-Lp,h[1]=Lp,a[0]=r[e];for(let f=1,g=0,x=0;f<s;f++){a[f]=r[e+f*i];const T=f*f;do{const E=u[g];x=(a[f]-a[E]+T-E*E)/(f-E)/2}while(x<=h[g]&&--g>-1);g++,u[g]=f,h[g]=x,h[g+1]=Lp}for(let f=0,g=0;f<s;f++){for(;h[g+1]<f;)g++;const x=u[g],T=f-x;r[e+f*i]=a[x]+T*T}}const La=2,Lv={none:0,ideographs:1,all:2};class Ld{constructor(e,i,s){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=s,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,i){const s=[],a=this.url||Ri.GLYPHS_URL;for(const u in e)for(const h of e[u])s.push({stack:u,id:h});be(s,(({stack:u,id:h},f)=>{let g=this.entries[u];g||(g=this.entries[u]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let x=g.glyphs[h];if(x!==void 0)return void f(null,{stack:u,id:h,glyph:x});if(x=this._tinySDF(g,u,h),x)return g.glyphs[h]=x,void f(null,{stack:u,id:h,glyph:x});const T=Math.floor(h/256);if(256*T>65535)return It("glyphs > 65535 not supported"),void f(null,{stack:u,id:h,glyph:x});if(g.ranges[T])return void f(null,{stack:u,id:h,glyph:x});let E=g.requests[T];E||(E=g.requests[T]=[],Ld.loadGlyphRange(u,T,a,this.requestManager,((A,P)=>{if(P){g.ascender=P.ascender,g.descender=P.descender;for(const L in P.glyphs)this._doesCharSupportLocalGlyph(+L)||(g.glyphs[+L]=P.glyphs[+L]);g.ranges[T]=!0}for(const L of E)L(A,P);delete g.requests[T]}))),E.push(((A,P)=>{A?f(A):P&&f(null,{stack:u,id:h,glyph:P.glyphs[h]||null})}))}),((u,h)=>{if(u)i(u);else if(h){const f={};for(const{stack:g,id:x,glyph:T}of h)f[g]===void 0&&(f[g]={}),f[g].glyphs===void 0&&(f[g].glyphs={}),f[g].glyphs[x]=T&&{id:T.id,bitmap:T.bitmap.clone(),metrics:T.metrics},f[g].ascender=this.entries[g].ascender,f[g].descender=this.entries[g].descender;i(null,f)}}))}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Lv.none&&(this.localGlyphMode===Lv.all?!!this.localFontFamily:!!this.localFontFamily&&(Yt["CJK Unified Ideographs"](e)||Yt["Hangul Syllables"](e)||Yt.Hiragana(e)||Yt.Katakana(e)||Yt["CJK Symbols and Punctuation"](e)||Yt["CJK Unified Ideographs Extension A"](e)||Yt["CJK Unified Ideographs Extension B"](e)||Yt.Osage(e)))}_tinySDF(e,i,s){const a=this.localFontFamily;if(!a||!this._doesCharSupportLocalGlyph(s))return;let u=e.tinySDF;if(!u){let F="400";/bold/i.test(i)?F="900":/medium/i.test(i)?F="500":/light/i.test(i)&&(F="200"),u=e.tinySDF=new Ld.TinySDF({fontFamily:a,fontWeight:F,fontSize:24*La,buffer:3*La,radius:8*La}),u.fontWeight=F}if(this.localGlyphs[u.fontWeight][s])return this.localGlyphs[u.fontWeight][s];const h=String.fromCodePoint(s),{data:f,width:g,height:x,glyphWidth:T,glyphHeight:E,glyphLeft:A,glyphTop:P,glyphAdvance:L}=u.draw(h);return this.localGlyphs[u.fontWeight][s]={id:s,bitmap:new Lc({width:g,height:x},f),metrics:{width:T/La,height:E/La,left:A/La,top:P/La-27,advance:L/La,localGlyph:!0}}}}Ld.loadGlyphRange=function(r,e,i,s,a){const u=256*e,h=u+255,f=s.transformRequest(s.normalizeGlyphsURL(i).replace("{fontstack}",r).replace("{range}",`${u}-${h}`),Qc.Glyphs);da(f,((g,x)=>{if(g)a(g);else if(x){const T={},E=(function(A){return new $_(A).readFields(kA,{})})(x);for(const A of E.glyphs)T[A.id]=A;a(null,{glyphs:T,ascender:E.ascender,descender:E.descender})}}))},Ld.TinySDF=class{constructor({fontSize:r=24,buffer:e=3,radius:i=8,cutoff:s=.25,fontFamily:a="sans-serif",fontWeight:u="normal",fontStyle:h="normal",lang:f=null}={}){this.buffer=e,this.cutoff=s,this.radius=i,this.lang=f;const g=this.size=r+4*e,x=this._createCanvas(g),T=this.ctx=x.getContext("2d",{willReadFrequently:!0});T.font=`${h} ${u} ${r}px ${a}`,T.textBaseline="alphabetic",T.textAlign="left",T.fillStyle="black",this.gridOuter=new Float64Array(g*g),this.gridInner=new Float64Array(g*g),this.f=new Float64Array(g),this.z=new Float64Array(g+1),this.v=new Uint16Array(g)}_createCanvas(r){const e=document.createElement("canvas");return e.width=e.height=r,e}draw(r){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:s,actualBoundingBoxLeft:a,actualBoundingBoxRight:u}=this.ctx.measureText(r),h=Math.ceil(i),f=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(u-a))),g=Math.min(this.size-this.buffer,h+Math.ceil(s)),x=f+2*this.buffer,T=g+2*this.buffer,E=Math.max(x*T,0),A=new Uint8ClampedArray(E),P={data:A,width:x,height:T,glyphWidth:f,glyphHeight:g,glyphTop:h,glyphLeft:0,glyphAdvance:e};if(f===0||g===0)return P;const{ctx:L,buffer:F,gridInner:U,gridOuter:V}=this;this.lang&&(L.lang=this.lang),L.clearRect(F,F,f,g),L.fillText(r,F,F+h);const $=L.getImageData(F,F,f,g);V.fill(Lp,0,E),U.fill(0,0,E);for(let X=0;X<g;X++)for(let Q=0;Q<f;Q++){const de=$.data[4*(X*f+Q)+3]/255;if(de===0)continue;const ae=(X+F)*x+Q+F;if(de===1)V[ae]=0,U[ae]=Lp;else{const me=.5-de;V[ae]=me>0?me*me:0,U[ae]=me<0?me*me:0}}Jb(V,0,0,x,T,x,this.f,this.v,this.z),Jb(U,F,F,f,g,x,this.f,this.v,this.z);for(let X=0;X<E;X++){const Q=Math.sqrt(V[X])-Math.sqrt(U[X]);A[X]=Math.round(255-255*(Q/this.radius+this.cutoff))}return P}};const ul=ju;function Qb(r,e){return r+e[1]-e[0]}function Rv(r,e,i,s,a=1){const u=[],h=r.imagePrimary,f=h.pixelRatio,g=h.paddedRect.w-2*ul,x=h.paddedRect.h-2*ul,T=(r.right-r.left)*a,E=(r.bottom-r.top)*a,A=h.stretchX||[[0,g]],P=h.stretchY||[[0,x]],L=A.reduce(Qb,0),F=P.reduce(Qb,0),U=g-L,V=x-F;let $=0,X=L,Q=0,de=F,ae=0,me=U,xe=0,Ee=V;if(h.content&&s){const Me=h.content;$=Y_(A,0,Me[0]),Q=Y_(P,0,Me[1]),X=Y_(A,Me[0],Me[2]),de=Y_(P,Me[1],Me[3]),ae=Me[0]-$,xe=Me[1]-Q,me=Me[2]-Me[0]-X,Ee=Me[3]-Me[1]-de}const Ge=(Me,$e,Ke,Qe)=>{const at=J_(Me.stretch-$,X,T,r.left*a),ct=K_(Me.fixed-ae,me,Me.stretch,L),tt=J_($e.stretch-Q,de,E,r.top*a),rt=K_($e.fixed-xe,Ee,$e.stretch,F),Ze=J_(Ke.stretch-$,X,T,r.left*a),qe=K_(Ke.fixed-ae,me,Ke.stretch,L),ot=J_(Qe.stretch-Q,de,E,r.top*a),yt=K_(Qe.fixed-xe,Ee,Qe.stretch,F),ft=new st(at,tt),Nt=new st(Ze,tt),Et=new st(Ze,ot),Ct=new st(at,ot),Ot=new st(ct/f,rt/f),Ii=new st(qe/f,yt/f),pt=e*Math.PI/180;if(pt){const pr=Math.sin(pt),le=Math.cos(pt),fe=[le,-pr,pr,le];ft._matMult(fe),Nt._matMult(fe),Ct._matMult(fe),Et._matMult(fe)}const zt=Me.stretch+Me.fixed,oi=Ke.stretch+Ke.fixed,Oi=$e.stretch+$e.fixed,Ni=Qe.stretch+Qe.fixed,pi=r.imageSecondary;return{tl:ft,tr:Nt,bl:Ct,br:Et,texPrimary:{x:h.paddedRect.x+ul+zt,y:h.paddedRect.y+ul+Oi,w:oi-zt,h:Ni-Oi},texSecondary:pi?{x:pi.paddedRect.x+ul+zt,y:pi.paddedRect.y+ul+Oi,w:oi-zt,h:Ni-Oi}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Ot,pixelOffsetBR:Ii,minFontScaleX:me/f/T,minFontScaleY:Ee/f/E,isSDF:i}};if(s&&(h.stretchX||h.stretchY)){const Me=ew(A,U,L),$e=ew(P,V,F);for(let Ke=0;Ke<Me.length-1;Ke++){const Qe=Me[Ke],at=Me[Ke+1];for(let ct=0;ct<$e.length-1;ct++)u.push(Ge(Qe,$e[ct],at,$e[ct+1]))}}else u.push(Ge({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:g+1},{fixed:0,stretch:x+1}));return u}function GA(r,e){const i=r.stretchY||[[0,r.paddedRect.h-2*ul]];return e&&(r.stretchX||r.stretchY)?tw(r.stretchX||[[0,r.paddedRect.w-2*ul]])*tw(i):1}function Y_(r,e,i){let s=0;for(const a of r)s+=Math.max(e,Math.min(i,a[1]))-Math.max(e,Math.min(i,a[0]));return s}function ew(r,e,i){const s=[{fixed:-ul,stretch:0}];for(const[a,u]of r){const h=s[s.length-1];s.push({fixed:a-h.stretch,stretch:h.stretch}),s.push({fixed:a-h.stretch,stretch:h.stretch+(u-a)})}return s.push({fixed:e+ul,stretch:i}),s}function tw(r){return 2*r.length+1}function J_(r,e,i,s){return r/e*i+s}function K_(r,e,i,s){return r-e*i/s}function qA(r,e,i,s){const a=e+r.positionedLines[s].lineOffset;return s===0?i+a/2:i+(a+(e+r.positionedLines[s-1].lineOffset))/2}function HA(r,e=1,i=!1){let s=1/0,a=1/0,u=-1/0,h=-1/0;const f=r[0];for(let P=0;P<f.length;P++){const L=f[P];(!P||L.x<s)&&(s=L.x),(!P||L.y<a)&&(a=L.y),(!P||L.x>u)&&(u=L.x),(!P||L.y>h)&&(h=L.y)}const g=Math.min(u-s,h-a);let x=g/2;const T=new bh([],ZA);if(g===0)return new st(s,a);for(let P=s;P<u;P+=g)for(let L=a;L<h;L+=g)T.push(new Rd(P+x,L+x,x,r));let E=(function(P){let L=0,F=0,U=0;const V=P[0];for(let $=0,X=V.length,Q=X-1;$<X;Q=$++){const de=V[$],ae=V[Q],me=de.x*ae.y-ae.x*de.y;F+=(de.x+ae.x)*me,U+=(de.y+ae.y)*me,L+=3*me}return new Rd(F/L,U/L,0,P)})(r),A=T.length;for(;T.length;){const P=T.pop();(P.d>E.d||!E.d)&&(E=P,i&&console.log("found best %d after %d probes",Math.round(1e4*P.d)/1e4,A)),P.max-E.d<=e||(x=P.h/2,T.push(new Rd(P.p.x-x,P.p.y-x,x,r)),T.push(new Rd(P.p.x+x,P.p.y-x,x,r)),T.push(new Rd(P.p.x-x,P.p.y+x,x,r)),T.push(new Rd(P.p.x+x,P.p.y+x,x,r)),A+=4)}return i&&(console.log(`num probes: ${A}`),console.log(`best distance: ${E.d}`)),E.p}function ZA(r,e){return e.max-r.max}class Rd{constructor(e,i,s,a){this.p=new st(e,i),this.h=s,this.d=(function(u,h){let f=!1,g=1/0;for(let x=0;x<h.length;x++){const T=h[x];for(let E=0,A=T.length,P=A-1;E<A;P=E++){const L=T[E],F=T[P];L.y>u.y!=F.y>u.y&&u.x<(F.x-L.x)*(u.y-L.y)/(F.y-L.y)+L.x&&(f=!f),g=Math.min(g,sn(u,L,F))}}return(f?1:-1)*Math.sqrt(g)})(this.p,a),this.max=this.d+this.h*Math.SQRT2}}const $A=Object.keys,Dv=Number.POSITIVE_INFINITY,WA=Math.sqrt(2);function Dc(r,e,i,s,a){const u=Av(r)&&r.collisionPadding?r.collisionPadding:[0,0,0,0],h={top:r.top-u[1],bottom:r.bottom+u[3],left:r.left-u[0],right:r.right+u[2],scaled:!1};return s!==void 0&&(function(f,g){f.top*=g,f.bottom*=g,f.left*=g,f.right*=g,f.scaled=!0})(h,s),i&&(function(f,g){if(!g)return;const x=Yi(g),T=new st(f.left,f.top),E=new st(f.right,f.top),A=new st(f.left,f.bottom),P=new st(f.right,f.bottom),L=new st(0,0);T._rotateAround(x,L),E._rotateAround(x,L),A._rotateAround(x,L),P._rotateAround(x,L),f.left=Math.min(T.x,E.x,A.x,P.x),f.right=Math.max(T.x,E.x,A.x,P.x),f.top=Math.min(T.y,E.y,A.y,P.y),f.bottom=Math.max(T.y,E.y,A.y,P.y)})(h,i),a&&(h.left+=a[0],h.right+=a[0],h.top+=a[1],h.bottom+=a[1]),e?{top:Math.min(e.top,h.top),bottom:Math.max(e.bottom,h.bottom),left:Math.min(e.left,h.left),right:Math.max(e.right,h.right),scaled:e.scaled||h.scaled}:h}function iw(r,[e,i]){let s=0,a=0;if(i===Dv){e<0&&(e=0);const u=e/WA;switch(r){case"top-right":case"top-left":a=u-7;break;case"bottom-right":case"bottom-left":a=7-u;break;case"bottom":a=7-e;break;case"top":a=e-7}switch(r){case"top-right":case"bottom-right":s=-u;break;case"top-left":case"bottom-left":s=u;break;case"left":s=e;break;case"right":s=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),r){case"top-right":case"top-left":case"top":a=i-7;break;case"bottom-right":case"bottom-left":case"bottom":a=7-i}switch(r){case"top-right":case"bottom-right":case"right":s=-e;break;case"top-left":case"bottom-left":case"left":s=e}}return[s,a]}function XA(r,e,i,s,a,u,h,f,g,x,T,E,A,P){const L=r.layers[0],F=L.appearances;if(F.length===0)return{iconBBox:null,iconVerticalBBox:null,textBBox:null,textVerticalBBox:null};const U={iconBBox:null,iconVerticalBBox:null},V={textBBox:null,textVerticalBBox:null},{baseIconRotate:$,baseTextRotate:X,iconScaleFactor:Q}=(function(ae,me,xe){const Ee=ae.get("icon-rotate").evaluate(me,{},xe),Ge=ae.get("text-rotate").evaluate(me,{},xe),[Me,$e]=ae.get("icon-size-scale-range");return{baseIconRotate:Ee,baseTextRotate:Ge,iconScaleFactor:j(1,Me,$e)}})(s,a,u);e&&(U.iconBBox=Dc(e,U.iconBBox,$,h),i)&&(U.iconVerticalBBox=Dc(i,U.iconVerticalBBox,$+90,h));const de=eg(E.horizontal);de&&(V.textBBox=Dc(de,V.textBBox,X,1,P)),E.vertical&&(V.textVerticalBBox=Dc(E.vertical,V.textVerticalBBox,X+90,1,P));for(const ae of F)ae.hasIconProperties()&&YA(U,r,L,ae,a,u,f,$,h,g,e,x,Q,T),ae.hasTextProperties()&&JA(V,L,ae,a,u,P,X,A,de,E.vertical);return{iconBBox:U.iconBBox,iconVerticalBBox:U.iconVerticalBBox,textBBox:V.textBBox,textVerticalBBox:V.textVerticalBBox}}function YA(r,e,i,s,a,u,h,f,g,x,T,E,A,P){const{appearanceIconOffset:L,appearanceIconRotate:F,appearanceIconSize:U}=(function(Q,de,ae,me,xe,Ee,Ge,Me){const $e=Q.hasProperty("icon-offset")?de.getAppearanceValueAndResolveTokens(Q,"icon-offset",ae,me,[]):null,Ke=$e&&Array.isArray($e)?$e:xe,Qe=Q.hasProperty("icon-rotate")?de.getAppearanceValueAndResolveTokens(Q,"icon-rotate",ae,me,[]):null,at=typeof Qe=="number"?Qe:Ee,ct=Q.hasProperty("icon-size")?de.getAppearanceValueAndResolveTokens(Q,"icon-size",ae,me,[]):null;return{appearanceIconOffset:Ke,appearanceIconRotate:at,appearanceIconSize:typeof ct=="number"?ct*Me.iconScaleFactor:Ge}})(s,i,a,u,h,f,g,x);let V=null,$=null,X=null;s.hasProperty("icon-image")?X=(function(Q,de,ae,me,xe,Ee,Ge){let Me=null;const $e=de.getAppearanceValueAndResolveTokens(ae,"icon-image",me,xe,[]);if($e){const Ke=Q.getResolvedImageFromTokens($e),Qe=ae.getUnevaluatedProperty("icon-size"),at=Rp(Ke,Md(Q.zoom,Qe,Q.worldview),Qe,xe,Q.zoom,me,Q.pixelRatio,Ge,Q.worldview);Me=Ee.get(at.iconPrimary.toString())}return Me})(e,i,s,a,u,E,A):T&&(X=T.imagePrimary),X&&(V=X_(X,null,L,P),e.allowVerticalPlacement&&($=X_(X,null,L,P))),V&&(r.iconBBox=Dc(V,r.iconBBox,F,U)),$&&(r.iconVerticalBBox=Dc($,r.iconVerticalBBox,F+90,U))}function JA(r,e,i,s,a,u,h,f,g,x){const{appearanceTextOffset:T,appearanceTextRotate:E,appearanceTextSize:A}=(function(L,F,U,V,$,X,Q){const de=L.hasProperty("text-offset")?F.getAppearanceValueAndResolveTokens(L,"text-offset",U,V,[]):null,ae=de&&Array.isArray(de)?[de[0]*zn,de[1]*zn]:$,me=L.hasProperty("text-rotate")?F.getAppearanceValueAndResolveTokens(L,"text-rotate",U,V,[]):null,xe=typeof me=="number"?me:X,Ee=L.hasProperty("text-size")?F.getAppearanceValueAndResolveTokens(L,"text-size",U,V,[]):null;return{appearanceTextOffset:ae,appearanceTextRotate:xe,appearanceTextSize:typeof Ee=="number"?Ee:Q}})(i,e,s,a,u,h,f),P=A/f;g&&(r.textBBox=Dc(g,r.textBBox,E,P,T)),x&&(r.textVerticalBBox=Dc(x,r.textVerticalBBox,E+90,P,T))}function Q_(r,e,i,s,a,u,h,f,g){if(!e||!e.usvg)return;const x=Gb(s),T=Gb(a),E=u!=="both"&&u!=="width"||!Ub(s)?1:T.width/x.width,A=u!=="both"&&u!=="height"||!jb(s)?1:T.height/x.height;i.scaleSelf(E,A);const P=i.toString();h.set(P,i),f.set(P,e);const{imagePosition:L}=Pv(P,e,ju);g.set(P,L)}function rw(r,e,i,s,a,u,h,f,g){if(!r)return;const x=(function(T,E,A,P,L,F){if(T.kind==="camera")return T.maxSize;if(T.kind==="composite"){const U=E.possiblyEvaluate(new Ar(T.maxZoom,{worldview:F}),A).evaluate(L,{},A),V=E.possiblyEvaluate(new Ar(T.minZoom,{worldview:F}),A).evaluate(L,{},A);return Math.max(U,V)}return E.possiblyEvaluate(new Ar(P,{worldview:F})).evaluate(L,{},A)})(e,i,s,a,u,g);return r.scaleSelf(x*f*h)}function Rp(r,e,i,s,a,u,h,f,g){return{iconPrimary:rw(r.getPrimary(),e,i,s,a,u,h,f,g),iconSecondary:rw(r.getSecondary(),e,i,s,a,u,h,f,g)}}function KA(r,e,i){if(!e)return;const s=i.get(r.toString()),a=i.get(e.toString());s&&a&&(s.paddedRect.w===a.paddedRect.w&&s.paddedRect.h===a.paddedRect.h||It(`Mismatch in icon variant sizes: ${r.toString()} and ${e.toString()}`),s.usvg!==a.usvg&&It(`Mismatch in icon variant image types: ${r.id} and ${e.id}`))}function nw(r,e,i,s){if(!r)return;const a=e.get(i.toString());if(r.imagePrimary=a,s){const u=e.get(s.toString());r.imageSecondary=u}}function QA(r,e){for(const i in r.horizontal)ow(r.horizontal[i],e);ow(r.vertical,e)}function ow(r,e){if(r){for(const i of r.positionedLines)for(const s of i.positionedGlyphs)if(s.image!==null){const a=s.image.toString();s.rect=e.get(a).paddedRect}}}function Ov(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function e3(r,e,i,s,a,u,h,f,g){const x=eg(u.horizontal)||u.vertical,T=i.get("icon-text-fit-padding").evaluate(s,{},a);let E,A=e;return e&&g!=="none"&&(r.allowVerticalPlacement&&u.vertical&&(E=Cv(e,u.vertical,g,T,f,h)),x&&(A=Cv(e,x,g,T,f,h))),{defaultShapedIcon:A,verticallyShapedIcon:E}}function t3(r,e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U,V,$,X,Q,de,ae,me){let xe=h.textMaxSize.evaluate(e,{},A);xe===void 0?xe=f*h.textScaleFactor:xe*=h.textScaleFactor;const Ee=r.layers[0].layout,Ge=zn,Me=f*h.textScaleFactor/Ge,$e=eg(i.horizontal)||i.vertical;if(U!=="none"&&r.appearanceFeatureData&&e.index<r.appearanceFeatureData.length){const Et=r.appearanceFeatureData[e.index];Et&&(Et.textShaping=$e,Et.iconTextFitPadding=Ee.get("icon-text-fit-padding").evaluate(e,{},A),Et.fontScale=Me)}const Ke=P.name==="globe",Qe=r.tilePixelRatio*xe/Ge,at=(ot=r.overscaling,r.zoom>18&&ot>2&&(ot>>=1),Math.max(gt/(512*ot),1)*Ee.get("symbol-spacing")),ct=Ee.get("text-padding")*r.tilePixelRatio,tt=Ee.get("icon-padding")*r.tilePixelRatio,rt=Yi(Ee.get("text-max-angle")),Ze=Ee.get("icon-rotation-alignment")==="map"&&X!=="point",qe=at/2;var ot;r.hasAnyIconTextFit===!1&&U!=="none"&&(r.hasAnyIconTextFit=!0);const yt=e.properties?+e.properties[He]:null,ft=yt&&r.elevationFeatureIdToIndex?r.elevationFeatureIdToIndex.get(yt):65535,Nt=(Et,Ct,Ot)=>{if(Ct.x<0||Ct.x>=gt||Ct.y<0||Ct.y>=gt)return;let Ii=null;if(Ke){const{x:pt,y:zt,z:oi}=P.projectTilePoint(Ct.x,Ct.y,Ot);Ii={anchor:new Xl(pt,zt,oi,0,void 0),up:P.upVector(Ot,Ct.x,Ct.y)}}(function(pt,zt,oi,Oi,Ni,pi,pr,le,fe,We,lt,bt,wt,Vt,qt,hi,bi,Ei,Mi,Qt,ni,Hi,Ki,Qi,ur,br,mr,tr,sr,wi,Fi,zr,Jt){const Pi=pt.addToLineVertexArray(zt,Oi);let _r,Er,Cr,cn,Sr,Kt,Vr,hr=0,Dr=0,Tn=0,kn=0,mn=-1,_n=-1;const Pn={};let Io=ch("");const Ir=oi?oi.anchor:zt,an=tr!=="none";let un=0,Ro=0;if(fe._unevaluatedLayout.getValue("text-radial-offset")===void 0){const Yn=fe.layout.get("text-offset").evaluate(ni,{},ur);un=Yn[0]*zn,Ro=Yn[1]*zn}else un=fe.layout.get("text-radial-offset").evaluate(ni,{},ur)*zn,Ro=Dv;if(pt.allowVerticalPlacement&&Ni.vertical){const Yn=Ni.vertical;if(qt)Kt=zv(Yn),le&&(Vr=zv(le));else{const _o=fe.layout.get("text-rotate").evaluate(ni,{},ur)+90;Cr=tg(We,Ir,zt,lt,bt,wt,Yn,Vt,_o,hi,zr),le&&(cn=tg(We,Ir,zt,lt,bt,wt,le,Ei,_o,null,Fi))}}if(pi){const Yn=pt.iconSizeData,_o=fe.layout.get("icon-rotate").evaluate(ni,{},ur),Xo=Rv(pi,_o,Ki,an,Hi.iconScaleFactor),kc=le?Rv(le,_o,Ki,an,Hi.iconScaleFactor):void 0;Er=tg(We,Ir,zt,lt,bt,wt,pi,Ei,_o,null,wi);const Nd=(function(za,Yp,E2,fC,S2,I2,pC,mC){const A2=za.layers[0],C2=A2.appearances;let Vd=Yp.length;if(E2&&(Vd=Math.max(Vd,E2.length)),C2.length===0)return Vd;const[_C,gC]=fC.get("icon-size-scale-range"),yC=j(1,_C,gC);for(const M2 of C2){const P2=M2.getUnevaluatedProperties();if(P2._values["icon-image"].value!==void 0){const L2=A2.getAppearanceValueAndResolveTokens(M2,"icon-image",S2,I2,[]);if(L2){const R2=za.getResolvedImageFromTokens(L2);if(R2){const D2=P2._values["icon-size"],vC=Rp(R2,Md(za.zoom,D2,za.worldview),D2,I2,za.zoom,S2,za.pixelRatio,yC,za.worldview),xC=pC.get(vC.iconPrimary.toString());Vd=Math.max(Vd,GA(xC,mC))}}}}return Vd})(pt,Xo,kc,fe.layout,ni,ur,pt.iconAtlasPositions,an);hr=4*Nd;let Oa=null;Yn.kind==="source"?(Oa=[Pa*fe.layout.get("icon-size").evaluate(ni,{},ur)*Hi.iconScaleFactor],Oa[0]>Yl&&It(`${pt.layerIds[0]}: Value for "icon-size" is >= ${Dp}. Reduce your "icon-size".`)):Yn.kind==="composite"&&(Oa=[Pa*Hi.compositeIconSizes[0].evaluate(ni,{},ur)*Hi.iconScaleFactor,Pa*Hi.compositeIconSizes[1].evaluate(ni,{},ur)*Hi.iconScaleFactor],(Oa[0]>Yl||Oa[1]>Yl)&&It(`${pt.layerIds[0]}: Value for "icon-size" is >= ${Dp}. Reduce your "icon-size".`)),pt.addSymbols(pt.icon,Xo,Oa,Qt,Mi,ni,void 0,oi,zt,Pi.lineStartIndex,Pi.lineLength,-1,Qi,ur,br,mr,pt.symbolInstances.length,Nd),mn=pt.icon.placedSymbolArray.length-1,kc&&(Dr=4*Nd,pt.addSymbols(pt.icon,kc,Oa,Qt,Mi,ni,Wo.vertical,oi,zt,Pi.lineStartIndex,Pi.lineLength,-1,Qi,ur,br,mr,pt.symbolInstances.length,Nd),_n=pt.icon.placedSymbolArray.length-1)}for(const Yn in Ni.horizontal){const _o=Yn,Xo=Ni.horizontal[_o];_r||(Io=ch(Xo.text),qt?Sr=zv(Xo):_r=tg(We,Ir,zt,lt,bt,wt,Xo,Vt,fe.layout.get("text-rotate").evaluate(ni,{},ur),hi,zr));const kc=Xo.positionedLines.length===1;if(Tn+=sw(pt,oi,zt,Xo,pr,fe,qt,ni,hi,Pi,Ni.vertical?Wo.horizontal:Wo.horizontalOnly,kc?$A(Ni.horizontal):[_o],Pn,mn,Hi,Qi,ur,pt.symbolInstances.length,br),kc)break}Ni.vertical&&(kn+=sw(pt,oi,zt,Ni.vertical,pr,fe,qt,ni,hi,Pi,Wo.vertical,["vertical"],Pn,_n,Hi,Qi,ur,pt.symbolInstances.length,br));let En=-1;const ia=(Yn,_o)=>Yn?Math.max(Yn,_o):_o;En=ia(Sr,En),En=ia(Kt,En),En=ia(Vr,En);const hl=En>-1?1:0;pt.glyphOffsetArray.length>=65535&&It("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),ni.sortKey!==void 0&&pt.addToSortKeyRanges(pt.symbolInstances.length,ni.sortKey),pt.symbolInstances.emplaceBack(zt.x,zt.y,Ir.x,Ir.y,Ir.z,Pn.right>=0?Pn.right:-1,Pn.center>=0?Pn.center:-1,Pn.left>=0?Pn.left:-1,Pn.vertical>=0?Pn.vertical:-1,mn,_n,Io,_r!==void 0?_r:pt.collisionBoxArray.length,_r!==void 0?_r+1:pt.collisionBoxArray.length,Cr!==void 0?Cr:pt.collisionBoxArray.length,Cr!==void 0?Cr+1:pt.collisionBoxArray.length,Er!==void 0?Er:pt.collisionBoxArray.length,Er!==void 0?Er+1:pt.collisionBoxArray.length,cn||pt.collisionBoxArray.length,cn?cn+1:pt.collisionBoxArray.length,lt,Tn,kn,hr,Dr,hl,0,un,Ro,En,0,an?1:0,sr)})(r,Ct,Ii,Et,i,s,u,a,r.layers[0],r.collisionBoxArray,e.index,e.sourceLayerIndex,r.index,ct,$,x,0,tt,Ze,V,e,h,T,E,A,L,F,U,ft,Q,de,ae)};if(X==="line")for(const Et of k_(e.geometry,0,0,gt,gt)){const Ct=jA(Et,at,rt,i.vertical||$e,s,Ge,Qe,r.overscaling,gt);for(const Ot of Ct)$e&&i3(r,$e.text,qe,Ot)||Nt(Et,Ot,A)}else if(X==="line-center"){for(const Et of e.geometry)if(Et.length>1){const Ct=UA(Et,rt,i.vertical||$e,s,Ge,Qe);Ct&&Nt(Et,Ct,A)}}else if(e.type==="Polygon")for(const Et of mp(e.geometry,0)){const Ct=HA(Et,16);Nt(Et[0],new Xl(Ct.x,Ct.y,0,0,void 0),A)}else if(e.type==="LineString")for(const Et of e.geometry)Nt(Et,new Xl(Et[0].x,Et[0].y,0,0,void 0),A);else if(e.type==="Point")for(const Et of e.geometry)for(const Ct of Et)Nt([Ct],new Xl(Ct.x,Ct.y,0,0,void 0),A)}const Dp=255,Yl=Dp*Pa;function sw(r,e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U,V,$){const X=(function(ae,me,xe,Ee,Ge,Me,$e,Ke){const Qe=[];if(me.positionedLines.length===0)return Qe;const at=Ee.layout.get("text-rotate").evaluate(Me,{})*Math.PI/180,ct=(function(ot){const yt=ot[0],ft=ot[1],Nt=yt*ft;return Nt>0?[yt,-ft]:Nt<0?[-yt,ft]:yt===0?[ft,yt]:[ft,-yt]})(xe);let tt=Math.abs(me.top-me.bottom);for(const ot of me.positionedLines)tt-=ot.lineOffset;const rt=me.positionedLines.length,Ze=tt/rt;let qe=me.top-xe[1];for(let ot=0;ot<rt;++ot){const yt=me.positionedLines[ot];qe=qA(me,Ze,qe,ot);for(const ft of yt.positionedGlyphs){if(!ft.rect)continue;const Nt=ft.rect||{};let Et=zb+1,Ct=!0,Ot=1,Ii=0;if(ft.image){const bi=$e.get(ft.image.toString());if(!bi)continue;if(bi.sdf){It("SDF images are not supported in formatted text and will be ignored.");continue}Ct=!1,Ot=bi.pixelRatio,Et=ju/Ot}const pt=(Ge||Ke)&&ft.vertical,zt=ft.metrics.advance*ft.scale/2,oi=ft.metrics,Oi=ft.rect;if(Oi===null)continue;Ke&&me.verticalizable&&(Ii=ft.image?zt-ft.metrics.width*ft.scale/2:0);const Ni=Ge?[ft.x+zt,ft.y]:[0,0];let pi=[0,0],pr=[0,0],le=!1;Ge||(pt?(pr=[ft.x+zt+ct[0],ft.y+ct[1]-Ii],le=!0):pi=[ft.x+zt+xe[0],ft.y+xe[1]-Ii]);const fe=Oi.w*ft.scale/(Ot*(ft.localGlyph?La:1)),We=Oi.h*ft.scale/(Ot*(ft.localGlyph?La:1));let lt,bt,wt,Vt;if(pt){const bi=ft.y-qe,Ei=new st(-zt,zt-bi),Mi=-Math.PI/2,Qt=new st(...pr);lt=new st(-zt+pi[0],pi[1]),lt._rotateAround(Mi,Ei)._add(Qt),lt.x+=-bi+zt,lt.y-=(oi.left-Et)*ft.scale;const ni=ft.image?oi.advance*ft.scale:zn*ft.scale,Hi=String.fromCodePoint(ft.glyph);SA(Hi)?lt.x+=(1-Et)*ft.scale:IA(Hi)?lt.x+=ni-oi.height*ft.scale+(-Et-1)*ft.scale:lt.x+=ft.image||oi.width+2*Et===Oi.w&&oi.height+2*Et===Oi.h?(ni-We)/2:(ni-(oi.height+2*Et)*ft.scale)/2,bt=new st(lt.x,lt.y-fe),wt=new st(lt.x+We,lt.y),Vt=new st(lt.x+We,lt.y-fe)}else{const bi=(oi.left-Et)*ft.scale-zt+pi[0],Ei=(-oi.top-Et)*ft.scale+pi[1],Mi=bi+fe,Qt=Ei+We;lt=new st(bi,Ei),bt=new st(Mi,Ei),wt=new st(bi,Qt),Vt=new st(Mi,Qt)}if(at){let bi;bi=Ge?new st(0,0):le?new st(ct[0],ct[1]):new st(xe[0],xe[1]),lt._rotateAround(at,bi),bt._rotateAround(at,bi),wt._rotateAround(at,bi),Vt._rotateAround(at,bi)}const qt=new st(0,0),hi=new st(0,0);Qe.push({tl:lt,tr:bt,bl:wt,br:Vt,texPrimary:Nt,texSecondary:void 0,writingMode:me.writingMode,glyphOffset:Ni,sectionIndex:ft.sectionIndex,isSDF:Ct,pixelOffsetTL:qt,pixelOffsetBR:hi,minFontScaleX:0,minFontScaleY:0})}}return Qe})(0,s,g,u,h,f,a,r.allowVerticalPlacement),Q=r.textSizeData;let de=null;Q.kind==="source"?(de=[Pa*u.layout.get("text-size").evaluate(f,{},U)*L.textScaleFactor],de[0]>Yl&&It(`${r.layerIds[0]}: Value for "text-size" is >= ${Dp}. Reduce your "text-size".`)):Q.kind==="composite"&&(de=[Pa*L.compositeTextSizes[0].evaluate(f,{},U)*L.textScaleFactor,Pa*L.compositeTextSizes[1].evaluate(f,{},U)*L.textScaleFactor],(de[0]>Yl||de[1]>Yl)&&It(`${r.layerIds[0]}: Value for "text-size" is >= ${Dp}. Reduce your "text-size".`)),r.addSymbols(r.text,X,de,g,h,f,T,e,i,x.lineStartIndex,x.lineLength,P,F,U,$,!1,V,X.length);for(const ae of E)A[ae]=r.text.placedSymbolArray.length-1;return 4*X.length}function eg(r){for(const e in r)return r[e];return null}function tg(r,e,i,s,a,u,h,f,g,x,T){let E,A,P,L;if(E=T?T.top:h.top,A=T?T.bottom:h.bottom,P=T?T.left:h.left,L=T?T.right:h.right,Av(h)&&h.collisionPadding){const F=h.collisionPadding;P-=F[0],E-=F[1],L+=F[2],A+=F[3]}if(g){const F=new st(P,E),U=new st(L,E),V=new st(P,A),$=new st(L,A),X=Yi(g);let Q=new st(0,0);x&&(Q=new st(x[0],x[1])),F._rotateAround(X,Q),U._rotateAround(X,Q),V._rotateAround(X,Q),$._rotateAround(X,Q),P=Math.min(F.x,U.x,V.x,$.x),L=Math.max(F.x,U.x,V.x,$.x),E=Math.min(F.y,U.y,V.y,$.y),A=Math.max(F.y,U.y,V.y,$.y)}return r.emplaceBack(e.x,e.y,e.z,i.x,i.y,P,E,L,A,f,s,a,u),r.length-1}function zv(r){Av(r)&&r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);const e=r.bottom-r.top;return e>0?Math.max(10,e):null}function i3(r,e,i,s){const a=r.compareText;if(e in a){const u=a[e];for(let h=u.length-1;h>=0;h--)if(s.dist(u[h])<i)return!0}else a[e]=[];return a[e].push(s),!1}function aw(r,e){const i=r.fovAboveCenter,s=r.elevation?r.elevation.getMinElevationBelowMSL()*e:0,a=(r._camera.position[2]*r.worldSize-s)/Math.cos(r._pitch),u=Math.sin(i)*a/Math.sin(Math.max(Math.PI/2-r._pitch-i,.01));let h=Math.sin(r._pitch)*u+a;const f=a*(1/r._horizonShift);if(!r.elevation||r.elevation.exaggeration()===0){let g=Math.max(r.zoom-17,0);r.isOrthographic&&(g/=10),h*=1+g}return Math.min(1.01*h,f)}function Op(r,e){if(!e.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:e};const i=Math.pow(2,-r.z),s=r.x*i,a=(r.x+1)*i,u=r.y*i,h=(r.y+1)*i,f=C(s),g=C(a),x=O(u),T=O(h),E=e.project(f,x),A=e.project(g,x),P=e.project(g,T),L=e.project(f,T);let F=Math.min(E.x,A.x,P.x,L.x),U=Math.min(E.y,A.y,P.y,L.y),V=Math.max(E.x,A.x,P.x,L.x),$=Math.max(E.y,A.y,P.y,L.y);const X=i/16;function Q(ae,me,xe,Ee,Ge,Me){const $e=(xe+Ge)/2,Ke=(Ee+Me)/2,Qe=e.project(C($e),O(Ke)),at=Math.max(0,F-Qe.x,U-Qe.y,Qe.x-V,Qe.y-$);F=Math.min(F,Qe.x),V=Math.max(V,Qe.x),U=Math.min(U,Qe.y),$=Math.max($,Qe.y),at>X&&(Q(ae,Qe,xe,Ee,$e,Ke),Q(Qe,me,$e,Ke,Ge,Me))}Q(E,A,s,u,a,u),Q(A,P,a,u,a,h),Q(P,L,a,h,s,h),Q(L,E,s,h,s,u),F-=X,U-=X,V+=X,$+=X;const de=1/Math.max(V-F,$-U);return{scale:de,x:F*de,y:U*de,x2:V*de,y2:$*de,projection:e}}function lw(r,{x:e,y:i},s=0){return new st(((e-s)*r.scale-r.x)*gt,(i*r.scale-r.y)*gt)}const r3=K(new Float32Array(16));class Oc{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new n(0,0)}projectTilePoint(e,i,s){return{x:e,y:i,z:0}}locationPoint(e,i,s,a=!0){return e._coordinatePoint(e.locationCoordinate(i,s),a)}pixelsPerMeter(e,i){return I(1,e)*i}pixelSpaceConversion(e,i,s){return 1}farthestPixelDistance(e){return aw(e,e.pixelsPerMeter)}pointCoordinate(e,i,s,a){const u=e.horizonLineFromTop(!1),h=new st(i,Math.max(u,s));return e.rayIntersectionCoordinate(e.pointRayIntersection(h,a))}pointCoordinate3D(e,i,s){const a=new st(i,s);if(e.elevation)return e.elevation.pointCoordinate(a);{const u=this.pointCoordinate(e,a.x,a.y,0);return[u.x,u.y,u.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const s=e.horizonLineFromTop();return i.y<s}createInversionMatrix(e,i){return r3}createTileMatrix(e,i,s){let a,u,h;const f=s.canonical,g=K(new Float64Array(16));if(this.isReprojectedInTileSpace){const x=Op(f,this);a=1,u=x.x+s.wrap*x.scale,h=x.y,Ae(g,g,[a/x.scale,a/x.scale,e.pixelsPerMeter/i])}else a=i/e.zoomScale(f.z),u=(f.x+Math.pow(2,f.z)*s.wrap)*a,h=f.y*a;return Oe(g,g,[u,h,0]),Ae(g,g,[a/gt,a/gt,1]),g}upVector(e,i,s){return[0,0,1]}upVectorScale(e,i,s){return{metersToTile:1}}}class n3 extends Oc{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,s]=this.parallels=e.parallels||[29.5,45.5],a=Math.sin(Yi(i));this.n=(a+Math.sin(Yi(s)))/2,this.c=1+a*(2*this.n-a),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:s,c:a,r0:u}=this,h=Yi(e-this.center[0]),f=Yi(i),g=Math.sqrt(a-2*s*Math.sin(f))/s;return{x:g*Math.sin(h*s),y:g*Math.cos(h*s)-u,z:0}}unproject(e,i){const{n:s,c:a,r0:u}=this,h=u+i;let f=Math.atan2(e,Math.abs(h))*Math.sign(h);h*s<0&&(f-=Math.PI*Math.sign(e)*Math.sign(h));const g=Yi(this.center[0])*s;f=ne(f,-Math.PI-g,Math.PI-g);const x=j(no(f/s)+this.center[0],-180,180),T=Math.asin(j((a-(e*e+h*h)*s*s)/(2*s),-1,1)),E=j(no(T),-z,z);return new n(x,E)}}const zp=1.340264,kp=-.081106,Fp=893e-6,Bp=.003796,ig=Math.sqrt(3)/2;class o3 extends Oc{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const s=Math.asin(ig*Math.sin(i)),a=s*s,u=a*a*a;return{x:.5*(e*Math.cos(s)/(ig*(zp+3*kp*a+u*(7*Fp+9*Bp*a)))/Math.PI+.5),y:1-.5*(s*(zp+kp*a+u*(Fp+Bp*a))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,a=s*s,u=a*a*a;for(let T,E,A,P=0;P<12&&(E=s*(zp+kp*a+u*(Fp+Bp*a))-i,A=zp+3*kp*a+u*(7*Fp+9*Bp*a),T=E/A,s=j(s-T,-Math.PI/3,Math.PI/3),a=s*s,u=a*a*a,!(Math.abs(T)<1e-12));++P);const h=ig*e*(zp+3*kp*a+u*(7*Fp+9*Bp*a))/Math.cos(s),f=Math.asin(Math.sin(s)/ig),g=j(180*h/Math.PI,-180,180),x=j(180*f/Math.PI,-z,z);return new n(g,x)}}class s3 extends Oc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const s=360*(e-.5),a=j(360*(.5-i),-z,z);return new n(s,a)}}const Dd=Math.PI/2;function rg(r){return Math.tan((Dd+r)/2)}class a3 extends Oc{constructor(e){super(e),this.center=e.center||[0,30];const[i,s]=this.parallels=e.parallels||[30,30];let a=Yi(i),u=Yi(s);this.southernCenter=a+u<0,this.southernCenter&&(a=-a,u=-u);const h=Math.cos(a),f=rg(a);this.n=a===u?Math.sin(a):Math.log(h/Math.cos(u))/Math.log(rg(u)/f),this.f=h*Math.pow(rg(a),this.n)/this.n}project(e,i){i=Yi(i),this.southernCenter&&(i=-i),e=Yi(e-this.center[0]);const s=1e-6,{n:a,f:u}=this;u>0?i<-Dd+s&&(i=-Dd+s):i>Dd-s&&(i=Dd-s);const h=u/Math.pow(rg(i),a);let f=h*Math.sin(a*e),g=u-h*Math.cos(a*e);return f=.5*(f/Math.PI+.5),g=.5*(g/Math.PI+.5),{x:f,y:this.southernCenter?g:1-g,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:s,f:a}=this,u=a-i,h=Math.sign(u),f=Math.sign(s)*Math.sqrt(e*e+u*u);let g=Math.atan2(e,Math.abs(u))*h;u*s<0&&(g-=Math.PI*Math.sign(e)*h);const x=j(no(g/s)+this.center[0],-180,180),T=j(no(2*Math.atan(Math.pow(a/f,1/s))-Dd),-z,z);return new n(x,this.southernCenter?-T:T)}}class cw extends Oc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:v(e),y:w(i),z:0}}unproject(e,i){const s=C(e),a=O(i);return new n(s,a)}}const uw=Yi(z);class l3 extends Oc{project(e,i){const s=(i=Yi(i))*i,a=s*s;return{x:.5*((e=Yi(e))*(.8707-.131979*s+a*(a*(.003971*s-.001529*a)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+s*(.015085+a*(.028874*s-.044475-.005916*a)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,a=25,u=0,h=s*s;do{h=s*s;const x=h*h;u=(s*(1.007226+h*(.015085+x*(.028874*h-.044475-.005916*x)))-i)/(1.007226+h*(.045255+x*(.259866*h-.311325-.005916*11*x))),s=j(s-u,-uw,uw)}while(Math.abs(u)>1e-6&&--a>0);h=s*s;const f=j(no(e/(.8707+h*(h*(h*h*h*(.003971-.001529*h)-.013791)-.131979))),-180,180),g=no(s);return new n(f,g)}}const hw=Yi(z);class c3 extends Oc{project(e,i){i=Yi(i),e=Yi(e);const s=Math.cos(i),a=2/Math.PI,u=Math.acos(s*Math.cos(e/2)),h=Math.sin(u)/u,f=.5*(e*a+2*s*Math.sin(e/2)/h)||0,g=.5*(i+Math.sin(i)/h)||0;return{x:.5*(f/Math.PI+.5),y:1-.5*(g/Math.PI+1),z:0}}unproject(e,i){let s=e=(2*e-.5)*Math.PI,a=i=(2*(1-i)-1)*Math.PI,u=25;const h=1e-6;let f=0,g=0;do{const x=Math.cos(a),T=Math.sin(a),E=2*T*x,A=T*T,P=x*x,L=Math.cos(s/2),F=Math.sin(s/2),U=2*L*F,V=F*F,$=1-P*L*L,X=$?1/$:0,Q=$?Math.acos(x*L)*Math.sqrt(1/$):0,de=.5*(2*Q*x*F+2*s/Math.PI)-e,ae=.5*(Q*T+a)-i,me=.5*X*(P*V+Q*x*L*A)+1/Math.PI,xe=X*(U*E/4-Q*T*F),Ee=.125*X*(E*F-Q*T*P*U),Ge=.5*X*(A*L+Q*V*x)+.5,Me=xe*Ee-Ge*me;f=(ae*xe-de*Ge)/Me,g=(de*Ee-ae*me)/Me,s=j(s-f,-Math.PI,Math.PI),a=j(a-g,-hw,hw)}while((Math.abs(f)>h||Math.abs(g)>h)&&--u>0);return new n(no(s),no(a))}}class dw extends Oc{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Yi(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:s,cosPhi:a}=this;return{x:Yi(e)*a*s+.5,y:-Math.sin(Yi(i))/a*s+.5,z:0}}unproject(e,i){const{scale:s,cosPhi:a}=this,u=-(i-.5)/s,h=j(no((e-.5)/s)/a,-180,180),f=Math.asin(j(u*a,-1,1)),g=j(no(f),-z,z);return new n(h,g)}}class u3 extends cw{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,s){const a=cp(e,i,s);return kr(a,a,A_(Ms(s))),{x:a[0],y:a[1],z:a[2]}}locationPoint(e,i,s){const a=Ac(i.lat,i.lng),u=ui([],a),h=s?e._centerAltitude+s:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude;qn(a,a,u,I(1,0)*gt*h);const f=K(new Float64Array(16));return Le(f,e.pixelMatrix,e.globeMatrix),kr(a,a,f),new st(a[0],a[1])}pixelsPerMeter(e,i){return I(1,0)*i}pixelSpaceConversion(e,i,s){const a=I(1,e)*i,u=ei(I(1,45)*i,a,s);return this.pixelsPerMeter(e,i)/u}createTileMatrix(e,i,s){const a=Vy(Ms(s.canonical));return Le(new Float64Array(16),e.globeMatrix,a)}createInversionMatrix(e,i){const{center:s}=e,a=A_(Ms(i));return Fe(a,a,Yi(s.lng)),ze(a,a,Yi(s.lat)),Ae(a,a,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(a)}pointCoordinate(e,i,s,a){return Mc(e,i,s,!0)||new Y(0,0)}pointCoordinate3D(e,i,s){const a=this.pointCoordinate(e,i,s,0);return[a.x,a.y,a.z]}isPointAboveHorizon(e,i){return!Mc(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=(function(a,u){const h=a.cameraToCenterDistance,f=a._centerAltitude*u,g=a._camera,x=a._camera.forward(),T=Bi([],yr([],x,-h),[0,0,f]),E=a.worldSize/(2*Math.PI),A=[0,0,-E],P=a.width/a.height,L=Math.tan(a.fovAboveCenter),F=yr([],g.up(),L),U=yr([],g.right(),L*P),V=ui([],Bi([],Bi([],x,F),U)),$=[];let X;if(new Dt(T,V).closestPointOnSphere(A,E,$)){const Q=Bi([],$,A),de=Kr([],Q,T);X=Math.cos(a.fovAboveCenter)*rr(de)}else{const Q=Kr([],T,A),de=Kr([],A,T);ui(de,de);const ae=rr(Q)-E;X=Math.sqrt(ae*(ae+2*E));const me=Math.acos(X/(E+ae))-Math.acos(ki(x,de));X*=Math.cos(me)}return 1.01*X})(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),s=Pc(e.zoom);if(s>0){const a=aw(e,I(1,e.center.lat)*e.worldSize),u=e.worldSize/(2*Math.PI),h=Math.max(e.width,e.height)/e.worldSize*Math.PI;return ei(i,a+u*(1-Math.cos(h)),Math.pow(s,10))}return i}upVector(e,i,s){return cp(i,s,e,1)}upVectorScale(e){return{metersToTile:ea(I_(Ms(e)))}}}function fw(r){const e=r.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(r.name){case"mercator":return new cw(r);case"equirectangular":return new s3(r);case"naturalEarth":return new l3(r);case"equalEarth":return new o3(r);case"winkelTripel":return new c3(r);case"albers":return i?new dw(r):new n3(r);case"lambertConformalConic":return i?new dw(r):new a3(r);case"globe":return new u3(r)}throw new Error(`Invalid projection name: ${r.name}`)}const h3=Se.types,d3=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Np(r,e,i,s,a,u,h,f,g,x,T,E,A){const P=f?Math.min(Yl,Math.round(f[0])):0,L=f?Math.min(Yl,Math.round(f[1])):0;r.emplaceBack(e,i,Math.round(32*s),Math.round(32*a),u,h,(P<<1)+(g?1:0),0+(L<<1),16*x,16*T,256*E,256*A)}function Vp(r,e,i){r.emplaceBack(e,i)}function Up(r,e,i,s,a,u,h){r.emplaceBack(e,i,s,a,u,h)}const ng=(r,e,i,s)=>{for(let a=0;a<e;a++)r.emplaceBack(i[0],i[1],i[2],s[0],s[1],s[2])};function Od(r,e,i,s,a){r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a)}function f3(r){for(const e of r.sections)if(Ey(e.text))return!0;return!1}class kv{constructor(e){this.layoutVertexArray=new Zf,this.indexArray=new xn,this.programConfigurations=e,this.segments=new Fr,this.dynamicLayoutVertexArray=new ol,this.opacityVertexArray=new rd,this.placedSymbolArray=new v_,this.iconTransitioningVertexArray=new Ho,this.globeExtVertexArray=new $f,this.zOffsetVertexArray=new ba,this.orientationVertexArray=new Yf,this.symbolInstanceIndices=[]}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}getIconVertexData(e,i){const s=[],a=this.layoutVertexArray.uint16;for(let u=0;u<i;++u){const h=12*(e+u);s.push(...a.slice(h,h+12))}return s}updateIconVertexData(e,i,s,a,u,h,f,g,x,T,E,A,P){const L=this.layoutVertexArray.uint16,F=12*e;L[F]=i,L[F+1]=s,L[F+2]=a,L[F+3]=u,L[F+4]=h,L[F+5]=f,L[F+6]=g,L[F+7]=x,L[F+8]=T,L[F+9]=E,L[F+10]=A,L[F+11]=P}upload(e,i,s,a,u,h){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,mA.members,!!h),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,gA.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,d3,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,xA.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,_A.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||u)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,yA.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,vA.members,!0)),this.opacityVertexBuffer.itemSize=1),(s||a)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}Lt(kv,"SymbolBuffers");class Fv{constructor(e,i,s){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new s,this.segments=new Fr,this.collisionVertexArray=new Wf,this.collisionVertexArrayExt=new ol}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,bA.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,wA.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Lt(Fv,"CollisionBuffers");class og{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((h=>h.fqid)),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=K([]),this.placementViewportMatrix=K([]);const i=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.localizable=e.localizable,this.textSizeData=Md(this.zoom,i["text-size"],this.worldview),this.iconSizeData=Md(this.zoom,i["icon-size"],this.worldview);const s=this.layers[0].layout,a=s.get("symbol-sort-key"),u=s.get("symbol-z-order");this.lut=e.lut,this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey=u!=="viewport-y"&&a.constantOr(1)!==void 0,this.sortFeaturesByY=(u==="viewport-y"||u==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map((h=>Wo[h])),this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id)),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1,this.hasAppearances=null,this.lastActiveApperance=null,this.featureToAppearanceIndex={}}hasAnyAppearanceProperty(e){const i=this.layers[0].getAppearances();return!(!i||i.length===0)&&i.some((s=>s.getProperty(e)!=null))}createArrays(){this.text=new kv(new As(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("text")||e.startsWith("symbol")))),this.icon=new kv(new As(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("icon")||e.startsWith("symbol")))),this.glyphOffsetArray=new hd,this.lineVertexArray=new b_,this.symbolInstances=new tp}calculateGlyphDependencies(e,i,s,a,u){for(const h of e){const f=h.codePointAt(0);if(f===void 0)break;if(i[f]=!0,a&&u&&f<=65535){const g=Cp[h];g&&(i[g.charCodeAt(0)]=!0)}}}calculateEffectiveAppearanceIconSize(e,i,s,a,u,h){let f=1;const g=e.getUnevaluatedProperties()._values["icon-size"],x=Md(this.zoom,g,this.worldview),T=Pd(x,i);if(x.kind!=="constant"&&x.kind!=="camera"||(f=T.uSize),x.kind==="composite"){const{minZoom:E,maxZoom:A}=x,P=g.possiblyEvaluate(new Ar(E,{worldview:this.worldview}),a),L=g.possiblyEvaluate(new Ar(A,{worldview:this.worldview}),a),F=P.evaluate(s,{},a,u);f=F+(L.evaluate(s,{},a,u)-F)*T.uSizeT}return x.kind==="source"&&(f=g.possiblyEvaluate(new Ar(this.zoom,{worldview:this.worldview}),a).evaluate(s,{},a,u)),f*h}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const s=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!D_(this.activeReplacements,s)&&(this.activeReplacements=s,!0)}getResolvedImageFromTokens(e){return typeof e=="string"?uo.build(e):e}populate(e,i,s,a){const u=this.layers[0],h=u.layout,f=this.projection.name==="globe",g=h.get("text-font"),x=h.get("text-field"),T=h.get("icon-image"),[E,A]=h.get("icon-size-scale-range"),P=j(i.scaleFactor||1,E,A),L=(x.value.kind!=="constant"||x.value.value instanceof co&&!x.value.value.isEmpty()||x.value.value.toString().length>0)&&(g.value.kind!=="constant"||g.value.value.length>0),F=T.value.kind!=="constant"||!!T.value.value||Object.keys(T.parameters).length>0,U=this.hasAnyAppearanceProperty("icon-image"),V=h.get("symbol-sort-key");if(this.features=[],this.appearanceFeatureData=[],!L&&!F&&!U)return;const $=i.iconDependencies,X=i.glyphDependencies,Q=i.availableImages,de=new Ar(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),ae=me=>{const xe=me.id.toString();$.has(xe)?$.get(xe).push(me):$.set(xe,[me])};for(const me of e){const{feature:xe,id:Ee,index:Ge,sourceLayerIndex:Me}=me,$e=u._featureFilter.needGeometry,Ke=Ce(xe,$e);if(!u._featureFilter.filter(de,Ke,s))continue;if($e||(Ke.geometry=ye(xe,s,a)),f&&xe.type!==1&&s.z<=5){const ot=Ke.geometry,yt=.98078528056,ft=(Nt,Et)=>ki(cp(Nt.x,Nt.y,s,1),cp(Et.x,Et.y,s,1))<yt;for(let Nt=0;Nt<ot.length;Nt++)ot[Nt]=he(ot[Nt],ft)}let Qe,at;if(L){const ot=u.getValueAndResolveTokens("text-field",Ke,s,Q),yt=co.factory(ot);f3(yt)&&(this.hasRTLText=!0),(!this.hasRTLText||Su()==="unavailable"||this.hasRTLText&&xa.isParsed())&&(Qe=EA(yt,u,Ke))}if(F){const ot=u.getValueAndResolveTokens("icon-image",Ke,s,Q);at=this.getResolvedImageFromTokens(ot)}const ct=this.layers[0];let tt=!1;if(!at&&U){const ot=ct.getAppearances();for(const yt of ot)if(yt.getProperty("icon-image")){const ft=ct.getAppearanceValueAndResolveTokens(yt,"icon-image",Ke,s,Q);if(ft){at=this.getResolvedImageFromTokens(ft),tt=!0;break}}}if(!Qe&&!at)continue;const rt=this.sortFeaturesByKey?V.evaluate(Ke,{},s):void 0,Ze={id:Ee,text:Qe,icon:at,index:Ge,sourceLayerIndex:Me,geometry:Ke.geometry,properties:xe.properties,type:h3[xe.type],sortKey:rt};if(this.features.push(Ze),this.featureToAppearanceIndex[Ge]=this.appearanceFeatureData.length,this.appearanceFeatureData.push({id:Ee,properties:xe.properties,usesAppearanceIconAsPlaceholder:tt,isUsingAppearanceVertexData:!1,layoutBasedVertexData:[],activeAppearance:null}),at){const ot=ct._unevaluatedLayout._values,{iconPrimary:yt,iconSecondary:ft}=Rp(at,this.iconSizeData,ot["icon-size"],s,this.zoom,Ze,this.pixelRatio,P,this.worldview);ae(yt),ft&&(this.hasAnySecondaryIcon=!0,ae(ft))}const qe=ct.getAppearances();if(qe.length!==0&&qe.forEach((ot=>{if(!ot.getProperty("icon-image"))return;const yt=this.getCombinedIconPrimary(ot,ct,Ke,s,Q,Ze,P);yt&&ae(yt)})),Qe){const ot=g.evaluate(Ke,{},s).join(","),yt=h.get("text-rotation-alignment")==="map"&&h.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Wo.vertical)>=0;for(const ft of Qe.sections)if(ft.image){const Nt=ft.image.getPrimary().scaleSelf(this.pixelRatio),Et=Nt.id.toString(),Ct=$.get(Et)||[];Ct.push(Nt),$.set(Et,Ct)}else{const Nt=Tu(Qe.toString()),Et=ft.fontStack||ot,Ct=X[Et]=X[Et]||{};this.calculateGlyphDependencies(ft.text,Ct,yt,this.allowVerticalPlacement,Nt)}}}if(h.get("symbol-placement")==="line"&&(this.features=(function(me){const xe={},Ee={},Ge=[];let Me=0;function $e(ct){Ge.push(me[ct]),Me++}function Ke(ct,tt,rt){const Ze=Ee[ct];return delete Ee[ct],Ee[tt]=Ze,Ge[Ze].geometry[0].pop(),Ge[Ze].geometry[0]=Ge[Ze].geometry[0].concat(rt[0]),Ze}function Qe(ct,tt,rt){const Ze=xe[tt];return delete xe[tt],xe[ct]=Ze,Ge[Ze].geometry[0].shift(),Ge[Ze].geometry[0]=rt[0].concat(Ge[Ze].geometry[0]),Ze}function at(ct,tt,rt){const Ze=rt?tt[0][tt[0].length-1]:tt[0][0];return`${ct}:${Ze.x}:${Ze.y}`}for(let ct=0;ct<me.length;ct++){const tt=me[ct],rt=tt.geometry,Ze=tt.text?tt.text.toString():null;if(!Ze){$e(ct);continue}const qe=at(Ze,rt),ot=at(Ze,rt,!0);if(qe in Ee&&ot in xe&&Ee[qe]!==xe[ot]){const yt=Qe(qe,ot,rt),ft=Ke(qe,ot,Ge[yt].geometry);delete xe[qe],delete Ee[ot],Ee[at(Ze,Ge[ft].geometry,!0)]=ft,Ge[yt].geometry=null}else qe in Ee?Ke(qe,ot,rt):ot in xe?Qe(qe,ot,rt):($e(ct),xe[qe]=Me-1,Ee[ot]=Me-1)}return Ge.filter((ct=>ct.geometry))})(this.features)),h.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const me of i.elevationFeatures)this.elevationFeatureIdToIndex.set(me.id,this.elevationFeatures.length),this.elevationFeatures.push(me)}}else h.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort(((me,xe)=>me.sortKey-xe.sortKey))}getCombinedIconPrimary(e,i,s,a,u,h,f){let g,x;const T=e.getUnevaluatedProperties();if(T._values["icon-image"].value!==void 0){const E=i.getAppearanceValueAndResolveTokens(e,"icon-image",s,a,u);g=this.getResolvedImageFromTokens(E)}else{const E=i.getValueAndResolveTokens("icon-image",s,a,u);g=this.getResolvedImageFromTokens(E)}if(g){const E=T._values["icon-size"]||i._unevaluatedLayout._values["icon-size"];x=Rp(g,Md(this.zoom,E,this.worldview),E,a,this.zoom,h,this.pixelRatio,f,this.worldview).iconPrimary}return x}updateAppearanceBasedIconTextures(e,i,s,a){if(!this.appearanceFeatureData||!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)return!1;const u=this.layers[0];let h=!1,f=0;const g=u.layout,[x,T]=g.get("icon-size-scale-range"),E=j(1,x,T);for(let A=0;A<this.symbolInstances.length;A++){const P=this.symbolInstances.get(A),L=this.featureToAppearanceIndex[P.featureIndex],F=L!==void 0?this.appearanceFeatureData[L]:void 0;if(F&&P.placedIconSymbolIndex>=0){const U=F.id,V=i&&U!==void 0?i[String(U)]:void 0,$={type:"Point",id:F.id,properties:F.properties,geometry:[]},X=this.layers[0].appearances&&this.layers[0].appearances.find((Q=>Q.isActive({globals:a,feature:$,canonical:e,featureState:V})));if(F.activeAppearance===X){f+=P.numIconVertices;continue}if(X){F.activeAppearance=X;const Q=this.getCombinedIconPrimary(X,u,$,e,s,{sortKey:void 0,text:void 0,icon:null,index:P.featureIndex,sourceLayerIndex:P.featureIndex,geometry:[],properties:F.properties,type:"Point",id:F.id},E);if(!Q)continue;const de=Q.toString(),ae=this.iconAtlasPositions&&this.iconAtlasPositions.get(de);if(ae){const me=u.getAppearanceValueAndResolveTokens(X,"icon-offset",$,e,s),xe=me&&Array.isArray(me)?me:[0,0];let Ee=X_(ae,void 0,xe,u.layout.get("icon-anchor").evaluate($,{},e));const Ge=u.getAppearanceValueAndResolveTokens(X,"icon-rotate",$,e,s),Me=typeof Ge=="number"?Ge:0,$e=ae.sdf,Ke=u.layout.get("icon-text-fit").constantOr("none");Ke!=="none"&&F.textShaping&&F.iconTextFitPadding&&F.fontScale&&(Ee=Cv(Ee,F.textShaping,Ke,F.iconTextFitPadding,xe,F.fontScale));const Qe=this.calculateEffectiveAppearanceIconSize(X,a.zoom,$,e,s,E),at=0,ct=1+(Math.min(Yl,Math.round(Qe*Pa))<<1),tt=Rv(Ee,Me,$e,Ke!=="none",E);F.isUsingAppearanceVertexData||(F.isUsingAppearanceVertexData=!0,F.layoutBasedVertexData=this.icon.getIconVertexData(f,P.numIconVertices));for(let Ze=0;Ze<tt.length;++Ze){const qe=tt[Ze],ot=F.layoutBasedVertexData[0]||P.tileAnchorX,yt=F.layoutBasedVertexData[1]||P.tileAnchorY,ft=16*qe.pixelOffsetTL.x,Nt=16*qe.pixelOffsetTL.y,Et=16*qe.pixelOffsetBR.x,Ct=16*qe.pixelOffsetBR.y,Ot=16*qe.minFontScaleX,Ii=16*qe.minFontScaleY;this.icon.updateIconVertexData(f,ot,yt,Math.round(32*qe.tl.x),Math.round(32*qe.tl.y),qe.texPrimary.x,qe.texPrimary.y,at,ct,ft,Nt,Ot,Ii),this.icon.updateIconVertexData(f+1,ot,yt,Math.round(32*qe.tr.x),Math.round(32*qe.tr.y),qe.texPrimary.x+qe.texPrimary.w,qe.texPrimary.y,at,ct,Et,Nt,Ot,Ii),this.icon.updateIconVertexData(f+2,ot,yt,Math.round(32*qe.bl.x),Math.round(32*qe.bl.y),qe.texPrimary.x,qe.texPrimary.y+qe.texPrimary.h,at,ct,ft,Ct,Ot,Ii),this.icon.updateIconVertexData(f+3,ot,yt,Math.round(32*qe.br.x),Math.round(32*qe.br.y),qe.texPrimary.x+qe.texPrimary.w,qe.texPrimary.y+qe.texPrimary.h,at,ct,Et,Ct,Ot,Ii),f+=4}const rt=P.numIconVertices-4*tt.length;for(let Ze=0;Ze<rt;++Ze)this.icon.updateIconVertexData(f+Ze,0,0,0,0,0,0,0,0,0,0,0,0);h=!0}else f+=P.numIconVertices}else if(F.usesAppearanceIconAsPlaceholder)this.layers[0].appearances&&this.layers[0].appearances.length>0&&(this.icon.updateIconVertexData(f,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(f+1,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(f+2,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(f+3,0,0,0,0,0,0,0,0,0,0,0,0),h=!0),f+=P.numIconVertices,F.activeAppearance=null;else if(F.isUsingAppearanceVertexData){const de=F.layoutBasedVertexData.length/12;for(let ae=0;ae<de;++ae){const me=ae*12;this.icon.updateIconVertexData(f+ae,F.layoutBasedVertexData[me+0],F.layoutBasedVertexData[me+1],F.layoutBasedVertexData[me+2],F.layoutBasedVertexData[me+3],F.layoutBasedVertexData[me+4],F.layoutBasedVertexData[me+5],F.layoutBasedVertexData[me+6],F.layoutBasedVertexData[me+7],F.layoutBasedVertexData[me+8],F.layoutBasedVertexData[me+9],F.layoutBasedVertexData[me+10],F.layoutBasedVertexData[me+11])}f+=de,F.isUsingAppearanceVertexData=!1,F.activeAppearance=null,h=!0}else f+=P.numIconVertices,F.activeAppearance=null}}return h}update(e,i,s,a,u,h,f){this.text.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let i=!1;const s=q(e),a=1/s;let u=!1,h=!1;for(let f=0;f<this.symbolInstances.length;f++){const g=this.symbolInstances.get(f),x=Li(1,0,0),T=Li(0,1,0),{numHorizontalGlyphVertices:E,numVerticalGlyphVertices:A,numIconVertices:P,numVerticalIconVertices:L}=g,F=E>0||A>0,U=P>0,V=this.elevationFeatures[g.elevationFeatureIndex];if(V){const $=new st(g.tileAnchorX,g.tileAnchorY),X=.075+V.pointElevation($);g.zOffset!==X&&(i=!0,g.zOffset=X),X!==0&&(this.hasAnyZOffset=!0);const Q=V.computeSlopeNormal($,a),de=ic(la(),Li(0,0,1),Q);yo(x,x,de),yo(T,T,de),x[2]*=s,T[2]*=s,x[0]===1&&x[1]===0&&x[2]===0&&T[0]===0&&T[1]===1&&T[2]===0||(u=u||F,h=h||U)}if(F&&(ng(this.text.orientationVertexArray,E,x,T),ng(this.text.orientationVertexArray,A,x,T)),U){const{placedIconSymbolIndex:$,verticalPlacedIconSymbolIndex:X}=g;$>=0&&ng(this.icon.orientationVertexArray,P,x,T),X>=0&&ng(this.icon.orientationVertexArray,L,x,T)}}u||(this.text.orientationVertexArray=void 0),h||(this.icon.orientationVertexArray=void 0),i&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(u,h,f)=>{s+=h,s>u.length&&u.resize(s);for(let g=-h;g<0;g++)u.emplace(g+s,f)},i=(u,h,f)=>{a+=h,a>u.length&&u.resize(a);for(let g=-h;g<0;g++)u.emplace(g+a,f)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let s=0,a=0;for(let u=0;u<this.symbolInstances.length;u++){const h=this.symbolInstances.get(u),{numHorizontalGlyphVertices:f,numVerticalGlyphVertices:g,numIconVertices:x}=h,T=h.zOffset,E=x>0;if((f>0||g>0)&&(e(this.text.zOffsetVertexArray,f,T),e(this.text.zOffsetVertexArray,g,T)),E){const{placedIconSymbolIndex:A,verticalPlacedIconSymbolIndex:P}=h;A>=0&&i(this.icon.zOffsetVertexArray,x,T),P>=0&&i(this.icon.zOffsetVertexArray,h.numVerticalIconVertices,T)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e,i,s,a,u){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,!1),this.hasAppearances===null&&(this.hasAppearances=this.layers.some((h=>h.appearances&&h.appearances.length>0))),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.uploaded=!0}updateAppearances(e,i,s,a){return!!(e&&i&&s)&&!(!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)&&!!this.icon.layoutVertexArray.arrayBuffer&&void(this.updateAppearanceBasedIconTextures(e,i,s,a)&&this.icon.layoutVertexBuffer&&this.icon.layoutVertexArray.arrayBuffer!==null&&this.icon.layoutVertexArray.length===this.icon.layoutVertexBuffer.length&&this.icon.layoutVertexBuffer.updateData(this.icon.layoutVertexArray))}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=fw(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const s=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:a,y:u}of i)this.lineVertexArray.emplaceBack(a,u);return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,i,s,a,u,h,f,g,x,T,E,A,P,L,F,U,V,$){const X=e.indexArray,Q=e.layoutVertexArray,de=e.globeExtVertexArray,ae=e.segments.prepareSegment(4*$,Q,X,this.canOverlap?h.sortKey:void 0),me=this.glyphOffsetArray.length,xe=ae.vertexLength,Ee=this.allowVerticalPlacement&&f===Wo.vertical?Math.PI/2:0,Ge=h.text&&h.text.sections;for(let Ke=0;Ke<i.length;Ke++){const{tl:Qe,tr:at,bl:ct,br:tt,texPrimary:rt,texSecondary:Ze,pixelOffsetTL:qe,pixelOffsetBR:ot,minFontScaleX:yt,minFontScaleY:ft,glyphOffset:Nt,isSDF:Et,sectionIndex:Ct}=i[Ke],Ot=ae.vertexLength,Ii=Nt[1];if(Np(Q,x.x,x.y,Qe.x,Ii+Qe.y,rt.x,rt.y,s,Et,qe.x,qe.y,yt,ft),Np(Q,x.x,x.y,at.x,Ii+at.y,rt.x+rt.w,rt.y,s,Et,ot.x,qe.y,yt,ft),Np(Q,x.x,x.y,ct.x,Ii+ct.y,rt.x,rt.y+rt.h,s,Et,qe.x,ot.y,yt,ft),Np(Q,x.x,x.y,tt.x,Ii+tt.y,rt.x+rt.w,rt.y+rt.h,s,Et,ot.x,ot.y,yt,ft),g){const{x:pt,y:zt,z:oi}=g.anchor,[Oi,Ni,pi]=g.up;Up(de,pt,zt,oi,Oi,Ni,pi),Up(de,pt,zt,oi,Oi,Ni,pi),Up(de,pt,zt,oi,Oi,Ni,pi),Up(de,pt,zt,oi,Oi,Ni,pi),Od(e.dynamicLayoutVertexArray,pt,zt,oi,Ee)}else Od(e.dynamicLayoutVertexArray,x.x,x.y,x.z,Ee);if(U){const pt=Ze||rt;Vp(e.iconTransitioningVertexArray,pt.x,pt.y),Vp(e.iconTransitioningVertexArray,pt.x+pt.w,pt.y),Vp(e.iconTransitioningVertexArray,pt.x,pt.y+pt.h),Vp(e.iconTransitioningVertexArray,pt.x+pt.w,pt.y+pt.h)}X.emplaceBack(Ot,Ot+1,Ot+2),X.emplaceBack(Ot+1,Ot+2,Ot+3),ae.vertexLength+=4,ae.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Nt[0]),Ke!==i.length-1&&Ct===i[Ke+1].sectionIndex||e.programConfigurations.populatePaintArrays(Q.length,h,h.index,{},P,L,F,Ge&&Ge[Ct],this.worldview)}const Me=$-i.length;Me!==0&&this._addNullVertices(Me,Q,s,g,de,e,U,ae,X);const $e=g?g.anchor:x;e.placedSymbolArray.emplaceBack($e.x,$e.y,$e.z,x.x,x.y,me,this.glyphOffsetArray.length-me,xe,T,E,x.segment,s?s[0]:0,s?s[1]:0,a[0],a[1],f,0,0,0,A,0),e.symbolInstanceIndices.push(V)}_addNullVertices(e,i,s,a,u,h,f,g,x){for(let T=0;T<e;T++){for(let A=0;A<4;A++)Np(i,0,0,0,0,0,0,s,!1,0,0,0,0),a&&Up(u,0,0,0,0,0,0),Od(h.dynamicLayoutVertexArray,0,0,0,0),f&&Vp(h.iconTransitioningVertexArray,0,0);const E=g.vertexLength;x.emplaceBack(E,E+1,E+2),x.emplaceBack(E+1,E+2,E+3),g.vertexLength+=4,g.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(0)}}_commitLayoutVertex(e,i,s,a,u,h,f){e.emplaceBack(i,s,a,u,h,Math.round(f.x),Math.round(f.y))}_addCollisionDebugVertices(e,i,s,a,u,h,f){const g=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),x=g.vertexLength,T=f.tileAnchorX,E=f.tileAnchorY;for(let P=0;P<4;P++)s.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(s.collisionVertexArrayExt,i,e.padding,f.zOffset),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,T,E,new st(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,T,E,new st(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,T,E,new st(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,T,E,new st(e.x1,e.y2)),g.vertexLength+=4;const A=s.indexArray;A.emplaceBack(x,x+1),A.emplaceBack(x+1,x+2),A.emplaceBack(x+2,x+3),A.emplaceBack(x+3,x),g.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,s,a,u,h){for(let f=a;f<u;f++){const g=s.get(f),x=this.getSymbolInstanceTextSize(e,h,i,f);this._addCollisionDebugVertices(g,x,this.textCollisionBox,g.projectedAnchorX,g.projectedAnchorY,g.projectedAnchorZ,h)}}_addIconDebugCollisionBoxes(e,i,s,a,u,h){for(let f=a;f<u;f++){const g=s.get(f),x=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._addCollisionDebugVertices(g,x,this.iconCollisionBox,g.projectedAnchorX,g.projectedAnchorY,g.projectedAnchorZ,h)}}generateCollisionDebugBuffers(e,i,s){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Fv(od,Lb.members,Ho),this.iconCollisionBox=new Fv(od,Lb.members,Ho);const a=Pd(this.iconSizeData,e),u=Pd(this.textSizeData,e,s);for(let h=0;h<this.symbolInstances.length;h++){const f=this.symbolInstances.get(h);this._addTextDebugCollisionBoxes(u,e,i,f.textBoxStartIndex,f.textBoxEndIndex,f),this._addTextDebugCollisionBoxes(u,e,i,f.verticalTextBoxStartIndex,f.verticalTextBoxEndIndex,f),this._addIconDebugCollisionBoxes(a,e,i,f.iconBoxStartIndex,f.iconBoxEndIndex,f),this._addIconDebugCollisionBoxes(a,e,i,f.verticalIconBoxStartIndex,f.verticalIconBoxEndIndex,f)}}getSymbolInstanceTextSize(e,i,s,a){const u=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:a),h=Mv(this.textSizeData,e,u)/zn;return this.tilePixelRatio*h}getSymbolInstanceIconSize(e,i,s){const a=this.icon.placedSymbolArray.get(s),u=Mv(this.iconSizeData,e,a);return this.tilePixelRatio*u}_commitDebugCollisionVertexUpdate(e,i,s,a){e.emplaceBack(i,-s,-s,a),e.emplaceBack(i,s,-s,a),e.emplaceBack(i,s,s,a),e.emplaceBack(i,-s,s,a)}_updateTextDebugCollisionBoxes(e,i,s,a,u,h,f){for(let g=a;g<u;g++){const x=s.get(g),T=this.getSymbolInstanceTextSize(e,h,i,g);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,T,x.padding,h.zOffset)}}_updateIconDebugCollisionBoxes(e,i,s,a,u,h,f){for(let g=a;g<u;g++){const x=s.get(g),T=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,T,x.padding,h.zOffset)}}updateCollisionDebugBuffers(e,i,s,a){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const u=Pd(this.iconSizeData,e,a),h=Pd(this.textSizeData,e,s);for(let f=0;f<this.symbolInstances.length;f++){const g=this.symbolInstances.get(f);this._updateTextDebugCollisionBoxes(h,e,i,g.textBoxStartIndex,g.textBoxEndIndex,g,s),this._updateTextDebugCollisionBoxes(h,e,i,g.verticalTextBoxStartIndex,g.verticalTextBoxEndIndex,g,s),this._updateIconDebugCollisionBoxes(u,e,i,g.iconBoxStartIndex,g.iconBoxEndIndex,g,a),this._updateIconDebugCollisionBoxes(u,e,i,g.verticalIconBoxStartIndex,g.verticalIconBoxEndIndex,g,a)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,s,a,u,h,f,g,x){const T={};if(i<s){const{x1:E,y1:A,x2:P,y2:L,padding:F,projectedAnchorX:U,projectedAnchorY:V,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:Q,featureIndex:de}=e.get(i);T.textBox={x1:E,y1:A,x2:P,y2:L,padding:F,projectedAnchorX:U,projectedAnchorY:V,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:Q},T.textFeatureIndex=de}if(a<u){const{x1:E,y1:A,x2:P,y2:L,padding:F,projectedAnchorX:U,projectedAnchorY:V,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:Q,featureIndex:de}=e.get(a);T.verticalTextBox={x1:E,y1:A,x2:P,y2:L,padding:F,projectedAnchorX:U,projectedAnchorY:V,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:Q},T.verticalTextFeatureIndex=de}if(h<f){const{x1:E,y1:A,x2:P,y2:L,padding:F,projectedAnchorX:U,projectedAnchorY:V,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:Q,featureIndex:de}=e.get(h);T.iconBox={x1:E,y1:A,x2:P,y2:L,padding:F,projectedAnchorX:U,projectedAnchorY:V,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:Q},T.iconFeatureIndex=de}if(g<x){const{x1:E,y1:A,x2:P,y2:L,padding:F,projectedAnchorX:U,projectedAnchorY:V,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:Q,featureIndex:de}=e.get(g);T.verticalIconBox={x1:E,y1:A,x2:P,y2:L,padding:F,projectedAnchorX:U,projectedAnchorY:V,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:Q},T.verticalIconFeatureIndex=de}return T}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const s=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const s=e.placedSymbolArray.get(i),a=s.vertexStartIndex+4*s.numGlyphs;for(let u=s.vertexStartIndex;u<a;u+=4)e.indexArray.emplaceBack(u,u+1,u+2),e.indexArray.emplaceBack(u+1,u+2,u+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),s=Math.cos(e),a=[],u=[],h=[];for(let f=0;f<this.symbolInstances.length;++f){h.push(f);const g=this.symbolInstances.get(f);a.push(0|Math.round(i*g.tileAnchorX+s*g.tileAnchorY)),u.push(g.featureIndex)}return h.sort(((f,g)=>a[f]-a[g]||u[g]-u[f])),h}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset))}addToSortKeyRanges(e,i){const s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===i?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const s=this.symbolInstances.get(i);this.featureSortOrder.push(s.featureIndex);const{rightJustifiedTextSymbolIndex:a,centerJustifiedTextSymbolIndex:u,leftJustifiedTextSymbolIndex:h,verticalPlacedTextSymbolIndex:f,placedIconSymbolIndex:g,verticalPlacedIconSymbolIndex:x}=s;a>=0&&this.addIndicesForPlacedSymbol(this.text,a),u>=0&&u!==a&&this.addIndicesForPlacedSymbol(this.text,u),h>=0&&h!==u&&h!==a&&this.addIndicesForPlacedSymbol(this.text,h),f>=0&&this.addIndicesForPlacedSymbol(this.text,f),g>=0&&this.addIndicesForPlacedSymbol(this.icon,g),x>=0&&this.addIndicesForPlacedSymbol(this.icon,x)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}getElevationFeatureForText(e){const i=this.symbolInstances.get(this.text.symbolInstanceIndices[e]).elevationFeatureIndex;let s;return this.elevationFeatures&&i<this.elevationFeatures.length&&(s=this.elevationFeatures[i]),s}}function pw(r,e){return e.replace(/{([^{}]+)}/g,((i,s)=>s in r?String(r[s]):""))}let mw,_w,Bv;Lt(og,"SymbolBucket",{omit:["layers","collisionBoxArray","compareText","features"]}),og.addDynamicAttributes=Od;class gw{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:ws,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Lt(gw,"FormatSectionOverride",{omit:["defaultValue"]});const Nv=()=>Bv||(Bv={layout:mw||(mw=new en({"symbol-placement":new mt(Re.layout_symbol["symbol-placement"]),"symbol-spacing":new mt(Re.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new mt(Re.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new xt(Re.layout_symbol["symbol-sort-key"]),"symbol-z-order":new mt(Re.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new mt(Re.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new mt(Re.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new mt(Re.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new mt(Re.layout_symbol["icon-ignore-placement"]),"icon-optional":new mt(Re.layout_symbol["icon-optional"]),"icon-rotation-alignment":new mt(Re.layout_symbol["icon-rotation-alignment"]),"icon-size":new xt(Re.layout_symbol["icon-size"]),"icon-size-scale-range":new mt(Re.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new xt(Re.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new xt(Re.layout_symbol["icon-text-fit-padding"]),"icon-image":new xt(Re.layout_symbol["icon-image"]),"icon-image-use-theme":new mt({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new xt(Re.layout_symbol["icon-rotate"]),"icon-padding":new mt(Re.layout_symbol["icon-padding"]),"icon-keep-upright":new mt(Re.layout_symbol["icon-keep-upright"]),"icon-offset":new xt(Re.layout_symbol["icon-offset"]),"icon-anchor":new xt(Re.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new mt(Re.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new mt(Re.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new mt(Re.layout_symbol["text-rotation-alignment"]),"text-field":new xt(Re.layout_symbol["text-field"]),"text-font":new xt(Re.layout_symbol["text-font"]),"text-size":new xt(Re.layout_symbol["text-size"]),"text-size-scale-range":new mt(Re.layout_symbol["text-size-scale-range"]),"text-max-width":new xt(Re.layout_symbol["text-max-width"]),"text-line-height":new xt(Re.layout_symbol["text-line-height"]),"text-letter-spacing":new xt(Re.layout_symbol["text-letter-spacing"]),"text-justify":new xt(Re.layout_symbol["text-justify"]),"text-radial-offset":new xt(Re.layout_symbol["text-radial-offset"]),"text-variable-anchor":new mt(Re.layout_symbol["text-variable-anchor"]),"text-anchor":new xt(Re.layout_symbol["text-anchor"]),"text-max-angle":new mt(Re.layout_symbol["text-max-angle"]),"text-writing-mode":new mt(Re.layout_symbol["text-writing-mode"]),"text-rotate":new xt(Re.layout_symbol["text-rotate"]),"text-padding":new mt(Re.layout_symbol["text-padding"]),"text-keep-upright":new mt(Re.layout_symbol["text-keep-upright"]),"text-transform":new xt(Re.layout_symbol["text-transform"]),"text-offset":new xt(Re.layout_symbol["text-offset"]),"text-allow-overlap":new mt(Re.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new mt(Re.layout_symbol["text-ignore-placement"]),"text-optional":new mt(Re.layout_symbol["text-optional"]),visibility:new mt(Re.layout_symbol.visibility)})),paint:_w||(_w=new en({"icon-opacity":new xt(Re.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new xt(Re.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new xt(Re.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new xt(Re.paint_symbol["text-emissive-strength"]),"icon-color":new xt(Re.paint_symbol["icon-color"]),"icon-halo-color":new xt(Re.paint_symbol["icon-halo-color"]),"icon-halo-width":new xt(Re.paint_symbol["icon-halo-width"]),"icon-halo-blur":new xt(Re.paint_symbol["icon-halo-blur"]),"icon-translate":new mt(Re.paint_symbol["icon-translate"]),"icon-translate-anchor":new mt(Re.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new mt(Re.paint_symbol["icon-image-cross-fade"]),"text-opacity":new xt(Re.paint_symbol["text-opacity"]),"text-occlusion-opacity":new xt(Re.paint_symbol["text-occlusion-opacity"]),"text-color":new xt(Re.paint_symbol["text-color"],{runtimeType:wo,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new xt(Re.paint_symbol["text-halo-color"]),"text-halo-width":new xt(Re.paint_symbol["text-halo-width"]),"text-halo-blur":new xt(Re.paint_symbol["text-halo-blur"]),"text-translate":new mt(Re.paint_symbol["text-translate"]),"text-translate-anchor":new mt(Re.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new mt(Re.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new mt(Re.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new mt(Re.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new mt(Re.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new xt(Re.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},Bv);class sg extends po{constructor(e,i,s,a){super(e,Nv(),i,s,a,e.layout?e.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=K([]),this.hasOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}_handleSpecialPaintPropertyUpdate(e){e!=="icon-occlusion-opacity"&&e!=="text-occlusion-opacity"||(this.hasOcclusionOpacityProperties=!0)}recalculate(e,i){super.recalculate(e,i),this.appearances&&this.appearances.forEach((a=>{a.recalculate(e,i,this.iconImageUseTheme)})),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const s=this.layout.get("text-writing-mode");if(s){const a=[];for(const u of s)a.indexOf(u)<0&&a.push(u);this.layout._values["text-writing-mode"]=a}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,s,a){return this._saturation===e&&this._contrast===i&&this._brightnessMin===s&&this._brightnessMax===a||(this._colorAdjustmentMatrix=(function(u,h,f,g){u=Zr(u),h=$i(h);const x=oe(),T=u/3,E=1-2*T,A=[E,T,T,0,T,E,T,0,T,T,E,0,0,0,0,1],P=.5-.5*h,L=g-f;return Le(x,[L,0,0,0,0,L,0,0,0,0,L,0,f,f,f,1],[h,0,0,0,0,h,0,0,0,0,h,0,P,P,P,1]),Le(x,x,A),x})(e,i,s,a),this._saturation=e,this._contrast=i,this._brightnessMin=s,this._brightnessMax=a),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,s,a){const u=this.layout.get(e).evaluate(i,{},s,a),h=this._unevaluatedLayout._values[e];return h.isDataDriven()||bu(h.value)||!u?u:pw(i.properties,u)}getAppearanceValueAndResolveTokens(e,i,s,a,u){const h=e.getProperty(i);if(!h)return;const f=h.evaluate(s,{},a,u),g=e.getUnevaluatedProperties()._values[i];return g.isDataDriven()||bu(g.value)||!f||typeof f!="string"?f:pw(s.properties,f)}createBucket(e){return new og(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of Nv().paint.overridableProperties){if(!sg.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),s=new gw(i),a=new Uh(s,i.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme"));let u=null;u=i.value.kind==="constant"||i.value.kind==="source"?new yc("source",a):new Fl("composite",a,i.value.zoomStops,i.value.interpolationType),this.paint._values[e]=new Nl(i.property,u,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,s){return!(!this.layout||i.isDataDriven()||s.isDataDriven())&&sg.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const s=e.get("text-field"),a=Nv().paint.properties[i];let u=!1;const h=f=>{for(const g of f)if(a.overrides&&a.overrides.hasOverride(g))return void(u=!0)};if(s.value.kind==="constant"&&s.value.value instanceof co)h(s.value.value.sections);else if(s.value.kind==="source"){const f=x=>{u||(x instanceof pa&&On(x.value)===su?h(x.value.sections):x instanceof Zs?h(x.sections):x.eachChild(f))},g=s.value;g._styleExpression&&f(g._styleExpression.expression)}return u}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,s){return{config:new al(this,{zoom:i,lut:s}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let yw,vw,xw,bw;var Vv=Ci([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function ag(r,e,i,s,a,u,h,f){const g=[r,e,1,i,s,1,a,u,1],x=[h,f,1],T=re([],g),[E,A,P]=Rn(x,x,T);return ue(g,g,[E,0,0,0,A,0,0,0,P])}function ww(r,e,i,s,a,u,h,f){const g=(function(x,T,E,A,P,L,F,U){const V=ag(0,0,1,0,1,1,0,1),$=ag(x,T,E,A,P,L,F,U);return ue($,$,re([],V))})(r,e,i,s,a,u,h,f);return[g[2]/g[8]/gt,g[5]/g[8]/gt]}function lg(r){return[r[0],Math.min(Math.max(r[1],-z),z)]}class Tw extends Ll{constructor(e,i,s,a){super(),this.id=e,this.dispatcher=s,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(a),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new qs("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=lh(this.map._requestManager.transformRequest(this.url,Qc.Image),((s,a)=>{this._imageRequest=null,this._loaded=!0,s?this.fire(new ru(s)):a&&(this.image=a instanceof HTMLImageElement?Dn.getImageData(a):a,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())}))}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Sp(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new qs("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Sp||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],s=e[0][1];for(const u of e)u[1]>s&&(s=u[1]),u[1]<i&&(i=u[1]);const a=(s+i)/2;if(a>z?this.onNorthPole=!0:a<-z&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const u=e.map(Y.fromLngLat);this.tileID=(function(h){let f=1/0,g=1/0,x=-1/0,T=-1/0;for(const F of h)f=Math.min(f,F.x),g=Math.min(g,F.y),x=Math.max(x,F.x),T=Math.max(T,F.y);const E=Math.max(x-f,T-g),A=Math.max(0,Math.floor(-Math.log2(E))),P=Math.pow(2,A);let L=Math.floor((f+x)/2*P);return L>1&&(L-=1),new xr(A,L,Math.floor((g+T)/2*P))})(u),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new qs("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Sp||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const V in this.tiles){const $=this.tiles[V];$.state!=="loaded"&&($.state="loaded",$.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=Op(new xr(0,0,0),this.map.transform.projection),s=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!(function(V){const $=V[1].x-V[0].x,X=V[1].y-V[0].y,Q=V[2].x-V[1].x,de=V[2].y-V[1].y,ae=V[3].x-V[2].x,me=V[3].y-V[2].y,xe=V[0].x-V[3].x,Ee=V[0].y-V[3].y,Ge=$*de-Q*X,Me=Q*me-ae*de,$e=ae*Ee-xe*me,Ke=xe*X-$*Ee;return Ge>0&&Me>0&&$e>0&&Ke>0||Ge<0&&Me<0&&$e<0&&Ke<0})(s))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const a=Op(this.tileID,this.map.transform.projection),[u,h,f,g]=this.coordinates.map((V=>{const $=a.projection.project(V[0],V[1]);return lw(a,$)._round()}));this.perspectiveTransform=ww(u.x,u.y,h.x,h.y,f.x,f.y,g.x,g.y);const x=this._boundsArray=new wc;x.emplaceBack(u.x,u.y,0,0),x.emplaceBack(h.x,h.y,gt,0),x.emplaceBack(g.x,g.y,0,gt),x.emplaceBack(f.x,f.y,gt,gt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(x,Vv.members),this.boundsSegments=Fr.simpleSegment(0,0,4,2);const T=[],E=[lg((A=this.coordinates)[0]),lg(A[1]),lg(A[2]),lg(A[3])];var A;const[P,L,F,U]=(function(V){let $=V[0][0],X=$,Q=V[0][1],de=Q;for(let ae=1;ae<V.length;ae++)V[ae][0]<$?$=V[ae][0]:V[ae][0]>X&&(X=V[ae][0]),V[ae][1]<Q?Q=V[ae][1]:V[ae][1]>de&&(de=V[ae][1]);return[$,Q,X-$,de-Q]})(E);{const V=new wc,[$,X,Q,de]=(function(tt){let rt=tt[0].x,Ze=rt,qe=tt[0].y,ot=qe;for(let yt=1;yt<tt.length;yt++)tt[yt].x<rt?rt=tt[yt].x:tt[yt].x>Ze&&(Ze=tt[yt].x),tt[yt].y<qe?qe=tt[yt].y:tt[yt].y>ot&&(ot=tt[yt].y);return[rt,qe,Ze-rt,ot-qe]})(s),ae=tt=>[(tt.x-$)/Q,(tt.y-X)/de],[me,xe,Ee,Ge]=s.map(ae),Me=(function(tt,rt,Ze,qe,ot,yt,ft,Nt){const Et=ag(0,0,1,0,1,1,0,1);return ue(Et,Et,re([],ag(tt,rt,Ze,qe,ot,yt,ft,Nt)))})(me[0],me[1],xe[0],xe[1],Ee[0],Ee[1],Ge[0],Ge[1]);this.elevatedGlobePerspectiveTransform=ww(me[0],me[1],xe[0],xe[1],Ee[0],Ee[1],Ge[0],Ge[1]);const $e=(tt,rt)=>{T.push(tt.lng);const Ze=Math.round((tt.lng-P)/F*gt),qe=Math.round((tt.lat-L)/U*gt),ot=ae(rt),yt=Rn([],[ot[0],ot[1],1],Me),ft=Math.round(yt[0]/yt[2]*gt),Nt=Math.round(yt[1]/yt[2]*gt);V.emplaceBack(Ze,qe,ft,Nt)},Ke=s[3].x-s[0].x,Qe=s[3].y-s[0].y,at=s[2].x-s[1].x,ct=s[2].y-s[1].y;for(let tt=0;tt<65;tt++){const rt=tt/64,Ze=[s[0].x+rt*Ke,s[0].y+rt*Qe],qe=[s[1].x+rt*at,s[1].y+rt*ct],ot=qe[0]-Ze[0],yt=qe[1]-Ze[1];for(let ft=0;ft<65;ft++){const Nt=ft/64,Et={x:Ze[0]+ot*Nt,y:Ze[1]+yt*Nt};$e(i.projection.unproject(Et.x,Et.y),Et)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(V,Vv.members)}{this.maxLongitudeTriangleSize=0;let V=[],$=new xn;const X=(Q,de,ae)=>{$.emplaceBack(Q,de,ae);const me=T[Q],xe=T[de],Ee=T[ae],Ge=Math.min(Math.min(me,xe),Ee),Me=Math.max(Math.max(me,xe),Ee)-Ge;Me>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Me),V.push(Ge+Me/2)};for(let Q=0;Q<64;Q++)for(let de=0;de<64;de++){const ae=65*Q+de,me=ae+1,xe=ae+65,Ee=xe+1;X(ae,xe,me),X(me,xe,Ee)}[V,$]=(function(Q,de){const ae=Array.from({length:Q.length},((Ee,Ge)=>Ge));ae.sort(((Ee,Ge)=>Q[Ee]-Q[Ge]));const me=[],xe=new xn;for(let Ee=0;Ee<ae.length;Ee++){const Ge=ae[Ee];me.push(Q[Ge]);const Me=3*Ge,$e=Me+1;xe.emplaceBack(de.uint16[Me],de.uint16[$e],de.uint16[$e+1])}return[me,xe]})(V,$),this.elevatedGlobeTrianglesCenterLongitudes=V,this.elevatedGlobeIndexBuffer=e.createIndexBuffer($)}this.elevatedGlobeSegments=Fr.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,F/gt,0,U/gt,0,0,L,P,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,s=i.gl;!this._dirty||this.texture instanceof Sp||(this.texture?this.texture.update(this.image):(this.texture=new hv(i,this.image,s.RGBA8),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const s=this.elevatedGlobeTrianglesCenterLongitudes;let a=(u=e+180)+360*Math.round((s[0]-u)/360);var u;const h=new Fr,f=(E,A)=>{h.segments.push({vertexOffset:0,primitiveOffset:E,vertexLength:i.segments[0].vertexLength,primitiveLength:A,sortKey:void 0,vaos:{}})},g=.51*this.maxLongitudeTriangleSize;if(Math.abs(s[0]-a)<=g){const E=Hr(s,0,s.length,a+g);return E===s.length||f(E,gn(s,E+1,s.length,a+360-g)-E),h}a<s[0]&&(a+=360);const x=gn(s,0,s.length,a-g);if(x===s.length)return f(0,s.length),h;f(0,x-0);const T=Hr(s,x+1,s.length,a+g);return T!==s.length&&f(T,s.length-T),h}}const p3=(Math.pow(256,2)-1)/16907520;class Ew extends po{constructor(e,i,s,a){super(e,{layout:xw||(xw=new en({visibility:new mt(Re.layout_raster.visibility)})),paint:bw||(bw=new en({"raster-opacity":new mt(Re.paint_raster["raster-opacity"]),"raster-color":new Ul(Re.paint_raster["raster-color"]),"raster-color-mix":new mt(Re.paint_raster["raster-color-mix"]),"raster-color-range":new mt(Re.paint_raster["raster-color-range"]),"raster-hue-rotate":new mt(Re.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new mt(Re.paint_raster["raster-brightness-min"]),"raster-brightness-max":new mt(Re.paint_raster["raster-brightness-max"]),"raster-saturation":new mt(Re.paint_raster["raster-saturation"]),"raster-contrast":new mt(Re.paint_raster["raster-contrast"]),"raster-resampling":new mt(Re.paint_raster["raster-resampling"]),"raster-fade-duration":new mt(Re.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new mt(Re.paint_raster["raster-emissive-strength"]),"raster-array-band":new mt(Re.paint_raster["raster-array-band"]),"raster-elevation":new mt(Re.paint_raster["raster-elevation"]),"raster-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},i,s,a),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof Tw&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[s,a]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(s)&&isNaN(a)||s===this._curRampRange[0]&&a===this._curRampRange[1]||(this.colorRamp=up({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:s,end:a}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[s,a])}}let Sw,Iw,Aw,Cw,Mw;class Pw extends po{constructor(e,i,s,a){super(e,{layout:Sw||(Sw=new en({visibility:new mt(Re["layout_raster-particle"].visibility)})),paint:Iw||(Iw=new en({"raster-particle-array-band":new mt(Re["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new mt(Re["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Ul(Re["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new mt(Re["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new mt(Re["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new mt(Re["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new mt(Re["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new mt(Re["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},i,s,a),this._updateColorRamp(),this.lastInvalidatedAt=Dn.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=up({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Dn.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class m3 extends po{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function Uv(r,e,i){const s=[0,0,1],a=tc([]);return ca(a,a,i?-Yi(r)+Math.PI:Yi(r)),gs(a,a,-Yi(e)),yo(s,s,a),ui(s,s)}const Lw={None:0,Model:1,Symbol:2,FillExtrusion:4};class cg{constructor(e,i,s,a){this.message=(e?`${e}: `:"")+s,a&&(this.identifier=a),i!=null&&i.__line__&&(this.line=i.__line__)}}function jv(r,e){const i=r.indexOf("://")===-1;try{return new URL(r,i&&e?"http://example.com":void 0),!0}catch{return!1}}class Rw{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Dw{constructor(){this.maxScale=1,this.maxXYTranslationDistance=0,this.instancedDataArray=new Qf,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}colorForInstance(e){const i=16*e,s=this.instancedDataArray.float32;let a=Math.floor(s[i+2]);const u=1.05*(s[i+2]-a);return a/=100,[s[i]%1*1.05,s[i+1]%1*1.05,u,a]}tileCoordinatesForInstance(e){const i=16*e,s=this.instancedDataArray.float32;let a=s[i+0];return a=a>gt?a-gt:a,new st(Math.trunc(a),Math.trunc(s[i+1]))}translationForInstance(e){const i=16*e,s=this.instancedDataArray.float32;return[s[i+4],s[i+5],s[i+6]]}rotationScaleForInstance(e){const i=16*e,s=this.instancedDataArray.float32;return[s[i+7],s[i+8],s[i+9],s[i+10],s[i+11],s[i+12],s[i+13],s[i+14],s[i+15]]}transformForInstance(e){const i=16*e,s=this.instancedDataArray.float32;return[s[i+7],s[i+8],s[i+9],s[i+4],s[i+10],s[i+11],s[i+12],s[i+5],s[i+13],s[i+14],s[i+15],s[i+6],0,0,0,1]}}class Gv{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaledZ=this.canonical.z+Math.log2(e.overscaling),this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,s,a){}populate(e,i,s,a){this.tileToMeter=q(s);const u=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:h,id:f,index:g,sourceLayerIndex:x}of e){const T=f??(h.properties&&h.properties.hasOwnProperty("id")?h.properties.id:void 0),E=Ce(h,u);if(!this.layers[0]._featureFilter.filter(new Ar(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),E,s))continue;const A={id:T,sourceLayerIndex:x,index:g,geometry:u?E.geometry:ye(h,s,a),properties:h.properties,type:h.type,patterns:{}},P=this.addFeature(A,A.geometry,E);P&&i.featureIndex.insert(h,A.geometry,g,x,this.index,this.instancesPerModel[P].instancedDataArray.length,gt/32)}this.lookup=null}evaluateQueryRenderedFeaturePadding(){const e=this.layers[0].modelManager,i=this.layers[0].scope;let s=0;for(const a of this.modelUris){const u=e.getModel(a,i);if(!u)continue;const h=this.instancesPerModel[a];if(h){const f=.5*ii(u.aabb.max,u.aabb.min)*h.maxScale+h.maxXYTranslationDistance,g=Math.min(gt,Math.max(f/this.tileToMeter,gt/32));s=Math.max(g,s)}}return s}update(e,i,s,a){for(const u in this.instancesPerModel){const h=this.instancesPerModel[u];for(const f in e)h.idToFeaturesIndex.hasOwnProperty(f)&&(this.evaluate(h.features[h.idToFeaturesIndex[f]],e[f],h,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];for(const a of s.features){const u=this.layers[0],h=a.feature,f=this.canonical,g=u.paint.get("model-rotation").evaluate(h,{},f),x=u.paint.get("model-scale").evaluate(h,{},f),T=u.paint.get("model-translation").evaluate(h,{},f);Jr(a.rotation,g)&&Jr(a.scale,x)&&Jr(a.translation,T)||(this.evaluate(a,a.featureStates,s,!0),e=!0)}}return e}updateReplacement(e,i,s,a){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const u=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(D_(this.activeReplacements,u))return!1;this.activeReplacements=u;let h=!1;for(const f in this.instancesPerModel){const g=this.instancesPerModel[f],x=g.instancedDataArray;for(const T of g.features){const E=T.instancedDataOffset,A=T.instancedDataCount;for(let P=0;P<A;P++){const L=16*(P+E);let F=x.float32[L+0];const U=F>gt;F=U?F-gt:F;const V=Math.floor(F),$=Math.floor(x.float32[L+1]);let X=!1;for(const Q of this.activeReplacements)if(!v1(Q,s,Lw.Model,a)&&!(Q.min.x>V||V>Q.max.x||Q.min.y>$||$>Q.max.y)&&(X=E1(T1(V,$,e.canonical,Q.footprintTileId.canonical),Q.footprint),X))break;x.float32[L]=X?F+gt:F,h=h||X!==U}}}return h}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];s.instancedDataArray.length<0||s.instancedDataArray.length===0||(s.instancedDataBuffer?s.instancedDataBuffer.updateData(s.instancedDataArray):s.instancedDataBuffer=e.createVertexBuffer(s.instancedDataArray,BI.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(e){for(const s in this.instancesPerModel){const a=this.instancesPerModel[s];a.instancedDataArray.length!==0&&a.instancedDataBuffer&&a.instancedDataBuffer.destroy()}const i=this.layers[0].modelManager;if(e&&i&&this.modelUris&&this.modelsRequested)for(const s of this.modelUris)i.removeModel(s,"",!0)}addFeature(e,i,s){const a=this.layers[0],u=a.layout.get("model-id").evaluate(s,{},this.canonical);if(!u)return It(`modelId is not evaluated for layer ${a.id} and it is not going to get rendered.`),u;(jv(u,!1)||this.styleDefinedModelURLs[u]!==void 0)&&(this.modelUris.includes(u)||this.modelUris.push(u)),this.instancesPerModel[u]||(this.instancesPerModel[u]=new Dw);const h=this.instancesPerModel[u],f=h.instancedDataArray,g=new Rw(s,f.length);for(const x of i)for(const T of x){if(T.x<0||T.x>=gt||T.y<0||T.y>=gt)continue;if(this.lookupDim!==0){const A=(this.lookupDim-1)/gt,P=this.lookupDim*(T.y*A|0)+T.x*A|0;if(this.lookup){if(this.lookup[P]!==0)continue;this.lookup[P]=1}}this.instanceCount++;const E=f.length;f.resize(E+1),h.instancesEvaluatedElevation.push(0),f.float32[16*E]=T.x,f.float32[16*E+1]=T.y}return g.instancedDataCount=h.instancedDataArray.length-g.instancedDataOffset,g.instancedDataCount>0&&(e.id&&(h.idToFeaturesIndex[e.id]=h.features.length),h.features.push(g),this.evaluate(g,{},h,!1)),u}getModelUris(){return this.modelUris}evaluate(e,i,s,a){const u=this.layers[0],h=e.feature,f=this.canonical,g=e.rotation=u.paint.get("model-rotation").evaluate(h,i,f),x=e.scale=u.paint.get("model-scale").evaluate(h,i,f),T=e.translation=u.paint.get("model-translation").evaluate(h,i,f),E=Object.assign({},u.paint.get("model-color").evaluate(h,i,f));E.a=u.paint.get("model-color-mix-intensity").evaluate(h,i,f);const A=[];this.maxVerticalOffset<T[2]&&(this.maxVerticalOffset=T[2]);const P=T[0]*T[0]+T[1]*T[1],L=P>0?Math.sqrt(P):0;s.maxScale=Math.max(Math.max(s.maxScale,x[0]),Math.max(x[1],x[2])),s.maxXYTranslationDistance=Math.max(s.maxXYTranslationDistance,L),this.maxScale=Math.max(Math.max(this.maxScale,x[0]),Math.max(x[1],x[2])),ub(A,g,x);const F=Math.round(100*E.a)+E.b/1.05;for(let U=0;U<e.instancedDataCount;++U){const V=e.instancedDataOffset+U,$=16*V,X=s.instancedDataArray.float32;let Q=0;a&&(Q=X[$+6]-s.instancesEvaluatedElevation[V]);const de=0|X[$+1];X[$]=(0|X[$])+E.r/1.05,X[$+1]=de+E.g/1.05,X[$+2]=F,X[$+3]=1/(f.z>10?this.tileToMeter:q(f,de)),X[$+4]=T[0],X[$+5]=T[1],X[$+6]=T[2]+Q,X[$+7]=A[0],X[$+8]=A[1],X[$+9]=A[2],X[$+10]=A[4],X[$+11]=A[5],X[$+12]=A[6],X[$+13]=A[8],X[$+14]=A[9],X[$+15]=A[10],s.instancesEvaluatedElevation[V]=T[2]}}}let Ow,zw;Lt(Gv,"ModelBucket",{omit:["layers"]}),Lt(Dw,"PerModelAttributes"),Lt(Rw,"ModelFeature");class zd{constructor(e,i,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=s}static create(e,i,s){const a=s||e.findDEMTileFor(i);if(!a||!a.dem)return;const u=a.dem,h=a.tileID,f=1<<i.canonical.z-h.canonical.z;return new zd(a,u.dim/gt/f,[(i.canonical.x/f-h.canonical.x)*u.dim,(i.canonical.y/f-h.canonical.y)*u.dim])}tileCoordToPixel(e,i){const s=i*this._scale+this._offset[1];return new st(Math.floor(e*this._scale+this._offset[0]),Math.floor(s))}getElevationAt(e,i,s,a){const u=e*this._scale+this._offset[0],h=i*this._scale+this._offset[1],f=Math.floor(u),g=Math.floor(h),x=this._dem;return a=!!a,s?ei(ei(x.get(f,g,a),x.get(f,g+1,a),h-g),ei(x.get(f+1,g,a),x.get(f+1,g+1,a),h-g),u-f):x.get(f,g,a)}getElevationAtPixel(e,i,s){return this._dem.get(e,i,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*I(1,e)*this._dem.stride}}const qv=new Float32Array(262144),Gu=new Uint8Array(262144);function kw(r){let e=0;if(r.meshes)for(const i of r.meshes)e=Math.max(e,i.aabb.max[2]);if(r.children)for(const i of r.children)e=Math.max(e,kw(i));return e}function Fw(r,e,i){if(r.meshes)for(const s of r.meshes){if(s.aabb.min[0]===1/0)continue;const a=Ft.applyTransform(s.aabb,r.globalMatrix);i.insert(e,a.min[0],a.min[1],a.max[0],a.max[1])}if(r.children)for(const s of r.children)Fw(s,e,i)}const Bw=["","wall","door","roof","window","lamp","logo"];class Nw{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:kw(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Ft([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new Ft([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const s of this.node.meshes)this.node.lightMeshIndex!==e&&(s.transformedAabb=Ft.applyTransformFast(s.aabb,this.node.globalMatrix),i.encapsulate(s.transformedAabb)),e++;this.aabb=i}return this.aabb}}class ug{constructor(e,i,s,a,u,h,f,g){this.id=s,this.layers=e,this.layerIds=this.layers.map((x=>x.fqid)),this.stateDependentLayerIds=this.layers.filter((x=>x.isStateDependent())).map((x=>x.id)),this.modelTraits|=Id.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,a&&(this.modelTraits|=Id.HasMapboxMeshFeatures),u&&(this.modelTraits|=Id.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=h,this.worldview=g,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const x of i)this.nodesInfo.push(new Nw(x)),Fw(x,f.featureIndexArray.length,f.grid),f.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,f.bucketLayerIDs.length-1,0);this.states={},this.hasAppearances=null}updateFootprints(e,i){for(const s of this.getNodesInfo()){const a=s.node;a.footprint&&i.push({footprint:a.footprint,id:e})}}updateAppearances(e,i,s,a){}update(e){const i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;const s=i?this.stateDependentLayers:this.layers;if(!ha(e,this.states))for(const a of s)this.evaluate(a,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const s of i){const a=s.node;this.uploaded?this.updatePbrBuffer(a):pv(a,e,!0)}for(const s of i)H_(s.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const s of e.meshes)s.pbrBuffer&&(s.pbrBuffer.updateData(s.featureArray),i=!0);return i}needsReEvaluation(e,i,s){const a=e.transform.projectionOptions,u=e.style.getBrightness(),h=this.brightness!==u;if(!this.uploaded||this.dirty||a.name!==this.projection.name||jp(s.paint.get("model-color").value,h)||jp(s.paint.get("model-color-mix-intensity").value,h)||jp(s.paint.get("model-roughness").value,h)||jp(s.paint.get("model-emissive-strength").value,h)||jp(s.paint.get("model-height-based-emissive-strength-multiplier").value,h)){this.projection=a,this.brightness=u;const f=this.getNodesInfo();for(const g of f)g.state=null;return!0}return!1}evaluateTransform(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const s=this.getNodesInfo(),a=this.id.canonical;for(const u of s){const h=u.feature;u.evaluatedTranslation=i.paint.get("model-translation").evaluate(h,{},a),u.evaluatedScale=i.paint.get("model-scale").evaluate(h,{},a)}}evaluate(e,i){const s=this.getNodesInfo();for(const a of s){if(!a.node.meshes)continue;const u=a.feature,h=i&&i[u.id];if(ha(h,a.state))continue;a.state=structuredClone(h);const f=a.node.meshes&&a.node.meshes[0].featureData,g=a.evaluatedColor[2],x=a.evaluatedRMEA[2],T=this.id.canonical;if(a.hasTranslucentParts=!1,f){for(let E=0;E<Bw.length;E++){const A=Bw[E];A.length&&(u.properties.part=A);const P=e.paint.get("model-color").evaluate(u,h,T).toPremultipliedRenderColor(null),L=e.paint.get("model-color-mix-intensity").evaluate(u,h,T);a.evaluatedColor[E]=[P.r,P.g,P.b,L],a.evaluatedRMEA[E][0]=e.paint.get("model-roughness").evaluate(u,h,T),a.evaluatedRMEA[E][2]=e.paint.get("model-emissive-strength").evaluate(u,h,T),a.evaluatedRMEA[E][3]=P.a,a.emissionHeightBasedParams[E]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(u,h,T),!a.hasTranslucentParts&&P.a<1&&(a.hasTranslucentParts=!0)}delete u.properties.part,g3(a,g!==a.evaluatedColor[2]||x!==a.evaluatedRMEA[2],this.modelTraits)}else a.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(u,h,T);a.evaluatedTranslation=e.paint.get("model-translation").evaluate(u,h,T),a.evaluatedScale=e.paint.get("model-scale").evaluate(u,h,T),this.updatePbrBuffer(a.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,s,a){const u=e.findDEMTileFor(s);if(u&&(u.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(u.dem&&u.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=u.tileID.overscaledZ;const h=zd.create(e,s,u);if(!h)return;this.modelTraits&Id.HasMapboxMeshFeatures&&this.updateDEM(e,h,s,a);for(const f of this.getNodesInfo()){const g=f.node;if(!g.footprint||!g.footprint.vertices||!g.footprint.vertices.length)continue;const x=g.footprint.vertices;let T=h.getElevationAt(x[0].x,x[0].y,!0,!0);for(let E=1;E<x.length;E++)T=Math.min(T,h.getElevationAt(x[E].x,x[E].y,!0,!0));g.elevation=T}}this.terrainTile=u.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,s,a){let u=i._dem._modifiedForSources[a];if(u===void 0&&(i._dem._modifiedForSources[a]=[],u=i._dem._modifiedForSources[a]),u.includes(s.canonical))return;const h=i._dem.dim;u.push(s.canonical);let f=!1;for(const g of this.getNodesInfo()){const x=g.node;if(!x.footprint||!x.footprint.grid)continue;const T=x.footprint.grid,E=i.tileCoordToPixel(T.min.x,T.min.y),A=i.tileCoordToPixel(T.max.x,T.max.y),P=Math.min(Math.min(h-A.y,E.x),Math.min(E.y,h-A.x));if(P<0)continue;const L=j(P,2,5);let F=Math.max(0,E.x-L),U=Math.max(0,E.y-L),V=Math.min(A.x+L,h-1),$=Math.min(A.y+L,h-1);for(let ae=U;ae<=$;++ae)for(let me=F;me<=V;++me)Gu[ae*h+me]=255;let X=0,Q=0;for(let ae=0;ae<T.cellsY;++ae)for(let me=0;me<T.cellsX;++me){if(!T.cells[ae*T.cellsX+me])continue;const xe=i.tileCoordToPixel(T.min.x+me/T.xScale,T.min.y+ae/T.yScale),Ee=i.tileCoordToPixel(T.min.x+(me+1)/T.xScale,T.min.y+(ae+1)/T.yScale);for(let Ge=xe.y;Ge<=Math.min(Ee.y+1,h-1);++Ge)for(let Me=xe.x;Me<=Math.min(Ee.x+1,h-1);++Me)Gu[Ge*h+Me]===255&&(Gu[Ge*h+Me]=0,X+=i.getElevationAtPixel(Me,Ge),Q++)}const de=X/Q;F=Math.max(1,E.x-L),U=Math.max(1,E.y-L),V=Math.min(A.x+L,h-2),$=Math.min(A.y+L,h-2),f=!0;for(let ae=U;ae<=$;++ae)for(let me=F;me<=V;++me)Gu[ae*h+me]===0&&(qv[ae*h+me]=i._dem.set(me,ae,de));for(let ae=1;ae<L;++ae){F=Math.max(1,E.x-ae),U=Math.max(1,E.y-ae),V=Math.min(A.x+ae,h-2),$=Math.min(A.y+ae,h-2);for(let me=U;me<=$;++me)for(let xe=F;xe<=V;++xe){const Ee=me*h+xe;if(Gu[Ee]===255){let Ge=0,Me=0,$e=-1,Ke=-1;for(let Qe=-1;Qe<=1;++Qe)for(let at=-1;at<=1;++at){const ct=(me+Qe)*h+xe+at;if(Gu[ct]>=ae)continue;const tt=qv[ct],rt=Math.abs(tt);rt>Me&&(Ge=tt,Me=rt,$e=at,Ke=Qe)}if(Me>.1){const Qe=1-(ae+.5*Math.abs($e*Ke))/L;let at=i._dem.get(xe,me)+Ge*Qe;const ct=i._dem.get(xe+$e,me+Ke),tt=i._dem.get(xe-$e,me-Ke,!0);(at-ct)*(at-tt)>0&&(at=(ct+tt)/2),qv[Ee]=i._dem.set(xe,me,at),Gu[Ee]=ae}}}}}f&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=Dn.now())}setFilter(e){this.filter=e?Yh(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter((e=>this.filter.filter(new Ar(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical))):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)H_(i.node),mv(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const s=i.getReplacementRegionsForTile(e.toUnwrapped());for(const a of this.getNodesInfo()){const u=a.node.footprint;a.hiddenByReplacement=!!u&&!s.find((h=>h.footprint===u))}}getHeightAtTileCoord(e,i){const s=[],a=[0,0,0],u=K([]);for(const h of this.getNodesInfo()){const f=h.node.meshes[0],g=f.transformedAabb;if(e<g.min[0]||i<g.min[1]||e>g.max[0]||i>g.max[1])continue;if(h.node.hidden===!0)return{height:1/0,maxHeight:h.feature.properties.height,hidden:!1,verticalScale:h.evaluatedScale[2]};Te(u,h.node.globalMatrix),a[0]=e,a[1]=i,kr(a,a,u);const x=(a[0]-f.aabb.min[0])/(f.aabb.max[0]-f.aabb.min[0])*Vu|0,T=Math.min(63,(a[1]-f.aabb.min[1])/(f.aabb.max[1]-f.aabb.min[1])*Vu|0)*Vu+Math.min(63,x),E=f.heightmap[T];if(!(E<0&&h.node.footprint))return h.hiddenByReplacement?void 0:{height:E,maxHeight:h.feature.properties.height,hidden:!1,verticalScale:h.evaluatedScale[2]};if(h.node.footprint.grid.query(new st(e,i),new st(e,i),s),s.length>0)return{height:void 0,maxHeight:h.feature.properties.height,hidden:h.hiddenByReplacement,verticalScale:h.evaluatedScale[2]}}}}function jp(r,e){return r instanceof yc&&!r.isLightConstant&&e}function _3(r,e,i,s,a,u,h,f){let g=(61440&e|(61440&e)>>4)>>8,x=(3840&e|(3840&e)>>4)>>4,T=240&e|(240&e)>>4;i[3]>0&&(g=ei(g,255*i[0],i[3]),x=ei(x,255*i[1],i[3]),T=ei(T,255*i[2],i[3]));const E=g<<8|x,A=T<<8|Math.floor(255*s[3]),P=(function(ae){const me=j(ae,0,2);return Math.min(Math.round(.5*me*255),255)})(s[2])<<8|15*s[0]<<4|15*s[1],L=j(a[0],0,1),F=j(a[1],0,1),U=j(a[2],0,1),V=j(a[3],0,1);let $,X,Q,de;if(L!==F&&h!==u&&F!==L){const ae=h-u;X=1/(ae*(F-L)),Q=-(u+ae*L)/(ae*(F-L));const me=j(a[4],-1,1);de=Math.pow(10,me),$=255*U<<8|255*V}else $=65535,X=0,Q=1,de=1;if(r.emplaceBack(E,A,P,$,X,Q,de),f){const ae=f.length;f.clear();for(let me=0;me<ae;me++)f.emplaceBack(E,A,P,$,X,Q,de)}}function g3(r,e,i){const s=r.node;let a=0;const u=i&Id.HasMeshoptCompression;for(const h of s.meshes){if(s.lights&&s.lightMeshIndex===a||!h.featureData)continue;h.featureArray=new ad,h.featureArray.reserve(h.featureData.length);let f=e;for(const g of h.featureData){const x=u?65535&g:g>>16&65535,T=u?g>>16&65535:65535&g,E=(15&T)<8?15&T:0,A=r.evaluatedRMEA[E],P=r.evaluatedColor[E],L=r.emissionHeightBasedParams[E];let F;if(f&&E===2&&s.lights&&(F=new ad,F.resize(10*s.lights.length)),_3(h.featureArray,x,P,A,L,h.aabb.min[2],h.aabb.max[2],F),F&&f){f=!1;const U=s.meshes[s.lightMeshIndex];U.featureArray=F,U.featureArray._trim()}}h.featureArray._trim(),a++}}Lt(ug,"Tiled3dModelBucket",{omit:["layers"]}),Lt(Nw,"Tiled3dModelFeature");const y3=["id","tile","layer","source","sourceLayer","state"];class qu{constructor(e,i,s,a,u){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=s,this._y=a,this.properties=e?e.properties:{},this.id=u}clone(){const e=new qu(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&this._vectorTileFeature&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of y3)this[i]!==void 0&&(e[i]=this[i]);return e}}class Hu extends Ll{constructor(e,i,s,a){super(),this.id=e,this.type="model",this.models=[],this._loaded=!1,this._options=i,this._modelsInfo=new Map}load(){const e=[];for(const i in this._options.models){const s=this._options.models[i],a=this._modelsInfo.get(i);if(a){const u=a.model;u.position=s.position!=null?new n(s.position[0],s.position[1]):new n(0,0),u.orientation=s.orientation!=null?s.orientation:[0,0,0],a.modelSpec=s,Hu.applyModelSpecification(u,s),u.computeBoundsAndApplyParent(),this.models.push(u)}else{const u=sb(this.map._requestManager.transformRequest(s.uri,Qc.Model).url).then((h=>{if(!h)return;const f=gv(h),g=new hb(i,s.uri,s.position,s.orientation,f);Hu.applyModelSpecification(g,s),g.computeBoundsAndApplyParent(),this.models.push(g),this._modelsInfo.set(i,{modelSpec:s,model:g})})).catch((h=>{this.fire(new ru(new Error(`Could not load model ${i} from ${s.uri}: ${h.message}`)))}));e.push(u)}}Promise.allSettled(e).then((()=>{this._loaded=!0,this.fire(new qs("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((i=>{this._loaded=!0,this.fire(new ru(new Error(`Could not load models: ${i.message}`)))}))}static applyModelSpecification(e,i){i.nodeOverrides&&Hu.convertNodeOverrides(e,i.nodeOverrides),i.materialOverrides&&Hu.convertMaterialOverrides(e,i.materialOverrides),i.nodeOverrideNames&&(e.nodeOverrideNames=[...i.nodeOverrideNames]),i.materialOverrideNames&&(e.materialOverrideNames=[...i.materialOverrideNames]),i.featureProperties&&(e.featureProperties=i.featureProperties)}static convertNodeOverrides(e,i){if(Array.isArray(i)&&i.every((s=>typeof s=="string"))){e.nodeOverrideNames=[];for(const s of i)e.nodeOverrideNames.push(s)}else Object.entries(i).forEach((([s,a])=>{const u={orientation:[0,0,0]};if(a.hasOwnProperty("orientation")){const h=a.orientation;h&&(u.orientation=h)}e.nodeOverrides.set(s,u)}))}static convertMaterialOverrides(e,i){if(Array.isArray(i)&&i.every((s=>typeof s=="string"))){e.materialOverrideNames=[];for(const s of i)e.materialOverrideNames.push(s)}else Object.entries(i).forEach((([s,a])=>{const u={color:new lr(1,1,1),colorMix:0,emissionStrength:0,opacity:1},h=a["model-color"];h!==void 0&&(u.color.r=h[0],u.color.g=h[1],u.color.b=h[2]);const f=a["model-color-mix-intensity"];f!==void 0&&(u.colorMix=f);const g=a["model-emissive-strength"];g!==void 0&&(u.emissionStrength=g);const x=a["model-opacity"];x!==void 0&&(u.opacity=x),e.materialOverrides.set(s,u)}))}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(e,i){}serialize(){return this._options}setProperty(e,i){return!1}reload(){const e=Is(this.id,this.scope);this.map.style.clearSource(e),this.models=[],this._modelsInfo.clear(),this._loaded=!1,this.load()}setModels(e){this.models=[];const i=new Map;for(const s in e){const a=e[s];if(this._modelsInfo.has(s)){const u=this._modelsInfo.get(s);u&&u.modelSpec.uri===a.uri&&i.set(s,u)}}this._modelsInfo=i,this._options.models=e,this._loaded=!1,this.load()}}function Hv(r,e,i,s){const a=1<<r.z;e.lat=O((s/gt+r.y)/a),e.lng=C((i/gt+r.x)/a)}function v3(r,e,i,s){const a=r.getNodesInfo()[e];if(!a||a.hiddenByReplacement||!a.node.meshes)return;let u=Number.MAX_VALUE;const h=a.node,f=i.tile,g=s.calculatePosMatrix(f.tileID.toUnwrapped(),s.worldSize),x=a.evaluatedScale;let T=0;s.elevation&&h.elevation&&(T=h.elevation*s.elevation.exaggeration()),Oe(g,g,[(h.anchor?h.anchor[0]:0)*(x[0]-1),(h.anchor?h.anchor[1]:0)*(x[1]-1),T]),Ae(g,g,x);const E=i.queryGeometry,A=E.isPointQuery()?E.screenBounds:E.screenGeometry,P=function(F){const U=Le([],g,F.globalMatrix);Le(U,s.expandedFarZProjMatrix,U);for(let V=0;V<F.meshes.length;++V){const $=F.meshes[V];if(V===F.lightMeshIndex)continue;const X=fv(A,s,U,$.aabb);X!=null&&(u=Math.min(X,u))}if(F.children)for(const V of F.children)P(V)};if(P(h),u===Number.MAX_VALUE)return;const L=new n(0,0);return Hv(f.tileID.canonical,L,a.node.anchor[0],a.node.anchor[1]),{intersectionZ:u,position:L,feature:a.feature}}const x3={circle:class extends po{constructor(r,e,i,s){super(r,{layout:So||(So=new en({"circle-sort-key":new xt(Re.layout_circle["circle-sort-key"]),"circle-elevation-reference":new mt(Re.layout_circle["circle-elevation-reference"]),visibility:new mt(Re.layout_circle.visibility)})),paint:tn||(tn=new en({"circle-radius":new xt(Re.paint_circle["circle-radius"]),"circle-color":new xt(Re.paint_circle["circle-color"]),"circle-blur":new xt(Re.paint_circle["circle-blur"]),"circle-opacity":new xt(Re.paint_circle["circle-opacity"]),"circle-translate":new mt(Re.paint_circle["circle-translate"]),"circle-translate-anchor":new mt(Re.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new mt(Re.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new mt(Re.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new xt(Re.paint_circle["circle-stroke-width"]),"circle-stroke-color":new xt(Re.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new xt(Re.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new mt(Re.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}createBucket(r){return new cr(r)}queryRadius(r){const e=r;return io("circle-radius",this,e)+io("circle-stroke-width",this,e)+$n(this.paint.get("circle-translate"))}queryIntersectsFeature(r,e,i,s,a,u,h,f){const g=hs(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),x=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return Zx(r,s,u,h,f,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",g,x)}getProgramIds(){return["circle"]}getDefaultProgramParams(r,e,i){const s=Hx(this);return{config:new al(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}is3D(r){return!r&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends po{createBucket(r){return new Wx(r)}constructor(r,e,i,s){super(r,{layout:Xx||(Xx=new en({visibility:new mt(Re.layout_heatmap.visibility)})),paint:Yx||(Yx=new en({"heatmap-radius":new xt(Re.paint_heatmap["heatmap-radius"]),"heatmap-weight":new xt(Re.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new mt(Re.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Ul(Re.paint_heatmap["heatmap-color"]),"heatmap-opacity":new mt(Re.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=up({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(r){return io("heatmap-radius",this,r)}queryIntersectsFeature(r,e,i,s,a,u,h,f){const g=this.paint.get("heatmap-radius").evaluate(e,i);return Zx(r,s,u,h,f,!0,!0,new st(0,0),g)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(r,e,i){return r==="heatmap"?{config:new al(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends po{constructor(r,e,i,s){super(r,{layout:Jx||(Jx=new en({visibility:new mt(Re.layout_hillshade.visibility)})),paint:Kx||(Kx=new en({"hillshade-illumination-direction":new mt(Re.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new mt(Re.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new mt(Re.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new mt(Re.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new mt(Re.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new mt(Re.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new mt(Re.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}},fill:class extends po{constructor(r,e,i,s){super(r,{layout:f1||(f1=new en({"fill-sort-key":new xt(Re.layout_fill["fill-sort-key"]),visibility:new mt(Re.layout_fill.visibility),"fill-elevation-reference":new mt(Re.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new xt(Re.layout_fill["fill-construct-bridge-guard-rail"])})),paint:p1||(p1=new en({"fill-antialias":new mt(Re.paint_fill["fill-antialias"]),"fill-opacity":new xt(Re.paint_fill["fill-opacity"]),"fill-color":new xt(Re.paint_fill["fill-color"]),"fill-outline-color":new xt(Re.paint_fill["fill-outline-color"]),"fill-translate":new mt(Re.paint_fill["fill-translate"]),"fill-translate-anchor":new mt(Re.paint_fill["fill-translate-anchor"]),"fill-pattern":new xt(Re.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new mt(Re.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new mt(Re.paint_fill["fill-emissive-strength"]),"fill-z-offset":new xt(Re.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new xt(Re.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new xt(Re.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){const r=this.paint.get("fill-pattern"),e=r&&r.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(r,e,i){return{config:new al(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(r,e){super.recalculate(r,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new Yy(r)}queryRadius(){return $n(this.paint.get("fill-translate"))}queryIntersectsFeature(r,e,i,s,a,u){return!r.queryGeometry.isAboveHorizon&&ir(Zo(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),s)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(r){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return r!=null?e&&!r:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends po{constructor(r,e,i,s){super(r,{layout:V1||(V1=new en({visibility:new mt(Re["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new mt(Re["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:U1||(U1=new en({"fill-extrusion-opacity":new mt(Re["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new xt(Re["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new mt(Re["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new mt(Re["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new xt(Re["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new mt(Re["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new xt(Re["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new xt(Re["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new mt(Re["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new mt(Re["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new mt(Re["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new mt(Re["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new mt(Re["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new mt(Re["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new mt(Re["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new mt(Re["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new mt(Re["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new mt(Re["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new xt(Re["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new xt(Re["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new mt(Re["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new mt(Re["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new mt(Re["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new mt(Re["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new xt(Re["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new xt(Re["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new mt(Re["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new z_(r)}queryRadius(){return $n(this.paint.get("fill-extrusion-translate"))}is3D(r){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(r,e,i,s,a,u,h,f,g){const x=hs(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),T=this.paint.get("fill-extrusion-height").evaluate(e,i),E=this.paint.get("fill-extrusion-base").evaluate(e,i),A=[0,0],P=f&&u.elevation,L=u.elevation?u.elevation.exaggeration():1,F=r.tile.getBucket(this);if(P&&F instanceof z_){const Q=F.centroidVertexArray,de=g+1;de<Q.length&&(A[0]=Q.geta_centroid_pos0(de),A[1]=Q.geta_centroid_pos1(de))}if(A[0]===0&&A[1]===1)return!1;u.projection.name==="globe"&&(s=N1([s],[new st(0,0),new st(gt,gt)],r.tileID.canonical).map((Q=>Q.polygon)).flat());const U=P?f:null,[V,$]=W1(u,s,E,T,x,h,U,A,L,u.center.lat,r.tileID.canonical),X=r.queryGeometry;return $1(V,$,X.isPointQuery()?X.screenBounds:X.screenGeometry)}},building:class extends po{constructor(r,e,i,s){super(r,{layout:yb||(yb=new en({visibility:new mt(Re.layout_building.visibility),"building-facade":new xt(Re.layout_building["building-facade"]),"building-facade-floors":new xt(Re.layout_building["building-facade-floors"]),"building-facade-unit-width":new xt(Re.layout_building["building-facade-unit-width"]),"building-facade-window":new xt(Re.layout_building["building-facade-window"]),"building-roof-shape":new xt(Re.layout_building["building-roof-shape"]),"building-height":new xt(Re.layout_building["building-height"]),"building-base":new xt(Re.layout_building["building-base"]),"building-flood-light-wall-radius":new xt(Re.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new xt(Re.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new xt(Re.layout_building["building-flip-roof-orientation"])})),paint:vb||(vb=new en({"building-opacity":new mt(Re.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new mt(Re.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new mt(Re.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new mt(Re.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new mt(Re.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new mt(Re.paint_building["building-vertical-scale"]),"building-cast-shadows":new mt(Re.paint_building["building-cast-shadows"]),"building-color":new xt(Re.paint_building["building-color"]),"building-emissive-strength":new xt(Re.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new mt(Re.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new mt(Re.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new mt(Re.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new mt(Re.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new mt(Re.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new gb(r)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(r){return!0}queryRadius(r){return 0}queryIntersectsFeature(r,e,i,s,a,u,h,f,g){let x=this.layout.get("building-height").evaluate(e,i);const T=this.layout.get("building-base").evaluate(e,i),E=r.tile.getBucket(this).getFootprint(e);if(E){if(E.hiddenFlags!==0)return!1;x=E.height}const[A,P]=W1(u,s,T,x,new st(0,0),h,null,[0,0],1,u.center.lat,r.tileID.canonical),L=r.queryGeometry;return $1(A,P,L.isPointQuery()?L.screenBounds:L.screenGeometry)}},line:class extends po{constructor(r,e,i,s){const a=Mb();super(r,a,e,i,s),a.layout&&(this.layout=new Vl(a.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(r){if(r==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof mu,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}emissiveStrengthExpression(){return this._transitionablePaint._values["line-emissive-strength"].value.expression}recalculate(r,e){super.recalculate(r,e),this.paint._values["line-floorwidth"]=(()=>{if(Ap)return Ap;const i=Mb();return Ap=new pA(i.paint.properties["line-width"].specification),Ap.useIntegerZoom=!0,Ap})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new xv(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(r,e,i){const s=Ab(this);return{config:new al(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}queryRadius(r){const e=r,i=Pb(io("line-width",this,e),io("line-gap-width",this,e)),s=io("line-offset",this,e);return i/2+Math.abs(s)+$n(this.paint.get("line-translate"))}queryIntersectsFeature(r,e,i,s,a,u){if(r.queryGeometry.isAboveHorizon)return!1;const h=Zo(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),f=r.pixelToTileUnitsFactor/2*Pb(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),g=this.paint.get("line-offset").evaluate(e,i);return g&&(s=(function(x,T){const E=[],A=new st(0,0);for(let P=0;P<x.length;P++){const L=x[P],F=[];for(let U=0;U<L.length;U++){const V=L[U],$=L[U+1],X=U===0?A:V.sub(L[U-1])._unit()._perp(),Q=U===L.length-1?A:$.sub(V)._unit()._perp(),de=X._add(Q)._unit();de._mult(1/(de.x*Q.x+de.y*Q.y)),F.push(de._mult(T)._add(V))}E.push(F)}return E})(s,g*r.pixelToTileUnitsFactor)),(function(x,T,E){for(let A=0;A<T.length;A++){const P=T[A];if(x.length>=3){for(let L=0;L<P.length;L++)if(vr(x,P[L]))return!0}if($r(x,P,E))return!0}return!1})(h,s,f)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(r){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:sg,background:class extends po{constructor(r,e,i,s){super(r,{layout:yw||(yw=new en({visibility:new mt(Re.layout_background.visibility)})),paint:vw||(vw=new en({"background-pitch-alignment":new mt(Re.paint_background["background-pitch-alignment"]),"background-color":new mt(Re.paint_background["background-color"]),"background-pattern":new mt(Re.paint_background["background-pattern"]),"background-opacity":new mt(Re.paint_background["background-opacity"]),"background-emissive-strength":new mt(Re.paint_background["background-emissive-strength"]),"background-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}is3D(r){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:Ew,"raster-particle":Pw,sky:class extends po{constructor(r,e,i,s){super(r,{layout:Aw||(Aw=new en({visibility:new mt(Re.layout_sky.visibility)})),paint:Cw||(Cw=new en({"sky-type":new mt(Re.paint_sky["sky-type"]),"sky-atmosphere-sun":new mt(Re.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new mt(Re.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new mt(Re.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new mt(Re.paint_sky["sky-gradient-radius"]),"sky-gradient":new Ul(Re.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new mt(Re.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new mt(Re.paint_sky["sky-atmosphere-color"]),"sky-opacity":new mt(Re.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(r){r==="sky-gradient"?this._updateColorRamp():r!=="sky-atmosphere-sun"&&r!=="sky-atmosphere-halo-color"&&r!=="sky-atmosphere-color"&&r!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=up({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(r,e){if(this.paint.get("sky-type")==="atmosphere"){const s=this.paint.get("sky-atmosphere-sun"),a=!s,u=r.style.light,h=u.properties.get("position");return a&&u.properties.get("anchor")==="viewport"&&It("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),a?Uv(h.azimuthal,90-h.polar,e):Uv(s[0],90-s[1],e)}const i=this.paint.get("sky-gradient-center");return Uv(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const r=this.paint.get("sky-type");return r==="atmosphere"?["skyboxCapture","skybox"]:r==="gradient"?["skyboxGradient"]:null}},slot:class extends po{constructor(r,e,i,s){super(r,{paint:Mw||(Mw=new en({}))},e,null)}},model:class extends po{constructor(r,e,i,s){super(r,{layout:Ow||(Ow=new en({visibility:new mt(Re.layout_model.visibility),"model-id":new xt(Re.layout_model["model-id"])})),paint:zw||(zw=new en({"model-opacity":new xt(Re.paint_model["model-opacity"]),"model-rotation":new xt(Re.paint_model["model-rotation"]),"model-scale":new xt(Re.paint_model["model-scale"]),"model-translation":new xt(Re.paint_model["model-translation"]),"model-color":new xt(Re.paint_model["model-color"]),"model-color-mix-intensity":new xt(Re.paint_model["model-color-mix-intensity"]),"model-type":new mt(Re.paint_model["model-type"]),"model-cast-shadows":new mt(Re.paint_model["model-cast-shadows"]),"model-receive-shadows":new mt(Re.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new mt(Re.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new xt(Re.paint_model["model-emissive-strength"]),"model-roughness":new xt(Re.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new xt(Re.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new mt(Re.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new mt(Re.paint_model["model-front-cutoff"]),"model-elevation-reference":new mt(Re.paint_model["model-elevation-reference"]),"model-color-use-theme":new xt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this.layer=r,this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Gv(r)}getProgramIds(){return["model"]}is3D(r){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(r){return r instanceof ug?gt-1:0}queryRenderedFeatures(r,e,i){const s=e.getSource();if(!(s&&s instanceof Hu))return{};const a=s,u={};u[this.id]=[];const h=u[this.id];let f=0;for(const g of a.models){const x=e.getFeatureState(this.sourceLayer,g.id),T={type:"Unknown",id:g.id,properties:g.featureProperties},E=this.paint.get("model-rotation").evaluate(T,x),A=this.paint.get("model-scale").evaluate(T,x),P=this.paint.get("model-translation").evaluate(T,x),L=this.paint.get("model-elevation-reference");let F=[];q_(F,g,i,g.position,E,A,P,L==="ground",L==="ground",!1),i.projection.name==="globe"&&(F=G_(F,i));const U=Le([],i.projMatrix,F),V=fv(r.isPointQuery()?r.screenBounds:r.screenGeometry,i,U,g.aabb);if(V!=null){const $=new qu(void 0,0,0,0,g.id);$.layer=this.layer,$.properties=structuredClone(g.featureProperties),$.properties.layer=this.id,$.properties.uri=g.uri,$.properties.orientation=g.orientation,$.sourceLayer=this.sourceLayer,$.geometry={type:"Point",coordinates:[g.position.lng,g.position.lat]},$.state=x,$.source=this.source,h.push({featureIndex:f,feature:$,intersectionZ:V})}++f}return u}queryIntersectsFeature(r,e,i,s,a,u){if(!this.modelManager)return!1;const h=this.modelManager,f=r.tile.getBucket(this);if(!(f&&f instanceof Gv))return!1;for(const g in f.instancesPerModel){const x=f.instancesPerModel[g],T=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(x.idToFeaturesIndex.hasOwnProperty(T)){const E=x.features[x.idToFeaturesIndex[T]],A=h.getModel(g,this.scope);if(!A)return!1;let P=[];const L=new n(0,0),F=f.canonical;let U=Number.MAX_VALUE;for(let V=0;V<E.instancedDataCount;++V){const $=16*(E.instancedDataOffset+V),X=x.instancedDataArray.float32,Q=[X[$+4],X[$+5],X[$+6]];Hv(F,L,Math.floor(X[$]),Math.floor(X[$+1])),q_(P,A,u,L,E.rotation,E.scale,Q,!1,!1,!1),u.projection.name==="globe"&&(P=G_(P,u));const de=Le([],u.projMatrix,P),ae=r.queryGeometry,me=fv(ae.isPointQuery()?ae.screenBounds:ae.screenGeometry,u,de,A.aabb);me!=null&&(U=Math.min(me,U))}return U!==Number.MAX_VALUE&&U}}return!1}_handleOverridablePaintPropertyUpdate(r,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||r!=="model-color"&&r!=="model-color-mix-intensity"&&r!=="model-rotation"&&r!=="model-scale"&&r!=="model-translation"&&r!=="model-emissive-strength")}_isPropertyZoomDependent(r){const e=this._transitionablePaint._values[r];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof Fl}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends po{constructor(r,e,i,s){super(r,{layout:m1||(m1=new en({"clip-layer-types":new mt(Re.layout_clip["clip-layer-types"]),"clip-layer-scope":new mt(Re.layout_clip["clip-layer-scope"])})),paint:_1||(_1=new en({}))},e,i,s)}recalculate(r,e){super.recalculate(r,e)}createBucket(r){return new g1(r)}is3D(r){return!0}}},Zv=new lr(0,0,0),$v={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},Wv={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},hg={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},b3={PAINT_ORDER_FILL_AND_STROKE:1},Gp={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},Vw={MASK_TYPE_LUMINANCE:1};function w3(r,e,i){r===1&&e.icons.push((function(s,a){return(function(u){if(u.usvg_tree.height||(u.usvg_tree.height=u.usvg_tree.width),!u.metadata)return u;const{metadata:h}=u;if(h.content_area){const{content_area:f}=h;f.left==null&&(f.left=0),f.top==null&&(f.top=f.left),f.width==null&&(f.width=u.usvg_tree.width),f.height==null&&(f.height=f.width)}if(h.text_placeholder){const{text_placeholder:f}=h;f.top==null&&(f.top=f.left),f.height==null&&(f.height=f.width)}return h.stretch_x&&h.stretch_x.length&&Uw(h,"x"),h.stretch_y&&h.stretch_y.length&&Uw(h,"y"),u})(s.readFields(T3,{name:void 0},a))})(i,i.readVarint()+i.pos))}function Uw(r,e){const i=[],s=r[`stretch_${e}`];let a=null;for(let u=0;u<s.length;u++)a===null?a=i.length===0?s[0]:i[i.length-1][1]+s[u]:(i.push([a,a+s[u]]),a=null);r[`stretch_${e}_areas`]=i}function T3(r,e,i){r===1?e.name=i.readString():r===2?e.metadata=(function(s,a){return s.readFields(E3,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},a)})(i,i.readVarint()+i.pos):r===3&&(e.usvg_tree=(function(s,a){return s.readFields(A3,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},a)})(i,i.readVarint()+i.pos),e.data="usvg_tree")}function E3(r,e,i){r===1?e.stretch_x=i.readPackedVarint():r===2?e.stretch_y=i.readPackedVarint():r===3?e.content_area=jw(i,i.readVarint()+i.pos):r===4?e.variables.push((function(s,a){return s.readFields(I3,{name:void 0},a)})(i,i.readVarint()+i.pos)):r===5&&(e.text_placeholder=jw(i,i.readVarint()+i.pos))}function jw(r,e){return r.readFields(S3,{},e)}function S3(r,e,i){r===1?e.left=i.readVarint():r===2?e.width=i.readVarint():r===3?e.top=i.readVarint():r===4&&(e.height=i.readVarint())}function I3(r,e,i){r===1?e.name=i.readString():r===2&&(e.rgb_color=pg(i.readVarint()),e.value="rgb_color")}function A3(r,e,i){r===1?e.width=e.height=i.readVarint():r===2?e.height=i.readVarint():r===3?e.children.push(dg(i,i.readVarint()+i.pos)):r===4?e.linear_gradients.push((function(s,a){return s.readFields(O3,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},a)})(i,i.readVarint()+i.pos)):r===5?e.radial_gradients.push((function(s,a){return s.readFields(k3,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},a)})(i,i.readVarint()+i.pos)):r===7?e.clip_paths.push((function(s,a){return s.readFields(F3,{children:[]},a)})(i,i.readVarint()+i.pos)):r===8&&e.masks.push((function(s,a){const u=s.readFields(B3,{left:0,width:20,mask_type:Vw.MASK_TYPE_LUMINANCE,children:[]},a);return u.height==null&&(u.height=u.width),u.top==null&&(u.top=u.left),u})(i,i.readVarint()+i.pos))}function dg(r,e){return r.readFields(C3,{},e)}function C3(r,e,i){r===1?(e.group=(function(s,a){return s.readFields(M3,{opacity:255,children:[]},a)})(i,i.readVarint()+i.pos),e.node="group"):r===2&&(e.path=(function(s,a){return s.readFields(L3,{paint_order:1,commands:[],step:1,diffs:[],rule:$v.PATH_RULE_NON_ZERO},a)})(i,i.readVarint()+i.pos),e.node="path")}function M3(r,e,i){r===1?e.transform=fg(i,i.readVarint()+i.pos):r===2?e.opacity=i.readVarint():r===5?e.clip_path_idx=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(dg(i,i.readVarint()+i.pos))}function fg(r,e){return r.readFields(P3,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function P3(r,e,i){r===1?e.sx=i.readFloat():r===2?e.ky=i.readFloat():r===3?e.kx=i.readFloat():r===4?e.sy=i.readFloat():r===5?e.tx=i.readFloat():r===6&&(e.ty=i.readFloat())}function L3(r,e,i){r===1?e.fill=(function(s,a){return s.readFields(R3,{rgb_color:Zv,paint:"rgb_color",opacity:255},a)})(i,i.readVarint()+i.pos):r===2?e.stroke=(function(s,a){return s.readFields(D3,{rgb_color:Zv,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},a)})(i,i.readVarint()+i.pos):r===3?e.paint_order=i.readVarint():r===5?i.readPackedVarint(e.commands):r===6?e.step=i.readFloat():r===7?i.readPackedSVarint(e.diffs):r===8&&(e.rule=i.readVarint())}function R3(r,e,i){r===1?(e.rgb_color=pg(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5&&(e.opacity=i.readVarint())}function pg(r){return new lr((r>>16&255)/255,(r>>8&255)/255,(255&r)/255,1)}function D3(r,e,i){r===1?(e.rgb_color=pg(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5?i.readPackedFloat(e.dasharray):r===6?e.dashoffset=i.readFloat():r===7?e.miterlimit=i.readFloat():r===8?e.opacity=i.readVarint():r===9?e.width=i.readFloat():r===10?e.linecap=i.readVarint():r===11&&(e.linejoin=i.readVarint())}function O3(r,e,i){r===1?e.transform=fg(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(Gw(i,i.readVarint()+i.pos)):r===4?e.x1=i.readFloat():r===5?e.y1=i.readFloat():r===6?e.x2=i.readFloat():r===7&&(e.y2=i.readFloat())}function Gw(r,e){return r.readFields(z3,{offset:0,opacity:255,rgb_color:Zv},e)}function z3(r,e,i){r===1?e.offset=i.readFloat():r===2?e.opacity=i.readVarint():r===3&&(e.rgb_color=pg(i.readVarint()))}function k3(r,e,i){r===1?e.transform=fg(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(Gw(i,i.readVarint()+i.pos)):r===4?e.cx=i.readFloat():r===5?e.cy=i.readFloat():r===6?e.r=i.readFloat():r===7?e.fx=i.readFloat():r===8?e.fy=i.readFloat():r===9&&(e.fr=i.readFloat())}function F3(r,e,i){r===1?e.transform=fg(i,i.readVarint()+i.pos):r===2?e.clip_path_idx=i.readVarint():r===3&&e.children.push(dg(i,i.readVarint()+i.pos))}function B3(r,e,i){r===1?e.left=e.top=i.readFloat():r===2?e.width=e.height=i.readFloat():r===3?e.top=i.readFloat():r===4?e.height=i.readFloat():r===5?e.mask_type=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(dg(i,i.readVarint()+i.pos))}class N3{static calculate(e={},i=[]){const s=new Map,a=new Map;if(Object.keys(e).length===0)return s;i.forEach((u=>{a.set(u.name,u.rgb_color||new lr(0,0,0))}));for(const[u,h]of Object.entries(e))a.has(u)?s.set(a.get(u).toString(),h):console.warn(`Ignoring unknown image variable "${u}"`);return s}}function kd(r,e=255,i){const s=e/255,a=r.toString(),u=i.has(a)?i.get(a).clone():r.clone();return u.a*=s,u.toString()}function qp(r,e){if(!Us()){const i=document.createElement("canvas");return i.width=r,i.height=e,i}return new OffscreenCanvas(r,e)}let Xv,Hp=null;function Yv(r,e,i,s,a){for(const u of s.children)qw(r,e,i,u,a)}function qw(r,e,i,s,a){s.group?(r.save(),(function(u,h,f,g,x){const T=g.mask_idx!=null?f.masks[g.mask_idx]:null,E=g.clip_path_idx!=null?f.clip_paths[g.clip_path_idx]:null;if(g.transform&&(h=Fd(g.transform).preMultiplySelf(h)),!(function(L,F,U){return L.opacity!==255||F||U})(g,E!=null,T!=null))return void Yv(u,h,f,g,x);const A=qp(u.canvas.width,u.canvas.height),P=A.getContext("2d");Yv(P,h,f,g,x),E&&Jw(P,h,f,E),T&&Kw(P,h,f,T,x),u.globalAlpha=g.opacity/255,u.drawImage(A,0,0)})(r,e,i,s.group,a),r.restore()):s.path&&(r.save(),(function(u,h,f,g,x){u.setTransform(h),g.paint_order===b3.PAINT_ORDER_FILL_AND_STROKE?(Hw(u,f,g,x),$w(u,f,g,x)):($w(u,f,g,x),Hw(u,f,g,x))})(r,e,i,s.path,a),r.restore())}function Hw(r,e,i,s){const a=i.fill;if(!a)return;const u=a.opacity/255;switch(r.save(),r.beginPath(),Qw(i,r),a.paint){case"rgb_color":r.fillStyle=kd(a.rgb_color,a.opacity,s);break;case"linear_gradient_idx":{const h=e.linear_gradients[a.linear_gradient_idx];h.transform&&r.setTransform(Fd(h.transform).preMultiplySelf(r.getTransform())),r.fillStyle=Ww(r,h,u,s);break}case"radial_gradient_idx":{const h=e.radial_gradients[a.radial_gradient_idx];h.transform&&r.setTransform(Fd(h.transform).preMultiplySelf(r.getTransform())),r.fillStyle=Xw(r,h,u,s)}}r.fill(Zw(i)),r.restore()}function Zw(r){return r.rule===$v.PATH_RULE_NON_ZERO?"nonzero":r.rule===$v.PATH_RULE_EVEN_ODD?"evenodd":void 0}function $w(r,e,i,s){const a=i.stroke;if(!a)return;const u=e2(i);r.lineWidth=a.width,r.miterLimit=a.miterlimit,r.setLineDash(a.dasharray),r.lineDashOffset=a.dashoffset;const h=a.opacity/255;switch(a.paint){case"rgb_color":r.strokeStyle=kd(a.rgb_color,a.opacity,s);break;case"linear_gradient_idx":r.strokeStyle=Ww(r,e.linear_gradients[a.linear_gradient_idx],h,s,!0);break;case"radial_gradient_idx":r.strokeStyle=Xw(r,e.radial_gradients[a.radial_gradient_idx],h,s,!0)}switch(a.linejoin){case hg.LINE_JOIN_MITER_CLIP:case hg.LINE_JOIN_MITER:r.lineJoin="miter";break;case hg.LINE_JOIN_ROUND:r.lineJoin="round";break;case hg.LINE_JOIN_BEVEL:r.lineJoin="bevel"}switch(a.linecap){case Wv.LINE_CAP_BUTT:r.lineCap="butt";break;case Wv.LINE_CAP_ROUND:r.lineCap="round";break;case Wv.LINE_CAP_SQUARE:r.lineCap="square"}r.stroke(u)}function Ww(r,e,i,s,a=!1){if(e.stops.length===1){const A=e.stops[0];return kd(A.rgb_color,A.opacity*i,s)}const{x1:u,y1:h,x2:f,y2:g}=e;let x=new DOMPoint(u,h),T=new DOMPoint(f,g);if(a){const A=Fd(e.transform);x=A.transformPoint(x),T=A.transformPoint(T)}const E=r.createLinearGradient(x.x,x.y,T.x,T.y);for(const A of e.stops)E.addColorStop(A.offset,kd(A.rgb_color,A.opacity*i,s));return E}function Xw(r,e,i,s,a=!1){if(e.stops.length===1){const V=e.stops[0];return kd(V.rgb_color,V.opacity*i,s)}const u=Fd(e.transform),{fx:h,fy:f,fr:g,cx:x,cy:T,r:E}=e;let A=new DOMPoint(h,f),P=new DOMPoint(x,T),L=g,F=E;if(a){A=u.transformPoint(A),P=u.transformPoint(P);const V=(u.a+u.d)/2;L=g*V,F=e.r*V}const U=r.createRadialGradient(A.x,A.y,L,P.x,P.y,F);for(const V of e.stops)U.addColorStop(V.offset,kd(V.rgb_color,V.opacity*i,s));return U}function Yw(r,e,i,s){const a=s.transform?Fd(s.transform).preMultiplySelf(e):e,u=qp(r.canvas.width,r.canvas.height),h=u.getContext("2d");for(const g of s.children)if(g.group)Yw(h,a,i,g.group);else if(g.path){const x=g.path,T=new Path2D;T.addPath(e2(x),a),h.fill(T,Zw(x))}const f=s.clip_path_idx!=null?i.clip_paths[s.clip_path_idx]:null;f&&Jw(h,a,i,f),r.globalCompositeOperation="source-over",r.drawImage(u,0,0)}function Jw(r,e,i,s){const a=qp(r.canvas.width,r.canvas.height);Yw(a.getContext("2d"),e,i,s),r.globalCompositeOperation="destination-in",r.drawImage(a,0,0)}function Kw(r,e,i,s,a){if(s.children.length===0)return;const u=s.mask_idx!=null?i.masks[s.mask_idx]:null;u&&Kw(r,e,i,u,a);const h=r.canvas.width,f=r.canvas.height,g=qp(h,f),x=g.getContext("2d"),T=s.width,E=s.height,A=s.left,P=s.top,L=new Path2D,F=new Path2D;F.rect(A,P,T,E),L.addPath(F,e),x.clip(L);for(const $ of s.children)qw(x,e,i,$,a);const U=x.getImageData(0,0,h,f),V=U.data;if(s.mask_type===Vw.MASK_TYPE_LUMINANCE)for(let $=0;$<V.length;$+=4)V[$+3]=V[$+3]/255*(.2126*V[$]+.7152*V[$+1]+.0722*V[$+2]);x.putImageData(U,0,0),r.globalCompositeOperation="destination-in",r.drawImage(g,0,0)}function Fd(r){return r?new DOMMatrix([r.sx,r.ky,r.kx,r.sy,r.tx,r.ty]):new DOMMatrix}function Qw(r,e){const i=r.step;let s=r.diffs[0]*i,a=r.diffs[1]*i;e.moveTo(s,a);for(let u=0,h=2;u<r.commands.length;u++)switch(r.commands[u]){case Gp.PATH_COMMAND_MOVE:s+=r.diffs[h++]*i,a+=r.diffs[h++]*i,e.moveTo(s,a);break;case Gp.PATH_COMMAND_LINE:s+=r.diffs[h++]*i,a+=r.diffs[h++]*i,e.lineTo(s,a);break;case Gp.PATH_COMMAND_QUAD:{const f=s+r.diffs[h++]*i,g=a+r.diffs[h++]*i;s=f+r.diffs[h++]*i,a=g+r.diffs[h++]*i,e.quadraticCurveTo(f,g,s,a);break}case Gp.PATH_COMMAND_CUBIC:{const f=s+r.diffs[h++]*i,g=a+r.diffs[h++]*i,x=f+r.diffs[h++]*i,T=g+r.diffs[h++]*i;s=x+r.diffs[h++]*i,a=T+r.diffs[h++]*i,e.bezierCurveTo(f,g,x,T,s,a);break}case Gp.PATH_COMMAND_CLOSE:e.closePath()}return e}function e2(r){return Qw(r,new Path2D)}class mg{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}Lt(mg,"LRUCache");class Jv{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new ro(e,e.data)}getFromCache(e,i,s){return this.cacheMap.has(s)||this.cacheMap.set(s,new mg(150)),this.cacheMap.get(s).get(Is(e.toString(),i))}setInCache(e,i,s,a){this.cacheDependenciesMap.has(a)||this.cacheDependenciesMap.set(a,new Map),this.cacheMap.has(a)||this.cacheMap.set(a,new mg(150));const u=this.cacheDependenciesMap.get(a),h=Is(e.id.toString(),s);u.get(h)||u.set(h,new Set);const f=this.cacheMap.get(a),g=e.toString();u.get(h).add(g),f.put(Is(e.toString(),s),i)}removeImagesFromCacheByIds(e,i,s=0){if(!this.cacheMap.has(s)||!this.cacheDependenciesMap.has(s))return;const a=this.cacheMap.get(s),u=this.cacheDependenciesMap.get(s);for(const h of e){const f=Is(h.toString(),i);if(u.has(f)){for(const g of u.get(f))a.delete(g);u.delete(f)}}}rasterize(e,i,s,a){const u=this.getFromCache(e,s,a);if(u)return u.clone();const h=(function(g,x){const T=N3.calculate(x.params,g.metadata?g.metadata.variables:[]),E=g.usvg_tree,A=E.width,P=E.height,L=Math.max(1,Math.round(A*x.sx)),F=Math.max(1,Math.round(P*x.sy)),U=new DOMMatrix([L/A,0,0,F/P,0,0]);return Hp===null&&(Hp=qp(10,10),Xv=Hp.getContext("2d",{willReadFrequently:!0})),Hp.width=L,Hp.height=F,Yv(Xv,U,E,E,T),Xv.getImageData(0,0,L,F)})(i.icon,e),f=Jv._getImage(h);return this.setInCache(e,f,s,a),f.clone()}}class t2{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const s=this.toIdx(e,i);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function i2(r,e,i,s){let a=0,u=Number.MAX_VALUE;for(let h=0;h<3;h++)if(Math.abs(s[h])<1e-15){if(i[h]<r[h]||i[h]>e[h])return null}else{const f=1/s[h];let g=(r[h]-i[h])*f,x=(e[h]-i[h])*f;if(g>x){const T=g;g=x,x=T}if(g>a&&(a=g),x<u&&(u=x),a>u)return null}return a}function r2(r,e,i,s,a,u,h,f,g,x,T){const E=s-r,A=a-e,P=u-i,L=h-r,F=f-e,U=g-i,V=T[1]*U-T[2]*F,$=T[2]*L-T[0]*U,X=T[0]*F-T[1]*L,Q=E*V+A*$+P*X;if(Math.abs(Q)<1e-15)return null;const de=1/Q,ae=x[0]-r,me=x[1]-e,xe=x[2]-i,Ee=(ae*V+me*$+xe*X)*de;if(Ee<0||Ee>1)return null;const Ge=me*P-xe*A,Me=xe*E-ae*P,$e=ae*A-me*E,Ke=(T[0]*Ge+T[1]*Me+T[2]*$e)*de;return Ke<0||Ee+Ke>1?null:(L*Ge+F*Me+U*$e)*de}function n2(r,e,i){return(r-e)/(i-e)}function o2(r,e,i,s,a,u,h,f,g){const x=1<<i,T=u-s,E=h-a,A=(r+1)/x*T+s,P=(e+0)/x*E+a,L=(e+1)/x*E+a;f[0]=(r+0)/x*T+s,f[1]=P,g[0]=A,g[1]=L}class s2{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=(function(u){const h=Math.ceil(Math.log2(u.dim/8)),f=[];let g=Math.ceil(Math.pow(2,h));const x=1/g,T=(P,L,F,U,V)=>{const $=U?1:0,X=(P+1)*F-$,Q=L*F,de=(L+1)*F-$;V[0]=P*F,V[1]=Q,V[2]=X,V[3]=de};let E=new t2(g);const A=[];for(let P=0;P<g*g;P++){T(P%g,Math.floor(P/g),x,!1,A);const L=zc(A[0],A[1],u),F=zc(A[2],A[1],u),U=zc(A[2],A[3],u),V=zc(A[0],A[3],u);E.minimums.push(Math.min(L,F,U,V)),E.maximums.push(Math.max(L,F,U,V)),E.leaves.push(1)}for(f.push(E),g/=2;g>=1;g/=2){const P=f[f.length-1];E=new t2(g);for(let L=0;L<g*g;L++){T(L%g,Math.floor(L/g),2,!0,A);const F=P.getElevation(A[0],A[1]),U=P.getElevation(A[2],A[1]),V=P.getElevation(A[2],A[3]),$=P.getElevation(A[0],A[3]),X=P.isLeaf(A[0],A[1]),Q=P.isLeaf(A[2],A[1]),de=P.isLeaf(A[2],A[3]),ae=P.isLeaf(A[0],A[3]),me=Math.min(F.min,U.min,V.min,$.min),xe=Math.max(F.max,U.max,V.max,$.max),Ee=X&&Q&&de&&ae;E.maximums.push(xe),E.minimums.push(me),E.leaves.push(xe-me<=5&&Ee?1:0)}f.push(E)}return f})(this.dem),s=i.length-1,a=i[s];this._addNode(a.minimums[0],a.maximums[0],a.leaves[0]),this._construct(i,0,0,s,0)}raycastRoot(e,i,s,a,u,h,f=1){return i2([e,i,-100],[s,a,this.maximums[0]*f],u,h)}raycast(e,i,s,a,u,h,f=1){if(!this.nodeCount)return null;const g=this.raycastRoot(e,i,s,a,u,h,f);if(g==null)return null;const x=[],T=[],E=[],A=[],P=[{idx:0,t:g,nodex:0,nodey:0,depth:0}];for(;P.length>0;){const{idx:L,t:F,nodex:U,nodey:V,depth:$}=P.pop();if(this.leaves[L]){o2(U,V,$,e,i,s,a,E,A);const Q=1<<$,de=(U+0)/Q,ae=(U+1)/Q,me=(V+0)/Q,xe=(V+1)/Q,Ee=zc(de,me,this.dem)*f,Ge=zc(ae,me,this.dem)*f,Me=zc(ae,xe,this.dem)*f,$e=zc(de,xe,this.dem)*f,Ke=r2(E[0],E[1],Ee,A[0],E[1],Ge,A[0],A[1],Me,u,h),Qe=r2(A[0],A[1],Me,E[0],A[1],$e,E[0],E[1],Ee,u,h),at=Math.min(Ke!==null?Ke:Number.MAX_VALUE,Qe!==null?Qe:Number.MAX_VALUE);if(at!==Number.MAX_VALUE)return at;{const ct=qn([],u,h,F);if(a2(Ee,Ge,$e,Me,n2(ct[0],E[0],A[0]),n2(ct[1],E[1],A[1]))>=ct[2])return F}continue}let X=0;for(let Q=0;Q<this._siblingOffset.length;Q++){o2((U<<1)+this._siblingOffset[Q][0],(V<<1)+this._siblingOffset[Q][1],$+1,e,i,s,a,E,A),E[2]=-100,A[2]=this.maximums[this.childOffsets[L]+Q]*f;const de=i2(E,A,u,h);if(de!=null){const ae=de;x[Q]=ae;let me=!1;for(let xe=0;xe<X&&!me;xe++)ae>=x[T[xe]]&&(T.splice(xe,0,Q),me=!0);me||(T[X]=Q),X++}}for(let Q=0;Q<X;Q++){const de=T[Q];P.push({idx:this.childOffsets[L]+de,t:x[de],nodex:(U<<1)+this._siblingOffset[de][0],nodey:(V<<1)+this._siblingOffset[de][1],depth:$+1})}}return null}_addNode(e,i,s){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,s,a,u){if(e[a].isLeaf(i,s)===1)return;this.childOffsets[u]||(this.childOffsets[u]=this.nodeCount);const h=a-1,f=e[h];let g=0,x=0;for(let T=0;T<this._siblingOffset.length;T++){const E=2*i+this._siblingOffset[T][0],A=2*s+this._siblingOffset[T][1],P=f.getElevation(E,A),L=f.isLeaf(E,A),F=this._addNode(P.min,P.max,L);L&&(g|=1<<T),x||(x=F)}for(let T=0;T<this._siblingOffset.length;T++)g&1<<T||this._construct(e,2*i+this._siblingOffset[T][0],2*s+this._siblingOffset[T][1],h,x+T)}}function a2(r,e,i,s,a,u){return ei(ei(r,i,u),ei(e,s,u),a)}function zc(r,e,i){const s=i.dim,a=j(r*s-.5,0,s-1),u=j(e*s-.5,0,s-1),h=Math.floor(a),f=Math.floor(u),g=Math.min(h+1,s-1),x=Math.min(f+1,s-1);return a2(i.get(h,f),i.get(g,f),i.get(h,x),i.get(g,x),a-h,u-f)}const V3={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function U3(r,e,i){return(256*r*256+256*e+i)/10-1e4}function j3(r,e,i){return 256*r+e+i/256-32768}class _g{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,s,a=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(s&&s!=="mapbox"&&s!=="terrarium")return void It(`"${s}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const u=this.dim=i.height-2,h=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=a,this._modifiedForSources={},!a){for(let g=0;g<u;g++)h[this._idx(-1,g)]=h[this._idx(0,g)],h[this._idx(u,g)]=h[this._idx(u-1,g)],h[this._idx(g,-1)]=h[this._idx(g,0)],h[this._idx(g,u)]=h[this._idx(g,u-1)];h[this._idx(-1,-1)]=h[this._idx(0,0)],h[this._idx(u,-1)]=h[this._idx(u-1,0)],h[this._idx(-1,u)]=h[this._idx(0,u-1)],h[this._idx(u,u)]=h[this._idx(u-1,u-1)]}const f=s==="terrarium"?j3:U3;for(let g=0;g<h.length;++g){const x=4*g;this.floatView[g]=f(this.pixels[x],this.pixels[x+1],this.pixels[x+2])}this._timestamp=Dn.now()}_buildQuadTree(){this._tree=new s2(this)}get(e,i,s=!1){s&&(e=j(e,-1,this.dim),i=j(i,-1,this.dim));const a=this._idx(e,i);return this.floatView[a]}set(e,i,s){const a=this._idx(e,i),u=this.floatView[a];return this.floatView[a]=s,s-u}static getUnpackVector(e){return V3[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const s=[0,0,0,0],a=_g.getUnpackVector(i);let u=Math.floor((e+a[3])/a[2]);return s[2]=u%256,u=Math.floor(u/256),s[1]=u%256,u=Math.floor(u/256),s[0]=u,s}getPixels(){return new t1({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let a=i*this.dim,u=i*this.dim+this.dim,h=s*this.dim,f=s*this.dim+this.dim;switch(i){case-1:a=u-1;break;case 1:u=a+1}switch(s){case-1:h=f-1;break;case 1:f=h+1}const g=-i*this.dim,x=-s*this.dim;for(let T=h;T<f;T++)for(let E=a;E<u;E++){const A=4*this._idx(E,T),P=4*this._idx(E+g,T+x);this.pixels[A+0]=e.pixels[P+0],this.pixels[A+1]=e.pixels[P+1],this.pixels[A+2]=e.pixels[P+2],this.pixels[A+3]=e.pixels[P+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function G3(r,e,i){r===1?e.headerLength=i.readFixed32():r===2?e.x=i.readVarint():r===3?e.y=i.readVarint():r===4?e.z=i.readVarint():r===5&&e.layers.push((function(s,a){return s.readFields(W3,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},a)})(i,i.readVarint()+i.pos))}function q3(r,e,i){r===1?(e.delta_filter=(function(s,a){return s.readFields(H3,{blockSize:0},a)})(i,i.readVarint()+i.pos),e.filter="delta_filter"):r===2?(i.readVarint(),e.filter="zigzag_filter"):r===3?(i.readVarint(),e.filter="bitshuffle_filter"):r===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function H3(r,e,i){r===1&&(e.blockSize=i.readVarint())}function Z3(r,e,i){r===1?(i.readVarint(),e.codec="gzip_data"):r===2?(i.readVarint(),e.codec="jpeg_image"):r===3?(i.readVarint(),e.codec="webp_image"):r===4&&(i.readVarint(),e.codec="png_image")}function $3(r,e,i){let s=0,a=0;r===1?e.firstByte=i.readFixed64():r===2?e.lastByte=i.readFixed64():r===3?e.filters.push((function(u,h){return u.readFields(q3,{},h)})(i,i.readVarint()+i.pos)):r===4?e.codec=(function(u,h){return u.readFields(Z3,{},h)})(i,i.readVarint()+i.pos):r===5?a=i.readFloat():r===6?s=i.readFloat():r===7?e.bands.push(i.readString()):r===8?e.offset=i.readDouble():r===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=a),e.scale===0&&(e.scale=s)}function W3(r,e,i){r===1?e.version=i.readVarint():r===2?e.name=i.readString():r===3?e.units=i.readString():r===4?e.tileSize=i.readVarint():r===5?e.buffer=i.readVarint():r===6?e.pixelFormat=i.readVarint():r===7&&e.dataIndex.push((function(s,a){return s.readFields($3,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},a)})(i,i.readVarint()+i.pos))}function X3(r,e,i){if(r===2)(function(s,a,u){s.readFields(Y3,u,a)})(i,i.readVarint()+i.pos,e);else if(r===3)throw new Error("Not implemented")}function Y3(r,e,i){if(r===1){let s=0;const a=i.readVarint()+i.pos;for(;i.pos<a;)e[s++]=i.readVarint()}}function J3(r,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let s=2;s>=1;s--){const a=s===1?1:0,u=s===2?1:0;for(let h=0;h<e[0];h++){const f=e[1]*h;for(let g=a;g<e[1];g++){const x=e[2]*(g+f);for(let T=u;T<e[2];T++){const E=e[3]*(T+x);for(let A=0;A<e[3];A++){const P=E+A;r[P]+=r[P-i]}}}}i*=e[s]}return r}function K3(r){for(let e=0,i=r.length;e<i;e++)r[e]=r[e]>>>1^-(1&r[e]);return r}function Q3(r,e){switch(e){case"uint32":return r;case"uint16":for(let i=0;i<r.length;i+=2){const s=r[i],a=r[i+1];r[i]=(240&s)>>4|(61440&s)>>8|(240&a)<<4|61440&a,r[i+1]=15&s|(3840&s)>>4|(15&a)<<8|(3840&a)<<4}return r;case"uint8":for(let i=0;i<r.length;i+=4){const s=r[i],a=r[i+1],u=r[i+2],h=r[i+3];r[i+0]=(192&s)>>6|(192&a)>>4|(192&u)>>2|192&h,r[i+1]=(48&s)>>4|(48&a)>>2|48&u|(48&h)<<2,r[i+2]=(12&s)>>2|12&a|(12&u)<<2|(12&h)<<4,r[i+3]=3&s|(3&a)<<2|(3&u)<<4|(3&h)<<6}return r;default:throw new Error(`Invalid pixel format, "${e}"`)}}Lt(_g,"DEMData"),Lt(s2,"DemMinMaxQuadTree",{omit:["dem"]});var Ps=Uint8Array,Zp=Uint16Array,eC=Int32Array,l2=new Ps([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),c2=new Ps([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),tC=new Ps([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),u2=function(r,e){for(var i=new Zp(31),s=0;s<31;++s)i[s]=e+=1<<r[s-1];var a=new eC(i[30]);for(s=1;s<30;++s)for(var u=i[s];u<i[s+1];++u)a[u]=u-i[s]<<5|s;return{b:i,r:a}},h2=u2(l2,2),d2=h2.b,iC=h2.r;d2[28]=258,iC[258]=28;for(var rC=u2(c2,0).b,f2=new Zp(32768),Mn=0;Mn<32768;++Mn){var Bd=(43690&Mn)>>1|(21845&Mn)<<1;f2[Mn]=((65280&(Bd=(61680&(Bd=(52428&Bd)>>2|(13107&Bd)<<2))>>4|(3855&Bd)<<4))>>8|(255&Bd)<<8)>>1}var $p=function(r,e,i){for(var s=r.length,a=0,u=new Zp(e);a<s;++a)r[a]&&++u[r[a]-1];var h,f=new Zp(e);for(a=1;a<e;++a)f[a]=f[a-1]+u[a-1]<<1;h=new Zp(1<<e);var g=15-e;for(a=0;a<s;++a)if(r[a])for(var x=a<<4|r[a],T=e-r[a],E=f[r[a]-1]++<<T,A=E|(1<<T)-1;E<=A;++E)h[f2[E]>>g]=x;return h},Wp=new Ps(288);for(Mn=0;Mn<144;++Mn)Wp[Mn]=8;for(Mn=144;Mn<256;++Mn)Wp[Mn]=9;for(Mn=256;Mn<280;++Mn)Wp[Mn]=7;for(Mn=280;Mn<288;++Mn)Wp[Mn]=8;var p2=new Ps(32);for(Mn=0;Mn<32;++Mn)p2[Mn]=5;var nC=$p(Wp,9),oC=$p(p2,5),Kv=function(r){for(var e=r[0],i=1;i<r.length;++i)r[i]>e&&(e=r[i]);return e},Ra=function(r,e,i){var s=e/8|0;return(r[s]|r[s+1]<<8)>>(7&e)&i},Qv=function(r,e){var i=e/8|0;return(r[i]|r[i+1]<<8|r[i+2]<<16)>>(7&e)},sC=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Da=function(r,e,i){var s=new Error(e||sC[r]);if(s.code=r,Error.captureStackTrace&&Error.captureStackTrace(s,Da),!i)throw s;return s},aC=new Ps(0),lC=typeof TextDecoder<"u"&&new TextDecoder;try{lC.decode(aC,{stream:!0})}catch{}const cC={gzip_data:"gzip"};class ta extends Error{constructor(e){super(e),this.name="MRTError"}}const uC={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},m2={uint32:1,uint16:2,uint8:4},hC={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let e0;class gg{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new ta(`Layer '${e}' not found`);return i}getHeaderLength(e){const i=new Uint8Array(e),s=new DataView(e);if(i[0]!==13)throw new ta("File is not a valid MRT.");return s.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),s=this.getHeaderLength(e);if(i.length<s)throw new ta(`Expected header with length >= ${s} but got buffer of length ${i.length}`);const a=new e0(i.subarray(0,s)).readFields(G3,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==a.x||this.y!==a.y||this.z!==a.z))throw new ta(`Invalid attempt to parse header ${a.z}/${a.x}/${a.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=a.x,this.y=a.y,this.z=a.z;for(const u of a.layers)this.layers[u.name]=new _2(u,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],s=this.getLayer(e.layerName);for(let a of e.blockIndices){const u=s.dataIndex[a],h=u.firstByte-e.firstByte,f=u.lastByte-e.firstByte;if(s._blocksInProgress.has(a))continue;const g={layerName:s.name,firstByte:h,lastByte:f,pixelFormat:s.pixelFormat,blockIndex:a,blockShape:[u.bands.length].concat(s.bandShape),buffer:s.buffer,codec:u.codec.codec,filters:u.filters.map((x=>x.filter))};s._blocksInProgress.add(a),i.push(g)}return new g2(i,(()=>{i.forEach((a=>s._blocksInProgress.delete(a.blockIndex)))}),((a,u)=>{if(i.forEach((h=>s._blocksInProgress.delete(h.blockIndex))),a)throw a;u.forEach((h=>{this.getLayer(h.layerName).processDecodedData(h)}))}))}}class _2{constructor({version:e,name:i,units:s,tileSize:a,pixelFormat:u,buffer:h,dataIndex:f},g){if(this.version=e,this.version!==1)throw new ta(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=s,this.tileSize=a,this.buffer=h,this.pixelFormat=uC[u],this.dataIndex=f,this.bandShape=[a+2*h,a+2*h,m2[this.pixelFormat]],this._decodedBlocks=new mg(g?g.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return m2[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map((({bands:e})=>e)).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[s,a]of this.dataIndex.entries()){for(const[u,h]of a.bands.entries())if(h===e)return{bandIndex:i+u,blockIndex:s,blockBandIndex:u};i+=a.bands.length}break;case"number":for(const[s,a]of this.dataIndex.entries()){if(e>=i&&e<i+a.bands.length)return{bandIndex:e,blockIndex:s,blockBandIndex:e-i};i+=a.bands.length}break;default:throw new ta(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let i=1/0,s=-1/0;const a=[],u=new Set;for(const h of e){const{blockIndex:f}=this.getBlockForBand(h);if(f<0)throw new ta(`Invalid band: ${JSON.stringify(h)}`);const g=this.dataIndex[f];a.includes(f)||a.push(f),u.add(f),i=Math.min(i,g.firstByte),s=Math.max(s,g.lastByte)}if(u.size>this.cacheSize)throw new ta(`Number of blocks to decode (${u.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:s,blockIndices:a}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:s}=this.getBlockForBand(e);if(i<0)throw new ta(`Band not found: ${JSON.stringify(e)}`);const a=this._decodedBlocks.get(i.toString());if(!a)throw new ta(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const u=this.dataIndex[i],h=this.bandShape.reduce(((x,T)=>x*T),1),f=s*h,g=a.subarray(f,f+h);return{data:g,bytes:new Uint8Array(g.buffer).subarray(g.byteOffset,g.byteOffset+g.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:u.offset,scale:u.scale}}}gg.setPbf=function(r){e0=r};class g2{constructor(e,i,s){this.tasks=e,this._onCancel=i,this._onComplete=s,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}gg.performDecoding=function(r,e){const i=new Uint8Array(r);return Promise.all(e.tasks.map((s=>{const{layerName:a,firstByte:u,lastByte:h,pixelFormat:f,blockShape:g,blockIndex:x,filters:T,codec:E}=s,A=i.subarray(u,h+1),P=new Uint32Array(g[0]*g[1]*g[2]);let L;if(E!=="gzip_data")throw new ta(`Unhandled codec: ${E}`);return L=(function(F,U){if(!globalThis.DecompressionStream&&U==="gzip_data")return Promise.resolve(((Q=(function(me){me[0]==31&&me[1]==139&&me[2]==8||Da(6,"invalid gzip data");var xe=me[3],Ee=10;4&xe&&(Ee+=2+(me[10]|me[11]<<8));for(var Ge=(xe>>3&1)+(xe>>4&1);Ge>0;Ge-=!me[Ee++]);return Ee+(2&xe)})(X=F))+8>X.length&&Da(6,"invalid gzip data"),(function(me,xe,Ee,Ge){var Me=me.length;if(!Me||xe.f&&!xe.l)return Ee||new Ps(0);var $e=!Ee,Ke=$e||xe.i!=2,Qe=xe.i;$e&&(Ee=new Ps(3*Me));var at,ct,tt=function(mr){var tr=Ee.length;if(mr>tr){var sr=new Ps(Math.max(2*tr,mr));sr.set(Ee),Ee=sr}},rt=xe.f||0,Ze=xe.p||0,qe=xe.b||0,ot=xe.l,yt=xe.d,ft=xe.m,Nt=xe.n,Et=8*Me;do{if(!ot){rt=Ra(me,Ze,1);var Ct=Ra(me,Ze+1,3);if(Ze+=3,!Ct){var Ot=me[(We=4+((Ze+7)/8|0))-4]|me[We-3]<<8,Ii=We+Ot;if(Ii>Me){Qe&&Da(0);break}Ke&&tt(qe+Ot),Ee.set(me.subarray(We,Ii),qe),xe.b=qe+=Ot,xe.p=Ze=8*Ii,xe.f=rt;continue}if(Ct==1)ot=nC,yt=oC,ft=9,Nt=5;else if(Ct==2){var pt=Ra(me,Ze,31)+257,zt=Ra(me,Ze+10,15)+4,oi=pt+Ra(me,Ze+5,31)+1;Ze+=14;for(var Oi=new Ps(oi),Ni=new Ps(19),pi=0;pi<zt;++pi)Ni[tC[pi]]=Ra(me,Ze+3*pi,7);Ze+=3*zt;var pr=Kv(Ni),le=(1<<pr)-1,fe=$p(Ni,pr);for(pi=0;pi<oi;){var We,lt=fe[Ra(me,Ze,le)];if(Ze+=15&lt,(We=lt>>4)<16)Oi[pi++]=We;else{var bt=0,wt=0;for(We==16?(wt=3+Ra(me,Ze,3),Ze+=2,bt=Oi[pi-1]):We==17?(wt=3+Ra(me,Ze,7),Ze+=3):We==18&&(wt=11+Ra(me,Ze,127),Ze+=7);wt--;)Oi[pi++]=bt}}var Vt=Oi.subarray(0,pt),qt=Oi.subarray(pt);ft=Kv(Vt),Nt=Kv(qt),ot=$p(Vt,ft),yt=$p(qt,Nt)}else Da(1);if(Ze>Et){Qe&&Da(0);break}}Ke&&tt(qe+131072);for(var hi=(1<<ft)-1,bi=(1<<Nt)-1,Ei=Ze;;Ei=Ze){var Mi=(bt=ot[Qv(me,Ze)&hi])>>4;if((Ze+=15&bt)>Et){Qe&&Da(0);break}if(bt||Da(2),Mi<256)Ee[qe++]=Mi;else{if(Mi==256){Ei=Ze,ot=null;break}var Qt=Mi-254;Mi>264&&(Qt=Ra(me,Ze,(1<<(Ki=l2[pi=Mi-257]))-1)+d2[pi],Ze+=Ki);var ni=yt[Qv(me,Ze)&bi],Hi=ni>>4;if(ni||Da(3),Ze+=15&ni,qt=rC[Hi],Hi>3){var Ki=c2[Hi];qt+=Qv(me,Ze)&(1<<Ki)-1,Ze+=Ki}if(Ze>Et){Qe&&Da(0);break}Ke&&tt(qe+131072);var Qi=qe+Qt;if(qe<qt){var ur=0-qt,br=Math.min(qt,Qi);for(ur+qe<0&&Da(3);qe<br;++qe)Ee[qe]=(void 0)[ur+qe]}for(;qe<Qi;++qe)Ee[qe]=Ee[qe-qt]}}xe.l=ot,xe.p=Ei,xe.b=qe,xe.f=rt,ot&&(rt=1,xe.m=ft,xe.d=yt,xe.n=Nt)}while(!rt);return qe!=Ee.length&&$e?(at=Ee,((ct=qe)==null||ct>at.length)&&(ct=at.length),new Ps(at.subarray(0,ct))):Ee.subarray(0,qe)})(X.subarray(Q,-8),{i:2},new Ps(((V=X)[($=V.length)-4]|V[$-3]<<8|V[$-2]<<16|V[$-1]<<24)>>>0))));var V,$,X,Q;const de=cC[U];if(!de)throw new Error(`Unhandled codec: ${U}`);const ae=new globalThis.DecompressionStream(de);return new Response(new Blob([F]).stream().pipeThrough(ae)).arrayBuffer().then((me=>new Uint8Array(me)))})(A,E).then((F=>((function(U,V){U.readFields(X3,V)})(new e0(F),P),new hC[f](P.buffer)))),L.then((F=>{for(let U=T.length-1;U>=0;U--)switch(T[U]){case"delta_filter":J3(F,g);break;case"zigzag_filter":K3(F);break;case"bitshuffle_filter":Q3(F,f);break;default:throw new ta(`Unhandled filter "${T[U]}"`)}return{layerName:a,blockIndex:x,data:F}})).catch((F=>{throw F}))})))},Lt(g2,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Lt(gg,"MapboxRasterTile"),Lt(_2,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class y2{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const s=e[i];this._stringToNumber[s]=i,this._numberToString[i]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}class v2{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new vc(gt,16,0),this.featureIndexArray=new rp,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,s,a,u,h=0,f=0){const g=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,a,u,h);const x=this.grid;for(let T=0;T<i.length;T++){const E=i[T],A=[1/0,1/0,-1/0,-1/0];for(let P=0;P<E.length;P++){const L=E[P];A[0]=Math.min(A[0],L.x),A[1]=Math.min(A[1],L.y),A[2]=Math.max(A[2],L.x),A[3]=Math.max(A[3],L.y)}f!==0&&(A[0]-=f,A[1]-=f,A[2]+=f,A[3]+=f),A[0]<gt&&A[1]<gt&&A[2]>=0&&A[3]>=0&&x.insert(g,A[0],A[1],A[2],A[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new ke(new $_(this.rawTileData)).layers,this.sourceLayerCoder=new y2(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:s,transform:a,tileTransform:u,pixelPosMatrix:h,availableImages:f,worldview:g}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const x=i.queryRadius?i.queryRadius:0,T=s.bufferedTilespaceBounds,E=this.grid.query(T.min.x,T.min.y,T.max.x,T.max.y,((F,U,V,$)=>mo(s.bufferedTilespaceGeometry,F-x,U-x,V+x,$+x)));E.sort(dC);let A=null;a.elevation&&E.length>0&&(A=zd.create(a.elevation,this.tileID));const P={};let L;for(let F=0;F<E.length;F++){const U=E[F];if(U===L)continue;L=U;const V=this.featureIndexArray.get(U);let $=null;this.is3DTile?this.loadMatchingModelFeature(P,V,e,s,a,g):this.loadMatchingFeature(P,V,e,f,g,((X,Q,de,ae=0)=>($||($=ye(X,this.tileID.canonical,u)),Q.queryIntersectsFeature(s,X,de,$,this.z,a,h,A,ae))))}return P}loadMatchingFeature(e,i,s,a,u,h){const{featureIndex:f,bucketIndex:g,sourceLayerIndex:x,layoutVertexArrayOffset:T}=i,E=this.bucketLayerIDs[g],A=s.layers,P=Object.keys(A);if(P.length&&!Mt(P,E))return;const L=s.sourceCache,F=this.sourceLayerCoder.decode(x),U=this.vtLayers[F].feature(f),V=this.getId(U,F);for(let $=0;$<E.length;$++){const X=E[$];if(!A[X])continue;const{styleLayer:Q,targets:de}=A[X];let ae={};V!==void 0&&(ae=L.getFeatureState(Q.sourceLayer,V));const me=!h||h(U,Q,ae,T);if(!me)continue;const xe=new qu(U,this.z,this.x,this.y,V);xe.tile=this.tileID.canonical,xe.state=ae;let Ee=this.serializedLayersCache.get(X);Ee||(Ee=Q.serialize(),Ee.id=X,this.serializedLayersCache.set(X,Ee)),xe.source=Ee.source,xe.sourceLayer=Ee["source-layer"],xe.layer=Object.assign({},Ee),xe.layer.paint=x2(Ee.paint,Q.paint,U,ae,a),xe.layer.layout=x2(Ee.layout,Q.layout,U,ae,a);let Ge=!1;for(const Me of de){this.updateFeatureProperties(xe,Me);const{filter:$e}=Me;if($e){if(U.properties=xe.properties,$e.needGeometry){const Ke=Ce(U,!0);if(!$e.filter(new Ar(this.tileID.overscaledZ,{worldview:u}),Ke,this.tileID.canonical))continue}else if(!$e.filter(new Ar(this.tileID.overscaledZ,{worldview:u}),U))continue}Ge=!0,Me.targetId&&this.addFeatureVariant(xe,Me)}Ge&&this.appendToResult(e,X,f,xe,me)}}loadMatchingModelFeature(e,i,s,a,u,h){const{featureIndex:f,bucketIndex:g}=i,x=this.bucketLayerIDs[g],T=s.layers,E=Object.keys(T);if(!E.length||Mt(E,x))for(let A=0;A<x.length;A++){const P=x[A],{styleLayer:L,targets:F}=T[P];if(L.type!=="model")continue;const U=a.tile,V=U.getBucket(L);if(!(V&&V instanceof ug))continue;const $=v3(V,f,a,u);if(!$)continue;const{z:X,x:Q,y:de}=U.tileID.canonical,{feature:ae,intersectionZ:me,position:xe}=$;let Ee={};ae.id!==void 0&&(Ee=s.sourceCache.getFeatureState(L.sourceLayer,ae.id));const Ge=new qu({},X,Q,de,ae.id);Ge.tile=this.tileID.canonical,Ge.state=Ee,Ge.properties=ae.properties,Ge.geometry={type:"Point",coordinates:[xe.lng,xe.lat]};let Me=this.serializedLayersCache.get(P);Me||(Me=L.serialize(),Me.id=P,this.serializedLayersCache.set(P,Me)),Ge.source=Me.source,Ge.sourceLayer=Me["source-layer"],Ge.layer=Object.assign({},Me);let $e=!1;for(const Ke of F){this.updateFeatureProperties(Ge,Ke);const{filter:Qe}=Ke;if(Qe){if(ae.properties=Ge.properties,Qe.needGeometry){if(!Qe.filter(new Ar(this.tileID.overscaledZ,{worldview:h}),ae,this.tileID.canonical))continue}else if(!Qe.filter(new Ar(this.tileID.overscaledZ,{worldview:h}),ae))continue}$e=!0,Ke.targetId&&this.addFeatureVariant(Ge,Ke)}$e&&this.appendToResult(e,P,f,Ge,me)}}updateFeatureProperties(e,i,s){if(i.properties){const a={};for(const u in i.properties){const h=i.properties[u].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,s);h!=null&&(a[u]=h)}e.properties=a}}addFeatureVariant(e,i,s){const a={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(a.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(a)}appendToResult(e,i,s,a,u){let h=e[i];h===void 0&&(h=e[i]=[]),h.push({featureIndex:s,feature:a,intersectionZ:u})}lookupSymbolFeatures(e,i,s,a,u,h){const f={};this.loadVTLayers();for(const g of e)this.loadMatchingFeature(f,{bucketIndex:i,sourceLayerIndex:s,featureIndex:g,layoutVertexArrayOffset:0},a,u,h);return f}loadFeature(e){const{featureIndex:i,sourceLayerIndex:s}=e;this.loadVTLayers();const a=this.sourceLayerCoder.decode(s),u=this.vtFeatures[a];if(u[i])return u[i];const h=this.vtLayers[a].feature(i);return u[i]=h,h}hasLayer(e){for(const i of this.bucketLayerIDs)for(const s of i)if(e===s)return!0;return!1}getId(e,i){let s=e.id;if(this.promoteId){const a=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(a!=null)if(Array.isArray(a)){if(!this.promoteIdExpression){const u=il(a);if(u.result!=="success"){const h=u.value.map((f=>`${f.key}: ${f.message}`)).join(", ");return void It(`Failed to create expression for promoteId: ${h}`)}this.promoteIdExpression=u.value}s=this.promoteIdExpression.evaluate({zoom:0},e)}else s=e.properties[a];typeof s=="boolean"&&(s=Number(s))}return s}}function x2(r,e,i,s,a){return Ne(r,((u,h)=>{const f=e instanceof Vl?e.get(h):null;return f&&f.evaluate?f.evaluate(i,s,void 0,a):f}))}function dC(r,e){return e-r}Lt(v2,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const b2=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class t0{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,s]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const a=s>>4;if(a!==1)throw new Error(`Got v${a} data when expected v1.`);const u=b2[15&s];if(!u)throw new Error("Unrecognized array type.");const[h]=new Uint16Array(e,2,1),[f]=new Uint32Array(e,4,1);return new t0(f,h,u,e)}constructor(e,i=64,s=Float64Array,a){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const u=b2.indexOf(this.ArrayType),h=2*e*this.ArrayType.BYTES_PER_ELEMENT,f=e*this.IndexArrayType.BYTES_PER_ELEMENT,g=(8-f%8)%8;if(u<0)throw new Error(`Unexpected typed array class: ${s}.`);a&&a instanceof ArrayBuffer?(this.data=a,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+g,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+h+f+g),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+g,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+u]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=i,s}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return i0(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,s,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:u,coords:h,nodeSize:f}=this,g=[0,u.length-1,0],x=[];for(;g.length;){const T=g.pop()||0,E=g.pop()||0,A=g.pop()||0;if(E-A<=f){for(let U=A;U<=E;U++){const V=h[2*U],$=h[2*U+1];V>=e&&V<=s&&$>=i&&$<=a&&x.push(u[U])}continue}const P=A+E>>1,L=h[2*P],F=h[2*P+1];L>=e&&L<=s&&F>=i&&F<=a&&x.push(u[P]),(T===0?e<=L:i<=F)&&(g.push(A),g.push(P-1),g.push(1-T)),(T===0?s>=L:a>=F)&&(g.push(P+1),g.push(E),g.push(1-T))}return x}within(e,i,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:u,nodeSize:h}=this,f=[0,a.length-1,0],g=[],x=s*s;for(;f.length;){const T=f.pop()||0,E=f.pop()||0,A=f.pop()||0;if(E-A<=h){for(let U=A;U<=E;U++)T2(u[2*U],u[2*U+1],e,i)<=x&&g.push(a[U]);continue}const P=A+E>>1,L=u[2*P],F=u[2*P+1];T2(L,F,e,i)<=x&&g.push(a[P]),(T===0?e-s<=L:i-s<=F)&&(f.push(A),f.push(P-1),f.push(1-T)),(T===0?e+s>=L:i+s>=F)&&(f.push(P+1),f.push(E),f.push(1-T))}return g}}function i0(r,e,i,s,a,u){if(a-s<=i)return;const h=s+a>>1;w2(r,e,h,s,a,u),i0(r,e,i,s,h-1,1-u),i0(r,e,i,h+1,a,1-u)}function w2(r,e,i,s,a,u){for(;a>s;){if(a-s>600){const x=a-s+1,T=i-s+1,E=Math.log(x),A=.5*Math.exp(2*E/3),P=.5*Math.sqrt(E*A*(x-A)/x)*(T-x/2<0?-1:1);w2(r,e,i,Math.max(s,Math.floor(i-T*A/x+P)),Math.min(a,Math.floor(i+(x-T)*A/x+P)),u)}const h=e[2*i+u];let f=s,g=a;for(Xp(r,e,s,i),e[2*a+u]>h&&Xp(r,e,s,a);f<g;){for(Xp(r,e,f,g),f++,g--;e[2*f+u]<h;)f++;for(;e[2*g+u]>h;)g--}e[2*s+u]===h?Xp(r,e,s,g):(g++,Xp(r,e,g,a)),g<=i&&(s=g+1),i<=g&&(a=g-1)}}function Xp(r,e,i,s){r0(r,i,s),r0(e,2*i,2*s),r0(e,2*i+1,2*s+1)}function r0(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}function T2(r,e,i,s){const a=r-i,u=e-s;return a*a+u*u}o.$=mh,o.A=fa,o.B=Is,o.C=2,o.D=wd,o.E=Ll,o.F=Pp,o.G=Xb,o.H=ph,o.I=so,o.J=c_,o.K=Bt,o.L=sc,o.M=Nh,o.N=xu,o.O=Ym,o.P=st,o.Q=bu,o.R=Qc,o.S=Xh,o.T=hv,o.U=il,o.V=cg,o.W=Ff,o.X=hc,o.Y=uc,o.Z=pu,o._=ho,o.a=function(r){return Ri.API_CDN_URL_REGEX.test(r)},o.a$=O,o.a0=ri,o.a1=rs,o.a2=Ys,o.a3=class extends cg{},o.a4=Vh,o.a5=Xm,o.a6=Re,o.a7=function(r){const e=r.value;return e?ri(e)?jv(e,!0)?[]:[new cg(r.key,e,`invalid url "${e}"`)]:[new cg(r.key,e,`string expected, "${Bt(e)}" found`)]:[]},o.a8=o_,o.a9=en,o.aA=j,o.aB=Le,o.aC=Jn,o.aD=eo,o.aE=vr,o.aF=v,o.aG=J,o.aH=function(r,e){const i={};for(let s=0;s<e.length;s++){const a=e[s];a in r&&(i[a]=r[a])}return i},o.aI=c,o.aJ=w,o.aK=class{constructor(r){this.entries={},this.scheduler=r}request(r,e,i,s){const a=this.entries[r]=this.entries[r]||{callbacks:[]};if(a.result){const[u,h]=a.result;return this.scheduler?this.scheduler.add((()=>{s(u,h)}),e):s(u,h),()=>{}}return a.callbacks.push(s),a.cancel||(a.cancel=i(((u,h)=>{a.result=[u,h];for(const f of a.callbacks)this.scheduler?this.scheduler.add((()=>{f(u,h)}),e):f(u,h);setTimeout((()=>delete this.entries[r]),3e3)}))),()=>{a.result||(a.callbacks=a.callbacks.filter((u=>u!==s)),a.callbacks.length||(a.cancel(),delete this.entries[r]))}}},o.aL=function(r,e,i){const s=JSON.stringify(r.request);return r.data&&(this.deduped.entries[s]={result:[null,r.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},(a=>{const u=da(r.request,((h,f,g)=>{h?a(h):f&&a(null,{rawData:f,vectorTile:i?void 0:new ke(new $_(f)),responseHeaders:new Map(g.entries())})}));return()=>{u.cancel(),a()}}),e)},o.aM=function(r){return r?{cacheControl:r.get("Cache-Control"),expires:r.get("Expires")}:{cacheControl:void 0,expires:void 0}},o.aN=Po,o.aO=function(r){is++,is>nh&&(r.getActor().send("enforceCacheSizeLimit",rh),is=0)},o.aP=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log2(r)))},o.aQ=Wr,o.aR=Ew,o.aS=Pw,o.aT=n,o.aU=Tw,o.aV=function(r,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let s=0;s<r.length;s++){const a=document.createElement("source");oy(r[s])||(i.crossOrigin="Anonymous"),a.src=r[s],i.appendChild(a)}return{cancel:()=>{}}},o.aW=Sp,o.aX=Hu,o.aY=Pe,o.aZ=Op,o.a_=C,o.aa=mt,o.ab=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return fi(r.expression.evaluate(e))}interpolate(r,e,i){return{x:ei(r.x,e.x,i),y:ei(r.y,e.y,i),z:ei(r.z,e.z,i),azimuthal:ei(r.azimuthal,e.azimuthal,i),polar:ei(r.polar,e.polar,i)}}},o.ac=Ar,o.ad=Fl,o.ae=Y,o.af=kr,o.ag=rr,o.ah=W,o.ai=Vl,o.aj=Pc,o.ak=ei,o.al=gt,o.am=sf,o.an=Yi,o.ao=lr,o.ap=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return(function([i,s]){const a=fi([1,i,s]);return{x:a.x,y:a.y,z:a.z}})(r.expression.evaluate(e))}interpolate(r,e,i){return{x:ei(r.x,e.x,i),y:ei(r.y,e.y,i),z:ei(r.z,e.z,i)}}},o.aq=function(r,e,i=0,s=!0){const a=new st(i,i),u=r.sub(a),h=e.add(a),f=[u,new st(h.x,u.y),h,new st(u.x,h.y)];return s&&f.push(u.clone()),f},o.ar=function(r,e){const i=[];for(let s=0;s<r.length;s++){const a=ne(s-1,-1,r.length-1),u=ne(s+1,-1,r.length-1),h=r[s],f=r[u],g=r[a].sub(h).unit(),x=f.sub(h).unit(),T=x.angleWithSep(g.x,g.y),E=g.add(x).unit().mult(-1*e/Math.sin(T/2));i.push(h.add(E))}return i},o.as=lw,o.at=mo,o.au=function(r,e,i=0){return Li(((e.x-i)*r.scale-r.x)*gt,(e.y*r.scale-r.y)*gt,D(e.z,e.y))},o.av=Kr,o.aw=ui,o.ax=Dt,o.ay=Tb,o.az=function(r){let e=1/0,i=1/0,s=-1/0,a=-1/0;for(const u of r)e=Math.min(e,u.x),i=Math.min(i,u.y),s=Math.max(s,u.x),a=Math.max(a,u.y);return{min:new st(e,i),max:new st(s,a)}},o.b=function(r){return Ri.API_FONTS_REGEX.test(r)},o.b$=T1,o.b0=xn,o.b1=wc,o.b2=Ie,o.b3=y_,o.b4=og,o.b5=function(){xa.isLoading()||xa.isLoaded()||Su()!=="deferred"||n_()},o.b6=Yh,o.b7=Ce,o.b8=qu,o.b9=Qr,o.bA=K,o.bB=Ye,o.bC=oe,o.bD=function(r,e){const{x:i,y:s}=r.point,a=jx(i,s,r.worldSize/r._pixelsPerMercatorPixel,0,0);return Le(a,a,Vy(Ms(e)))},o.bE=ee,o.bF=Gr,o.bG=ii,o.bH=qn,o.bI=wr,o.bJ=ki,o.bK=Pd,o.bL=Wo,o.bM=Mv,o.bN=function(r,e,i,s,a){const u=5*e+2;r.float32[u+0]=i,r.float32[u+1]=s,r.float32[u+2]=a},o.bO=Od,o.bP=vo,o.bQ=ua,o.bR=Ga,o.bS=eh,o.bT=ne,o.bU=function(r,e,i,s){var a=new Z(4);return a[0]=r,a[1]=e,a[2]=i,a[3]=s,a},o.bV=class{isDataAvailableAtPoint(r){const e=this._source();if(this.isUsingMockSource()||!e||r.y<0||r.y>1)return!1;const i=e.getSource().maxzoom,s=1<<i,a=Math.floor(r.x),u=Math.floor((r.x-a)*s),h=Math.floor(r.y*s),f=this.findDEMTileFor(new Wr(i,a,i,u,h));return!(!f||!f.dem)}getAtPointOrZero(r,e=0){return this.getAtPoint(r,e)||0}getAtPoint(r,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const s=this._source();if(!s||r.y<0||r.y>1)return e;const a=s.getSource().maxzoom,u=1<<a,h=Math.floor(r.x),f=r.x-h,g=new Wr(a,h,a,Math.floor(f*u),Math.floor(r.y*u)),x=this.findDEMTileFor(g);if(!x||!x.dem)return e;const T=x.dem,E=1<<x.tileID.canonical.z,A=(f*E-x.tileID.canonical.x)*T.dim,P=(r.y*E-x.tileID.canonical.y)*T.dim,L=Math.floor(A),F=Math.floor(P);return(i?this.exaggeration():1)*ei(ei(T.get(L,F),T.get(L,F+1),P-F),ei(T.get(L+1,F),T.get(L+1,F+1),P-F),A-L)}static getAtTileOffset(r,e,i,s){const a=1<<r.canonical.z;return s?s.pointElevation(e):i?i.getAtPointOrZero(new Y(r.wrap+(r.canonical.x+e.x/gt)/a,(r.canonical.y+e.y/gt)/a)):0}static getAtTileOffsetFunc(r,e,i,s){return(a,u,h)=>{const f=this.getAtTileOffset(r,a,u,h),g=s.upVector(r.canonical,a.x,a.y);return yr(g,g,f*s.upVectorScale(r.canonical,e,i).metersToTile),g}}getForTilePoints(r,e,i,s){if(this.isUsingMockSource())return!1;const a=zd.create(this,r,s);return!!a&&(e.forEach((u=>{u[2]=this.exaggeration()*a.getElevationAt(u[0],u[1],i)})),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(r);if(!e||!e.dem)return null;const i=e.dem.tree,s=e.tileID,a=1<<r.canonical.z-s.canonical.z;let u=r.canonical.x/a-s.canonical.x,h=r.canonical.y/a-s.canonical.y,f=0;for(let g=0;g<r.canonical.z-s.canonical.z&&!i.leaves[f];g++){u*=2,h*=2;const x=2*Math.floor(h)+Math.floor(u);f=i.childOffsets[f]+x,u%=1,h%=1}return{min:this.exaggeration()*i.minimums[f],max:this.exaggeration()*i.maximums[f]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const r=this.visibleDemTiles;if(r.length===0)return null;let e=!1,i=Number.MAX_VALUE,s=Number.MIN_VALUE;for(const a of r){const u=this.getMinMaxForTile(a.tileID);u&&(i=Math.min(i,u.min),s=Math.max(s,u.max),e=!0)}return e?{min:i,max:s}:null}},o.bW=k_,o.bX=Xi,o.bY=zn,o.bZ=v1,o.b_=Lw,o.ba=xv,o.bb=Yy,o.bc=ye,o.bd=nl,o.be=sl,o.bf=Cc,o.bg=Fr,o.bh=xd,o.bi=Vv,o.bj=function(r,e){const i=Pc(e.zoom);if(i===0)return Ms(r);const s=S_(r),a=Ny(s),u=v(s.getWest())*e.worldSize,h=v(s.getEast())*e.worldSize,f=w(s.getNorth())*e.worldSize,g=w(s.getSouth())*e.worldSize,x=[u,f,0],T=[h,f,0],E=[u,g,0],A=[h,g,0],P=Te([],e.globeMatrix);return kr(x,x,P),kr(T,T,P),kr(E,E,P),kr(A,A,P),a[0]=Ca(a[0],E,i),a[1]=Ca(a[1],A,i),a[2]=Ca(a[2],T,i),a[3]=Ca(a[3],x,i),Ft.fromPoints(a)},o.bk=A_,o.bl=Te,o.bm=cp,o.bn=Ca,o.bo=bc,o.bp=ku,o.bq=it,o.br=Oe,o.bs=gg,o.bt=$_,o.bu=da,o.bv=function(r,e){const i=[];for(const s in r)s in e||i.push(s);return i},o.bw=be,o.bx=["type","source","source-layer","minzoom","maxzoom","filter","layout"],o.by=ha,o.bz=ge,o.c=Wn,o.c$=function(r,e,i){let s=0;for(let a=0;a<2;++a)r[a]>0&&(s+=(r[a]-0)*(r[a]-0)),e[a]<0&&(s+=(0-e[a])*(0-e[a]));return s},o.c0=E1,o.c1=Iv,o.c2=iw,o.c3=Ov,o.c4=t0,o.c5=yr,o.c6=Vo,o.c7=tc,o.c8=function(r,e,i){i*=.5;var s=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g+a*f,r[1]=a*g-s*f,r[2]=u*g+h*f,r[3]=h*g-u*f,r},o.c9=gs,o.cA=Pt,o.cB=er,o.cC=lb,o.cD=xr,o.cE=Nx,o.cF=function(r,e,i,s,a,u,h,f,g){if(g.name==="globe")return Nx(r,e,new xr(i,s,a),!1);const x=Op({z:i,x:s,y:a},g);return new Ft([(u+x.x/x.scale)*e,e*(x.y/x.scale),h],[(u+x.x2/x.scale)*e,e*(x.y2/x.scale),f])},o.cG=function(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r[3]=Math.min(e[3],i[3]),r},o.cH=function(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r[3]=Math.max(e[3],i[3]),r},o.cI=function(r){const e=Math.round((r+45+360)%360/90)%4;return tf[e]},o.cJ=z,o.cK=Ns,o.cL=vd,o.cM=function(r){const e=K(new Float64Array(16));Le(e,r.pixelMatrix,r.globeMatrix);const i=[0,cs,0],s=[0,us,0];return kr(i,i,e),kr(s,s,e),[i[0]>0&&i[0]<=r.width&&i[1]>0&&i[1]<=r.height&&!jy(r,new n(r.center.lat,90)),s[0]>0&&s[0]<=r.width&&s[1]>0&&s[1]<=r.height&&!jy(r,new n(r.center.lat,-90))]},o.cN=function(r,e){const{scale:i}=r.tileTransform,s=i*gt/(r.tileSize*Math.pow(2,e.zoom-r.tileID.overscaledZ+r.tileID.canonical.z));return(function(a,u,h){var f=u[1],g=u[2],x=u[3],T=h[0],E=h[1];return a[0]=u[0]*T,a[1]=f*T,a[2]=g*E,a[3]=x*E,a})(new Float32Array(4),e.inverseAdjustmentMatrix,[s,s])},o.cO=U_,o.cP=Xt,o.cQ=ab,o.cR=function(r){const e=ab(r,!0);return ee([],[e[0],e[1],e[4],e[5]])},o.cS=Ae,o.cT=Tt,o.cU=ze,o.cV=function(r){const{x:e,y:i}=r.point,{lng:s,lat:a}=r._center;return jx(e,i,r.worldSize,s,a)},o.cW=Ln,o.cX=no,o.cY=Nr,o.cZ=Xn,o.c_=ls,o.ca=nn,o.cb=function(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=e[3],r},o.cc=li,o.cd=function(r,e,i,s,a){var u=1/Math.tan(e/2);if(r[0]=u/i,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=u,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,a!=null&&a!==1/0){var h=1/(s-a);r[10]=(a+s)*h,r[14]=2*a*s*h}else r[10]=-1,r[14]=-2*s;return r},o.ce=function(r,e,i,s,a,u,h){var f=1/(e-i),g=1/(s-a),x=1/(u-h);return r[0]=-2*f,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*g,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*x,r[11]=0,r[12]=(e+i)*f,r[13]=(a+s)*g,r[14]=(h+u)*x,r[15]=1,r},o.cf=I,o.cg=function(r,e,i){r[4*e+0]=i[0],r[4*e+1]=i[1],r[4*e+2]=i[2],r[4*e+3]=i[3]},o.ch=md,o.ci=Pu,o.cj=bn,o.ck=Qs,o.cl=Ru,o.cm=fw,o.cn=function(){var r=new Z(4);return Z!=Float32Array&&(r[1]=0,r[2]=0),r[0]=1,r[3]=1,r},o.co=function(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g+u*f,r[1]=a*g+h*f,r[2]=s*-f+u*g,r[3]=a*-f+h*g,r},o.cp=function(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]},o.cq=Jr,o.cr=function(r){var e=r[0],i=r[1],s=r[2],a=r[3];return Math.sqrt(e*e+i*i+s*s+a*a)},o.cs=bl,o.ct=yo,o.cu=dn,o.cv=3,o.cw=2,o.cx=7,o.cy=6,o.cz=Hn,o.d=function(r){return Ri.API_TILEJSON_REGEX.test(r)},o.d$=class{constructor(r,e,i,s){this.context=r,this.format=s,this.size=i,this.texture=r.gl.createTexture();const[a,u,h]=this.size,{gl:f}=r;f.bindTexture(f.TEXTURE_3D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in e&&e.data&&f.texImage3D(f.TEXTURE_3D,0,this.format,a,u,h,0,cv(this.format),uv(this.format),e.data)}bind(r,e){const{context:i}=this,{gl:s}=i;s.bindTexture(s.TEXTURE_3D,this.texture),r!==this.minFilter&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MAG_FILTER,r),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MIN_FILTER,r),this.minFilter=r),e!==this.wrapS&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_S,e),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}},o.d0=function(r){return r*r*r*r*r},o.d1=_,o.d2=45,o.d3=_d,o.d4=function(r,e,i){const s=Math.sqrt(r*r+e*e+i*i),a=s>0?Math.acos(i/s)*El:0;let u=r!==0||e!==0?Math.atan2(-e,-r)*El+90:0;return u<0&&(u+=360),[s,u,a]},o.d5=Li,o.d6=fi,o.d7=q,o.d8=Bi,o.d9=Ft,o.dA=function(r){return r({pluginStatus:fo,pluginURL:va}),$h.on("pluginStateChange",r),r},o.dB=Lu,o.dC=class extends wa{constructor(r){super(r),this.current=gd}set(r,e,i){if(this.fetchUniformLocation(r,e)){for(let s=0;s<9;s++)if(i[s]!==this.current[s]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},o.dD=Sl,o.dE=function(r,e,i){const s=Pc(i.zoom),a=r.style.map._antialias,u=r.terrain&&r.terrain.exaggeration()>0;return s===0&&!a&&!u},o.dF=function(r){const e=r.pixelsPerMeter,i=e/I(1,r.center.lat),s=K(new Float64Array(16));return Oe(s,s,[r.point.x,r.point.y,0]),Ae(s,s,[i,i,e]),Float32Array.from(s)},o.dG=S_,o.dH=function(r){const e=z-5;r=j(r,-e,e)/e*90;const i=Math.pow(Math.abs(Math.sin(Yi(r))),3);return Math.round(i*(lp.length-1))},o.dI=function(r,e,i,s){const a=e.getNorth(),u=e.getSouth(),h=e.getWest(),f=e.getEast(),g=1<<r.z,x=f-h,T=a-u,E=x/Ic,A=-T/lp[i],P=[0,E,0,A,0,0,a,h,0];if(r.z>0){const L=180/s;ue(P,P,[L/x+1,0,0,0,L/T+1,0,-.5*L/E,.5*L/A,1])}return P[2]=g,P[5]=r.x,P[8]=r.y,P},o.dJ=Ms,o.dK=function(r,e,i){const s=K(new Float64Array(16)),a=(e/(1<<r)-.5)*Math.PI*2;return Fe(s,i.globeMatrix,a),Float32Array.from(s)},o.dL=t1,o.dM=ea,o.dN=function(r,e){return[Math.pow(r[0],2.2)*e,Math.pow(r[1],2.2)*e,Math.pow(r[2],2.2)*e]},o.dO=ie,o.dP=function(r,e){var i=Math.sin(e),s=Math.cos(e);return r[0]=s,r[1]=i,r[2]=0,r[3]=-i,r[4]=s,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},o.dQ=Rn,o.dR=Ux,o.dS=$i,o.dT=Zr,o.dU=256,o.dV=function(r,e){const i=[0,0,0];return kr(i,i,A_(Ms(e.canonical))),kr(i,i,r),i},o.dW=r=>({u_matrix:new Ru(r),u_texsize:new Qs(r),u_pixels_to_tile_units:new yd(r),u_device_pixel_ratio:new bn(r),u_width_scale:new bn(r),u_floor_width_scale:new bn(r),u_image:new md(r),u_units_to_pixels:new Qs(r),u_tile_units_to_pixels:new bn(r),u_alpha_discard_threshold:new bn(r),u_trim_offset:new Qs(r),u_trim_fade_range:new Qs(r),u_trim_color:new _d(r),u_zbias_factor:new bn(r),u_tile_to_meter:new bn(r),u_ground_shadow_factor:new Pu(r),u_pattern_transition:new bn(r)}),o.dX=r=>({u_matrix:new Ru(r),u_pixels_to_tile_units:new yd(r),u_device_pixel_ratio:new bn(r),u_width_scale:new bn(r),u_floor_width_scale:new bn(r),u_units_to_pixels:new Qs(r),u_dash_image:new md(r),u_gradient_image:new md(r),u_image_height:new bn(r),u_texsize:new Qs(r),u_tile_units_to_pixels:new bn(r),u_alpha_discard_threshold:new bn(r),u_trim_offset:new Qs(r),u_trim_fade_range:new Qs(r),u_trim_color:new _d(r),u_zbias_factor:new bn(r),u_tile_to_meter:new bn(r),u_ground_shadow_factor:new Pu(r)}),o.dY=r=>({u_camera_to_center_distance:new bn(r),u_extrude_scale:new yd(r),u_device_pixel_ratio:new bn(r),u_matrix:new Ru(r),u_inv_rot_matrix:new Ru(r),u_merc_center:new Qs(r),u_tile_id:new Pu(r),u_zoom_transition:new bn(r),u_up_dir:new Pu(r),u_emissive_strength:new bn(r)}),o.dZ=sd,o.d_=TA,o.da=jr,o.db=function(r){return[Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)]},o.dc=sb,o.dd=gv,o.de=hb,o.df=jv,o.dg=function(r,e){return r.readFields(w3,{icons:[]},e)},o.dh=F_,o.di=Ld,o.dj=Lv,o.dk=ah,o.dl=Eu,o.dm=rc,o.dn=ch,o.dp=Je,o.dq=function(r){const e=r.indexOf(Gl);return e>=0?r.slice(0,e):r},o.dr=function(r){return r.indexOf(Gl)>=0},o.ds=function(r){const e=r.lastIndexOf(Gl);return e>=0?r.slice(e+1):""},o.dt=function(r){const e=[],i=r.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),r.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},o.du=function(r,e,i,s){return r.type==="custom"?new m3(r,e):new x3[r.type](r,e,i,s)},o.dv=ut,o.dw=function(r){const e=r.indexOf(Gl);return e>=0?r.slice(e+1):""},o.dx=class extends qu{constructor(r,e){super(r._vectorTileFeature,r._z,r._x,r._y,r.id),r.state&&(this.state=Object.assign({},r.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=r.source,this.sourceLayer=r.sourceLayer,this.layer=r.layer)}toJSON(){const r=super.toJSON();return r.target=this.target,r.namespace=this.namespace,r}},o.dy=$h,o.dz=Pl,o.e=Ri,o.e$=di,o.e0=Hx,o.e1=(r,e,i,s,a,u)=>{const h=r.transform,f=h.projection.name==="globe";let g;if(u.paint.get("circle-pitch-alignment")==="map")if(f){const T=Ux(h.zoom,e.canonical)*h._pixelsPerMercatorPixel;g=Float32Array.from([T,0,0,T])}else g=h.calculatePixelsToTileUnitsMatrix(i);else g=new Float32Array([h.pixelsToGLUnits[0],0,0,h.pixelsToGLUnits[1]]);const x={u_camera_to_center_distance:r.transform.getCameraToCenterDistance(h.projection),u_matrix:r.translatePosMatrix(e.projMatrix,i,u.paint.get("circle-translate"),u.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Dn.devicePixelRatio,u_extrude_scale:g,u_inv_rot_matrix:NS,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:u.paint.get("circle-emissive-strength")};if(f){x.u_inv_rot_matrix=s,x.u_merc_center=a,x.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],x.u_zoom_transition=Pc(h.zoom);const T=a[0]*gt,E=a[1]*gt;x.u_up_dir=h.projection.upVector(new xr(0,0,0),T,E)}return x},o.e2=Ab,o.e3=uo,o.e4=(r,e,i,s,a,u,h,f,g,x)=>{const T=r.transform,E=T.pitch<15?Eb(.07,.7,j((14-T.zoom)/5,0,1)):.07,A=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:Ib(r,e,i,s),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:T.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:a,u_width_scale:u,u_floor_width_scale:h,u_image:0,u_tile_units_to_pixels:Sb(e,T),u_units_to_pixels:[1/T.pixelsToGLUnits[0],1/T.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:f,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(A?null:i.lut).toArray01(),u_zbias_factor:E,u_tile_to_meter:q(e.tileID.canonical,0),u_ground_shadow_factor:g,u_pattern_transition:x}},o.e5=(r,e,i,s,a,u,h,f,g,x)=>{const T=r.transform,E=T.calculatePixelsToTileUnitsMatrix(e),A=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",P=T.pitch<15?Eb(.07,.7,j((14-T.zoom)/5,0,1)):.07;return{u_matrix:Ib(r,e,i,s),u_pixels_to_tile_units:E,u_device_pixel_ratio:u,u_width_scale:h,u_floor_width_scale:f,u_units_to_pixels:[1/T.pixelsToGLUnits[0],1/T.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:a,u_texsize:Cb(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Sb(e,r.transform),u_alpha_discard_threshold:0,u_trim_offset:g,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(A?null:i.lut).toArray01(),u_zbias_factor:P,u_tile_to_meter:q(e.tileID.canonical,0),u_ground_shadow_factor:x}},o.e6=Ve,o.e7=up,o.e8=D,o.e9=ds,o.eA=function(r,e){var i=2*Math.acos(e[3]),s=Math.sin(i/2);return s>G?(r[0]=e[0]/s,r[1]=e[1]/s,r[2]=e[2]/s):(r[0]=1,r[1]=0,r[2]=0),i},o.eB=Hv,o.eC=q_,o.eD=G_,o.eE=[1,1,1],o.eF=zd,o.eG=_s,o.eH=function(r,e,i,s){var a=e[0],u=e[1],h=e[2],f=e[3];return r[0]=a+s*(i[0]-a),r[1]=u+s*(i[1]-u),r[2]=h+s*(i[2]-h),r[3]=f+s*(i[3]-f),r},o.eI=Id,o.eJ=Ho,o.eK=Ks,o.eL=function(r,e,i,s,a,u,h,f,g,x,T,E,A,P,L,F){var U=new Z(16);return U[0]=r,U[1]=e,U[2]=i,U[3]=s,U[4]=a,U[5]=u,U[6]=h,U[7]=f,U[8]=g,U[9]=x,U[10]=T,U[11]=E,U[12]=A,U[13]=P,U[14]=L,U[15]=F,U},o.eM=l,o.eN=Ec,o.eO=Kf,o.eP=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new st(1/0,1/0),max:new st(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(r,e=!1){const i=b1(new st(0,0),new st(gt,gt),r),s=[];if(e&&!Jy(i,this._globalClipBounds))return s;for(const a of this._activeRegions){if(a.hiddenByOverlap||!Jy(i,a))continue;const u=pI(a.min,a.max,r);s.push({min:u.min,max:u.max,sourceId:this._sourceIds[a.priority],footprint:a.footprint,footprintTileId:a.tileId,order:a.order,clipMask:a.clipMask,clipScope:a.clipScope})}return s}setSources(r){this._setSources(r.map((e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const s of e.cache.getVisibleCoordinates()){const a=e.cache.getTile(s).buckets[e.layer];a&&a.updateFootprints(s.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope}))))}_addSource(r){const e=r.getFootprints();if(e.length===0)return;const i=r.getOrder(),s=r.getClipMask(),a=r.getClipScope();for(const u of e){if(!u.footprint)continue;const h=b1(u.footprint.min,u.footprint.max,u.id);this._activeRegions.push({min:h.min,max:h.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:u.id,footprint:u.footprint,order:i,clipMask:s,clipScope:a})}this._sourceIds.push(r.getSourceId())}_computeReplacement(){this._activeRegions.sort(((e,i)=>e.priority-i.priority||R_(e.min,i.min)||R_(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||(function(s,a){const u=(h,f)=>h+f;return s.length-a.length||s.reduce(u,"").localeCompare(a.reduce(u,""))})(e.clipScope,i.clipScope)));let r=this._activeRegions.length!==this._prevRegions.length;if(!r){let e=0;for(;!r&&e!==this._activeRegions.length;){const i=this._activeRegions[e],s=this._prevRegions[e];r=i.priority!==s.priority||!x1(i,s)||i.order!==s.order||i.clipMask!==s.clipMask||!ha(i.clipScope,s.clipScope),this._activeRegions[e].hiddenByOverlap=s.hiddenByOverlap,++e}}if(r){++this._updateTime;for(const i of this._activeRegions)i.order!==_p&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const s=this._activeRegions;if(i>=s.length)return i;const a=s[i].priority;for(;i<s.length&&s[i].priority===a;)++i;return i};if(this._sourceIds.length>1){let i=0,s=e(i);for(;i!==s;){let a=i;const u=i;for(;a!==s;){const h=this._activeRegions[a];h.hiddenByOverlap=!1;for(let f=0;f<u;f++){const g=this._activeRegions[f];if(!g.hiddenByOverlap&&h.order===_p&&Jy(h,g)&&(h.hiddenByOverlap=w1(h.footprint,h.tileId,g.footprint,g.tileId),h.hiddenByOverlap))break}++a}i=s,s=e(i)}}}}_setSources(r){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=r.length-1;e>=0;e--)this._addSource(r[e]);this._computeReplacement()}},o.eQ=_p,o.eR=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const r of this._poleSegments)r.destroy();for(const r of this._gridSegments)r.withSkirts.destroy(),r.withoutSkirts.destroy()}_fillGridMeshWithLods(r,e){const i=new nl,s=new xn,a=[],u=r+1+2,h=e[0]+1,f=e[0]+1+(1+e.length),g=(x,T,E)=>{let A=x===u-1?x-2:x===0?x:x-1;return A+=E?24575:0,[A,T]};for(let x=0;x<u;++x)i.emplaceBack(...g(x,0,!0));for(let x=0;x<h;++x)for(let T=0;T<u;++T)i.emplaceBack(...g(T,x,(T===0||T===u-1)&&!0));for(let x=0;x<e.length;++x){const T=e[x];for(let E=0;E<u;++E)i.emplaceBack(...g(E,T,!0))}for(let x=0;x<e.length;++x){const T=s.length,E=e[x]+1+2,A=new xn;for(let F=0;F<E-1;F++){const U=F===E-2,V=U?u*(f-e.length+x-F):u;for(let $=0;$<u-1;$++){const X=F*u+$;F===0||U||$===0||$===u-2?(A.emplaceBack(X+1,X,X+V),A.emplaceBack(X+V,X+V+1,X+1)):(s.emplaceBack(X+1,X,X+V),s.emplaceBack(X+V,X+V+1,X+1))}}const P=Fr.simpleSegment(0,T,i.length,s.length-T);for(let F=0;F<A.uint16.length;F+=3)s.emplaceBack(A.uint16[F],A.uint16[F+1],A.uint16[F+2]);const L=Fr.simpleSegment(0,T,i.length,s.length-T);a.push({withoutSkirts:P,withSkirts:L})}return{vertices:i,indices:s,segments:a}}_createGrid(r){const e=this._fillGridMeshWithLods(Ic,lp);this._gridSegments=e.segments,this._gridBuffer=r.createVertexBuffer(e.vertices,Cc.members),this._gridIndexBuffer=r.createIndexBuffer(e.indices,!0)}_createPoles(r){const e=new xn;for(let h=0;h<=Ic;h++)e.emplaceBack(0,h+1,h+2);this._poleIndexBuffer=r.createIndexBuffer(e,!0);const i=new Hl,s=new Hl,a=new Hl,u=new Hl;this._poleSegments=[];for(let h=0,f=0;h<ls;h++){const g=360/(1<<h);i.emplaceBack(0,-eo,0,.5,0),s.emplaceBack(0,-eo,0,.5,1),a.emplaceBack(0,-eo,0,.5,.5),u.emplaceBack(0,-eo,0,.5,.5);for(let x=0;x<=Ic;x++){let T=x/Ic,E=0;const A=ei(0,g,T),[P,L,F]=Zl(FS,BS,A,eo);i.emplaceBack(P,L,F,T,E),s.emplaceBack(P,L,F,T,1-E);const U=Yi(A);T=.5+.5*Math.sin(U),E=.5+.5*Math.cos(U),a.emplaceBack(P,L,F,T,E),u.emplaceBack(P,L,F,T,1-E)}this._poleSegments.push(Fr.simpleSegment(f,0,66,64)),f+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(i,Cs,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(s,Cs,!1),this._texturedPoleNorthVertexBuffer=r.createVertexBuffer(a,Cs,!1),this._texturedPoleSouthVertexBuffer=r.createVertexBuffer(u,Cs,!1)}getGridBuffers(r,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[r].withSkirts:this._gridSegments[r].withoutSkirts]}getPoleBuffers(r,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}},o.eS=y1,o.eT=Jc,o.eU=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},o.eV=De,o.eW=H,o.eX=function(r,e,i){return r[0]=e[0]/i[0],r[1]=e[1]/i[1],r[2]=e[2]/i[2],r},o.eY=yl,o.eZ=Ac,o.e_=si,o.ea=z_,o.eb=B1,o.ec=Wl,o.ed=C1,o.ee=A1,o.ef=B,o.eg=function(r,e){if(r===e){var i=e[1],s=e[2],a=e[3],u=e[6],h=e[7],f=e[11];r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=i,r[6]=e[9],r[7]=e[13],r[8]=s,r[9]=u,r[11]=e[14],r[12]=a,r[13]=h,r[14]=f}else r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15];return r},o.eh=p3,o.ei=Ci,o.ej=ep,o.ek=256,o.el=Vy,o.em=qo,o.en=Fe,o.eo=function(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],r},o.ep=Hl,o.eq=Zm,o.er=Jf,o.es=function(r,e,i,s,a){return j((r-e)/(i-e)*(a-s)+s,s,a)},o.et=ca,o.eu=function(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=e[4],f=e[5],g=e[6],x=e[7],T=e[8],E=T*h-f*x,A=-T*u+f*g,P=x*u-h*g,L=i*E+s*A+a*P;return L?(r[0]=E*(L=1/L),r[1]=(-T*s+a*x)*L,r[2]=(f*s-a*h)*L,r[3]=A*L,r[4]=(T*i-a*g)*L,r[5]=(-f*i+a*u)*L,r[6]=P*L,r[7]=(-x*i+s*g)*L,r[8]=(h*i-s*u)*L,r):null},o.ev=2,o.ew=Ti,o.ex=la,o.ey=Rt,o.ez=function(r,e){var i=new Z(3);Rt(i,e);var s=1/i[0],a=1/i[1],u=1/i[2],h=e[0]*s,f=e[1]*a,g=e[2]*u,x=e[4]*s,T=e[5]*a,E=e[6]*u,A=e[8]*s,P=e[9]*a,L=e[10]*u,F=h+T+L,U=0;return F>0?(U=2*Math.sqrt(F+1),r[3]=.25*U,r[0]=(E-P)/U,r[1]=(A-g)/U,r[2]=(f-x)/U):h>T&&h>L?(U=2*Math.sqrt(1+h-T-L),r[3]=(E-P)/U,r[0]=.25*U,r[1]=(f+x)/U,r[2]=(A+g)/U):T>L?(U=2*Math.sqrt(1+T-h-L),r[3]=(A-g)/U,r[0]=(f+x)/U,r[1]=.25*U,r[2]=(E+P)/U):(U=2*Math.sqrt(1+L-h-T),r[3]=(f-x)/U,r[0]=(A+g)/U,r[1]=(E+P)/U,r[2]=.25*U),r},o.f=function(r){return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,((e,i)=>String.fromCharCode(+("0x"+i)))))},o.f0=function([r,e,i]){const s=Math.hypot(r,e,i),a=Math.atan2(r,i),u=.5*Math.PI-Math.acos(-e/s);return new n(no(a),no(u))},o.f1=ja,o.f2=dv,o.f3=function(r){const e=r.navigator?r.navigator.userAgent:null;return!!(function(i){if(fn==null){const s=i.navigator?i.navigator.userAgent:null;fn=!!i.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return fn})(r)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},o.f4=function(r,e){rh=r,nh=e},o.f5=jy,o.f6=Gx,o.f7=function(r){const e=[0,0,0],i=K(new Float64Array(16));return Le(i,r.pixelMatrix,r.globeMatrix),kr(e,e,i),new st(e[0],e[1])},o.f8=function(){const r=wp;r&&(r.isPreloaded()&&r.numActive()===1?(r.release(rv),wp=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},o.f9=function(){F_().acquire(rv)},o.fA=_g,o.fB=Se,o.fC=function(r){let e=0;if(new Uint32Array(r,0,1)[0]!==tb){const i=new Uint32Array(r,0,7),[,,s,a,u,h]=i;e=i.byteLength+a+u+h+u,(s!==r.byteLength||e>=r.byteLength)&&It("Invalid b3dm header information.")}return ob(r,e)},o.fD=function(r,e){const i=gv(r);for(const s of i){for(const a of s.meshes)HI(a);s.lights&&(s.lightMeshIndex=s.meshes.length,s.meshes.push(ZI(s.lights,e)))}return i},o.fE=ug,o.fF=Ui,o.fG=Y1,o.fH=xa,o.fI=Lo,o.fJ=function(r){bs(),js?.then((e=>{e.keys().then((i=>{for(let s=0;s<i.length-r;s++)e.delete(i[s]).catch((a=>It(a.message)))})).catch((i=>It(i.message)))})).catch((e=>It(e.message)))},o.fa=Su,o.fb=function(r,e,i=!1){if(fo===Lo.deferred||fo===Lo.loading||fo===Lo.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");va=Dn.resolveURL(r),fo=Lo.deferred,Uf=e,Zh(),i||n_()},o.fc=function(r){Td=Dn.resolveURL(r),Ed||(Ed=new wd(F_(),new Ll)),Ed.broadcast("setMeshoptUrl",Td)},o.fd=Q1,o.fe=function(r){sv=Dn.resolveURL(r),Ed||(Ed=new wd(F_(),new Ll)),Ed.broadcast("setDracoUrl",sv)},o.ff=K1,o.fg=bp,o.fh=function(r){const e=xs();if(!e)return;const i=e.delete(ih);r&&i.then((()=>r())).catch(r)},o.fi=Nu,o.fj=Lt,o.fk=Lc,o.fl=La,o.fm=y2,o.fn=v2,o.fo=xb,o.fp=He,o.fq="hd_road_elevation",o.fr=nr,o.fs=Ne,o.ft=$l,o.fu=Pv,o.fv=ju,o.fw=function(r,e,i,s,a,u,h,f=1,g,x,T){r.createArrays(),r.tilePixelRatio=gt/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;const E=r.layers[0].layout,A=r.layers[0]._unevaluatedLayout._values,P={};P.scaleFactor=f,P.textSizeScaleRange=E.get("text-size-scale-range"),P.iconSizeScaleRange=E.get("icon-size-scale-range");const[L,F]=P.textSizeScaleRange,[U,V]=P.iconSizeScaleRange;P.textScaleFactor=j(P.scaleFactor,L,F),P.iconScaleFactor=j(P.scaleFactor,U,V);const $=A["text-size"],X=A["icon-size"];if(r.textSizeData.kind==="composite"){const{minZoom:Ee,maxZoom:Ge}=r.textSizeData;P.compositeTextSizes=[$.possiblyEvaluate(new Ar(Ee,{worldview:T}),u),$.possiblyEvaluate(new Ar(Ge,{worldview:T}),u)]}if(r.iconSizeData.kind==="composite"){const{minZoom:Ee,maxZoom:Ge}=r.iconSizeData;P.compositeIconSizes=[X.possiblyEvaluate(new Ar(Ee,{worldview:T}),u),X.possiblyEvaluate(new Ar(Ge,{worldview:T}),u)]}P.layoutTextSize=$.possiblyEvaluate(new Ar(h+1,{worldview:T}),u),P.layoutIconSize=X.possiblyEvaluate(new Ar(h+1,{worldview:T}),u),P.textMaxSize=$.possiblyEvaluate(new Ar(18,{worldview:T}),u);const Q=E.get("symbol-placement"),de=E.get("text-rotation-alignment")==="map"&&Q!=="point",ae=E.get("text-size");let me=!1;const xe=[];for(const Ee of r.features){const Ge=E.get("text-font").evaluate(Ee,{},u).join(","),Me=ae.evaluate(Ee,{},u)*P.textScaleFactor,$e=P.layoutTextSize.evaluate(Ee,{},u)*P.textScaleFactor,Ke=P.layoutIconSize.evaluate(Ee,{},u)*P.iconScaleFactor,Qe={horizontal:{},vertical:void 0},at=Ee.text;let ct,tt=[0,0];if(at){const pi=at.toString(),pr=E.get("text-letter-spacing").evaluate(Ee,{},u)*zn,le=E.get("text-line-height").evaluate(Ee,{},u)*zn,fe=Nf(pi)?pr:0,We=E.get("text-anchor").evaluate(Ee,{},u),lt=E.get("text-variable-anchor");if(!lt){const hi=E.get("text-radial-offset").evaluate(Ee,{},u);if(hi)tt=iw(We,[hi*zn,Dv]);else{const bi=E.get("text-offset").evaluate(Ee,{},u);tt=[bi[0]*zn,bi[1]*zn]}}let bt=de?"center":E.get("text-justify").evaluate(Ee,{},u);const wt=Q==="point",Vt=wt?E.get("text-max-width").evaluate(Ee,{},u)*zn:1/0,qt=hi=>{r.allowVerticalPlacement&&Tu(pi)&&(Qe.vertical=Sv(at,e,i,a,Ge,Vt,le,We,hi,fe,tt,Wo.vertical,!0,$e,Me,g))};if(!de&&lt){const hi=bt==="auto"?lt.map((Ei=>Ov(Ei))):[bt];let bi=!1;for(let Ei=0;Ei<hi.length;Ei++){const Mi=hi[Ei];if(!Qe.horizontal[Mi])if(bi)Qe.horizontal[Mi]=Qe.horizontal[0];else{const Qt=Sv(at,e,i,a,Ge,Vt,le,"center",Mi,fe,tt,Wo.horizontal,!1,$e,Me,g);Qt&&(Qe.horizontal[Mi]=Qt,bi=Qt.positionedLines.length===1)}}qt("left")}else{if(bt==="auto"&&(bt=Ov(We)),wt||E.get("text-writing-mode").indexOf("horizontal")>=0||!Tu(pi)){const hi=Sv(at,e,i,a,Ge,Vt,le,We,bt,fe,tt,Wo.horizontal,!1,$e,Me,g);hi&&(Qe.horizontal[bt]=hi)}qt(wt?"left":bt)}}let rt,Ze,qe,ot,yt,ft,Nt=!1;const Et=E.get("icon-text-fit").evaluate(Ee,{},u);if(Ee.icon&&Ee.icon.hasPrimary()){const pi=Rp(Ee.icon,r.iconSizeData,A["icon-size"],u,r.zoom,Ee,g,P.iconScaleFactor,T);rt=pi.iconPrimary,qe=pi.iconSecondary;const pr=rt.toString();if(Ze=s.get(pr),Ze&&(yt=E.get("icon-offset").evaluate(Ee,{},u),ft=E.get("icon-anchor").evaluate(Ee,{},u),ct=X_(a.get(pr),qe?a.get(qe.toString()):void 0,yt,ft),Nt=Ze.sdf,r.sdfIcons===void 0?r.sdfIcons=Ze.sdf:r.sdfIcons!==Ze.sdf&&It("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ze.pixelRatio!==r.pixelRatio||E.get("icon-rotate").constantOr(1)!==0)&&(r.iconsNeedLinear=!0)),qe){const le=qe.toString();ot=s.get(le)}}me=me||!(!Ee.icon||!Ee.icon.hasSecondary());const Ct=eg(Qe.horizontal)||Qe.vertical;r.iconsInText||(r.iconsInText=!!Ct&&Ct.iconsInText);const Ot=$e*P.textScaleFactor/zn,{defaultShapedIcon:Ii,verticallyShapedIcon:pt}=e3(r,ct,E,Ee,u,Qe,Ot,yt,Et);Et!=="none"&&ct&&(Ub(ct)||jb(ct))&&(Q_(0,Ze,rt,ct,Ii,Et,x,s,a),Q_(0,ot,qe,ct,Ii,Et,x,s,a),pt&&(Q_(0,Ze,rt,ct,pt,Et,x,s,a),Q_(0,ot,qe,ct,pt,Et,x,s,a))),ct=Ii;const{iconBBox:zt,iconVerticalBBox:oi,textBBox:Oi,textVerticalBBox:Ni}=XA(r,ct,pt,E,Ee,u,Ke,yt,P,a,ft,Qe,$e,tt);xe.push({feature:Ee,shapedTextOrientations:Qe,shapedText:Ct,shapedIcon:ct,iconPrimary:rt,iconSecondary:qe,iconOffset:yt,iconAnchor:ft,verticallyShapedIcon:pt,layoutTextSize:$e,layoutIconSize:Ke,textOffset:tt,isSDFIcon:Nt,iconTextFit:Et,iconCollisionBounds:zt,iconVerticalCollisionBounds:oi,textCollisionBounds:Oi,textVerticalCollisionBounds:Ni})}return{featureData:xe,sizes:P,hasAnySecondaryIcon:me,textAlongLine:de,symbolPlacement:Q}},o.fx=Yb,o.fy=function(r,e,i,s,a,u,h,f,g,x){r.iconAtlasPositions=x.iconPositions;const{featureData:T,hasAnySecondaryIcon:E,sizes:A,textAlongLine:P,symbolPlacement:L}=e;for(const F of T){const{shapedIcon:U,verticallyShapedIcon:V,feature:$,shapedTextOrientations:X,shapedText:Q,layoutTextSize:de,textOffset:ae,isSDFIcon:me,iconPrimary:xe,iconSecondary:Ee,iconTextFit:Ge,iconOffset:Me,iconCollisionBounds:$e,iconVerticalCollisionBounds:Ke,textCollisionBounds:Qe}=F;nw(U,x.iconPositions,xe,Ee),nw(V,x.iconPositions,xe,Ee),QA(X,x.iconPositions),KA(xe,Ee,x.iconPositions),(Q||U)&&t3(r,$,X,U,V,g,A,de,0,ae,me,s,a,h,f,E,Ge,Me,P,L,$e,Ke,Qe)}i&&r.generateCollisionDebugBuffers(u,r.collisionBoxArray,A.textScaleFactor)},o.fz=ke,o.g=function(r,e){return Pl(Object.assign(r,{method:"GET"}),e)},o.h=function(r){return r.indexOf("mapbox:")===0},o.i=function(r){return Ri.API_STYLE_REGEX.test(r)&&!Wn(r)},o.j=on,o.k=Gs,o.l=function(r){return decodeURIComponent(atob(r).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""))},o.m=function(r,e){return Pl(Object.assign(r,{type:"json"}),e)},o.n=lh,o.o=Dn,o.p=function(r,e){return Pl(Object.assign(r,{method:"POST"}),e)},o.q=ro,o.r=Us,o.s=function(r){try{const e=self[r];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},o.t=function(){return nv||(nv=new Nu("ImageRasterizer")),nv},o.u=function(){return(function r(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)})()},o.v=function(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)},o.w=It,o.x=Jv,o.y=ru,o.z=qs})),R(["./shared"],(function(o){function G(De){const j=De?De.url.toString():void 0;return j?performance.getEntriesByName(j):[]}function Z(De){if(typeof De=="number"||typeof De=="boolean"||typeof De=="string"||De==null)return JSON.stringify(De);if(Array.isArray(De)){let W="[";for(const ne of De)W+=`${Z(ne)},`;return`${W}]`}let j="{";for(const W of Object.keys(De).sort())j+=`${W}:${Z(De[W])},`;return`${j}}`}function ee(De){let j="";for(const W of o.bx)j+=`/${Z(De[W])}`;return j}class ie{constructor(j){this.keyCache={},this._layers={},this._layerConfigs={},j&&this.replace(j)}replace(j,W){this._layerConfigs={},this._layers={},this.update(j,[],W)}update(j,W,ne){this._options=ne;for(const ve of j)this._layerConfigs[ve.id]=ve,(this._layers[ve.id]=o.du(ve,this.scope,null,this._options)).compileFilter(ne),this.keyCache[ve.id]&&delete this.keyCache[ve.id];for(const ve of W)delete this.keyCache[ve],delete this._layerConfigs[ve],delete this._layers[ve];this.familiesBySource={};const be=(function(ve,Ie){const Ve={};for(let Ne=0;Ne<ve.length;Ne++){const ut=ve[Ne];let Je=Ie&&Ie[ut.id];Je||(ut.type==="symbol"?Je=ut.id:(Je=ee(ut),ut.type==="line"&&ut.paint&&(function $t(It){return typeof It=="string"&&It==="line-progress"||(Array.isArray(It)?It.some($t):!(!It||typeof It!="object")&&Object.values(It).some($t))})(ut.paint["line-width"])&&(Je+=`/${Z(ut.paint["line-width"])}`))),Ie&&(Ie[ut.id]=Je);let Mt=Ve[Je];Mt||(Mt=Ve[Je]=[]),Mt.push(ut)}const Pe=[];for(const Ne in Ve)Pe.push(Ve[Ne]);return Pe})(Object.values(this._layerConfigs),this.keyCache);for(const ve of be){const Ie=ve.map((Mt=>this._layers[Mt.id])),Ve=Ie[0];if(Ve.visibility==="none")continue;const Pe=Ve.source||"";let Ne=this.familiesBySource[Pe];Ne||(Ne=this.familiesBySource[Pe]={});const ut=Ve.sourceLayer||"_geojsonTileLayer";let Je=Ne[ut];Je||(Je=Ne[ut]=[]),Je.push(Ie)}}}const re=1*o.fl;class ue{constructor(j){const W={},ne=[];for(const Ve in j){const Pe=j[Ve],Ne=W[Ve]={};for(const ut in Pe.glyphs){const Je=Pe.glyphs[+ut];if(!Je||Je.bitmap.width===0||Je.bitmap.height===0)continue;const Mt=Je.metrics.localGlyph?re:1,$t={x:0,y:0,w:Je.bitmap.width+2*Mt,h:Je.bitmap.height+2*Mt};ne.push($t),Ne[ut]=$t}}const{w:be,h:ve}=o.G(ne),Ie=new o.fk({width:be||1,height:ve||1});for(const Ve in j){const Pe=j[Ve];for(const Ne in Pe.glyphs){const ut=Pe.glyphs[+Ne];if(!ut||ut.bitmap.width===0||ut.bitmap.height===0)continue;const Je=W[Ve][Ne],Mt=ut.metrics.localGlyph?re:1;o.fk.copy(ut.bitmap,Ie,{x:0,y:0},{x:Je.x+Mt,y:Je.y+Mt},ut.bitmap)}}this.image=Ie,this.positions=W}}function oe(De,j,W){De[j]?W&&(De[j].center=W):De[j]={floorIds:new Set,center:W||[0,0],floors:{}}}function ge(De,j,W,ne){for(const be of j)oe(De,be),De[be].floors[W]=ne,De[be].floorIds.add(W)}function K(De){return{id:De.properties.id.toString(),center:De.properties.center.toString().split(";").map(Number)}}function Te(De){return{id:De.properties.id.toString(),isDefault:!!De.properties.is_default&&De.properties.is_default,connections:De.properties.connected_floor_ids?new Set(De.properties.connected_floor_ids.toString().split(";")):new Set,conflicts:De.properties.conflicted_floor_ids?new Set(De.properties.conflicted_floor_ids.toString().split(";")):new Set,buildings:De.properties.building_ids?new Set(De.properties.building_ids.toString().split(";")):new Set,name:De.properties.name.toString(),zIndex:De.properties.z_index}}function Le(De,j){return j.every((W=>De.properties&&De.properties[W]!=null))}function Oe(De){return Le(De,["type","id","name"])&&De.properties.type==="building"}function Ae(De){return Le(De,["type","id","name","z_index"])&&De.properties.type==="floor"}o.fj(ue,"GlyphAtlas");class ze{constructor(j){this.tileID=new o.aQ(j.tileID.overscaledZ,j.tileID.wrap,j.tileID.canonical.z,j.tileID.canonical.x,j.tileID.canonical.y),this.tileZoom=j.tileZoom,this.uid=j.uid,this.zoom=j.zoom,this.lut=j.lut,this.canonical=j.tileID.canonical,this.pixelRatio=j.pixelRatio,this.tileSize=j.tileSize,this.source=j.source,this.scope=j.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=j.showCollisionBoxes,this.collectResourceTiming=!!j.request&&j.request.collectResourceTiming,this.promoteId=j.promoteId,this.isSymbolTile=j.isSymbolTile,this.tileTransform=o.aZ(j.tileID.canonical,j.projection),this.projection=j.projection,this.worldview=j.worldview,this.localizableLayerIds=j.localizableLayerIds,this.brightness=j.brightness,this.extraShadowCaster=!!j.extraShadowCaster,this.tessellationStep=j.tessellationStep,this.scaleFactor=j.scaleFactor,this.worldview=j.worldview,this.indoor=j.indoor}parse(j,W,ne,be,ve,Ie){this.status="parsing",this.data=j,this.collisionBoxArray=new o.b3;const Ve=new o.fm(Object.keys(j.layers).sort()),Pe=new o.fn(this.tileID,this.promoteId);Pe.bucketLayerIDs=[];const Ne={},ut=new o.fo(256,256),Je={featureIndex:Pe,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:ut,availableImages:ne,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0,activeFloors:void 0};if(this.indoor){const yi=this.indoor.indoorState.activeFloorsVisible,mi=(function(fi,Ui,Qr){const fn=(function(Hr,$i){if(!Hr)return o.w("No source layers defined in indoor specification"),$i;if(Hr.size===0)return $i;const Zr=Hr.difference($i);for(const Tr of Zr)o.w(`Missing source layer required in indoor specification: ${Tr}`);return $i.intersection($i)})(Ui.sourceLayers,new Set(Object.keys(fi.layers))),nn=Ui.indoorState,gn=(function(Hr,$i,Zr,Tr){const Ri=new Set,on=new Set,Wn=new Set,Kn=new Map,xo={},Il=Un=>{const Uo=Kn.get(Un)||new Set;for(const oo of Ri)if((Kn.get(oo)||new Set).has(Un)||Uo.has(oo))return!0;return!1};for(const Un of $i){const Uo=Hr.layers[Un];if(Uo)for(let oo=0;oo<Uo.length;oo++){const Us=Uo.feature(oo);if(Oe(Us)){const{id:Dn,center:Al}=K(Us);oe(xo,Dn,Al),Ri.add(Dn)}else if(Ae(Us)){const{id:Dn,isDefault:Al,connections:rc,conflicts:ih,buildings:rh,name:nh,zIndex:Kc}=Te(Us);ge(xo,rh,Dn,{name:nh,zIndex:Kc}),Kn.set(Dn,ih),(Dn===Tr||rc.has(Tr))&&Ri.add(Dn),on.add(Dn),Al&&Wn.add(Dn)}}else o.w(`indoor source layer not found: ${Un}`)}if(Zr)for(const Un of Zr)on.has(Un)&&(Il(Un)||Ri.add(Un));for(const Un of Wn)Ri.has(Un)||Il(Un)||Ri.add(Un);return{buildings:xo,activeFloors:Ri}})(fi,fn,nn.lastActiveFloors,nn.selectedFloorId);return Qr.send("setIndoorData",gn),gn})(j,this.indoor,ve);Je.activeFloors=yi?mi.activeFloors:void 0}const Mt=[],$t=W.familiesBySource[this.source];for(const yi in $t){const mi=j.layers[yi];if(!mi)continue;let fi=!1,Ui=!1,Qr=!1;for(const $i of $t[yi])$i[0].type==="symbol"?fi=!0:Ui=!0,$i[0].is3D()&&$i[0].type!=="model"&&(Qr=!0);if(this.extraShadowCaster&&!Qr||this.isSymbolTile===!0&&!fi||this.isSymbolTile===!1&&!Ui)continue;mi.version===1&&o.w(`Vector tile source "${this.source}" layer "${yi}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const fn=Ve.encode(yi),nn=[],gn=this.localizableLayerIds&&this.localizableLayerIds.has(yi);let Hr=!1;for(let $i=0,Zr=0;$i<mi.length;$i++){const Tr=mi.feature($i),Ri=Pe.getId(Tr,yi),on=Tr.properties?Tr.properties.worldview:null;if(gn&&this.worldview&&typeof on=="string")if(on==="all")Tr.properties.$localized=!0;else{if(!on.split(",").includes(this.worldview))continue;Tr.properties.$localized=!0,Tr.properties.worldview=this.worldview}!Hr&&Tr.properties&&Tr.properties.hasOwnProperty(o.fp)&&(Hr=!0),nn.push({feature:Tr,id:Ri,index:Zr,sourceLayerIndex:fn}),Zr++}Hr&&!Je.elevationFeatures&&j.layers.hasOwnProperty(o.fq)&&(Je.elevationFeatures=o.fr.parseFrom(j.layers[o.fq],this.canonical));for(const $i of $t[yi]){const Zr=$i[0];if(this.extraShadowCaster&&(!Zr.is3D()||Zr.type==="model")||this.isSymbolTile!==void 0&&Zr.type==="symbol"!==this.isSymbolTile||Zr.minzoom&&this.zoom<Math.floor(Zr.minzoom)||Zr.maxzoom&&this.zoom>=Zr.maxzoom||Zr.visibility==="none")continue;Fe($i,this.zoom,Je.brightness,ne,this.worldview);const Tr=Ne[Zr.id]=Zr.createBucket({index:Pe.bucketLayerIDs.length,layers:$i,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:fn,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:be,worldview:this.worldview,localizable:gn});Pe.bucketLayerIDs.push($i.map((on=>o.B(on.id,on.scope))));let Ri=Tr.prepare?Tr.prepare():null;Ri!=null?(Ri=Ri.then((()=>Tr.populate(nn,Je,this.tileID.canonical,this.tileTransform))),Mt.push(Ri)):Tr.populate(nn,Je,this.tileID.canonical,this.tileTransform)}}const It=()=>{let yi,mi,fi,Ui,Qr,fn;ut.trim();const nn={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},gn=()=>{if(yi)return this.status="done",Ie(yi);if(this.extraShadowCaster)this.status="done",Ie(null,{buckets:Object.values(Ne).filter(($i=>!$i.isEmpty())),featureIndex:Pe,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Je.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(mi&&fi&&Ui){const $i=new ue(mi),Zr=new Map;for(const[on,Wn]of fi.entries()){const{imagePosition:Kn}=o.fu(on,Wn,o.fv);Zr.set(on,Kn)}const Tr={};for(const on in Ne){const Wn=Ne[on];Wn instanceof o.b4&&(Fe(Wn.layers,this.zoom,Je.brightness,ne,this.worldview),Tr[on]=o.fw(Wn,mi,$i.positions,fi,Zr,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,Qr,this.worldview))}const Ri={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(ve,fi,Qr,(()=>{Ri.iconsPending=!1,Hr(Tr,$i,Ri)})),this.rasterizeIfNeeded(ve,Ui,fn,(()=>{Ri.patternsPending=!1,Hr(Tr,$i,Ri)}))}},Hr=($i,Zr,Tr,Ri)=>{if(Tr.iconsPending||Tr.patternsPending)return;const on=new o.fx(fi,Ui,this.lut);for(const Wn in Ne){const Kn=Ne[Wn];if(Wn in $i)o.fy(Kn,$i[Wn],this.showCollisionBoxes,ne,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,fi,on);else if(Kn.hasPattern&&(Kn instanceof o.ba||Kn instanceof o.bb||Kn instanceof o.ea)){Fe(Kn.layers,this.zoom,Je.brightness,ne,this.worldview);const xo=Object.fromEntries(on.patternPositions);Kn.addFeatures(Je,this.tileID.canonical,xo,ne,this.tileTransform,this.brightness)}}this.status="done",Ie(null,{buckets:Object.values(Ne).filter((Wn=>!Wn.isEmpty())),featureIndex:Pe,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Zr.image,lineAtlas:ut,imageAtlas:on,brightness:Je.brightness})};if(!this.extraShadowCaster){const $i=o.fs(Je.glyphDependencies,(Ri=>Object.keys(Ri).map(Number)));Object.keys($i).length?ve.send("getGlyphs",{uid:this.uid,stacks:$i},((Ri,on)=>{yi||(yi=Ri,mi=on,gn())}),void 0,!1,nn):mi={};const Zr=Array.from(Je.iconDependencies.keys()).map((Ri=>o.I.parse(Ri)));Zr.length?ve.send("getImages",{images:Zr,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((Ri,on)=>{yi||(yi=Ri,fi=new Map,Qr=this.updateImageMapAndGetImageTaskQueue(fi,on,Je.iconDependencies),gn())}),void 0,!1,nn):(fi=new Map,Qr=new Map);const Tr=Array.from(Je.patternDependencies.keys()).map((Ri=>o.I.parse(Ri)));Tr.length?ve.send("getImages",{images:Tr,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((Ri,on)=>{yi||(yi=Ri,Ui=new Map,fn=this.updateImageMapAndGetImageTaskQueue(Ui,on,Je.patternDependencies),gn())}),void 0,!1,nn):(Ui=new Map,fn=new Map)}if(Je.elevationFeatures&&Je.elevationFeatures.length>0){const $i=[];for(const Tr of Object.values(Ne))if(Tr instanceof o.bb){const Ri=Tr.getUnevaluatedPortalGraph();Ri&&$i.push(Ri)}const Zr=o.ft.evaluate($i);for(const Tr of Object.values(Ne))if(Tr instanceof o.bb){const Ri=j.layers[Ve.decode(Tr.sourceLayerIndex)];Tr.setEvaluatedPortalGraph(Zr,Ri,this.tileID.canonical,Je.availableImages,Je.brightness)}}gn()};Mt.length>0?Promise.allSettled(Mt).then(It).catch(Ie):It()}updateParameters(j){this.scaleFactor=j.scaleFactor,this.showCollisionBoxes=j.showCollisionBoxes,this.projection=j.projection,this.brightness=j.brightness,this.tileTransform=o.aZ(j.tileID.canonical,j.projection),this.extraShadowCaster=j.extraShadowCaster,this.lut=j.lut,this.worldview=j.worldview,this.indoor=j.indoor}rasterizeIfNeeded(j,W,ne,be){Array.from(W.values()).some((ve=>ve.usvg))?this.rasterize(j,W,ne,be):be()}updateImageMapAndGetImageTaskQueue(j,W,ne){const be=new Map;for(const ve of W.keys()){const Ie=ne.get(ve)||[];for(const Ve of Ie){const Pe=Ve.toString(),Ne=W.get(Ve.id.toString());Ne.usvg?be.has(Pe)||(be.set(Pe,Ve),j.set(Pe,Object.assign({},Ne))):j.set(Pe,Ne)}}return be}rasterize(j,W,ne,be){this.rasterizeTask=j.send("rasterizeImages",{scope:this.scope,tasks:ne},((ve,Ie)=>{if(!ve)for(const[Ve,Pe]of Ie.entries()){const Ne=Object.assign(W.get(Ve),{data:Pe});W.set(Ve,Ne)}be()}))}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function Fe(De,j,W,ne,be){const ve=new o.ac(j,{brightness:W,worldview:be});for(const Ie of De)Ie.recalculate(ve,ne)}class Ye extends o.E{constructor(j,W,ne,be,ve,Ie,Ve){super(),this.actor=j,this.layerIndex=W,this.availableImages=ne,this.availableModels=be,this.loadVectorData=Ie||o.aL,this.loading={},this.loaded={},this.deduped=new o.aK(j.scheduler),this.isSpriteLoaded=ve,this.scheduler=j.scheduler,this.brightness=Ve}loadTile(j,W){const ne=j.uid,be=j&&j.request,ve=be&&be.collectResourceTiming,Ie=this.loading[ne]=new ze(j);Ie.abort=this.loadVectorData(j,((Ve,Pe)=>{const Ne=!this.loading[ne];if(delete this.loading[ne],Ie.cancelRasterize(),Ne||Ve||!Pe)return Ie.status="done",Ne||(this.loaded[ne]=Ie),W(Ve);const ut=Pe.rawData,Je={},Mt=o.aM(Pe.responseHeaders);Mt&&Mt.expires&&(Je.expires=Mt.expires),Mt&&Mt.cacheControl&&(Je.cacheControl=Mt.cacheControl),Ie.vectorTile=Pe.vectorTile||new o.fz(new o.bt(ut));const $t=()=>{Ie.parse(Ie.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,((It,yi)=>{if(It||!yi)return W(It);const mi={};if(ve){const fi=G(be);fi.length>0&&(mi.resourceTiming=JSON.parse(JSON.stringify(fi)))}W(null,Object.assign({rawTileData:ut.slice(0),responseHeaders:Pe.responseHeaders},yi,Je,mi))}))};this.isSpriteLoaded?$t():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add($t,{type:"parseTile",isSymbolTile:j.isSymbolTile,zoom:j.tileZoom}):$t()})),this.loaded=this.loaded||{},this.loaded[ne]=Ie}))}reloadTile(j,W){const ne=this.loaded,be=j.uid;if(ne&&ne[be]){const ve=ne[be];ve.updateParameters(j);const Ie=(Ve,Pe)=>{const Ne=ve.reloadCallback;Ne&&(delete ve.reloadCallback,ve.parse(ve.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Ne)),W(Ve,Pe)};ve.status==="parsing"?ve.reloadCallback=Ie:ve.status==="done"&&(ve.vectorTile?ve.parse(ve.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Ie):Ie())}else W(null,void 0)}abortTile(j,W){const ne=j.uid,be=this.loading[ne];be&&(be.abort&&be.abort(),delete this.loading[ne]),W()}removeTile(j,W){const ne=this.loaded,be=j.uid;ne&&ne[be]&&delete ne[be],W()}}class it{loadTile(j,W){const{uid:ne,encoding:be,rawImageData:ve,padding:Ie}=j,Ve=ImageBitmap&&ve instanceof ImageBitmap?this.getImageData(ve,Ie):ve;W(null,new o.fA(ne,Ve,be,Ie<1))}reloadTile(j,W){W(null,null)}abortTile(j,W){W()}removeTile(j,W){W()}getImageData(j,W){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(j.width,j.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=j.width,this.offscreenCanvas.height=j.height,this.offscreenCanvasContext.drawImage(j,0,0,j.width,j.height);const ne=this.offscreenCanvasContext.getImageData(-W,-W,j.width+2*W,j.height+2*W);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ne}}o.bs.setPbf(o.bt);class jt{constructor(j){this._mrt=new o.bs(j.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=j.uid,this.tileID=j.tileID,this.source=j.source}parse(j,W){const ne=this._mrt;this.status="parsing",this._entireBuffer=j;try{ne.parseHeader(j),this._isHeaderLoaded=!0;const be=[];for(const ve in ne.layers){const Ie=ne.getLayer(ve),Ve=Ie.getDataRange(Ie.getBandList()),Pe=ne.createDecodingTask(Ve),Ne=j.slice(Ve.firstByte,Ve.lastByte+1),ut=o.bs.performDecoding(Ne,Pe).then((Je=>Pe.complete(null,Je))).catch((Je=>Pe.complete(Je,null)));be.push(ut)}Promise.allSettled(be).then((()=>W(null,ne))).catch((ve=>W(ve)))}catch(be){W(be)}}}class Rt{constructor(j){this.actor=j,this.loading={},this.loaded={}}loadTile(j,W){const ne=j.uid,be=j.request,ve=this.loading[ne]=new jt(j),{cancel:Ie}=o.bu(be,((Ve,Pe,Ne)=>{const ut=!this.loading[ne];if(delete this.loading[ne],ut||Ve||!Pe)return ve.status="done",ut||(this.loaded[ne]=ve),W(Ve);ve.parse(Pe,((Je,Mt)=>{if(Je||!Mt)return W(Je);W(null,Mt,Ne)})),this.loaded[ne]=ve}));ve.abort=Ie}reloadTile(j,W){W(null,void 0)}abortTile(j,W){const ne=j.uid,be=this.loading[ne];be&&(be.abort&&be.abort(),delete this.loading[ne]),W()}removeTile(j,W){const ne=j.uid;this.loaded[ne]&&delete this.loaded[ne],W()}decodeRasterArray(j,W){o.bs.performDecoding(j.buffer,j.task).then((ne=>W(null,ne))).catch((ne=>W(ne)))}}const li=o.fB.prototype.toGeoJSON;class Xt{constructor(j){this._feature=j,this.extent=o.al,this.type=j.type,this.properties=j.tags,"id"in j&&!isNaN(j.id)&&(this.id=parseInt(j.id,10))}loadGeometry(){if(this._feature.type===1){const j=[];for(const W of this._feature.geometry)j.push([new o.P(W[0],W[1])]);return j}{const j=[];for(const W of this._feature.geometry){const ne=[];for(const be of W)ne.push(new o.P(be[0],be[1]));j.push(ne)}return j}}toGeoJSON(j,W,ne){return li.call(this,j,W,ne)}}class Pt{constructor(j,W){this.name=j,this.extent=o.al,this.length=W.length,this._jsonFeatures=W}feature(j){return new Xt(this._jsonFeatures[j])}}class Ai{constructor(j){this.layers={},this.extent=o.al;for(const W of Object.keys(j))this.layers[W]=new Pt(W,j[W])}}const rr=64/4096,Li=128;class di{constructor(){this.features=new Map}clear(){this.features.clear()}load(j=[],W){for(const ne of j){const be=ne.id;if(be==null)continue;let ve=this.features.get(be);ve&&this.updateCache(ve,W),ne.geometry?(ve=jr(ne),this.updateCache(ve,W),this.features.set(be,ve)):this.features.delete(be),this.updateCache(ve,W)}}updateCache(j,W){for(const{canonical:ne,uid:be}of Object.values(W)){const{z:ve,x:Ie,y:Ve}=ne;Bi(j,Math.pow(2,ve),Ie,Ve)&&delete W[be]}}getTile(j,W,ne){const be=Math.pow(2,j),ve=[];for(const Ie of this.features.values())Bi(Ie,be,W,ne)&&ve.push(yr(Ie,be,W,ne));return{features:ve}}getFeatures(){return[...this.features.values()]}}function Bi({minX:De,minY:j,maxX:W,maxY:ne},be,ve,Ie){return De<(ve+1+rr)/be&&j<(Ie+1+rr)/be&&W>(ve-rr)/be&&ne>(Ie-rr)/be}function jr(De){const{id:j,geometry:W,properties:ne}=De;if(!W)return;if(W.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:be,coordinates:ve}=W,Ie={id:j,type:1,geometry:[],tags:ne,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Ve=Ie.geometry;if(be==="Point")Ln(ve,Ve,Ie);else if(be==="MultiPoint")for(const Pe of ve)Ln(Pe,Ve,Ie);else if(be==="LineString")Ie.type=2,Nn(ve,Ve,Ie);else if(be==="MultiLineString")Ie.type=2,An(ve,Ve,Ie);else if(be==="Polygon")Ie.type=3,An(ve,Ve,Ie,!0);else{if(be!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");Ie.type=3;for(const Pe of ve)An(Pe,Ve,Ie,!0)}return Ie}function Ln([De,j],W,ne){const be=o.aF(De);let ve=o.aJ(j);ve=ve<0?0:ve>1?1:ve,W.push(be,ve),ne.minX=Math.min(ne.minX,be),ne.minY=Math.min(ne.minY,ve),ne.maxX=Math.max(ne.maxX,be),ne.maxY=Math.max(ne.maxY,ve)}function Nn(De,j,W,ne=!1,be=!1){const ve=[];for(const Ie of De)Ln(Ie,ve,W);j.push(ve),ne&&(function(Ie,Ve){let Pe=0;for(let Ne=0,ut=Ie.length,Je=ut-2;Ne<ut;Je=Ne,Ne+=2)Pe+=(Ie[Ne]-Ie[Je])*(Ie[Ne+1]+Ie[Je+1]);if(Pe>0===Ve)for(let Ne=0,ut=Ie.length;Ne<ut/2;Ne+=2){const Je=Ie[Ne],Mt=Ie[Ne+1];Ie[Ne]=Ie[ut-2-Ne],Ie[Ne+1]=Ie[ut-1-Ne],Ie[ut-2-Ne]=Je,Ie[ut-1-Ne]=Mt}})(ve,be)}function An(De,j,W,ne=!1){for(let be=0;be<De.length;be++)Nn(De[be],j,W,ne,be===0)}function yr(De,j,W,ne){const{id:be,type:ve,geometry:Ie,tags:Ve}=De,Pe=[];if(ve===1)(function(Ne,ut,Je,Mt,$t){for(let It=0;It<Ne.length;It+=2){const yi=Math.round(o.al*(Ne[It+0]*ut-Je)),mi=Math.round(o.al*(Ne[It+1]*ut-Mt));$t.push([yi,mi])}})(Ie,j,W,ne,Pe);else if(ve===2)for(const Ne of Ie)qn(Ne,j,W,ne,Pe);else if(ve===3)for(const Ne of Ie)ii(Ne,j,W,ne,Pe);return{id:be,type:ve,geometry:Pe,tags:Ve}}function qn(De,j,W,ne,be){const ve=-Li,Ie=o.al+Li;let Ve;for(let Pe=0;Pe<De.length-2;Pe+=2){let Ne=Math.round(o.al*(De[Pe+0]*j-W)),ut=Math.round(o.al*(De[Pe+1]*j-ne)),Je=Math.round(o.al*(De[Pe+2]*j-W)),Mt=Math.round(o.al*(De[Pe+3]*j-ne));const $t=Je-Ne,It=Mt-ut;Ne<ve&&Je<ve||(Ne<ve?(ut+=Math.round(It*((ve-Ne)/$t)),Ne=ve):Je<ve&&(Mt=ut+Math.round(It*((ve-Ne)/$t)),Je=ve),ut<ve&&Mt<ve||(ut<ve?(Ne+=Math.round($t*((ve-ut)/It)),ut=ve):Mt<ve&&(Je=Ne+Math.round($t*((ve-ut)/It)),Mt=ve),Ne>=Ie&&Je>=Ie||(Ne>=Ie?(ut+=Math.round(It*((Ie-Ne)/$t)),Ne=Ie):Je>=Ie&&(Mt=ut+Math.round(It*((Ie-Ne)/$t)),Je=Ie),ut>=Ie&&Mt>=Ie||(ut>=Ie?(Ne+=Math.round($t*((Ie-ut)/It)),ut=Ie):Mt>=Ie&&(Je=Ne+Math.round($t*((Ie-ut)/It)),Mt=Ie),Ve&&Ne===Ve[Ve.length-1][0]&&ut===Ve[Ve.length-1][1]||(Ve=[[Ne,ut]],be.push(Ve)),Ve.push([Je,Mt])))))}}function ii(De,j,W,ne,be){const ve=(W-rr)/j,Ie=(ne-rr)/j,Ve=(W+1+rr)/j,Pe=(ne+1+rr)/j;function Ne(Mt,$t){let It=0;return Mt<ve?It|=1:Mt>Ve&&(It|=2),$t<Ie?It|=4:$t>Pe&&(It|=8),It}let ut=[];for(let Mt=1;Mt<=8;Mt*=2){let $t=De[De.length-2],It=De[De.length-1],yi=!(Ne($t,It)&Mt);for(let mi=0;mi<De.length;mi+=2){const fi=De[mi],Ui=De[mi+1],Qr=!(Ne(fi,Ui)&Mt);Qr!==yi&&(8&Mt?ut.push($t+(fi-$t)*(Pe-It)/(Ui-It),Pe):4&Mt?ut.push($t+(fi-$t)*(Ie-It)/(Ui-It),Ie):2&Mt?ut.push(Ve,It+(Ui-It)*(Ve-$t)/(fi-$t)):1&Mt&&ut.push(ve,It+(Ui-It)*(ve-$t)/(fi-$t))),Qr&&ut.push(fi,Ui),$t=fi,It=Ui,yi=Qr}if(!(De=ut).length||Mt===8)break;ut=[]}const Je=[];for(let Mt=0;Mt<ut.length;Mt+=2)Je.push([Math.round(o.al*(ut[Mt]*j-W)),Math.round(o.al*(ut[Mt+1]*j-ne))]);be.push(Je)}function Si({name:De,features:j},W){W.writeStringField(1,De),W.writeVarintField(5,o.al);const ne=new Map,be=new Map,ve={keys:ne,values:be,feature:null};for(const Ie of j)ve.feature=Ie,W.writeMessage(2,si,ve);for(const Ie of ne.keys())W.writeStringField(3,Ie);for(const Ie of be.keys())W.writeMessage(4,Hn,Ie)}function si(De,j){const W=De.feature;W.id!==void 0&&Number.isSafeInteger(+W.id)&&j.writeVarintField(1,+W.id),W.tags&&j.writeMessage(2,Ti,De),j.writeVarintField(3,W.type),j.writeMessage(4,wr,W)}function Ti({keys:De,values:j,feature:W},ne){for(const be of Object.keys(W.tags)){let ve=W.tags[be];if(ve===null)continue;let Ie=De.get(be);Ie===void 0&&(Ie=De.size,De.set(be,Ie)),ne.writeVarint(Ie);const Ve=typeof ve;Ve!=="string"&&Ve!=="boolean"&&Ve!=="number"&&(ve=JSON.stringify(ve));let Pe=j.get(ve);Pe===void 0&&(Pe=j.size,j.set(ve,Pe)),ne.writeVarint(Pe)}}function ui(De,j){return(j<<3)+(7&De)}function ki(De){return De<<1^De>>31}function wr(De,j){const{geometry:W,type:ne}=De;let be=0,ve=0;if(ne===1){j.writeVarint(ui(1,W.length));for(const Ie of W){const Ve=Ie[0]-be,Pe=Ie[1]-ve;j.writeVarint(ki(Ve)),j.writeVarint(ki(Pe)),be+=Ve,ve+=Pe}}else for(const Ie of W){j.writeVarint(ui(1,1));const Ve=Ie.length-(ne===3?1:0);for(let Pe=0;Pe<Ve;Pe++){Pe===1&&j.writeVarint(ui(2,Ve-1));const Ne=Ie[Pe][0]-be,ut=Ie[Pe][1]-ve;j.writeVarint(ki(Ne)),j.writeVarint(ki(ut)),be+=Ne,ve+=ut}ne===3&&j.writeVarint(ui(7,1))}}function Hn(De,j){const W=typeof De;W==="string"?j.writeStringField(1,De):W==="boolean"?j.writeBooleanField(7,De):W==="number"&&(De%1!=0?j.writeDoubleField(3,De):De<0?j.writeSVarintField(6,De):j.writeVarintField(5,De))}const kr={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:De=>De},Rn=Math.fround||(yo=new Float32Array(1),De=>(yo[0]=+De,yo[0]));var yo;const Gr=3,Jr=5,Kr=6;class yl{constructor(j){this.options=Object.assign(Object.create(kr),j),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(j){const{log:W,minZoom:ne,maxZoom:be}=this.options;W&&console.time("total time");const ve=`prepare ${j.length} points`;W&&console.time(ve),this.points=j;const Ie=[];for(let Pe=0;Pe<j.length;Pe++){const Ne=j[Pe];if(!Ne.geometry)continue;const[ut,Je]=Ne.geometry.coordinates,Mt=Rn(Ns(ut)),$t=Rn(ja(Je));Ie.push(Mt,$t,1/0,Pe,-1,1),this.options.reduce&&Ie.push(0)}let Ve=this.trees[be+1]=this._createTree(Ie);W&&console.timeEnd(ve);for(let Pe=be;Pe>=ne;Pe--){const Ne=+Date.now();Ve=this.trees[Pe]=this._createTree(this._cluster(Ve,Pe)),W&&console.log("z%d: %d clusters in %dms",Pe,Ve.numItems,+Date.now()-Ne)}return W&&console.timeEnd("total time"),this}getClusters(j,W){let ne=((j[0]+180)%360+360)%360-180;const be=Math.max(-90,Math.min(90,j[1]));let ve=j[2]===180?180:((j[2]+180)%360+360)%360-180;const Ie=Math.max(-90,Math.min(90,j[3]));if(j[2]-j[0]>=360)ne=-180,ve=180;else if(ne>ve){const Je=this.getClusters([ne,be,180,Ie],W),Mt=this.getClusters([-180,be,ve,Ie],W);return Je.concat(Mt)}const Ve=this.trees[this._limitZoom(W)],Pe=Ve.range(Ns(ne),ja(Ie),Ns(ve),ja(be)),Ne=Ve.data,ut=[];for(const Je of Pe){const Mt=this.stride*Je;ut.push(Ne[Mt+Jr]>1?Vo(Ne,Mt,this.clusterProps):this.points[Ne[Mt+Gr]])}return ut}getChildren(j){const W=this._getOriginId(j),ne=this._getOriginZoom(j),be="No cluster with the specified id.",ve=this.trees[ne];if(!ve)throw new Error(be);const Ie=ve.data;if(W*this.stride>=Ie.length)throw new Error(be);const Ve=this.options.radius/(this.options.extent*Math.pow(2,ne-1)),Pe=ve.within(Ie[W*this.stride],Ie[W*this.stride+1],Ve),Ne=[];for(const ut of Pe){const Je=ut*this.stride;Ie[Je+4]===j&&Ne.push(Ie[Je+Jr]>1?Vo(Ie,Je,this.clusterProps):this.points[Ie[Je+Gr]])}if(Ne.length===0)throw new Error(be);return Ne}getLeaves(j,W,ne){const be=[];return this._appendLeaves(be,j,W=W||10,ne=ne||0,0),be}getTile(j,W,ne){const be=this.trees[this._limitZoom(j)],ve=Math.pow(2,j),{extent:Ie,radius:Ve}=this.options,Pe=Ve/Ie,Ne=(ne-Pe)/ve,ut=(ne+1+Pe)/ve,Je={features:[]};return this._addTileFeatures(be.range((W-Pe)/ve,Ne,(W+1+Pe)/ve,ut),be.data,W,ne,ve,Je),W===0&&this._addTileFeatures(be.range(1-Pe/ve,Ne,1,ut),be.data,ve,ne,ve,Je),W===ve-1&&this._addTileFeatures(be.range(0,Ne,Pe/ve,ut),be.data,-1,ne,ve,Je),Je.features.length?Je:null}getClusterExpansionZoom(j){let W=this._getOriginZoom(j)-1;for(;W<=this.options.maxZoom;){const ne=this.getChildren(j);if(W++,ne.length!==1)break;j=ne[0].properties.cluster_id}return W}_appendLeaves(j,W,ne,be,ve){const Ie=this.getChildren(W);for(const Ve of Ie){const Pe=Ve.properties;if(Pe&&Pe.cluster?ve+Pe.point_count<=be?ve+=Pe.point_count:ve=this._appendLeaves(j,Pe.cluster_id,ne,be,ve):ve<be?ve++:j.push(Ve),j.length===ne)break}return ve}_createTree(j){const W=new o.c4(j.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ne=0;ne<j.length;ne+=this.stride)W.add(j[ne],j[ne+1]);return W.finish(),W.data=j,W}_addTileFeatures(j,W,ne,be,ve,Ie){for(const Ve of j){const Pe=Ve*this.stride,Ne=W[Pe+Jr]>1;let ut,Je,Mt;if(Ne)ut=_s(W,Pe,this.clusterProps),Je=W[Pe],Mt=W[Pe+1];else{const yi=this.points[W[Pe+Gr]];ut=yi.properties;const[mi,fi]=yi.geometry.coordinates;Je=Ns(mi),Mt=ja(fi)}const $t={type:1,geometry:[[Math.round(this.options.extent*(Je*ve-ne)),Math.round(this.options.extent*(Mt*ve-be))]],tags:ut};let It;It=Ne||this.options.generateId?W[Pe+Gr]:this.points[W[Pe+Gr]].id,It!==void 0&&($t.id=It),Ie.features.push($t)}}_limitZoom(j){return Math.max(this.options.minZoom,Math.min(Math.floor(+j),this.options.maxZoom+1))}_cluster(j,W){const{radius:ne,extent:be,reduce:ve,minPoints:Ie}=this.options,Ve=ne/(be*Math.pow(2,W)),Pe=j.data,Ne=[],ut=this.stride;for(let Je=0;Je<Pe.length;Je+=ut){if(Pe[Je+2]<=W)continue;Pe[Je+2]=W;const Mt=Pe[Je],$t=Pe[Je+1],It=j.within(Pe[Je],Pe[Je+1],Ve),yi=Pe[Je+Jr];let mi=yi;for(const fi of It){const Ui=fi*ut;Pe[Ui+2]>W&&(mi+=Pe[Ui+Jr])}if(mi>yi&&mi>=Ie){let fi,Ui=Mt*yi,Qr=$t*yi,fn=-1;const nn=(Je/ut<<5)+(W+1)+this.points.length;for(const gn of It){const Hr=gn*ut;if(Pe[Hr+2]<=W)continue;Pe[Hr+2]=W;const $i=Pe[Hr+Jr];Ui+=Pe[Hr]*$i,Qr+=Pe[Hr+1]*$i,Pe[Hr+4]=nn,ve&&(fi||(fi=this._map(Pe,Je,!0),fn=this.clusterProps.length,this.clusterProps.push(fi)),ve(fi,this._map(Pe,Hr)))}Pe[Je+4]=nn,Ne.push(Ui/mi,Qr/mi,1/0,nn,-1,mi),ve&&Ne.push(fn)}else{for(let fi=0;fi<ut;fi++)Ne.push(Pe[Je+fi]);if(mi>1)for(const fi of It){const Ui=fi*ut;if(!(Pe[Ui+2]<=W)){Pe[Ui+2]=W;for(let Qr=0;Qr<ut;Qr++)Ne.push(Pe[Ui+Qr])}}}}return Ne}_getOriginId(j){return j-this.points.length>>5}_getOriginZoom(j){return(j-this.points.length)%32}_map(j,W,ne){if(j[W+Jr]>1){const Ie=this.clusterProps[j[W+Kr]];return ne?Object.assign({},Ie):Ie}const be=this.points[j[W+Gr]].properties,ve=this.options.map(be);return ne&&ve===be?Object.assign({},ve):ve}}function Vo(De,j,W){return{type:"Feature",id:De[j+Gr],properties:_s(De,j,W),geometry:{type:"Point",coordinates:[(ne=De[j],360*(ne-.5)),Jn(De[j+1])]}};var ne}function _s(De,j,W){const ne=De[j+Jr],be=ne>=1e4?`${Math.round(ne/1e3)}k`:ne>=1e3?Math.round(ne/100)/10+"k":ne,ve=De[j+Kr],Ie=ve===-1?{}:Object.assign({},W[ve]);return Object.assign(Ie,{cluster:!0,cluster_id:De[j+Gr],point_count:ne,point_count_abbreviated:be})}function Ns(De){return De/360+.5}function ja(De){const j=Math.sin(De*Math.PI/180),W=.5-.25*Math.log((1+j)/(1-j))/Math.PI;return W<0?0:W>1?1:W}function Jn(De){const j=(180-360*De)*Math.PI/180;return 360*Math.atan(Math.exp(j))/Math.PI-90}function la(De,j,W,ne){let be=ne;const ve=j+(W-j>>1);let Ie,Ve=W-j;const Pe=De[j],Ne=De[j+1],ut=De[W],Je=De[W+1];for(let Mt=j+3;Mt<W;Mt+=3){const $t=tc(De[Mt],De[Mt+1],Pe,Ne,ut,Je);if($t>be)Ie=Mt,be=$t;else if($t===be){const It=Math.abs(Mt-ve);It<Ve&&(Ie=Mt,Ve=It)}}be>ne&&(Ie-j>3&&la(De,j,Ie,ne),De[Ie+2]=be,W-Ie>3&&la(De,Ie,W,ne))}function tc(De,j,W,ne,be,ve){let Ie=be-W,Ve=ve-ne;if(Ie!==0||Ve!==0){const Pe=((De-W)*Ie+(j-ne)*Ve)/(Ie*Ie+Ve*Ve);Pe>1?(W=be,ne=ve):Pe>0&&(W+=Ie*Pe,ne+=Ve*Pe)}return Ie=De-W,Ve=j-ne,Ie*Ie+Ve*Ve}function gs(De,j,W,ne){const be={id:De??null,type:j,geometry:W,tags:ne,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(j==="Point"||j==="MultiPoint"||j==="LineString")ca(be,W);else if(j==="Polygon")ca(be,W[0]);else if(j==="MultiLineString")for(const ve of W)ca(be,ve);else if(j==="MultiPolygon")for(const ve of W)ca(be,ve[0]);return be}function ca(De,j){for(let W=0;W<j.length;W+=3)De.minX=Math.min(De.minX,j[W]),De.minY=Math.min(De.minY,j[W+1]),De.maxX=Math.max(De.maxX,j[W]),De.maxY=Math.max(De.maxY,j[W+1])}function lo(De,j,W,ne){if(!j.geometry)return;const be=j.geometry.coordinates;if(be&&be.length===0)return;const ve=j.geometry.type,Ie=Math.pow(W.tolerance/((1<<W.maxZoom)*W.extent),2);let Ve=[],Pe=j.id;if(W.promoteId?Pe=j.properties[W.promoteId]:W.generateId&&(Pe=ne||0),ve==="Point")vl(be,Ve);else if(ve==="MultiPoint")for(const Ne of be)vl(Ne,Ve);else if(ve==="LineString")xl(be,Ve,Ie,!1);else if(ve==="MultiLineString"){if(W.lineMetrics){for(const Ne of be)Ve=[],xl(Ne,Ve,Ie,!1),De.push(gs(Pe,"LineString",Ve,j.properties));return}bl(be,Ve,Ie,!1)}else if(ve==="Polygon")bl(be,Ve,Ie,!0);else{if(ve!=="MultiPolygon"){if(ve==="GeometryCollection"){for(const Ne of j.geometry.geometries)lo(De,{id:Pe,geometry:Ne,properties:j.properties},W,ne);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Ne of be){const ut=[];bl(Ne,ut,Ie,!0),Ve.push(ut)}}De.push(gs(Pe,ve,Ve,j.properties))}function vl(De,j){j.push(ic(De[0]),Vn(De[1]),0)}function xl(De,j,W,ne){let be,ve,Ie=0;for(let Pe=0;Pe<De.length;Pe++){const Ne=ic(De[Pe][0]),ut=Vn(De[Pe][1]);j.push(Ne,ut,0),Pe>0&&(Ie+=ne?(be*ut-Ne*ve)/2:Math.sqrt(Math.pow(Ne-be,2)+Math.pow(ut-ve,2))),be=Ne,ve=ut}const Ve=j.length-3;j[2]=1,la(j,0,Ve,W),j[Ve+2]=1,j.size=Math.abs(Ie),j.start=0,j.end=j.size}function bl(De,j,W,ne){for(let be=0;be<De.length;be++){const ve=[];xl(De[be],ve,W,ne),j.push(ve)}}function ic(De){return De/360+.5}function Vn(De){const j=Math.sin(De*Math.PI/180),W=.5-.25*Math.log((1+j)/(1-j))/Math.PI;return W<0?0:W>1?1:W}function vo(De,j,W,ne,be,ve,Ie,Ve){if(ne/=j,ve>=(W/=j)&&Ie<ne)return De;if(Ie<W||ve>=ne)return null;const Pe=[];for(const Ne of De){const ut=Ne.geometry;let Je=Ne.type;const Mt=be===0?Ne.minX:Ne.minY,$t=be===0?Ne.maxX:Ne.maxY;if(Mt>=W&&$t<ne){Pe.push(Ne);continue}if($t<W||Mt>=ne)continue;let It=[];if(Je==="Point"||Je==="MultiPoint")Xc(ut,It,W,ne,be);else if(Je==="LineString")Ga(ut,It,W,ne,be,!1,Ve.lineMetrics);else if(Je==="MultiLineString")ua(ut,It,W,ne,be,!1);else if(Je==="Polygon")ua(ut,It,W,ne,be,!0);else if(Je==="MultiPolygon")for(const yi of ut){const mi=[];ua(yi,mi,W,ne,be,!0),mi.length&&It.push(mi)}if(It.length){if(Ve.lineMetrics&&Je==="LineString"){for(const yi of It)Pe.push(gs(Ne.id,Je,yi,Ne.tags));continue}Je!=="LineString"&&Je!=="MultiLineString"||(It.length===1?(Je="LineString",It=It[0]):Je="MultiLineString"),Je!=="Point"&&Je!=="MultiPoint"||(Je=It.length===3?"Point":"MultiPoint"),Pe.push(gs(Ne.id,Je,It,Ne.tags))}}return Pe.length?Pe:null}function Xc(De,j,W,ne,be){for(let ve=0;ve<De.length;ve+=3){const Ie=De[ve+be];Ie>=W&&Ie<=ne&&ys(j,De[ve],De[ve+1],De[ve+2])}}function Ga(De,j,W,ne,be,ve,Ie){let Ve=Vs(De);const Pe=be===0?Yc:wl;let Ne,ut,Je=De.start;for(let mi=0;mi<De.length-3;mi+=3){const fi=De[mi],Ui=De[mi+1],Qr=De[mi+2],fn=De[mi+3],nn=De[mi+4],gn=be===0?fi:Ui,Hr=be===0?fn:nn;let $i=!1;Ie&&(Ne=Math.sqrt(Math.pow(fi-fn,2)+Math.pow(Ui-nn,2))),gn<W?Hr>W&&(ut=Pe(Ve,fi,Ui,fn,nn,W),Ie&&(Ve.start=Je+Ne*ut)):gn>ne?Hr<ne&&(ut=Pe(Ve,fi,Ui,fn,nn,ne),Ie&&(Ve.start=Je+Ne*ut)):ys(Ve,fi,Ui,Qr),Hr<W&&gn>=W&&(ut=Pe(Ve,fi,Ui,fn,nn,W),$i=!0),Hr>ne&&gn<=ne&&(ut=Pe(Ve,fi,Ui,fn,nn,ne),$i=!0),!ve&&$i&&(Ie&&(Ve.end=Je+Ne*ut),j.push(Ve),Ve=Vs(De)),Ie&&(Je+=Ne)}let Mt=De.length-3;const $t=De[Mt],It=De[Mt+1],yi=be===0?$t:It;yi>=W&&yi<=ne&&ys(Ve,$t,It,De[Mt+2]),Mt=Ve.length-3,ve&&Mt>=3&&(Ve[Mt]!==Ve[0]||Ve[Mt+1]!==Ve[1])&&ys(Ve,Ve[0],Ve[1],Ve[2]),Ve.length&&j.push(Ve)}function Vs(De){const j=[];return j.size=De.size,j.start=De.start,j.end=De.end,j}function ua(De,j,W,ne,be,ve){for(const Ie of De)Ga(Ie,j,W,ne,be,ve,!1)}function ys(De,j,W,ne){De.push(j,W,ne)}function Yc(De,j,W,ne,be,ve){const Ie=(ve-j)/(ne-j);return ys(De,ve,W+(be-W)*Ie,1),Ie}function wl(De,j,W,ne,be,ve){const Ie=(ve-W)/(be-W);return ys(De,j+(ne-j)*Ie,ve,1),Ie}function qr(De,j){const W=[];for(let ne=0;ne<De.length;ne++){const be=De[ne],ve=be.type;let Ie;if(ve==="Point"||ve==="MultiPoint"||ve==="LineString")Ie=Zn(be.geometry,j);else if(ve==="MultiLineString"||ve==="Polygon"){Ie=[];for(const Ve of be.geometry)Ie.push(Zn(Ve,j))}else if(ve==="MultiPolygon"){Ie=[];for(const Ve of be.geometry){const Pe=[];for(const Ne of Ve)Pe.push(Zn(Ne,j));Ie.push(Pe)}}W.push(gs(be.id,ve,Ie,be.tags))}return W}function Zn(De,j){const W=[];W.size=De.size,De.start!==void 0&&(W.start=De.start,W.end=De.end);for(let ne=0;ne<De.length;ne+=3)W.push(De[ne]+j,De[ne+1],De[ne+2]);return W}function eh(De,j){if(De.transformed)return De;const W=1<<De.z,ne=De.x,be=De.y;for(const ve of De.features){const Ie=ve.geometry,Ve=ve.type;if(ve.geometry=[],Ve===1)for(let Pe=0;Pe<Ie.length;Pe+=2)ve.geometry.push(Tl(Ie[Pe],Ie[Pe+1],j,W,ne,be));else for(let Pe=0;Pe<Ie.length;Pe++){const Ne=[];for(let ut=0;ut<Ie[Pe].length;ut+=2)Ne.push(Tl(Ie[Pe][ut],Ie[Pe][ut+1],j,W,ne,be));ve.geometry.push(Ne)}}return De.transformed=!0,De}function Tl(De,j,W,ne,be,ve){return[Math.round(W*(De*ne-be)),Math.round(W*(j*ne-ve))]}function vs(De,j,W,ne,be){const ve=j===be.maxZoom?0:be.tolerance/((1<<j)*be.extent),Ie={features:[],numPoints:0,numSimplified:0,numFeatures:De.length,source:null,x:W,y:ne,z:j,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Ve of De)th(Ie,Ve,ve,be);return Ie}function th(De,j,W,ne){const be=j.geometry,ve=j.type,Ie=[];if(De.minX=Math.min(De.minX,j.minX),De.minY=Math.min(De.minY,j.minY),De.maxX=Math.max(De.maxX,j.maxX),De.maxY=Math.max(De.maxY,j.maxY),ve==="Point"||ve==="MultiPoint")for(let Ve=0;Ve<be.length;Ve+=3)Ie.push(be[Ve],be[Ve+1]),De.numPoints++,De.numSimplified++;else if(ve==="LineString")st(Ie,be,De,W,!1,!1);else if(ve==="MultiLineString"||ve==="Polygon")for(let Ve=0;Ve<be.length;Ve++)st(Ie,be[Ve],De,W,ve==="Polygon",Ve===0);else if(ve==="MultiPolygon")for(let Ve=0;Ve<be.length;Ve++){const Pe=be[Ve];for(let Ne=0;Ne<Pe.length;Ne++)st(Ie,Pe[Ne],De,W,!0,Ne===0)}if(Ie.length){let Ve=j.tags||null;if(ve==="LineString"&&ne.lineMetrics){Ve={};for(const Ne in j.tags)Ve[Ne]=j.tags[Ne];Ve.mapbox_clip_start=be.start/be.size,Ve.mapbox_clip_end=be.end/be.size}const Pe={geometry:Ie,type:ve==="Polygon"||ve==="MultiPolygon"?3:ve==="LineString"||ve==="MultiLineString"?2:1,tags:Ve};j.id!==null&&(Pe.id=j.id),De.features.push(Pe)}}function st(De,j,W,ne,be,ve){const Ie=ne*ne;if(ne>0&&j.size<(be?Ie:ne))return void(W.numPoints+=j.length/3);const Ve=[];for(let Pe=0;Pe<j.length;Pe+=3)(ne===0||j[Pe+2]>Ie)&&(W.numSimplified++,Ve.push(j[Pe],j[Pe+1])),W.numPoints++;be&&(function(Pe,Ne){let ut=0;for(let Je=0,Mt=Pe.length,$t=Mt-2;Je<Mt;$t=Je,Je+=2)ut+=(Pe[Je]-Pe[$t])*(Pe[Je+1]+Pe[$t+1]);if(ut>0===Ne)for(let Je=0,Mt=Pe.length;Je<Mt/2;Je+=2){const $t=Pe[Je],It=Pe[Je+1];Pe[Je]=Pe[Mt-2-Je],Pe[Je+1]=Pe[Mt-1-Je],Pe[Mt-2-Je]=$t,Pe[Mt-1-Je]=It}})(Ve,ve),De.push(Ve)}const ha={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class ef{constructor(j,W){const ne=(W=this.options=(function(ve,Ie){for(const Ve in Ie)ve[Ve]=Ie[Ve];return ve})(Object.create(ha),W)).debug;if(ne&&console.time("preprocess data"),W.maxZoom<0||W.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(W.promoteId&&W.generateId)throw new Error("promoteId and generateId cannot be used together.");let be=(function(ve,Ie){const Ve=[];if(ve.type==="FeatureCollection")for(let Pe=0;Pe<ve.features.length;Pe++)lo(Ve,ve.features[Pe],Ie,Pe);else lo(Ve,ve.type==="Feature"?ve:{geometry:ve},Ie);return Ve})(j,W);this.tiles={},this.tileCoords=[],ne&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",W.indexMaxZoom,W.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),be=(function(ve,Ie){const Ve=Ie.buffer/Ie.extent;let Pe=ve;const Ne=vo(ve,1,-1-Ve,Ve,0,-1,2,Ie),ut=vo(ve,1,1-Ve,2+Ve,0,-1,2,Ie);return(Ne||ut)&&(Pe=vo(ve,1,-Ve,1+Ve,0,-1,2,Ie)||[],Ne&&(Pe=qr(Ne,1).concat(Pe)),ut&&(Pe=Pe.concat(qr(ut,-1)))),Pe})(be,W),be.length&&this.splitTile(be,0,0,0),ne&&(be.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(j,W,ne,be,ve,Ie,Ve){const Pe=[j,W,ne,be],Ne=this.options,ut=Ne.debug;for(;Pe.length;){be=Pe.pop(),ne=Pe.pop(),W=Pe.pop(),j=Pe.pop();const Je=1<<W,Mt=El(W,ne,be);let $t=this.tiles[Mt];if(!$t&&(ut>1&&console.time("creation"),$t=this.tiles[Mt]=vs(j,W,ne,be,Ne),this.tileCoords.push({z:W,x:ne,y:be}),ut)){ut>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",W,ne,be,$t.numFeatures,$t.numPoints,$t.numSimplified),console.timeEnd("creation"));const $i=`z${W}`;this.stats[$i]=(this.stats[$i]||0)+1,this.total++}if($t.source=j,ve==null){if(W===Ne.indexMaxZoom||$t.numPoints<=Ne.indexMaxPoints)continue}else{if(W===Ne.maxZoom||W===ve)continue;if(ve!=null){const $i=ve-W;if(ne!==Ie>>$i||be!==Ve>>$i)continue}}if($t.source=null,j.length===0)continue;ut>1&&console.time("clipping");const It=.5*Ne.buffer/Ne.extent,yi=.5-It,mi=.5+It,fi=1+It;let Ui=null,Qr=null,fn=null,nn=null,gn=vo(j,Je,ne-It,ne+mi,0,$t.minX,$t.maxX,Ne),Hr=vo(j,Je,ne+yi,ne+fi,0,$t.minX,$t.maxX,Ne);j=null,gn&&(Ui=vo(gn,Je,be-It,be+mi,1,$t.minY,$t.maxY,Ne),Qr=vo(gn,Je,be+yi,be+fi,1,$t.minY,$t.maxY,Ne),gn=null),Hr&&(fn=vo(Hr,Je,be-It,be+mi,1,$t.minY,$t.maxY,Ne),nn=vo(Hr,Je,be+yi,be+fi,1,$t.minY,$t.maxY,Ne),Hr=null),ut>1&&console.timeEnd("clipping"),Pe.push(Ui||[],W+1,2*ne,2*be),Pe.push(Qr||[],W+1,2*ne,2*be+1),Pe.push(fn||[],W+1,2*ne+1,2*be),Pe.push(nn||[],W+1,2*ne+1,2*be+1)}}getTile(j,W,ne){j=+j,W=+W,ne=+ne;const be=this.options,{extent:ve,debug:Ie}=be;if(j<0||j>24)return null;const Ve=1<<j,Pe=El(j,W=W+Ve&Ve-1,ne);if(this.tiles[Pe])return eh(this.tiles[Pe],ve);Ie>1&&console.log("drilling down to z%d-%d-%d",j,W,ne);let Ne,ut=j,Je=W,Mt=ne;for(;!Ne&&ut>0;)ut--,Je>>=1,Mt>>=1,Ne=this.tiles[El(ut,Je,Mt)];return Ne&&Ne.source?(Ie>1&&(console.log("found parent tile z%d-%d-%d",ut,Je,Mt),console.time("drilling down")),this.splitTile(Ne.source,ut,Je,Mt,j,W,ne),Ie>1&&console.timeEnd("drilling down"),this.tiles[Pe]?eh(this.tiles[Pe],ve):null):null}}function El(De,j,W){return 32*((1<<De)*W+j)+De}function Yi(De,j){const W=De.tileID.canonical;if(!this._geoJSONIndex)return void j(null,null);const ne=this._geoJSONIndex.getTile(W.z,W.x,W.y);if(!ne)return void j(null,null);const be=Ne=>Ne.tags&&"3d_elevation_id"in Ne.tags&&"source"in Ne.tags&&Ne.tags.source==="elevation",ve=ne.features.filter((Ne=>be(Ne)));let Ie={_geojsonTileLayer:ne.features};ve.length>0&&(Ie={_geojsonTileLayer:ne.features.filter((Ne=>!be(Ne))),hd_road_elevation:ve});const Ve=new Ai(Ie),Pe=(function(Ne){const ut=new o.bt;for(const Je of Object.keys(Ne))ut.writeMessage(3,Si,{name:Je,features:Ne[Je]});return ut.finish()})(Ie).buffer;j(null,{vectorTile:Ve,rawData:Pe})}class no extends Ye{constructor(j,W,ne,be,ve,Ie,Ve){super(j,W,ne,be,ve,Yi,Ve),Ie&&(this.loadGeoJSON=Ie),this._dynamicIndex=new di}loadData(j,W){const ne=j&&j.request,be=ne&&ne.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(j,((ve,Ie)=>{if(ve||!Ie)return W(ve);if(typeof Ie!="object")return W(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`));{try{if(j.filter){const Pe=o.U(j.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Pe.result==="error")throw new Error(Pe.value.map((Ne=>`${Ne.key}: ${Ne.message}`)).join(", "));Ie.features=Ie.features.filter((Ne=>Pe.value.evaluate({zoom:0},Ne)))}j.dynamic?(Ie.type==="Feature"&&(Ie={type:"FeatureCollection",features:[Ie]}),j.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(Ie.features,this.loaded),j.cluster&&(Ie.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=j.cluster?new yl((function({superclusterOptions:Pe,clusterProperties:Ne}){if(!Ne||!Pe)return Pe;const ut={},Je={},Mt={accumulated:null,zoom:0},$t={properties:null},It=Object.keys(Ne);for(const yi of It){const[mi,fi]=Ne[yi],Ui=o.U(fi),Qr=o.U(typeof mi=="string"?[mi,["accumulated"],["get",yi]]:mi);ut[yi]=Ui.value,Je[yi]=Qr.value}return Pe.map=yi=>{$t.properties=yi;const mi={};for(const fi of It)mi[fi]=ut[fi].evaluate(Mt,$t);return mi},Pe.reduce=(yi,mi)=>{$t.properties=mi;for(const fi of It)Mt.accumulated=yi[fi],yi[fi]=Je[fi].evaluate(Mt,$t)},Pe})(j)).load(Ie.features):j.dynamic?this._dynamicIndex:(function(Pe,Ne){return new ef(Pe,Ne)})(Ie,j.geojsonVtOptions)}catch(Pe){return W(Pe)}const Ve={};if(be){const Pe=G(ne);Pe&&(Ve.resourceTiming={},Ve.resourceTiming[j.source]=JSON.parse(JSON.stringify(Pe)))}W(null,Ve)}}))}reloadTile(j,W){const ne=this.loaded;return ne&&ne[j.uid]?j.partial?W(null,void 0):super.reloadTile(j,W):this.loadTile(j,W)}loadGeoJSON(j,W){if(j.request)o.m(j.request,W);else{if(typeof j.data!="string")return W(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`));setTimeout((()=>{try{return W(null,JSON.parse(j.data))}catch{return W(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`))}}),0)}}getClusterExpansionZoom(j,W){try{W(null,this._geoJSONIndex.getClusterExpansionZoom(j.clusterId))}catch(ne){W(ne)}}getClusterChildren(j,W){try{W(null,this._geoJSONIndex.getChildren(j.clusterId))}catch(ne){W(ne)}}getClusterLeaves(j,W){try{W(null,this._geoJSONIndex.getLeaves(j.clusterId,j.limit,j.offset))}catch(ne){W(ne)}}}class tf{constructor(j,W,ne){this.tileID=new o.aQ(j.tileID.overscaledZ,j.tileID.wrap,j.tileID.canonical.z,j.tileID.canonical.x,j.tileID.canonical.y),this.tileZoom=j.tileZoom,this.uid=j.uid,this.zoom=j.zoom,this.canonical=j.tileID.canonical,this.pixelRatio=j.pixelRatio,this.tileSize=j.tileSize,this.source=j.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=j.projection,this.brightness=W,this.worldview=ne}parse(j,W,ne,be){this.status="parsing";const ve=new o.aQ(ne.tileID.overscaledZ,ne.tileID.wrap,ne.tileID.canonical.z,ne.tileID.canonical.x,ne.tileID.canonical.y),Ie=[],Ve=W.familiesBySource[ne.source],Pe=new o.fn(ve,ne.promoteId);Pe.bucketLayerIDs=[],Pe.is3DTile=!0,o.fC(j).then((Ne=>{if(!Ne)return be(new Error("Could not parse tile"));const ut=Ne.json.extensionsUsed&&Ne.json.extensionsUsed.includes("MAPBOX_mesh_features")||Ne.json.asset.extras&&Ne.json.asset.extras.MAPBOX_mesh_features,Je=Ne.json.extensionsUsed&&Ne.json.extensionsUsed.includes("EXT_meshopt_compression"),Mt=new o.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const $t in Ve)for(const It of Ve[$t]){const yi=It[0];Pe.bucketLayerIDs.push(It.map((Ui=>o.B(Ui.id,Ui.scope)))),yi.recalculate(Mt,[]);const mi=o.fD(Ne,1/o.d7(ne.tileID.canonical)),fi=new o.fE(It,mi,ve,ut,Je,this.brightness,Pe,this.worldview);ut||(fi.needsUpload=!0),Ie.push(fi),fi.evaluate(yi)}this.status="done",be(null,{buckets:Ie,featureIndex:Pe,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})})).catch((Ne=>be(new Error(Ne.message))))}}class Sl{constructor(j,W,ne,be,ve,Ie,Ve,Pe){this.actor=j,this.layerIndex=W,this.availableImages=ne,this.availableModels=be,this.brightness=Ve,this.loading={},this.loaded={},this.worldview=Pe}loadTile(j,W){const ne=j.uid,be=this.loading[ne]=new tf(j,this.brightness,this.worldview);o.bu(j.request,((ve,Ie)=>{const Ve=!this.loading[ne];return delete this.loading[ne],Ve||ve?(be.status="done",Ve||(this.loaded[ne]=be),W(ve)):Ie&&Ie.byteLength!==0?void be.parse(Ie,this.layerIndex,j,((Pe,Ne)=>{be.status="done",this.loaded=this.loaded||{},this.loaded[ne]=be,Pe||!Ne?W(Pe):W(null,Ne)})):(be.status="done",this.loaded[ne]=be,W())}))}reloadTile(j,W){const ne=this.loaded,be=j.uid;if(ne&&ne[be]){const ve=ne[be];ve.projection=j.projection,ve.brightness=j.brightness;const Ie=(Ve,Pe)=>{ve.reloadCallback&&(delete ve.reloadCallback,this.loadTile(j,W)),W(Ve,Pe)};ve.status==="parsing"?ve.reloadCallback=Ie:ve.status==="done"&&this.loadTile(j,W)}}abortTile(j,W){const ne=j.uid;this.loading[ne]&&delete this.loading[ne],W()}removeTile(j,W){const ne=this.loaded,be=j.uid;ne&&ne[be]&&delete ne[be],W()}}class Jc{constructor(j){this.self=j,this.actor=new o.fG(j,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new o.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=o.cm({name:"mercator"}),this.workerSourceTypes={vector:Ye,geojson:no,"raster-dem":it,"raster-array":Rt,"batched-model":Sl},this.workerSources={},this.self.registerWorkerSource=(W,ne)=>{if(this.workerSourceTypes[W])throw new Error(`Worker source with name "${W}" already registered.`);this.workerSourceTypes[W]=ne},this.self.registerRTLTextPlugin=W=>{if(o.fH.isParsed())throw new Error("RTL text plugin already registered.");o.fH.setState({pluginStatus:o.fI.parsed,pluginURL:o.fH.getPluginURL()}),o.fH.applyArabicShaping=W.applyArabicShaping,o.fH.processBidirectionalText=W.processBidirectionalText,o.fH.processStyledBidirectionalText=W.processStyledBidirectionalText;for(const ne of this.rtlPluginParsingListeners)ne(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(j,W,ne){delete this.layerIndexes[j],delete this.availableImages[j],delete this.availableModels[j],delete this.workerSources[j],ne()}checkIfReady(j,W,ne){ne()}setReferrer(j,W){this.referrer=W}spriteLoaded(j,W){this.isSpriteLoaded[j]||(this.isSpriteLoaded[j]={});const{scope:ne,isLoaded:be}=W;if(this.isSpriteLoaded[j][ne]=be,this.workerSources[j]&&this.workerSources[j][ne])for(const ve in this.workerSources[j][ne]){const Ie=this.workerSources[j][ne][ve];for(const Ve in Ie){const Pe=Ie[Ve];Pe instanceof Ye&&(Pe.isSpriteLoaded=be,Pe.fire(new o.z("isSpriteLoaded")))}}}setImages(j,W,ne){this.availableImages[j]||(this.availableImages[j]={});const{scope:be,images:ve}=W;if(this.availableImages[j][be]=ve,this.workerSources[j]&&this.workerSources[j][be]){for(const Ie in this.workerSources[j][be]){const Ve=this.workerSources[j][be][Ie];for(const Pe in Ve)Ve[Pe].availableImages=ve}ne()}else ne()}setModels(j,{scope:W,models:ne},be){if(this.availableModels[j]||(this.availableModels[j]={}),this.availableModels[j][W]=ne,this.workerSources[j]&&this.workerSources[j][W]){for(const ve in this.workerSources[j][W]){const Ie=this.workerSources[j][W][ve];for(const Ve in Ie)Ie[Ve].availableModels=ne}be()}else be()}setProjection(j,W){this.projections[j]=o.cm(W)}setBrightness(j,W,ne){this.brightness=W,ne()}setWorldview(j,W,ne){this.worldview=W,ne()}setLayers(j,W,ne){this.getLayerIndex(j,W.scope).replace(W.layers,W.options),ne()}updateLayers(j,W,ne){this.getLayerIndex(j,W.scope).update(W.layers,W.removedIds,W.options),ne()}loadTile(j,W,ne){W.projection=this.projections[j]||this.defaultProjection,this.getWorkerSource(j,W.type,W.source,W.scope).loadTile(W,ne)}decodeRasterArray(j,W,ne){this.getWorkerSource(j,W.type,W.source,W.scope).decodeRasterArray(W,ne)}reloadTile(j,W,ne){W.projection=this.projections[j]||this.defaultProjection,this.getWorkerSource(j,W.type,W.source,W.scope).reloadTile(W,ne)}abortTile(j,W,ne){this.getWorkerSource(j,W.type,W.source,W.scope).abortTile(W,ne)}removeTile(j,W,ne){this.getWorkerSource(j,W.type,W.source,W.scope).removeTile(W,ne)}removeSource(j,W,ne){if(!(this.workerSources[j]&&this.workerSources[j][W.scope]&&this.workerSources[j][W.scope][W.type]&&this.workerSources[j][W.scope][W.type][W.source]))return;const be=this.workerSources[j][W.scope][W.type][W.source];delete this.workerSources[j][W.scope][W.type][W.source],be.removeSource!==void 0?be.removeSource(W,ne):ne()}loadWorkerSource(j,W,ne){try{this.self.importScripts(W.url),ne()}catch(be){ne(be)}}syncRTLPluginState(j,W,ne){if(o.fH.isParsed())ne(null,!0);else if(o.fH.isParsing())this.rtlPluginParsingListeners.push(ne);else try{o.fH.setState(W);const be=o.fH.getPluginURL();!o.fH.isLoaded()||o.fH.isParsed()||o.fH.isParsing()||be==null||(o.fH.setState({pluginStatus:o.fI.parsing,pluginURL:o.fH.getPluginURL()}),this.self.importScripts(be),o.fH.isParsed()?ne(null,!0):this.rtlPluginParsingListeners.push(ne))}catch(be){ne(be)}}setDracoUrl(j,W){this.dracoUrl=W}getAvailableImages(j,W){this.availableImages[j]||(this.availableImages[j]={});let ne=this.availableImages[j][W];return ne||(ne=[]),ne}getAvailableModels(j,W){this.availableModels[j]||(this.availableModels[j]={});let ne=this.availableModels[j][W];return ne||(ne={}),ne}getLayerIndex(j,W){this.layerIndexes[j]||(this.layerIndexes[j]={});let ne=this.layerIndexes[j][W];return ne||(ne=this.layerIndexes[j][W]=new ie,ne.scope=W),ne}getWorkerSource(j,W,ne,be){const ve=this.workerSources;return ve[j]||(ve[j]={}),ve[j][be]||(ve[j][be]={}),ve[j][be][W]||(ve[j][be][W]={}),this.isSpriteLoaded[j]||(this.isSpriteLoaded[j]={}),ve[j][be][W][ne]||(ve[j][be][W][ne]=new this.workerSourceTypes[W]({send:(Ie,Ve,Pe,Ne,ut,Je)=>this.actor.send(Ie,Ve,Pe,j,ut,Je),scheduler:this.actor.scheduler},this.getLayerIndex(j,be),this.getAvailableImages(j,be),this.getAvailableModels(j,be),this.isSpriteLoaded[j][be],void 0,this.brightness,this.worldview)),ve[j][be][W][ne]}rasterizeImagesWorker(j,W,ne){const be=new Map;for(const[ve,{image:Ie,imageVariant:Ve}]of W.tasks.entries()){const Pe=this.imageRasterizer.rasterize(Ve,Ie,W.scope,j);be.set(ve,Pe)}ne(void 0,be)}removeRasterizedImages(j,W,ne){this.imageRasterizer.removeImagesFromCacheByIds(W.imageIds,W.scope,j),ne()}enforceCacheSizeLimit(j,W){o.fJ(W)}getWorkerPerformanceMetrics(j,W,ne){ne(void 0,void 0)}}return o.fF(self)&&(self.worker=new Jc(self)),Jc})),R(["./shared"],(function(o){var G="3.17.0";const Z={create:"create",load:"load",fullLoad:"fullLoad"},ee={mark(l){performance.mark(l)},measure(l,t,n){performance.measure(l,t,n)}};function ie(l){const t=l.name.split("?")[0];return o.a(t)&&t.includes("mapbox-gl.js")?"javascript":o.a(t)&&t.includes("mapbox-gl.css")?"css":o.b(t)?"fontRange":o.c(t)?"sprite":o.i(t)?"style":o.d(t)?"tilejson":"other"}var re,ue={},oe=(function(){if(re)return ue;function l(c){return!t(c)}function t(c){return typeof window>"u"||typeof document>"u"?"not a browser":(function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var p,_,v=new Blob([""],{type:"text/javascript"}),w=URL.createObjectURL(v);try{_=new Worker(w),p=!0}catch{p=!1}return _&&_.terminate(),URL.revokeObjectURL(w),p})()?(function(){var p=document.createElement("canvas");p.width=p.height=1;var _=p.getContext("2d");if(!_)return!1;var v=_.getImageData(0,0,1,1);return v&&v.width===p.width})()?(n[d=c&&c.failIfMajorPerformanceCaveat]===void 0&&(n[d]=(function(p){var _,v=(function(w){var I=document.createElement("canvas"),C=Object.create(l.webGLContextAttributes);return C.failIfMajorPerformanceCaveat=w,I.getContext("webgl2",C)})(p);if(!v)return!1;try{_=v.createShader(v.VERTEX_SHADER)}catch{return!1}return!(!_||v.isContextLost())&&(v.shaderSource(_,"void main() {}"),v.compileShader(_),v.getShaderParameter(_,v.COMPILE_STATUS)===!0)})(d)),n[d]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var d}re=1,ue.supported=l,ue.notSupportedReason=t;var n={};return l.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},ue})();function ge(l,t,n){const c=document.createElement(l);return t!=null&&(c.className=t),n&&n.appendChild(c),c}function K(l,t,n){const c=document.createElementNS("http://www.w3.org/2000/svg",l);for(const d of Object.keys(t))c.setAttributeNS(null,d,String(t[d]));return n&&n.appendChild(c),c}const Te=typeof document<"u"?document.documentElement&&document.documentElement.style:null,Le=Te&&Te.userSelect!==void 0?"userSelect":"WebkitUserSelect";let Oe;function Ae(){Te&&Le&&(Oe=Te[Le],Te[Le]="none")}function ze(){Te&&Le&&(Te[Le]=Oe)}function Fe(l){l.preventDefault(),l.stopPropagation(),window.removeEventListener("click",Fe,!0)}function Ye(){window.addEventListener("click",Fe,!0),window.setTimeout((()=>{window.removeEventListener("click",Fe,!0)}),0)}function it(l,t){const n=l.getBoundingClientRect();return li(l,n,t)}function jt(l,t){const n=l.getBoundingClientRect(),c=[];for(let d=0;d<t.length;d++)c.push(li(l,n,t[d]));return c}function Rt(l){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&l.button===2&&l.ctrlKey?0:l.button}function li(l,t,n){const c=l.offsetWidth===t.width?1:l.offsetWidth/t.width;return new o.P((n.clientX-t.left)*c,(n.clientY-t.top)*c)}const Xt="01",Pt="NO_ACCESS_TOKEN";class Ai{constructor(t,n,c){this._transformRequestFn=t,this._customAccessToken=n,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){const t=(function(){let n="";for(let c=0;c<10;c++)n+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Xt,n].join(""),tokenExpiresAt:Date.now()+432e5}})();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}normalizeStyleURL(t,n){if(!o.h(t))return t;const c=Li(t);return c.params.push(`sdk=js-${G}`),c.path=`/styles/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeGlyphsURL(t,n){if(!o.h(t))return t;const c=Li(t);return c.path=`/fonts/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeModelURL(t,n){if(!o.h(t))return t;const c=Li(t);return c.path=`/models/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeSourceURL(t,n,c,d){if(!o.h(t))return t;const p=Li(t);return p.path=`/v4/${p.authority}.json`,p.params.push("secure"),c&&p.params.push(`language=${c}`),d&&p.params.push(`worldview=${d}`),this._makeAPIURL(p,this._customAccessToken||n)}normalizeIconsetURL(t,n){const c=Li(t);return o.h(t)?(c.path=`/styles/v1${c.path}/iconset.pbf`,this._makeAPIURL(c,this._customAccessToken||n)):di(c)}normalizeSpriteURL(t,n,c,d){const p=Li(t);return o.h(t)?(p.path=`/styles/v1${p.path}/sprite${n}${c}`,this._makeAPIURL(p,this._customAccessToken||d)):(p.path+=`${n}${c}`,di(p))}normalizeTileURL(t,n,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!o.h(t))return t;const d=Li(t);d.path=d.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${n||c&&d.authority!=="raster"&&c===512?"@2x":""}${o.k.supported?".webp":"$1"}`),d.authority==="raster"?d.path=`/${o.e.RASTER_URL_PREFIX}${d.path}`:d.authority==="rasterarrays"?d.path=`/${o.e.RASTERARRAYS_URL_PREFIX}${d.path}`:d.authority==="3dtiles"?d.path=`/${o.e.TILES3D_URL_PREFIX}${d.path}`:(d.path=d.path.replace(/^.+\/v4\//,"/"),d.path=`/${o.e.TILE_URL_VERSION}${d.path}`);const p=this._customAccessToken||(function(_){for(const v of _){const w=v.match(/^access_token=(.*)$/);if(w)return w[1]}return null})(d.params)||o.e.ACCESS_TOKEN;return o.e.REQUIRE_ACCESS_TOKEN&&p&&this._skuToken&&d.params.push(`sku=${this._skuToken}`),this._makeAPIURL(d,p)}canonicalizeTileURL(t,n){const c=Li(t);if(!c.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!c.path.match(/\.[\w]+$/))return t;let d="mapbox://";c.path.match(/^\/raster\/v1\//)?d+=`raster/${c.path.replace(`/${o.e.RASTER_URL_PREFIX}/`,"")}`:c.path.match(/^\/rasterarrays\/v1\//)?d+=`rasterarrays/${c.path.replace(`/${o.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:d+=`tiles/${c.path.replace(`/${o.e.TILE_URL_VERSION}/`,"")}`;let p=c.params;return n&&(p=p.filter((_=>!_.match(/^access_token=/)))),p.length&&(d+=`?${p.join("&")}`),d}canonicalizeTileset(t,n){const c=!!n&&o.h(n),d=[];for(const p of t.tiles||[])o.j(p)?d.push(this.canonicalizeTileURL(p,c)):d.push(p);return d}_makeAPIURL(t,n){const c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",d=Li(o.e.API_URL);if(t.protocol=d.protocol,t.authority=d.authority,t.protocol==="http"){const p=t.params.indexOf("secure");p>=0&&t.params.splice(p,1)}if(d.path!=="/"&&(t.path=`${d.path}${t.path}`),!o.e.REQUIRE_ACCESS_TOKEN)return di(t);if(n=n||o.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!n)throw new Error(`An API access token is required to use Mapbox GL. ${c}`);if(n[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${c}`)}return t.params=t.params.filter((p=>p.indexOf("access_token")===-1)),t.params.push(`access_token=${n||""}`),di(t)}}const rr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Li(l){const t=l.match(rr);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function di(l){const t=l.params.length?`?${l.params.join("&")}`:"";return`${l.protocol}://${l.authority}${l.path}${t}`}const Bi="mapbox.eventData";function jr(l){if(!l)return null;const t=l.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(o.l(t[1]))}catch{return null}}class Ln{constructor(t){this.type=t,this.anonId=null,this.anonIdTimestamp=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const n=jr(o.e.ACCESS_TOKEN);let c="";return c=n&&n.u?o.f(n.u):o.e.ACCESS_TOKEN||"",t?`${Bi}.${t}:${c}`:`${Bi}:${c}`}fetchEventData(){const t=o.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.getStorageKey("uuidTimestamp");if(t)try{const p=localStorage.getItem(n);p&&(this.eventData=JSON.parse(p));const _=localStorage.getItem(c);_&&(this.anonId=_);const v=localStorage.getItem(d);v&&(this.anonIdTimestamp=Number(v));const w=Date.now()-864e5;(!this.anonIdTimestamp||this.anonIdTimestamp<w)&&this.refreshUUID()}catch{o.w("Unable to read from LocalStorage")}}refreshUUID(){this.anonId=o.u(),this.anonIdTimestamp=Date.now()}saveEventData(){const t=o.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.getStorageKey("uuidTimestamp"),p=this.anonId,_=this.anonIdTimestamp;if(t&&p)try{localStorage.setItem(c,p),Object.keys(this.eventData).length>=1&&localStorage.setItem(n,JSON.stringify(this.eventData)),_&&localStorage.setItem(d,_.toString())}catch{o.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,n,c,d){if(!o.e.EVENTS_URL)return;const p=Li(o.e.EVENTS_URL);p.params.push(`access_token=${d||o.e.ACCESS_TOKEN||""}`);const _={event:this.type,created:new Date(t).toISOString()},v=n?Object.assign(_,n):_,w={url:di(p),headers:{"Content-Type":"text/plain"},body:JSON.stringify([v])};this.pendingRequest=o.p(w,(I=>{this.pendingRequest=null,c(I),this.saveEventData(),this.processRequests(d)}))}queueRequest(t,n){this.queue.push(t),this.processRequests(n)}}class Nn extends Ln{constructor(t){super("metrics"),t&&(this.data=t)}postMetricsEvent(t){if(!o.e.EVENTS_URL||!t&&!o.e.ACCESS_TOKEN)return;this.anonId||this.fetchEventData(),o.v(this.anonId)||this.refreshUUID();const n=Object.assign({},this.data,{sessionId:this.anonId});this.queueRequest({timestamp:Date.now(),payload:n},t)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:n,payload:c}=this.queue.shift();this.postEvent(n,c,(()=>{}),t)}}const An=new class extends Ln{constructor(l){super("appUserTurnstile"),this._customAccessToken=l}postTurnstileEvent(l,t){o.e.EVENTS_URL&&o.e.ACCESS_TOKEN&&Array.isArray(l)&&l.some((n=>o.h(n)||o.j(n)))&&this.queueRequest(Date.now(),t)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.anonIdTimestamp&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=jr(o.e.ACCESS_TOKEN),n=t?t.u:o.e.ACCESS_TOKEN;let c=n!==this.eventData.tokenU;o.v(this.anonId)||(this.refreshUUID(),c=!0);const d=this.queue.shift();if(this.eventData.lastSuccess){const p=new Date(this.eventData.lastSuccess),_=new Date(d),v=(d-this.eventData.lastSuccess)/864e5;c=c||v>=1||v<-1||p.getDate()!==_.getDate()}else c=!0;c?this.postEvent(d,{sdkIdentifier:"mapbox-gl-js",sdkVersion:G,skuId:Xt,"enabled.telemetry":!1,userId:this.anonId},(p=>{p||(this.eventData.lastSuccess=d,this.eventData.tokenU=n)}),l):this.processRequests()}},yr=An.postTurnstileEvent.bind(An),qn=new class extends Ln{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(l,t,n,c){this.skuToken=t,this.errorCb=c,o.e.EVENTS_URL&&(n||o.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(Pt)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||(this.anonId&&this.anonIdTimestamp||this.fetchEventData(),o.v(this.anonId)||this.refreshUUID(),this.postEvent(n,{sdkIdentifier:"mapbox-gl-js",sdkVersion:G,skuId:Xt,skuToken:this.skuToken,userId:this.anonId},(c=>{c?this.errorCb(c):t&&(this.success[t]=!0)}),l))}remove(){this.errorCb=null}},ii=qn.postMapLoadEvent.bind(qn),Si=new class extends Ln{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(l){let t=this.mapInstanceIdMap.get(l);return t||(t=o.u(),this.mapInstanceIdMap.set(l,t)),t}getEventId(l){const t=this.eventIdPerMapInstanceMap.get(l)||0;return this.eventIdPerMapInstanceMap.set(l,t+1),t}postStyleLoadEvent(l,t){const{map:n,style:c,importedStyles:d}=t;if(!o.e.EVENTS_URL||!l&&!o.e.ACCESS_TOKEN)return;const p=this.getMapInstanceId(n),_={mapInstanceId:p,eventId:this.getEventId(p),style:c};d.length&&(_.importedStyles=d),this.queueRequest({timestamp:Date.now(),payload:_},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:n}=this.queue.shift();this.postEvent(t,n,(()=>{}),l)}},si=Si.postStyleLoadEvent.bind(Si),Ti=new Nn({attributes:[{name:"maps/js/layer-animations/style-with-appearances"}]}),ui=Ti.postMetricsEvent.bind(Ti),ki=new Nn({attributes:[{name:"maps/js/layer-animations/runtime-appearances"}]}),wr=ki.postMetricsEvent.bind(ki),Hn=new class extends Ln{constructor(){super("gljs.performance")}postPerformanceEvent(l,t){o.e.EVENTS_URL&&(l||o.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:n}=this.queue.shift(),c=(function(d){const p=performance.getEntriesByType("resource"),_=performance.getEntriesByType("mark"),v=(function(z){const N={};if(z){for(const B in z)if(B!=="other")for(const H of z[B]){const q=`${B}ResolveRangeMin`,Y=`${B}ResolveRangeMax`,te=`${B}RequestCount`,J=`${B}RequestCachedCount`;N[q]=Math.min(N[q]||1/0,H.startTime),N[Y]=Math.max(N[Y]||-1/0,H.responseEnd);const _e=he=>{N[he]===void 0&&(N[he]=0),++N[he]};H.transferSize!==void 0&&H.transferSize===0&&_e(J),_e(te)}}return N})((function(z,N){const B={};if(z)for(const H of z){const q=N(H);B[q]===void 0&&(B[q]=[]),B[q].push(H)}return B})(p,ie)),w=window.devicePixelRatio,I=navigator.connection||navigator.mozConnection||navigator.webkitConnection,C=I?I.effectiveType:void 0,O={counters:[],metadata:[],attributes:[]},D=(z,N,B)=>{B!=null&&z.push({name:N,value:B.toString()})};for(const z in v)D(O.counters,z,v[z]);if(d.interactionRange[0]!==1/0&&d.interactionRange[1]!==-1/0&&(D(O.counters,"interactionRangeMin",d.interactionRange[0]),D(O.counters,"interactionRangeMax",d.interactionRange[1])),_)for(const z of Object.values(Z)){const N=_.find((B=>B.name===z));N&&D(O.counters,z,N.startTime)}return D(O.counters,"visibilityHidden",d.visibilityHidden),D(O.attributes,"style",(function(z){if(z)for(const N of z){const B=N.name.split("?")[0];if(o.i(B)){const H=B.split("/").slice(-2);if(H.length===2)return`mapbox://styles/${H[0]}/${H[1]}`}}})(p)),D(O.attributes,"terrainEnabled",d.terrainEnabled?"true":"false"),D(O.attributes,"fogEnabled",d.fogEnabled?"true":"false"),D(O.attributes,"projection",d.projection),D(O.attributes,"zoom",d.zoom),D(O.metadata,"devicePixelRatio",w),D(O.metadata,"connectionEffectiveType",C),D(O.metadata,"navigatorUserAgent",navigator.userAgent),D(O.metadata,"screenWidth",window.screen.width),D(O.metadata,"screenHeight",window.screen.height),D(O.metadata,"windowWidth",window.innerWidth),D(O.metadata,"windowHeight",window.innerHeight),D(O.metadata,"mapWidth",d.width/w),D(O.metadata,"mapHeight",d.height/w),D(O.metadata,"webglRenderer",d.renderer),D(O.metadata,"webglVendor",d.vendor),D(O.metadata,"sdkVersion",G),D(O.metadata,"sdkIdentifier","mapbox-gl-js"),O})(n);for(const d of c.metadata);for(const d of c.counters);for(const d of c.attributes);this.postEvent(t,c,(()=>{}),l)}},kr=Hn.postPerformanceEvent.bind(Hn),Rn=new class extends Ln{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(l,t,n,c){if(!o.e.API_URL||!o.e.SESSION_PATH)return;const d=Li(o.e.API_URL+o.e.SESSION_PATH);d.params.push(`sku=${t||""}`),d.params.push(`access_token=${c||o.e.ACCESS_TOKEN||""}`);const p={url:di(d),headers:{"Content-Type":"text/plain"}};this.pendingRequest=o.g(p,(_=>{this.pendingRequest=null,n(_),this.saveEventData(),this.processRequests(c)}))}getSessionAPI(l,t,n,c){this.skuToken=t,this.errorCb=c,o.e.SESSION_PATH&&o.e.API_URL&&(n||o.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(Pt)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||this.getSession(n,this.skuToken,(c=>{c?this.errorCb(c):t&&(this.success[t]=!0)}),l)}remove(){this.errorCb=null}},yo=Rn.getSessionAPI.bind(Rn),Gr=new Set;function Jr(l,t){t?Gr.add(l):Gr.delete(l)}class Kr{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,n){this._updatedSourceCaches[t]=n,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const n=t.scope;this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._updatedLayers[n].add(t.id),this.setDirty()}removeLayer(t){const n=t.scope;this._removedLayers[n]=this._removedLayers[n]||{},this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._removedLayers[n][t.id]=t,this._updatedLayers[n].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const n in this._updatedLayers)t[n]=t[n]||{},t[n].updatedIds=Array.from(this._updatedLayers[n].values());for(const n in this._removedLayers)t[n]=t[n]||{},t[n].removedIds=Object.keys(this._removedLayers[n]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,n){this._updatedImages[n]=this._updatedImages[n]||new Set,this._updatedImages[n].add(o.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function yl(l){const{userImage:t}=l;return!!(t&&t.render&&t.render())&&(l.data.replace(new Uint8Array(t.data.buffer)),!0)}class Vo extends o.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&o.r()&&(this.imageRasterizerDispatcher=new o.D(o.t(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new o.q({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);const n=this.atlasTexture.get(t);n&&(n.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,n){this.imageProviders.has(n)||this.imageProviders.set(n,new Map),this.imageProviders.get(n).set(t.id,t)}removeImageProvider(t,n){this.imageProviders.has(n)&&this.imageProviders.get(n).delete(t)}getPendingImageProviders(){const t=[];for(const n of this.imageProviders.values())for(const c of n.values())c.hasPendingRequests()&&t.push(c);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new o.x),this._imageRasterizer}isLoaded(){for(const t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,n){if(this.loaded.get(n)!==t&&(this.loaded.set(n,t),t)){for(const{ids:c,callback:d}of this.requestors)this._notify(c,n,d);this.requestors=[]}}hasImage(t,n){return!!this.getImage(t,n)}getImage(t,n){return this.images.get(n).get(t.toString())}addImage(t,n,c){this._validate(t,c)&&this.images.get(n).set(t.toString(),c)}_validate(t,n){let c=!0;return this._validateStretch(n.stretchX,n.data&&n.data.width)||(this.fire(new o.y(new Error(`Image "${t.name}" has invalid "stretchX" value`))),c=!1),this._validateStretch(n.stretchY,n.data&&n.data.height)||(this.fire(new o.y(new Error(`Image "${t.name}" has invalid "stretchY" value`))),c=!1),this._validateContent(n.content,n)||(this.fire(new o.y(new Error(`Image "${t.name}" has invalid "content" value`))),c=!1),c}_validateStretch(t,n){if(!t)return!0;let c=0;for(const d of t){if(d[0]<c||d[1]<d[0]||n<d[1])return!1;c=d[1]}return!0}_validateContent(t,n){return t?t.length!==4||!n.usvg&&(t[0]<0||n.data.width<t[0]||t[1]<0||n.data.height<t[1]||t[2]<0||n.data.width<t[2]||t[3]<0||n.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,n,c){const d=this.images.get(n).get(t.toString());c.version=d.version+1,this.images.get(n).set(t.toString(),c),this.updatedImages.get(n).add(t),this.removeFromImageRasterizerCache(t,n)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,n){this.spriteFormat!=="raster"&&(o.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:n}):this.imageRasterizer.removeImagesFromCacheByIds([t],n))}removeImage(t,n){const c=this.images.get(n),d=c.get(t.toString());c.delete(t.toString()),this.patterns.get(n).delete(t.toString()),this.removeFromImageRasterizerCache(t,n),d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map((n=>o.I.from(n)))}getImages(t,n,c){const d=[],p=[],_=this.imageProviders.get(n);for(const C of t){if(!C.iconsetId){d.push(C);continue}const O=_.get(C.iconsetId);O&&(this.getImage(C,n)?p.push(C):O.addPendingRequest(C))}if(d.length===0)return void this._notify(p,n,c);let v=!0;const w=!!this.loaded.get(n),I=this.images.get(n);if(!w)for(const C of d)I.has(C.toString())||(v=!1);w||v?this._notify(d,n,c):this.requestors.push({ids:d,scope:n,callback:c})}rasterizeImages(t,n){const c=new Map,{tasks:d,scope:p}=t;for(const[_,v]of d.entries()){const w=this.getImage(v.id,p);w&&c.set(_,{image:w,imageVariant:v})}this._rasterizeImages(p,c,n)}_rasterizeImages(t,n,c){if(o.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:n,scope:t},c);else{const d=new Map;for(const[p,{image:_,imageVariant:v}]of n.entries())d.set(p,this.imageRasterizer.rasterize(v,_,t,0));c(void 0,d)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,n,c){const d=this.images.get(n),p=new Map;for(const _ of t){if(!d.get(_.toString())){if(_.iconsetId)continue;this.fire(new o.z("styleimagemissing",{id:_.name}))}const v=d.get(_.toString());if(!v){o.w(`Image "${_.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const w={data:v.usvg?null:v.data.clone(),pixelRatio:v.pixelRatio,sdf:v.sdf,usvg:v.usvg,version:v.version,stretchX:v.stretchX,stretchY:v.stretchY,content:v.content,hasRenderCallback:!!(v.userImage&&v.userImage.render)};v.usvg&&Object.assign(w,{width:v.icon.usvg_tree.width,height:v.icon.usvg_tree.height}),p.set(o.I.toString(_),w)}c(null,p)}getPixelSize(t){const{width:n,height:c}=this.atlasImage.get(t);return{width:n,height:c}}getPattern(t,n,c){const d=t.toString(),p=this.patterns.get(n),_=p.get(d),v=this.getImage(t,n);if(!v)return null;if(_){if(_.position.version===v.version)return _.position;_.position.version=v.version}else{if(v.usvg&&!v.data){const w=this.getPatternInFlightId(d,n);if(this.patternsInFlight.has(w))return null;this.patternsInFlight.add(w);const I=new o.A(t).scaleSelf(o.o.devicePixelRatio),C=new Map([[I.toString(),{image:v,imageVariant:I}]]);return this._rasterizeImages(n,C,((O,D)=>this.storePatternImage(I,n,v,c,D))),null}this.storePattern(t,n,v)}return this._updatePatternAtlas(n,c),p.get(d).position}getPatternInFlightId(t,n){return o.B(t,n)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,n,c,d,p){const _=t.toString(),v=p?p.get(_):void 0;v&&(c.data=v,this.storePattern(t.id,n,c),this._updatePatternAtlas(n,d),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),n)))}storePattern(t,n,c){const d={w:c.data.width+2*o.C,h:c.data.height+2*o.C,x:0,y:0},p=new o.F(d,c,o.C);this.patterns.get(n).set(t.toString(),{bin:d,position:p})}destroyAtlasTextures(){for(const t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,n){const c=t.gl;let d=this.atlasTexture.get(n);d?this.dirty&&(d.update(this.atlasImage.get(n)),this.dirty=!1):(d=new o.T(t,this.atlasImage.get(n),c.RGBA8),this.atlasTexture.set(n,d)),d.bind(c.LINEAR,c.CLAMP_TO_EDGE)}_updatePatternAtlas(t,n){const c=this.patterns.get(t),d=Array.from(c.values()).map((({bin:I})=>I)),{w:p,h:_}=o.G(d),v=this.atlasImage.get(t);v.resize({width:p||1,height:_||1});const w=this.images.get(t);for(const[I,{bin:C,position:O}]of c.entries()){let D=O.padding;const z=C.x+D,N=C.y+D,B=w.get(I).data,H=B.width,q=B.height;D=D>1?D-1:D,o.q.copy(B,v,{x:0,y:0},{x:z,y:N},{width:H,height:q},n),o.q.copy(B,v,{x:0,y:q-D},{x:z,y:N-D},{width:H,height:D},n),o.q.copy(B,v,{x:0,y:0},{x:z,y:N+q},{width:H,height:D},n),o.q.copy(B,v,{x:H-D,y:0},{x:z-D,y:N},{width:D,height:q},n),o.q.copy(B,v,{x:0,y:0},{x:z+H,y:N},{width:D,height:q},n),o.q.copy(B,v,{x:H-D,y:q-D},{x:z-D,y:N-D},{width:D,height:D},n),o.q.copy(B,v,{x:0,y:q-D},{x:z+H,y:N-D},{width:D,height:D},n),o.q.copy(B,v,{x:0,y:0},{x:z+H,y:N+q},{width:D,height:D},n),o.q.copy(B,v,{x:H-D,y:0},{x:z-D,y:N+q},{width:D,height:D},n)}this.dirty=!0}beginFrame(){for(const t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,n){const c=this.images.get(n);for(const d of t){if(this.callbackDispatchedThisFrame.get(n).has(d.toString()))continue;this.callbackDispatchedThisFrame.get(n).add(d.toString());const p=c.get(d.toString());yl(p)&&this.updateImage(d,n,p)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function _s(l){const t=l.value,n=l.valueSpec,c=l.style,d=l.styleSpec,p=l.key,_=l.arrayElementValidator||qr;if(!Array.isArray(t))return[new o.V(p,t,`array expected, ${o.K(t)} found`)];if(n.length&&t.length!==n.length)return[new o.V(p,t,`array length ${n.length} expected, length ${t.length} found`)];if(n["min-length"]&&t.length<n["min-length"])return[new o.V(p,t,`array length at least ${n["min-length"]} expected, length ${t.length} found`)];let v={type:n.value,values:n.values,minimum:n.minimum,maximum:n.maximum,function:void 0};d.$version<7&&(v.function=n.function),o.H(n.value)&&(v=n.value);let w=[];for(let I=0;I<t.length;I++)w=w.concat(_({array:t,arrayIndex:I,value:t[I],valueSpec:v,style:c,styleSpec:d,key:`${p}[${I}]`},!0));return w}function Ns(l){const t=l.key,n=l.value,c=l.valueSpec;if(!o.L(n))return[new o.V(t,n,`number expected, ${o.K(n)} found`)];if(n!=n)return[new o.V(t,n,"number expected, NaN found")];if("minimum"in c){let d=c.minimum;if(Array.isArray(c.minimum)&&(d=c.minimum[l.arrayIndex]),n<d)return[new o.V(t,n,`${n} is less than the minimum value ${d}`)]}if("maximum"in c){let d=c.maximum;if(Array.isArray(c.maximum)&&(d=c.maximum[l.arrayIndex]),n>d)return[new o.V(t,n,`${n} is greater than the maximum value ${d}`)]}return[]}function ja(l){const t=l.key,n=l.value;if(!o.H(n))return[new o.V(t,n,`object expected, ${o.K(n)} found`)];const c=l.valueSpec,d=o.J(n.type);let p,_,v,w={};const I=d!=="categorical"&&n.property===void 0,C=!I,O=(function(B){const H=B.stops;return Array.isArray(H)&&Array.isArray(H[0])&&o.H(H[0][0])})(n),D=Zn({key:l.key,value:l.value,valueSpec:l.styleSpec.function,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{stops:function(B){if(d==="identity")return[new o.V(B.key,B.value,'identity function may not have a "stops" property')];let H=[];const q=B.value;return H=H.concat(_s({key:B.key,value:q,valueSpec:B.valueSpec,style:B.style,styleSpec:B.styleSpec,arrayElementValidator:z})),Array.isArray(q)&&q.length===0&&H.push(new o.V(B.key,q,"array must have at least one stop")),H},default:function(B){return qr({key:B.key,value:B.value,valueSpec:c,style:B.style,styleSpec:B.styleSpec})}}});return d==="identity"&&I&&D.push(new o.V(l.key,l.value,'missing required property "property"')),d==="identity"||n.stops||D.push(new o.V(l.key,l.value,'missing required property "stops"')),d==="exponential"&&c.expression&&!o.M(c)&&D.push(new o.V(l.key,l.value,"exponential functions not supported")),l.styleSpec.$version>=8&&(C&&!o.N(c)?D.push(new o.V(l.key,l.value,"property functions not supported")):I&&!o.O(c)&&D.push(new o.V(l.key,l.value,"zoom functions not supported"))),d!=="categorical"&&!O||n.property!==void 0||D.push(new o.V(l.key,l.value,'"property" property is required')),D;function z(B){let H=[];const q=B.value,Y=B.key;if(!Array.isArray(q))return[new o.V(Y,q,`array expected, ${o.K(q)} found`)];if(q.length!==2)return[new o.V(Y,q,`array length 2 expected, length ${q.length} found`)];if(O){if(!o.H(q[0]))return[new o.V(Y,q,`object expected, ${o.K(q[0])} found`)];const te=q[0];if(te.zoom===void 0)return[new o.V(Y,q,"object stop key must have zoom")];if(te.value===void 0)return[new o.V(Y,q,"object stop key must have value")];const J=o.J(te.zoom);if(typeof J!="number")return[new o.V(Y,te.zoom,"stop zoom values must be numbers")];if(v&&v>J)return[new o.V(Y,te.zoom,"stop zoom values must appear in ascending order")];J!==v&&(v=J,_=void 0,w={}),H=H.concat(Zn({key:`${Y}[0]`,value:q[0],valueSpec:{zoom:{}},style:B.style,styleSpec:B.styleSpec,objectElementValidators:{zoom:Ns,value:N}}))}else H=H.concat(N({key:`${Y}[0]`,value:q[0],style:B.style,styleSpec:B.styleSpec},q));return o.Q(o.S(q[1]))?H.concat([new o.V(`${Y}[1]`,q[1],"expressions are not allowed in function stops.")]):H.concat(qr({key:`${Y}[1]`,value:q[1],valueSpec:c,style:B.style,styleSpec:B.styleSpec}))}function N(B,H){const q=o.K(B.value),Y=o.J(B.value),te=B.value!==null?B.value:H;if(p){if(q!==p)return[new o.V(B.key,te,`${q} stop domain type must match previous stop domain type ${p}`)]}else p=q;if(q!=="number"&&q!=="string"&&q!=="boolean"&&typeof Y!="number"&&typeof Y!="string"&&typeof Y!="boolean")return[new o.V(B.key,te,"stop domain value must be a number, string, or boolean")];if(q!=="number"&&d!=="categorical"){let J=`number expected, ${q} found`;return o.N(c)&&d===void 0&&(J+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new o.V(B.key,te,J)]}return d!=="categorical"||q!=="number"||typeof Y=="number"&&isFinite(Y)&&Math.floor(Y)===Y?d!=="categorical"&&q==="number"&&typeof Y=="number"&&typeof _=="number"&&_!==void 0&&Y<_?[new o.V(B.key,te,"stop domain values must appear in ascending order")]:(_=Y,d==="categorical"&&Y in w?[new o.V(B.key,te,"stop domain values must be unique")]:(w[Y]=!0,[])):[new o.V(B.key,te,`integer expected, found ${String(Y)}`)]}}function Jn(l){const t=(l.expressionContext==="property"?o.W:o.U)(o.S(l.value),l.valueSpec);if(t.result==="error")return t.value.map((c=>new o.V(`${l.key}${c.key}`,l.value,c.message)));const n=t.value.expression||t.value._styleExpression.expression;if(l.expressionContext==="property"&&l.propertyKey==="text-font"&&!n.outputDefined())return[new o.V(l.key,l.value,`Invalid data expression for "${l.propertyKey}". Output values must be contained as literals within the expression.`)];if(l.expressionContext==="property"&&l.propertyType==="layout"&&!o.Z(n))return[new o.V(l.key,l.value,'"feature-state" data expressions are not supported with layout properties.')];if(l.expressionContext==="filter")return la(n,l);if(l.expressionContext==="appearance")return tc(n,l);if(l.expressionContext&&l.expressionContext.indexOf("cluster")===0){if(!o.X(n,["zoom","feature-state"]))return[new o.V(l.key,l.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(l.expressionContext==="cluster-initial"&&!o.Y(n))return[new o.V(l.key,l.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function la(l,t){const n=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const d of t.valueSpec.expression.parameters)n.delete(d);if(n.size===0)return[];const c=[];return l instanceof o._&&n.has(l.name)?[new o.V(t.key,t.value,`["${l.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(l.eachChild((d=>{c.push(...la(d,t))})),c)}function tc(l,t){const n=new Set;if(t.valueSpec&&t.valueSpec.expression)for(const d of t.valueSpec.expression.parameters)n.add(d);if(n.size===0)return[];const c=[];return l instanceof o._&&!n.has(l.name)?[new o.V(t.key,t.value,`["${l.name}"] is not an allowed parameter`)]:(l.eachChild((d=>{c.push(...tc(d,t))})),c)}function gs(l){const t=l.key,n=l.value,c=l.valueSpec,d=[];return Array.isArray(c.values)?c.values.indexOf(o.J(n))===-1&&d.push(new o.V(t,n,`expected one of [${c.values.join(", ")}], ${JSON.stringify(n)} found`)):Object.keys(c.values).indexOf(o.J(n))===-1&&d.push(new o.V(t,n,`expected one of [${Object.keys(c.values).join(", ")}], ${JSON.stringify(n)} found`)),d}function ca(l){return o.a2(o.S(l.value))?Jn(Object.assign({},l,{expressionContext:"filter",valueSpec:l.styleSpec[`filter_${l.layerType||"fill"}`]})):lo(l)}function lo(l){const t=l.value,n=l.key;if(!Array.isArray(t))return[new o.V(n,t,`array expected, ${o.K(t)} found`)];if(t.length<1)return[new o.V(n,t,"filter array must have at least 1 element")];const c=l.styleSpec;let d=gs({key:`${n}[0]`,value:t[0],valueSpec:c.filter_operator});const p=()=>{t.length>=2&&(o.a0(t[1])||d.push(new o.V(`${n}[1]`,t[1],`string expected, ${o.K(t[1])} found`)));for(let _=2;_<t.length;_++)o.J(t[1])==="$type"?d=d.concat(gs({key:`${n}[${_}]`,value:t[_],valueSpec:c.geometry_type})):o.a0(t[_])||o.L(t[_])||o.$(t[_])||d.push(new o.V(`${n}[${_}]`,t[_],`string, number, or boolean expected, ${o.K(t[_])} found.`))};switch(o.J(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&o.J(t[1])==="$type"&&d.push(new o.V(n,t,`"$type" cannot be use with operator "${t[0]}"`)),t.length!==3&&d.push(new o.V(n,t,`filter array for operator "${t[0]}" must have 3 elements`)),p();break;case"==":case"!=":t.length!==3&&d.push(new o.V(n,t,`filter array for operator "${t[0]}" must have 3 elements`)),p();break;case"in":case"!in":p();break;case"any":case"all":case"none":for(let _=1;_<t.length;_++)d=d.concat(lo({key:`${n}[${_}]`,value:t[_],style:l.style,styleSpec:l.styleSpec}));break;case"has":case"!has":t.length!==2?d.push(new o.V(n,t,`filter array for "${t[0]}" operator must have 2 elements`)):o.a0(t[1])||d.push(new o.V(`${n}[1]`,t[1],`string expected, ${o.K(t[1])} found`))}return d}function vl(l,t){const n=l.key,c=l.style,d=l.layer,p=l.styleSpec,_=l.value,v=l.objectKey,w=p[`${t}_${l.layerType}`];if(!w)return[];const I=v.match(/^(.*)-use-theme$/);if(I&&w[I[1]])return o.Q(o.S(_))?[].concat(qr({key:n,value:_,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:v})):qr({key:n,value:_,valueSpec:{type:"string"},style:c,styleSpec:p});const C=v.match(/^(.*)-transition$/);if(t==="paint"&&C&&w[C[1]]&&w[C[1]].transition)return qr({key:n,value:_,valueSpec:p.transition,style:c,styleSpec:p});const O=l.valueSpec||w[v];if(!O)return[new o.a3(n,_,`unknown property "${v}"`)];let D;if(o.a0(_)&&o.N(O)&&!O.tokens&&(D=/^{([^}]+)}$/.exec(_))){const N=`\`{ "type": "identity", "property": ${D?JSON.stringify(D[1]):'"_"'} }\``;return[new o.V(n,_,`"${v}" does not support interpolation syntax
Use an identity property function instead: ${N}.`)]}const z=[];if(l.layerType==="symbol")v!=="text-field"||!c||c.glyphs||c.imports||z.push(new o.V(n,_,'use of "text-field" requires a style "glyphs" property')),v==="text-font"&&o.a4(o.S(_))&&o.J(_.type)==="identity"&&z.push(new o.V(n,_,'"text-font" does not support identity functions'));else if(l.layerType==="model"&&t==="paint"&&d&&d.layout&&d.layout.hasOwnProperty("model-id")&&o.N(O)&&(o.a5(O)||o.O(O))){const N=o.W(o.S(_),O).value,B="expression"in N&&N.expression||"_styleExpression"in N&&N._styleExpression&&N._styleExpression.expression;B&&!o.X(B,["measure-light"])&&(v==="model-emissive-strength"&&o.Y(B)&&o.Z(B)||z.push(new o.V(n,_,`${v} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return z.concat(qr({key:l.key,value:_,valueSpec:O,style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:v}))}function xl(l){return vl(l,"paint")}function bl(l){return vl(l,"layout")}function ic(l){let t=[];const n=l.value,c=l.key,d=l.style,p=l.styleSpec;if(!o.H(n))return[new o.V(c,n,"object expected")];n.type||n.ref||t.push(new o.V(c,n,'either "type" or "ref" is required'));let _=o.J(n.type);const v=o.J(n.ref);if(n.id){const w=o.J(n.id);for(let I=0;I<l.arrayIndex;I++){const C=d.layers[I];o.J(C.id)===w&&t.push(new o.V(c,n.id,`duplicate layer id "${w}", previously used at line ${C.id.__line__}`))}}if("ref"in n){let w;["type","source","source-layer","filter","layout"].forEach((I=>{I in n&&t.push(new o.V(c,n[I],`"${I}" is prohibited for ref layers`))})),d.layers.forEach((I=>{o.J(I.id)===v&&(w=I)})),w?w.ref?t.push(new o.V(c,n.ref,"ref cannot reference another ref layer")):_=o.J(w.type):typeof v=="string"&&t.push(new o.V(c,n.ref,`ref layer "${v}" not found`))}else if(_!=="background"&&_!=="sky"&&_!=="slot")if(n.source)if(o.a0(n.source)){const w=d.sources&&d.sources[n.source],I=w&&o.J(w.type);w?I==="vector"&&_==="raster"?t.push(new o.V(c,n.source,`layer "${n.id}" requires a raster source`)):I==="raster"&&_!=="raster"?t.push(new o.V(c,n.source,`layer "${n.id}" requires a vector source`)):I!=="vector"||n["source-layer"]?I==="raster-dem"&&_!=="hillshade"?t.push(new o.V(c,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):I!=="raster-array"||["raster","raster-particle"].includes(_)?_==="line"&&n.paint&&(n.paint["line-gradient"]||n.paint["line-trim-offset"])&&I==="geojson"&&!w.lineMetrics?t.push(new o.V(c,n,`layer "${n.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):_==="raster-particle"&&I!=="raster-array"&&t.push(new o.V(c,n.source,`layer "${n.id}" requires a 'raster-array' source.`)):t.push(new o.V(c,n.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new o.V(c,n,`layer "${n.id}" must specify a "source-layer"`)):t.push(new o.V(c,n.source,`source "${n.source}" not found`))}else t.push(new o.V(`${c}.source`,n.source,'"source" must be a string'));else t.push(new o.V(c,n,'missing required property "source"'));return t=t.concat(Zn({key:c,value:n,valueSpec:p.layer,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":()=>[],type:()=>qr({key:`${c}.type`,value:n.type,valueSpec:p.layer.type,style:l.style,styleSpec:l.styleSpec,object:n,objectKey:"type"}),filter:w=>ca(Object.assign({layerType:_},w)),layout:w=>Zn({layer:n,key:w.key,value:w.value,valueSpec:{},style:w.style,styleSpec:w.styleSpec,objectElementValidators:{"*":I=>bl(Object.assign({layerType:_},I))}}),paint:w=>Zn({layer:n,key:w.key,value:w.value,valueSpec:{},style:w.style,styleSpec:w.styleSpec,objectElementValidators:{"*":I=>xl(Object.assign({layerType:_,layer:n},I))}}),appearances(w){const I=_s({key:w.key,value:w.value,valueSpec:w.valueSpec,style:w.style,styleSpec:w.styleSpec,arrayElementValidator:D=>(function(z){const{key:N,layer:B,layerType:H}=z,q=o.J(z.value),Y=o.J(q.name),te=o.J(q.condition),J=Zn({key:N,value:q,valueSpec:z.styleSpec.appearance,style:z.style,styleSpec:z.styleSpec,objectElementValidators:{condition:_e=>(function(he){const pe=[];return pe.push(...Jn({key:he.key,value:he.object.condition,valueSpec:o.a6.appearance.condition,expressionContext:"appearance"})),pe})(Object.assign({layer:B,layerType:H},_e)),properties:_e=>(function(he){const pe=[],{styleSpec:ce,layer:se,layerType:ye}=he,Ce=ce[`paint_${ye}`],Se=ce[`layout_${ye}`],Ue=he.object[he.objectKey];for(const je in Ue){const Xe=je in Ce?"paint":je in Se?"layout":void 0;if(!Xe){pe.push(new o.V(he.key,je,`unknown property "${je}" for layer type "${ye}"`));continue}const ht=Object.assign({},he,{key:`${he.key}.${je}`,object:Ue,objectKey:je,layer:se,layerType:ye,value:Ue[je],valueSpec:Xe==="paint"?Ce[je]:Se[je]});pe.push(...vl(ht,Xe))}return pe})(Object.assign({layer:B,layerType:H},_e))}});return Y!=="hidden"&&te===void 0&&J.push(new o.V(z.key,"name",'Appearance with name different than "hidden" must have a condition')),J})(Object.assign({layerType:_,layer:n},D))}),C=Array.isArray(w.value)?w.value:[],O=new Set;return C.forEach(((D,z)=>{const N=o.J(D.name);if(N)if(O.has(N)){const B=o.J(n.id);I.push(new o.V(w.key,N,`Duplicated appearance name "${N}" for layer "${B}"`))}else O.add(N)})),I}}})),t}function Vn({key:l,value:t}){return o.a0(t)?[]:[new o.V(l,t,`string expected, ${o.K(t)} found`)]}const vo={promoteId:function l({key:t,value:n}){if(o.a0(n))return Vn({key:t,value:n});if(Array.isArray(n)){const d=[],p=o.S(n),_=o.U(p);return _.result==="error"&&_.value.forEach((v=>{d.push(new o.V(`${t}${v.key}`,null,`${v.message}`))})),o.X(_.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||d.push(new o.V(`${t}`,null,"promoteId expression should be only feature dependent")),d}if(!o.H(n))return[new o.V(t,n,`string, expression or object expected, "${o.K(n)}" found`)];const c=[];for(const d in n)c.push(...l({key:`${t}.${d}`,value:n[d]}));return c}};function Xc(l){const t=l.value,n=l.key,c=l.styleSpec,d=l.style;if(!o.H(t))return[new o.V(n,t,`object expected, ${o.K(t)} found`)];if(!("type"in t))return[new o.V(n,t,'"type" is required')];const p=o.J(t.type);let _=[];switch(["vector","raster","raster-dem","raster-array"].includes(p)&&("url"in t||"tiles"in t||_.push(new o.a3(n,t,'Either "url" or "tiles" is required.'))),p){case"vector":case"raster":case"raster-dem":case"raster-array":return _=_.concat(Zn({key:n,value:t,valueSpec:c[`source_${p.replace("-","_")}`],style:l.style,styleSpec:c,objectElementValidators:vo})),_;case"geojson":if(_=Zn({key:n,value:t,valueSpec:c.source_geojson,style:d,styleSpec:c,objectElementValidators:vo}),"cluster"in t&&"clusterProperties"in t){if(!o.H(t.clusterProperties))return[new o.V(`${n}.clusterProperties`,t,`object expected, ${o.K(t)} found`)];for(const v in t.clusterProperties){const w=t.clusterProperties[v];if(!Array.isArray(w))return[new o.V(`${n}.clusterProperties.${v}`,w,"array expected")];const[I,C]=w,O=typeof I=="string"?[I,["accumulated"],["get",v]]:I;_.push(...Jn({key:`${n}.${v}.map`,value:C,expressionContext:"cluster-map"})),_.push(...Jn({key:`${n}.${v}.reduce`,value:O,expressionContext:"cluster-reduce"}))}}return _;case"video":return Zn({key:n,value:t,valueSpec:c.source_video,style:d,styleSpec:c});case"image":return Zn({key:n,value:t,valueSpec:c.source_image,style:d,styleSpec:c});case"canvas":return[new o.V(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return gs({key:`${n}.type`,value:t.type,valueSpec:{values:Ga(c)}})}}function Ga(l){return l.source.reduce(((t,n)=>{const c=l[n];return c.type.type==="enum"&&(t=t.concat(Object.keys(c.type.values||{}))),t}),[])}function Vs(l){const t=l.value,n=l.styleSpec,c=n.light,d=l.style;if(t===void 0)return[];if(!o.H(t))return[new o.V("light",t,`object expected, ${o.K(t)} found`)];let p=[];for(const _ in t){const v=_.match(/^(.*)-transition$/),w=_.match(/^(.*)-use-theme$/);p=p.concat(w&&c[w[1]]?qr({key:_,value:t[_],valueSpec:{type:"string"},style:d,styleSpec:n}):v&&c[v[1]]&&c[v[1]].transition?qr({key:_,value:t[_],valueSpec:n.transition,style:d,styleSpec:n}):c[_]?qr({key:_,value:t[_],valueSpec:c[_],style:d,styleSpec:n}):[new o.V(_,t[_],`unknown property "${_}"`)])}return p}function ua(l){const t=l.value;if(!t)return[];const n=l.key;if(!o.H(t))return[new o.V(n,t,`object expected, ${o.K(t)} found`)];let c=[];const d=l.styleSpec,p=d["light-3d"],_=l.style,v=l.style.lights;for(const C of["type","id"])if(!(C in t))return c=c.concat([new o.V(n,t,`missing property "${C}"`)]),c;if(!o.a0(t.type))return c=c.concat([new o.V(`${n}.type`,t.type,"string expected")]),c;if(v)for(let C=0;C<l.arrayIndex;C++){const O=o.J(t.type),D=v[C];o.J(D.type)===O&&c.push(new o.V(n,t.id,`duplicate light type "${t.type}", previously defined at line ${D.id.__line__}`))}const w=`properties_light_${t.type}`;if(!(w in d))return c=c.concat([new o.V(`${n}.type`,t,`Invalid light type ${t.type}`)]),c;const I=d[w];for(const C in t)if(C==="properties"){const O=t[C];if(!o.H(O))return c=c.concat([new o.V("properties",O,`object expected, ${o.K(O)} found`)]),c;for(const D in O){const z=D.match(/^(.*)-transition$/),N=D.match(/^(.*)-use-theme$/);c=c.concat(N&&I[N[1]]?qr({key:C,value:O[D],valueSpec:{type:"string"},style:_,styleSpec:d}):z&&I[z[1]]&&I[z[1]].transition?qr({key:C,value:t[C],valueSpec:d.transition,style:_,styleSpec:d}):I[D]?qr({key:D,value:O[D],valueSpec:I[D],style:_,styleSpec:d}):[new o.a3(l.key,O[D],`unknown property "${D}"`)])}}else c=c.concat(p[C]?qr({key:C,value:t[C],valueSpec:p[C],style:_,styleSpec:d}):[new o.a3(C,t[C],`unknown property "${C}"`)]);return c}function ys(l){const t=l.value,n=l.key,c=l.style,d=l.styleSpec,p=d.terrain;if(t==null)return[];if(!o.H(t))return[new o.V("terrain",t,`object expected, ${o.K(t)} found`)];let _=[];for(const v in t){const w=v.match(/^(.*)-transition$/),I=v.match(/^(.*)-use-theme$/);_=_.concat(I&&p[I[1]]?qr({key:v,value:t[v],valueSpec:{type:"string"},style:c,styleSpec:d}):w&&p[w[1]]&&p[w[1]].transition?qr({key:v,value:t[v],valueSpec:d.transition,style:c,styleSpec:d}):p[v]?qr({key:v,value:t[v],valueSpec:p[v],style:c,styleSpec:d}):[new o.a3(v,t[v],`unknown property "${v}"`)])}if(t.source)if(o.a0(t.source)){const v=c.sources&&c.sources[t.source],w=v&&o.J(v.type);v?w!=="raster-dem"&&_.push(new o.V(`${n}.source`,t.source,`terrain cannot be used with a source of type ${w}, it only be used with a "raster-dem" source type`)):_.push(new o.V(`${n}.source`,t.source,`source "${t.source}" not found`))}else _.push(new o.V(`${n}.source`,t.source,"source must be a string"));else _.push(new o.V(n,t,'terrain is missing required property "source"'));return _}function Yc(l){const t=l.value,n=l.style,c=l.styleSpec,d=c.fog;if(t===void 0)return[];if(!o.H(t))return[new o.V("fog",t,`object expected, ${o.K(t)} found`)];let p=[];for(const _ in t){const v=_.match(/^(.*)-transition$/),w=_.match(/^(.*)-use-theme$/);p=p.concat(w&&d[w[1]]?qr({key:_,value:t[_],valueSpec:{type:"string"},style:n,styleSpec:c}):v&&d[v[1]]&&d[v[1]].transition?qr({key:_,value:t[_],valueSpec:c.transition,style:n,styleSpec:c}):d[_]?qr({key:_,value:t[_],valueSpec:d[_],style:n,styleSpec:c}):[new o.a3(_,t[_],`unknown property "${_}"`)])}return p}const wl={"*":()=>[],array:_s,boolean:function(l){const t=l.value,n=l.key;return o.$(t)?[]:[new o.V(n,t,`boolean expected, ${o.K(t)} found`)]},number:Ns,color:function({key:l,value:t}){return o.a0(t)?o.a1.parseCSSColor(t)===null?[new o.V(l,t,`color expected, "${t}" found`)]:[]:[new o.V(l,t,`color expected, ${o.K(t)} found`)]},enum:gs,filter:ca,function:ja,layer:ic,object:Zn,source:Xc,model:o.a7,light:Vs,"light-3d":ua,terrain:ys,fog:Yc,string:Vn,formatted:function(l){return Vn(l).length===0?[]:Jn(l)},resolvedImage:function(l){return Vn(l).length===0?[]:Jn(l)},projection:function(l){const t=l.value,n=l.styleSpec,c=n.projection,d=l.style;if(o.H(t)){let p=[];for(const _ in t)p=p.concat(qr({key:_,value:t[_],valueSpec:c[_],style:d,styleSpec:n}));return p}return o.a0(t)?[]:[new o.V("projection",t,`object or string expected, ${o.K(t)} found`)]},import:function(l){const t=l.key,{value:n,styleSpec:c}=l;if(!o.H(n))return[new o.V(t,n,"import must be an object")];const{data:d,...p}=n;Object.defineProperty(p,"__line__",{value:n.__line__,enumerable:!1});let _=Zn(Object.assign({},l,{value:p,valueSpec:c.import}));return o.J(p.id)===""&&_.push(new o.V(`${l.key}.id`,p,"import id can't be an empty string")),d&&(_=_.concat(Tl(d,c,{key:`${l.key}.data`}))),_},iconset:function(l){const t=l.value,n=l.key,c=l.styleSpec,d=l.style;if(!o.H(t))return[new o.V(n,t,"object expected")];if(!t.type)return[new o.V(n,t,'"type" is required')];const p=o.J(t.type);let _=[];if(_=_.concat(Zn({key:n,value:t,valueSpec:c[`iconset_${p}`],style:d,styleSpec:c})),(function(v,w){return!(v!=="source"||!w.source)})(p,t)){const v=d.sources&&d.sources[t.source],w=v&&o.J(v.type);v?w!=="raster-array"&&_.push(new o.V(n,t.source,`iconset cannot be used with a source of type ${String(w)}, it only be used with a "raster-array" source type`)):_.push(new o.V(n,t.source,`source "${t.source}" not found`))}return _}};function qr(l,t=!1){const n=l.value,c=l.valueSpec,d=l.styleSpec;if(c.expression){if(o.a4(o.J(n)))return ja(l);if(o.Q(o.S(n)))return Jn(l)}if(c.type&&wl[c.type]){const p=wl[c.type](l);return t===!0&&p.length>0&&Array.isArray(l.value)?Jn(l):p}return Zn(Object.assign({},l,{valueSpec:c.type?d[c.type]:c}))}function Zn(l){const t=l.key,n=l.value,c=l.valueSpec||{},d=l.objectElementValidators||{},p=l.style,_=l.styleSpec;if(!o.H(n))return[new o.V(t,n,`object expected, ${o.K(n)} found`)];let v=[];for(const w in n){const I=w.split(".")[0];let C;d[I]?C=d[I]:c[I]?C=qr:d["*"]?C=d["*"]:c["*"]&&(C=qr),C?v=v.concat(C({key:(t&&`${t}.`)+w,value:n[w],valueSpec:c[I]||c["*"],style:p,styleSpec:_,object:n,objectKey:w},n)):v.push(new o.a3(t,n[w],`unknown property "${w}"`))}for(const w in c){if(d[w])continue;const I=c[w];I.required&&I.default===void 0&&n[w]===void 0&&v.push(new o.V(t,n,`missing required property "${w}"`))}return v}function eh({key:l,value:t}){const n=Vn({key:l,value:t});if(n.length)return n;const c=t;return c.indexOf("{fontstack}")===-1&&n.push(new o.V(l,t,'"glyphs" url must include a "{fontstack}" token')),c.indexOf("{range}")===-1&&n.push(new o.V(l,t,'"glyphs" url must include a "{range}" token')),n}function Tl(l,t=o.a6,n={}){return Zn({key:n.key||"",value:l,valueSpec:Object.assign(t.$root,{"*":{type:"*"}}),styleSpec:t,style:l,objectElementValidators:{glyphs:eh}})}function vs(l,t=o.a6){return W(Tl(l,t))}const th=l=>W(Xc(l)),st=l=>W(Vs(l)),ha=l=>W(ua(l)),ef=l=>W(ys(l)),El=l=>W(Yc(l)),Yi=l=>W((function(t){const n=t.value,c=t.style,d=t.styleSpec,p=d.snow;if(n===void 0)return[];if(!o.H(n))return[new o.V("snow",n,`object expected, ${o.K(n)} found`)];let _=[];for(const v in n){const w=v.match(/^(.*)-transition$/);_=_.concat(w&&p[w[1]]&&p[w[1]].transition?qr({key:v,value:n[v],valueSpec:d.transition,style:c,styleSpec:d}):p[v]?qr({key:v,value:n[v],valueSpec:p[v],style:c,styleSpec:d}):[new o.a3(v,n[v],`unknown property "${v}"`)])}return _})(l)),no=l=>W((function(t){const n=t.value,c=t.style,d=t.styleSpec,p=d.rain;if(n===void 0)return[];if(!o.H(n))return[new o.V("rain",n,`object expected, ${o.K(n)} found`)];let _=[];for(const v in n){const w=v.match(/^(.*)-transition$/);_=_.concat(w&&p[w[1]]&&p[w[1]].transition?qr({key:v,value:n[v],valueSpec:d.transition,style:c,styleSpec:d}):p[v]?qr({key:v,value:n[v],valueSpec:p[v],style:c,styleSpec:d}):[new o.a3(v,n[v],`unknown property "${v}"`)])}return _})(l)),tf=l=>W(ic(l)),Sl=l=>W(ca(l)),Jc=l=>W(xl(l)),De=l=>W(bl(l)),j=l=>W(o.a7(l));function W(l){return l.slice().sort(((t,n)=>t.line&&n.line?t.line-n.line:0))}function ne(l,t){let n=!1;if(t&&t.length)for(const c of t)c instanceof o.a3?o.w(c.message):(l.fire(new o.y(new Error(c.message))),n=!0);return n}const be=o.a6.light;let ve;class Ie extends o.E{constructor(t,n="flat"){super(),this._transitionable=new o.a8(ve||(ve=new o.a9({anchor:new o.aa(be.anchor),position:new o.ab(be.position),color:new o.aa(be.color),intensity:new o.aa(be.intensity)}))),this.setLight(t,n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n,c={}){this._validate(st,t,c)||(this._transitionable.setTransitionOrValue(t),this.id=n)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&ne(this,t.call(vs,Object.assign({value:n,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}}const Ve=o.a6.terrain;let Pe=class extends o.E{constructor(l,t,n,c,d){super(),this.scope=n,this._transitionable=new o.a8(new o.a9({source:new o.aa(Ve.source),exaggeration:new o.aa(Ve.exaggeration)}),n,c),this._transitionable.setTransitionOrValue(l,c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=d}get(){return this._transitionable.serialize()}set(l,t){this._transitionable.setTransitionOrValue(l,t)}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}getExaggeration(l){return this._transitioning.possiblyEvaluate(new o.ac(l,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const l=this._transitionable._values.exaggeration;if(!l)return null;const t=l.value.expression;if(!t)return null;let n=-1,c=-1,d=1;for(const p of t.zoomStops)d=t.evaluate(new o.ac(p,{worldview:this.worldview})),d>.01?(n=p,c=-1):c=p;return d<.01&&n>0&&c>n?[n,c]:null}isZoomDependent(){const l=this._transitionable._values.exaggeration;return l!=null&&l.value!=null&&l.value.expression!=null&&l.value.expression instanceof o.ad}};const Ne=45,ut=65,Je=.05;function Mt(l,t,n,c){const d=o.ah(Ne,ut,n),[p,_]=$t(l,c);let v=1-Math.min(1,Math.exp((t-p)/(_-p)*-6));return v*=v*v,v=Math.min(1,1.00747*v),v*d*l.alpha}function $t(l,t){const n=.5/Math.tan(.5*t);return[l.range[0]+n,l.range[1]+n]}function It(l,t,n,c,d){const p=o.af([],[t,n,c],d.mercatorFogMatrix);return Mt(l,o.ag(p),d.pitch,d._fov)}function yi(l,t,n,c,d,p,_){const v=[[n,c,0],[d,c,0],[d,p,0],[n,p,0]];let w=Number.MAX_VALUE,I=-Number.MAX_VALUE;for(const C of v){const O=o.af([],C,t),D=o.ag(O);w=Math.min(w,D),I=Math.max(I,D)}return[Mt(l,w,_.pitch,_._fov),Mt(l,I,_.pitch,_._fov)]}const mi=o.a6.fog;class fi extends o.E{constructor(t,n,c,d){super();const p=new o.a9({range:new o.aa(mi.range),color:new o.aa(mi.color),"color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new o.aa(mi["high-color"]),"high-color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new o.aa(mi["space-color"]),"space-color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new o.aa(mi["horizon-blend"]),"star-intensity":new o.aa(mi["star-intensity"]),"vertical-range":new o.aa(mi["vertical-range"])});this._transitionable=new o.a8(p,c,new Map(d)),this.set(t,d),this._transitioning=this._transitionable.untransitioned(),this._transform=n,this.properties=new o.ai(p),this.scope=c}get state(){const t=this._transform,n=t.projection.name==="globe",c=o.aj(t.zoom),d=this.properties.get("range"),p=[.5,3];return{range:n?[o.ak(p[0],d[0],c),o.ak(p[1],d[1],c)]:d,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,n,c={}){if(this._validate(El,t,c))return;const d=Object.assign({},t);for(const p of Object.keys(mi))d[p]===void 0&&(d[p]=mi[p].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,n)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const n=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:o.ah(Ne,ut,t))*n.a}getOpacityAtLatLng(t,n){return this._transform.projection.supportsFog?(function(c,d,p){const _=o.ae.fromLngLat(d),v=p.elevation?p.elevation.getAtPointOrZero(_):0;return It(c,_.x,_.y,v,p)})(this.state,t,n):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const n=this._transform.calculateFogTileMatrix(t.toUnwrapped());return yi(this.state,n,0,0,o.al,o.al,this._transform)}getOpacityForBounds(t,n,c,d,p){return this._transform.projection.supportsFog?yi(this.state,t,n,c,d,p,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?$t(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const n=[4,5,6,7];for(const c of n){const d=t.points[c];let p;if(d[2]>=0)p=d;else{const _=t.points[c-4];p=o.am(_,d,_[2]/(_[2]-d[2]))}if(It(this.state,p[0],p[1],0,this._transform)>=Je)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&ne(this,t.call(vs,Object.assign({value:n,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}}let Ui,Qr,fn,nn,gn=class extends o.E{constructor(l,t,n,c){super();const d=Ui||(Ui=new o.a9({density:new o.aa(o.a6.snow.density),intensity:new o.aa(o.a6.snow.intensity),color:new o.aa(o.a6.snow.color),opacity:new o.aa(o.a6.snow.opacity),vignette:new o.aa(o.a6.snow.vignette),"vignette-color":new o.aa(o.a6.snow["vignette-color"]),"center-thinning":new o.aa(o.a6.snow["center-thinning"]),direction:new o.aa(o.a6.snow.direction),"flake-size":new o.aa(o.a6.snow["flake-size"])}));this._transitionable=new o.a8(d,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ai(d),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=o.an(n[0]),d=-Math.max(o.an(n[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],_=this.properties.get("vignette"),v=this.properties.get("vignette-color");return v.a=_,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.ao(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:v}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(Yi,l,n))return;const c=Object.assign({},l),d=o.a6.snow;for(const p of Object.keys(d))c[p]===void 0&&(c[p]=d[p].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||n.validate!==!1)&&ne(this,l.call(vs,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}},Hr=class extends o.E{constructor(l,t,n,c){super();const d=Qr||(Qr=new o.a9({density:new o.aa(o.a6.rain.density),intensity:new o.aa(o.a6.rain.intensity),color:new o.aa(o.a6.rain.color),opacity:new o.aa(o.a6.rain.opacity),vignette:new o.aa(o.a6.rain.vignette),"vignette-color":new o.aa(o.a6.rain["vignette-color"]),"center-thinning":new o.aa(o.a6.rain["center-thinning"]),direction:new o.aa(o.a6.rain.direction),"droplet-size":new o.aa(o.a6.rain["droplet-size"]),"distortion-strength":new o.aa(o.a6.rain["distortion-strength"])}));this._transitionable=new o.a8(d,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ai(d),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=o.an(n[0]),d=-Math.max(o.an(n[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],_=this.properties.get("vignette-color");return _.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.ao(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:_}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(no,l,n))return;const c=Object.assign({},l),d=o.a6.rain;for(const p of Object.keys(d))c[p]===void 0&&(c[p]=d[p].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||n.validate!==!1)&&ne(this,l.call(vs,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}};class $i extends o.E{constructor(t,n,c,d){super(),this.scope=c,this._options=t,this.properties=new o.ai(n),this._transitionable=new o.a8(n,c,new Map(d)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,n){this._options=t,this._transitionable.setTransitionOrValue(t.properties,n)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class Zr{constructor(t,n,c){this.screenBounds=t,this.cameraPoint=c.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=n,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,c)}static createFromScreenPoints(t,n){let c,d;if(t instanceof o.P||typeof t[0]=="number"){const p=o.P.convert(t);c=[p],d=n.isPointAboveHorizon(p)}else{const p=o.P.convert(t[0]),_=o.P.convert(t[1]),v=p.add(_)._div(2);c=[p,_],d=o.aq(p,_).every((w=>n.isPointAboveHorizon(w)))&&n.isPointAboveHorizon(v)}return new Zr(c,d,n)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return o.aq(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const n=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],d=o.aq(n,c,0,!1);return this.cameraPoint.y>c.y&&(this.cameraPoint.x>n.x&&this.cameraPoint.x<c.x?d.splice(3,0,this.cameraPoint):this.cameraPoint.x>=c.x?d[2]=this.cameraPoint:this.cameraPoint.x<=n.x&&(d[3]=this.cameraPoint)),o.ar(d,t)}bufferedCameraGeometryGlobe(t){const n=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],d=o.aq(n,c,t),p=this.cameraPoint.clone();switch(3*((p.y>n.y)+(p.y>c.y))+((p.x>n.x)+(p.x>c.x))){case 0:d[0]=p,d[4]=p.clone();break;case 1:d.splice(1,0,p);break;case 2:d[1]=p;break;case 3:d.splice(4,0,p);break;case 5:d.splice(2,0,p);break;case 6:d[3]=p;break;case 7:d.splice(3,0,p);break;case 8:d[2]=p}return d}containsTile(t,n,c,d=0){const p=Math.max(t.queryPadding,t.evaluateQueryRenderedFeaturePadding())/n._pixelsPerMercatorPixel+1,_=c?this._bufferedCameraMercator(p,n):this._bufferedScreenMercator(p,n);let v=t.tileID.wrap+(_.unwrapped?d:0);const w=_.polygon.map((H=>o.as(t.tileTransform,H,v)));if(!o.at(w,0,0,o.al,o.al))return;v=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?d:0);const I=this.screenGeometryMercator.polygon.map((H=>o.au(t.tileTransform,H,v))),C=I.map((H=>new o.P(H[0],H[1]))),O=n.getFreeCameraOptions().position||new o.ae(0,0,0),D=o.au(t.tileTransform,O,v),z=I.map((H=>{const q=o.av(H,H,D);return o.aw(q,q),new o.ax(D,q)})),N=o.ay(t,1,n.zoom)*n._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:C,tilespaceRays:z,bufferedTilespaceGeometry:w,bufferedTilespaceBounds:(B=o.az(w),B.min.x=o.aA(B.min.x,0,o.al),B.min.y=o.aA(B.min.y,0,o.al),B.max.x=o.aA(B.max.x,0,o.al),B.max.y=o.aA(B.max.y,0,o.al),B),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:N};var B}_bufferedScreenMercator(t,n){const c=on(t);if(this._screenRaycastCache[c])return this._screenRaycastCache[c];{let d;return d=n.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),n):{polygon:this.bufferedScreenGeometry(t).map((p=>n.pointCoordinate3D(p))),unwrapped:!0},this._screenRaycastCache[c]=d,d}}_bufferedCameraMercator(t,n){const c=on(t);if(this._cameraRaycastCache[c])return this._cameraRaycastCache[c];{let d;return d=n.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),n):{polygon:this.bufferedCameraGeometry(t).map((p=>n.pointCoordinate3D(p))),unwrapped:!0},this._cameraRaycastCache[c]=d,d}}_projectAndResample(t,n){const c=(function(p,_){const v=o.aB([],_.pixelMatrix,_.globeMatrix),w=[0,-o.aD,0,1],I=[0,o.aD,0,1],C=[0,0,0,1];o.aC(w,w,v),o.aC(I,I,v),o.aC(C,C,v);const O=new o.P(w[0]/w[3],w[1]/w[3]),D=new o.P(I[0]/I[3],I[1]/I[3]),z=o.aE(p,O)&&w[3]<C[3],N=o.aE(p,D)&&I[3]<C[3];if(!z&&!N)return null;const B=(function(pe,ce,se){for(let ye=1;ye<pe.length;ye++){const Ce=Ri(ce.pointCoordinate3D(pe[ye-1]).x),Se=Ri(ce.pointCoordinate3D(pe[ye]).x);if(se<0){if(Ce<Se)return{idx:ye,t:-Ce/(Se-1-Ce)}}else if(Se<Ce)return{idx:ye,t:(1-Ce)/(Se+1-Ce)}}return null})(p,_,z?-1:1);if(!B)return null;const{idx:H,t:q}=B;let Y=H>1?Tr(p.slice(0,H),_):[],te=H<p.length?Tr(p.slice(H),_):[];Y=Y.map((pe=>new o.P(Ri(pe.x),pe.y))),te=te.map((pe=>new o.P(Ri(pe.x),pe.y)));const J=[...Y];J.length===0&&J.push(te[te.length-1]);const _e=o.ak(J[J.length-1].y,(te.length===0?Y[0]:te[0]).y,q);let he;return he=z?[new o.P(0,_e),new o.P(0,0),new o.P(1,0),new o.P(1,_e)]:[new o.P(1,_e),new o.P(1,1),new o.P(0,1),new o.P(0,_e)],J.push(...he),te.length===0?J.push(Y[0]):J.push(...te),{polygon:J.map((pe=>new o.ae(pe.x,pe.y))),unwrapped:!1}})(t,n);if(c)return c;const d=(function(p,_){let v=!1,w=-1/0,I=0;for(let O=0;O<p.length-1;O++)p[O].x>w&&(w=p[O].x,I=O);for(let O=0;O<p.length-1;O++){const D=(I+O)%(p.length-1),z=p[D],N=p[D+1];Math.abs(z.x-N.x)>.5&&(z.x<N.x?(z.x+=1,D===0&&(p[p.length-1].x+=1)):(N.x+=1,D+1===p.length-1&&(p[0].x+=1)),v=!0)}const C=o.aF(_.center.lng);return v&&C<Math.abs(C-1)&&p.forEach((O=>{O.x-=1})),{polygon:p,unwrapped:v}})(Tr(t,n).map((p=>new o.P(Ri(p.x),p.y))),n);return{polygon:d.polygon.map((p=>new o.ae(p.x,p.y))),unwrapped:d.unwrapped}}}function Tr(l,t){return o.aG(l,(n=>{const c=t.pointCoordinate3D(n);n.x=c.x,n.y=c.y}),1/256)}function Ri(l){return l<0?1+l%1:l%1}function on(l){return 100*l|0}function Wn(l,t,n,c,d){const p=function(v,w){if(v)return d(v);if(w){if(l.url&&w.tiles&&l.tiles&&delete l.tiles,w.variants){if(!Array.isArray(w.variants))return d(new Error("variants must be an array"));for(const C of w.variants){if(C==null||typeof C!="object"||C.constructor!==Object)return d(new Error("variant must be an object"));if(!Array.isArray(C.capabilities))return d(new Error("capabilities must be an array"));if(C.capabilities.length===1&&C.capabilities[0]==="meshopt"){w=Object.assign(w,C);break}}}const I=o.aH(Object.assign({},w,l),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);I.tiles=t.canonicalizeTileset(I,l.url),d(null,I)}},_=(function(v,w,I){if(!v)return null;if(!w&&!I)return v;I=I||v.worldview_default;const C=Object.values(v.language||{});if(C.length===0)return null;const O=Object.values(v.worldview||{});if(O.length===0)return null;const D=C.every((N=>N===w)),z=O.every((N=>N===I));return D&&z?v:w in(v.language_options||{})||I in(v.worldview_options||{})?null:v.language_options&&v.worldview_options?v:null})(l.data,n,c);return _?o.o.frame((()=>p(null,_))):l.url?o.m(t.transformRequest(t.normalizeSourceURL(l.url,null,n,c),o.R.Source),p):o.o.frame((()=>{const{data:v,...w}=l;p(null,w)}))}function Kn(l,t){const n=Math.pow(2,t.z),c=Math.floor(o.aF(l.getWest())*n),d=Math.floor(o.aJ(l.getNorth())*n),p=Math.ceil(o.aF(l.getEast())*n),_=Math.ceil(o.aJ(l.getSouth())*n);return t.x>=c&&t.x<p&&t.y>=d&&t.y<_}class xo{constructor(t,n,c){this.bounds=t?o.aI.convert(this.validateBounds(t)):null,this.minzoom=n||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(const n of t)this.extraBounds.push(o.aI.convert(this.validateBounds(n)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!Kn(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(const n of this.extraBounds)if(Kn(n,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;const n=new xo(t.bounds,t.minzoom,t.maxzoom);return n.addExtraBounds(t.extra_bounds),n}}class Il extends o.E{constructor(t,n,c,d){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,o.aH(n,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},n),this._collectResourceTiming=!!n.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d),this._tileWorkers={},this._deduped=new o.aK}load(t){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const n=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=Wn(this._options,this.map._requestManager,n,c,((d,p)=>{if(this._tileJSONRequest=null,this._loaded=!0,d)n&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${n}`),c&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${c}`),this.fire(new o.y(d));else if(p){if(Object.assign(this,p),this.hasWorldviews=!!p.worldview_options,p.worldview_default&&(this.worldviewDefault=p.worldview_default),p.vector_layers){this.vectorLayers=p.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const _ of p.vector_layers)this.vectorLayerIds.push(_.id),p.worldview&&p.worldview[_.source]&&this.localizableLayerIds.add(_.id)}this.tileBounds=xo.fromTileJSON(p),yr(p.tiles,this.map._requestManager._customAccessToken),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}t&&t(d)}))}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=o.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(t,n){const c=t.tileID.canonical.url(this.tiles,this.scheme),d=this.map._requestManager.normalizeTileURL(c),p=this.map._requestManager.transformRequest(d,o.R.Tile),_=this.map.style?this.map.style.getLut(this.scope):null,v=_?{image:_.image.clone()}:null,w={request:p,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:v,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:o.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault,indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};if(this.hasWorldviews&&o.h(c)&&(w.localizableLayerIds=this.localizableLayerIds),w.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=n:t.request=t.actor.send("reloadTile",w,I.bind(this));else if(t.actor=this._tileWorkers[d]=this._tileWorkers[d]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",w,I.bind(this),void 0,!0);else{const C=o.aL.call({deduped:this._deduped},w,((O,D)=>{if(O||!D)I.call(this,O);else{const z=o.aM(D.responseHeaders);w.data={rawData:D.rawData.slice(0),expires:z.expires,cacheControl:z.cacheControl},t.actor&&t.actor.send("loadTile",w,I.bind(this),void 0,!0)}}),!0);t.request={cancel:C}}function I(C,O){return delete t.request,t.aborted?n(null):C&&C instanceof o.aN&&C.status!==404?n(C):(O&&O.resourceTiming&&(t.resourceTiming=O.resourceTiming),this.map._refreshExpiredTiles&&O&&t.setExpiryData(O),t.loadVectorData(O,this.map.painter),o.aO(this.dispatcher),n(null,O),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,n){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Un extends o.E{constructor(t,n,c,d){super(),this.id=t,this.dispatcher=c,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},n),Object.assign(this,o.aH(n,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const n=this.map.getWorldview();this._tileJSONRequest=Wn(this._options,this.map._requestManager,null,n,((c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?this.fire(new o.y(c)):d&&(Object.assign(this,d),d.raster_layers&&(this.rasterLayers=d.raster_layers,this.rasterLayerIds=this.rasterLayers.map((p=>p.id))),this.tileBounds=xo.fromTileJSON(d),yr(d.tiles),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(c)}))}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=o.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,n){const c=o.o.devicePixelRatio>=2,d=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),c,this.tileSize);t.request=o.n(this.map._requestManager.transformRequest(d,o.R.Tile),((p,_,v)=>{if(delete t.request,t.aborted)return t.state="unloaded",n(null);if(p)return t.state="errored",n(p);if(!_)return n(null);const w=o.aM(v);this.map._refreshExpiredTiles&&t.setExpiryData(w),t.setTexture(_,this.map.painter),t.state="loaded",o.aO(this.dispatcher),n(null)}))}abortTile(t,n){t.request&&(t.request.cancel(),delete t.request),n&&n()}unloadTile(t,n){t.texture&&t.texture instanceof o.T?(t.destroy(!1),t.texture&&t.texture instanceof o.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),n&&n()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function Uo([l,t],n,c,{scaled:d=!0}={}){const{tileSize:p,buffer:_}=c,{x:v,y:w,z:I}=n;if(!isFinite(v)||!isFinite(w)||!isFinite(I))throw new Error("Invalid MRT header");const C=2**I,O=C*o.aF(l),D=C*o.aJ(t);return(function([z,N],B,{scaled:H=!0}={}){if(!B)throw new Error("bandView is undefined");const{data:q,tileSize:Y,buffer:te,offset:J,scale:_e,dimension:he}=B;if(z<-te||z>Y+te||N<-te||N>Y+te)throw new Error(`Point (${z}, ${N}) out of bounds for tileSize=${Y}, buffer=${te}`);const pe=(N+te)*(Y+2*te)+(z+te);if(new Uint32Array(q.buffer)[pe]===4294967295)return null;let ce=[];ce=H?[]:new B.data.constructor(he);for(let se=0;se<he;se++)ce[se]=Math.round(1e12*(q[he*pe+se]*_e+J))/1e12;return ce})([Math.min(Math.max(-_,Math.floor((O-v)*p)),p-1+_),Math.min(Math.max(-_,Math.floor((D-w)*p)),p-1+_)],c,{scaled:d})}class oo extends Un{constructor(t,n,c,d){super(t,n,c,d),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},n)}triggerRepaint(t){const n=this.map.painter._terrain,c=this.map.style.getSourceCache(this.id);n&&n.enabled&&c&&n._clearRenderCacheForTile(c.id,t.tileID),this.map.triggerRepaint()}loadTile(t,n){const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,o.R.Tile),p={request:d,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=d,t.actor||(t.actor=this.dispatcher.getActor());const _=(v,w,I)=>{if(delete t.request,t.aborted)return t.state="unloaded",n(null);if(v)return v.name==="AbortError"?void 0:(t.state="errored",n(v));if(this.map._refreshExpiredTiles&&w){const C=o.aM(I);t.setExpiryData(C)}if(this.partial&&t.state!=="expired")t.state="empty";else if(!this.partial){if(!w)return n(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=w}n(null)};t.request=this.partial?t.fetchHeader(void 0,_.bind(this)):t.actor.send("loadTile",p,_.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,n){const c=t.texturePerLayer;if(t.flushAllQueues(),c.size){t.destroy(!1);for(const d of c.values())this.map.painter.saveTileTexture(d)}else t.destroy()}prepareTile(t,n,c,d){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBandForRender(n,c,d,((p,_)=>{if(p)return t.state="errored",this.fire(new o.y(p)),void this.triggerRepaint(t);_&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(c,_,this.map.painter),t.state="loaded",this.triggerRepaint(t))})))}getInitialBand(t){if(!this.rasterLayers)return 0;const n=this.rasterLayers.find((({id:p})=>p===t)),c=n&&n.fields,d=c&&c.bands&&c.bands;return d?d[0]:0}getTextureDescriptor(t,n,c){if(!t)return;const d=n.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!d)return;let p=null;n instanceof o.aR?p=n.paint.get("raster-array-band"):n instanceof o.aS&&(p=n.paint.get("raster-particle-array-band"));const _=p||this.getInitialBand(d);if(_==null)return;if(!t.textureDescriptorPerLayer.get(n.id))return void this.prepareTile(t,d,n.id,_);if(t.updateNeeded(n.id,_)&&!c)return;const v=t.textureDescriptorPerLayer.get(n.id);return Object.assign({},v,{texture:t.texturePerLayer.get(n.id)})}getImages(t,n){const c=new Map;for(const d of t)for(const p of n){const[_,v]=p.split("/"),w=d.getLayer(_);if(!w||!w.hasBand(v)||!w.hasDataForBand(v))continue;const{bytes:I,tileSize:C,buffer:O}=w.getBandView(v),D=C+2*O,z={data:new o.q({width:D,height:D},I),pixelRatio:2,sdf:!1,usvg:!1,version:0};c.set(p,z)}return c}queryRasterArrayValueByBandId(t,n,c){const d=n._mrt;return new Promise((p=>{const _={},v=new Set;for(const[w,I]of Object.entries(d.layers)){if(c.layerName&&w!==c.layerName)continue;const C={};_[w]=C;for(const{bands:O}of I.dataIndex)for(const D of O)c.bands&&!c.bands.includes(D)||(v.add(o.B(w,D)),n.fetchBand(w,null,D,(z=>{o.o.frame((()=>{C[D]=z?null:Uo([t.lng,t.lat],d,I.getBandView(D)),v.delete(o.B(w,D)),v.size===0&&p(_)}))}),!1))}v.size===0&&p(_)}))}_loadTileForQuery(t,n){if(this._loadTileLoaded[t.uid])return void n(null,t._mrt);if(this._loadTilePending[t.uid])return void this._loadTilePending[t.uid].push(n);this._loadTilePending[t.uid]=[n];const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,o.R.Tile);t.actor.send("loadTile",{request:d,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},((p,_,v)=>{if(p)return this._loadTilePending[t.uid].forEach((w=>w(p,null))),void delete this._loadTilePending[t.uid];if(!_)return this._loadTilePending[t.uid].forEach((w=>w(null,null))),void delete this._loadTilePending[t.uid];if(this.map._refreshExpiredTiles&&_){const w=o.aM(v);t.setExpiryData(w)}t._mrt=_,t._isHeaderLoaded=!0,t.state="loaded",this._loadTilePending[t.uid].forEach((w=>w(null,_))),this._loadTileLoaded[t.uid]=!0,delete this._loadTilePending[t.uid]}),void 0,!0)}queryRasterArrayValueByAllBands(t,n,c){return new Promise(((d,p)=>{this._loadTileForQuery(n,((_,v)=>{_?p(_):d(v?this.queryRasterArrayValueByBandId(t,n,c):null)}))}))}queryRasterArrayValue(t,n){const c=o.aT.convert(t),d=this.findLoadedParent(c);return d&&d._mrt?n.bands||!this.partial?this.queryRasterArrayValueByBandId(c,d,n):this.queryRasterArrayValueByAllBands(c,d,n):Promise.resolve(null)}findLoadedParent(t){const n=o.ae.fromLngLat(t,this.map.transform.tileSize),c=this.maxzoom+1,d=1<<c,p=Math.floor(n.x),_=Math.floor((n.x-p)*d),v=Math.floor(n.y*d),w=this.map.style.getSourceCache(this.id),I=new o.aQ(c,p,c,_,v);return w.findLoadedParent(I,this.minzoom)}}const Us={vector:Il,raster:Un,"raster-dem":class extends Un{constructor(l,t,n,c){super(l,t,n,c),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function c(d,p){d&&(l.state="errored",t(d)),p&&(l.dem=p,l.dem.onDeserialize(),l.needsHillshadePrepare=!0,l.needsDEMTextureUpload=!0,l.state="loaded",t(null))}l.request=o.n(this.map._requestManager.transformRequest(n,o.R.Tile),(function(d,p,_){if(delete l.request,l.aborted)l.state="unloaded",t(null);else if(d)l.state="errored",t(d);else if(p){const v=o.aM(_);this.map._refreshExpiredTiles&&l.setExpiryData(v);const w=ImageBitmap&&p instanceof ImageBitmap&&o.r(),I=1-(p.width-o.aP(p.width))/2;I<1||l.neighboringTiles||(l.neighboringTiles=this._getNeighboringTiles(l.tileID));const C=w?p:o.o.getImageData(p,I),O={uid:l.uid,tileID:l.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:C,encoding:this.encoding,padding:I};l.actor&&l.state!=="expired"||(l.actor=this.dispatcher.getActor(),l.actor.send("loadTile",O,c.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(l){const t=l.canonical,n=Math.pow(2,t.z),c=(t.x-1+n)%n,d=t.x===0?l.wrap-1:l.wrap,p=(t.x+1+n)%n,_=t.x+1===n?l.wrap+1:l.wrap,v={};return v[new o.aQ(l.overscaledZ,d,t.z,c,t.y).key]={backfilled:!1},v[new o.aQ(l.overscaledZ,_,t.z,p,t.y).key]={backfilled:!1},t.y>0&&(v[new o.aQ(l.overscaledZ,d,t.z,c,t.y-1).key]={backfilled:!1},v[new o.aQ(l.overscaledZ,l.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},v[new o.aQ(l.overscaledZ,_,t.z,p,t.y-1).key]={backfilled:!1}),t.y+1<n&&(v[new o.aQ(l.overscaledZ,d,t.z,c,t.y+1).key]={backfilled:!1},v[new o.aQ(l.overscaledZ,l.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},v[new o.aQ(l.overscaledZ,_,t.z,p,t.y+1).key]={backfilled:!1}),v}},"raster-array":oo,geojson:class extends o.E{constructor(l,t,n,c){super(),this.id=l,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(c),this._data=t.data,this._options=Object.assign({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const d=o.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*d,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*d,extent:o.al,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:o.al,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*d,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(l){this.map=l,this.setData(this._data)}setData(l){return this._data=l,this._updateWorkerData(),this}updateData(l){if(!this._options.dynamic)return this.fire(new o.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof l!="string"&&(l.type==="Feature"&&(l={type:"FeatureCollection",features:[l]}),l.type!=="FeatureCollection"))return this.fire(new o.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof l!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const t=new Map;for(const n of this._data.features)t.set(n.id,n);for(const n of l.features)t.set(n.id,n);this._data.features=[...t.values()]}else this._data=l;return this._updateWorkerData(!0),this}getClusterExpansionZoom(l,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterChildren(l,t){return this.actor.send("geojson.getClusterChildren",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterLeaves(l,t,n,c){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:l,limit:t,offset:n},c),this}_updateWorkerData(l=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new o.z("dataloading",{dataType:"source"})),this._loaded=!1;const t=Object.assign({append:l},this.workerOptions);t.scope=this.scope;const n=this._data;typeof n=="string"?(t.request=this.map._requestManager.transformRequest(o.o.resolveURL(n),o.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(n),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,((c,d)=>{if(this._loaded=!0,this._pendingLoad=null,c)this.fire(new o.y(c));else{const p={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&d&&d.resourceTiming&&d.resourceTiming[this.id]&&(p.resourceTiming=d.resourceTiming[this.id]),l&&(this._partialReload=!0),this.fire(new o.z("data",p)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(l),this._coalesce=!1)}))}loaded(){return this._loaded}reload(){const l=o.B(this.id,this.scope);this.map.style.clearSource(l),this._updateWorkerData()}loadTile(l,t){const n=l.actor?"reloadTile":"loadTile";l.actor=this.actor;const c=this.map.style?this.map.style.getLut(this.scope):null,d=c?{image:c.image.clone()}:null,p=this._partialReload,_={type:this.type,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:d,scope:this.scope,pixelRatio:o.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:l.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:p,worldview:this.map.getWorldview(),indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};l.request=this.actor.send(n,_,((v,w)=>p&&!w?(l.state="loaded",t(null)):(delete l.request,l.destroy(!1),l.aborted?t(null):v?t(v):(l.loadVectorData(w,this.map.painter,n==="reloadTile"),t(null)))),void 0,n==="loadTile")}abortTile(l){l.request&&(l.request.cancel(),delete l.request),l.aborted=!0}unloadTile(l,t){this.actor.send("removeTile",{uid:l.uid,type:this.type,source:this.id,scope:this.scope}),l.destroy()}onRemove(l){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends o.aU{constructor(l,t,n,c){super(l,t,n,c),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const l=this.options;this.urls=[];for(const t of l.urls)this.urls.push(this.map._requestManager.transformRequest(t,o.R.Source).url);o.aV(this.urls,((t,n)=>{this._loaded=!0,t?this.fire(new o.y(t)):n&&(this.video=n,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(l){if(this.video){const t=this.video.seekable;l<t.start(0)||l>t.end(0)?this.fire(new o.y(new o.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=l}}getVideo(){return this.video}onAdd(l){this.map||(this.map=l,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const l=this.map.painter.context,t=l.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new o.T(l,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(l)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:o.aU,model:o.aX,"batched-model":class extends o.E{constructor(l,t,n,c){super(),this.type="batched-model",this.id=l,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=n,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(c)}onAdd(l){this.map=l,this.load()}reload(){this.cancelTileJSONRequest();const l=o.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(l)))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(l){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map.getWorldview();this._tileJSONRequest=Wn(this._options,this.map._requestManager,t,n,((c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),n&&n.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${n}`),this.fire(new o.y(c))):d&&(Object.assign(this,d),d.bounds&&(this.tileBounds=new xo(d.bounds,this.minzoom,this.maxzoom)),yr(d.tiles,this.map._requestManager._customAccessToken),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))),l&&l(c)}))}hasTransition(){return!1}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}loaded(){return this._loaded}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme)),c={request:this.map._requestManager.transformRequest(n,o.R.Tile),data:void 0,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,tileSize:this.tileSize*l.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:l.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:o.o.devicePixelRatio,promoteId:this.promoteId};if(l.actor&&l.state!=="expired")if(l.state==="loading")l.reloadCallback=t;else{if(l.buckets){const p=Object.values(l.buckets);for(const _ of p)_.dirty=!0;return void(l.state="loaded")}l.request=l.actor.send("reloadTile",c,d.bind(this))}else l.actor=this.dispatcher.getActor(),l.request=l.actor.send("loadTile",c,d.bind(this),void 0,!0);function d(p,_){return l.aborted?t(null):p&&p.status!==404?t(p):(this.map._refreshExpiredTiles&&_&&l.setExpiryData(_),l.loadModelData(_,this.map.painter),l.state="loaded",void t(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends o.aU{constructor(l,t,n,c){super(l,t,n,c),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some((d=>!Array.isArray(d)||d.length!==2||d.some((p=>typeof p!="number"))))||this.fire(new o.y(new o.V(`sources.${l}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new o.y(new o.V(`sources.${l}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new o.y(new o.V(`sources.${l}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new o.y(new o.V(`sources.${l}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new o.y(new o.V(`sources.${l}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new o.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(l){this.map=l,this.load(),this.canvas&&this.animate&&this.play()}onRemove(l){this.pause()}prepare(){let l=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,l=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,l=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!l&&!this._playing||this.texture instanceof o.aW||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new o.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const l of[this.canvas.width,this.canvas.height])if(isNaN(l)||l<=0)return!0;return!1}},custom:class extends o.E{constructor(l,t,n,c){super(),this.id=l,this.type="custom",this._dataType="raster",this._dispatcher=n,this._implementation=t,this.setEventedParent(c),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new o.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new o.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new xo(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,o.aH(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return o.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(l){this.map=l,this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(l),this.load()}onRemove(l){this._implementation.onRemove&&this._implementation.onRemove(l)}hasTile(l){if(this._implementation.hasTile){const{x:t,y:n,z:c}=l.canonical;return this._implementation.hasTile({x:t,y:n,z:c})}return!this.tileBounds||this.tileBounds.contains(l.canonical)}loadTile(l,t){const{x:n,y:c,z:d}=l.tileID.canonical,p=new AbortController;l.request=Promise.resolve(this._implementation.loadTile({x:n,y:c,z:d},{signal:p.signal})).then((function(_){return delete l.request,l.aborted?(l.state="unloaded",t(null)):_===void 0?(l.state="errored",t(null)):_===null?(this.loadTileData(l,{width:this.tileSize,height:this.tileSize,data:null}),l.state="loaded",t(null)):(function(v){return v instanceof ImageData||v instanceof HTMLCanvasElement||v instanceof ImageBitmap||v instanceof HTMLImageElement})(_)?(this.loadTileData(l,_),l.state="loaded",void t(null)):(l.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch((_=>{_.name!=="AbortError"&&(l.state="errored",t(_))})),l.request.cancel=()=>p.abort()}loadTileData(l,t){l.setTexture(t,this.map.painter)}unloadTile(l,t){if(l.texture&&l.texture instanceof o.T?(l.destroy(!1),l.texture&&l.texture instanceof o.T&&this.map.painter.saveTileTexture(l.texture)):l.destroy(),this._implementation.unloadTile){const{x:n,y:c,z:d}=l.tileID.canonical;this._implementation.unloadTile({x:n,y:c,z:d})}t&&t()}abortTile(l,t){l.request&&l.request.cancel&&(l.request.cancel(),delete l.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((l=>({x:l.canonical.x,y:l.canonical.y,z:l.canonical.z})))}_clearTiles(){const l=o.B(this.id,this.scope);this.map.style.clearSource(l)}_update(){this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}}},Dn=function(l,t,n,c){const d=new Us[t.type](l,t,n,c);if(d.id!==l)throw new Error(`Expected Source id to be ${l} instead of ${d.id}`);return o.aY(["load","abort","unload","serialize","prepare"],d),d};function Al(l,t,n=""){return`${n}:${t.id||""}:${t.layer.id}:${(function(c){if("layerId"in c)return`layer:${c.layerId}`;{const{featuresetId:d,importId:p}=c;return`featureset:${d}${p?`:import:${p}`:""}`}})(l.target)}`}function rc(l,t,n,c=""){if(l.uniqueFeatureID){const d=Al(l,t,c);if(n.has(d))return!0;n.add(d)}return!1}function ih(l,t,n,c,d=!1){const p=t.sourceCache.transform,_=t.sourceCache.tilesIn(l,t.has3DLayers,d);_.sort(Kc);const v=[];for(const w of _){const I=w.tile.queryRenderedFeatures(t,w,n,c,p,d);Object.keys(I).length&&v.push({wrappedTileID:w.tile.tileID.wrapped().key,queryResults:I})}for(const w in t.layers){const I=t.layers[w];if(I.styleLayer){const C=I.styleLayer.queryRenderedFeatures(l,t.sourceCache,c);Object.keys(C).length&&v.push({wrappedTileID:0,queryResults:C})}}return v.length===0?{}:(function(w){const I={},C={};for(const O of w){const D=O.queryResults,z=O.wrappedTileID,N=C[z]=C[z]||{};for(const B in D){const H=D[B],q=N[B]=N[B]||{},Y=I[B]=I[B]||[];for(const te of H)q[te.featureIndex]||(q[te.featureIndex]=!0,Y.push(te))}}return I})(v)}function rh(l,t,n,c,d,p){const _={},v=c.queryRenderedSymbols(l),w=[];for(const I of Object.keys(v).map(Number))w.push(d[I]);w.sort(Kc);for(const I of w){const C=I.featureIndex.lookupSymbolFeatures(v[I.bucketInstanceId],I.bucketIndex,I.sourceLayerIndex,t,n,p);for(const O in C){const D=_[O]=_[O]||[],z=C[O];z.sort(((N,B)=>{const H=I.featureSortOrder;if(H){const q=H.indexOf(N.featureIndex);return H.indexOf(B.featureIndex)-q}return B.featureIndex-N.featureIndex}));for(const N of z)D.push(N)}}return _}function nh(l,t){const n=l.getRenderableIds().map((p=>l.getTileByID(p))),c=[],d={};for(let p=0;p<n.length;p++){const _=n[p],v=_.tileID.canonical.key;d[v]||(d[v]=!0,_.querySourceFeatures(c,t))}return c}function Kc(l,t){const n=l.tileID,c=t.tileID;return n.overscaledZ-c.overscaledZ||n.canonical.y-c.canonical.y||n.wrap-c.wrap||n.canonical.x-c.canonical.x}function js(l,t){const n={};if(!t)return n;for(const c of l){const d=c.layerIds.map((p=>t.getLayer(p))).filter(Boolean);if(d.length!==0){c.layers=d,c.stateDependentLayerIds&&(c.stateDependentLayers=c.stateDependentLayerIds.map((p=>d.filter((_=>_.id===p))[0])));for(const p of d)n[p.fqid]=c}}return n}const bo=32,xs=33,bs=new Uint16Array(8184);for(let l=0;l<2046;l++){let t=l+2,n=0,c=0,d=0,p=0,_=0,v=0;for(1&t?d=p=_=bo:n=c=v=bo;(t>>=1)>1;){const I=n+d>>1,C=c+p>>1;1&t?(d=n,p=c,n=_,c=v):(n=d,c=p,d=_,p=v),_=I,v=C}const w=4*l;bs[w+0]=n,bs[w+1]=c,bs[w+2]=d,bs[w+3]=p}const is=new Uint16Array(2178),Gs=new Uint8Array(1089),qa=new Uint16Array(1089);function Cl(l){return l===0?-.03125:l===32?.03125:0}const oh={type:2,extent:o.al,loadGeometry:()=>[[new o.P(0,0),new o.P(o.al+1,0),new o.P(o.al+1,o.al+1),new o.P(0,o.al+1),new o.P(0,0)]]};class Ml{constructor(t,n,c,d,p,_){this.tileID=t,this.uid=o.b2(),this.uses=0,this.tileSize=n,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=p,d&&d.style&&(this._lastUpdatedBrightness=d.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",d&&d.transform&&(this.projection=d.transform.projection),this.worldview=_,this._hasAppearances=null}registerFadeDuration(t){const n=t+this.timeAdded;n<o.o.now()||this.fadeEndTime&&n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=o.aZ(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,n,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=js(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const d in this.buckets){const p=this.buckets[d];if(p instanceof o.b4){if(this.hasSymbolBuckets=!0,!c)break;p.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const d in this.buckets){const p=this.buckets[d];if(p instanceof o.b4&&p.hasRTLText){this.hasRTLText=!0,o.b5();break}}this.queryPadding=0;for(const d in this.buckets){const p=this.buckets[d],_=n.style.getOwnLayer(d);if(!_)continue;const v=_.queryRadius(p);this.queryPadding=Math.max(this.queryPadding,v)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new o.b3}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,n,c){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,js(t.buckets,n.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t,n){for(const p in this.buckets){const _=this.buckets[p];if(_.uploadPending()){let v={},w=[],I={zoom:0,pitch:0,brightness:0,worldview:""};if(n){if(n.style){w=n.style.listImages();const C=_.layers[0],O=C.sourceLayer||"_geojsonTileLayer",D=n.style.getLayerSourceCache(C);D&&(v=D._state.getState(O,void 0))}I={zoom:n.transform.zoom||0,pitch:n.transform.pitch||0,brightness:n.style.getBrightness()||0,worldview:n.worldview||""}}_.upload(t,this.tileID.canonical,v,w,I)}}const c=t.gl,d=this.imageAtlas;d&&!d.uploaded&&(this.imageAtlasTexture=new o.T(t,d.image,c.RGBA8,{useMipmap:!!d.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new o.T(t,this.glyphAtlasImage,c.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new o.T(t,this.lineAtlas.image,c.R8),this.lineAtlas.uploaded=!0)}prepare(t,n,c){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,c),!n||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const d=n.style.getBrightness();this._hasAppearances===null&&(this._hasAppearances=this.hasAppearances(n)),(this._lastUpdatedBrightness||d||this._hasAppearances)&&(!this._hasAppearances&&this._lastUpdatedBrightness&&d&&Math.abs(this._lastUpdatedBrightness-d)<.001||(this.updateBuckets(n,this._lastUpdatedBrightness!==d),this._lastUpdatedBrightness=d))}evaluateQueryRenderedFeaturePadding(){let t=0;for(const n in this.buckets){const c=this.buckets[n];c.evaluateQueryRenderedFeaturePadding&&(t=Math.max(t,c.evaluateQueryRenderedFeaturePadding()))}return t}queryRenderedFeatures(t,n,c,d,p,_){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const v=this.evaluateQueryRenderedFeaturePadding(),w=(function(I,C){const O=o.bq([],[.5*I.width,.5*-I.height,1]);return o.br(O,O,[1,-1,0]),o.aB(O,O,I.calculateProjMatrix(C.toUnwrapped())),Float32Array.from(O)})(p,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:n,pixelPosMatrix:w,transform:d,availableImages:c,tileTransform:this.tileTransform,worldview:this.worldview,queryRadius:v})}querySourceFeatures(t,n){const c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;const d=c.loadVTLayers(),p=n?n.sourceLayer:"",_=d._geojsonTileLayer||d[p];if(!_)return;const v=o.b6(n&&n.filter),{z:w,x:I,y:C}=this.tileID.canonical,O={z:w,x:I,y:C};for(let D=0;D<_.length;D++){const z=_.feature(D);if(v.needGeometry){const H=o.b7(z,!0);if(!v.filter(new o.ac(this.tileID.overscaledZ,{worldview:this.worldview}),H,this.tileID.canonical))continue}else if(!v.filter(new o.ac(this.tileID.overscaledZ,{worldview:this.worldview}),z))continue;const N=c.getId(z,p),B=new o.b8(z,w,I,C,N);B.tile=O,t.push(B)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const c=o.b9(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const c=Date.now();let d=!1;if(this.expirationTime>c)d=!1;else if(n)if(this.expirationTime<n)d=!0;else{const p=this.expirationTime-n;p?this.expirationTime=c+Math.max(p,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}hasAppearances(t){for(const n in this.buckets)if(t.style.hasLayer(n)&&this.buckets[n].layers.some((c=>c.appearances&&c.appearances.length>0)))return!0;return!1}updateBuckets(t,n){if(!this.latestFeatureIndex||!t.style)return;const c=t.style.listImages(),d=t.style.getBrightness();for(const p in this.buckets){if(!t.style.hasLayer(p))continue;const _=this.buckets[p],v=_.layers[0],w=v.sourceLayer||"_geojsonTileLayer",I=t.style.getLayerSourceCache(v);let C={};I&&(C=I._state.getState(w,void 0));const O=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},D=Object.keys(C).length>0&&!n;_.hasAppearances=_.layers.some((B=>B.appearances&&B.appearances.length>0));const z=D?_.stateDependentLayers:_.layers;if(D&&_.stateDependentLayers.length!==0||n){const B=this.latestFeatureIndex.loadVTLayers();_.update(C,B[w],c,O,z,n,d)}if(D&&_.stateDependentLayers.length!==0||n||_.hasAppearances){const B={zoom:t.transform.zoom,pitch:t.transform.pitch,brightness:t.style.getBrightness()||0,worldview:t.worldview};_.updateAppearances(this.tileID.canonical,C,c,B)}(_ instanceof o.ba||_ instanceof o.bb)&&t._terrain&&t._terrain.enabled&&I&&_.uploadPending()&&t._terrain._clearRenderCacheForTile(I.id,this.tileID);const N=t&&t.style&&t.style.getOwnLayer(p);N&&(this.queryPadding=Math.max(this.queryPadding,N.queryRadius(_)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<o.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=o.o.now()+t}setTexture(t,n){const c=n.context,d=c.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture&&this.texture instanceof o.T?this.texture.update(t):(this.texture=new o.T(c,t,d.RGBA8,{useMipmap:!0}),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE))}setDependencies(t,n){const c={};for(const d of n)c[d]=!0;this.dependencies[t]=c}hasDependency(t,n){for(const c of t){const d=this.dependencies[c];if(d){for(const p of n)if(d[p])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,n){if(!n||n.name==="mercator"||this._tileDebugBuffer)return;const c=o.bc(oh,this.tileID.canonical,this.tileTransform)[0],d=new o.bd,p=new o.be;for(let _=0;_<c.length;_++){const{x:v,y:w}=c[_];d.emplaceBack(v,w),p.emplaceBack(_)}p.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(p),this._tileDebugBuffer=t.createVertexBuffer(d,o.bf.members),this._tileDebugSegments=o.bg.simpleSegment(0,0,d.length,p.length)}_makeTileBoundsBuffers(t,n){if(this._tileBoundsBuffer||!n||n.name==="mercator")return;const c=o.bc(oh,this.tileID.canonical,this.tileTransform)[0];let d,p;if(this.isRaster){const _=(function(v,w){const I=o.aZ(v,w),C=Math.pow(2,v.z);for(let H=0;H<xs;H++)for(let q=0;q<xs;q++){const Y=o.a_((v.x+(q+Cl(q))/bo)/C),te=o.a$((v.y+(H+Cl(H))/bo)/C),J=w.project(Y,te),_e=H*xs+q;is[2*_e+0]=Math.round((J.x*I.scale-I.x)*o.al),is[2*_e+1]=Math.round((J.y*I.scale-I.y)*o.al)}Gs.fill(0),qa.fill(0);for(let H=2045;H>=0;H--){const q=4*H,Y=bs[q+0],te=bs[q+1],J=bs[q+2],_e=bs[q+3],he=Y+J>>1,pe=te+_e>>1,ce=he+pe-te,se=pe+Y-he,ye=te*xs+Y,Ce=_e*xs+J,Se=pe*xs+he,Ue=Math.hypot((is[2*ye+0]+is[2*Ce+0])/2-is[2*Se+0],(is[2*ye+1]+is[2*Ce+1])/2-is[2*Se+1])>=16;Gs[Se]=Gs[Se]||(Ue?1:0),H<1022&&(Gs[Se]=Gs[Se]||Gs[(te+se>>1)*xs+(Y+ce>>1)]||Gs[(_e+se>>1)*xs+(J+ce>>1)])}const O=new o.b1,D=new o.b0;let z=0;function N(H,q){const Y=q*xs+H;return qa[Y]===0&&(O.emplaceBack(is[2*Y+0],is[2*Y+1],H*o.al/bo,q*o.al/bo),qa[Y]=++z),qa[Y]-1}function B(H,q,Y,te,J,_e){const he=H+Y>>1,pe=q+te>>1;if(Math.abs(H-J)+Math.abs(q-_e)>1&&Gs[pe*xs+he])B(J,_e,H,q,he,pe),B(Y,te,J,_e,he,pe);else{const ce=N(H,q),se=N(Y,te),ye=N(J,_e);D.emplaceBack(ce,se,ye)}}return B(0,0,bo,bo,bo,0),B(bo,bo,0,0,0,bo),{vertices:O,indices:D}})(this.tileID.canonical,n);d=_.vertices,p=_.indices}else{d=new o.b1,p=new o.b0;for(const{x:v,y:w}of c)d.emplaceBack(v,w,0,0);const _=o.bh(d.int16.subarray(0,4*d.length),void 0,4);for(let v=0;v<_.length;v+=3)p.emplaceBack(_[v],_[v+1],_[v+2])}this._tileBoundsBuffer=t.createVertexBuffer(d,o.bi.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(p),this._tileBoundsSegments=o.bg.simpleSegment(0,0,d.length,p.length)}_makeGlobeTileDebugBuffers(t,n){const c=n.projection;if(!c||c.name!=="globe"||n.freezeTileCoverage)return;const d=this.tileID.canonical,p=o.bj(d,n),_=o.bk(p),v=o.aj(n.zoom);let w;v>0&&(w=o.bl(new Float64Array(16),n.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,d,n,_,w,v),this._makeGlobeTileDebugTextBuffer(t,d,n,_,w,v)}_globePoint(t,n,c,d,p,_,v){let w=o.bm(t,n,c);if(_){const I=1<<c.z,C=o.aF(d.center.lng),O=o.aJ(d.center.lat),D=(c.x+.5)/I-C;let z=0;D>.5?z=-1:D<-.5&&(z=1);let N=(t/o.al+c.x)/I+z,B=(n/o.al+c.y)/I;N=(N-C)*d._pixelsPerMercatorPixel+C,B=(B-O)*d._pixelsPerMercatorPixel+O;const H=[N*d.worldSize,B*d.worldSize,0];o.af(H,H,_),w=o.bn(w,H,v)}return o.af(w,w,p)}_makeGlobeTileDebugBorderBuffer(t,n,c,d,p,_){const v=new o.bd,w=new o.be,I=new o.bo,C=(D,z,N,B,H)=>{const q=(N-D)/(H-1),Y=(B-z)/(H-1),te=v.length;for(let J=0;J<H;J++){const _e=D+J*q,he=z+J*Y;v.emplaceBack(_e,he);const pe=this._globePoint(_e,he,n,c,d,p,_);I.emplaceBack(pe[0],pe[1],pe[2]),w.emplaceBack(te+J)}},O=o.al;C(0,0,O,0,16),C(O,0,O,O,16),C(O,O,0,O,16),C(0,O,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(w),this._tileDebugBuffer=t.createVertexBuffer(v,o.bf.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(I,o.bp.members),this._tileDebugSegments=o.bg.simpleSegment(0,0,v.length,w.length)}_makeGlobeTileDebugTextBuffer(t,n,c,d,p,_){const v=o.al/4,w=new o.bd,I=new o.b0,C=new o.bo,O=25;I.reserve(32),w.reserve(O),C.reserve(O);const D=(z,N)=>O*z+N;for(let z=0;z<O;z++){const N=z*v;for(let B=0;B<O;B++){const H=B*v;w.emplaceBack(H,N);const q=this._globePoint(H,N,n,c,d,p,_);C.emplaceBack(q[0],q[1],q[2])}}for(let z=0;z<4;z++)for(let N=0;N<4;N++){const B=D(z,N),H=D(z,N+1),q=D(z+1,N),Y=D(z+1,N+1);I.emplaceBack(B,H,q),I.emplaceBack(q,H,Y)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(I),this._tileDebugTextBuffer=t.createVertexBuffer(w,o.bf.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(C,o.bp.members),this._tileDebugTextSegments=o.bg.simpleSegment(0,0,O,32)}destroy(t=!0){for(const n in this.buckets)this.buckets[n].destroy(t);this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),t&&this.texture&&this.texture instanceof o.T&&(this.texture.destroy(),delete this.texture),this.emissiveTexture&&this.emissiveTexture instanceof o.T&&(this.emissiveTexture.destroy(),delete this.emissiveTexture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}o.bs.setPbf(o.bt);class sh extends Ml{constructor(t,n,c,d,p){super(t,n,c,d,p),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,n,c){const d=c.context,p=d.gl;let _=this.texturePerLayer.get(t)||c.getTileTexture(n.width);_&&_ instanceof o.T?_.update(n,{premultiply:!1}):_=new o.T(d,n,p.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,_)}flushQueues(t){const n=this._workQueuePerLayer.get(t)||[],c=this._fetchQueuePerLayer.get(t)||[];for(;n.length;)n.pop()();for(;c.length;)c.pop()()}flushAllQueues(){for(const t of this._workQueuePerLayer.keys()){const n=this._workQueuePerLayer.get(t)||[];for(;n.length;)n.pop()()}for(const t of this._fetchQueuePerLayer.keys()){const n=this._fetchQueuePerLayer.get(t)||[];for(;n.length;)n.pop()()}}fetchHeader(t=16384,n){const c=this._mrt=new o.bs(30),d=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=o.bu(d,((p,_,v)=>{if(p)n(p);else try{const w=c.getHeaderLength(_);if(w>t)return void(this.request=this.fetchHeader(w,n));c.parseHeader(_),this._isHeaderLoaded=!0;let I=0;for(const C of Object.values(c.layers))I=Math.max(I,C.dataIndex[C.dataIndex.length-1].lastByte);_.byteLength>=I&&(this.entireBuffer=_),n(null,this.entireBuffer||_,v)}catch(w){n(w)}})),this.request}fetchBandForRender(t,n,c,d){this.fetchBand(t,n,c,(p=>{if(p)return void d(p);this.updateTextureDescriptor(t,n,c);const _=this.textureDescriptorPerLayer.get(n);d(null,_?_.img:null)}))}fetchBand(t,n,c,d,p=!0){const _=this._mrt;if(!this._isHeaderLoaded||!_)return void d(new Error("Tile header is not ready"));const v=this.actor;if(!v)return void d(new Error("Can't fetch tile band without an actor"));let w;const I=o.B(String(c),o.B(this.tileID.key,t));let C=this._taskQueue.get(I);C?C.add(d):(C=new Set,C.add(d),this._taskQueue.set(I,C));const O=(B,H)=>{w.complete(B,H),B?d(B):(C.forEach((q=>q(null,H))),this._taskQueue.delete(I))},D=(B,H)=>{if(B)return d(B);const q=v.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:H,task:w},O,void 0,!0);if(n!==null){const Y=this._workQueuePerLayer.get(n)||[];Y.push((()=>{q&&q.cancel(),w.cancel()})),this._workQueuePerLayer.has(n)||this._workQueuePerLayer.set(n,Y)}};let z;try{z=_.getLayer(t)}catch(B){if(this.state==="reloading")return;throw B}if(!z)return void d(new Error(`Unknown sourceLayer "${t}"`));if(z.hasDataForBand(c))return C.forEach((B=>B(null,null))),void this._taskQueue.delete(I);const N=z.getDataRange([c]);if(w=_.createDecodingTask(N),!w||w.tasks.length)if(n!==null&&this.flushQueues(n),this.entireBuffer)D(null,this.entireBuffer.slice(N.firstByte,N.lastByte+1));else{const B=Object.assign({},this.requestParams,{headers:{Range:`bytes=${N.firstByte}-${N.lastByte}`}}),H=o.bu(B,D);if(n!==null){const q=this._fetchQueuePerLayer.get(n)||[];q.push((()=>{H.cancel(),w.cancel()})),this._fetchQueuePerLayer.has(n)||this._fetchQueuePerLayer.set(n,q)}}}updateNeeded(t,n){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==n||this.refreshedUponExpiration)&&this.state!=="errored"}updateTextureDescriptor(t,n,c){if(!this._mrt)return;const d=this._mrt.getLayer(t);if(!d||!d.hasBand(c)||!d.hasDataForBand(c))return;const{bytes:p,tileSize:_,buffer:v,offset:w,scale:I}=d.getBandView(c),C=_+2*v,O=new o.q({width:C,height:C},p),D=this.texturePerLayer.get(n);D&&D instanceof o.T&&D.update(O,{premultiply:!1}),this.textureDescriptorPerLayer.set(n,{layer:t,band:c,img:O,buffer:v,offset:w,tileSize:_,format:d.pixelFormat,mix:[I,256*I,65536*I,16777216*I]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(const n of this.texturePerLayer.values())n&&n instanceof o.T&&n.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class bm{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,c){const d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);const p={value:n,timeout:void 0};if(c!==void 0&&(p.timeout=setTimeout((()=>{this.remove(t,p)}),c)),this.data[d].push(p),this.order.push(d),this.order.length>this.max){const _=this._getAndRemoveByKey(this.order[0]);_&&this.onRemove(_)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const c=t.wrapped().key,d=n===void 0?0:this.data[c].indexOf(n),p=this.data[c][d];return this.data[c].splice(d,1),p.timeout&&clearTimeout(p.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(p.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const c in this.data)for(const d of this.data[c])t(d.value)||n.push(d);for(const c of n)this.remove(c.value.tileID,c)}}class Qc{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,c){const d=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},Object.assign(this.stateChanges[t][d],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(const p in this.state[t])p!==d&&(this.deletedStates[t][p]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(const p in this.state[t][d])c[p]||(this.deletedStates[t][d][p]=null)}else for(const p in c)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][p]===null&&delete this.deletedStates[t][d][p]}removeFeatureState(t,n,c){if(this.deletedStates[t]===null)return;const d=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&n!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][c]=null);else if(n!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(c in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][c]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,n){const c=this.state[t]||{},d=this.stateChanges[t]||{},p=this.deletedStates[t];if(p===null)return{};if(n!==void 0){const v=String(n),w=Object.assign({},c[v],d[v]);if(p){const I=p[n];if(I===null)return{};for(const C in I)delete w[C]}return w}const _=Object.assign({},c,d);if(p)for(const v in p)delete _[v];return _}initializeTileState(t,n){t.refreshFeatureState(n)}coalesceChanges(t,n){const c={};for(const d in this.stateChanges){this.state[d]=this.state[d]||{};const p={};for(const _ in this.stateChanges[d])this.state[d][_]||(this.state[d][_]={}),Object.assign(this.state[d][_],this.stateChanges[d][_]),p[_]=this.state[d][_];c[d]=p}for(const d in this.deletedStates){this.state[d]=this.state[d]||{};const p={};if(this.deletedStates[d]===null)for(const _ in this.state[d])p[_]={},this.state[d][_]={};else for(const _ in this.deletedStates[d]){if(this.deletedStates[d][_]===null)this.state[d][_]={};else if(this.state[d][_])for(const v of Object.keys(this.deletedStates[d][_]))delete this.state[d][_][v];p[_]=this.state[d][_]}c[d]=c[d]||{},Object.assign(c[d],p)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(const d in t)t[d].refreshFeatureState(n)}}class Po extends o.E{constructor(t,n,c){super(),this.id=t,this._onlySymbols=c,n.on("data",(d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))})),n.on("error",(()=>{this._sourceErrored=!0})),this._source=n,this._tiles={},this._cache=new bm(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=n.minTileCacheSize,this._maxTileCacheSize=n.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Qc,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,n){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,n)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const c=this._tiles[n];c.upload(t,this.map?this.map.painter:void 0),c.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map((t=>t.tileID)).sort(ah).map((t=>t.key))}getRenderableIds(t,n){const c=[];for(const d in this._tiles)this._isIdRenderable(+d,t,n)&&c.push(this._tiles[d]);return t?c.sort(((d,p)=>{const _=d.tileID,v=p.tileID,w=new o.P(_.canonical.x,_.canonical.y)._rotate(this.transform.angle),I=new o.P(v.canonical.x,v.canonical.y)._rotate(this.transform.angle);return _.overscaledZ-v.overscaledZ||I.y-w.y||I.x-w.x})).map((d=>d.tileID.key)):c.map((d=>d.tileID)).sort(ah).map((d=>d.key))}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n,c){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())&&(c||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,n){const c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=n),this._loadTile(c,this._tileLoaded.bind(this,c,t,n)))}_tileLoaded(t,n,c,d,p){if(d){if(t.state="errored",d.status!==404)this._source.fire(new o.y(d,{tile:t}));else{if(this._source.fire(new o.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const v=this.map.painter.terrain;this.update(this.transform,v.getScaledDemTileSize(),!0),v.resetTileLookupCache(this.id)}else this.update(this.transform)}return}t.timeAdded=o.o.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null);let _=new Map;p&&p.responseHeaders&&(_=p.responseHeaders),this._source.fire(new o.z("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id,responseHeaders:_}))}_backfillDEM(t){const n=this.getRenderableIds();for(let d=0;d<n.length;d++){const p=n[d];if(t.neighboringTiles&&t.neighboringTiles[p]){const _=this.getTileByID(p);c(t,_),c(_,t)}}function c(d,p){if(!d.dem||d.dem.borderReady)return;d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0;let _=p.tileID.canonical.x-d.tileID.canonical.x;const v=p.tileID.canonical.y-d.tileID.canonical.y,w=Math.pow(2,d.tileID.canonical.z),I=p.tileID.key;_===0&&v===0||Math.abs(v)>1||(Math.abs(_)>1&&(Math.abs(_+w)===1?_+=w:Math.abs(_-w)===1&&(_-=w)),p.dem&&d.dem&&(d.dem.backfillBorder(p.dem,_,v),d.neighboringTiles&&d.neighboringTiles[I]&&(d.neighboringTiles[I].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,c,d){for(const p in this._tiles){let _=this._tiles[p];if(d[p]||!_.hasData()||_.tileID.overscaledZ<=n||_.tileID.overscaledZ>c)continue;let v=_.tileID;for(;_&&_.tileID.overscaledZ>n+1;){const I=_.tileID.scaledTo(_.tileID.overscaledZ-1);_=this._tiles[I.key],_&&_.hasData()&&(v=I)}let w=v;for(;w.overscaledZ>n;)if(w=w.scaledTo(w.overscaledZ-1),t[w.key]){d[v.key]=v;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=n?c:null}for(let c=t.overscaledZ-1;c>=n;c--){const d=t.scaledTo(c),p=this._getLoadedTile(d);if(p)return p}}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,n){n=n||this._source.tileSize;const c=Math.ceil(t.width/n)+1,d=Math.ceil(t.height/n)+1,p=Math.floor(c*d*5),_=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,p):p,v=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,_):_;this._cache.setMaxSize(v)}handleWrapJump(t){const n=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,n){const c={};for(const d in this._tiles){const p=this._tiles[d];p.tileID=p.tileID.unwrapTo(p.tileID.wrap+n),c[p.tileID.key]=p}this._tiles=c;for(const d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(const d in this._tiles)this._setTileReloadTimer(+d,this._tiles[d])}}update(t,n,c,d,p){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;this.updateCacheSize(t,n),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const _=this._source.type==="batched-model";let v,w=this._source.maxzoom;const I=this.map&&this.map.painter?this.map.painter._terrain:null;if(I&&I.sourceCache===this&&I.attenuationRange()){const D=I.attenuationRange()[0],z=Math.floor(D)-Math.log2(I.getDemUpscale());w>z&&(w=z)}if(this.used||this.usedForTerrain){if(this._source.tileID)v=t.getVisibleUnwrappedCoordinates(this._source.tileID).map((D=>new o.aQ(D.canonical.z,D.wrap,D.canonical.z,D.canonical.x,D.canonical.y)));else if(this.tileCoverLift!==0){const D=t.clone();D.tileCoverLift=this.tileCoverLift,v=D.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:w,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:_}),this._source.minzoom<=1&&t.projection.name==="globe"&&(v.push(new o.aQ(1,0,1,0,0)),v.push(new o.aQ(1,0,1,1,0)),v.push(new o.aQ(1,0,1,0,1)),v.push(new o.aQ(1,0,1,1,1)))}else if(v=t.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:w,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:_}),this._source.hasTile){const D=this._source.hasTile.bind(this._source);v=v.filter((z=>D(z)))}}else v=[];if(v.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Pl(this._source.type)){const D=t.coveringZoomLevel({tileSize:n||this._source.tileSize,roundZoom:this._source.roundZoom&&!c}),z=Math.min(D,this._source.maxzoom);if(_){const N=t.extendTileCover(v,z);for(const B of N)v.push(B)}else if(p){const N=t.extendTileCoverToNearPlane(v,this.transform.getFrustum(z),z);for(const B of N)v.push(B)}else if(this.castsShadows&&d){const N=t.extendTileCover(v,z,d,16);for(const B of N)this._shadowCasterTiles[B.key]=!0,v.push(B)}}const C=this._updateRetainedTiles(v);if(Pl(this._source.type)&&v.length!==0){const D={},z={},N=Object.keys(C);for(const H of N){const q=C[H],Y=this._tiles[H];if(!Y||Y.fadeEndTime&&Y.fadeEndTime<=o.o.now())continue;const te=this.findLoadedParent(q,Math.max(q.overscaledZ-Po.maxOverzooming,this._source.minzoom));te&&(this._addTile(te.tileID),D[te.tileID.key]=te.tileID),z[H]=q}const B=v[v.length-1].overscaledZ;for(const H in this._tiles){const q=this._tiles[H];if(C[H]||!q.hasData())continue;let Y=q.tileID;for(;Y.overscaledZ>B;){Y=Y.scaledTo(Y.overscaledZ-1);const te=this._tiles[Y.key];if(te&&te.hasData()&&z[Y.key]){C[H]=q.tileID;break}}}for(const H in D)C[H]||(this._coveredTiles[H]=!0,C[H]=D[H])}for(const D in C)this._tiles[D].clearFadeHold();const O=o.bv(this._tiles,C);for(const D of O){const z=this._tiles[D];z.hasSymbolBuckets&&!z.holdingForFade()?z.setHoldDuration(this.map._fadeDuration):z.hasSymbolBuckets&&!z.symbolFadeFinished()||this._removeTile(+D)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const n={};if(t.length===0)return n;const c={},d=t.reduce(((I,C)=>Math.min(I,C.overscaledZ)),1/0),p=t[0].overscaledZ,_=Math.max(p-Po.maxOverzooming,this._source.minzoom),v=Math.max(p+Po.maxUnderzooming,this._source.minzoom),w={};for(const I of t){const C=this._addTile(I);n[I.key]=I,C.hasData()||d<this._source.maxzoom&&(w[I.key]=I)}this._retainLoadedChildren(w,d,v,n);for(const I of t){let C=this._tiles[I.key];if(C.hasData())continue;if(I.canonical.z>=this._source.maxzoom){const D=I.children(this._source.maxzoom)[0],z=this.getTile(D);if(z&&z.hasData()){n[D.key]=D;continue}}else{const D=I.children(this._source.maxzoom);if(n[D[0].key]&&n[D[1].key]&&n[D[2].key]&&n[D[3].key])continue}let O=C.wasRequested();for(let D=I.overscaledZ-1;D>=_;--D){const z=I.scaledTo(D);if(c[z.key]||(c[z.key]=!0,C=this.getTile(z),!C&&O&&(C=this._addTile(z)),C&&(n[z.key]=z,O=C.wasRequested(),C.hasData())))break}}return n}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let c,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){c=this._loadedParentTiles[d.key];break}n.push(d.key);const p=d.scaledTo(d.overscaledZ-1);if(c=this._getLoadedTile(p),c)break;d=p}for(const p of n)this._loadedParentTiles[p]=c}}_addTile(t){let n=this._tiles[t.key];if(n)return n.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const c=!!n;if(!c){const d=this.map?this.map.painter:null,p=this._source.tileSize*t.overscaleFactor();n=this._source.type==="raster-array"?new sh(t,p,this.transform.tileZoom,d,this._isRaster):new Ml(t,p,this.transform.tileZoom,d,this._isRaster,this._source.worldview),this._loadTile(n,this._tileLoaded.bind(this,n,t.key,n.state))}return n.uses++,this._tiles[t.key]=n,c||this._source.fire(new o.z("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const c=n.getExpiryTimeout();c&&(this._timers[t]=setTimeout((()=>{this._reloadTile(t,"expired"),delete this._timers[t]}),c))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&n.state!=="reloading"||n.state==="empty"?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,n,c){const d=[],p=this.transform;if(!p)return d;const _=p.projection.name==="globe",v=o.aF(p.center.lng);for(const w in this._tiles){const I=this._tiles[w];if(c&&I.clearQueryDebugViz(),I.holdingForFade())continue;let C;if(_){const O=I.tileID.canonical;if(O.z===0){const D=[Math.abs(o.aA(v,...da(O,-1))-v),Math.abs(o.aA(v,...da(O,1))-v)];C=[0,2*D.indexOf(Math.min(...D))-1]}else{const D=[Math.abs(o.aA(v,...da(O,-1))-v),Math.abs(o.aA(v,...da(O,0))-v),Math.abs(o.aA(v,...da(O,1))-v)];C=[D.indexOf(Math.min(...D))-1]}}else C=[0];for(const O of C){const D=t.containsTile(I,p,n,O);D&&d.push(D)}}return d}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,n){const c=this.getRenderableIds(t,n).map((p=>this._tiles[p].tileID)),d=this.transform.projection.name==="globe";for(const p of c)p.projMatrix=this.transform.calculateProjMatrix(p.toUnwrapped()),p.expandedProjMatrix=d?this.transform.calculateProjMatrix(p.toUnwrapped(),!1,!0):p.projMatrix;return c}sortCoordinatesByDistance(t){const n=t.slice(),c=this.transform._camera.position,d=this.transform._camera.forward(),p={};for(const _ of n){const v=1/(1<<_.canonical.z);p[_.key]=((_.canonical.x+.5)*v+_.wrap-c[0])*d[0]+((_.canonical.y+.5)*v-c[1])*d[1]-c[2]*d[2]}return n.sort(((_,v)=>p[_.key]-p[v.key])),n}hasTransition(){if(this._source.hasTransition())return!0;if(Pl(this._source.type))for(const t in this._tiles){const n=this._tiles[t];if(n.fadeEndTime!==void 0&&n.fadeEndTime>=o.o.now())return!0}return!1}setFeatureState(t,n,c){this._state.updateState(t=t||"_geojsonTileLayer",n,c)}removeFeatureState(t,n,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,c)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,c){const d=this._tiles[t];d&&d.setDependencies(n,c)}reloadTilesForDependencies(t,n){for(const c in this._tiles)this._tiles[c].hasDependency(t,n)&&this._reloadTile(+c,"reloading");this._cache.filter((c=>!c.hasDependency(t,n)))}_preloadTiles(t,n){if(!this._sourceLoaded){const w=()=>{this._sourceLoaded&&(this._source.off("data",w),this._preloadTiles(t,n))};return void this._source.on("data",w)}const c=new Map,d=Array.isArray(t)?t:[t],p=this.map.painter.terrain,_=this.usedForTerrain&&p?p.getScaledDemTileSize():this._source.tileSize;for(const w of d){const I=w.coveringTiles({tileSize:_,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const C of I)c.set(C.key,C);this.usedForTerrain&&w.updateElevation(!1)}const v=Array.from(c.values());o.bw(v,((w,I)=>{const C=new Ml(w,this._source.tileSize*w.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(C,(O=>{this._source.type==="raster-dem"&&C.dem&&this._backfillDEM(C),I(O,C)}))}),n)}}function ah(l,t){const n=Math.abs(2*l.wrap)-+(l.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return l.overscaledZ-t.overscaledZ||c-n||t.canonical.y-l.canonical.y||t.canonical.x-l.canonical.x}function Pl(l){return l==="raster"||l==="image"||l==="video"||l==="custom"}function da(l,t){const n=1<<l.z;return[l.x/n+t,(l.x+1)/n+t]}Po.maxOverzooming=10,Po.maxUnderzooming=3;class oy{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,n=!1;for(const c in this.style._mergedLayers){const d=this.style._mergedLayers[c];if(d.type==="fill-extrusion"||d.type==="building")this.layers.push({layer:d,visible:t,visibilityChanged:n});else if(d.type==="model"){const p=this.style.getLayerSource(d);p&&p.type==="batched-model"&&this.layers.push({layer:d,visible:t,visibilityChanged:n})}}}onNewFrame(t){this.layersGotHidden=!1;for(const n of this.layers){const c=n.layer;let d=!1;c.type==="fill-extrusion"?d=!c.isHidden(t)&&c.paint.get("fill-extrusion-opacity")>0:c.type==="building"?d=!c.isHidden(t)&&c.paint.get("building-opacity")>0:c.type==="model"&&(d=!c.isHidden(t)&&c.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!d&&n.visible,n.visible=d}}updateZOffset(t,n){this.currentBuildingBuckets=[];for(const d of this.layers){const p=d.layer,_=this.style.getLayerSourceCache(p);let v=1;p.type==="fill-extrusion"?v=d.visible?p.paint.get("fill-extrusion-vertical-scale"):0:p.type==="building"&&(v=d.visible?p.paint.get("building-vertical-scale"):0);let w=_?_.getTile(n):null;if(!w&&_)for(const I in _._tiles){const C=_._tiles[I];if(n.canonical.isChildOf(C.tileID.canonical)){w=C;break}}this.currentBuildingBuckets.push({bucket:w?w.getBucket(p):null,tileID:w?w.tileID:n,verticalScale:v})}t.hasAnyZOffset=!1;let c=!1;for(let d=0;d<t.symbolInstances.length;d++){const p=t.symbolInstances.get(d),_=p.zOffset,v=this._getHeightAtTileOffset(n,p.tileAnchorX,p.tileAnchorY);p.zOffset=v!==Number.NEGATIVE_INFINITY?v:_,c||_===p.zOffset||(c=!0),t.hasAnyZOffset||p.zOffset===0||(t.hasAnyZOffset=!0)}c&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,n,c,d){let p=n,_=c;if(t.canonical.z!==d.canonical.z){const v=d.canonical,w=1/(1<<t.canonical.z-v.z);p=(n+t.canonical.x*o.al)*w-v.x*o.al|0,_=(c+t.canonical.y*o.al)*w-v.y*o.al|0}return{tileX:p,tileY:_}}_getHeightAtTileOffset(t,n,c){let d,p;for(let _=0;_<this.layers.length;++_){const v=this.layers[_].layer;if(v.type!=="fill-extrusion"&&v.type!=="building")continue;const{bucket:w,tileID:I,verticalScale:C}=this.currentBuildingBuckets[_];if(!w)continue;const{tileX:O,tileY:D}=this._mapCoordToOverlappingTile(t,n,c,I),z=w.getHeightAtTileCoord(O,D);z&&z.height!==void 0&&(z.hidden?d=z.height:p=Math.max(z.height*C,p||0))}if(p!==void 0)return p;for(let _=0;_<this.layers.length;++_){const v=this.layers[_];if(v.layer.type!=="model"||!v.visible)continue;const{bucket:w,tileID:I}=this.currentBuildingBuckets[_];if(!w)continue;const{tileX:C,tileY:O}=this._mapCoordToOverlappingTile(t,n,c,I),D=w.getHeightAtTileCoord(C,O);if(D&&!D.hidden)return D.height===void 0&&d!==void 0?Math.min(D.maxHeight,d)*D.verticalScale:D.height?D.height*D.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function wm(l,t){const n={};for(const c in l)c!=="ref"&&(n[c]=l[c]);return o.bx.forEach((c=>{c in t&&(n[c]=t[c])})),n}function eu(l){l=l.slice();const t=Object.create(null);for(let n=0;n<l.length;n++)t[l[n].id]=l[n];for(let n=0;n<l.length;n++)"ref"in l[n]&&(l[n]=wm(l[n],t[l[n].ref]));return l}const Wi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function lh(l,t,n){n.push({command:Wi.addSource,args:[l,t[l]]})}function rf(l,t,n){t.push({command:Wi.removeSource,args:[l]}),n[l]=!0}function Tm(l,t,n,c){rf(l,n,c),lh(l,t,n)}function Em(l,t,n){let c;for(c in l[n])if(l[n].hasOwnProperty(c)&&c!=="data"&&!o.by(l[n][c],t[n][c]))return!1;for(c in t[n])if(t[n].hasOwnProperty(c)&&c!=="data"&&!o.by(l[n][c],t[n][c]))return!1;return!0}function Ha(l,t,n,c,d,p){let _;for(_ in t=t||{},l=l||{})l.hasOwnProperty(_)&&(o.by(l[_],t[_])||n.push({command:p,args:[c,_,t[_],d]}));for(_ in t)t.hasOwnProperty(_)&&!l.hasOwnProperty(_)&&(o.by(l[_],t[_])||n.push({command:p,args:[c,_,t[_],d]}))}function tu(l){return l.id}function iu(l,t){return l[t.id]=t,l}function nf(l,t,n){const c=t.createTileMatrix(l,l.worldSize,n.toUnwrapped());return o.aB(new Float32Array(16),l.projMatrix,c)}function ch(l,t,n){if(t.projection.name===n.projection.name)return l.projMatrix;const c=n.clone();return c.setProjection(t.projection),nf(c,t.getProjection(),l)}function qs(l,t,n){return t.name===n.projection.name?l.projMatrix:nf(n,t,l)}class ru{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=o.aA(t,0,1);let n=1,c=this._distances[n];const d=t*this.paddedLength+this.padding;for(;c<d&&n<this._distances.length;)c=this._distances[++n];const p=n-1,_=this._distances[p],v=c-_,w=v>0?(d-_)/v:0;return this.points[p].mult(1-w).add(this.points[n].mult(w))}}class of{constructor(t,n,c){const d=this.boxCells=[],p=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(n/c);for(let _=0;_<this.xCellCount*this.yCellCount;_++)d.push([]),p.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,c,d,p){this._forEachCell(n,c,d,p,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(p)}insertCircle(t,n,c,d){this._forEachCell(n-d,c-d,n+d,c+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(c),this.circles.push(d)}_insertBoxCell(t,n,c,d,p,_){this.boxCells[p].push(_)}_insertCircleCell(t,n,c,d,p,_){this.circleCells[p].push(_)}_query(t,n,c,d,p,_){if(c<0||t>this.width||d<0||n>this.height)return!p&&[];const v=[];if(t<=0&&n<=0&&this.width<=c&&this.height<=d){if(p)return!0;for(let w=0;w<this.boxKeys.length;w++)v.push({key:this.boxKeys[w],x1:this.bboxes[4*w],y1:this.bboxes[4*w+1],x2:this.bboxes[4*w+2],y2:this.bboxes[4*w+3]});for(let w=0;w<this.circleKeys.length;w++){const I=this.circles[3*w],C=this.circles[3*w+1],O=this.circles[3*w+2];v.push({key:this.circleKeys[w],x1:I-O,y1:C-O,x2:I+O,y2:C+O})}return _?v.filter(_):v}return this._forEachCell(t,n,c,d,this._queryCell,v,{hitTest:p,seenUids:{box:{},circle:{}}},_),p?v.length>0:v}_queryCircle(t,n,c,d,p){const _=t-c,v=t+c,w=n-c,I=n+c;if(v<0||_>this.width||I<0||w>this.height)return!d&&[];const C=[];return this._forEachCell(_,w,v,I,this._queryCellCircle,C,{hitTest:d,circle:{x:t,y:n,radius:c},seenUids:{box:{},circle:{}}},p),d?C.length>0:C}query(t,n,c,d,p){return this._query(t,n,c,d,!1,p)}hitTest(t,n,c,d,p){return this._query(t,n,c,d,!0,p)}hitTestCircle(t,n,c,d){return this._queryCircle(t,n,c,!0,d)}_queryCell(t,n,c,d,p,_,v,w){const I=v.seenUids,C=this.boxCells[p];if(C!==null){const D=this.bboxes;for(const z of C)if(!I.box[z]){I.box[z]=!0;const N=4*z;if(t<=D[N+2]&&n<=D[N+3]&&c>=D[N+0]&&d>=D[N+1]&&(!w||w(this.boxKeys[z]))){if(v.hitTest)return _.push(!0),!0;_.push({key:this.boxKeys[z],x1:D[N],y1:D[N+1],x2:D[N+2],y2:D[N+3]})}}}const O=this.circleCells[p];if(O!==null){const D=this.circles;for(const z of O)if(!I.circle[z]){I.circle[z]=!0;const N=3*z;if(this._circleAndRectCollide(D[N],D[N+1],D[N+2],t,n,c,d)&&(!w||w(this.circleKeys[z]))){if(v.hitTest)return _.push(!0),!0;{const B=D[N],H=D[N+1],q=D[N+2];_.push({key:this.circleKeys[z],x1:B-q,y1:H-q,x2:B+q,y2:H+q})}}}}}_queryCellCircle(t,n,c,d,p,_,v,w){const I=v.circle,C=v.seenUids,O=this.boxCells[p];if(O!==null){const z=this.bboxes;for(const N of O)if(!C.box[N]){C.box[N]=!0;const B=4*N;if(this._circleAndRectCollide(I.x,I.y,I.radius,z[B+0],z[B+1],z[B+2],z[B+3])&&(!w||w(this.boxKeys[N])))return _.push(!0),!0}}const D=this.circleCells[p];if(D!==null){const z=this.circles;for(const N of D)if(!C.circle[N]){C.circle[N]=!0;const B=3*N;if(this._circlesCollide(z[B],z[B+1],z[B+2],I.x,I.y,I.radius)&&(!w||w(this.circleKeys[N])))return _.push(!0),!0}}}_forEachCell(t,n,c,d,p,_,v,w){const I=this._convertToXCellCoord(t),C=this._convertToYCellCoord(n),O=this._convertToXCellCoord(c),D=this._convertToYCellCoord(d);for(let z=I;z<=O;z++)for(let N=C;N<=D;N++)if(p.call(this,t,n,c,d,this.xCellCount*N+z,_,v,w))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,c,d,p,_){const v=d-t,w=p-n,I=c+_;return I*I>v*v+w*w}_circleAndRectCollide(t,n,c,d,p,_,v){const w=(_-d)/2,I=Math.abs(t-(d+w));if(I>w+c)return!1;const C=(v-p)/2,O=Math.abs(n-(p+C));if(O>C+c)return!1;if(I<=w||O<=C)return!0;const D=I-w,z=O-C;return D*D+z*z<=c*c}}const Za={unknown:0,flipRequired:1,flipNotRequired:2},Ll=Math.tan(85*Math.PI/180);function so(l,t,n,c,d,p,_){const v=o.bC();if(n)if(p.name==="globe"){const w=o.bD(d,t);o.aB(v,v,w)}else{const w=o.bE([],_);v[0]=w[0],v[1]=w[1],v[4]=w[2],v[5]=w[3],c||o.bB(v,v,d.angle)}else o.aB(v,d.labelPlaneMatrix,l);return v}function uh(l,t,n,c,d,p,_){const v=so(l,t,n,c,d,p,_);return p.name==="globe"&&n||(v[2]=v[6]=v[10]=v[14]=0),v}function nu(l,t,n,c,d,p,_){if(n){if(p.name==="globe"){const v=so(l,t,n,c,d,p,_);return o.bl(v,v),o.aB(v,l,v),v}{const v=o.bz(l),w=o.bA([]);return w[0]=_[0],w[1]=_[1],w[4]=_[2],w[5]=_[3],o.aB(v,v,w),c||o.bB(v,v,-d.angle),v}}return d.glCoordMatrix}function rs(l,t,n,c){const d=[l,t,n,1];n?o.aC(d,d,c):Gt(d,d,c);const p=d[3];return d[0]/=p,d[1]/=p,d[2]/=p,d}function lr(l,t){return Math.min(.5+l/t*.5,1.5)}function Sm(l,t){const n=l[0]/l[3],c=l[1]/l[3];return n>=-t[0]&&n<=t[0]&&c>=-t[1]&&c<=t[1]}function Im(l,t,n,c,d,p,_,v,w,I,C=1){const O=n.transform,D=c?l.textSizeData:l.iconSizeData,z=o.bK(D,n.transform.zoom,C),N=O.projection.name==="globe",B=[256/n.width*2+1,256/n.height*2+1],H=c?l.text.dynamicLayoutVertexArray:l.icon.dynamicLayoutVertexArray;H.clear();let q=null;N&&(q=c?l.text.globeExtVertexArray:l.icon.globeExtVertexArray);const Y=l.lineVertexArray,te=c?l.text.placedSymbolArray:l.icon.placedSymbolArray,J=n.transform.width/n.transform.height;let _e,he=!1;for(let pe=0;pe<te.length;pe++){const ce=te.get(pe),{numGlyphs:se,writingMode:ye}=ce;if(ye!==o.bL.vertical||he||_e===o.bL.horizontal||(he=!0),_e=ye,(ce.hidden||ye===o.bL.vertical)&&!he){ws(se,H);continue}he=!1;const Ce=new o.P(ce.tileAnchorX,ce.tileAnchorY),Se=l.elevationType==="road",Ue=!!O.elevation||Se;let{x:je,y:Xe,z:ht}=O.projection.projectTilePoint(Ce.x,Ce.y,I.canonical),ke=null;if(Ue){const At=Se?l.getElevationFeatureForText(pe):null;ke={getElevation:w,elevation:O.elevation,elevationFeature:At};const[Wt,ci,Di]=w(Ce,O.elevation,At);je+=Wt,Xe+=ci,ht+=Di}const we=[je,Xe,ht,1];if(o.aC(we,we,t),!Sm(we,B)){ws(se,H);continue}const He=we[3],Be=lr(n.transform.getCameraToCenterDistance(O.projection),He),et=o.bM(D,z,ce),vt=_?et/Be:et*Be,St=rs(je,Xe,ht,d);if(St[3]<=0){ws(se,H);continue}let _t={};const dt=o.an(l.layers[0].layout.get("text-max-angle")),kt=Math.cos(dt),Dt=_?null:ke,Tt=sf(ce,vt,!1,v,t,d,p,l.glyphOffsetArray,Y,H,q,St,Ce,_t,J,Dt,O.projection,I,_,kt);he=Tt.useVertical,Dt&&Tt.needsFlipping&&(_t={}),(Tt.notEnoughRoom||he||Tt.needsFlipping&&sf(ce,vt,!0,v,t,d,p,l.glyphOffsetArray,Y,H,q,St,Ce,_t,J,Dt,O.projection,I,_,kt).notEnoughRoom)&&ws(se,H)}c?(l.text.dynamicLayoutVertexBuffer.updateData(H),q&&l.text.globeExtVertexBuffer&&l.text.globeExtVertexBuffer.updateData(q)):(l.icon.dynamicLayoutVertexBuffer.updateData(H),q&&l.icon.globeExtVertexBuffer&&l.icon.globeExtVertexBuffer.updateData(q))}function Am(l,t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H){const{lineStartIndex:q,glyphStartIndex:Y,segment:te}=v,J=Y+v.numGlyphs,_e=q+v.lineLength,he=t.getoffsetX(Y),pe=t.getoffsetX(J-1),ce=nc(l*he,n,c,d,p,_,te,q,_e,w,I,C,O,D,!0,z,N,B,H);if(!ce)return null;const se=nc(l*pe,n,c,d,p,_,te,q,_e,w,I,C,O,D,!0,z,N,B,H);return se?{first:ce,last:se}:null}function ei(l,t,n,c){return l===o.bL.horizontal&&Math.abs(c)>Math.abs(n)?{useVertical:!0}:l===o.bL.vertical?c>0?{needsFlipping:!0}:null:t!==Za.unknown&&(function(d,p){return d===0||Math.abs(p/d)>Ll})(n,c)?t===Za.flipRequired?{needsFlipping:!0}:null:n<0?{needsFlipping:!0}:null}function sf(l,t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H,q,Y,te){const J=t/24,_e=l.lineOffsetX*J,he=l.lineOffsetY*J,{lineStartIndex:pe,glyphStartIndex:ce,numGlyphs:se,segment:ye,writingMode:Ce,flipState:Se}=l,Ue=pe+l.lineLength,je=Xe=>{if(C){const[He,Be,et]=Xe.up,vt=I.length;o.bN(C,vt+0,He,Be,et),o.bN(C,vt+1,He,Be,et),o.bN(C,vt+2,He,Be,et),o.bN(C,vt+3,He,Be,et)}const[ht,ke,we]=Xe.point;o.bO(I,ht,ke,we,Xe.angle)};if(se>1){const Xe=Am(J,v,_e,he,n,O,D,l,w,p,z,B,!1,H,q,Y,te);if(!Xe)return{notEnoughRoom:!0};if(c&&!n){let[ht,ke,we]=Xe.first.point,[He,Be,et]=Xe.last.point;[ht,ke]=rs(ht,ke,we,_),[He,Be]=rs(He,Be,et,_);const vt=ei(Ce,Se,(He-ht)*N,Be-ke);if(l.flipState=vt&&vt.needsFlipping?Za.flipRequired:Za.flipNotRequired,vt)return vt}je(Xe.first);for(let ht=ce+1;ht<ce+se-1;ht++){const ke=nc(J*v.getoffsetX(ht),_e,he,n,O,D,ye,pe,Ue,w,p,z,B,!1,!1,H,q,Y,te);if(!ke)return I.length-=4*(ht-ce),{notEnoughRoom:!0};je(ke)}je(Xe.last)}else{if(c&&!n){const ht=rs(D.x,D.y,0,d),ke=pe+ye+1,we=new o.P(w.getx(ke),w.gety(ke)),He=rs(we.x,we.y,0,d),Be=He[3]>0?He:ns(D,we,ht,1,d,void 0,H,q.canonical),et=ei(Ce,Se,(Be[0]-ht[0])*N,Be[1]-ht[1]);if(l.flipState=et&&et.needsFlipping?Za.flipRequired:Za.flipNotRequired,et)return et}const Xe=nc(J*v.getoffsetX(ce),_e,he,n,O,D,ye,pe,Ue,w,p,z,B,!1,!1,H,q,Y,te);if(!Xe)return{notEnoughRoom:!0};je(Xe)}return{}}function ou(l,t,n,c,d){const{x:p,y:_,z:v}=c.projectTilePoint(l.x,l.y,t);if(!d)return rs(p,_,v,n);const[w,I,C]=d.getElevation(l,d.elevation,d.elevationFeature);return rs(p+w,_+I,v+C,n)}function ns(l,t,n,c,d,p,_,v){const w=ou(l.sub(t)._unit()._add(l),v,d,_,p);return o.av(w,n,w),o.aw(w,w),o.bH(w,n,w,c)}function nc(l,t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H,q,Y){const te=c?l-t:l+t;let J=te>0?1:-1,_e=0;c&&(J*=-1,_e=Math.PI),J<0&&(_e+=Math.PI);let he=v+_+(J>0?0:1)|0,pe=d,ce=d,se=0,ye=0;const Ce=Math.abs(te),Se=[],Ue=[];let je=p,Xe=je,ht=o.bF([]);const ke=()=>ns(Xe,je,ce,Ce-se+1,C,D,B,H.canonical);for(;se+ye<=Ce;){if(he+=J,he<v||he>=w)return null;if(ce=pe,Xe=je,Se.push(ce),z&&Ue.push(Xe),je=new o.P(I.getx(he),I.gety(he)),pe=O[he],!pe){const Dt=ou(je,H.canonical,C,B,D);pe=Dt[3]>0?O[he]=Dt:ke()}se+=ye;const dt=o.av([],pe,ce),kt=o.bG(ce,pe);if(n&&kt>0&&ye>0&&o.bJ(ht,dt)/(ye*kt)<Y)return null;ye=kt,ht=dt}N&&D&&(O[he]&&(pe=ke(),ye=o.bG(ce,pe),ht=o.av([],pe,ce)),O[he]=pe);const we=(Ce-se)/ye,He=je.sub(Xe)._mult(we)._add(Xe),Be=o.bH([],ce,ht,we);let et=[0,0,1],vt=ht[0],St=ht[1];if(q&&(et=B.upVector(H.canonical,He.x,He.y),et[0]!==0||et[1]!==0||et[2]!==1)){const dt=[et[2],0,-et[0]],kt=o.bI([],et,dt);o.aw(dt,dt),o.aw(kt,kt),vt=o.bJ(ht,dt),St=o.bJ(ht,kt)}if(n){const dt=o.bI([],et,ht);o.aw(dt,dt),o.bH(Be,Be,dt,n*J)}const _t=_e+Math.atan2(St,vt);return Se.push(Be),z&&Ue.push(He),{point:Be,angle:_t,path:Se,tilePath:Ue,up:et}}function ws(l,t){const n=t.length,c=n+4*l;t.resize(c),t.float32.fill(-1/0,4*n,4*c)}function Gt(l,t,n){const c=t[0],d=t[1];return l[0]=n[0]*c+n[4]*d+n[12],l[1]=n[1]*c+n[5]*d+n[13],l[3]=n[3]*c+n[7]*d+n[15],l}const Vi=100;class dr{constructor(t,n,c=new of(t.width+200,t.height+200,25),d=new of(t.width+200,t.height+200,25)){this.transform=t,this.grid=c,this.ignoredGrid=d,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Vi,this.screenBottomBoundary=t.height+Vi,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=n}placeCollisionBox(t,n,c,d,p,_,v,w,I,C,O){let D=c.projectedAnchorX,z=c.projectedAnchorY,N=c.projectedAnchorZ;const B=c.tileAnchorX,H=c.tileAnchorY,q=c.elevation,Y=c.tileID,te=t.getProjection();if(q&&Y){const[Ue,je,Xe]=te.upVector(Y.canonical,c.tileAnchorX,c.tileAnchorY),ht=te.upVectorScale(Y.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;D+=Ue*q*ht,z+=je*q*ht,N+=Xe*q*ht}const J=t.projection.name==="globe",_e=t.projection.name==="globe"?o.aj(this.transform.zoom):0;if(Y&&J&&_e<1&&!_){const Ue=1<<Y.canonical.z,je=o.bP(B,H);o.bQ(je,je,1/o.al),o.bR(je,je,o.bP(Y.canonical.x,Y.canonical.y)),o.bQ(je,je,1/Ue),o.bS(je,je,o.bP(d[0],d[1])),je[0]=o.bT(je[0],-.5,.5),o.bQ(je,je,o.al);const Xe=o.bU(je[0],je[1],o.al/(2*Math.PI),1);o.aC(Xe,Xe,p),D=o.ak(D,Xe[0],_e),z=o.ak(z,Xe[1],_e),N=o.ak(N,Xe[2],_e)}const he=this.projectAndGetPerspectiveRatio(C,D,z,N,c.tileID,te.name==="globe"||!!q||this.transform.pitch>0,te),pe=I*he.perspectiveRatio,ce=(c.x1*n+v.x-c.padding)*pe+he.point.x,se=(c.y1*n+v.y-c.padding)*pe+he.point.y,ye=(c.x2*n+v.x+c.padding)*pe+he.point.x,Ce=(c.y2*n+v.y+c.padding)*pe+he.point.y,Se=he.perspectiveRatio<=.55||he.occluded;return!this.isInsideGrid(ce,se,ye,Ce)||!w&&this.grid.hitTest(ce,se,ye,Ce,O)||Se?{box:[],offscreen:!1,occluded:he.occluded}:{box:[ce,se,ye,Ce],offscreen:this.isOffscreen(ce,se,ye,Ce),occluded:!1}}placeCollisionCircles(t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H){const q=[],Y=this.transform.elevation,te=t.getProjection(),J=t.elevationType==="road",_e=!!Y||J,he=o.bV.getAtTileOffsetFunc(H,this.transform.center.lat,this.transform.worldSize,te),pe=new o.P(c.tileAnchorX,c.tileAnchorY),ce=new o.P(c.tileAnchorX,c.tileAnchorY);let{x:se,y:ye,z:Ce}=te.projectTilePoint(ce.x,ce.y,H.canonical),Se=null;if(_e){const kt=J?t.getElevationFeatureForText(d):null;Se={getElevation:he,elevation:Y,elevationFeature:kt};const[Dt,Tt,At]=he(pe,Y,kt);se+=Dt,ye+=Tt,Ce+=At}const Ue=te.name==="globe",je=this.projectAndGetPerspectiveRatio(w,se,ye,Ce,H,Ue||!!Y||this.transform.pitch>0,te),{perspectiveRatio:Xe}=je,ht=(D?v/Xe:v*Xe)/o.bY,ke=rs(se,ye,Ce,I),we=c.lineOffsetX*ht,He=c.lineOffsetY*ht,Be=o.an(t.layers[0].layout.get("text-max-angle")),et=Math.cos(Be),vt=je.signedDistanceFromCamera>0?Am(ht,_,we,He,J&&c.flipState===1,ke,ce,c,p,I,{},_e&&!D?Se:null,D&&_e,te,H,D,et):null;let St=!1,_t=!1,dt=!0;if(vt&&!je.occluded){const kt=.5*N*Xe+B,Dt=new o.P(-100,-100),Tt=new o.P(this.screenRightBoundary,this.screenBottomBoundary),At=new ru,{first:Wt,last:ci}=vt,Di=Wt.path.length;let er=[];for(let ai=Di-1;ai>=1;ai--)er.push(Wt.path[ai]);for(let ai=1;ai<ci.path.length;ai++)er.push(ci.path[ai]);const Ft=2.5*kt;C&&(er=er.map((([ai,nr,fr],cr)=>(_e&&!Ue&&(fr=he(cr<Di-1?Wt.tilePath[Di-1-cr]:ci.tilePath[cr-Di+2],Y,Se.elevationFeature)[2]),rs(ai,nr,fr,C)))),er.some((ai=>ai[3]<=0))&&(er=[]));let Ji=[];if(er.length>0){let ai=1/0,nr=-1/0,fr=1/0,cr=-1/0;for(const Xi of er)ai=Math.min(ai,Xi[0]),fr=Math.min(fr,Xi[1]),nr=Math.max(nr,Xi[0]),cr=Math.max(cr,Xi[1]);nr>=Dt.x&&ai<=Tt.x&&cr>=Dt.y&&fr<=Tt.y&&(Ji=[er.map((Xi=>new o.P(Xi[0],Xi[1])))],(ai<Dt.x||nr>Tt.x||fr<Dt.y||cr>Tt.y)&&(Ji=o.bW(Ji,Dt.x,Dt.y,Tt.x,Tt.y)))}for(const ai of Ji){At.reset(ai,.25*kt);let nr=0;nr=At.length<=.5*kt?1:Math.ceil(At.paddedLength/Ft)+1;for(let fr=0;fr<nr;fr++){const cr=fr/Math.max(nr-1,1),Xi=At.lerp(cr),vi=Xi.x+Vi,ir=Xi.y+Vi;q.push(vi,ir,kt,0);const $r=vi-kt,Rr=ir-kt,or=vi+kt,Gi=ir+kt;if(dt=dt&&this.isOffscreen($r,Rr,or,Gi),_t=_t||this.isInsideGrid($r,Rr,or,Gi),!n&&this.grid.hitTestCircle(vi,ir,kt,z)&&(St=!0,!O))return{circles:[],offscreen:!1,collisionDetected:St,occluded:!1}}}}return{circles:!O&&St||!_t?[]:q,offscreen:dt,collisionDetected:St,occluded:je.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const n=[];let c=1/0,d=1/0,p=-1/0,_=-1/0;for(const C of t){const O=new o.P(C.x+Vi,C.y+Vi);c=Math.min(c,O.x),d=Math.min(d,O.y),p=Math.max(p,O.x),_=Math.max(_,O.y),n.push(O)}const v=this.grid.query(c,d,p,_).concat(this.ignoredGrid.query(c,d,p,_)),w={},I={};for(const C of v){const O=C.key;if(w[O.bucketInstanceId]===void 0&&(w[O.bucketInstanceId]={}),w[O.bucketInstanceId][O.featureIndex])continue;const D=[new o.P(C.x1,C.y1),new o.P(C.x2,C.y1),new o.P(C.x2,C.y2),new o.P(C.x1,C.y2)];o.bX(n,D)&&(w[O.bucketInstanceId][O.featureIndex]=!0,I[O.bucketInstanceId]===void 0&&(I[O.bucketInstanceId]=[]),I[O.bucketInstanceId].push(O.featureIndex))}return I}insertCollisionBox(t,n,c,d,p){(n?this.ignoredGrid:this.grid).insert({bucketInstanceId:c,featureIndex:d,collisionGroupID:p},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,c,d,p){const _=n?this.ignoredGrid:this.grid,v={bucketInstanceId:c,featureIndex:d,collisionGroupID:p};for(let w=0;w<t.length;w+=4)_.insertCircle(v,t[w],t[w+1],t[w+2])}projectAndGetPerspectiveRatio(t,n,c,d,p,_,v){const w=[n,c,d,1];let I=!1;d||this.transform.pitch>0?(o.aC(w,w,t),this.fogState&&p&&v.name!=="globe"&&(I=(function(D,z,N,B,H,q){const Y=q.calculateFogTileMatrix(H),te=[z,N,B];return o.af(te,te,Y),Mt(D,o.ag(te),q.pitch,q._fov)})(this.fogState,n,c,d,p.toUnwrapped(),this.transform)>.9)):Gt(w,w,t);const C=w[3];return{point:new o.P((w[0]/C+1)/2*this.transform.width+Vi,(-w[1]/C+1)/2*this.transform.height+Vi),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(v)/C*.5,1.5),signedDistanceFromCamera:C,occluded:_&&w[2]>C||I}}isOffscreen(t,n,c,d){return c<Vi||t>=this.screenRightBoundary||d<Vi||n>this.screenBottomBoundary}isInsideGrid(t,n,c,d){return c>=0&&t<this.gridRightBoundary&&d>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=o.bA([]);return o.br(t,t,[-100,-100,0]),t}}class wo{constructor(t,n,c,d){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):d&&c?1:0,this.placed=c}isHidden(){return this.opacity===0&&!this.placed}}class Hs{constructor(t,n,c,d,p,_=!1){this.text=new wo(t?t.text:null,n,c,p),this.icon=new wo(t?t.icon:null,n,d,p),this.clipped=_}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class ar{constructor(t,n,c,d=!1){this.text=t,this.icon=n,this.skipFade=c,this.clipped=d}}class hh{constructor(){this.invProjMatrix=o.bC(),this.viewportMatrix=o.bC(),this.circles=[]}}class su{constructor(t,n,c,d,p){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=c,this.bucketIndex=d,this.tileID=p}}class au{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:c=>c.collisionGroupID===n}}return this.collisionGroups[t]}}function Qn(l,t,n,c,d){const{horizontalAlign:p,verticalAlign:_}=o.c1(l),v=-(p-.5)*t,w=-(_-.5)*n,I=o.c2(l,c);return new o.P(v+I[0]*d,w+I[1]*d)}function pn(l,t,n,c,d){const p=new o.P(l,t);return n&&p._rotate(c?d:-d),p}class sy{constructor(t,n,c,d,p,_){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new dr(this.transform,p),this.buildingIndex=_,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=n,this.retainedQueryData={},this.collisionGroups=new au(c),this.collisionCircleArrays={},this.prevPlacement=d,d&&(d.prevPlacement=void 0),this.placedOrientations={},this.lastReplacementSourceUpdateTime=0}getBucketParts(t,n,c,d,p=1){const _=c.getBucket(n),v=c.latestFeatureIndex;if(!_||!v||n.fqid!==_.layerIds[0])return;const w=_.layers[0].layout,I=_.layers[0].paint,C=c.collisionBoxArray,O=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),D=c.tileSize/o.al,z=c.tileID.toUnwrapped();this.transform.setProjection(_.projection);const N=(B=c.tileID,H=_.getProjection(),q=this.transform,H.name===this.projection?q.calculateProjMatrix(B.toUnwrapped()):nf(q,H,B));var B,H,q;const Y=w.get("text-pitch-alignment")==="map",te=w.get("text-rotation-alignment")==="map";n.compileFilter(n.options);const J=n.dynamicFilter(),_e=n.dynamicFilterNeedsFeature(),he=this.transform.calculatePixelsToTileUnitsMatrix(c),pe=uh(N,c.tileID.canonical,Y,te,this.transform,_.getProjection(),he);let ce=null;const se=_.getProjection().createInversionMatrix(this.transform,c.tileID.canonical);if(Y){const we=nu(N,c.tileID.canonical,Y,te,this.transform,_.getProjection(),he);ce=o.aB([],this.transform.labelPlaneMatrix,we)}let ye=null;J&&c.latestFeatureIndex&&(ye={unwrappedTileID:z,dynamicFilter:J,dynamicFilterNeedsFeature:_e}),this.retainedQueryData[_.bucketInstanceId]=new su(_.bucketInstanceId,v,_.sourceLayerIndex,_.index,c.tileID);const[Ce,Se]=_.layers[0].layout.get("text-size-scale-range"),Ue=o.aA(p,Ce,Se),[je,Xe]=w.get("icon-size-scale-range"),ht=o.aA(p,je,Xe),ke={bucket:_,layout:w,paint:I,posMatrix:N,invMatrix:se,mercatorCenter:[o.aF(this.transform.center.lng),o.aJ(this.transform.center.lat)],textLabelPlaneMatrix:pe,labelToScreenMatrix:ce,clippingData:ye,scale:O,textPixelRatio:D,holdingForFade:c.holdingForFade(),collisionBoxArray:C,partiallyEvaluatedTextSize:o.bK(_.textSizeData,this.transform.zoom,Ue),partiallyEvaluatedIconSize:o.bK(_.iconSizeData,this.transform.zoom,ht),collisionGroup:this.collisionGroups.get(_.sourceID),latestFeatureIndex:c.latestFeatureIndex};if(d)for(const we of _.sortKeyRanges){const{sortKey:He,symbolInstanceStart:Be,symbolInstanceEnd:et}=we;t.push({sortKey:He,symbolInstanceStart:Be,symbolInstanceEnd:et,parameters:ke})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:_.symbolInstances.length,parameters:ke})}attemptAnchorPlacement(t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H,q,Y,te,J,_e){const{textOffset0:he,textOffset1:pe,crossTileID:ce}=B,se=[he,pe],ye=Qn(t,_,v,se,w),Ce=this.collisionIndex.placeCollisionBox(q,w,n,c,d,p,pn(ye.x,ye.y,I,C,this.transform.angle),N,O,D,z.predicate);if(te){const Se=q.getSymbolInstanceIconSize(_e,this.transform.zoom,B.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(q,Se,te,c,d,p,pn(ye.x,ye.y,I,C,this.transform.angle),N,O,D,z.predicate).box.length===0)return}if(Ce.box.length>0){let Se;return this.prevPlacement&&this.prevPlacement.variableOffsets[ce]&&this.prevPlacement.placements[ce]&&this.prevPlacement.placements[ce].text&&(Se=this.prevPlacement.variableOffsets[ce].anchor),this.variableOffsets[ce]={textOffset:se,width:_,height:v,anchor:t,textScale:w,prevAnchor:Se},this.markUsedJustification(q,t,B,Y),q.allowVerticalPlacement&&(this.markUsedOrientation(q,Y,B),this.placedOrientations[ce]=Y),{shift:ye,placedGlyphBoxes:Ce}}}placeLayerBucketPart(t,n,c,d,p=1){const{bucket:_,layout:v,paint:w,posMatrix:I,textLabelPlaneMatrix:C,labelToScreenMatrix:O,clippingData:D,textPixelRatio:z,mercatorCenter:N,invMatrix:B,holdingForFade:H,collisionBoxArray:q,partiallyEvaluatedTextSize:Y,partiallyEvaluatedIconSize:te,collisionGroup:J,latestFeatureIndex:_e}=t.parameters,he=v.get("text-optional"),pe=v.get("icon-optional"),ce=v.get("text-allow-overlap"),se=v.get("icon-allow-overlap"),ye=v.get("text-rotation-alignment")==="map",Ce=v.get("icon-rotation-alignment")==="map",Se=v.get("text-pitch-alignment")==="map",Ue=w.get("symbol-z-offset"),je=v.get("symbol-elevation-reference")==="sea",Xe=v.get("symbol-placement"),[ht,ke]=v.get("text-size-scale-range"),[we,He]=v.get("icon-size-scale-range"),Be=o.aA(p,ht,ke),et=o.aA(p,we,He),vt=v.get("text-variable-anchor"),St=ye&&Xe!=="point",_t=Ce&&Xe!=="point",dt=vt&&_.hasTextData(),kt=_.hasIconTextFit()&&dt&&_.hasIconData();this.transform.setProjection(_.projection);const Dt=dt||St,Tt=_t||kt;let At=ce&&(se||!_.hasIconData()||pe),Wt=se&&(ce||!_.hasTextData()||he);const ci=!Ue.isConstant();!_.collisionArrays&&q&&_.deserializeCollisionBoxes(q),c&&d&&_.updateCollisionDebugBuffers(this.transform.zoom,q,Be,et);const Di=(Ft,Ji,ai)=>{const{crossTileID:nr,numVerticalGlyphVertices:fr}=Ft;let cr=null;if(D&&D.dynamicFilterNeedsFeature||ci){const tn=this.retainedQueryData[_.bucketInstanceId];cr=_e.loadFeature({featureIndex:Ft.featureIndex,bucketIndex:tn.bucketIndex,sourceLayerIndex:tn.sourceLayerIndex,layoutVertexArrayOffset:0});const ln=cr.properties?cr.properties.worldview:null;if(_.localizable&&_.worldview&&typeof ln=="string")if(ln==="all")cr.properties.$localized=!0;else{if(!ln.split(",").includes(_.worldview))return;cr.properties.$localized=!0,cr.properties.worldview=_.worldview}}if(D&&!(0,D.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch,worldview:_.worldview},cr,this.retainedQueryData[_.bucketInstanceId].tileID.canonical,new o.P(Ft.tileAnchorX,Ft.tileAnchorY),this.transform.calculateDistanceTileData(D.unwrappedTileID)))return this.placements[nr]=new ar(!1,!1,!1,!0),void n.add(nr);const Xi=Ue.evaluate(cr,{});if(n.has(nr))return;if(H)return void(this.placements[nr]=new ar(!1,!1,!1));let vi=!1,ir=!1,$r=!0,Rr=!1,or=!1,Gi=null,xi={box:null,offscreen:null,occluded:null},Mr={box:null},sn=null,Br=null,vr=null,mo=0,Xn=0,wn=0;ai.textFeatureIndex?mo=ai.textFeatureIndex:Ft.useRuntimeCollisionCircles&&(mo=Ft.featureIndex),ai.verticalTextFeatureIndex&&(Xn=ai.verticalTextFeatureIndex);const to=_.elevationFeatures?_.elevationFeatures[Ft.elevationFeatureIndex]:void 0,io=tn=>{tn.tileID=this.retainedQueryData[_.bucketInstanceId].tileID;const ln=this.transform.elevation;tn.elevation=je?Xi:Xi+o.bV.getAtTileOffset(tn.tileID,new o.P(tn.tileAnchorX,tn.tileAnchorY),ln,to),tn.elevation+=Ft.zOffset},$n=ai.textBox;if($n){io($n);const tn=xr=>{let dn=o.bL.horizontal;if(_.allowVerticalPlacement&&!xr&&this.prevPlacement){const Wr=this.prevPlacement.placedOrientations[nr];Wr&&(this.placedOrientations[nr]=Wr,dn=Wr,this.markUsedOrientation(_,dn,Ft))}return dn},ln=(xr,dn)=>{if(_.allowVerticalPlacement&&fr>0&&ai.verticalTextBox){for(const Wr of _.writingModes)if(Wr===o.bL.vertical?(xi=dn(),Mr=xi):xi=xr(),xi&&xi.box&&xi.box.length)break}else xi=xr()};if(vt){let xr=vt;if(this.prevPlacement&&this.prevPlacement.variableOffsets[nr]){const Nr=this.prevPlacement.variableOffsets[nr];xr.indexOf(Nr.anchor)>0&&(xr=xr.filter((ds=>ds!==Nr.anchor)),xr.unshift(Nr.anchor))}const dn=(Nr,ds,zu)=>{const Cs=_.getSymbolInstanceTextSize(Y,Ft,this.transform.zoom,Ji),ku=(Nr.x2-Nr.x1)*Cs+2*Nr.padding,Cc=(Nr.y2-Nr.y1)*Cs+2*Nr.padding,ea=Ft.hasIconTextFit&&!se?ds:null;ea&&io(ea);let Ia={box:[],offscreen:!1,occluded:!1};const Mc=ce?2*xr.length:xr.length;for(let ll=0;ll<Mc;++ll){const Aa=this.attemptAnchorPlacement(xr[ll%xr.length],Nr,N,B,Dt,ku,Cc,Cs,ye,Se,z,I,J,ll>=xr.length,Ft,Ji,_,zu,ea,Y,te);if(Aa&&(Ia=Aa.placedGlyphBoxes,Ia&&Ia.box&&Ia.box.length)){vi=!0,Gi=Aa.shift;break}}return Ia};ln((()=>dn($n,ai.iconBox,o.bL.horizontal)),(()=>{const Nr=ai.verticalTextBox;return Nr&&io(Nr),_.allowVerticalPlacement&&!(xi&&xi.box&&xi.box.length)&&fr>0&&Nr?dn(Nr,ai.verticalIconBox,o.bL.vertical):{box:null,offscreen:null,occluded:null}})),xi&&(vi=xi.box,$r=xi.offscreen,Rr=xi.occluded);const Wr=tn(!(!xi||!xi.box));if(!vi&&this.prevPlacement){const Nr=this.prevPlacement.variableOffsets[nr];Nr&&(this.variableOffsets[nr]=Nr,this.markUsedJustification(_,Nr.anchor,Ft,Wr))}}else{const xr=(dn,Wr)=>{const Nr=_.getSymbolInstanceTextSize(Y,Ft,this.transform.zoom,Ji),ds=this.collisionIndex.placeCollisionBox(_,Nr,dn,N,B,Dt,new o.P(0,0),ce,z,I,J.predicate);return ds&&ds.box&&ds.box.length&&(this.markUsedOrientation(_,Wr,Ft),this.placedOrientations[nr]=Wr),ds};ln((()=>xr($n,o.bL.horizontal)),(()=>{const dn=ai.verticalTextBox;return _.allowVerticalPlacement&&fr>0&&dn?(io(dn),xr(dn,o.bL.vertical)):{box:null,offscreen:null,occluded:null}})),tn(!!(xi&&xi.box&&xi.box.length))}}if(sn=xi,vi=sn&&sn.box&&sn.box.length>0,$r=sn&&sn.offscreen,Rr=sn&&sn.occluded,Ft.useRuntimeCollisionCircles){const tn=Ft.centerJustifiedTextSymbolIndex>=0?Ft.centerJustifiedTextSymbolIndex:Ft.verticalPlacedTextSymbolIndex,ln=_.text.placedSymbolArray.get(tn),xr=o.bM(_.textSizeData,Y,ln),dn=v.get("text-padding");Br=this.collisionIndex.placeCollisionCircles(_,ce,ln,tn,_.lineVertexArray,_.glyphOffsetArray,xr,I,C,O,c,Se,J.predicate,Ft.collisionCircleDiameter*xr/o.bY,dn,this.retainedQueryData[_.bucketInstanceId].tileID),vi=ce||Br.circles.length>0&&!Br.collisionDetected,$r=$r&&Br.offscreen,Rr=Br.occluded}if(ai.iconFeatureIndex&&(wn=ai.iconFeatureIndex),ai.iconBox){const tn=ln=>{io(ln);const xr=Ft.hasIconTextFit&&Gi?pn(Gi.x,Gi.y,ye,Se,this.transform.angle):new o.P(0,0),dn=_.getSymbolInstanceIconSize(te,this.transform.zoom,Ft.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(_,dn,ln,N,B,Tt,xr,se,z,I,J.predicate)};Mr&&Mr.box&&Mr.box.length&&ai.verticalIconBox?(vr=tn(ai.verticalIconBox),ir=vr.box.length>0):(vr=tn(ai.iconBox),ir=vr.box.length>0),$r=$r&&vr.offscreen,or=vr.occluded}const Zo=he||Ft.numHorizontalGlyphVertices===0&&fr===0,hs=pe||Ft.numIconVertices===0;if(Zo||hs?hs?Zo||(ir=ir&&vi):vi=ir&&vi:ir=vi=ir&&vi,vi&&sn&&sn.box&&this.collisionIndex.insertCollisionBox(sn.box,v.get("text-ignore-placement"),_.bucketInstanceId,Mr&&Mr.box&&Xn?Xn:mo,J.ID),ir&&vr&&this.collisionIndex.insertCollisionBox(vr.box,v.get("icon-ignore-placement"),_.bucketInstanceId,wn,J.ID),Br&&(vi&&this.collisionIndex.insertCollisionCircles(Br.circles,v.get("text-ignore-placement"),_.bucketInstanceId,mo,J.ID),c)){const tn=_.bucketInstanceId;let ln=this.collisionCircleArrays[tn];ln===void 0&&(ln=this.collisionCircleArrays[tn]=new hh);for(let xr=0;xr<Br.circles.length;xr+=4)ln.circles.push(Br.circles[xr+0]),ln.circles.push(Br.circles[xr+1]),ln.circles.push(Br.circles[xr+2]),ln.circles.push(Br.collisionDetected?1:0)}const So=_.projection.name!=="globe";At=At&&(So||!Rr),Wt=Wt&&(So||!or),this.placements[nr]=new ar(vi||At,ir||Wt,$r||_.justReloaded),n.add(nr)},er=this.retainedQueryData[_.bucketInstanceId].tileID;if(_.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(_,er),_.elevationType==="road"&&_.updateRoadElevation(er.canonical),_.updateZOffset(),_.sortFeaturesByY){const Ft=_.getSortedSymbolIndexes(this.transform.angle);for(let Ji=Ft.length-1;Ji>=0;--Ji){const ai=Ft[Ji];Di(_.symbolInstances.get(ai),ai,_.collisionArrays[ai])}_.hasAnyZOffset&&o.w(`${_.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(_.hasAnyZOffset){const Ft=_.getSortedIndexesByZOffset();for(let Ji=0;Ji<Ft.length;++Ji){const ai=Ft[Ji];Di(_.symbolInstances.get(ai),ai,_.collisionArrays[ai])}}else for(let Ft=t.symbolInstanceStart;Ft<t.symbolInstanceEnd;Ft++)Di(_.symbolInstances.get(Ft),Ft,_.collisionArrays[Ft]);if(c&&_.bucketInstanceId in this.collisionCircleArrays){const Ft=this.collisionCircleArrays[_.bucketInstanceId];o.bl(Ft.invProjMatrix,I),Ft.viewportMatrix=this.collisionIndex.getViewportMatrix()}_.justReloaded=!1}markUsedJustification(t,n,c,d){const{leftJustifiedTextSymbolIndex:p,centerJustifiedTextSymbolIndex:_,rightJustifiedTextSymbolIndex:v,verticalPlacedTextSymbolIndex:w,crossTileID:I}=c,C=o.c3(n),O=d===o.bL.vertical?w:C==="left"?p:C==="center"?_:C==="right"?v:-1;p>=0&&(t.text.placedSymbolArray.get(p).crossTileID=O>=0&&p!==O?0:I),_>=0&&(t.text.placedSymbolArray.get(_).crossTileID=O>=0&&_!==O?0:I),v>=0&&(t.text.placedSymbolArray.get(v).crossTileID=O>=0&&v!==O?0:I),w>=0&&(t.text.placedSymbolArray.get(w).crossTileID=O>=0&&w!==O?0:I)}markUsedOrientation(t,n,c){const d=n===o.bL.horizontal||n===o.bL.horizontalOnly?n:0,p=n===o.bL.vertical?n:0,{leftJustifiedTextSymbolIndex:_,centerJustifiedTextSymbolIndex:v,rightJustifiedTextSymbolIndex:w,verticalPlacedTextSymbolIndex:I}=c,C=t.text.placedSymbolArray;_>=0&&(C.get(_).placedOrientation=d),v>=0&&(C.get(v).placedOrientation=d),w>=0&&(C.get(w).placedOrientation=d),I>=0&&(C.get(I).placedOrientation=p)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let c=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const d=n?n.symbolFadeChange(t):1,p=n?n.opacities:{},_=n?n.variableOffsets:{},v=n?n.placedOrientations:{};for(const w in this.placements){const I=this.placements[w],C=p[w];C?(this.opacities[w]=new Hs(C,d,I.text,I.icon,null,I.clipped),c=c||I.text!==C.text.placed||I.icon!==C.icon.placed):(this.opacities[w]=new Hs(null,d,I.text,I.icon,I.skipFade,I.clipped),c=c||I.text||I.icon)}for(const w in p){const I=p[w];if(!this.opacities[w]){const C=new Hs(I,d,!1,!1);C.isHidden()||(this.opacities[w]=C,c=c||I.text.placed||I.icon.placed)}}for(const w in _)this.variableOffsets[w]||!this.opacities[w]||this.opacities[w].isHidden()||(this.variableOffsets[w]=_[w]);for(const w in v)this.placedOrientations[w]||!this.opacities[w]||this.opacities[w].isHidden()||(this.placedOrientations[w]=v[w]);c?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n,c,d){d&&(this.lastReplacementSourceUpdateTime=d.updateTime);const p=new Set;for(const _ of n){const v=_.getBucket(t);v&&_.latestFeatureIndex&&t.fqid===v.layerIds[0]&&(this.updateBucketOpacities(v,p,_,_.collisionBoxArray,c,d,_.tileID,t.scope),v.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(v,_.tileID),v.elevationType==="road"&&v.updateRoadElevation(_.tileID.canonical),v.updateZOffset())}}updateBucketOpacities(t,n,c,d,p,_,v,w){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const I=t.layers[0].layout,C=t.layers[0].paint,O=!!t.layers[0].dynamicFilter(),D=new Hs(null,0,!1,!1,!0),z=I.get("text-allow-overlap"),N=I.get("icon-allow-overlap"),B=I.get("text-variable-anchor"),H=I.get("text-rotation-alignment")==="map",q=I.get("text-pitch-alignment")==="map",Y=C.get("symbol-z-offset"),te=I.get("symbol-elevation-reference")==="sea",J=!Y.isConstant(),_e=new Hs(null,0,z&&(N||!t.hasIconData()||I.get("icon-optional")),N&&(z||!t.hasTextData()||I.get("text-optional")),!0);!t.collisionArrays&&d&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(d);const he=(ce,se,ye)=>{for(let Ce=0;Ce<se/4;Ce++)ce.opacityVertexArray.emplaceBack(ye)};let pe=0;_&&t.updateReplacement(v,_);for(let ce=0;ce<t.symbolInstances.length;ce++){const se=t.symbolInstances.get(ce),{numHorizontalGlyphVertices:ye,numVerticalGlyphVertices:Ce,crossTileID:Se,numIconVertices:Ue,tileAnchorX:je,tileAnchorY:Xe}=se;let ht=null;const ke=this.retainedQueryData[t.bucketInstanceId];J&&se&&ke&&(ht=c.latestFeatureIndex.loadFeature({featureIndex:se.featureIndex,bucketIndex:ke.bucketIndex,sourceLayerIndex:ke.sourceLayerIndex,layoutVertexArrayOffset:0}));const we=Y.evaluate(ht,{}),He=n.has(Se);let Be=this.opacities[Se];He?Be=D:Be||(Be=_e,this.opacities[Se]=Be),n.add(Se);const et=ye>0||Ce>0,vt=Ue>0,St=this.placedOrientations[Se],_t=St===o.bL.vertical,dt=St===o.bL.horizontal||St===o.bL.horizontalOnly;!et&&!vt||Be.isHidden()||pe++;let kt=!1;if((et||vt)&&_)for(const Dt of t.activeReplacements){if(o.bZ(Dt,p,o.b_.Symbol,w)||Dt.min.x>je||je>Dt.max.x||Dt.min.y>Xe||Xe>Dt.max.y)continue;const Tt=o.b$(je,Xe,v.canonical,Dt.footprintTileId.canonical);if(kt=o.c0(Tt,Dt.footprint),kt)break}if(et){const Dt=kt?Rl:uo(Be.text);he(t.text,ye,_t?Rl:Dt),he(t.text,Ce,dt?Rl:Dt);const Tt=Be.text.isHidden(),{leftJustifiedTextSymbolIndex:At,centerJustifiedTextSymbolIndex:Wt,rightJustifiedTextSymbolIndex:ci,verticalPlacedTextSymbolIndex:Di}=se,er=t.text.placedSymbolArray,Ft=Tt||_t?1:0;At>=0&&(er.get(At).hidden=Ft),Wt>=0&&(er.get(Wt).hidden=Ft),ci>=0&&(er.get(ci).hidden=Ft),Di>=0&&(er.get(Di).hidden=Tt||dt?1:0);const Ji=this.variableOffsets[Se];Ji&&this.markUsedJustification(t,Ji.anchor,se,St);const ai=this.placedOrientations[Se];ai&&(this.markUsedJustification(t,"left",se,ai),this.markUsedOrientation(t,ai,se))}if(vt){const Dt=kt?Rl:uo(Be.icon),{placedIconSymbolIndex:Tt,verticalPlacedIconSymbolIndex:At}=se,Wt=t.icon.placedSymbolArray,ci=Be.icon.isHidden()?1:0;Tt>=0&&(he(t.icon,Ue,_t?Rl:Dt),Wt.get(Tt).hidden=ci),At>=0&&(he(t.icon,se.numVerticalIconVertices,dt?Rl:Dt),Wt.get(At).hidden=ci)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const Dt=t.collisionArrays[ce];if(Dt){let Tt=new o.P(0,0),At=!0;if(Dt.textBox||Dt.verticalTextBox){if(B){const ci=this.variableOffsets[Se];ci?(Tt=Qn(ci.anchor,ci.width,ci.height,ci.textOffset,ci.textScale),H&&Tt._rotate(q?this.transform.angle:-this.transform.angle)):At=!1}O&&(At=!Be.clipped),Dt.textBox&&$a(t.textCollisionBox.collisionVertexArray,Be.text.placed,!At||_t,we,te,Tt.x,Tt.y),Dt.verticalTextBox&&$a(t.textCollisionBox.collisionVertexArray,Be.text.placed,!At||dt,we,te,Tt.x,Tt.y)}const Wt=At&&!!(!dt&&Dt.verticalIconBox);Dt.iconBox&&$a(t.iconCollisionBox.collisionVertexArray,Be.icon.placed,Wt,we,te,se.hasIconTextFit?Tt.x:0,se.hasIconTextFit?Tt.y:0),Dt.verticalIconBox&&$a(t.iconCollisionBox.collisionVertexArray,Be.icon.placed,!Wt,we,te,se.hasIconTextFit?Tt.x:0,se.hasIconTextFit?Tt.y:0)}}}if(t.fullyClipped=pe===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const ce=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=ce.invProjMatrix,t.placementViewportMatrix=ce.viewportMatrix,t.collisionCircleArray=ce.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const c=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*c>t}isStale(){return this.stale}setStale(){this.stale=!0}}function $a(l,t,n,c,d,p,_){l.emplaceBack(t?1:0,n?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,_||0,c,d?1:0)}const af=Math.pow(2,25),lu=Math.pow(2,24),dh=Math.pow(2,17),lf=Math.pow(2,16),fh=Math.pow(2,9),co=Math.pow(2,8),fa=Math.pow(2,1);function uo(l){if(l.opacity===0&&!l.placed)return 0;if(l.opacity===1&&l.placed)return 4294967295;const t=l.placed?1:0,n=Math.floor(127*l.opacity);return n*af+t*lu+n*dh+t*lf+n*fh+t*co+n*fa+t}const Rl=0;class oc{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,n,c,d,p,_){const v=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(v,d,t[this._currentTileIndex],this._sortAcrossTiles,_),this._currentTileIndex++,p())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,v.sort(((w,I)=>w.sortKey-I.sortKey)));this._currentPartIndex<v.length;){const w=v[this._currentPartIndex];if(n.placeLayerBucketPart(w,this._seenCrossTileIDs,c,w.symbolInstanceStart===0,_),this._currentPartIndex++,p())return!0}return!1}}class On{constructor(t,n,c,d,p,_,v,w,I){this.placement=new sy(t,p,_,v,w,I),this._currentPlacementIndex=n.length-1,this._forceFullPlacement=c,this._showCollisionBoxes=d,this._done=!1}isDone(){return this._done}continuePlacement(t,n,c,d,p){const _=o.o.now(),v=()=>{const w=o.o.now()-_;return!this._forceFullPlacement&&w>2};for(;this._currentPlacementIndex>=0;){const w=n[t[this._currentPlacementIndex]],I=this.placement.collisionIndex.transform.zoom;if(w.type==="symbol"&&w.visibility!=="none"&&(!w.minzoom||w.minzoom<=I)&&(!w.maxzoom||w.maxzoom>I)){const C=w,O=C.layout.get("symbol-z-elevate"),D=C.layout.get("symbol-sort-key").constantOr(1)!==void 0,z=C.layout.get("symbol-z-order"),N=z==="viewport-y"||z==="auto"&&!(z!=="viewport-y"&&D),B=C.layout.get("text-allow-overlap")||C.layout.get("icon-allow-overlap")||C.layout.get("text-ignore-placement")||C.layout.get("icon-ignore-placement"),H=N&&B,q=this._inProgressLayer=this._inProgressLayer||new oc(C),Y=o.B(w.source,w.scope);if(q.continuePlacement(O||H?d[Y]:c[Y],this.placement,this._showCollisionBoxes,w,v,p))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const os=512/o.al/2;class pa{constructor(t,n,c){this.tileID=t,this.bucketInstanceId=c,this.index=new o.c4(n.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const d=t.canonical.x*o.al,p=t.canonical.y*o.al;for(let _=0;_<n.length;_++){const{key:v,crossTileID:w,tileAnchorX:I,tileAnchorY:C}=n.get(_),O=Math.floor((d+I)*os),D=Math.floor((p+C)*os);this.index.add(O,D),this.keys.push(v),this.crossTileIDs.push(w)}this.index.finish()}findMatches(t,n,c){const d=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z),p=os/Math.pow(2,n.canonical.z-this.tileID.canonical.z),_=n.canonical.x*o.al,v=n.canonical.y*o.al;for(let w=0;w<t.length;w++){const I=t.get(w);if(I.crossTileID)continue;const{key:C,tileAnchorX:O,tileAnchorY:D}=I,z=Math.floor((_+O)*p),N=Math.floor((v+D)*p),B=this.index.range(z-d,N-d,z+d,N+d).sort(((H,q)=>H-q));for(const H of B){const q=this.crossTileIDs[H];if(this.keys[H]===C&&!c.has(q)){c.add(q),I.crossTileID=q;break}}}}}class Cn{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class cf{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(n!==0)for(const c in this.indexes){const d=this.indexes[c],p={};for(const _ in d){const v=d[_];v.tileID=v.tileID.unwrapTo(v.tileID.wrap+n),p[v.tileID.key]=v}this.indexes[c]=p}this.lng=t}addBucket(t,n,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let p=0;p<n.symbolInstances.length;p++)n.symbolInstances.get(p).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const d=this.usedCrossTileIDs[t.overscaledZ];for(const p in this.indexes){const _=this.indexes[p];if(Number(p)>t.overscaledZ)for(const v in _){const w=_[v];w.tileID.isChildOf(t)&&w.findMatches(n.symbolInstances,t,d)}else{const v=_[t.scaledTo(Number(p)).key];v&&v.findMatches(n.symbolInstances,t,d)}}for(let p=0;p<n.symbolInstances.length;p++){const _=n.symbolInstances.get(p);_.crossTileID||(_.crossTileID=c.generate(),d.add(_.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new pa(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const c of n.crossTileIDs)this.usedCrossTileIDs[t].delete(c)}removeStaleBuckets(t){let n=!1;for(const c in this.indexes){const d=this.indexes[c];for(const p in d)t[d[p].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,d[p]),delete d[p],n=!0)}return n}}class Ts{constructor(){this.layerIndexes={},this.crossTileIDs=new Cn,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,c,d){let p=this.layerIndexes[t.fqid];p===void 0&&(p=this.layerIndexes[t.fqid]=new cf);let _=!1;const v={};d.name!=="globe"&&p.handleWrapJump(c);for(const w of n){const I=w.getBucket(t);I&&t.fqid===I.layerIds[0]&&(I.bucketInstanceId||(I.bucketInstanceId=++this.maxBucketInstanceId),p.addBucket(w.tileID,I,this.crossTileIDs)&&(_=!0),v[I.bucketInstanceId]=!0)}return p.removeStaleBuckets(v)&&(_=!0),_}pruneUnusedLayers(t){const n={};t.forEach((c=>{n[c]=!0}));for(const c in this.layerIndexes)n[c]||delete this.layerIndexes[c]}}const Zs=771;class _i{constructor(t,n,c,d){this.blendFunction=t,this.blendColor=n.toNonPremultipliedRenderColor(null),this.mask=c,this.blendEquation=d}}_i.Replace=[1,0,1,0],_i.disabled=new _i(_i.Replace,o.ao.transparent,[!1,!1,!1,!1]),_i.unblended=new _i(_i.Replace,o.ao.transparent,[!0,!0,!0,!0]),_i.alphaBlended=new _i([1,Zs,1,Zs],o.ao.transparent,[!0,!0,!0,!0]),_i.alphaBlendedNonPremultiplied=new _i([770,Zs,770,Zs],o.ao.transparent,[!0,!0,!0,!0]),_i.multiply=new _i([774,0,774,0],o.ao.transparent,[!0,!0,!0,!0]),_i.additive=new _i([1,1,1,1],o.ao.transparent,[!0,!0,!0,!0]);class Bt{constructor(t,n,c){this.func=t,this.mask=n,this.range=c}}Bt.ReadOnly=!1,Bt.ReadWrite=!0,Bt.disabled=new Bt(519,Bt.ReadOnly,[0,1]);const ph=7680;class ri{constructor(t,n,c,d,p,_){this.test=t,this.ref=n,this.mask=c,this.fail=d,this.depthFail=p,this.pass=_}}ri.disabled=new ri({func:519,mask:0},0,0,ph,ph,ph);const sc=1029,mh=2305;class ti{constructor(t,n,c){this.enable=t,this.mode=n,this.frontFace=c}}function $s(l,t){const n=o.ca(l,3);o.cc(l,t),o.cg(l,3,n)}function uf(l,t){const n=o.c7([]);return o.c8(n,n,-t),o.c9(n,n,-l),n}function _h(l,t){const n=[l[0],l[1],0],c=[t[0],t[1],0];if(o.ag(n)>=1e-15){const _=o.aw([],n);o.c5(c,_,o.bJ(c,_)),t[0]=c[0],t[1]=c[1]}const d=o.bI([],t,l);if(o.c6(d)<1e-15)return null;const p=Math.atan2(-d[1],d[0]);return uf(Math.atan2(Math.sqrt(l[0]*l[0]+l[1]*l[1]),-l[2]),p)}ti.disabled=new ti(!1,sc,mh),ti.backCCW=new ti(!0,sc,mh),ti.backCW=new ti(!0,sc,2304),ti.frontCW=new ti(!0,1028,2304),ti.frontCCW=new ti(!0,1028,mh);class ho{constructor(t,n){this.position=t,this.orientation=n}get position(){return this._position}set position(t){if(t){const n=t instanceof o.ae?t:new o.ae(t[0],t[1],t[2]);this._renderWorldCopies&&(n.x=o.bT(n.x,0,1)),this._position=n}else this._position=null}lookAtPoint(t,n,c){if(this.orientation=null,!this.position)return;const d=this.position,p=c||(this._elevation?this._elevation.getAtPointOrZero(o.ae.fromLngLat(t)):0),_=o.ae.fromLngLat(t,p),v=[_.x-d.x,_.y-d.y,_.z-d.z];n||(n=[0,0,1]),n[2]=Math.abs(n[2]),this.orientation=_h(v,n)}setPitchBearing(t,n){this.orientation=uf(o.an(t),o.an(-n))}}class gh{constructor(t,n){this._transform=o.bA([]),this.orientation=n,this.position=t}get mercatorPosition(){const t=this.position;return new o.ae(t[0],t[1],t[2])}get position(){const t=o.ca(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var n;t&&o.cg(this._transform,3,[(n=t)[0],n[1],n[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||o.c7([]),t&&$s(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),n=this.right();return{bearing:Math.atan2(-n[1],n[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,n){this._orientation=uf(t,n),$s(this._transform,this._orientation)}forward(){const t=o.ca(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=o.ca(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=o.ca(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,n){const c=new Float64Array(16);return o.bl(c,this.getWorldToCamera(t,n)),c}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,n,c){const d=this.position;o.c5(d,d,-t);const p=new Float64Array(16);return o.bq(p,[c,c,c]),o.br(p,p,d),p[10]*=n,p}getWorldToCamera(t,n){const c=new Float64Array(16),d=new Float64Array(4),p=this.position;return o.cb(d,this._orientation),o.c5(p,p,-t),o.cc(c,d),o.br(c,c,p),c[1]*=-1,c[5]*=-1,c[9]*=-1,c[13]*=-1,c[8]*=n,c[9]*=n,c[10]*=n,c[11]*=n,c}getCameraToClipPerspective(t,n,c,d){const p=new Float64Array(16);return o.cd(p,t,n,c,d),p}getCameraToClipOrthographic(t,n,c,d,p,_){const v=new Float64Array(16);return o.ce(v,t,n,c,d,p,_),v}getDistanceToElevation(t,n=!1){const c=t===0?0:o.cf(t,n?o.a$(this.position[1]):this.position[1]),d=this.forward();return(c-this.position[2])/d[2]}clone(){return new gh([...this.position],[...this.orientation])}}const jn={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class yh{constructor(t=0,n=0,c=0,d=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(c)||c<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=c,this.right=d}interpolate(t,n,c){return n.top!=null&&t.top!=null&&(this.top=o.ak(t.top,n.top,c)),n.bottom!=null&&t.bottom!=null&&(this.bottom=o.ak(t.bottom,n.bottom,c)),n.left!=null&&t.left!=null&&(this.left=o.ak(t.left,n.left,c)),n.right!=null&&t.right!=null&&(this.right=o.ak(t.right,n.right,c)),this}getCenter(t,n){const c=o.aA((this.left+t-this.right)/2,0,t),d=o.aA((this.top+n-this.bottom)/2,0,n);return new o.P(c,d)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new yh(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Es=15;class hf{constructor(t,n,c,d,p,_,v){this.tileSize=512,this._renderWorldCopies=p===void 0||p,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=c??0,this._maxPitch=d??60,this.setProjection(_),this.setMaxBounds(v),this.width=0,this.height=0,this._center=new o.aT(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new yh,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new gh,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const t=new hf(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<Es}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,n=!1){const c=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||c)&&this._updateCameraOnTerrain(),(t||c)&&this._constrainCamera(n),this._calcMatrices()}getProjection(){return o.aH(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const n=this.projection?this.getProjection():void 0;this.projection=o.cm(this.projectionOptions);const c=this.getProjection(),d=!o.by(n,c);return d&&this._calcMatrices(),this.mercatorFromTransition=!1,d}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=o.cm({name:"mercator"});const n=t!==this.projection.name;return n&&this._calcMatrices(),n}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return o.cf(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new o.P(this.width,this.height)}get bearing(){return o.bT(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const n=-t*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=o.cn(),o.co(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=o.aA(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=o.an(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._setZoom(n),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,n=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!n||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const c=this._elevation;n||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&c.exaggeration()&&this._centerAltitudeValidForExaggeration!==c.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*c.exaggeration(),this._centerAltitudeValidForExaggeration=c.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=c.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;const t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,n=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],c=this.horizonLineFromTop();let d=0,p=0;for(let _=0;_<n.length;_++){const v=new o.P(n[_][0]*this.width,c+n[_][1]*(this.height-c)),w=t.pointCoordinate(v);if(!w)continue;const I=1/Math.hypot(w[0]-this._camera.position[0],w[1]-this._camera.position[1]);d+=w[3]*I,p+=I}return p===0?NaN:d/p}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,n=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),c=this.pixelsPerMeter/this.worldSize*n,d=this._mercatorZfromZoom(t),p=this._mercatorZfromZoom(this._maxZoom),_=Math.max(d-c,p);this._setZoom(this._zoomFromMercatorZ(_))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}equals(t){const n=this.elevation,c=t.elevation,d=n!=null!=(c!=null)||n&&c&&n.exaggeration()!==c.exaggeration();return this.width===t.width&&this.height===t.height&&this.center.lng===t.center.lng&&this.center.lat===t.center.lat&&this.zoom===t.zoom&&this.bearing===t.bearing&&this.pitch===t.pitch&&this.fov===t.fov&&this.projection.name===t.projection.name&&this._edgeInsets.equals(t.padding)&&!d}computeZoomRelativeTo(t){const n=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let c;c=t.z<this._camera.position[2]?[n.x,n.y,n.z]:[t.x,t.y,t.z];const d=o.ag(o.av([],this._camera.position,c));return o.aA(this._zoomFromMercatorZ(d),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let n=!1;if(t.orientation&&!o.cp(t.orientation,this._camera.orientation)&&(n=this._setCameraOrientation(t.orientation)),t.position){const c=[t.position.x,t.position.y,t.position.z];o.cq(c,this._camera.position)||(this._setCameraPosition(c),n=!0)}n&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,n=new ho;return n.position=new o.ae(t[0],t[1],t[2]),n.orientation=this._camera.orientation,n._elevation=this.elevation,n._renderWorldCopies=this.renderWorldCopies,n}_setCameraOrientation(t){if(!o.cr(t))return!1;o.cs(t,t);const n=o.ct([],[0,0,-1],t),c=o.ct([],[0,-1,0],t);if(c[2]<0)return!1;const d=_h(n,c);return!!d&&(this._camera.orientation=d,!0)}_setCameraPosition(t){const n=this.zoomScale(this.minZoom)*this.tileSize,c=this.zoomScale(this.maxZoom)*this.tileSize,d=this.cameraToCenterDistance;t[2]=o.aA(t[2],d/c,d/n),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,c){this._unmodified=!1,this._edgeInsets.interpolate(t,n,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new o.cu(0,t)];if(this.renderWorldCopies){const c=this.pointCoordinate(new o.P(0,0)),d=this.pointCoordinate(new o.P(this.width,0)),p=this.pointCoordinate(new o.P(this.width,this.height)),_=this.pointCoordinate(new o.P(0,this.height)),v=Math.floor(Math.min(c.x,d.x,p.x,_.x)),w=Math.floor(Math.max(c.x,d.x,p.x,_.x)),I=1;for(let C=v-I;C<=w+I;C++)C!==0&&n.push(new o.cu(C,t))}return n}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,n,c,d){let p=[];const _=c!=null,v=!_;if(v&&this.zoom<n||_&&c[0]===0&&c[1]===0)return p;const w=new Set,I=(O,D,z,N,B)=>{const H=o.cY(D,O,z,N,B);w.has(H)||(p.push(new o.aQ(O,D,z,N,B)),w.add(H))};for(let O=0;O<t.length;O++){const D=t[O];if(v&&D.canonical.z!==n||_&&d!==void 0&&d>D.canonical.z)continue;const z=D.canonical,N=D.overscaledZ,B=D.wrap,H=1<<z.z,q=z.x+1<H,Y=z.x>0,te=z.y+1<H,J=z.y>0,_e=D.wrap-(Y?0:1),he=D.wrap+(q?0:1),pe=Y?z.x-1:H-1,ce=q?z.x+1:0;if(_)c[0]<0?(I(N,he,z.z,ce,z.y),c[1]<0&&te&&(I(N,B,z.z,z.x,z.y+1),I(N,he,z.z,ce,z.y+1)),c[1]>0&&J&&(I(N,B,z.z,z.x,z.y-1),I(N,he,z.z,ce,z.y-1))):c[0]>0?(I(N,_e,z.z,pe,z.y),c[1]<0&&te&&(I(N,B,z.z,z.x,z.y+1),I(N,_e,z.z,pe,z.y+1)),c[1]>0&&J&&(I(N,B,z.z,z.x,z.y-1),I(N,_e,z.z,pe,z.y-1))):c[1]<0&&te?I(N,B,z.z,z.x,z.y+1):J&&I(N,B,z.z,z.x,z.y-1);else{const se=D.visibleQuadrants;1&se&&(I(N,_e,z.z,pe,z.y),J&&(I(N,B,z.z,z.x,z.y-1),I(N,_e,z.z,pe,z.y-1))),2&se&&(I(N,he,z.z,ce,z.y),J&&(I(N,B,z.z,z.x,z.y-1),I(N,he,z.z,ce,z.y-1))),4&se&&(I(N,_e,z.z,pe,z.y),te&&(I(N,B,z.z,z.x,z.y+1),I(N,_e,z.z,pe,z.y+1))),8&se&&(I(N,he,z.z,ce,z.y),te&&(I(N,B,z.z,z.x,z.y+1),I(N,he,z.z,ce,z.y+1)))}}const C=[];for(const O of p)p.some((D=>O.isChildOf(D)))||C.push(O);if(p=C.filter((O=>!t.some((D=>!!(O.overscaledZ<n&&D.isChildOf(O))||O.equals(D)||O.isChildOf(D))))),v){const O=1<<n,D=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),z=[O*D.x,O*D.y],N=4,B=N*N;p=p.filter((H=>{const q=H.canonical.x+.5-z[0],Y=H.canonical.y+.5-z[1];return q*q+Y*Y<B}))}return p}extendTileCoverToNearPlane(t,n,c){const d=[],p=new Set;for(const Y of t)p.add(Y.key);const _=(Y,te,J,_e,he)=>{const pe=o.cY(te,Y,J,_e,he);p.has(pe)||(d.push(new o.aQ(Y,te,J,_e,he)),p.add(pe))},v=t.reduce(((Y,te)=>Math.max(Y,te.overscaledZ)),c),w=1<<c,I=[new o.P(0,0),new o.P(o.al,0),new o.P(o.al,o.al),new o.P(0,o.al)],C=new o.P(0,0),O=new o.P(0,0),D=(Y,te)=>{const J=Math.floor(Y[0]),_e=Math.floor(Y[1]),he=(Y[0]-J)*o.al,pe=(Y[1]-_e)*o.al,ce=Math.floor(te[0]),se=Math.floor(te[1]),ye=(te[0]-ce)*o.al,Ce=(te[1]-se)*o.al;for(let Se=-1;Se<=1;Se++){const Ue=J+Se;if(!(Ue<0||Ue>=w)){C.x=he-Se*o.al,O.x=ye-(Ue-ce)*o.al;for(let je=-1;je<=1;je++){const Xe=_e+je;C.y=pe-je*o.al,O.y=Ce-(Xe-se)*o.al,o.cZ(C,O,I)&&_(v,0,c,Ue,Xe)}}}},z=n.points,N=z[o.cv],B=z[o.cw],H=this._projectToGround(N,z[o.cx]),q=this._projectToGround(B,z[o.cy]);return D(N,H),D(B,q),d}_projectToGround(t,n){return o.cz(o.cA(),t,n,t[2]/(t[2]-n[2]))}coveringTiles(t){let n=this.coveringZoomLevel(t);const c=n,d=this.elevation&&this.elevation.exaggeration(),p=d&&!t.isTerrainDEM,_=this.projection.name==="mercator";if(t.minzoom!==void 0&&n<t.minzoom)return[];t.maxzoom!==void 0&&n>t.maxzoom&&(n=t.maxzoom);const v=this.locationCoordinate(this.center),w=this.center.lat,I=1<<n,C=[I*v.x,I*v.y,0],O=this.projection.name==="globe",D=!O,z=o.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,n,D),N=O?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),B=I*o.cf(1,this.center.lat),H=this._camera.position[2]/o.cf(1,this.center.lat),q=[I*N.x,I*N.y,H*(D?1:B)],Y=O||d,te=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),J=this.isLODDisabled(!0)?n:0;let _e;if(this._elevation&&t.isTerrainDEM)_e=1e4*this._elevation.exaggeration();else if(this._elevation){const we=this._elevation.getMinMaxForVisibleTiles();_e=we?we.max:this._centerAltitude}else _e=this._centerAltitude;const he=t.isTerrainDEM?-_e:this._elevation?this._elevation.getMinElevationBelowMSL():0,pe=this.projection.isReprojectedInTileSpace?o.cC(this):1,ce=we=>{const Be=new o.ae(we.x+25e-6,we.y,we.z),et=new o.ae(we.x,we.y+25e-6,we.z),vt=we.toLngLat(),St=Be.toLngLat(),_t=et.toLngLat(),dt=this.locationCoordinate(vt),kt=this.locationCoordinate(St),Dt=this.locationCoordinate(_t),Tt=Math.hypot(kt.x-dt.x,kt.y-dt.y),At=Math.hypot(Dt.x-dt.x,Dt.y-dt.y);return Math.sqrt(Tt*At)*pe/25e-6},se=we=>{const He=_e,Be=he;return{aabb:o.cF(this,I,0,0,0,we,Be,He,this.projection),zoom:0,x:0,y:0,minZ:Be,maxZ:He,wrap:we,fullyVisible:!1}},ye=[];let Ce=[];const Se=n,Ue=t.reparseOverscaled?c:n,je=(H-this._centerAltitude)*B,Xe=we=>{if(!this._elevation||!we.tileID||!_)return;const He=this._elevation.getMinMaxForTile(we.tileID),Be=we.aabb;He?(Be.min[2]=He.min,Be.max[2]=He.max,Be.center[2]=(Be.min[2]+Be.max[2])/2):(we.shouldSplit=ke(we),we.shouldSplit||(Be.min[2]=Be.max[2]=Be.center[2]=this._centerAltitude))},ht=(we,He)=>{if(.707*He<we)return 1;const Be=He/we;return Be/(1.4144271570014144+(Math.pow(1.1,Be-1.4144271570014144+1)-1)/(1.1-1)-1)},ke=we=>{if(we.zoom<J)return!0;if(we.zoom===Se)return!1;if(we.shouldSplit!=null)return we.shouldSplit;const He=we.aabb.distanceX(q),Be=we.aabb.distanceY(q);let et=je,vt=1;if(O){et=we.aabb.distanceZ(q);const At=Math.pow(2,we.zoom),Wt=o.a$((we.y+1)/At),ci=o.a$(we.y/At),Di=Math.min(Math.max(w,Wt),ci),er=o.d1(Di)/o.d1(w);if(vt=Di===w?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,er/this._mercatorScaleRatio),this.zoom<=o.c_&&we.zoom===Se-1&&er>=.9)return!0}else if(p&&(et=we.aabb.distanceZ(q)*B),this.projection.isReprojectedInTileSpace&&c<=5){const At=Math.pow(2,we.zoom),Wt=ce(new o.ae((we.x+.5)/At,(we.y+.5)/At));vt=Wt>.85?1:Wt}if(!_&&!O){const At=Math.sqrt(He*He+Be*Be+et*et);let Wt=(1<<Se-we.zoom)*te*vt;return Wt*=ht(Math.max(et,je),At),At<Wt}let St=Number.MAX_VALUE,_t=0;const dt=we.aabb.getCorners(),kt=[];for(const At of dt){o.av(kt,At,q),O||(p?kt[2]*=B:kt[2]=je);const Wt=o.bJ(kt,this._camera.forward());Wt<St&&(St=Wt,_t=Math.abs(kt[2]))}let Dt=(1<<Se-we.zoom)*te*vt;if(Dt*=ht(Math.max(_t,je),St),St<Dt)return!0;const Tt=we.aabb.closestPoint(C);return Tt[0]===C[0]&&Tt[1]===C[1]};if(this.renderWorldCopies)for(let we=1;we<=3;we++)ye.push(se(-we)),ye.push(se(we));for(ye.push(se(0));ye.length>0;){const we=ye.pop(),He=we.x,Be=we.y;let et=we.fullyVisible;const vt=()=>this.projection.name==="globe"&&(we.y===0||we.y===(1<<we.zoom)-1);if(!et){let St=Y?we.aabb.intersects(z):we.aabb.intersectsFlat(z);if(St===0&&vt()){const _t=new o.cD(we.zoom,He,Be);St=o.cE(this,I,_t,!0).intersects(z)}if(St===0)continue;et=St===2}if(we.zoom!==Se&&ke(we))for(let St=0;St<4;St++){const _t=(He<<1)+St%2,dt=(Be<<1)+(St>>1),kt={aabb:_?we.aabb.quadrant(St):o.cF(this,I,we.zoom+1,_t,dt,we.wrap,we.minZ,we.maxZ,this.projection),zoom:we.zoom+1,x:_t,y:dt,wrap:we.wrap,fullyVisible:et,tileID:void 0,shouldSplit:void 0,minZ:we.minZ,maxZ:we.maxZ};p&&!O&&(kt.tileID=new o.aQ(we.zoom+1===Se?Ue:we.zoom+1,we.wrap,we.zoom+1,_t,dt),Xe(kt)),ye.push(kt)}else{const St=we.zoom===Se?Ue:we.zoom;if(t.minzoom&&t.minzoom>St)continue;let _t=0;if(!et){let Tt=Y?we.aabb.intersectsPrecise(z):we.aabb.intersectsPreciseFlat(z);if(Tt===0&&vt()){const At=new o.cD(we.zoom,He,Be);Tt=o.cE(this,I,At,!0).intersectsPrecise(z)}if(Tt===0)continue;if(t.calculateQuadrantVisibility)if(z.containsPoint(we.aabb.center))_t=15;else for(let At=0;At<4;At++)we.aabb.quadrant(At).intersects(z)!==0&&(_t|=1<<At)}const dt=C[0]-(.5+He+(we.wrap<<we.zoom))*(1<<n-we.zoom),kt=C[1]-.5-Be,Dt=we.tileID?we.tileID:new o.aQ(St,we.wrap,we.zoom,He,Be);t.calculateQuadrantVisibility&&(Dt.visibleQuadrants=_t),Ce.push({tileID:Dt,distanceSq:dt*dt+kt*kt})}}if(this.fogCullDistSq){const we=this.fogCullDistSq,He=this.horizonLineFromTop();Ce=Ce.filter((Be=>{const et=[0,0,0,1],vt=[o.al,o.al,0,1],St=this.calculateFogTileMatrix(Be.tileID.toUnwrapped());o.aC(et,et,St),o.aC(vt,vt,St);const _t=o.cG([],et,vt),dt=o.cH([],et,vt),kt=o.c$(_t,dt);if(kt===0)return!0;let Dt=!1;const Tt=this._elevation;if(Tt&&kt>we&&He!==0){const At=this.calculateProjMatrix(Be.tileID.toUnwrapped());let Wt;t.isTerrainDEM||(Wt=Tt.getMinMaxForTile(Be.tileID)),Wt||(Wt={min:he,max:_e});const ci=o.cI(this.rotation),Di=[ci[0]*o.al,ci[1]*o.al,Wt.max];o.af(Di,Di,At),Dt=(1-Di[1])*this.height*.5<He}return kt<we||Dt}))}return Ce.sort(((we,He)=>we.distanceSq-He.distanceSq)).map((we=>we.tileID))}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log2(t)}project(t){const n=o.aA(t.lat,-o.cJ,o.cJ),c=this.projection.project(t.lng,n);return new o.P(c.x*this.worldSize,c.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/o.cf(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,n){let c,d;const p=this.centerPoint;if(this.projection.name==="globe"){const v=this.worldSize;c=(n.x-p.x)/v,d=(n.y-p.y)/v}else{const v=this.pointCoordinate(n),w=this.pointCoordinate(p);c=v.x-w.x,d=v.y-w.y}const _=this.locationCoordinate(t);this.setLocation(new o.ae(_.x-c,_.y-d))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,n){return this.projection.locationPoint(this,t,n)}locationPoint3D(t,n){return this.projection.locationPoint(this,t,n,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,n){return this.coordinateLocation(this.pointCoordinate3D(t,n))}locationCoordinate(t,n){const c=n?o.cf(n,t.lat):void 0,d=this.projection.project(t.lng,t.lat);return new o.ae(d.x,d.y,c)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,n){const c=n??this._centerAltitude,d=[t.x,t.y,0,1],p=[t.x,t.y,1,1];o.aC(d,d,this.pixelMatrixInverse),o.aC(p,p,this.pixelMatrixInverse);const _=p[3];o.cK(d,d,1/d[3]),o.cK(p,p,1/_);const v=d[2],w=p[2];return{p0:d,p1:p,t:v===w?0:(c-v)/(w-v)}}screenPointToMercatorRay(t){const n=[t.x,t.y,0,1],c=[t.x,t.y,1,1];return o.aC(n,n,this.pixelMatrixInverse),o.aC(c,c,this.pixelMatrixInverse),o.cK(n,n,1/n[3]),o.cK(c,c,1/c[3]),n[2]=o.cf(n[2],this._center.lat)*this.worldSize,c[2]=o.cf(c[2],this._center.lat)*this.worldSize,o.cK(n,n,1/this.worldSize),o.cK(c,c,1/this.worldSize),new o.ax([n[0],n[1],n[2]],o.aw([],o.av([],c,n)))}rayIntersectionCoordinate(t){const{p0:n,p1:c,t:d}=t,p=o.cf(n[2],this._center.lat),_=o.cf(c[2],this._center.lat);return new o.ae(o.ak(n[0],c[0],d)/this.worldSize,o.ak(n[1],c[1],d)/this.worldSize,o.ak(p,_,d))}pointCoordinate(t,n=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,n)}pointCoordinate3D(t,n){if(!this.elevation)return this.pointCoordinate(t,n);let c=this.projection.pointCoordinate3D(this,t.x,t.y);if(c)return new o.ae(c[0],c[1],c[2]);let d=0,p=this.horizonLineFromTop();if(t.y>p)return this.pointCoordinate(t,n);const _=.02*p,v=t.clone();for(let w=0;w<10&&p-d>_;w++){v.y=o.ak(d,p,.66);const I=this.projection.pointCoordinate3D(this,v.x,v.y);I?(p=v.y,c=I):d=v.y}return c?new o.ae(c[0],c[1],c[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=o.cL)return!this.isPointAboveHorizon(t);const n=this.pointCoordinate(t);return n.y>=0&&n.y<=1}_coordinatePoint(t,n){const c=n&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,d=[t.x*this.worldSize,t.y*this.worldSize,c+t.toAltitude(),1];return o.aC(d,d,this.pixelMatrix),d[3]>0?new o.P(d[0]/d[3],d[1]/d[3]):new o.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:n}=this._edgeInsets,c=this.height-this._edgeInsets.bottom,d=this.width-this._edgeInsets.right,p=this.pointLocation3D(new o.P(n,t)),_=this.pointLocation3D(new o.P(d,t)),v=this.pointLocation3D(new o.P(d,c)),w=this.pointLocation3D(new o.P(n,c));let I=Math.min(p.lng,_.lng,v.lng,w.lng),C=Math.max(p.lng,_.lng,v.lng,w.lng),O=Math.min(p.lat,_.lat,v.lat,w.lat),D=Math.max(p.lat,_.lat,v.lat,w.lat);const z=Math.pow(2,-this.zoom)/16*270,N=this.projection.name==="globe"?1:4,B=(H,q,Y,te,J)=>{const _e=(H+Y)/2,he=(q+te)/2,pe=new o.P(_e,he),{lng:ce,lat:se}=this.pointLocation3D(pe),ye=Math.max(0,I-ce,O-se,ce-C,se-D);I=Math.min(I,ce),C=Math.max(C,ce),O=Math.min(O,se),D=Math.max(D,se),(J<N||ye>z)&&(B(H,q,_e,he,J+1),B(_e,he,Y,te,J+1))};if(B(n,t,d,t,1),B(d,t,d,c,1),B(d,c,n,c,1),B(n,c,n,t,1),this.projection.name==="globe"){const[H,q]=o.cM(this);H?(D=90,C=180,I=-180):q&&(O=-90,C=180,I=-180)}return new o.aI(new o.aT(I,O),new o.aT(C,D))}_getBoundsRectangular(t,n){const{top:c,left:d}=this._edgeInsets,p=this.height-this._edgeInsets.bottom,_=this.width-this._edgeInsets.right,v=new o.P(d,c),w=new o.P(_,c),I=new o.P(_,p),C=new o.P(d,p);let O=this.pointCoordinate(v,t),D=this.pointCoordinate(w,t);const z=this.pointCoordinate(I,n),N=this.pointCoordinate(C,n),B=(H,q)=>(q.y-H.y)/(q.x-H.x);return O.y>1&&D.y>=0?O=new o.ae((1-N.y)/B(N,O)+N.x,1):O.y<0&&D.y<=1&&(O=new o.ae(-N.y/B(N,O)+N.x,0)),D.y>1&&O.y>=0?D=new o.ae((1-z.y)/B(z,D)+z.x,1):D.y<0&&O.y<=1&&(D=new o.ae(-z.y/B(z,D)+z.x,0)),new o.aI().extend(this.coordinateLocation(O)).extend(this.coordinateLocation(D)).extend(this.coordinateLocation(N)).extend(this.coordinateLocation(z))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const n=t.visibleDemTiles.reduce(((c,d)=>{if(d.dem){const p=d.dem.tree;c.min=Math.min(c.min,p.minimums[0]),c.max=Math.max(c.max,p.maximums[0])}return c}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(n.min*t.exaggeration(),n.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const n=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,c=this.height/2-n*(1-this._horizonShift);return t?Math.max(0,c):c}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-o.cJ,this.maxLat=o.cJ,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=o.aF(this.minLng)*this.tileSize,this.worldMaxX=o.aF(this.maxLng)*this.tileSize,this.worldMinY=o.aJ(this.maxLat)*this.tileSize,this.worldMaxY=o.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,n){return this.projection.createTileMatrix(this,n,t)}calculateDistanceTileData(t){const n=t.key,c=this._distanceTileDataCache;if(c[n])return c[n];const d=t.canonical,p=1/this.height,_=this.cameraWorldSize,v=_/this.zoomScale(d.z),w=(d.x+Math.pow(2,d.z)*t.wrap)*v,I=d.y*v,C=this.point;C.x*=_/this.worldSize,C.y*=_/this.worldSize;const O=this.angle,D=Math.sin(-O),z=-Math.cos(-O);return c[n]={bearing:[D,z],center:[(C.x-w)*p,(C.y-I)*p],scale:v/o.al*p},c[n]}calculateFogTileMatrix(t){const n=t.key,c=this._fogTileMatrixCache;if(c[n])return c[n];const d=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return o.aB(d,this.worldToFogMatrix,d),c[n]=new Float32Array(d),c[n]}calculateProjMatrix(t,n=!1,c=!1){const d=t.key;let p;if(p=c?this._expandedProjMatrixCache:n?this._alignedProjMatrixCache:this._projMatrixCache,p[d])return p[d];const _=this.calculatePosMatrix(t,this.worldSize);let v;return v=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:c?this.expandedFarZProjMatrix:n?this.alignedProjMatrix:this.projMatrix,o.aB(_,v,_),p[d]=new Float32Array(_),p[d]}calculatePixelsToTileUnitsMatrix(t){const n=t.tileID.key,c=this._pixelsToTileUnitsCache;if(c[n])return c[n];const d=o.cN(t,this);return c[n]=d,c[n]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,n=o.bq([],[t,t,t]);return o.aB(n,n,this.globeMatrix),n}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const n=o.cf(1,this._center.lat)*this.worldSize,c=this._computeCameraPosition(n),d=this._camera.forward(),p=o.cf(1,this._center.lat);c[2]/=p,d[2]/=p,o.aw(d,d);const _=t.raycast(c,d,t.exaggeration());if(_){const v=o.bH([],c,d,_),w=new o.ae(v[0],v[1],o.cf(v[2],o.a$(v[1]))),I=(w.z+o.ag([w.x-c[0],w.y-c[1],w.z-c[2]*p]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(I),this._centerAltitude=w.toAltitude(),this._center=this.coordinateLocation(w),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const n=this._elevation,c=o.cf(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(c),p=n.getAtPointOrZero(new o.ae(...d)),_=this.pixelsPerMeter/this.worldSize*p,v=this._minimumHeightOverTerrain(),w=d[2]-_;if(w<=v)if(w<0||t){const I=this.locationCoordinate(this._center,this._centerAltitude),C=[d[0],d[1],I.z-d[2]],O=o.ag(C);C[2]-=(v-w)/this._pixelsPerMercatorPixel;const D=o.ag(C);if(D===0)return;o.c5(C,C,O/D*this._pixelsPerMercatorPixel),this._camera.position=[d[0],d[1],I.z*this._pixelsPerMercatorPixel-C[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const D=this.center;return D.lat=o.aA(D.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(D.lng=o.aA(D.lng,this.minLng,this.maxLng)),this.center=D,void(this._constraining=!1)}const n=this._unmodified,{x:c,y:d}=this.point;let p=0,_=c,v=d;const w=this.width/2,I=this.height/2,C=this.worldMinY*this.scale,O=this.worldMaxY*this.scale;if(d-I<C&&(v=C+I),d+I>O&&(v=O-I),O-C<this.height&&(p=Math.max(p,this.height/(O-C)),v=(O+C)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const D=this.worldMinX*this.scale,z=this.worldMaxX*this.scale,N=this.worldSize/2-(D+z)/2;_=(c+N+this.worldSize)%this.worldSize-N,_-w<D&&(_=D+w),_+w>z&&(_=z-w),z-D<this.width&&(p=Math.max(p,this.width/(z-D)),_=(z+D)/2)}_===c&&v===d||this._allowWorldUnderZoom||(this.center=this.unproject(new o.P(_,v))),p&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(p)),this._constrainCamera(),this._unmodified=n,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n=this.projection.name==="globe",c=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=o.cf(1,this.center.lat)/o.cf(1,o.d2));const d=o.cO(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,d),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const p=this.projection.zAxisUnit==="meters"?c:1,_=this._camera.getWorldToCamera(this.worldSize,p);let v;const w=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(w[8]=2*-t.x/this.width,w[9]=2*t.y/this.height,this.isOrthographic){let se=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),ye=se*this.aspect,Ce=-ye,Se=-se;ye-=t.x,Ce-=t.x,se+=t.y,Se+=t.y,v=this._camera.getCameraToClipOrthographic(Ce,ye,Se,se,this._nearZ,this._farZ),((Ue,je,Xe,ht)=>{for(let ke=0;ke<16;ke++)Ue[ke]=o.ak(je[ke],Xe[ke],ht)})(v,v,w,o.d0(this.pitch>=Es?1:this.pitch/Es))}else v=w;const I=o.cP([],w,_);let C=o.cP([],v,_);if(this.projection.isReprojectedInTileSpace){const se=this.locationCoordinate(this.center),ye=o.bA([]);o.br(ye,ye,[se.x*this.worldSize,se.y*this.worldSize,0]),o.aB(ye,ye,o.cQ(this)),o.br(ye,ye,[-se.x*this.worldSize,-se.y*this.worldSize,0]),o.aB(C,C,ye),o.aB(I,I,ye),this.inverseAdjustmentMatrix=o.cR(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=o.cS([],C,[this.worldSize,this.worldSize,this.worldSize/p,1]),this.projMatrix=C,this.invProjMatrix=o.bl(new Float64Array(16),this.projMatrix),n){const se=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);se[8]=2*-t.x/this.width,se[9]=2*t.y/this.height,this.expandedFarZProjMatrix=o.cP([],se,_)}else this.expandedFarZProjMatrix=this.projMatrix;const O=o.bl([],v);this.frustumCorners=o.cT.fromInvProjectionMatrix(O,this.horizonLineFromTop(),this.height),this.cameraFrustum=o.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!n);const D=new Float32Array(16);o.bA(D),o.cS(D,D,[1,-1,1]),o.cU(D,D,this._pitch),o.bB(D,D,this.angle);const z=o.cd(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=o.bz(z);const N=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;z[8]=2*-t.x/this.width,z[9]=2*(t.y+N)/this.height,this.skyboxMatrix=o.aB(D,z,D);const B=this.point,H=B.x,q=B.y,Y=this.width%2/2,te=this.height%2/2,J=Math.cos(this.angle),_e=Math.sin(this.angle),he=H-Math.round(H)+J*Y+_e*te,pe=q-Math.round(q)+J*te+_e*Y,ce=new Float64Array(C);if(o.br(ce,ce,[he>.5?he-1:he,pe>.5?pe-1:pe,0]),this.alignedProjMatrix=ce,C=o.bC(),o.cS(C,C,[this.width/2,-this.height/2,1]),o.br(C,C,[1,-1,0]),this.labelPlaneMatrix=C,C=o.bC(),o.cS(C,C,[1,-1,1]),o.br(C,C,[-1,-1,0]),o.cS(C,C,[2/this.width,2/this.height,1]),this.glCoordMatrix=C,this.pixelMatrix=o.aB(new Float64Array(16),this.labelPlaneMatrix,I),this._calcFogMatrices(),this._distanceTileDataCache={},C=o.bl(new Float64Array(16),this.pixelMatrix),!C)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=C,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=o.cV(this);const se=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=o.af(se,se,_),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=C;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,n=this.cameraPixelsPerMeter,c=this._camera.position,d=1/this.height/this._pixelsPerMercatorPixel,p=[t,t,n];o.c5(p,p,d),o.c5(c,c,-1),o.cW(c,c,p);const _=o.bC();o.br(_,_,c),o.cS(_,_,p),this.mercatorFogMatrix=_,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,n,d)}_computeCameraPosition(t){const n=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,c=this._camera.forward(),d=this.point,p=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*n-t/this.worldSize*this._centerAltitude;return[d.x/this.worldSize-c[0]*p,d.y/this.worldSize-c[1]*p,t/this.worldSize*this._centerAltitude-c[2]*p]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const n=this._maxCameraBoundsDistance()*Math.cos(this._pitch),c=this._camera.position[2],d=t[2];let p=1;this.projection.wrap&&(this.center=this.center.wrap()),d>0&&(p=Math.min((n-c)/d,1)),this._camera.position=o.bH([],this._camera.position,t,p),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,n=this._camera.forward(),{pitch:c,bearing:d}=this._camera.getPitchBearing(),p=o.cf(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,_=this._mercatorZfromZoom(this._maxZoom)*Math.cos(o.an(this._maxPitch)),v=Math.max((t[2]-p)/Math.cos(c),_),w=this._zoomFromMercatorZ(v);o.bH(t,t,n,v),this._pitch=o.aA(c,o.an(this.minPitch),o.an(this.maxPitch)),this.angle=o.bT(d,-Math.PI,Math.PI),this._setZoom(o.aA(w,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new o.ae(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let n=0,c=o.cL,d=0,p=1/0;for(;c-n>1e-6&&c>n;){const _=n+.5*(c-n),v=this.tileSize*Math.pow(2,_),w=this.getCameraToCenterDistance(this.projection,_,v),I=this.scaleZoom(w/(Math.max(0,t)*this.tileSize)),C=Math.abs(_-I);C<p&&(p=C,d=_),_<I?n=_:c=_}return d}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(o.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,n){const c=Math.min(t.x,n.x),d=Math.max(t.x,n.x),p=Math.min(t.y,n.y),_=Math.max(t.y,n.y);if(p<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const v=[new o.P(c,p),new o.P(d,_),new o.P(c,_),new o.P(d,p)],w=this.renderWorldCopies?-3:0,I=this.renderWorldCopies?4:1;for(const C of v){const O=this.pointRayIntersection(C);if(O.t<0)return!0;const D=this.rayIntersectionCoordinate(O);if(D.x<w||D.y<0||D.x>I||D.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+o.cX(this.fovAboveCenter)>88||this.anyCornerOffEdge(new o.P(0,0),new o.P(this.width,this.height))}zoomDeltaToMovement(t,n){const c=o.ag(o.av([],this._camera.position,t)),d=this._zoomFromMercatorZ(c)+n;return c-this._mercatorZfromZoom(d)}getCameraPoint(){if(this.projection.name==="globe"){const t=(function([n,c,d],p){const _=[n,c,d,1];o.aC(_,_,p);const v=_[3]=Math.max(_[3],1e-6);return _[0]/=v,_[1]/=v,_[2]/=v,_})([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new o.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new o.P(0,t))}}getCameraToCenterDistance(t,n=this.zoom,c=this.worldSize){const d=o.cO(t,n,this.width,this.height,1024),p=t.pixelSpaceConversion(this.center.lat,c,d);let _=.5/Math.tan(.5*this._fov)*this.height*p;return this.isOrthographic&&(_=o.ak(1,_,o.d0(this.pitch>=Es?1:this.pitch/Es))),_}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&o.aB(t,t,this.globeMatrix),t}getFrustum(t){return o.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}const Wa=(l,t)=>{if(t>0&&l.terrain&&o.w("Cutoff is currently disabled on terrain"),t<=0||l.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const n=l.transform,c=Math.max(Math.abs(n._zoom-(l.minCutoffZoom-1)),1),d=n.isLODDisabled(!1)?o.ah(60,45,n.pitch):o.ah(30,15,n.pitch),p=n._farZ-n._nearZ,_=t*n.height,v=((1-(w=d))*n.cameraToCenterDistance+w*(n._farZ+_))*c;var w;return{shouldRenderCutoff:d<1,uniformValues:{u_cutoff_params:[n._nearZ,n._farZ,(v-n._nearZ)/p,(v-_-n._nearZ)/p]}}},ss=2048;class cu{constructor(t,n){this.aabb=t,this.lastCascade=n}}class ay{add(t,n){const c=this.receivers[t.key];c!==void 0?(c.aabb.min[0]=Math.min(c.aabb.min[0],n.min[0]),c.aabb.min[1]=Math.min(c.aabb.min[1],n.min[1]),c.aabb.min[2]=Math.min(c.aabb.min[2],n.min[2]),c.aabb.max[0]=Math.max(c.aabb.max[0],n.max[0]),c.aabb.max[1]=Math.max(c.aabb.max[1],n.max[1]),c.aabb.max[2]=Math.max(c.aabb.max[2],n.max[2])):this.receivers[t.key]=new cu(n,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,n,c){const d=o.d9.fromPoints(t.points);let p=0;for(const _ in this.receivers){const v=this.receivers[_];if(!v||!d.intersectsAabb(v.aabb))continue;v.aabb.min=d.closestPoint(v.aabb.min),v.aabb.max=d.closestPoint(v.aabb.max);const w=v.aabb.getCorners();for(let I=0;I<c.length;I++){let C=!0;for(const O of w){const D=[O[0]*n,O[1]*n,O[2]];if(o.af(D,D,c[I].matrix),D[0]<-1||D[0]>1||D[1]<-1||D[1]>1){C=!1;break}}if(v.lastCascade=I,p=Math.max(p,I),C)break}}return p+1}}class ac{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new ay,this._depthMode=new Bt(t.context.gl.LEQUAL,Bt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,n){const c=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!n||!n.properties)return;const d=n.properties.get("shadow-intensity");if(!n.shadowsEnabled()||d<=0||(this._shadowLayerCount=c.style.order.reduce(((N,B)=>{const H=c.style._mergedLayers[B];return N+(H.hasShadowPass()&&!H.isHidden(t.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const p=c.context,_=ss,v=ss;if(this._cascades.length===0||ss!==this._cascades[0].texture.size[0]){this._cascades=[];for(let N=0;N<2;++N){const B=c._shadowMapDebug,H=p.gl,q=p.createFramebuffer(_,v,B?1:0,"texture"),Y=new o.T(p,{width:_,height:v,data:null},H.DEPTH_COMPONENT16);if(q.depthAttachment.set(Y.texture),B){const te=new o.T(p,{width:_,height:v,data:null},H.RGBA8);q.colorAttachment0.set(te.texture)}this._cascades.push({framebuffer:q,texture:Y,matrix:[],far:0,boundingSphereRadius:0,frustum:new o.cB,scale:0})}}this.shadowDirection=hu(n);let w=0;if(t.elevation){const N=t.elevation,B=[1e4,-1e4];N.visibleDemTiles.filter((H=>H.dem)).forEach((H=>{const q=H.dem.tree;B[0]=Math.min(B[0],q.minimums[0]),B[1]=Math.max(B[1],q.maximums[0])})),B[0]!==1e4&&(w=(B[1]-B[0])*N.exaggeration())}const I=1.5*t.cameraToCenterDistance,C=3*I,O=new Float64Array(16);for(let N=0;N<this._cascades.length;++N){const B=this._cascades[N];let H=t.height/50,q=1;N===0?q=I:(H=I,q=C);const[Y,te]=Xa(t,this.shadowDirection,H,q,ss,w);B.scale=t.scale,B.matrix=Y,B.boundingSphereRadius=te,o.bl(O,B.matrix),B.frustum=o.cB.fromInvProjectionMatrix(O,1,0,!0),B.far=q}const D=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[D].far,this._cascades[D].far],this._uniformValues.u_shadow_intensity=d,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=.00048828125,this._uniformValues.u_shadow_map_resolution=ss,this._uniformValues.u_shadowmap_0=jn.ShadowMap0,this._uniformValues.u_shadowmap_1=jn.ShadowMap0+1,this._groundShadowTiles=c.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const z=c.transform.elevation;for(const N of this._groundShadowTiles){let B={min:0,max:0};if(z){const H=z.getMinMaxForTile(N);H&&(B=H)}this.addShadowReceiver(N.toUnwrapped(),B.min,B.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,n){if(!this.enabled)return;const c=this.painter,d=c.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(c.transform.getFrustum(0),c.transform.worldSize,this._cascades),d.viewport.set([0,0,ss,ss]);for(let p=0;p<this._numCascadesToRender;++p){c.currentShadowCascade=p,d.bindFramebuffer.set(this._cascades[p].framebuffer.framebuffer),d.clear({color:o.ao.white,depth:1});for(const _ of t.order){const v=t._mergedLayers[_];if(!v.hasShadowPass()||v.isHidden(c.transform.zoom))continue;const w=t.getLayerSourceCache(v),I=w?n[w.id]:void 0;(v.type==="model"||I&&I.length)&&c.renderLayer(c,w,v,I)}}c.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,n=t.style,c=t.context,d=c.gl,p=n.directionalLight,_=n.ambientLight;if(!p||!_)return;const v=[],w=Wa(t,t.longestCutoffRange);w.shouldRenderCutoff&&v.push("RENDER_CUTOFF"),v.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&v.push("NORMAL_OFFSET");const I=ma(n,p,_),C=new Bt(d.LEQUAL,Bt.ReadOnly,t.depthRangeFor3D),O=new ri({func:d.EQUAL,mask:255},0,255,d.KEEP,d.KEEP,d.KEEP);for(const D of this._groundShadowTiles){const z=D.toUnwrapped(),N=t.isTileAffectedByFog(D),B=t.getOrCreateProgram("groundShadow",{defines:v,overrideFog:N});this.setupShadows(z,B),t.uploadCommonUniforms(c,B,z,null,w);const H={u_matrix:t.transform.calculateProjMatrix(z),u_ground_shadow_factor:I};B.draw(t,d.TRIANGLES,C,O,_i.multiply,ti.disabled,H,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?_i.unblended:_i.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const n=this.painter.transform,c=n.calculatePosMatrix(t,n.worldSize);return o.aB(c,this._cascades[this.painter.currentShadowCascade].matrix,c),Float32Array.from(c)}calculateShadowPassMatrixFromMatrix(t){const n=o.bz(t);return o.aB(n,this._cascades[this.painter.currentShadowCascade].matrix,t),n}setupShadows(t,n,c){if(!this.enabled)return;const d=this.painter.transform,p=this.painter.context,_=p.gl,v=this._uniformValues,w=new Float64Array(16),I=d.calculatePosMatrix(t,d.worldSize);for(let C=0;C<this._cascades.length;C++)o.aB(w,this._cascades[C].matrix,I),v[C===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(w),p.activeTexture.set(_.TEXTURE0+jn.ShadowMap0+C),this._cascades[C].texture.bindExtraParam(_.LINEAR,_.LINEAR,_.CLAMP_TO_EDGE,_.CLAMP_TO_EDGE,_.GREATER);if(this.useNormalOffset=!!c,this.useNormalOffset){const C=o.d7(t.canonical),O=2/d.tileSize*o.al/ss,D=O*this._cascades[0].boundingSphereRadius,z=O*this._cascades[this._cascades.length-1].boundingSphereRadius,N=(c==="vector-tile"?1:3)*(function(B,H,q,Y,te){const J=o.aA((B-22)/-22,0,1);return .125*(1-J)+4*J})(d.zoom);v.u_shadow_normal_offset=[C,D*N,z*N],v.u_shadow_bias=[1e-4,.0012,.012]}else v.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(p,v)}setupShadowsFromMatrix(t,n,c=!1){if(!this.enabled)return;const d=this.painter.context,p=d.gl,_=this._uniformValues,v=new Float64Array(16);for(let w=0;w<2;w++)o.aB(v,this._cascades[w].matrix,t),_[w===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(v),d.activeTexture.set(p.TEXTURE0+jn.ShadowMap0+w),this._cascades[w].texture.bindExtraParam(p.LINEAR,p.LINEAR,p.CLAMP_TO_EDGE,p.CLAMP_TO_EDGE,p.GREATER);this.useNormalOffset=c,c?(_.u_shadow_normal_offset=[1,3,3],_.u_shadow_bias=[6e-5,.0012,.012]):_.u_shadow_bias=[36e-5,.0012,.012],n.setShadowUniformValues(d,_)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,n,c,d){if(d[2]>=0)return{};const p=(function(w,I,C){const O=C/(1<<w.canonical.z);return new o.d9([w.canonical.x*O+w.wrap*C,w.canonical.y*O+w.wrap*C,0],[(w.canonical.x+1)*O+w.wrap*C,(w.canonical.y+1)*O+w.wrap*C,I])})(t,n,c).getCorners(),_=n/-d[2];d[0]<0?(o.d8(p[0],p[0],[d[0]*_,0,0]),o.d8(p[3],p[3],[d[0]*_,0,0])):d[0]>0&&(o.d8(p[1],p[1],[d[0]*_,0,0]),o.d8(p[2],p[2],[d[0]*_,0,0])),d[1]<0?(o.d8(p[0],p[0],[0,d[1]*_,0]),o.d8(p[1],p[1],[0,d[1]*_,0])):d[1]>0&&(o.d8(p[2],p[2],[0,d[1]*_,0]),o.d8(p[3],p[3],[0,d[1]*_,0]));const v={};return v.vertices=p,v.planes=[uu(p[1],p[0],p[4]),uu(p[2],p[1],p[5]),uu(p[3],p[2],p[6]),uu(p[0],p[3],p[7])],v}addShadowReceiver(t,n,c){this._receivers.add(t,o.d9.fromTileIdAndHeight(t,n,c))}getMaxCascadeForTile(t){const n=this._receivers.get(t);return n&&n.lastCascade?n.lastCascade:0}}function uu(l,t,n){const c=o.av([],n,t),d=o.av([],l,t),p=o.bI([],c,d),_=o.ag(p);return _===0?[0,0,1,0]:(o.c5(p,p,1/_),[p[0],p[1],p[2],-o.bJ(p,t)])}function hu(l){const t=l.properties.get("direction"),n=o.d4(t.x,t.y,t.z);n[2]=o.aA(n[2],0,75);const c=o.d6([n[0],n[1],n[2]]);return o.d5(c.x,c.y,c.z)}function ma(l,t,n){const c=t.properties.get("color-use-theme")==="none",d=t.properties.get("color"),p=t.properties.get("intensity"),_=t.properties.get("direction"),v=[_.x,_.y,_.z],w=n.properties.get("color-use-theme")==="none",I=n.properties.get("color"),C=n.properties.get("intensity"),O=Math.max(o.bJ([0,0,1],v),0),D=[0,0,0];o.c5(D,I.toPremultipliedRenderColor(w?null:l.getLut(t.scope)).toArray01Linear().slice(0,3),C);const z=[0,0,0];return o.c5(z,d.toPremultipliedRenderColor(c?null:l.getLut(n.scope)).toArray01Linear().slice(0,3),O*p),o.db([D[0]>0?D[0]/(D[0]+z[0]):0,D[1]>0?D[1]/(D[1]+z[1]):0,D[2]>0?D[2]/(D[2]+z[2]):0])}function Xa(l,t,n,c,d,p){const _=l.zoom,v=l.scale,w=l.worldSize,I=1/w,C=l.aspect,O=Math.sqrt(1+C*C)*Math.tan(.5*l.fovX),D=O*O,z=c-n,N=c+n;let B,H;D>z/N?(B=c,H=c*O):(B=.5*N*(1+D),H=.5*Math.sqrt(z*z+2*(c*c+n*n)*D+N*N*D*D));const q=l.projection.pixelsPerMeter(l.center.lat,w),Y=l._camera.getCameraToWorldMercator(),te=[0,0,-B*I];o.af(te,te,Y);let J=H*I;const _e=l._edgeInsets;if(!(_e.left===0&&_e.top===0&&_e.right===0&&_e.bottom===0||_e.left===_e.right&&_e.top===_e.bottom)){const et=l._camera.getWorldToCamera(l.worldSize,l.projection.zAxisUnit==="meters"?q:1),vt=l._camera.getCameraToClipPerspective(l._fov,l.width/l.height,n,c);vt[8]=2*-l.centerOffset.x/l.width,vt[9]=2*l.centerOffset.y/l.height;const St=new Float64Array(16);o.cP(St,vt,et);const _t=new Float64Array(16);o.bl(_t,St);const dt=o.cB.fromInvProjectionMatrix(_t,w,_,!0);for(const kt of dt.points){const Dt=((he=kt)[0]/=v,he[1]/=v,he[2]=o.cf(he[2],l._center.lat),he);J=Math.max(J,o.c6(o.da([],te,Dt)))}}var he;J*=d/(d-1);const pe=Math.acos(t[2]),ce=Math.atan2(-t[0],-t[1]),se=new gh;se.position=te,se.setPitchBearing(pe,ce);const ye=se.getWorldToCamera(w,q),Ce=J*w,Se=Math.min(l._mercatorZfromZoom(17)*w*-2,-2*Ce),Ue=se.getCameraToClipOrthographic(-Ce,Ce,-Ce,Ce,Se,(Ce+p*q)/t[2]),je=new Float64Array(16);o.aB(je,Ue,ye);const Xe=o.d5(Math.floor(1e6*te[0])/1e6*w,Math.floor(1e6*te[1])/1e6*w,0),ht=.5*d,ke=[0,0,0];o.af(ke,Xe,je),o.c5(ke,ke,ht);const we=[Math.floor(ke[0]),Math.floor(ke[1]),Math.floor(ke[2])],He=[0,0,0];o.av(He,ke,we),o.c5(He,He,-1/ht);const Be=new Float64Array(16);return o.bA(Be),o.br(Be,Be,He),o.aB(je,Be,je),[je,Ce]}class ly extends o.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,n){return o.dc(this.requestManager.transformRequest(n,o.R.Model).url).then((c=>{if(!c)return;const d=o.dd(c),p=new o.de(t,n,void 0,void 0,d);return p.computeBoundsAndApplyParent(),p})).catch((c=>{if(c&&c.status===404)return null;this.fire(new o.y(new Error(`Could not load model ${t} from ${n}: ${c.message}`)))}))}load(t,n,c={forceReload:!1}){this.models[n]||(this.models[n]={});const d=Object.keys(t),p=[],_=[];for(const v of d){const w=t[v];this.hasURLBeenRequested(w)&&!c.forceReload||(this.modelByURL[w]={modelId:v,scope:n},p.push(this.loadModel(v,w)),_.push(v)),this.models[n][v]||(this.models[n][v]={model:null,numReferences:1})}this.numModelsLoading[n]=(this.numModelsLoading[n]||0)+_.length,Promise.allSettled(p).then((v=>{for(let w=0;w<v.length;w++){const{status:I}=v[w];if(I==="rejected")continue;const{value:C}=v[w];this.models[n][_[w]]||(this.models[n][_[w]]={model:null,numReferences:1}),this.models[n][_[w]].model=C}this.numModelsLoading[n]-=_.length,this.fire(new o.z("data",{dataType:"style"}))})).catch((v=>{this.fire(new o.y(new Error(`Could not load models: ${v.message}`)))}))}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,n,c={exactIdMatch:!1}){return!!(c.exactIdMatch?this.getModel(t,n):this.getModelByURL(this.modelUris[n][t]))}getModel(t,n){return this.models[n]||(this.models[n]={}),this.models[n][t]?this.models[n][t].model:void 0}getModelByURL(t){if(!t)return null;const n=this.modelByURL[t];return n?this.models[n.scope][n.modelId].model:null}hasModelBeenAdded(t,n){return this.models[n]&&this.models[n][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,n,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={});const d=this.requestManager.normalizeModelURL(n);if((this.hasModel(t,c,{exactIdMatch:!0})||this.hasModelBeenAdded(t,c))&&this.modelUris[c][t]===d)this.models[c][t].numReferences++;else if(this.hasURLBeenRequested(d)){const{scope:p,modelId:_}=this.modelByURL[d];this.models[p][_].numReferences++}else this.modelUris[c][t]=d,this.load({[t]:this.modelUris[c][t]},c)}addModelURLs(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c=this.modelUris[n];for(const d in t)c[d]=this.requestManager.normalizeModelURL(t[d])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c={};for(const d of t)this.hasModel(d,n,{exactIdMatch:!0})||this.hasURLBeenRequested(d)?this.models[n][d].numReferences++:this.modelUris[n][d]&&!this.hasURLBeenRequested(d)?c[d]=this.modelUris[n][d]:!this.hasURLBeenRequested(d)&&o.df(d,!1)&&(this.modelUris[n][d]=this.requestManager.normalizeModelURL(d),c[d]=this.modelUris[n][d]);this.load(c,n)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,n,c=!1,d=!1){if(this.models[n]&&this.models[n][t]&&(this.models[n][t].numReferences--,this.models[n][t].numReferences===0||d)){const p=this.modelUris[n][t];c||delete this.modelUris[n][t],delete this.modelByURL[p];const _=this.models[n][t].model;if(!_)return;delete this.models[n][t],_.destroy()}}destroy(){for(const t of Object.keys(this.models))for(const n of Object.keys(this.models[t])){const c=this.models[t][n].model;delete this.models[t][n],c&&c.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,n){this.models[n]||(this.models[n]={});for(const c in this.models[n])this.models[n][c].model&&this.models[n][c].model.upload(t.context)}}const df=o.a6.colorTheme,cy=new o.a9({data:new o.aa(df.data)});function Cm(l){if(!l.metadata||!l.metadata.content_area)return;const t=o.o.devicePixelRatio,{left:n,top:c,width:d,height:p}=l.metadata.content_area,_=n*t,v=c*t;return[_,v,_+d*t,v+p*t]}function Mm(l){if(l)return l.map((([t,n])=>[t*o.o.devicePixelRatio,n*o.o.devicePixelRatio]))}class ff{constructor(t,n,c){this.id=t,this.scope=n,this.sourceCache=c,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const t=new Map;if(!this.sourceCache.loaded())return t;const n=this.sourceCache.getVisibleCoordinates();if(n.length===0)return t;const c=this.sourceCache.getSource();if(!(c instanceof oo))return t;const d=n.map((_=>this.sourceCache.getTile(_))),p=c.getImages(d,Array.from(this.pendingRequests));for(const[_,v]of p)t.set(o.I.from({name:_,iconsetId:this.id}),v),this.pendingRequests.delete(_);for(const _ of this.pendingRequests)this.missingRequests.add(_);return this.pendingRequests.clear(),t}}const Ya=(l,t)=>ne(l,t&&t.filter((n=>n.identifier!=="source.canvas"))),Pm=o.aH(Wi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setLayerProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),Lm=o.aH(Wi,["setCenter","setZoom","setBearing","setPitch"]),vh=new Set(["background","sky","slot","custom"]),Ja={version:8,layers:[],sources:{}},du={duration:300,delay:0};class as extends o.E{constructor(t,n={}){super(),this.map=t,this.scope=n.scope||"",this.globalId=null,this.fragments=[],this.importDepth=n.importDepth||0,this.importsCache=n.importsCache||new Map,this.resolvedImports=n.resolvedImports||new Set,this.transition=Object.assign({},du),this._buildingIndex=new oy(this),this.crossTileSymbolIndex=new Ts,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedIndoor={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._hasAppearances=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._importedAsBasemap=!1,this._changes=n.styleChanges||new Kr,this._hasDataDrivenEmissive=!1,this.dispatcher=n.dispatcher?n.dispatcher:new o.D(o.dh(),this),n.imageManager?this.imageManager=n.imageManager:(this.imageManager=new Vo(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=n.glyphManager?n.glyphManager:new o.di(t._requestManager,n.localFontFamily?o.dj.all:n.localIdeographFontFamily?o.dj.ideographs:o.dj.none,n.localFontFamily||n.localIdeographFontFamily),n.modelManager?this.modelManager=n.modelManager:(this.modelManager=new ly(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=n.configOptions?n.configOptions:new Map,this._configDependentLayers=n.configDependentLayers?n.configDependentLayers:new Set,this._indoorDependentLayers=n.indoorDependentLayers?n.indoorDependentLayers:new Set,this._config=n.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:n.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=n.initialConfig,this.dispatcher.broadcast("setReferrer",o.dk());const c=this;this._rtlTextPluginCallback=as.registerForPluginStateChange((d=>{c.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:d.pluginStatus,pluginURL:d.pluginURL},((p,_)=>{if(o.dl(p),_&&_.every((v=>v)))for(const v in c._sourceCaches){const w=c._sourceCaches[v],I=w.getSource().type;I!=="vector"&&I!=="geojson"||w.reload()}}))})),this.on("data",(d=>{if(d.dataType!=="source"||d.sourceDataType!=="metadata")return;const p=this.getOwnSource(d.sourceId);if(p&&p.vectorLayerIds)for(const _ in this._layers){const v=this._layers[_];v.source===p.id&&this._validateLayer(v)}}))}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(o.h(t))return t;const n=o.dm(t);if(!n.startsWith("http"))try{return new URL(n,location.href).toString()}catch{return n}return n}return`json://${o.dn(JSON.stringify(t))}`}_diffStyle(t,n,c){this.globalId=this._getGlobalId(t);const d=(p,_)=>{try{_(null,this.setState(p,c))}catch(v){_(v,!1)}};if(typeof t=="string"){const p=this.map._requestManager.normalizeStyleURL(t),_=this.map._requestManager.transformRequest(p,o.R.Style);o.m(_,((v,w)=>{v?this.fire(new o.y(v)):w&&d(w,n)}))}else typeof t=="object"&&d(t,n)}loadURL(t,n={}){this.fire(new o.z("dataloading",{dataType:"style"}));const c=typeof n.validate=="boolean"?n.validate:!o.h(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,n.accessToken),this.resolvedImports.add(t);const d=this.importsCache.get(t);if(d)return this._load(d,c);const p=this.map._requestManager.transformRequest(t,o.R.Style);this._request=o.m(p,((_,v)=>{if(this._request=null,_)this.fire(new o.y(_));else if(v)return this.importsCache.set(t,v),this._load(v,c)}))}loadJSON(t,n={}){this.fire(new o.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=o.o.frame((()=>{this._request=null,this._load(t,n.validate!==!1)}))}loadEmpty(){this.fire(new o.z("dataloading",{dataType:"style"})),this._load(Ja,!1)}_loadImports(t,n,c){if(this.importDepth>=4)return o.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const d=[];for(const p of t){const _=this._createFragmentStyle(p),v=new Promise((C=>{_.once("style.import.load",C),_.once("error",C)})).then((()=>this.mergeAll()));if(d.push(v),this.resolvedImports.has(p.url)){_.loadEmpty();continue}const w=p.data||this.importsCache.get(p.url);w?(_.loadJSON(w,{validate:n}),this._isInternalStyle(w)&&(_.globalId=null)):p.url?_.loadURL(p.url,{validate:n}):_.loadEmpty();const I={style:_,id:p.id,config:p.config};if(c){const C=this.fragments.findIndex((({id:O})=>O===c));this.fragments=this.fragments.slice(0,C).concat(I).concat(this.fragments.slice(C))}else this.fragments.push(I)}return Promise.allSettled(d)}getImportGlobalIds(t=this,n=new Set){for(const c of t.fragments)c.style.globalId&&n.add(c.style.globalId),this.getImportGlobalIds(c.style,n);return[...n.values()]}_createFragmentStyle(t){const n=this.scope?o.B(t.id,this.scope):t.id;let c;const d=this._initialConfig&&this._initialConfig[n];(t.config||d)&&(c=Object.assign({},t.config,d));const p=new as(this.map,{scope:n,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:c,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers,indoorDependentLayers:this._indoorDependentLayers});return p.setEventedParent(this.map,{style:p}),p}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this._updateLayers(this._indoorDependentLayers),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,n){if(this._isInternalStyle(t)){const p=Object.assign({},Ja,{imports:[{id:"basemap",data:t,url:""}]},t.center?{center:t.center}:{},t.bearing?{bearing:t.bearing}:{},t.pitch?{pitch:t.pitch}:{},t.zoom?{zoom:t.zoom}:{},t.light?{light:t.light}:{});return this._importedAsBasemap=!0,void this._load(p,n)}if(this.updateConfig(this._config,t.schema),n&&Ya(this,vs(t)))return;this._loaded=!0,this.stylesheet=o.dp(t);const c=()=>{for(const w in t.sources)this.addSource(w,t.sources[w],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const w in t.iconsets)this.addIconset(w,t.iconsets[w]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);const p=eu(this.stylesheet.layers);if(this._order=p.map((w=>w.id)),this.stylesheet.light&&o.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const w=this.stylesheet.lights[0];this.light=new Ie(w.properties,w.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Ie(this.stylesheet.light)),this._layers={};for(const w of p){const I=o.du(w,this.scope,this._styleColorTheme.lut,this.options);I.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(I.fqid),I.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(I.fqid),this._hasAppearances=this._hasAppearances||I.getAppearances().length!==0,I.setEventedParent(this,{layer:{id:I.id}}),this._layers[I.id]=I;const C=this.getOwnLayerSourceCache(I),O=!!this.directionalLight&&this.directionalLight.shadowsEnabled();C&&I.canCastShadows()&&O&&(C.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const _=this.stylesheet.terrain;_&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(_,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new o.z("data",{dataType:"style"}));const v=this.isRootStyle();t.imports?this._loadImports(t.imports,n).then((()=>{this._reloadImports(),this.fire(new o.z(v?"style.load":"style.import.load"))})).catch((w=>{this.fire(new o.y(new Error("Failed to load imports",w))),this.fire(new o.z(v?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new o.z(v?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const d=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(d){const p=this._evaluateColorThemeData(d);this._loadColorTheme(p).then((()=>{c()})).catch((_=>{o.w(`Couldn't load color theme from the stylesheet: ${_}`),c()}))}else this._styleColorTheme.lut=null,c()}isRootStyle(){return this.importDepth===0}hasAppearances(){return this._hasAppearances||this.fragments.some((t=>t.style.hasAppearances()))}mergeAll(){let t,n,c,d,p,_,v,w,I,C;const O={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((D=>{if(D.stylesheet){if(D.light!=null&&(t=D.light),D.stylesheet.lights)for(const z of D.stylesheet.lights)z.type==="ambient"&&D.ambientLight!=null&&(n=D.ambientLight),z.type==="directional"&&D.directionalLight!=null&&(c=D.directionalLight);d=this._prioritizeTerrain(d,D.terrain,D.stylesheet.terrain),D.stylesheet.fog&&D.fog!=null&&(p=D.fog),D.stylesheet.snow&&D.snow!=null&&(_=D.snow),D.stylesheet.rain&&D.rain!=null&&(v=D.rain),D.stylesheet.camera!=null&&(C=D.stylesheet.camera),D.stylesheet.projection!=null&&(w=D.stylesheet.projection),D.stylesheet.transition!=null&&(I=D.stylesheet.transition),O[D.scope]=D._styleColorTheme}})),this.light=t,this.ambientLight=n,this.directionalLight=c,this.fog=p,this.snow=_,this.rain=v,this._styleColorThemeForScope=O,d===null?delete this.terrain:this.terrain=d,this.camera=C||{"camera-projection":"perspective"},this.projection=w||{name:"mercator"},this.transition=Object.assign({},du,I),this.mergeSources(),this.mergeLayers(),this.mergeIndoor()}forEachFragmentStyle(t){const n=c=>{for(const d of c.fragments)n(d.style);t(c)};n(this)}_prioritizeTerrain(t,n,c){const d=t&&t.drapeRenderMode===0;return c===null?n&&n.drapeRenderMode===0?n:d?t:null:n!=null&&(!t||d||n&&n.drapeRenderMode===1)?n:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((n=>{t=this._prioritizeTerrain(t,n.terrain,n.stylesheet.terrain)})),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle((n=>{n.stylesheet.projection!=null&&(t=n.stylesheet.projection)})),this.projection=t||{name:"mercator"}}mergeSources(){const t={},n={},c={};this.forEachFragmentStyle((d=>{for(const p in d._sourceCaches){const _=o.B(p,d.scope);t[_]=d._sourceCaches[p]}for(const p in d._otherSourceCaches){const _=o.B(p,d.scope);n[_]=d._otherSourceCaches[p]}for(const p in d._symbolSourceCaches){const _=o.B(p,d.scope);c[_]=d._symbolSourceCaches[p]}})),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=n,this._mergedSymbolSourceCaches=c}mergeIndoor(){this.forEachFragmentStyle((t=>{if(t.stylesheet&&t.stylesheet.indoor)for(const n of Object.values(t.stylesheet.indoor)){const c=n,d=o.B(c.sourceId,t.scope);this._mergedIndoor[d]=new Set(c.sourceLayers||[])}}))}mergeLayers(){const t={},n=[],c={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((_=>{for(const v of _._order){const w=_._layers[v];if(w.type==="slot"){const I=o.dq(v);if(t[I])continue;t[I]=[]}w.slot&&t[w.slot]?t[w.slot].push(w):n.push(w)}})),this._mergedOrder=[];let d=-1;const p=(_=[])=>{for(const v of _)if(v.type==="slot"){const w=o.dq(v.id);t[w]&&p(t[w]),this._mergedSlots.push(w)}else{const w=o.B(v.id,v.scope);this._mergedOrder.push(w),c[w]=v,v.is3D(!!this.terrain)&&(this._has3DLayers=!0,d=this._mergedOrder.length-1),v.type==="circle"&&(this._hasCircleLayers=!0),v.type==="symbol"&&(this._hasSymbolLayers=!0),v.type==="clip"&&(this._clipLayerPresent=!0)}};if(p(n),this._has3DLayers){const _={};for(let v=0;v<this._mergedOrder.length;++v){const w=this._mergedOrder[v];_[w]=v===d?1:v<d?c[w].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort(((v,w)=>_[v]-_[w]))}this._mergedLayers=c,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged(),this._updateDataDrivenEmissiveStrength()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?(function(n,c,d,p){const _=Object.assign({},c);for(const w of Object.keys(df))_[w]===void 0&&(_[w]=df[w].default);const v=new o.a8(cy,n,new Map(d));return v.setTransitionOrValue(_,d),v.untransitioned().possiblyEvaluate(new o.ac(0,{worldview:void 0}))})(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const n=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((c,d)=>{const p="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void c();let _=t;_.startsWith(p)||(_=p+_);const v=o.I.from("mapbox-reserved-lut"),w=new Image;w.src=_,w.onerror=()=>{this._styleColorTheme.lutLoading=!1,d(new Error("Failed to load image data"))},w.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==n)return void c();this._styleColorTheme.lutLoading=!1;const{width:I,height:C,data:O}=o.o.getImageData(w);if(C>32)return void d(new Error("The height of the image must be less than or equal to 32 pixels."));if(I!==C*C)return void d(new Error("The width of the image must be equal to the height squared."));this.getImage(v)&&this.removeImage(v),this.addImage(v,{data:new o.q({width:I,height:C},O),pixelRatio:1,sdf:!1,usvg:!1,version:0});const D=this.imageManager.getImage(v,this.scope);D?(this._styleColorTheme.lut={image:D.data,data:t},c()):d(new Error("Missing LUT image."))}}))}getLut(t){const n=this._styleColorThemeForScope[t];return n?n.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=(function(n,c,d){let p,_,v;const w=o.o.devicePixelRatio>1?"@2x":"";let I=o.m(c.transformRequest(c.normalizeSpriteURL(n,w,".json"),o.R.SpriteJSON),((D,z)=>{I=null,v||(v=D,p=z,O())})),C=o.n(c.transformRequest(c.normalizeSpriteURL(n,w,".png"),o.R.SpriteImage),((D,z)=>{C=null,v||(v=D,_=z,O())}));function O(){if(v)d(v);else if(p&&_){const D=o.o.getImageData(_),z={};for(const N in p){const{width:B,height:H,x:q,y:Y,sdf:te,pixelRatio:J,stretchX:_e,stretchY:he,content:pe}=p[N],ce=new o.q({width:B,height:H});o.q.copy(D,ce,{x:q,y:Y},{x:0,y:0},{width:B,height:H},null),z[N]={data:ce,pixelRatio:J!==void 0?J:1,sdf:te!==void 0&&te,stretchX:_e,stretchY:he,content:pe,usvg:!1,version:0}}d(null,z)}}return{cancel(){I&&(I.cancel(),I=null),C&&(C.cancel(),C=null)}}})(t,this.map._requestManager,((n,c)=>{if(this._spriteRequest=null,n)this.fire(new o.y(n));else if(c){const d=new Map;for(const p in c)d.set(o.I.from(p),c[p]);this.addImages(d)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.z("data",{dataType:"style"}))}))}addIconset(t,n){if(n.type==="sprite")return void this._loadSprite(n.url);const c=this.getOwnSourceCache(n.source);if(!c)return void this.fire(new o.y(new Error(`Source "${n.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));const d=c.getSource();if(d.type!=="raster-array")return void this.fire(new o.y(new Error(`Source "${n.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));d.partial=!1;const p=new ff(t,this.scope,c);this.imageManager.addImageProvider(p,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!o.h(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);const n=this.map._spriteFormat==="auto";var c,d;this._spriteRequest=(d=(p,_)=>{if(this._spriteRequest=null,p)n?this._loadSprite(t):this.fire(new o.y(p));else if(_){const v=new Map;for(const w in _)v.set(o.I.from(w),_[w]);this.addImages(v)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.z("data",{dataType:"style"}))},o.bu((c=this.map._requestManager).transformRequest(c.normalizeIconsetURL(t),o.R.Iconset),((p,_)=>{if(p)return void d(p);const v={},w=o.dg(new o.bt(_));for(const I of w.icons){const C={version:1,pixelRatio:o.o.devicePixelRatio,content:Cm(I),stretchX:I.metadata?Mm(I.metadata.stretch_x_areas):void 0,stretchY:I.metadata?Mm(I.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:I};v[I.name]=C}d(null,v)})))}_validateLayer(t){const n=this.getOwnSource(t.source);if(!n)return;const c=t.sourceLayer;c&&(n.type==="geojson"||n.vectorLayerIds&&n.vectorLayerIds.indexOf(c)===-1)&&this.fire(new o.y(new Error(`Source layer "${c}" does not exist on source "${n.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((t,n)=>{const c=this.fragments[n];return c&&c.style&&(t.data=c.style.serialize()),t}))}_serializeSources(){const t={};for(const n in this._sourceCaches){const c=this._sourceCaches[n].getSource();t[c.id]||(t[c.id]=c.serialize())}return t}_serializeLayers(t){const n=[];for(const c of t){const d=this._layers[c];d&&d.type!=="custom"&&n.push(d.serialize())}return n}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}_updateDataDrivenEmissiveStrength(){for(const t in this._mergedLayers){const n=this._mergedLayers[t];if(n._transitionablePaint&&n._transitionablePaint._values){const c=n._transitionablePaint._values["line-emissive-strength"];if(c&&c.value&&c.value.isDataDriven())return void(this._hasDataDrivenEmissive=!0)}}this._hasDataDrivenEmissive=!1}hasDataDrivenEmissiveStrength(){return this._hasDataDrivenEmissive}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const n=this.getOwnLayer(t);if(n)return n;this.fire(new o.y(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const n=this.getOwnSource(t);if(n)return n;this.fire(new o.y(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,n){const c=this.map.painter;if(c)for(let d=t.minzoom||0;d<(t.maxzoom||25.5);d++){const p=t.getProgramIds();if(p)for(const _ of p){const v=t.getDefaultProgramParams(_,n.zoom,this._styleColorTheme.lut);v&&(c.style=this,this.fog&&(c._fogVisible=!0,v.overrideFog=!0,c.getOrCreateProgram(_,v)),c._fogVisible=!1,v.overrideFog=!1,c.getOrCreateProgram(_,v),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(v.overrideRtt=!0,c.getOrCreateProgram(_,v)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const n=this.calculateLightsBrightness();t.brightness=n||0,n!==this._brightness&&(this._brightness=n,this.dispatcher.broadcast("setBrightness",n)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const c=this._changes.isDirty();let d=!1;if(this._changes.isDirty()){const v=this._changes.getLayerUpdatesByScope();for(const w in v){const{updatedIds:I,removedIds:C}=v[w];(I||C)&&(this._updateWorkerLayers(w,I,C),d=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const p={};for(const v in this._mergedSourceCaches){const w=this._mergedSourceCaches[v];p[v]=w.used,w.used=!1,w.tileCoverLift=0}for(const v of this._mergedOrder){const w=this._mergedLayers[v];if(w.visibility!=="none"&&w.recalculate(t,this._availableImages),!w.isHidden(t.zoom)){const I=this.getLayerSourceCache(w);I&&(I.used=!0,I.tileCoverLift=Math.max(I.tileCoverLift,w.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback((()=>{this.precompilePrograms(w,t)})):this.precompilePrograms(w,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&d&&this.mergeLayers();const _=this.imageManager.getPendingImageProviders();for(const v of _)v.sourceCache.used=!0;for(const v in p){const w=this._mergedSourceCaches[v];p[v]!==w.used&&w.getSource().fire(new o.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:w.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),c&&this.fire(new o.z("data",{dataType:"style"}))}updateImageProviders(){const t=this.imageManager.getPendingImageProviders();for(const n of t){const c=n.resolvePendingRequests(),d=this.getFragmentStyle(n.scope);d&&d.addImages(c)}}_updateTilesForChangedImages(){const t={};for(const n in this._mergedSourceCaches){const c=this._mergedSourceCaches[n].getSource().scope;t[c]=t[c]||this._changes.getUpdatedImages(c),t[c].length!==0&&this._mergedSourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t[c])}for(const n in t)this._changes.resetUpdatedImages(n)}_updateWorkerLayers(t,n,c){const d=this.getFragmentStyle(t);d&&this.dispatcher.broadcast("updateLayers",{layers:n?d._serializeLayers(n):[],scope:t,removedIds:c||[],options:d.options})}setState(t,n){if(this._checkLoaded(),Ya(this,vs(t)))return!1;(t=o.dp(t)).layers=eu(t.layers);const c=(function(_,v){if(!_)return[{command:Wi.setStyle,args:[v]}];let w=[];try{if(!o.by(_.version,v.version))return[{command:Wi.setStyle,args:[v]}];if(o.by(_.center,v.center)||w.push({command:Wi.setCenter,args:[v.center]}),o.by(_.zoom,v.zoom)||w.push({command:Wi.setZoom,args:[v.zoom]}),o.by(_.bearing,v.bearing)||w.push({command:Wi.setBearing,args:[v.bearing]}),o.by(_.pitch,v.pitch)||w.push({command:Wi.setPitch,args:[v.pitch]}),o.by(_.sprite,v.sprite)||w.push({command:Wi.setSprite,args:[v.sprite]}),o.by(_.glyphs,v.glyphs)||w.push({command:Wi.setGlyphs,args:[v.glyphs]}),o.by(_.imports,v.imports)||(function(z=[],N=[],B){N=N||[];const H=(z=z||[]).map(tu),q=N.map(tu),Y=z.reduce(iu,{}),te=N.reduce(iu,{}),J=H.slice();let _e,he,pe,ce;for(_e=0,he=0;_e<H.length;_e++)pe=H[_e],te.hasOwnProperty(pe)?he++:(B.push({command:Wi.removeImport,args:[pe]}),J.splice(J.indexOf(pe,he),1));for(_e=0,he=0;_e<q.length;_e++)pe=q[q.length-1-_e],J[J.length-1-_e]!==pe&&(Y.hasOwnProperty(pe)?(B.push({command:Wi.removeImport,args:[pe]}),J.splice(J.lastIndexOf(pe,J.length-he),1)):he++,ce=J[J.length-_e],B.push({command:Wi.addImport,args:[te[pe],ce]}),J.splice(J.length-_e,0,pe));for(const se of N){const ye=Y[se.id];ye&&(delete ye.data,o.by(ye,se)||B.push({command:Wi.updateImport,args:[se.id,se]}))}})(_.imports,v.imports,w),o.by(_.transition,v.transition)||w.push({command:Wi.setTransition,args:[v.transition]}),o.by(_.light,v.light)||w.push({command:Wi.setLight,args:[v.light]}),o.by(_.fog,v.fog)||w.push({command:Wi.setFog,args:[v.fog]}),o.by(_.snow,v.snow)||w.push({command:Wi.setSnow,args:[v.snow]}),o.by(_.rain,v.rain)||w.push({command:Wi.setRain,args:[v.rain]}),o.by(_.projection,v.projection)||w.push({command:Wi.setProjection,args:[v.projection]}),o.by(_.lights,v.lights)||w.push({command:Wi.setLights,args:[v.lights]}),o.by(_.camera,v.camera)||w.push({command:Wi.setCamera,args:[v.camera]}),o.by(_.iconsets,v.iconsets)||(function(z,N,B){let H;for(H in N=N||{},z=z||{})z.hasOwnProperty(H)&&(N.hasOwnProperty(H)||B.push({command:Wi.removeIconset,args:[H]}));for(H in N){if(!N.hasOwnProperty(H))continue;const q=N[H];z.hasOwnProperty(H)?o.by(z[H],q)||(B.push({command:Wi.removeIconset,args:[H]}),B.push({command:Wi.addIconset,args:[H,q]})):B.push({command:Wi.addIconset,args:[H,q]})}})(_.iconsets,v.iconsets,w),!o.by(_["color-theme"],v["color-theme"]))return[{command:Wi.setStyle,args:[v]}];const I={},C=[];(function(z,N,B,H){let q;for(q in N=N||{},z=z||{})z.hasOwnProperty(q)&&(N.hasOwnProperty(q)||rf(q,B,H));for(q in N){if(!N.hasOwnProperty(q))continue;const Y=N[q];z.hasOwnProperty(q)?o.by(z[q],Y)||(z[q].type==="geojson"&&Y.type==="geojson"&&Em(z,N,q)?B.push({command:Wi.setGeoJSONSourceData,args:[q,Y.data]}):Tm(q,N,B,H)):lh(q,N,B)}})(_.sources,v.sources,C,I);const O=[];_.layers&&_.layers.forEach((z=>{z.source&&I[z.source]?w.push({command:Wi.removeLayer,args:[z.id]}):O.push(z)}));let D=_.terrain;D&&I[D.source]&&(w.push({command:Wi.setTerrain,args:[void 0]}),D=void 0),w=w.concat(C),o.by(D,v.terrain)||w.push({command:Wi.setTerrain,args:[v.terrain]}),(function(z,N,B){N=N||[];const H=(z=z||[]).map(tu),q=N.map(tu),Y=z.reduce(iu,{}),te=N.reduce(iu,{}),J=H.slice(),_e=Object.create(null);let he,pe,ce,se,ye,Ce,Se;for(he=0,pe=0;he<H.length;he++)ce=H[he],te.hasOwnProperty(ce)?pe++:(B.push({command:Wi.removeLayer,args:[ce]}),J.splice(J.indexOf(ce,pe),1));for(he=0,pe=0;he<q.length;he++)ce=q[q.length-1-he],J[J.length-1-he]!==ce&&(Y.hasOwnProperty(ce)?(B.push({command:Wi.removeLayer,args:[ce]}),J.splice(J.lastIndexOf(ce,J.length-pe),1)):pe++,Ce=J[J.length-he],B.push({command:Wi.addLayer,args:[te[ce],Ce]}),J.splice(J.length-he,0,ce),_e[ce]=!0);for(he=0;he<q.length;he++)if(ce=q[he],se=Y[ce],ye=te[ce],!_e[ce]&&!o.by(se,ye))if(o.by(se.source,ye.source)&&o.by(se["source-layer"],ye["source-layer"])&&o.by(se.type,ye.type)){for(Se in Ha(se.layout,ye.layout,B,ce,null,Wi.setLayoutProperty),Ha(se.paint,ye.paint,B,ce,null,Wi.setPaintProperty),o.by(se.slot,ye.slot)||B.push({command:Wi.setSlot,args:[ce,ye.slot]}),o.by(se.filter,ye.filter)||B.push({command:Wi.setFilter,args:[ce,ye.filter]}),o.by(se.minzoom,ye.minzoom)&&o.by(se.maxzoom,ye.maxzoom)||B.push({command:Wi.setLayerZoomRange,args:[ce,ye.minzoom,ye.maxzoom]}),se)se.hasOwnProperty(Se)&&Se!=="layout"&&Se!=="paint"&&Se!=="filter"&&Se!=="metadata"&&Se!=="minzoom"&&Se!=="maxzoom"&&Se!=="slot"&&(Se.indexOf("paint.")===0?Ha(se[Se],ye[Se],B,ce,Se.slice(6),Wi.setPaintProperty):o.by(se[Se],ye[Se])||B.push({command:Wi.setLayerProperty,args:[ce,Se,ye[Se]]}));for(Se in ye)ye.hasOwnProperty(Se)&&!se.hasOwnProperty(Se)&&Se!=="layout"&&Se!=="paint"&&Se!=="filter"&&Se!=="metadata"&&Se!=="minzoom"&&Se!=="maxzoom"&&Se!=="slot"&&(Se.indexOf("paint.")===0?Ha(se[Se],ye[Se],B,ce,Se.slice(6),Wi.setPaintProperty):o.by(se[Se],ye[Se])||B.push({command:Wi.setLayerProperty,args:[ce,Se,ye[Se]]}))}else B.push({command:Wi.removeLayer,args:[ce]}),Ce=J[J.lastIndexOf(ce)+1],B.push({command:Wi.addLayer,args:[ye,Ce]})})(O,v.layers,w)}catch(I){console.warn("Unable to compute style diff:",I),w=[{command:Wi.setStyle,args:[v]}]}return w})(this.serialize(),t).filter((_=>!(_.command in Lm)));if(c.length===0)return!1;const d=c.filter((_=>!(_.command in Pm)));if(d.length>0)throw new Error(`Unimplemented: ${d.map((_=>_.command)).join(", ")}.`);const p=[];return c.forEach((_=>{p.push(this[_.command](..._.args))})),n&&Promise.all(p).then(n).catch(n),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(const[n,c]of t.entries()){if(this.getImage(n))return this.fire(new o.y(new Error(`An image with the name "${n.name}" already exists.`)));this.imageManager.addImage(n,this.scope,c),this._changes.updateImage(n,this.scope)}return this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this}addImage(t,n){return this.getImage(t)?this.fire(new o.y(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,n),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this)}updateImage(t,n,c=!1){this.imageManager.updateImage(t,this.scope,n),c&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this):this.fire(new o.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}getActualScope(){return this._importedAsBasemap?"basemap":this.scope}addModelURLs(t){return this.modelManager.addModelURLs(t,this.getActualScope()),this._updateWorkerModels(),this.fire(new o.z("data",{dataType:"style"})),this}addModel(t,n,c={}){return this._checkLoaded(),this._validate(j,`models.${t}`,n,null,c)||(this.modelManager.addModel(t,n,this.getActualScope()),this.fire(new o.z("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.getActualScope())}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.getActualScope(),!1,!0),this.fire(new o.z("data",{dataType:"style"})),this):this.fire(new o.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.getActualScope())}addSource(t,n,c={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!n.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(n).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(th,`sources.${t}`,n,null,c))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const d=Dn(t,n,this.dispatcher,this);d.scope=this.scope,d.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(d.id),source:d.serialize(),sourceId:d.id})));const p=_=>{const v=(_?"symbol:":"other:")+d.id,w=o.B(v,this.scope),I=this._sourceCaches[v]=new Po(w,d,_);(_?this._symbolSourceCaches:this._otherSourceCaches)[d.id]=I,I.onAdd(this.map)};p(!1),n.type!=="vector"&&n.type!=="geojson"||p(!0),d.onAdd&&d.onAdd(this.map),c.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const n=this.getOwnSource(t);if(!n)throw new Error("There is no source with this ID");for(const d in this._layers)if(this._layers[d].source===t)return this.fire(new o.y(new Error(`Source "${t}" cannot be removed while layer "${d}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new o.y(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const d=Object.entries(this.stylesheet.iconsets).find((([p,_])=>_.type==="source"&&_.source===t));if(d)return this.fire(new o.y(new Error(`Source "${t}" cannot be removed while iconset "${d[0]}" is using it.`)))}const c=this.getOwnSourceCaches(t);for(const d of c){const p=o.dq(d.id);delete this._sourceCaches[p],this._changes.discardSourceCacheUpdate(d.id),d.fire(new o.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:d.getSource().id})),d.setEventedParent(null),d.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),n.setEventedParent(null),n.onRemove&&n.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,n){this._checkLoaded(),this.getOwnSource(t).setData(n),this._changes.setDirty()}getOwnSource(t){const n=this.getOwnSourceCache(t);return n&&n.getSource()}getOwnSources(){const t=[];for(const n in this._otherSourceCaches){const c=this.getOwnSourceCache(n);c&&t.push(c.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const n in t){const c=t[n]._tiles;for(const d in c){const p=c[d];if(p.state!=="loaded"&&p.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const n=this._getTransitionParameters();for(const p of t){if(this._validate(ha,"lights",p))return;switch(p.type){case"ambient":if(this.ambientLight){const _=this.ambientLight;_.set(p),_.updateTransitions(n)}else this.ambientLight=new $i(p,fn||(fn=new o.a9({color:new o.aa(o.a6.properties_light_ambient.color),"color-use-theme":new o.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.aa(o.a6.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const _=this.directionalLight;_.set(p),_.updateTransitions(n)}else this.directionalLight=new $i(p,nn||(nn=new o.a9({direction:new o.ap(o.a6.properties_light_directional.direction),color:new o.aa(o.a6.properties_light_directional.color),"color-use-theme":new o.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.aa(o.a6.properties_light_directional.intensity),"cast-shadows":new o.aa(o.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new o.aa(o.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new o.aa(o.a6.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const c=Object.assign(n,{worldview:this.map.getWorldview()}),d=new o.ac(this.z||0,c);this.ambientLight&&this.ambientLight.recalculate(d),this.directionalLight&&this.directionalLight.recalculate(d),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,n=this.ambientLight;if(!t||!n)return;const c=D=>.2126*(D[0]<=.03928?D[0]/12.92:Math.pow((D[0]+.055)/1.055,2.4))+.7152*(D[1]<=.03928?D[1]/12.92:Math.pow((D[1]+.055)/1.055,2.4))+.0722*(D[2]<=.03928?D[2]/12.92:Math.pow((D[2]+.055)/1.055,2.4)),d=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),p=t.properties.get("intensity"),_=t.properties.get("direction"),v=1-o.d4(_.x,_.y,_.z)[2]/90,w=c(d)*p*v,I=n.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),C=n.properties.get("intensity"),O=c(I)*C;return Number(((w+O)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(o.dr(t)){const n=o.ds(t),c=this.fragments.find((({id:p})=>p===n));if(!c)return;const d=o.dq(t);return c.style.getFragmentStyle(d)}{const n=this.fragments.find((({id:c})=>c===t));return n?n.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const n={},c=(d,p="")=>`${d}::${p}`;this._featuresetSelectors={};for(const d in t){const p=this._featuresetSelectors[d]=[];for(const _ of t[d].selectors){if(_.featureNamespace){const w=this.getOwnLayer(_.layer);if(!w){o.w(`Layer is undefined for selector: ${_.layer}`);continue}const I=c(w.source,w.sourceLayer);if(I in n&&n[I]!==_.featureNamespace){o.w(`"featureNamespace ${_.featureNamespace} of featureset ${d}'s selector is not associated to the same source, skip this selector`);continue}n[I]=_.featureNamespace}let v;if(_.properties)for(const w in _.properties){const I=o.U(_.properties[w]);I.result==="success"&&(v=v||{},v[w]=I.value)}p.push({layerId:_.layer,namespace:_.featureNamespace,properties:v,uniqueFeatureID:_._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const n=this.getFragmentStyle(t);if(!n||!n.stylesheet.featuresets)return[];const c=[];for(const d in n.stylesheet.featuresets)c.push({featuresetId:d,importId:n.scope?n.scope:void 0});return c}getFeaturesetLayers(t,n){const c=this.getFragmentStyle(n),d=c.stylesheet.featuresets;if(!d||!d[t])return this.fire(new o.y(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const p=[];for(const _ of d[t].selectors){const v=c.getOwnLayer(_.layer);v&&p.push(v)}return p}getConfigProperty(t,n){const c=this.getFragmentStyle(t);if(!c)return null;const d=o.B(n,c.scope),p=c.options.get(d),_=p?p.value||p.default:null;return _?_.serialize():null}isIndoorEnabled(){return Object.keys(this._mergedIndoor).length>0}getIndoorSourceLayers(t,n){const c=o.B(t,n);return this._mergedIndoor[c]}setIndoorData(t,n){this.map.indoor.setIndoorData(n)}updateIndoorDependentLayers(){this._updateLayers(this._indoorDependentLayers),this.map._styleDirty=!0,this.map.triggerRepaint()}setConfigProperty(t,n,c){const d=this.getFragmentStyle(t);if(!d)return;const p=d.stylesheet.schema;if(!p||!p[n])return;const _=o.U(c);if(_.result!=="success")return void Ya(this,_.value);const v=_.value.expression,w=o.B(n,d.scope),I=d.options.get(w);if(!I)return;let C;const{minValue:O,maxValue:D,stepValue:z,type:N,values:B}=p[n],H=o.U(p[n].default);H.result==="success"&&(C=H.value.expression),C?(this.options.set(w,Object.assign({},I,{value:v,default:C,minValue:O,maxValue:D,stepValue:z,type:N,values:B})),this.updateConfigDependencies(n)):this.fire(new o.y(new Error(`No schema defined for the config option "${n}" in the "${t}" fragment.`)))}getConfig(t){const n=this.getFragmentStyle(t);if(!n)return null;const c=n.stylesheet.schema;if(!c)return null;const d={};for(const p in c){const _=o.B(p,n.scope),v=n.options.get(_),w=v?v.value||v.default:null;d[p]=w?w.serialize():null}return d}setConfig(t,n){const c=this.getFragmentStyle(t);c&&(c.updateConfig(n,c.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const n=this.getFragmentStyle(t);return n?n.stylesheet.schema:null}setSchema(t,n){const c=this.getFragmentStyle(t);c&&(c.stylesheet.schema=n,c.updateConfig(c._config,n),this.updateConfigDependencies())}updateConfig(t,n){if(this._config=t,t||n)if(n)for(const c in n){let d,p;const _=o.U(n[c].default);if(_.result==="success"&&(d=_.value.expression),t&&t[c]!==void 0){const D=o.U(t[c]);D.result==="success"&&(p=D.value.expression)}const{minValue:v,maxValue:w,stepValue:I,type:C,values:O}=n[c];if(d){const D=o.B(c,this.scope);this.options.set(D,{default:d,value:p,minValue:v,maxValue:w,stepValue:I,type:C,values:O})}else this.fire(new o.y(new Error(`No schema defined for config option "${c}".`)))}else this.fire(new o.y(new Error("Attempting to set config for a style without schema.")))}_updateLayers(t,n=(()=>!0)){for(const c of t){const d=this.getLayer(c);d&&n(d)&&(d.possiblyEvaluateVisibility(),this._updateLayer(d),this._changes.setDirty())}}updateConfigDependencies(t){this._updateLayers(this._configDependentLayers,(n=>!t||n.expressionDependencies.configDependencies.has(t))),this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle((n=>{const c=n._styleColorTheme.colorThemeOverride?n._styleColorTheme.colorThemeOverride:n._styleColorTheme.colorTheme;if(c){const d=n._evaluateColorThemeData(c);(!n._styleColorTheme.lut&&d!==""||n._styleColorTheme.lut&&d!==n._styleColorTheme.lut.data)&&n.setColorTheme(c)}})),this._changes.setDirty()}addLayer(t,n,c={}){this._checkLoaded();const d=t.id;if(this._layers[d])return void this.fire(new o.y(new Error(`Layer with id "${d}" already exists on this map`)));let p;if(t.type==="custom"){if(Ya(this,o.dt(t)))return;p=o.du(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(d,t.source),t=o.dp(t),t=Object.assign(t,{source:d})),this._validate(tf,`layers.${d}`,t,{arrayIndex:-1},c))return;p=o.du(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(p),p.setEventedParent(this,{layer:{id:d}})}const _=o.B(p.source,p.scope);p.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(_),p.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(_);let v=this._order.length;if(n){const O=this._order.indexOf(n);if(O===-1)return void this.fire(new o.y(new Error(`Layer with id "${n}" does not exist on this map.`)));p.slot===this._layers[n].slot?v=O:o.w(`Layer with id "${n}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(v,0,d),this._layerOrderChanged=!0,this._layers[d]=p;const w=this.getOwnLayerSourceCache(p),I=!!this.directionalLight&&this.directionalLight.shadowsEnabled();w&&p.canCastShadows()&&I&&(w.castsShadows=!0);const C=this._changes.getRemovedLayer(p);if(C&&p.source&&w&&p.type!=="custom"){this._changes.discardLayerRemoval(p);const O=o.B(p.source,p.scope);C.type!==p.type?this._changes.updateSourceCache(O,"clear"):(this._changes.updateSourceCache(O,"reload"),w.pause())}this._updateLayer(p),p.onAdd&&p.onAdd(this.map),p.scope=this.scope,this.mergeLayers()}moveLayer(t,n){this._checkLoaded();const c=this._checkLayer(t);if(!c||t===n)return;const d=this._order.indexOf(t);this._order.splice(d,1);let p=this._order.length;if(n){const _=this._order.indexOf(n);if(_===-1)return void this.fire(new o.y(new Error(`Layer with id "${n}" does not exist on this map.`)));c.slot===this._layers[n].slot?p=_:o.w(`Layer with id "${n}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(p,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const n=this._checkLayer(t);if(!n)return;n.setEventedParent(null);const c=this._order.indexOf(t);this._order.splice(c,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(n.fqid),this._indoorDependentLayers.delete(n.fqid),this._changes.removeLayer(n);const d=this.getOwnLayerSourceCache(n);if(d&&d.castsShadows){let p=!1;for(const _ in this._layers)if(this._layers[_].source===n.source&&this._layers[_].canCastShadows()){p=!0;break}d.castsShadows=p}n.onRemove&&n.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const n in this._layers)if(this._layers[n].type===t)return!0;return!1}setLayerZoomRange(t,n,c){this._checkLoaded();const d=this._checkLayer(t);d&&(d.minzoom===n&&d.maxzoom===c||(n!=null&&(d.minzoom=n),c!=null&&(d.maxzoom=c),this._updateLayer(d)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,n){this._checkLoaded();const c=this._checkLayer(t);c&&c.slot!==n&&(c.slot=n,this._updateLayer(c))}setFilter(t,n,c={}){this._checkLoaded();const d=this._checkLayer(t);if(d&&!o.by(d.filter,n))return n==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(Sl,`layers.${d.id}.filter`,n,{layerType:d.type},c)||(d.filter=o.dp(n),this._updateLayer(d)))}getFilter(t){const n=this._checkLayer(t);if(n)return o.dp(n.filter)}setLayoutProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);if(p&&!o.by(p.getLayoutProperty(n),c)){if(c!=null&&(!d||d.validate!==!1)&&Ya(p,De.call(vs,{key:`layers.${t}.layout.${n}`,layerType:p.type,objectKey:n,value:c,styleSpec:o.a6,style:{glyphs:!0,sprite:!0}})))return;p.setLayoutProperty(n,c),p.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),p.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(p.fqid),this._updateLayer(p)}}setLayerProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);p&&(n==="appearances"?(p.setAppearances(c),this._changes.setDirty()):p.isPaintProperty(n)?this.setPaintProperty(t,n,c,d):this.setLayoutProperty(t,n,c,d))}getLayoutProperty(t,n){const c=this._checkLayer(t);if(c)return c.getLayoutProperty(n)}setPaintProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);if(!p||o.by(p.getPaintProperty(n),c)||c!=null&&(!d||d.validate!==!1)&&Ya(p,Jc.call(vs,{key:`layers.${t}.paint.${n}`,layerType:p.type,objectKey:n,value:c,styleSpec:o.a6})))return;const _=p.setPaintProperty(n,c);p.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),p.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(p.fqid),_&&this._updateLayer(p),this._changes.updatePaintProperties(p)}getPaintProperty(t,n){const c=this._checkLayer(t);if(c)return c.getPaintProperty(n)}setFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:w,importId:I}=t.target,C=this.getFragmentStyle(I),O=C.getFeaturesetLayers(w);for(const{source:D,sourceLayer:z}of O)C.setFeatureState({id:t.id,source:D,sourceLayer:z},n)}else if("layerId"in t.target){const{layerId:w}=t.target,I=this.getLayer(w);this.setFeatureState({id:t.id,source:I.source,sourceLayer:I.sourceLayer},n)}return}const c=t.source,d=t.sourceLayer,p=this._checkSource(c);if(!p)return;const _=p.type;if(_==="geojson"&&d)return void this.fire(new o.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(_==="vector"&&!d)return void this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new o.y(new Error("The feature id parameter must be provided.")));const v=this.getOwnSourceCaches(c);for(const w of v)w.setFeatureState(d,t.id,n)}removeFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:w,importId:I}=t.target,C=this.getFragmentStyle(I),O=C.getFeaturesetLayers(w);for(const{source:D,sourceLayer:z}of O)C.removeFeatureState({id:t.id,source:D,sourceLayer:z},n)}else if("layerId"in t.target){const{layerId:w}=t.target,I=this.getLayer(w);this.removeFeatureState({id:t.id,source:I.source,sourceLayer:I.sourceLayer},n)}return}const c=t.source,d=this._checkSource(c);if(!d)return;const p=d.type,_=p==="vector"?t.sourceLayer:void 0;if(p==="vector"&&!_)return void this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(n&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new o.y(new Error("A feature id is required to remove its specific state property.")));const v=this.getOwnSourceCaches(c);for(const w of v)w.removeFeatureState(_,t.id,n)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let p;if("featuresetId"in t.target){const{featuresetId:_,importId:v}=t.target,w=this.getFragmentStyle(v),I=w.getFeaturesetLayers(_);for(const{source:C,sourceLayer:O}of I){const D=w.getFeatureState({id:t.id,source:C,sourceLayer:O});if(D&&!p)p=D;else if(!o.by(p,D))return void this.fire(new o.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:_}=t.target,v=this.getLayer(_);p=this.getFeatureState({id:t.id,source:v.source,sourceLayer:v.sourceLayer})}return p}const n=t.source,c=t.sourceLayer,d=this._checkSource(n);if(d){if(d.type!=="vector"||c)return t.id===void 0&&this.fire(new o.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(n)[0].getFeatureState(c,t.id);this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),n=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return o.dv({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:n,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(c=>c!==void 0))}_updateFilteredLayers(t){for(const n of Object.values(this._mergedLayers))t(n)&&this._updateLayer(n)}_updateLayer(t){this._changes.updateLayer(t);const n=this.getLayerSourceCache(t),c=o.B(t.source,t.scope),d=this._changes.getUpdatedSourceCaches();t.source&&!d[c]&&n&&n.getSource().type!=="raster"&&(this._changes.updateSourceCache(c,"reload"),n.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const n=v=>this._mergedLayers[v].is3D(!!this.terrain),c=this.order,d={},p=[];for(let v=c.length-1;v>=0;v--){const w=c[v];if(n(w)){d[w]=v;for(const I of t){const C=I[w];if(C)for(const O of C)p.push(O)}}}p.sort(((v,w)=>w.intersectionZ-v.intersectionZ));const _=[];for(let v=c.length-1;v>=0;v--){const w=c[v];if(n(w))for(let I=p.length-1;I>=0;I--){const C=p[I].feature;if(C.layer&&d[C.layer.id]<v)break;_.push(C),p.pop()}else for(const I of t){const C=I[w];if(C)for(const O of C)_.push(O.feature)}}return _}queryRasterValue(t,n,c){const d=this.getOwnSource(t);return d?d.type!=="raster-array"?(this.fire(new o.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):d.queryRasterArrayValue(n,c):(this.fire(new o.y(new Error(`Source with id "${t}" does not exist in the style.`))),Promise.resolve(null))}queryRenderedFeatures(t,n,c){let d;n&&!Array.isArray(n)&&n.filter&&(this._validate(Sl,"queryRenderedFeatures.filter",n.filter,null,n),d=o.b6(n.filter));const p={},_=C=>{if(vh.has(C.type))return;const O=this.getOwnLayerSourceCache(C),D=p[O.id]=p[O.id]||{sourceCache:O,layers:{},has3DLayers:!1};C.is3D(!!this.terrain)&&(D.has3DLayers=!0),D.layers[C.fqid]=D.layers[C.fqid]||{styleLayer:C,targets:[]},D.layers[C.fqid].targets.push({filter:d})};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new o.y(new Error("parameters.layers must be an Array."))),[];for(const C of n.layers){const O=this._layers[C];if(!O)return this.fire(new o.y(new Error(`The layer '${C}' does not exist in the map's style and cannot be queried for features.`))),[];_(O)}}else for(const C in this._layers)_(this._layers[C]);const v=this._queryRenderedFeatures(t,p,c),w=this._flattenAndSortRenderedFeatures(v),I=[];for(const C of w)o.dw(C.layer.id)===this.scope&&I.push(C);return I}queryRenderedFeatureset(t,n,c){let d;n&&!Array.isArray(n)&&n.filter&&(this._validate(Sl,"queryRenderedFeatures.filter",n.filter,null,n),d=o.b6(n.filter));const p="mock",_=[];if(n&&n.target)_.push(Object.assign({},n,{targetId:p,filter:d}));else{const C=this.getFeaturesetDescriptors();for(const O of C)_.push({targetId:p,filter:d,target:O});for(const{style:O}of this.fragments){const D=O.getFeaturesetDescriptors();for(const z of D)_.push({targetId:p,filter:d,target:z})}}const v=this.queryRenderedTargets(t,_,c),w=[],I=new Set;for(const C of v)for(const O of C.variants[p])rc(O,C,I)||w.push(new o.dx(C,O));return w}queryRenderedTargets(t,n,c){const d={},p=(v,w,I,C)=>{const O=d[w.id]=d[w.id]||{sourceCache:w,layers:{},has3DLayers:!1};if(O.layers[v.fqid]=O.layers[v.fqid]||{styleLayer:v,targets:[]},v.is3D(!!this.terrain)&&(O.has3DLayers=!0),!C)return I.uniqueFeatureID=!1,void O.layers[v.fqid].targets.push(I);O.layers[v.fqid].targets.push(Object.assign({},I,{namespace:C.namespace,properties:C.properties,uniqueFeatureID:C.uniqueFeatureID}))};for(const v of n)if("featuresetId"in v.target){const{featuresetId:w,importId:I}=v.target,C=this.getFragmentStyle(I);if(!C||!C._featuresetSelectors)continue;const O=C._featuresetSelectors[w];if(!O){this.fire(new o.y(new Error(`The featureset '${w}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const D of O){const z=C.getOwnLayer(D.layerId);z&&!vh.has(z.type)&&p(z,C.getOwnLayerSourceCache(z),v,D)}}else if("layerId"in v.target){const{layerId:w}=v.target,I=this.getLayer(w);if(!I||vh.has(I.type))continue;p(I,this.getLayerSourceCache(I),v)}const _=this._queryRenderedFeatures(t,d,c);return this._flattenAndSortRenderedFeatures(_)}_queryRenderedFeatures(t,n,c){const d=[],p=!!this.map._showQueryGeometry,_=Zr.createFromScreenPoints(t,c);for(const v in n){const w=ih(_,n[v],this._availableImages,c,p);Object.keys(w).length&&d.push(w)}if(this.placement)for(const v in n){if(!n[v].sourceCache._onlySymbols)continue;const w=rh(_.screenGeometry,n[v],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(w).length&&d.push(w)}return d}querySourceFeatures(t,n){const c=n&&n.filter;c&&this._validate(Sl,"querySourceFeatures.filter",c,null,n);let d=[];const p=this.getOwnSourceCaches(t);for(const _ of p)d=d.concat(nh(_,n));return d}addSourceType(t,n,c){return as.getSourceType(t)?c(new Error(`A source type called "${t}" already exists.`)):(as.setSourceType(t,n),n.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:n.workerSourceURL},c):c(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,n,c={}){this._checkLoaded();const d=this.light.getLight();let p=!1;for(const v in t)if(!o.by(t[v],d[v])){p=!0;break}if(!p)return;const _=this._getTransitionParameters();this.light.setLight(t,n,c),this.light.updateTransitions(_)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=o.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&o.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,n=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),n===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let c=t;const d=!("source"in t)||t.source==null;if(n===1){if(this.disableElevatedTerrain)return;if("source"in c&&typeof c.source=="object"){const v="terrain-dem-src";this.addSource(v,c.source),c=o.dp(c),c=Object.assign(c,{source:v})}const p=Object.assign({},c),_={};if(this.terrain&&d){p.source=this.terrain.get().source;const v=this.terrain?this.getFragmentStyle(this.terrain.scope):null;v&&(_.style=v.serialize())}if(this._validate(ef,"terrain",p,_))return}if(!this.terrain||this.terrain.scope!==this.scope&&!d||this.terrain&&n!==this.terrain.drapeRenderMode){if(!c)return;this._createTerrain(c,n),this.fire(new o.z("data",{dataType:"style"}))}else{const p=this.terrain,_=p.get();for(const v of Object.keys(o.a6.terrain))!c.hasOwnProperty(v)&&o.a6.terrain[v].default&&(c[v]=o.a6.terrain[v].default);for(const v in t)if(!o.by(t[v],_[v])){p.set(t,this.options),this.stylesheet.terrain=t;const w=this._getTransitionParameters({duration:0});p.updateTransitions(w),this.fire(new o.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const n=this.fog=new fi(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createSnow(t){const n=this.snow=new gn(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createRain(t){const n=this.rain=new Hr(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask((()=>{for(const t of this.map._markers)t._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const n=this.fog;if(!o.by(n.get(),t)){n.set(t,this.options),this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const n=this.snow;if(!o.by(n.get(),t)){n.set(t,this.options),this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const n=this.rain;if(!o.by(n.get(),t)){n.set(t,this.options),this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const d in this._layers)this._layers[d].lut=this._styleColorTheme.lut;for(const d in this._sourceCaches)this._sourceCaches[d].clearTiles()},n=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!n)return this._styleColorTheme.lut=null,void t();const c=this._evaluateColorThemeData(n);this._loadColorTheme(c).then((()=>{this.fire(new o.z("colorthemeset")),t()})).catch((d=>{o.w(`Couldn't set color theme: ${d}`)}))}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&o.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,n){const c=this.getFragmentStyle(t);c&&(c._styleColorTheme.colorThemeOverride=n,c._reloadColorTheme())}_getTransitionParameters(t){return{now:o.o.now(),transition:Object.assign(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],n=[];for(const c of this._mergedOrder)this.isLayerDraped(this._mergedLayers[c])?t.push(c):n.push(c);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...n)}_createTerrain(t,n){const c=this.terrain=new Pe(t,n,this.scope,this.options,this.map.getWorldview());n===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const d=this._getTransitionParameters({duration:0});c.updateTransitions(d)}_force3DLayerUpdate(){for(const t in this._layers){const n=this._layers[t];n.type==="fill-extrusion"&&this._updateLayer(n)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const n=this._layers[t];n.type==="symbol"&&this._updateLayer(n)}}_validate(t,n,c,d,p={}){if(p&&p.validate===!1)return!1;const _=Object.assign({},this.serialize());return Ya(this,t.call(vs,Object.assign({key:n,style:_,value:c,styleSpec:o.a6},d)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),o.dy.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){const n=this.getSourceCaches(t);for(const c of n)c.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(const t in this._mergedLayers){const n=this._mergedLayers[t];n._clear&&n._clear()}}reloadSource(t){const n=this.getSourceCaches(t);for(const c of n)c.resume(),c.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle((t=>{t.modelManager.reloadModels(t.scope)}))}updateSources(t){let n;this.directionalLight&&(n=hu(this.directionalLight));const c=new Set,d=new Set;for(const p in this._mergedLayers){const _=this._mergedLayers[p];_.type==="building"&&c.add(_.source),_.hasElevation()&&!d.has(_.source)&&d.add(_.source)}for(const p in this._mergedSourceCaches){const _=this._mergedSourceCaches[p],v=d.has(_._source.id);c.has(_._source.id)&&(_._source.reparseOverscaled=!1),_.update(t,void 0,void 0,n,v)}}_generateCollisionBoxes(){for(const t in this._sourceCaches){const n=this._sourceCaches[t];n.resume(),n.reload()}}_updatePlacement(t,n,c,d,p,_,v=!1){let w=!1,I=!1;const C={},O={};for(const B of this._mergedOrder){const H=this._mergedLayers[B];if(H.type!=="symbol")continue;const q=o.B(H.source,H.scope);let Y=C[q];if(!Y){const J=this.getLayerSourceCache(H);if(!J)continue;const _e=J.getRenderableIds(!0).map((he=>J.getTileByID(he)));O[q]=_e.slice(),Y=C[q]=_e.sort(((he,pe)=>pe.tileID.overscaledZ-he.tileID.overscaledZ||(he.tileID.isLessThan(pe.tileID)?-1:1)))}const te=this.crossTileSymbolIndex.addLayer(H,Y,n.center.lng,n.projection);w=w||te}this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),v=v||this._layerOrderChanged,this._layerOrderChanged&&this.fire(new o.z("neworder"));const D=!!(this.placement&&!n.equals(this.placement.transform)),z=!!(this.placement&&(this.placement.lastReplacementSourceUpdateTime!==0&&!_||this.placement.lastReplacementSourceUpdateTime!==_.updateTime)),N=(D||z||w||this.placement&&this.placement.isStale())&&d===0;if((v||!this.pauseablePlacement||N||d!==0&&this.pauseablePlacement.isDone()&&!this.placement.stillRecent(o.o.now(),n.zoom))&&(this.pauseablePlacement=new On(n,this._mergedOrder,v||d===0,c,d,p,this.placement,this.fog&&n.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,C,O,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(o.o.now()),I=!0),w&&this.pauseablePlacement.placement.setStale()),I||w){this._buildingIndex.onNewFrame(n.zoom);for(let B=0;B<this._mergedOrder.length;B++){const H=this._mergedLayers[this._mergedOrder[B]];if(H.type!=="symbol"||H.visibility==="none")continue;const q=this.isLayerClipped(H);this.placement.updateLayerOpacities(H,C[o.B(H.source,H.scope)],B,q?_:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(o.o.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,n){this._checkLoaded();const c=this.stylesheet.imports=this.stylesheet.imports||[];if(c.findIndex((({id:p})=>p===t.id))!==-1)return void this.fire(new o.y(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!n)return c.push(t),this._loadImports([t],!0);const d=c.findIndex((({id:p})=>p===n));return d===-1&&this.fire(new o.y(new Error(`Import with id "${n}" does not exist on this map.`))),this.stylesheet.imports=c.slice(0,d).concat(t).concat(c.slice(d)),this._loadImports([t],!0,n)}updateImport(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);return d===-1?this:typeof n=="string"?(this.setImportUrl(t,n),this):(n.url&&n.url!==c[d].url&&this.setImportUrl(t,n.url),o.by(n.config,c[d].config)||this.setImportConfig(t,n.config,n.data.schema),o.by(n.data,c[d].data)||this.setImportData(t,n.data),this)}moveImport(t,n){this._checkLoaded();let c=this.stylesheet.imports||[];const d=this.getImportIndex(t);if(d===-1)return this;const p=this.getImportIndex(n);if(p===-1)return this;const _=c[d],v=this.fragments[d];return c=c.filter((({id:w})=>w!==t)),this.fragments=this.fragments.filter((({id:w})=>w!==t)),this.stylesheet.imports=c.slice(0,p).concat(_).concat(c.slice(p)),this.fragments=this.fragments.slice(0,p).concat(v).concat(this.fragments.slice(p)),this.mergeLayers(),this}setImportUrl(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);if(d===-1)return this;c[d].url=n;const p=this.fragments[d];return p.style=this._createFragmentStyle(c[d]),p.style.on("style.import.load",(()=>this.mergeAll())),p.style.loadURL(n),this}setImportData(t,n){this._checkLoaded();const c=this.getImportIndex(t),d=this.stylesheet.imports||[];return c===-1?this:n?(this.fragments[c].style.setState(n),this._reloadImports(),this):(delete d[c].data,this.setImportUrl(t,d[c].url))}setImportConfig(t,n,c){this._checkLoaded();const d=this.getImportIndex(t),p=this.stylesheet.imports||[];if(d===-1)return this;n?p[d].config=n:delete p[d].config;const _=this.fragments[d];c&&_.style.stylesheet&&(_.style.stylesheet.schema=c);const v=_.style.stylesheet&&_.style.stylesheet.schema;return _.config=n,_.style.updateConfig(n,v),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const n=this.stylesheet.imports||[],c=this.getImportIndex(t);c!==-1&&(n.splice(c,1),this.fragments[c].style._remove(),this.fragments.splice(c,1),this._reloadImports())}getImportIndex(t){const n=(this.stylesheet.imports||[]).findIndex((c=>c.id===t));return n===-1&&this.fire(new o.y(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),n}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const n in this._mergedOtherSourceCaches){const c=this._mergedOtherSourceCaches[n];c&&t.push(c.getSource())}return t}getSource(t,n){const c=this.getSourceCache(t,n);return c&&c.getSource()}getLayerSource(t){const n=this.getLayerSourceCache(t);return n&&n.getSource()}getSourceCache(t,n){const c=o.B(t,n);return this._mergedOtherSourceCaches[c]}getLayerSourceCache(t){const n=o.B(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[n]:this._mergedOtherSourceCaches[n]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);const n=[];return this._mergedOtherSourceCaches[t]&&n.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&n.push(this._mergedSymbolSourceCaches[t]),n}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const n in t){const c=t[n];c==="reload"?this.reloadSource(n):c==="clear"&&this.clearSource(n)}}updateLayers(t){const n=this._changes.getUpdatedPaintProperties();for(const c of n){const d=this.getLayer(c);d&&d.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,n,c){this.imageManager.getImages(n.images,n.scope,c),this._updateTilesForChangedImages();const d=_=>{if(_){const v=n.images.map((w=>o.I.toString(w)));_.setDependencies(n.tileID.key,n.type,v)}},p=o.B(n.source,n.scope);d(this._mergedOtherSourceCaches[p]),d(this._mergedSymbolSourceCaches[p]),n.images.some((_=>_.iconsetId))&&this.fire(new o.z("data",{dataType:"style"}))}rasterizeImages(t,n,c){this.imageManager.rasterizeImages(n,c)}getGlyphs(t,n,c){this.glyphManager.getGlyphs(n.stacks,c)}getResource(t,n,c){return o.dz(n,c)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const n=[];return this._otherSourceCaches[t]&&n.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&n.push(this._symbolSourceCaches[t]),n}_isSourceCacheLoaded(t){const n=this.getOwnSourceCaches(t);return n.length===0?(this.fire(new o.y(new Error(`There is no source with ID '${t}'`))),!1):n.every((c=>c.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,n){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;const c=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),d=t.type==="building";if(t.is3D(!!this.terrain)){if(c||d||n&&n.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((t=>{t.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}as.getSourceType=function(l){return Us[l]},as.setSourceType=function(l,t){Us[l]=t},as.registerForPluginStateChange=o.dA;class Rm extends o.E{constructor(t){super(),this._style=t,this._buildings={},this._activeFloors=new Set,this._activeFloorsVisible=!0,this._indoorState={selectedFloorId:null,lastActiveFloors:null,activeFloorsVisible:!0},o.aY(["_updateUI"],this)}destroy(){this._buildings={},this._activeFloors=new Set,this._indoorState=null}selectFloor(t){t===this._selectedFloorId&&this._activeFloorsVisible||(this._selectedFloorId=t,this._activeFloorsVisible=!0,this._updateActiveFloors())}setActiveFloorsVisibility(t){this._activeFloorsVisible=t,this._updateActiveFloors(),this._updateIndoorSelector()}setIndoorData(t){for(const[n,c]of Object.entries(t.buildings))if(this._buildings[n])for(const d of c.floorIds)this._buildings[n].floors[d]||(this._buildings[n].floors[d]=c.floors[d]);else this._buildings[n]=c;for(const n of t.activeFloors)this._activeFloors.add(n);this._updateIndoorSelector()}getIndoorTileOptions(t,n){const c=this._style.getIndoorSourceLayers(t,n);return c&&this._indoorState?{sourceLayers:c,indoorState:this._indoorState}:null}_updateUI(t,n,c){const d=(function(p,_,v,w){let I=null,C=Number.MAX_SAFE_INTEGER;if(w<16)return null;for(const[O,D]of Object.entries(p)){const z=D.center;if(z){const N=_.distanceTo(o.aT.convert(z));N<C&&v.contains(z)&&(C=N,I=O)}}return I})(this._buildings,n,c,t);d!==this._closestBuildingId&&(this._closestBuildingId=d,this._updateIndoorSelector())}_updateIndoorSelector(){const t=this._buildings,n=this._closestBuildingId,c=n&&t?t[n]:void 0;if(!c)return void this.fire(new o.z("selector-update",{selectedFloorId:null,activeFloorsVisible:this._activeFloorsVisible,floors:[]}));let d=null;for(const _ of c.floorIds)if(this._activeFloors&&this._activeFloors.has(_)){d=_;break}const p=Array.from(c.floorIds).map((_=>({id:_,name:c.floors[_].name,zIndex:c.floors[_].zIndex}))).sort(((_,v)=>v.zIndex-_.zIndex));this.fire(new o.z("selector-update",{selectedFloorId:d,activeFloorsVisible:this._activeFloorsVisible,floors:p}))}_updateActiveFloors(){const t=this._activeFloors;this._activeFloors=new Set,this._indoorState={selectedFloorId:this._selectedFloorId,lastActiveFloors:t,activeFloorsVisible:this._activeFloorsVisible},this._style.updateIndoorDependentLayers()}}var lc=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,cc=`
#ifdef DUAL_SOURCE_BLENDING
layout(location=0,index=0) out vec4 glFragColor;layout(location=0,index=1) out vec4 glFragColorSrc1;
#else
layout(location=0) out vec4 glFragColor;
#endif
#ifdef USE_MRT1
layout(location=1) out vec4 out_Target1;
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,pf=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}
#ifndef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_id) attrib
#define DECLARE_MATERIAL_TABLE_INFO
#endif`,xh="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",jo=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif`,bh=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,gt=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,mf=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,wh=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,Th=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif`,_f=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const fu=/#include\s+"([^"]+)"/g,Ws=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,gf=/\b[A-Za-z_][A-Za-z0-9_]*\b/g,Dl=new Set(["ifdef","ifndef","elif","if","defined"]),Ol=new Set;Qa(lc,Ol),Qa(pf,Ol),Qa(cc,Ol);const Ka={"_prelude_fog.vertex.glsl":bh,"_prelude_terrain.vertex.glsl":jo,"_prelude_shadow.vertex.glsl":Th,"_prelude_material_table.vertex.glsl":`#ifdef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define MATERIAL_TABLE_DEBUG 0
uniform int u_material_offset;uniform int u_vertex_offset;layout(std140,binding=0)readonly buffer material_buffer{uvec4 material_data[];};struct MaterialInfo{uint dataOffset;
#if MATERIAL_TABLE_DEBUG
vec4 colorDebug;
#endif
};uint read_buf_no_offset(uint iDword) {return material_data[iDword/4u][iDword % 4u];}uint read_buf(uint iDword) {iDword+=uint(u_material_offset/4);return read_buf_no_offset(iDword);}float read_buf_float(uint iDword){return uintBitsToFloat(read_buf(iDword));}uint read_buf_uint8(uint iDword,uint iUint8){uint dwordOffset=iDword+(iUint8/4u);uint byteOffset=iUint8 & 3u;uint bitOffset=8u*byteOffset;uint mask=0xffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint read_buf_uint16(uint iDword,uint iUint16){uint dwordOffset=iDword+(iUint16 >> 1u);uint bitOffset=(iUint16 & 1u)*16u;uint mask=0xffffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint nrDwordsForVertexIdEntries(uint nrMaterialLookupEntries) {return nrMaterialLookupEntries;}uint nrDwordsForMaterialIdEntries(uint nrMaterialLookupEntries) {return (nrMaterialLookupEntries*2u+3u)/4u;}uint findRangeBinarySearch(uint vertexId,uint numRanges,uint dwordOffset) {uint left=0u;uint right=numRanges-1u;for (uint i=0u; i < 16u; i++) { 
if (left > right) {break;}uint mid=(left+right)/2u;uint start=read_buf(dwordOffset+mid);uint nextStart=(mid+1u < numRanges) ? read_buf(dwordOffset+mid+1u) : 0xffffffffu;if (vertexId >=start && vertexId < nextStart) {return mid;} else if (vertexId < start) {if (mid==0u) {break;}right=mid-1u;} else {left=mid+1u;}}return 0u; 
}uint readVertexId(uint dwordOffset,uint iMaterialLookupEntry) {return read_buf(dwordOffset+iMaterialLookupEntry);}uint findRange(uint vertexId,uint numRanges,uint dwordOffset) {uint iRange;if(numRanges <=64u){uint vertexBegin;for(iRange=0u; iRange < numRanges;++iRange) {vertexBegin=readVertexId(dwordOffset,iRange);if(vertexBegin > vertexId) {break;}}iRange=iRange==0u? 0u : iRange-1u;} else { 
iRange=findRangeBinarySearch(vertexId,numRanges,dwordOffset);}return iRange;}MaterialInfo read_material_info(uint vertex_id) {MaterialInfo info;
#if MATERIAL_TABLE_DEBUG
const vec4 red=vec4(1.0,0.0,0.0,1.0);const vec4 orange=vec4(1.0,0.5,0.0,1.0);const vec4 yellow=vec4(1.0,1.0,0.0,1.0);const vec4 green=vec4(0.0,1.0,0.0,1.0);const vec4 indigo=vec4(0.294,0.0,0.510,1.0);const vec4 blue=vec4(0.0,0.0,1.0,1.0);const vec4 purple=vec4(0.5,0.0,0.5,1.0);const vec4 pink=vec4(1.0,0.0,1.0,1.0);info.colorDebug=green;
#endif
uint offset=0u;
#if MATERIAL_TABLE_DEBUG
bool keepFinding=true;uint magic=read_buf(offset);if(magic !=0xCAFEBABEu) {info.colorDebug=red;keepFinding=false;return info;}
#endif
offset++;
#if MATERIAL_TABLE_DEBUG
uint nrMaterials=read_buf(offset);uint nrVertices=read_buf(offset+1u);if(keepFinding && vertex_id >=nrVertices) {info.colorDebug=red;keepFinding=false;}
#endif
offset+=2u;uint nrMaterialLookupEntries=read_buf(offset++);uint perMaterialEntrySizeDwords=read_buf(offset++);
#if MATERIAL_TABLE_DEBUG
if(keepFinding && perMaterialEntrySizeDwords !=1u) {info.colorDebug=red;keepFinding=false;}
#endif
uint iMaterialLookup=findRange(vertex_id,nrMaterialLookupEntries,offset);
#if MATERIAL_TABLE_DEBUG
if(keepFinding)
{uint vertexBeginCheck=readVertexId(offset,iMaterialLookup);if(vertexBeginCheck > vertex_id) {info.colorDebug=red;keepFinding=false;}if(iMaterialLookup < nrMaterialLookupEntries-1u) {uint vertexEndCheck=readVertexId(offset,iMaterialLookup+1u);if(vertexEndCheck <=vertex_id) {info.colorDebug=red;keepFinding=false;}}}
#endif
offset+=nrDwordsForVertexIdEntries(nrMaterialLookupEntries);uint materialId=iMaterialLookup;
#if MATERIAL_TABLE_DEBUG
if(keepFinding) {if(materialId >=nrMaterialLookupEntries) {info.colorDebug=red;}}
#endif
info.dataOffset=offset+materialId*perMaterialEntrySizeDwords;return info;}uint get_data_location(const MaterialInfo matInfo,uint attribOffsetBytes)
{uint attribFieldOffsetDwords=attribOffsetBytes/4u;return matInfo.dataOffset+attribFieldOffsetDwords;}vec4 read_material_vec4(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec4(read_buf_float(loc),read_buf_float(loc+1u),read_buf_float(loc+2u),read_buf_float(loc+3u));}vec2 read_material_vec2(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec2(read_buf_float(loc),read_buf_float(loc+1u));}float read_material_float(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return read_buf_float(loc);}
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_offset) read_material_float(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_offset) read_material_vec4(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_offset) read_material_vec2(matInfo,attrib_offset)
#define DECLARE_MATERIAL_TABLE_INFO MaterialInfo materialInfo=read_material_info(uint(gl_VertexID));
#define DECLARE_MATERIAL_TABLE_INFO_DEBUG(dbgColor) MaterialInfo materialInfo=read_material_info(uint(gl_VertexID)); dbgColor=materialInfo.colorDebug;
#endif`,"_prelude_fog.fragment.glsl":gt,"_prelude_shadow.fragment.glsl":_f,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif`,"_prelude_raster_array.glsl":mf,"_prelude_raster_particle.glsl":wh},Eh={};ji("",jo),ji(gt,bh),ji(_f,Th),ji(mf,""),ji(wh,"");const Dm=ji(cc,pf),Sh=lc,uy=[`
#if defined(GL_EXT_blend_func_extended) && defined(DUAL_SOURCE_BLENDING)
#extension GL_EXT_blend_func_extended : require
#endif`,"precision mediump float;",Sh,Dm.fragmentSource].join(`
`),Om=["precision highp float;",Sh,Dm.vertexSource].join(`
`);var yf={background:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;uniform mediump float u_emissive_strength;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;uniform mediump float u_emissive_strength;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
#ifdef FLOOD_LIGHT
in highp float v_flood_radius;in float v_has_flood_light;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;uniform vec3 u_flood_light_color;uniform float u_flood_light_intensity;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
#else
shadowed_lighting_factor=dot(xy_flipped_normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=linearTosRGB(color.rgb);
#ifdef FLOOD_LIGHT
float flood_radiance=(1.0-min(v_pos.z/v_flood_radius,1.0))*u_flood_light_intensity*v_has_flood_light;color.rgb=mix(color.rgb,u_flood_light_color,flood_radiance);
#endif
color.rgb=mix(color.rgb,linearTosRGB(base_color.rgb),emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in float a_flood_light_wall_radius_1i16;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#ifdef FLOOD_LIGHT
out highp float v_flood_radius;out float v_has_flood_light;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;const float FLOOD_LIGHT_MAX_RADIUS_METER=2048.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
#ifdef FLOOD_LIGHT
v_flood_radius=(a_flood_light_wall_radius_1i16/MAX_INT_16*FLOOD_LIGHT_MAX_RADIUS_METER);v_has_flood_light=step(0.0,v_flood_radius);
#endif
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;float depth_offset=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);float height=a_centroid_3.z;depth_offset=min(1000.0,height)*0.0000002;}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);gl_Position.z-=depth_offset*gl_Position.w;}`),buildingBloom:ji(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
#ifdef RENDER_CUTOFF
opacity*=v_cutoff_opacity;
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),buildingDepth:ji(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:ji("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:ji(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:ji(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:ji("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:ji("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:ji("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:ji(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:ji(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#else
#ifdef FEATURE_CUTOUT
apply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);
#endif
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:ji(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:ji(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:ji(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
#ifdef USE_MRT1
out_Target1=vec4(1.0-texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size)).a,0.0,0.0,0.0);
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:ji(`precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float side_z_offset
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
#pragma mapbox: define lowp float emissive_strength
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float side_z_offset
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
#pragma mapbox: initialize lowp float emissive_strength
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);alpha=side_z_offset > 0.0 ? 1.0-alpha : alpha;
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#ifdef MULTIPLY_LINE_GRADIENT_COLOR
out_color*=color;
#endif
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef DUAL_SOURCE_BLENDING
glFragColorSrc1=vec4(vec3(0.0),emissive_strength);
#else
#ifdef USE_MRT1
out_Target1=vec4(emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float side_z_offset
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float side_z_offset
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
#pragma mapbox: initialize lowp float emissive_strength
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
bool left=normal.y==1.0;halfwidth=(u_width_scale*(left ? a_z_offset_width.y : a_z_offset_width.z))/2.0;a_z_offset+=left ? side_z_offset : 0.0;v_normal=side_z_offset > 0.0 && left ? vec2(0.0) : v_normal;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize lowp float emissive_strength
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef DUAL_SOURCE_BLENDING
glFragColorSrc1=vec4(vec3(0.0),emissive_strength);
#else
#ifdef USE_MRT1
out_Target1=vec4(emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize lowp float emissive_strength
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),1.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:ji("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:ji("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:ji(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:ji(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#define APPEARANCE_ICON 1.0
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float a_size_max= floor(a_size[1]*0.5);float a_apperance_icon=a_size[1]-2.0*a_size_max;vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (a_apperance_icon==APPEARANCE_ICON) {size=a_size_max/128.0;} else if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size_max,u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
#ifdef Z_TEST_OCCLUSION
out_fade_opacity*=occlusion_opacity;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
uniform sampler2D u_image1;uniform float u_emissive_texture_available;
#endif
in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : image_color.a;vec3 unlit_base=image_color.rgb*(1.0-emissive_strength);vec3 emissive_base=image_color.rgb*emissive_strength;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : image_color.a;color.rgb=mix(color.rgb,image_color.rgb,emissive_strength);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:ji("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:ji(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,xh),skyboxGradient:ji(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,xh),skyboxCapture:ji(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
uniform sampler2D u_image1;uniform float u_emissive_texture_available;
#endif
uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : raster.a;raster=apply_lighting_with_emission_ground(raster,emissive_strength);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : color.a;color=apply_lighting_with_emission_ground(color,emissive_strength);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:ji(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:ji(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef FLIP_Y
coord.y=1.0-coord.y;
#endif
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#ifdef CLIP_ZERO_TO_ONE
v_depth=-1.0+2.0*v_depth; 
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:ji(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:ji(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:ji("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:ji("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:ji("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:ji("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function Qa(l,t){const n=l.split(`
`);for(let c of n){if(c=c.trimStart(),c[0]!=="#"||!c.includes("if")||c.startsWith("#endif"))continue;const d=c.match(gf);if(d)for(const p of d)Dl.has(p)||t.add(p)}}function ji(l,t){const n=new Set,c=[],d=[];l=l.replace(fu,((_,v)=>(d.push(v),""))),t=t.replace(fu,((_,v)=>(c.push(v),"")));let p=new Set(Ol);Qa(l,p),Qa(t,p);for(const _ of[...c,...d])Eh[_]||(Eh[_]=new Set,Qa(Ka[_],Eh[_])),p=new Set([...p,...Eh[_]]);return{fragmentSource:l=l.replace(Ws,((_,v,w,I,C)=>(n.add(C),v==="define"?`
#ifndef HAS_UNIFORM_u_${C}
in ${w} ${I} ${C};
#else
uniform ${w} ${I} u_${C};
#endif
`:v==="initialize"?`
#ifdef HAS_UNIFORM_u_${C}
    ${w} ${I} ${C} = u_${C};
#endif
`:v==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${C}
    in ${w} ${I} ${C};
#endif
`:v==="initialize-attribute"?"":void 0))),vertexSource:t=t.replace(Ws,((_,v,w,I,C)=>{const O=`MATERIAL_ATTRIBUTE_OFFSET_${C}`,D=I==="float"?"vec2":I,z=`GET_ATTRIBUTE_${D}(a_${C}, materialInfo, ${O})`,N=C.match(/color/)?"color":D;return v==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${C}
in ${w} ${I} a_${C};
#endif
`:n.has(C)?v==="define"?`
#ifndef HAS_UNIFORM_u_${C}
uniform lowp float u_${C}_t;
    #if !defined(${O})
        in ${w} ${D} a_${C};
    #endif
out ${w} ${I} ${C};
#else
uniform ${w} ${I} u_${C};
#endif
`:v==="initialize"?N==="vec4"?`
#ifndef HAS_UNIFORM_u_${C}
    ${C} = a_${C};
#else
    ${w} ${I} ${C} = u_${C};
#endif
`:`
#if !defined(HAS_UNIFORM_u_${C})
    #ifdef ${O}
        ${C} = unpack_mix_${N}(${z}, u_${C}_t);
    #else
        ${C} = unpack_mix_${N}(a_${C}, u_${C}_t);
    #endif
#else
    ${w} ${I} ${C} = u_${C};
#endif
`:v==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${C}
    in ${w} ${I} a_${C};
    out ${w} ${I} ${C};
#endif
`:v==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${C}
    ${C} = a_${C};
#endif
`:void 0:v==="define"?`
#ifndef HAS_UNIFORM_u_${C}
uniform lowp float u_${C}_t;
    #if !defined(${O})
        in ${w} ${D} a_${C};
    #endif
#else
uniform ${w} ${I} u_${C};
#endif
`:v==="define-instanced"?N==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${C}0;
in vec4 a_${C}1;
in vec4 a_${C}2;
in vec4 a_${C}3;
#else
uniform ${w} ${I} u_${C};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${w} ${D} a_${C};
#else
uniform ${w} ${I} u_${C};
#endif
`:v==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${C}
    ${w} ${I} ${C} = a_${C};
#endif
`:N==="vec4"?`
#ifndef HAS_UNIFORM_u_${C}
    #ifdef ${O}
        ${w} ${I} ${C} = ${z};
    #else
        ${w} ${I} ${C} = a_${C};
    #endif
#else
    ${w} ${I} ${C} = u_${C};
#endif
`:`
#ifndef HAS_UNIFORM_u_${C}
    #ifdef ${O}
        ${w} ${I} ${C} = unpack_mix_${N}(${z}, u_${C}_t);
    #else
        ${w} ${I} ${C} = unpack_mix_${N}(a_${C}, u_${C}_t);
    #endif
#else
    ${w} ${I} ${C} = u_${C};
#endif
`})),usedDefines:p,vertexIncludes:c,fragmentIncludes:d}}class hy{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,n,c,d,p,_,v,w){this.context=t;let I=this.boundPaintVertexBuffers.length!==d.length;for(let O=0;!I&&O<d.length;O++)this.boundPaintVertexBuffers[O]!==d[O]&&(I=!0);let C=this.boundDynamicVertexBuffers.length!==v.length;for(let O=0;!C&&O<v.length;O++)this.boundDynamicVertexBuffers[O]!==v[O]&&(C=!0);if(!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==c||I||C||this.boundIndexBuffer!==p||this.boundVertexOffset!==_)this.freshBind(n,c,d,p,_,v,w);else{t.bindVertexArrayOES.set(this.vao);for(const O of v)O&&(O.bind(),w&&O.instanceCount&&O.setVertexAttribDivisor(t.gl,n,w));p&&p.dynamicDraw&&p.bind()}}freshBind(t,n,c,d,p,_,v){const w=this.context,I=w.gl;this.vao&&this.destroy(),this.vao=w.gl.createVertexArray(),w.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=d,this.boundVertexOffset=p,this.boundDynamicVertexBuffers=_,n.enableAttributes(I,t),n.bind(),n.setVertexAttribPointers(I,t,p);for(const C of c)C.enableAttributes(I,t),C.bind(),C.setVertexAttribPointers(I,t,p);for(const C of _)C&&(C.enableAttributes(I,t),C.bind(),C.setVertexAttribPointers(I,t,p),v&&C.instanceCount&&C.setVertexAttribDivisor(I,t,v));d&&d.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function dy(l,t){const n=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new o.ae(0,c/n).toLngLat().lat,new o.ae(0,(c+1)/n).toLngLat().lat]}function fy(l,t,n,c,d,p,_){const v=l.context,w=v.gl,I=n.hillshadeFBO;if(!I)return;l.prepareDrawTile();const C=l.isTileAffectedByFog(t),O=[];l.terrain&&l.terrain.renderingToTexture&&l.emissiveMode==="mrt-fallback"&&O.push("USE_MRT1");const D=l.getOrCreateProgram("hillshade",{overrideFog:C,defines:O});v.activeTexture.set(w.TEXTURE0),w.bindTexture(w.TEXTURE_2D,I.colorAttachment0.get());const z=((q,Y,te,J)=>{const _e=te.paint.get("hillshade-shadow-color"),he=te.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",pe=te.paint.get("hillshade-highlight-color"),ce=te.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",se=te.paint.get("hillshade-accent-color"),ye=te.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",Ce=te.paint.get("hillshade-emissive-strength");let Se=o.an(te.paint.get("hillshade-illumination-direction"));if(te.paint.get("hillshade-illumination-anchor")==="viewport")Se-=q.transform.angle;else if(q.style&&q.style.enable3dLights()&&q.style.directionalLight){const je=q.style.directionalLight.properties.get("direction"),Xe=o.d4(je.x,je.y,je.z);Se=o.an(Xe[1])}const Ue=!q.options.moving;return{u_matrix:J||q.transform.calculateProjMatrix(Y.tileID.toUnwrapped(),Ue),u_image:0,u_latrange:dy(0,Y.tileID),u_light:[te.paint.get("hillshade-exaggeration"),Se],u_shadow:_e.toPremultipliedRenderColor(he?null:te.lut),u_highlight:pe.toPremultipliedRenderColor(ce?null:te.lut),u_emissive_strength:Ce,u_accent:se.toPremultipliedRenderColor(ye?null:te.lut)}})(l,n,c,l.terrain?t.projMatrix:null);l.uploadCommonUniforms(v,D,t.toUnwrapped());const{tileBoundsBuffer:N,tileBoundsIndexBuffer:B,tileBoundsSegments:H}=l.getTileBoundsBuffers(n);D.draw(l,w.TRIANGLES,d,p,_,ti.disabled,z,c.id,N,B,H)}function vf(l,t,n){if(!t.needsDEMTextureUpload)return;const c=l.context,d=c.gl;c.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||l.getTileTexture(n.stride);const p=n.getPixels();t.demTexture?t.demTexture.update(p,{premultiply:!1}):t.demTexture=new o.T(c,p,d.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function py(l,t,n){const c=l.context,d=c.gl;if(!t.dem)return;const p=t.dem;if(c.activeTexture.set(d.TEXTURE1),vf(l,t,p),!t.demTexture)return;t.demTexture.bind(d.NEAREST,d.CLAMP_TO_EDGE);const _=p.dim;c.activeTexture.set(d.TEXTURE0);let v=t.hillshadeFBO;if(!v){const D=new o.T(c,{width:_,height:_,data:null},d.RGBA8);D.bind(d.LINEAR,d.CLAMP_TO_EDGE),v=t.hillshadeFBO=c.createFramebuffer(_,_,1,"renderbuffer"),v.colorAttachment0.set(D.texture)}c.bindFramebuffer.set(v.framebuffer),c.viewport.set([0,0,_,_]);const{tileBoundsBuffer:w,tileBoundsIndexBuffer:I,tileBoundsSegments:C}=l.getMercatorTileBoundsBuffers(),O=[];l.linearFloatFilteringSupported()&&O.push("TERRAIN_DEM_FLOAT_FORMAT"),l.terrain&&l.terrain.renderingToTexture&&l.emissiveMode==="mrt-fallback"&&O.push("USE_MRT1"),l.getOrCreateProgram("hillshadePrepare",{defines:O}).draw(l,d.TRIANGLES,Bt.disabled,ri.disabled,_i.unblended,ti.disabled,((D,z)=>{const N=z.stride,B=o.bC();return o.ce(B,0,o.al,-o.al,0,0,1),o.br(B,B,[0,-o.al,0]),{u_matrix:B,u_image:1,u_dimension:[N,N],u_zoom:D.overscaledZ}})(t.tileID,p),n.id,w,I,C),t.needsHillshadePrepare=!1}class Or{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class my extends Or{getDefault(){return o.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class zm extends Or{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class xf extends Or{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Ih extends Or{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class bf extends Or{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class zl extends Or{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class uc extends Or{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class pu extends Or{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class hc extends Or{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class km extends Or{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class wf extends Or{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class Fm extends Or{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class dc extends Or{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class Ah extends Or{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Ch extends Or{getDefault(){return o.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Tf extends Or{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class Mh extends Or{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class mu extends Or{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Bm extends Or{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Nm=class extends Or{getDefault(){return null}set(l){(l!==this.current||this.dirty)&&(this.gl.useProgram(l),this.current=l,this.dirty=!1)}};class Vm extends Or{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class fc extends Or{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Um extends Or{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class _y extends Or{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class gy extends Or{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class yy extends Or{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Ef extends Or{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Sf extends Or{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class If extends Or{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class Af extends Or{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class jm extends Or{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Ph extends Or{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class Lh extends Ph{constructor(t,n,c=0){super(t,n),this.attachmentPoint=t.gl.COLOR_ATTACHMENT0+c}setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,this.attachmentPoint,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class pc extends Ph{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,this.attachment(),n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class _u extends Ph{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,this.attachment(),n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Gm extends pc{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Go=(l,t,n,c)=>({u_matrix:l,u_image0:0,u_image1:1,u_skirt_height:t,u_ground_shadow_factor:n,u_emissive_texture_available:c}),Rh=(l,t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H)=>({u_proj_matrix:Float32Array.from(l),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(c),u_merc_matrix:n,u_zoom_transition:d,u_merc_center:p,u_image0:0,u_image1:1,u_frustum_tl:_,u_frustum_tr:v,u_frustum_br:w,u_frustum_bl:I,u_globe_pos:C,u_globe_radius:O,u_viewport:D,u_grid_matrix:H?Float32Array.from(H):new Float32Array(9),u_skirt_height:z,u_far_z_cutoff:N,u_emissive_texture_available:B});function gu(l,t){return l!=null&&t!=null&&!(!l.hasData()||!t.hasData())&&l.demTexture!=null&&t.demTexture!=null&&l.tileID.key!==t.tileID.key}const _a=new class{constructor(){this.operations={}}newMorphing(l,t,n,c,d){if(l in this.operations){const p=this.operations[l];p.to.tileID.key!==n.tileID.key&&(p.queued=n)}else this.operations[l]={startTime:c,phase:0,duration:d,from:t,to:n,queued:null}}getMorphValuesForProxy(l){if(!(l in this.operations))return null;const t=this.operations[l];return{from:t.from,to:t.to,phase:t.phase}}update(l){for(const t in this.operations){const n=this.operations[t];for(n.phase=(l-n.startTime)/n.duration;n.phase>=1||!this._validOp(n);)if(!this._nextOp(n,l)){delete this.operations[t];break}}}_nextOp(l,t){return!!l.queued&&(l.from=l.to,l.to=l.queued,l.queued=null,l.phase=0,l.startTime=t,!0)}_validOp(l){return l.from.hasData()&&l.to.hasData()}},Dh={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Oh(l,t,n){if(t===0)return 0;const c=t<1&&n===514?.25/t:1;return 6*Math.pow(1.5,22-l)*Math.max(t,1)*c}function Cf(l,t){const n=1<<l.z;return!t&&(l.x===0||l.x===n-1)||l.y===0||l.y===n-1}function mc(l,t){if(!l.style||!l.style.enable3dLights())return;const n=l.context,c=n.gl;n.activeTexture.set(c.TEXTURE1),t?t.bind(c.LINEAR,c.CLAMP_TO_EDGE):l.emptyTexture.bind(c.LINEAR,c.CLAMP_TO_EDGE)}const yu=l=>({u_matrix:l});function vu(l,t,n,c,d){if(d>0){const p=o.o.now(),_=(p-l.timeAdded)/d,v=t?(p-t.timeAdded)/d:-1,w=n.getSource(),I=c.coveringZoomLevel({tileSize:w.tileSize,roundZoom:w.roundZoom}),C=!t||Math.abs(t.tileID.overscaledZ-I)>Math.abs(l.tileID.overscaledZ-I),O=C&&l.refreshedUponExpiration?1:o.aA(C?_:1-v,0,1);return t?{opacity:1,mix:1-O,isFading:_<1}:{opacity:O,mix:0,isFading:_<1}}return{opacity:1,mix:0,isFading:!1}}class zh extends Po{constructor(t){const n=Dn("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",n,!1),n.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,n){t.state="loaded",n(null)}}class Mf extends Po{constructor(t){const n=Dn("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",n,!1),n.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,n,c){if(t.freezeTileCoverage)return;this.transform=t;const d=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((p,_)=>{if(p[_.key]="",!this._tiles[_.key]){const v=new Ml(_,this._source.tileSize*_.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);v.state="loaded",this._tiles[_.key]=v}return p}),{});for(const p in this._tiles)p in d||(this.freeFBO(p),this._tiles[p].unloadVectorData(),delete this._tiles[p])}freeFBO(t){const n=this.proxyCachedFBO[t];if(n!==void 0){const c=Object.values(n);this.renderCachePool.push(...c),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach((t=>t.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Pf extends o.aQ{constructor(t,n,c){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=n,this.projMatrix=c}}class Lf extends o.bV{constructor(t,n){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[c,d,p]=(function(w){const I=new o.bd,C=new o.b0,O=131;I.reserve(17161),C.reserve(33800);const D=o.al/128,z=o.al+D/2,N=z+D;for(let H=-D;H<N;H+=D)for(let q=-D;q<N;q+=D){const Y=q<0||q>z||H<0||H>z?24575:0,te=o.aA(Math.round(q),0,o.al),J=o.aA(Math.round(H),0,o.al);I.emplaceBack(te+Y,J)}const B=(H,q)=>{const Y=q*O+H;C.emplaceBack(Y+1,Y,Y+O),C.emplaceBack(Y+O,Y+O+1,Y+1)};for(let H=1;H<129;H++)for(let q=1;q<129;q++)B(q,H);return[0,129].forEach((H=>{for(let q=0;q<130;q++)B(q,H),B(H,q)})),[I,C,32768]})(),_=t.context;this.gridBuffer=_.createVertexBuffer(c,o.bf.members),this.gridIndexBuffer=_.createIndexBuffer(d),this.gridSegments=o.bg.simpleSegment(0,0,c.length,d.length),this.gridNoSkirtSegments=o.bg.simpleSegment(0,0,c.length,p),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Mf(n.map),this.orthoMatrix=o.bC(),o.ce(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,o.al,0,o.al,0,1);const v=_.gl;this._overlapStencilMode=new ri({func:v.GEQUAL,mask:255},0,255,v.KEEP,v.KEEP,v.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=n,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new zh(n.map),this._pendingGroundEffectLayers=[],this._emissiveTexture=!1}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(t,n,c){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const d=t.terrain.properties,p=t.terrain.drapeRenderMode===0,_=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=o.o.now();const v=t.terrain&&t.terrain.scope,w=d.get("source"),I=p?this._mockSourceCache:t.getSourceCache(w,v);if(!I)return void o.w(`Couldn't find terrain source "${w}".`);if(this.sourceCache=I,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=_?this.calculateExaggeration(n):d.get("exaggeration"),!n.projection.requiresDraping&&_&&this._exaggeration===0)return void this._disable();this.enabled=!0;const C=()=>{this.sourceCache.used&&o.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const O=this.getScaledDemTileSize();this.sourceCache.update(n,O,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,C(),this._initializing=!0),C(),n.updateElevation(!0,c),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(n),this._emptyDEMTextureDirty=!0,this._previousZoom=n.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const n=this._previousCameraAltitude,c=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=c;const d=n!=null?c-n:Number.MAX_VALUE;if(Math.abs(d)<2)return this._exaggeration;const p=t.zoom,_=this._style.terrain;if(!this._previousUpdateTimestamp)return _.getExaggeration(p);let v=p-this._previousZoom;const w=this._previousUpdateTimestamp;let I=p;this._evaluationZoom!=null&&(I=this._evaluationZoom,Math.abs(p-I)>.5&&(v=.5*(p-I+v)),v*d<0&&(I+=v)),this._evaluationZoom=I;const C=_.getExaggeration(I),O=C===_.getExaggeration(Math.max(0,I-.1));if(O&&Math.abs(C-this._exaggeration)<.01)return C;let D=Math.min(.1,.00375*(this._updateTimestamp-w));return(O||C<.1||Math.abs(v)<1e-4)&&(D=Math.min(.2,4*D)),o.ak(this._exaggeration,C,D)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.dataType==="source"&&t.coord?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach((t=>t.fb.destroy())),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const n=this.proxySourceCache,c=this.painter.transform;this._initializing&&(this._initializing=c._centerAltitude===0&&this.getAtPointOrZero(o.ae.fromLngLat(c.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const d=this.proxyCoords=n.getIds().map((w=>{const I=n.getTileByID(w).tileID;return I.projMatrix=c.calculateProjMatrix(I.toUnwrapped()),I}));(function(w,I){const C=I.transform.pointCoordinate(I.transform.getCameraPoint()),O=new o.P(C.x,C.y);w.sort(((D,z)=>{if(z.overscaledZ-D.overscaledZ)return z.overscaledZ-D.overscaledZ;const N=new o.P(D.canonical.x+(1<<D.canonical.z)*D.wrap,D.canonical.y),B=new o.P(z.canonical.x+(1<<z.canonical.z)*z.wrap,z.canonical.y),H=O.mult(1<<D.canonical.z);return H.x-=.5,H.y-=.5,H.distSqr(N)-H.distSqr(B)}))})(d,this.painter);const p=this.proxyToSource||{};this.proxyToSource={},d.forEach((w=>{this.proxyToSource[w.key]={}})),this.terrainTileForTile={};const _=this._style._mergedSourceCaches;for(const w in _){const I=_[w];if(!I.used||(I!==this.sourceCache&&this.resetTileLookupCache(I.id),this._setupProxiedCoordsForOrtho(I,t[w],p),I.usedForTerrain))continue;const C=t[w];I.getSource().reparseOverscaled&&this._assignTerrainTiles(C)}this.proxiedCoords[n.id]=d.map((w=>new Pf(w,w.key,this.orthoMatrix))),this._assignTerrainTiles(d),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(p),this.renderingToTexture=!1;const v={};this._visibleDemTiles=[];for(const w of this.proxyCoords){const I=this.terrainTileForTile[w.key];if(!I)continue;const C=I.tileID.key;C in v||(this._visibleDemTiles.push(I),v[C]=C)}}_assignTerrainTiles(t){this._initializing||t.forEach((n=>{if(this.terrainTileForTile[n.key])return;const c=this._findTileCoveringTileID(n,this.sourceCache);c&&(this.terrainTileForTile[n.key]=c)}))}_prepareDEMTextures(){const t=this.painter.context,n=t.gl;for(const c in this.terrainTileForTile){const d=this.terrainTileForTile[c],p=d.dem;!p||d.demTexture&&!d.needsDEMTextureUpload||(t.activeTexture.set(n.TEXTURE1),vf(this.painter,d,p))}}_prepareDemTileUniforms(t,n,c,d){if(!n||n.demTexture==null)return!1;const p=t.tileID.canonical,_=Math.pow(2,n.tileID.canonical.z-p.z),v=d||"";return c[`u_dem_tl${v}`]=[p.x*_%1,p.y*_%1],c[`u_dem_scale${v}`]=_,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const n=this._visibleDemTiles.reduce(((c,d)=>{if(!d.dem)return c;const p=d.dem.tree.minimums[0];return p>0&&t++,c+p}),0);return t?n/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,n=t.gl;t.activeTexture.set(n.TEXTURE2);const c=this._getLoadedAreaMinimum(),d=new o.dL({width:1,height:1},new Float32Array([c]));this._emptyDEMTextureDirty=!1;let p=this._emptyDEMTexture;return p?p.update(d,{premultiply:!1}):p=this._emptyDEMTexture=new o.T(t,d,n.R32F,{premultiply:!1}),p}setupElevationDraw(t,n,c){const d=this.painter.context,p=d.gl,_={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};_.u_exaggeration=this.exaggeration();let v=null,w=null,I=1;if(c&&c.morphing&&this._useVertexMorphing){const z=c.morphing.srcDemTile,N=c.morphing.dstDemTile;I=c.morphing.phase,z&&N&&(this._prepareDemTileUniforms(t,z,_,"_prev")&&(w=z),this._prepareDemTileUniforms(t,N,_)&&(v=N))}const C=z=>z&&z.demTexture&&this.painter.linearFloatFilteringSupported()?p.LINEAR:p.NEAREST;let O=null;var D;if(this.enabled?w&&v?(O=v.demTexture,d.activeTexture.set(p.TEXTURE4),w.demTexture.bind(C(w),p.CLAMP_TO_EDGE),_.u_dem_lerp=I):(v=this.terrainTileForTile[t.tileID.key],O=this._prepareDemTileUniforms(t,v,_)?v.demTexture:this.emptyDEMTexture):O=this.emptyDEMTexture,d.activeTexture.set(p.TEXTURE2),O&&(_.u_dem_size=(D=O).size[0]===1?1:D.size[0]-2,O.bind(C(v),p.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(c&&c.useDepthForOcclusion,n,_),c&&c.useMeterToDem&&v){const z=(1<<v.tileID.canonical.z)*o.cf(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;_.u_meter_to_dem=z}if(c&&c.labelPlaneMatrixInv&&(_.u_label_plane_matrix_inv=c.labelPlaneMatrixInv),n.setTerrainUniformValues(d,_),this.painter.transform.projection.name==="globe"){const z=this.globeUniformValues(this.painter.transform,t.tileID.canonical,c&&c.useDenormalizedUpVectorScale);n.setGlobeUniformValues(d,z)}}globeUniformValues(t,n,c){const d=t.projection;return{u_tile_tl_up:d.upVector(n,0,0),u_tile_tr_up:d.upVector(n,o.al,0),u_tile_br_up:d.upVector(n,o.al,o.al),u_tile_bl_up:d.upVector(n,0,o.al),u_tile_up_scale:c?o.dM(1):d.upVectorScale(n,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const n=this.painter,c=this.painter.context;t.length!==0&&(c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),n.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,(function(d,p,_,v,w){if(d.transform.projection.name==="globe")(function(I,C,O,D,z){const N=I.context,B=N.gl;let H,q;const Y=I.transform,te=o.dE(I,N,Y),J=(Ue,je)=>{if(q===je)return;const Xe=[Dh[je],"PROJECTION_GLOBE_VIEW"];te&&Xe.push("CUSTOM_ANTIALIASING");const ht=I.isTileAffectedByFog(Ue);H=I.getOrCreateProgram("globeRaster",{defines:Xe,overrideFog:ht}),q=je},_e=I.colorModeForRenderPass(),he=new Bt(B.LEQUAL,Bt.ReadWrite,I.depthRangeFor3D);_a.update(z);const pe=o.dF(Y),ce=[o.aF(Y.center.lng),o.aJ(Y.center.lat)],se=I.globeSharedBuffers,ye=[Y.width*o.o.devicePixelRatio,Y.height*o.o.devicePixelRatio],Ce=Float32Array.from(Y.globeMatrix),Se={useDenormalizedUpVectorScale:!0};{const Ue=I.transform,je=Oh(Ue.zoom,C.exaggeration(),C.sourceCache._source.tileSize);q=-1;const Xe=B.TRIANGLES;for(const ht of D){const ke=O.getTile(ht),we=ri.disabled,He=C.prevTerrainTileForTile[ht.key],Be=C.terrainTileForTile[ht.key];gu(He,Be)&&_a.newMorphing(ht.key,He,Be,z,250),mc(I,ke.emissiveTexture),N.activeTexture.set(B.TEXTURE0),ke.texture&&ke.texture.bind(B.LINEAR,B.CLAMP_TO_EDGE);const et=_a.getMorphValuesForProxy(ht.key),vt=et?1:0;et&&Object.assign(Se,{morphing:{srcDemTile:et.from,dstDemTile:et.to,phase:o.dD(et.phase)}});const St=o.dG(ht.canonical),_t=o.dH(St.getCenter().lat),dt=o.dI(ht.canonical,St,_t,Ue.worldSize/Ue._pixelsPerMercatorPixel),kt=o.bk(o.dJ(ht.canonical)),Dt=I.emissiveMode==="mrt-fallback"?1:0,Tt=Rh(Ue.expandedFarZProjMatrix,Ce,pe,kt,o.aj(Ue.zoom),ce,Ue.frustumCorners.TL,Ue.frustumCorners.TR,Ue.frustumCorners.BR,Ue.frustumCorners.BL,Ue.globeCenterInViewSpace,Ue.globeRadius,ye,je,Ue._farZ,Dt,dt);if(J(ht,vt),H&&(C.setupElevationDraw(ke,H,Se),I.uploadCommonUniforms(N,H,ht.toUnwrapped()),se)){const[At,Wt,ci]=se.getGridBuffers(_t,je!==0);H.draw(I,Xe,he,we,_e,ti.backCCW,Tt,"globe_raster",At,Wt,ci)}}}if(se&&(I.renderDefaultNorthPole||I.renderDefaultSouthPole)){const Ue=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];te&&Ue.push("CUSTOM_ANTIALIASING"),H=I.getOrCreateProgram("globeRaster",{defines:Ue});for(const je of D){const{x:Xe,y:ht,z:ke}=je.canonical,we=ht===0,He=ht===(1<<ke)-1,[Be,et,vt,St]=se.getPoleBuffers(ke,!1);if(St&&(we||He)){const _t=O.getTile(je);mc(I,_t.emissiveTexture),N.activeTexture.set(B.TEXTURE0),_t.texture&&_t.texture.bind(B.LINEAR,B.CLAMP_TO_EDGE);let dt=o.dK(ke,Xe,Y);const kt=o.bk(o.dJ(je.canonical)),Dt=I.emissiveMode==="mrt-fallback"?1:0,Tt=(At,Wt)=>At.draw(I,B.TRIANGLES,he,ri.disabled,_e,ti.disabled,Rh(Y.expandedFarZProjMatrix,dt,dt,kt,0,ce,Y.frustumCorners.TL,Y.frustumCorners.TR,Y.frustumCorners.BR,Y.frustumCorners.BL,Y.globeCenterInViewSpace,Y.globeRadius,ye,0,Y._farZ,Dt),"globe_pole_raster",Wt,vt,St);C.setupElevationDraw(_t,H,Se),I.uploadCommonUniforms(N,H,je.toUnwrapped()),we&&I.renderDefaultNorthPole&&Tt(H,Be),He&&I.renderDefaultSouthPole&&(dt=o.cS(o.bC(),dt,[1,-1,1]),Tt(H,et))}}}})(d,p,_,v,w);else{const I=d.context,C=I.gl;let O,D;const z=d.shadowRenderer,N=Wa(d,d.longestCutoffRange),B=_e=>{if(D===_e)return;const he=[];he.push(Dh[_e]),N.shouldRenderCutoff&&he.push("RENDER_CUTOFF"),z&&(he.push("RENDER_SHADOWS","DEPTH_TEXTURE"),z.useNormalOffset&&he.push("NORMAL_OFFSET")),O=d.getOrCreateProgram("terrainRaster",{defines:he}),D=_e},H=d.colorModeForRenderPass(),q=new Bt(C.LEQUAL,Bt.ReadWrite,d.depthRangeFor3D);_a.update(w);const Y=d.transform,te=Oh(Y.zoom,p.exaggeration(),p.sourceCache._source.tileSize);let J=[0,0,0];if(z){const _e=d.style.directionalLight,he=d.style.ambientLight;_e&&he&&(J=ma(d.style,_e,he))}{D=-1;const _e=C.TRIANGLES,[he,pe]=[p.gridIndexBuffer,p.gridSegments];for(const ce of v){const se=_.getTile(ce),ye=ri.disabled,Ce=p.prevTerrainTileForTile[ce.key],Se=p.terrainTileForTile[ce.key];gu(Ce,Se)&&_a.newMorphing(ce.key,Ce,Se,w,250),mc(d,se.emissiveTexture),I.activeTexture.set(C.TEXTURE0),se.texture&&se.texture.bind(C.LINEAR,C.CLAMP_TO_EDGE);const Ue=_a.getMorphValuesForProxy(ce.key),je=Ue?1:0;let Xe;Ue&&(Xe={morphing:{srcDemTile:Ue.from,dstDemTile:Ue.to,phase:o.dD(Ue.phase)}});const ht=d.emissiveMode==="mrt-fallback"?1:0,ke=Go(ce.projMatrix,Cf(ce.canonical,Y.renderWorldCopies)?te/10:te,J,ht);if(B(je),!O)continue;p.setupElevationDraw(se,O,Xe);const we=ce.toUnwrapped();z&&z.setupShadows(we,O),d.uploadCommonUniforms(I,O,we,null,N),O.draw(d,_e,q,ye,H,ti.backCCW,ke,"terrain_raster",p.gridBuffer,he,pe)}}}})(n,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,n.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const n=this.painter,c=this.painter.context,d=this.proxySourceCache,p=this.proxiedCoords[d.id],_=this._drapedRenderBatches.shift(),v=n.style.order,w=[];this._updateFBOs(n.emissiveMode==="mrt-fallback");let I=0;for(const C of p){const O=d.getTileByID(C.proxyTileKey),D=d.proxyCachedFBO[C.key]?d.proxyCachedFBO[C.key][t]:void 0,z=D!==void 0?d.renderCache[D]:this.pool[I++],N=D!==void 0;if(O.texture=z.tex,O.emissiveTexture=z.emissiveTex,N&&!z.dirty){w.push(O.tileID);continue}c.bindFramebuffer.set(z.fb.framebuffer);const B=c.gl;let H;B.drawBuffers(n.emissiveMode==="mrt-fallback"?[B.COLOR_ATTACHMENT0,B.COLOR_ATTACHMENT1]:[B.COLOR_ATTACHMENT0]),this.renderedToTile=!1,z.dirty&&(c.clear({color:o.ao.transparent,stencil:0}),z.dirty=!1);for(let q=_.start;q<=_.end;++q){const Y=n.style._mergedLayers[v[q]];if(Y.isHidden(n.transform.zoom))continue;const te=n.style.getLayerSourceCache(Y),J=te?this.proxyToSource[C.key][te.id]:[C];if(!J)continue;const _e=J;c.viewport.set([0,0,z.fb.width,z.fb.height]),H!==(te?te.id:null)&&(this._setupStencil(z,J,Y,te),H=te?te.id:null),n.renderLayer(n,te,Y,_e)}if(B.drawBuffers([B.COLOR_ATTACHMENT0]),this._drapedRenderBatches.length===0)for(const q of this._pendingGroundEffectLayers){const Y=n.style._mergedLayers[v[q]];if(Y.isHidden(n.transform.zoom))continue;const te=n.style.getLayerSourceCache(Y),J=te?this.proxyToSource[C.key][te.id]:[C];if(!J)continue;const _e=J;c.viewport.set([0,0,z.fb.width,z.fb.height]),H!==(te?te.id:null)&&(this._setupStencil(z,J,Y,te),H=te?te.id:null),n.renderLayer(n,te,Y,_e)}this.renderedToTile?(z.dirty=!0,w.push(O.tileID)):N||--I,I===5&&(I=0,this.renderToBackBuffer(w))}return this.renderToBackBuffer(w),this.renderingToTexture=!1,c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),_.end+1}postRender(){}isLayerOrderingCorrect(t){const n=t.order.length;let c=-1,d=n;for(let p=0;p<n;++p)this._style.isLayerDraped(t._mergedLayers[t.order[p]])?c=Math.max(c,p):d=Math.min(d,p);return d>c}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter((n=>n.dem)).forEach((n=>{t=Math.min(t,n.dem.tree.minimums[0])})),t===0?t:(t-30)*this._exaggeration}raycast(t,n,c){if(!this._visibleDemTiles)return null;const d=this._visibleDemTiles.filter((p=>p.dem)).map((p=>{const _=p.tileID,v=1<<_.overscaledZ,{x:w,y:I}=_.canonical,C=w/v,O=(w+1)/v,D=I/v,z=(I+1)/v;return{minx:C,miny:D,maxx:O,maxy:z,t:p.dem.tree.raycastRoot(C,D,O,z,t,n,c),tile:p}}));d.sort(((p,_)=>(p.t!==null?p.t:Number.MAX_VALUE)-(_.t!==null?_.t:Number.MAX_VALUE)));for(const p of d){if(p.t==null)return null;const _=p.tile.dem.tree.raycast(p.minx,p.miny,p.maxx,p.maxy,t,n,c);if(_!=null)return _}return null}_createFBO(){const t=this.painter.context,n=t.gl,c=this.drapeBufferSize;t.activeTexture.set(n.TEXTURE0);const d=new o.T(t,{width:c[0],height:c[1],data:null},n.RGBA8);d.bind(n.LINEAR,n.CLAMP_TO_EDGE);const p=t.createFramebuffer(c[0],c[1],1,null);let _;return p.colorAttachment0.set(d.texture),this._emissiveTexture&&(_=new o.T(t,{width:c[0],height:c[1],data:null},n.R8),_.bind(n.LINEAR,n.CLAMP_TO_EDGE),p.createColorAttachment(t,1),p.colorAttachment1.set(_.texture)),p.depthAttachment=new Gm(t,p.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,c[0],c[1]),this._stencilRef=0,p.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):p.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&n.texParameterf(n.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:p,tex:d,emissiveTex:_,dirty:!1}}_updateFBOs(t){if(this._emissiveTexture!==t){for(const n of this.pool)this._updateFBO(n,t);for(const n of this.proxySourceCache.renderCache)this._updateFBO(n,t);this._emissiveTexture=t}}_updateFBO(t,n){const c=t.fb,d=this.painter.context,p=d.gl,_=this.drapeBufferSize;if(n){const v=new o.T(d,{width:_[0],height:_[1],data:null},p.R8);v.bind(p.LINEAR,p.CLAMP_TO_EDGE),t.emissiveTex=v,c.createColorAttachment(d,1),c.colorAttachment1.set(v.texture)}else t.emissiveTex=void 0,c.removeColorAttachment(d,1);t.dirty=!0}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some((t=>{const n=this._style._mergedLayers[t],c=n.isHidden(this.painter.transform.zoom);return n.type==="hillshade"||n.type==="custom"?!c&&n.shouldRedrape():!c&&n.hasTransition()}))}_clearLineLayersFromRenderCache(){let t=!1;for(const c of this._style.getSources())if(c instanceof Il){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(!p||n[p.id]||d.isHidden(this.painter.transform.zoom)||d.type!=="line")continue;const _=d.widthExpression(),v=d.emissiveStrengthExpression();if(_ instanceof o.ad||v instanceof o.ad){n[p.id]=!0;for(const w of this.proxyCoords){const I=this.proxyToSource[w.key][p.id];if(I)for(const C of I)this._clearRenderCacheForTile(p.id,C)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const c in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[c]._source instanceof Un){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(!p||n[p.id]||d.isHidden(this.painter.transform.zoom)||d.type!=="raster")continue;const _=d.paint.get("raster-fade-duration");for(const v of this.proxyCoords){const w=this.proxyToSource[v.key][p.id];if(w)for(const I of w){const C=vu(p.getTile(I),p.findLoadedParent(I,0),p,this.painter.transform,_);(C.opacity!==1||C.mix!==0)&&this._clearRenderCacheForTile(p.id,I)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,n=t.length;if(n===0)return;const c=[];this._pendingGroundEffectLayers=[];let d,p=0,_=this._style._mergedLayers[t[p]];for(;!this._style.isLayerDraped(_)&&_.isHidden(this.painter.transform.zoom)&&++p<n;)_=this._style._mergedLayers[t[p]];for(;p<n;++p){const v=this._style._mergedLayers[t[p]];v.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(v)?d===void 0&&(d=p):(v.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(p),d!==void 0&&(c.push({start:d,end:p-1}),d=void 0)))}if(d!==void 0&&c.push({start:d,end:p-1}),c.length!==0){const v=c[c.length-1];this._pendingGroundEffectLayers.every((w=>w>v.end))||o.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=c}_setupRenderCache(t){const n=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,n.renderCache.length>n.renderCachePool.length){const _=Object.values(n.proxyCachedFBO);n.proxyCachedFBO={};for(let v=0;v<_.length;++v){const w=Object.values(_[v]);n.renderCachePool.push(...w)}}return}this._clearRasterLayersFromRenderCache();const c=this.proxyCoords,d=this._tilesDirty;for(let _=c.length-1;_>=0;_--){const v=c[_];if(n.getTileByID(v.key),n.proxyCachedFBO[v.key]!==void 0){const w=t[v.key],I=this.proxyToSource[v.key];let C=0;for(const O in I){const D=I[O],z=w[O];if(!z||z.length!==D.length||D.some(((N,B)=>N!==z[B]||d[O]&&d[O].hasOwnProperty(N.key)))){C=-1;break}++C}for(const O in n.proxyCachedFBO[v.key])n.renderCache[n.proxyCachedFBO[v.key][O]].dirty=C<0||C!==Object.values(w).length}}const p=[...this._drapedRenderBatches];p.sort(((_,v)=>v.end-v.start-(_.end-_.start)));for(const _ of p)for(const v of c){if(n.proxyCachedFBO[v.key])continue;let w=n.renderCachePool.pop();w===void 0&&n.renderCache.length<50&&(w=n.renderCache.length,n.renderCache.push(this._createFBO())),w!==void 0&&(n.proxyCachedFBO[v.key]={},n.proxyCachedFBO[v.key][_.start]=w,n.renderCache[w].dirty=!0)}this._tilesDirty={}}_setupStencil(t,n,c,d){if(!d||!this._sourceTilesOverlap[d.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const p=this.painter.context,_=p.gl;if(n.length<=1)return void(this._overlapStencilType=!1);let v;if(c.isTileClipped())v=n.length,this._overlapStencilMode.test={func:_.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(n[0].overscaledZ>n[n.length-1].overscaledZ))return void(this._overlapStencilType=!1);v=1,this._overlapStencilMode.test={func:_.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+v>255&&(p.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=v,this._overlapStencilMode.ref=this._stencilRef,c.isTileClipped()&&this._renderTileClippingMasks(n,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):ri.disabled}_renderTileClippingMasks(t,n){const c=this.painter,d=this.painter.context,p=d.gl;c._tileClippingMaskIDs={},d.setColorMode(_i.disabled),d.setDepthMode(Bt.disabled);const _=c.getOrCreateProgram("clippingMask");for(const v of t){const w=c._tileClippingMaskIDs[v.key]=--n;_.draw(c,p.TRIANGLES,Bt.disabled,new ri({func:p.ALWAYS,mask:0},w,255,p.KEEP,p.KEEP,p.REPLACE),_i.disabled,ti.disabled,yu(v.projMatrix),"$clipping",c.tileExtentBuffer,c.quadTriangleIndexBuffer,c.tileExtentSegments)}}pointCoordinate(t){const n=this.painter.transform;if(t.x<0||t.x>n.width||t.y<0||t.y>n.height)return null;const c=[t.x,t.y,1,1];o.aC(c,c,n.pixelMatrixInverse),o.cK(c,c,1/c[3]),c[0]/=n.worldSize,c[1]/=n.worldSize;const d=n._camera.position,p=o.cf(1,n.center.lat),_=[d[0],d[1],d[2]/p,0],v=o.da([],c.slice(0,3),_);o.aw(v,v);const w=this.raycast(_,v,this._exaggeration);return w!==null&&w?(o.bH(_,_,v,w),_[3]=_[2],_[2]*=p,_):null}_setupProxiedCoordsForOrtho(t,n,c){if(t.getSource()instanceof o.aU)return this._setupProxiedCoordsForImageSource(t,n,c);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const d=this.proxiedCoords[t.id]=[],p=this.proxyCoords;for(let w=0;w<p.length;w++){const I=p[w],C=this._findTileCoveringTileID(I,t);if(C){const O=this._createProxiedId(I,C,c[I.key]&&c[I.key][t.id]);d.push(O),this.proxyToSource[I.key][t.id]=[O]}}let _=!1;const v=new Set;for(let w=0;w<n.length;w++){const I=t.getTile(n[w]);if(!I||!I.hasData())continue;const C=this._findTileCoveringTileID(I.tileID,this.proxySourceCache);if(C&&C.tileID.canonical.z!==I.tileID.canonical.z){const O=this.proxyToSource[C.tileID.key][t.id],D=this._createProxiedId(C.tileID,I,c[C.tileID.key]&&c[C.tileID.key][t.id]);O?O.splice(O.length-1,0,D):this.proxyToSource[C.tileID.key][t.id]=[D];const z=this.proxyToSource[C.tileID.key][t.id];v.has(z)||v.add(z),d.push(D),_=!0}}if(this._sourceTilesOverlap[t.id]=_,_&&this._debugParams.sortTilesHiZFirst)for(const w of v)w.sort(((I,C)=>C.overscaledZ-I.overscaledZ))}_setupProxiedCoordsForImageSource(t,n,c){if(!t.getSource().loaded())return;const d=this.proxiedCoords[t.id]=[],p=this.proxyCoords,_=t.getSource(),v=_.tileID;if(!v)return;const w=new o.P(v.x,v.y)._div(1<<v.z),I=_.coordinates.map(o.ae.fromLngLat).reduce(((O,D)=>(O.min.x=Math.min(O.min.x,D.x-w.x),O.min.y=Math.min(O.min.y,D.y-w.y),O.max.x=Math.max(O.max.x,D.x-w.x),O.max.y=Math.max(O.max.y,D.y-w.y),O)),{min:new o.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new o.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),C=(O,D)=>{const z=O.wrap+O.canonical.x/(1<<O.canonical.z),N=O.canonical.y/(1<<O.canonical.z),B=o.al/(1<<O.canonical.z),H=D.wrap+D.canonical.x/(1<<D.canonical.z),q=D.canonical.y/(1<<D.canonical.z);return z+B<H+I.min.x||z>H+I.max.x||N+B<q+I.min.y||N>q+I.max.y};for(let O=0;O<p.length;O++){const D=p[O];for(let z=0;z<n.length;z++){const N=t.getTile(n[z]);if(!N||!N.hasData()||C(D,N.tileID))continue;const B=this._createProxiedId(D,N,c[D.key]&&c[D.key][t.id]),H=this.proxyToSource[D.key][t.id];H?H.push(B):this.proxyToSource[D.key][t.id]=[B],d.push(B)}}}_createProxiedId(t,n,c){let d=this.orthoMatrix;if(c){const p=c.find((_=>_.key===n.tileID.key));if(p)return p}if(n.tileID.key!==t.key){const p=t.canonical.z-n.tileID.canonical.z;let _,v,w;d=o.bC();const I=n.tileID.wrap-t.wrap<<t.overscaledZ;p>0?(_=o.al>>p,v=_*((n.tileID.canonical.x<<p)-t.canonical.x+I),w=_*((n.tileID.canonical.y<<p)-t.canonical.y)):(_=o.al<<-p,v=o.al*(n.tileID.canonical.x-(t.canonical.x+I<<-p)),w=o.al*(n.tileID.canonical.y-(t.canonical.y<<-p))),o.ce(d,0,_,0,_,0,1),o.br(d,d,[v,w,0])}return new Pf(n.tileID,t.key,d)}_findTileCoveringTileID(t,n){let c=n.getTile(t);if(c&&c.hasData())return c;const d=this._findCoveringTileCache[n.id],p=d[t.key];if(c=p?n.getTileByID(p):null,c&&c.hasData()||p===null)return c;let _=c?c.tileID:t,v=_.overscaledZ;const w=n.getSource().minzoom,I=[];if(!p){const O=n.getSource().maxzoom;if(t.canonical.z>=O){const D=t.canonical.z-O;n.getSource().reparseOverscaled?(v=Math.max(t.canonical.z+2,n.transform.tileZoom),_=new o.aQ(v,t.wrap,O,t.canonical.x>>D,t.canonical.y>>D)):D!==0&&(v=O,_=new o.aQ(v,t.wrap,O,t.canonical.x>>D,t.canonical.y>>D))}_.key!==t.key&&(I.push(_.key),c=n.getTile(_))}const C=O=>{I.forEach((D=>{d[D]=O})),I.length=0};for(v-=1;v>=w&&(!c||!c.hasData());v--){c&&C(c.tileID.key);const O=_.calculateScaledKey(v);if(c=n.getTileByID(O),c&&c.hasData())break;const D=d[O];if(D===null)break;D===void 0?I.push(O):c=n.getTileByID(D)}return C(c?c.tileID.key:null),c&&c.hasData()?c:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,n){let c=this._tilesDirty[t];c||(c=this._tilesDirty[t]={}),c[n.key]=!0}}function _c(l,t,n){const c=(function(v,w,I){const C=o.bJ(w,v),O=o.bJ(I,[.2126,.7152,.0722]),D=(N,B,H)=>(1-H)*N+H*B,z=D(1-.3*Math.min(O,1),1,Math.min(C+1,1));return D(.92,1,Math.asin(o.aA(w[2],-1,1))/Math.PI+.5)*z})(l,[0,0,1],t),d=[0,0,0];o.c5(d,n.slice(0,3),c);const p=[0,0,0];o.c5(p,t.slice(0,3),l[2]);const _=[0,0,0];return o.d8(_,d,p),o.db(_)}const vy=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],xy=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","building","buildingBloom","elevatedStructures","model","symbol"];class qm{static cacheKey(t,n,c,d){const p=[n];d&&p.push(d.cacheKey);for(const _ of c)t.usedDefines.has(_)&&p.push(_);return p.join("/")}constructor(t,n,c,d,p,_){const v=t.gl;this.program=v.createProgram(),this.configuration=d,this.name=n,this.fixedDefines=[..._];const w=`#version 300 es
${(d?d.defines():[]).concat(_.map((B=>`#define ${B}`))).join(`
`)}`,I=[w,uy];for(const B of c.fragmentIncludes)I.push(Ka[B]);I.push(c.fragmentSource);const C=I.join(`
`),O=[w,Om];for(const B of c.vertexIncludes)O.push(Ka[B]);this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&c.vertexSource.includes("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&O.push("uniform int u_instanceID;"),O.push(c.vertexSource);let D=O.join(`
`);this.forceManualRenderingForInstanceIDShaders&&(D=D.replaceAll("gl_InstanceID","u_instanceID"));const z=v.createShader(v.FRAGMENT_SHADER);if(v.isContextLost())return void(this.failedToCreate=!0);v.shaderSource(z,C),v.compileShader(z),v.attachShader(this.program,z);const N=v.createShader(v.VERTEX_SHADER);v.isContextLost()?this.failedToCreate=!0:(v.shaderSource(N,D),v.compileShader(N),v.attachShader(this.program,N),this.attributes={},v.linkProgram(this.program),v.deleteShader(N),v.deleteShader(z),this.fixedUniforms=p(t),this.fixedUniformsEntries=Object.entries(this.fixedUniforms),this.binderUniforms=d?d.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(B=>({u_instanceID:new o.ch(B)}))(t)),(_.includes("TERRAIN")||n.includes("symbol")||n.includes("circle"))&&(this.terrainUniforms=(B=>({u_dem:new o.ch(B),u_dem_prev:new o.ch(B),u_dem_tl:new o.ck(B),u_dem_scale:new o.cj(B),u_dem_tl_prev:new o.ck(B),u_dem_scale_prev:new o.cj(B),u_dem_size:new o.cj(B),u_dem_lerp:new o.cj(B),u_exaggeration:new o.cj(B),u_depth:new o.ch(B),u_depth_size_inv:new o.ck(B),u_depth_range_unpack:new o.ck(B),u_occluder_half_size:new o.cj(B),u_occlusion_depth_offset:new o.cj(B),u_meter_to_dem:new o.cj(B),u_label_plane_matrix_inv:new o.cl(B)}))(t)),_.includes("GLOBE")&&(this.globeUniforms=(B=>({u_tile_tl_up:new o.ci(B),u_tile_tr_up:new o.ci(B),u_tile_br_up:new o.ci(B),u_tile_bl_up:new o.ci(B),u_tile_up_scale:new o.cj(B)}))(t)),_.includes("FOG")&&(this.fogUniforms=(B=>({u_fog_matrix:new o.cl(B),u_fog_range:new o.ck(B),u_fog_color:new o.d3(B),u_fog_horizon_blend:new o.cj(B),u_fog_vertical_limit:new o.ck(B),u_fog_temporal_offset:new o.cj(B),u_frustum_tl:new o.ci(B),u_frustum_tr:new o.ci(B),u_frustum_br:new o.ci(B),u_frustum_bl:new o.ci(B),u_globe_pos:new o.ci(B),u_globe_radius:new o.cj(B),u_globe_transition:new o.cj(B),u_is_globe:new o.ch(B),u_viewport:new o.ck(B)}))(t)),_.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(B=>({u_cutoff_params:new o.d3(B)}))(t)),_.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(B=>({u_lighting_ambient_color:new o.ci(B),u_lighting_directional_dir:new o.ci(B),u_lighting_directional_color:new o.ci(B),u_ground_radiance:new o.ci(B)}))(t)),_.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(B=>({u_light_matrix_0:new o.cl(B),u_light_matrix_1:new o.cl(B),u_fade_range:new o.ck(B),u_shadow_normal_offset:new o.ci(B),u_shadow_intensity:new o.cj(B),u_shadow_texel_size:new o.cj(B),u_shadow_map_resolution:new o.cj(B),u_shadow_direction:new o.ci(B),u_shadow_bias:new o.ci(B),u_shadowmap_0:new o.ch(B),u_shadowmap_1:new o.ch(B)}))(t)))}getAttributeLocation(t,n){let c=this.attributes[n];return c===void 0&&(c=this.attributes[n]=t.getAttribLocation(this.program,n)),c}setTerrainUniformValues(t,n){if(!this.terrainUniforms)return;const c=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d]&&c[d].set(this.program,d,n[d])}}setGlobeUniformValues(t,n){if(!this.globeUniforms)return;const c=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d]&&c[d].set(this.program,d,n[d])}}setFogUniformValues(t,n){if(!this.fogUniforms)return;const c=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setCutoffUniformValues(t,n){if(!this.cutoffUniforms)return;const c=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setLightsUniformValues(t,n){if(!this.lightsUniforms)return;const c=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setShadowUniformValues(t,n){if(this.failedToCreate||!this.shadowUniforms)return;const c=this.shadowUniforms;t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}_drawDebugWireframe(t,n,c,d,p,_,v,w,I,C){const O=t.options.wireframe;if(O.terrain===!1&&O.layers2D===!1&&O.layers3D===!1)return;const D=t.context;if(!(!(!O.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!O.layers2D||t._terrain&&t._terrain.renderingToTexture||!vy.includes(this.name))||!(!O.layers3D||!xy.includes(this.name))))return;const z=D.gl,N=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,p,D);if(!N)return;const B=[...this.fixedDefines,"DEBUG_WIREFRAME"],H=t.getOrCreateProgram(this.name,{config:this.configuration,defines:B});D.program.set(H.program);const q=(J,_e,he)=>{if(_e[J]&&he[J])for(const pe in _e[J])he[J][pe]&&he[J][pe].set(he.program,pe,_e[J][pe].current)};I&&I.setUniforms(H.program,D,H.binderUniforms,v,{zoom:w}),q("fixedUniforms",this,H),q("terrainUniforms",this,H),q("globeUniforms",this,H),q("fogUniforms",this,H),q("lightsUniforms",this,H),q("shadowUniforms",this,H),N.bind(),D.setColorMode(new _i([z.ONE,z.ONE_MINUS_SRC_ALPHA,z.ZERO,z.ONE],o.ao.transparent,[!0,!0,!0,!1])),D.setDepthMode(new Bt(n.func===z.LESS?z.LEQUAL:n.func,Bt.ReadOnly,n.range)),D.setStencilMode(ri.disabled);const Y=3*_.primitiveLength*2,te=3*_.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const J=C||1;for(let _e=0;_e<J;++_e)H.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",_e),z.drawElements(z.LINES,Y,z.UNSIGNED_SHORT,te)}else C&&C>1?z.drawElementsInstanced(z.LINES,Y,z.UNSIGNED_SHORT,te,C):z.drawElements(z.LINES,Y,z.UNSIGNED_SHORT,te);p.bind(),D.program.set(this.program),D.setDepthMode(n),D.setStencilMode(c),D.setColorMode(d)}checkUniforms(t,n,c){if(this.fixedDefines.includes(n)){for(const d of Object.keys(c))if(!c[d].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${d} not set but required by ${n} being defined`)}}draw(t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H){const q=t.context,Y=q.gl;if(this.failedToCreate)return;q.program.set(this.program),q.setDepthMode(c),q.setStencilMode(d),q.setColorMode(p),q.setCullFace(_);for(const[ce,se]of this.fixedUniformsEntries)se.set(this.program,ce,v[ce]);N&&N.setUniforms(this.program,q,this.binderUniforms,D,{zoom:z});const te={[Y.POINTS]:1,[Y.LINES]:2,[Y.TRIANGLES]:3,[Y.LINE_STRIP]:1}[n];this.checkUniforms(w,"RENDER_SHADOWS",this.shadowUniforms);const J=B||[],_e=N?N.getPaintVertexBuffers():[],he=n===Y.TRIANGLES&&C,pe=H&&H>0?1:void 0;for(const ce of O.get()){const se=ce.vaos||(ce.vaos={});if((se[w]||(se[w]=new hy)).bind(q,this,I,_e,C,ce.vertexOffset,J,pe),this.forceManualRenderingForInstanceIDShaders){const ye=H||1;for(let Ce=0;Ce<ye;++Ce)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Ce),C?Y.drawElements(n,ce.primitiveLength*te,Y.UNSIGNED_SHORT,ce.primitiveOffset*te*2):Y.drawArrays(n,ce.vertexOffset,ce.vertexLength)}else H&&H>1?Y.drawElementsInstanced(n,ce.primitiveLength*te,Y.UNSIGNED_SHORT,ce.primitiveOffset*te*2,H):C?Y.drawElements(n,ce.primitiveLength*te,Y.UNSIGNED_SHORT,ce.primitiveOffset*te*2):Y.drawArrays(n,ce.vertexOffset,ce.vertexLength);he&&this._drawDebugWireframe(t,c,d,p,C,ce,D,z,N,H)}}}function Hm(l,t,n=0){const c=Math.pow(2,t.tileID.overscaledZ),d=t.tileSize*Math.pow(2,l.transform.tileZoom)/c,p=d*(t.tileID.canonical.x+t.tileID.wrap*c),_=d*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/o.ay(t,1,l.transform.tileZoom),u_pixel_coord_upper:[p>>16,_>>16],u_pixel_coord_lower:[65535&p,65535&_],u_pattern_transition:n}}const kh={terrain:0,flat:1},by=o.bC(),Fh=(l,t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H,q)=>{const Y=t.style.light,te=Y.properties.get("position"),J=[te.x,te.y,te.z],_e=o.dO();Y.properties.get("anchor")==="viewport"&&(o.dP(_e,-t.transform.angle),o.dQ(J,J,_e));const he=Y.properties.get("color").toPremultipliedRenderColor(null),pe=t.transform,ce={u_matrix:l,u_lightpos:J,u_lightintensity:Y.properties.get("intensity"),u_lightcolor:[he.r,he.g,he.b],u_vertical_gradient:+n,u_opacity:c,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:by,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:kh[I],u_base_type:kh[C],u_ao:d,u_edge_radius:p,u_width_scale:_,u_flood_light_color:N,u_vertical_scale:B,u_flood_light_intensity:H,u_ground_shadow_factor:q};return pe.projection.name==="globe"&&(ce.u_tile_id=[v.canonical.x,v.canonical.y,1<<v.canonical.z],ce.u_zoom_transition=O,ce.u_inv_rot_matrix=z,ce.u_merc_center=D,ce.u_up_dir=pe.projection.upVector(new o.cD(0,0,0),D[0]*o.al,D[1]*o.al),ce.u_height_lift=w),ce},Rf=(l,t,n,c,d,p)=>({u_matrix:l,u_edge_radius:t,u_width_scale:n,u_vertical_scale:c,u_height_type:kh[d],u_base_type:kh[p]}),Zm=(l,t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H,q)=>{const Y=Fh(l,t,n,c,d,p,_,v,I,C,O,D,z,N,B,H,1,[0,0,0]),te={u_height_factor:-Math.pow(2,v.overscaledZ)/w.tileSize/8};return Object.assign(Y,Hm(t,w,q),te)},gc=(l,t,n,c,d,p,_,v,w,I,C)=>({u_matrix:t,u_opacity:n,u_ao_pass:c?1:0,u_meter_to_tile:d,u_ao:p,u_flood_light_intensity:_,u_flood_light_color:v,u_attenuation:w,u_edge_radius:I,u_fb:0,u_fb_size:C,u_dynamic_offset:1}),Df=(l,t,n)=>({u_matrix:l,u_emissive_strength:t,u_ground_shadow_factor:n}),Of=(l,t,n,c,d,p=0)=>Object.assign(Df(l,t,d),Hm(n,c,p)),$m=(l,t,n,c)=>({u_matrix:l,u_world:n,u_emissive_strength:t,u_ground_shadow_factor:c}),zf=(l,t,n,c,d,p,_=0)=>Object.assign(Of(l,t,n,c,p,_),{u_world:d}),el=(l,t)=>({u_matrix:l,u_ground_shadow_factor:t}),kl=(l,t,n,c,d)=>({u_matrix:l,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:n,u_height_scale:c,u_reset_depth:d}),Bh=(l,t,n,c,d,p,_,v,w)=>({u_matrix:l,u_normal_matrix:t,u_opacity:n,u_faux_facade_ao_intensity:c,u_camera_pos:d,u_tile_to_meter:p,u_facade_emissive_chance:_,u_flood_light_color:v,u_flood_light_intensity:w}),Wm=l=>({u_matrix:l}),tl=l=>({u_matrix:l}),kf=(l,t,n,c,d,p,_,v)=>{const w=o.al/p.tileSize;return{u_matrix:l,u_inv_rot_matrix:t,u_camera_to_center_distance:n.getCameraToCenterDistance(v),u_extrude_scale:[n.pixelsToGLUnits[0]/w,n.pixelsToGLUnits[1]/w],u_zoom_transition:c,u_tile_id:_,u_merc_center:d}},xu=(l,t,n=1)=>({u_matrix:l,u_color:t,u_overlay:0,u_overlay_scale:n}),Xm=o.bC(),Ym=(l,t,n,c,d,p,_)=>{const v=l.transform,w=v.projection.name==="globe",I=w?o.dR(v.zoom,t.canonical)*v._pixelsPerMercatorPixel:o.ay(n,1,p),C={u_matrix:t.projMatrix,u_extrude_scale:I,u_intensity:_,u_inv_rot_matrix:Xm,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(w){C.u_inv_rot_matrix=c,C.u_merc_center=d,C.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],C.u_zoom_transition=o.aj(v.zoom);const O=d[0]*o.al,D=d[1]*o.al;C.u_up_dir=v.projection.upVector(new o.cD(0,0,0),O,D)}return C};function Nh(l,[t,n,c,d],[p,_]){if(p===_)return[0,0,0,0];const v=255*(l-1)/(l*(_-p));return[t*v,n*v,c*v,d*v]}function Vh(l,t,[n,c]){return n===c?0:.5/l+(t-n)*(l-1)/(l*(c-n))}const Jm=(l,t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H,q,Y,te,J)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:I,u_fade_t:C.mix,u_opacity:C.opacity*O.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:O.paint.get("raster-brightness-min"),u_brightness_high:O.paint.get("raster-brightness-max"),u_saturation_factor:o.dT(O.paint.get("raster-saturation")),u_contrast_factor:o.dS(O.paint.get("raster-contrast")),u_spin_weights:Km(O.paint.get("raster-hue-rotate")),u_perspective_transform:D,u_raster_elevation:z,u_zoom_transition:_,u_merc_center:v,u_cutoff_params:w,u_colorization_mix:Nh(o.dU,B,q),u_colorization_offset:Vh(o.dU,H,q),u_color_ramp:N,u_texture_offset:[te/(Y+2*te),Y/(Y+2*te)],u_texture_res:[Y+2*te,Y+2*te],u_emissive_strength:J});function Km(l){l*=Math.PI/180;const t=Math.sin(l),n=Math.cos(l);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}const Xs=.05,wy=(l,t,n,c,d,p,_,v,w,I,C,O)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:I,u_fade_t:C.mix,u_opacity:C.opacity,u_image0:0,u_image1:1,u_raster_elevation:O,u_zoom_transition:_,u_merc_center:v,u_cutoff_params:w}),Ty=(l,t,n,c,d,p,_,v,w,I)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_tile_offset:n,u_velocity:c,u_color_ramp:p,u_velocity_res:d,u_max_speed:_,u_uv_offset:v,u_data_scale:[255*w[0],255*w[1]],u_data_offset:I,u_particle_pos_scale:1.1,u_particle_pos_offset:[Xs,Xs]}),Qm=(l,t,n,c,d,p,_,v,w,I)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_velocity:n,u_velocity_res:c,u_max_speed:d,u_speed_factor:p,u_reset_rate:_,u_rand_seed:Math.random(),u_uv_offset:v,u_data_scale:[255*w[0],255*w[1]],u_data_offset:I,u_particle_pos_scale:1.1,u_particle_pos_offset:[Xs,Xs]}),e_=o.bC(),Uh=(l,t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H,q,Y,te,J,_e,he,pe)=>{const ce=d.transform,se={u_is_size_zoom_constant:+(l==="constant"||l==="source"),u_is_size_feature_constant:+(l==="constant"||l==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:ce.getCameraToCenterDistance(Y),u_rotate_symbol:+n,u_aspect_ratio:ce.width/ce.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:p,u_label_plane_matrix:_,u_coord_matrix:v,u_is_text:+I,u_elevation_from_sea:w?1:0,u_pitch_with_map:+c,u_texsize:C,u_texsize_icon:O,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:e_,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:e_,u_up_vector:[0,-1,0],u_color_adj_mat:_e,u_icon_transition:he||0,u_gamma_scale:c?d.transform.getCameraToCenterDistance(Y)*Math.cos(d.terrain?0:d.transform._pitch):1,u_device_pixel_ratio:o.o.devicePixelRatio,u_is_halo:1,u_scale_factor:pe||1,u_ground_shadow_factor:te,u_inv_matrix:o.bl(o.bC(),_),u_normal_scale:J,u_lutTexture:jn.LUT};return Y.name==="globe"&&(se.u_tile_id=[z.canonical.x,z.canonical.y,1<<z.canonical.z],se.u_zoom_transition=N,se.u_inv_rot_matrix=H,se.u_merc_center=B,se.u_camera_forward=ce._camera.forward(),se.u_ecef_origin=o.dV(ce.globeMatrix,z.toUnwrapped()),se.u_tile_matrix=Float32Array.from(ce.globeMatrix),se.u_up_vector=q),se},bu=(l,t,n,c)=>({u_matrix:l,u_emissive_strength:t,u_opacity:n,u_color:c}),il=(l,t,n,c,d,p,_,v,w)=>Object.assign((function(I,C,O,D,z,N){const{width:B,height:H}=D.imageManager.getPixelSize(C),q=Math.pow(2,N.tileID.overscaledZ),Y=N.tileSize*Math.pow(2,D.transform.tileZoom)/q,te=Y*(N.tileID.canonical.x+N.tileID.wrap*q),J=Y*N.tileID.canonical.y;return{u_image:0,u_pattern_tl:O.tl,u_pattern_br:O.br,u_texsize:[B,H],u_pattern_size:O.displaySize,u_pattern_units_to_pixels:z?[D.transform.width,-1*D.transform.height]:[1/o.ay(N,1,D.transform.tileZoom),1/o.ay(N,1,D.transform.tileZoom)],u_pixel_coord_upper:[te>>16,J>>16],u_pixel_coord_lower:[65535&te,65535&J]}})(0,p,_,c,v,w),{u_matrix:l,u_emissive_strength:t,u_opacity:n}),yc=new Float32Array(o.bA([])),Fl=(l,t,n,c,d,p,_,v,w,I,C,O,D,z=[0,0,0],N,B,H)=>{const q=d.style.light,Y=q.properties.get("position"),te=[-Y.x,-Y.y,Y.z],J=o.dO();q.properties.get("anchor")==="viewport"&&(o.dP(J,-d.transform.angle),o.dQ(te,te,J));const _e=C.alphaMode==="MASK",he=q.properties.get("color").toNonPremultipliedRenderColor(null),pe=D.paint.get("model-ambient-occlusion-intensity"),ce=D.paint.get("model-color").constantOr(o.ao.white).toNonPremultipliedRenderColor(null);return ce.a=D.paint.get("model-color-mix-intensity").constantOr(0),H&&(ce.r=H[0],ce.g=H[1],ce.b=H[2],ce.a=H[3]),B&&(ce.r=B.color.r,ce.g=B.color.g,ce.b=B.color.b,ce.a=B.colorMix,O=B.emissionStrength,p*=B.opacity),{u_matrix:l,u_lighting_matrix:t,u_normal_matrix:n,u_node_matrix:c||yc,u_lightpos:te,u_lightintensity:q.properties.get("intensity"),u_lightcolor:[he.r,he.g,he.b],u_camera_pos:z,u_opacity:p,u_baseTextureIsAlpha:0,u_alphaMask:+_e,u_alphaCutoff:C.alphaCutoff,u_baseColorFactor:_.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:v.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:w,u_roughnessFactor:I,u_baseColorTexture:jn.BaseColor,u_metallicRoughnessTexture:jn.MetallicRoughness,u_normalTexture:jn.Normal,u_occlusionTexture:jn.Occlusion,u_emissionTexture:jn.Emission,u_lutTexture:jn.LUT,u_color_mix:ce.toArray01(),u_aoIntensity:pe,u_emissive_strength:O,u_occlusionTextureTransform:N||[0,0,0,0]}},Ff=(l,t=yc,n=yc)=>({u_matrix:l,u_instance:t,u_node_matrix:n}),jh={fillExtrusion:l=>({u_matrix:new o.cl(l),u_lightpos:new o.ci(l),u_lightintensity:new o.cj(l),u_lightcolor:new o.ci(l),u_vertical_gradient:new o.cj(l),u_opacity:new o.cj(l),u_edge_radius:new o.cj(l),u_width_scale:new o.cj(l),u_ao:new o.ck(l),u_height_type:new o.ch(l),u_base_type:new o.ch(l),u_tile_id:new o.ci(l),u_zoom_transition:new o.cj(l),u_inv_rot_matrix:new o.cl(l),u_merc_center:new o.ck(l),u_up_dir:new o.ci(l),u_height_lift:new o.cj(l),u_flood_light_color:new o.ci(l),u_vertical_scale:new o.cj(l),u_flood_light_intensity:new o.cj(l),u_ground_shadow_factor:new o.ci(l)}),fillExtrusionDepth:l=>({u_matrix:new o.cl(l),u_edge_radius:new o.cj(l),u_width_scale:new o.cj(l),u_vertical_scale:new o.cj(l),u_height_type:new o.ch(l),u_base_type:new o.ch(l)}),fillExtrusionPattern:l=>({u_matrix:new o.cl(l),u_lightpos:new o.ci(l),u_lightintensity:new o.cj(l),u_lightcolor:new o.ci(l),u_vertical_gradient:new o.cj(l),u_height_factor:new o.cj(l),u_edge_radius:new o.cj(l),u_width_scale:new o.cj(l),u_ao:new o.ck(l),u_height_type:new o.ch(l),u_base_type:new o.ch(l),u_tile_id:new o.ci(l),u_zoom_transition:new o.cj(l),u_inv_rot_matrix:new o.cl(l),u_merc_center:new o.ck(l),u_up_dir:new o.ci(l),u_height_lift:new o.cj(l),u_image:new o.ch(l),u_texsize:new o.ck(l),u_pixel_coord_upper:new o.ck(l),u_pixel_coord_lower:new o.ck(l),u_tile_units_to_pixels:new o.cj(l),u_opacity:new o.cj(l),u_pattern_transition:new o.cj(l)}),fillExtrusionGroundEffect:l=>({u_matrix:new o.cl(l),u_opacity:new o.cj(l),u_ao_pass:new o.cj(l),u_meter_to_tile:new o.cj(l),u_ao:new o.ck(l),u_flood_light_intensity:new o.cj(l),u_flood_light_color:new o.ci(l),u_attenuation:new o.cj(l),u_edge_radius:new o.cj(l),u_fb:new o.ch(l),u_fb_size:new o.cj(l),u_dynamic_offset:new o.cj(l)}),fill:l=>({u_matrix:new o.cl(l),u_emissive_strength:new o.cj(l),u_ground_shadow_factor:new o.ci(l)}),fillPattern:l=>({u_matrix:new o.cl(l),u_emissive_strength:new o.cj(l),u_image:new o.ch(l),u_texsize:new o.ck(l),u_pixel_coord_upper:new o.ck(l),u_pixel_coord_lower:new o.ck(l),u_tile_units_to_pixels:new o.cj(l),u_ground_shadow_factor:new o.ci(l),u_pattern_transition:new o.cj(l)}),fillOutline:l=>({u_matrix:new o.cl(l),u_emissive_strength:new o.cj(l),u_world:new o.ck(l),u_ground_shadow_factor:new o.ci(l)}),fillOutlinePattern:l=>({u_matrix:new o.cl(l),u_emissive_strength:new o.cj(l),u_world:new o.ck(l),u_image:new o.ch(l),u_texsize:new o.ck(l),u_pixel_coord_upper:new o.ck(l),u_pixel_coord_lower:new o.ck(l),u_tile_units_to_pixels:new o.cj(l),u_ground_shadow_factor:new o.ci(l),u_pattern_transition:new o.cj(l)}),building:l=>({u_matrix:new o.cl(l),u_normal_matrix:new o.cl(l),u_opacity:new o.cj(l),u_faux_facade_ao_intensity:new o.cj(l),u_camera_pos:new o.ci(l),u_tile_to_meter:new o.cj(l),u_facade_emissive_chance:new o.cj(l),u_flood_light_color:new o.ci(l),u_flood_light_intensity:new o.cj(l)}),buildingBloom:l=>({u_matrix:new o.cl(l)}),buildingDepth:l=>({u_matrix:new o.cl(l)}),elevatedStructuresDepth:l=>({u_matrix:new o.cl(l),u_depth_bias:new o.cj(l)}),elevatedStructures:l=>({u_matrix:new o.cl(l),u_ground_shadow_factor:new o.ci(l)}),elevatedStructuresDepthReconstruct:l=>({u_matrix:new o.cl(l),u_camera_pos:new o.ci(l),u_depth_bias:new o.cj(l),u_height_scale:new o.cj(l),u_reset_depth:new o.cj(l)}),circle:o.dY,collisionBox:l=>({u_matrix:new o.cl(l),u_inv_rot_matrix:new o.cl(l),u_camera_to_center_distance:new o.cj(l),u_extrude_scale:new o.ck(l),u_zoom_transition:new o.cj(l),u_merc_center:new o.ck(l),u_tile_id:new o.ci(l)}),collisionCircle:l=>({u_matrix:new o.cl(l),u_inv_matrix:new o.cl(l),u_camera_to_center_distance:new o.cj(l),u_viewport_size:new o.ck(l)}),debug:l=>({u_color:new o.dB(l),u_matrix:new o.cl(l),u_overlay:new o.ch(l),u_overlay_scale:new o.cj(l)}),clippingMask:l=>({u_matrix:new o.cl(l)}),heatmap:l=>({u_extrude_scale:new o.cj(l),u_intensity:new o.cj(l),u_matrix:new o.cl(l),u_inv_rot_matrix:new o.cl(l),u_merc_center:new o.ck(l),u_tile_id:new o.ci(l),u_zoom_transition:new o.cj(l),u_up_dir:new o.ci(l)}),heatmapTexture:l=>({u_image:new o.ch(l),u_color_ramp:new o.ch(l),u_opacity:new o.cj(l)}),hillshade:l=>({u_matrix:new o.cl(l),u_image:new o.ch(l),u_latrange:new o.ck(l),u_light:new o.ck(l),u_shadow:new o.dB(l),u_highlight:new o.dB(l),u_emissive_strength:new o.cj(l),u_accent:new o.dB(l)}),hillshadePrepare:l=>({u_matrix:new o.cl(l),u_image:new o.ch(l),u_dimension:new o.ck(l),u_zoom:new o.cj(l)}),line:o.dX,linePattern:o.dW,raster:l=>({u_matrix:new o.cl(l),u_normalize_matrix:new o.cl(l),u_globe_matrix:new o.cl(l),u_merc_matrix:new o.cl(l),u_grid_matrix:new o.dC(l),u_tl_parent:new o.ck(l),u_scale_parent:new o.cj(l),u_fade_t:new o.cj(l),u_opacity:new o.cj(l),u_image0:new o.ch(l),u_image1:new o.ch(l),u_brightness_low:new o.cj(l),u_brightness_high:new o.cj(l),u_saturation_factor:new o.cj(l),u_contrast_factor:new o.cj(l),u_spin_weights:new o.ci(l),u_perspective_transform:new o.ck(l),u_raster_elevation:new o.cj(l),u_zoom_transition:new o.cj(l),u_merc_center:new o.ck(l),u_cutoff_params:new o.d3(l),u_colorization_mix:new o.d3(l),u_colorization_offset:new o.cj(l),u_color_ramp:new o.ch(l),u_texture_offset:new o.ck(l),u_texture_res:new o.ck(l),u_emissive_strength:new o.cj(l)}),rasterParticle:l=>({u_matrix:new o.cl(l),u_normalize_matrix:new o.cl(l),u_globe_matrix:new o.cl(l),u_merc_matrix:new o.cl(l),u_grid_matrix:new o.dC(l),u_tl_parent:new o.ck(l),u_scale_parent:new o.cj(l),u_fade_t:new o.cj(l),u_opacity:new o.cj(l),u_image0:new o.ch(l),u_image1:new o.ch(l),u_raster_elevation:new o.cj(l),u_zoom_transition:new o.cj(l),u_merc_center:new o.ck(l),u_cutoff_params:new o.d3(l)}),rasterParticleTexture:l=>({u_texture:new o.ch(l),u_opacity:new o.cj(l)}),rasterParticleDraw:l=>({u_particle_texture:new o.ch(l),u_particle_texture_side_len:new o.cj(l),u_tile_offset:new o.ck(l),u_velocity:new o.ch(l),u_color_ramp:new o.ch(l),u_velocity_res:new o.ck(l),u_max_speed:new o.cj(l),u_uv_offset:new o.ck(l),u_data_scale:new o.ck(l),u_data_offset:new o.cj(l),u_particle_pos_scale:new o.cj(l),u_particle_pos_offset:new o.ck(l)}),rasterParticleUpdate:l=>({u_particle_texture:new o.ch(l),u_particle_texture_side_len:new o.cj(l),u_velocity:new o.ch(l),u_velocity_res:new o.ck(l),u_max_speed:new o.cj(l),u_speed_factor:new o.cj(l),u_reset_rate:new o.cj(l),u_rand_seed:new o.cj(l),u_uv_offset:new o.ck(l),u_data_scale:new o.ck(l),u_data_offset:new o.cj(l),u_particle_pos_scale:new o.cj(l),u_particle_pos_offset:new o.ck(l)}),symbol:l=>({u_is_size_zoom_constant:new o.ch(l),u_is_size_feature_constant:new o.ch(l),u_size_t:new o.cj(l),u_size:new o.cj(l),u_camera_to_center_distance:new o.cj(l),u_rotate_symbol:new o.ch(l),u_aspect_ratio:new o.cj(l),u_fade_change:new o.cj(l),u_matrix:new o.cl(l),u_label_plane_matrix:new o.cl(l),u_coord_matrix:new o.cl(l),u_is_text:new o.ch(l),u_elevation_from_sea:new o.ch(l),u_pitch_with_map:new o.ch(l),u_texsize:new o.ck(l),u_texsize_icon:new o.ck(l),u_texture:new o.ch(l),u_texture_icon:new o.ch(l),u_gamma_scale:new o.cj(l),u_device_pixel_ratio:new o.cj(l),u_tile_id:new o.ci(l),u_zoom_transition:new o.cj(l),u_inv_rot_matrix:new o.cl(l),u_merc_center:new o.ck(l),u_camera_forward:new o.ci(l),u_tile_matrix:new o.cl(l),u_up_vector:new o.ci(l),u_ecef_origin:new o.ci(l),u_is_halo:new o.ch(l),u_icon_transition:new o.cj(l),u_color_adj_mat:new o.cl(l),u_scale_factor:new o.cj(l),u_ground_shadow_factor:new o.ci(l),u_inv_matrix:new o.cl(l),u_normal_scale:new o.cj(l),u_lutTexture:new o.ch(l)}),background:l=>({u_matrix:new o.cl(l),u_emissive_strength:new o.cj(l),u_opacity:new o.cj(l),u_color:new o.dB(l)}),backgroundPattern:l=>({u_matrix:new o.cl(l),u_emissive_strength:new o.cj(l),u_opacity:new o.cj(l),u_image:new o.ch(l),u_pattern_tl:new o.ck(l),u_pattern_br:new o.ck(l),u_texsize:new o.ck(l),u_pattern_size:new o.ck(l),u_pixel_coord_upper:new o.ck(l),u_pixel_coord_lower:new o.ck(l),u_pattern_units_to_pixels:new o.ck(l)}),terrainRaster:l=>({u_matrix:new o.cl(l),u_image0:new o.ch(l),u_image1:new o.ch(l),u_skirt_height:new o.cj(l),u_ground_shadow_factor:new o.ci(l),u_emissive_texture_available:new o.cj(l)}),skybox:l=>({u_matrix:new o.cl(l),u_sun_direction:new o.ci(l),u_cubemap:new o.ch(l),u_opacity:new o.cj(l),u_temporal_offset:new o.cj(l)}),skyboxGradient:l=>({u_matrix:new o.cl(l),u_color_ramp:new o.ch(l),u_center_direction:new o.ci(l),u_radius:new o.cj(l),u_opacity:new o.cj(l),u_temporal_offset:new o.cj(l)}),skyboxCapture:l=>({u_matrix_3f:new o.dC(l),u_sun_direction:new o.ci(l),u_sun_intensity:new o.cj(l),u_color_tint_r:new o.d3(l),u_color_tint_m:new o.d3(l),u_luminance:new o.cj(l)}),globeRaster:l=>({u_proj_matrix:new o.cl(l),u_globe_matrix:new o.cl(l),u_normalize_matrix:new o.cl(l),u_merc_matrix:new o.cl(l),u_zoom_transition:new o.cj(l),u_merc_center:new o.ck(l),u_image0:new o.ch(l),u_image1:new o.ch(l),u_grid_matrix:new o.dC(l),u_skirt_height:new o.cj(l),u_far_z_cutoff:new o.cj(l),u_frustum_tl:new o.ci(l),u_frustum_tr:new o.ci(l),u_frustum_br:new o.ci(l),u_frustum_bl:new o.ci(l),u_globe_pos:new o.ci(l),u_globe_radius:new o.cj(l),u_viewport:new o.ck(l),u_emissive_texture_available:new o.cj(l)}),globeAtmosphere:l=>({u_frustum_tl:new o.ci(l),u_frustum_tr:new o.ci(l),u_frustum_br:new o.ci(l),u_frustum_bl:new o.ci(l),u_horizon:new o.cj(l),u_transition:new o.cj(l),u_fadeout_range:new o.cj(l),u_atmosphere_fog_color:new o.d3(l),u_high_color:new o.d3(l),u_space_color:new o.d3(l),u_temporal_offset:new o.cj(l),u_horizon_angle:new o.cj(l)}),model:l=>({u_matrix:new o.cl(l),u_lighting_matrix:new o.cl(l),u_normal_matrix:new o.cl(l),u_node_matrix:new o.cl(l),u_lightpos:new o.ci(l),u_lightintensity:new o.cj(l),u_lightcolor:new o.ci(l),u_camera_pos:new o.ci(l),u_opacity:new o.cj(l),u_baseColorFactor:new o.d3(l),u_emissiveFactor:new o.d3(l),u_metallicFactor:new o.cj(l),u_roughnessFactor:new o.cj(l),u_baseTextureIsAlpha:new o.ch(l),u_alphaMask:new o.ch(l),u_alphaCutoff:new o.cj(l),u_baseColorTexture:new o.ch(l),u_metallicRoughnessTexture:new o.ch(l),u_normalTexture:new o.ch(l),u_occlusionTexture:new o.ch(l),u_emissionTexture:new o.ch(l),u_lutTexture:new o.ch(l),u_color_mix:new o.d3(l),u_aoIntensity:new o.cj(l),u_emissive_strength:new o.cj(l),u_occlusionTextureTransform:new o.d3(l)}),modelDepth:l=>({u_matrix:new o.cl(l),u_instance:new o.cl(l),u_node_matrix:new o.cl(l)}),groundShadow:l=>({u_matrix:new o.cl(l),u_ground_shadow_factor:new o.ci(l)}),stars:l=>({u_matrix:new o.cl(l),u_up:new o.ci(l),u_right:new o.ci(l),u_intensity_multiplier:new o.cj(l)}),snowParticle:l=>({u_modelview:new o.cl(l),u_projection:new o.cl(l),u_time:new o.cj(l),u_cam_pos:new o.ci(l),u_velocityConeAperture:new o.cj(l),u_velocity:new o.cj(l),u_horizontalOscillationRadius:new o.cj(l),u_horizontalOscillationRate:new o.cj(l),u_boxSize:new o.cj(l),u_billboardSize:new o.cj(l),u_simpleShapeParameters:new o.ck(l),u_screenSize:new o.ck(l),u_thinningCenterPos:new o.ck(l),u_thinningShape:new o.ci(l),u_thinningAffectedRatio:new o.cj(l),u_thinningParticleOffset:new o.cj(l),u_particleColor:new o.d3(l),u_direction:new o.ci(l)}),rainParticle:l=>({u_modelview:new o.cl(l),u_projection:new o.cl(l),u_time:new o.cj(l),u_cam_pos:new o.ci(l),u_texScreen:new o.ch(l),u_velocityConeAperture:new o.cj(l),u_velocity:new o.cj(l),u_boxSize:new o.cj(l),u_rainDropletSize:new o.ck(l),u_distortionStrength:new o.cj(l),u_rainDirection:new o.ci(l),u_color:new o.d3(l),u_screenSize:new o.ck(l),u_thinningCenterPos:new o.ck(l),u_thinningShape:new o.ci(l),u_thinningAffectedRatio:new o.cj(l),u_thinningParticleOffset:new o.cj(l),u_shapeDirectionalPower:new o.cj(l),u_shapeNormalPower:new o.cj(l),u_mode:new o.cj(l)}),vignette:l=>({u_vignetteShape:new o.ci(l),u_vignetteColor:new o.d3(l)}),occlusion:l=>({u_matrix:new o.cl(l),u_anchorPos:new o.ci(l),u_screenSizePx:new o.ck(l),u_occluderSizePx:new o.ck(l),u_color:new o.d3(l)})};class Ss{constructor(t,n,c,d){this.id=Ss.uniqueIdxCounter,Ss.uniqueIdxCounter++,this.context=t;const p=t.gl;this.buffer=p.createBuffer(),this.dynamicDraw=!!c,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?p.DYNAMIC_DRAW:p.STATIC_DRAW),this.dynamicDraw||d||n.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=Ss.uniqueIdxCounter,Ss.uniqueIdxCounter++;const n=this.context.gl;this.context.unbindVAO(),this.bind(),n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Ss.uniqueIdxCounter=0;const Bf={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class t_{constructor(t,n,c,d,p,_){this.length=n.length,this.attributes=c,this.itemSize=n.bytesPerElement,this.dynamicDraw=d,this.instanceCount=_,this.context=t;const v=t.gl;this.buffer=v.createBuffer(),t.bindVertexBuffer.set(this.buffer),v.bufferData(v.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?v.DYNAMIC_DRAW:v.STATIC_DRAW),this.dynamicDraw||p||n.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let c=0;c<this.attributes.length;c++){const d=n.getAttributeLocation(t,this.attributes[c].name);d!==-1&&t.enableVertexAttribArray(d)}}setVertexAttribPointers(t,n,c){for(let d=0;d<this.attributes.length;d++){const p=this.attributes[d],_=n.getAttributeLocation(t,p.name);_!==-1&&t.vertexAttribPointer(_,p.components,t[Bf[p.type]],!1,this.itemSize,p.offset+this.itemSize*(c||0))}}setVertexAttribDivisor(t,n,c){for(let d=0;d<this.attributes.length;d++){const p=n.getAttributeLocation(t,this.attributes[d].name);p!==-1&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(p,c)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class i_{constructor(t,n,c,d,p){this.context=t,this.width=n,this.height=c;const _=this.framebuffer=t.gl.createFramebuffer();d>0&&(this.colorAttachment0=new Lh(t,_,0)),d>1&&(this.colorAttachment1=new Lh(t,_,1)),p&&(this.depthAttachmentType=p,this.depthAttachment=p==="renderbuffer"?new pc(t,_):new _u(t,_))}createColorAttachment(t,n){n===0?this.colorAttachment0=new Lh(t,this.framebuffer,0):n===1&&(this.colorAttachment1=new Lh(t,this.framebuffer,1))}removeColorAttachment(t,n){const c=this.context.gl;let d;n===0?(d=this.colorAttachment0.get(),this.colorAttachment0=void 0):n===1&&(d=this.colorAttachment1.get(),this.colorAttachment1=void 0),d&&c.deleteTexture(d)}destroy(){const t=this.context.gl;if(this.colorAttachment0){const n=this.colorAttachment0.get();n&&t.deleteTexture(n)}if(this.colorAttachment1){const n=this.colorAttachment1.get();n&&t.deleteTexture(n)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const n=this.depthAttachment.get();n&&t.deleteRenderbuffer(n)}else{const n=this.depthAttachment.get();n&&t.deleteTexture(n)}t.deleteFramebuffer(this.framebuffer)}}class vc{constructor(t,n){this.gl=t,this.clearColor=new my(this),this.clearDepth=new zm(this),this.clearStencil=new xf(this),this.colorMask=new Ih(this),this.depthMask=new bf(this),this.stencilMask=new zl(this),this.stencilFunc=new uc(this),this.stencilOp=new pu(this),this.stencilTest=new hc(this),this.depthRange=new km(this),this.depthTest=new wf(this),this.depthFunc=new Fm(this),this.blend=new dc(this),this.blendFunc=new Ah(this),this.blendColor=new Ch(this),this.blendEquation=new Tf(this),this.cullFace=new Mh(this),this.cullFaceSide=new mu(this),this.frontFace=new Bm(this),this.program=new Nm(this),this.activeTexture=new Vm(this),this.viewport=new fc(this),this.bindFramebuffer=new Um(this),this.bindRenderbuffer=new _y(this),this.bindTexture=new gy(this),this.bindVertexBuffer=new yy(this),this.bindElementBuffer=new Ef(this),this.bindVertexArrayOES=new Sf(this),this.pixelStoreUnpack=new If(this),this.pixelStoreUnpackPremultiplyAlpha=new Af(this),this.pixelStoreUnpackFlipY=new jm(this),this.options=n?Object.assign({},n):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=n&&!!n.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.extBlendFuncExtended=t.getExtension("WEBGL_blend_func_extended")}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n,c){return new Ss(this,t,n,c)}createVertexBuffer(t,n,c,d,p){return new t_(this,t,n,c,d,p)}createRenderbuffer(t,n,c){const d=this.gl,p=d.createRenderbuffer();return this.bindRenderbuffer.set(p),d.renderbufferStorage(d.RENDERBUFFER,t,n,c),this.bindRenderbuffer.set(null),p}createFramebuffer(t,n,c,d){return new i_(this,t,n,c,d)}clear({color:t,depth:n,stencil:c,colorMask:d}){const p=this.gl;let _=0;t&&(_|=p.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(d||[!0,!0,!0,!0])),n!==void 0&&(_|=p.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),c!==void 0&&(_|=p.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),p.clear(_)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){o.by(t.blendFunction,_i.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Bl;function Lt(l,t,n,c,d,p,_){const v=l.context,w=v.gl,I=l.transform,C=[o.aF(I.center.lng),o.aJ(I.center.lat)],O=n.layout.get("symbol-placement"),D=n.layout.get("text-variable-anchor"),z=n.layout.get("icon-rotation-alignment")==="map",N=n.layout.get("text-rotation-alignment")==="map",B=O!=="point",H=[];let q=0,Y=0;for(let se=0;se<c.length;se++){const ye=c[se],Ce=t.getTile(ye),Se=Ce.getBucket(n);if(!Se)continue;const Ue=Se.getProjection().createInversionMatrix(I,ye.canonical),je=[],Xe=ch(ye,Se,I),ht=!_&&z&&B,ke=_&&N&&B,we=D&&Se.hasTextData(),He=Se.hasIconTextFit()&&we&&Se.hasIconData(),Be=ht||ke||_&&we||He,et=Se.projection.name==="globe",vt=et?o.aj(I.zoom):0;et&&(je.push("PROJECTION_GLOBE_VIEW"),Be&&je.push("PROJECTED_POS_ON_VIEWPORT"));const St=l.getOrCreateProgram("collisionBox",{defines:je});let _t=Xe;d[0]===0&&d[1]===0||(_t=l.translatePosMatrix(Xe,Ce,d,p));const dt=_?Se.textCollisionBox:Se.iconCollisionBox,kt=Se.collisionCircleArray;if(kt.length>0){const Tt=o.bC(),At=_t;o.cP(Tt,Se.placementInvProjMatrix,I.glCoordMatrix),o.cP(Tt,Tt,Se.placementViewportMatrix),H.push({circleArray:kt,circleOffset:Y,transform:At,invTransform:Tt,projection:Se.getProjection()}),q+=kt.length/4,Y=q}if(!dt)continue;l.terrain&&l.terrain.setupElevationDraw(Ce,St);const Dt=et?[ye.canonical.x,ye.canonical.y,1<<ye.canonical.z]:[0,0,0];St.draw(l,w.LINES,Bt.disabled,ri.disabled,l.colorModeForRenderPass(),ti.disabled,kf(_t,Ue,I,vt,C,Ce,Dt,Se.getProjection()),n.id,dt.layoutVertexBuffer,dt.indexBuffer,dt.segments,null,I.zoom,null,[dt.collisionVertexBuffer,dt.collisionVertexBufferExt])}if(!_||!H.length)return;const te=l.getOrCreateProgram("collisionCircle"),J=new o.dZ;J.resize(4*q),J._trim();let _e=0;for(const se of H)for(let ye=0;ye<se.circleArray.length/4;ye++){const Ce=4*ye,Se=se.circleArray[Ce+0],Ue=se.circleArray[Ce+1],je=se.circleArray[Ce+2],Xe=se.circleArray[Ce+3];J.emplace(_e++,Se,Ue,je,Xe,0),J.emplace(_e++,Se,Ue,je,Xe,1),J.emplace(_e++,Se,Ue,je,Xe,2),J.emplace(_e++,Se,Ue,je,Xe,3)}(!Bl||Bl.length<2*q)&&(Bl=(function(se){const ye=2*se,Ce=new o.b0;Ce.resize(ye),Ce._trim();for(let Se=0;Se<ye;Se++){const Ue=6*Se;Ce.uint16[Ue+0]=4*Se+0,Ce.uint16[Ue+1]=4*Se+1,Ce.uint16[Ue+2]=4*Se+2,Ce.uint16[Ue+3]=4*Se+2,Ce.uint16[Ue+4]=4*Se+3,Ce.uint16[Ue+5]=4*Se+0}return Ce})(q));const he=v.createIndexBuffer(Bl,!0),pe=v.createVertexBuffer(J,o.d_.members,!0);for(const se of H){const ye={u_matrix:se.transform,u_inv_matrix:se.invTransform,u_camera_to_center_distance:(ce=I).getCameraToCenterDistance(se.projection),u_viewport_size:[ce.width,ce.height]};te.draw(l,w.TRIANGLES,Bt.disabled,ri.disabled,l.colorModeForRenderPass(),ti.disabled,ye,n.id,pe,he,o.bg.simpleSegment(0,2*se.circleOffset,se.circleArray.length,se.circleArray.length/2),null,I.zoom)}var ce;pe.destroy(),he.destroy()}const wu=o.bC();function ga(l){const t=l._camera.getWorldToCamera(l.worldSize,1),n=o.aB([],t,l.globeMatrix);o.bl(n,n);const c=[0,0,0],d=[0,1,0,0];return o.aC(d,d,n),c[0]=d[0],c[1]=d[1],c[2]=d[2],o.aw(c,c),c}function rl({width:l,height:t,anchor:n,textOffset:c,textScale:d},p){const{horizontalAlign:_,verticalAlign:v}=o.c1(n),w=-(_-.5)*l,I=-(v-.5)*t,C=o.c2(n,c);return new o.P((w/d+C[0])*p,(I/d+C[1])*p)}function Yt(l,t,n,c,d,p,_,v,w,I){const C=l.text.placedSymbolArray,O=l.text.dynamicLayoutVertexArray,D=l.icon.dynamicLayoutVertexArray,z={},N=l.getProjection(),B=qs(_,N,d),H=d.elevation,q=N.upVectorScale(_.canonical,d.center.lat,d.worldSize).metersToTile;O.clear();for(let Y=0;Y<C.length;Y++){const te=C.get(Y),{tileAnchorX:J,tileAnchorY:_e,numGlyphs:he}=te,pe=te.hidden||!te.crossTileID||l.allowVerticalPlacement&&!te.placedOrientation?null:c[te.crossTileID];if(pe){let ce=0,se=0,ye=0;const Ce=l.elevationType==="road";if(H||Ce){const Be=Ce?l.getElevationFeatureForText(Y):null,et=o.bV.getAtTileOffset(_,new o.P(J,_e),H,Be),[vt,St,_t]=N.upVector(_.canonical,J,_e);ce=et*vt*q,se=et*St*q,ye=et*_t*q}let[Se,Ue,je,Xe]=rs(te.projectedAnchorX+ce,te.projectedAnchorY+se,te.projectedAnchorZ+ye,n?B:p);const ht=lr(d.getCameraToCenterDistance(N),Xe);let ke=o.bM(l.textSizeData,w,te)*ht/o.bY;n&&(ke*=l.tilePixelRatio/v);const we=rl(pe,ke);n?({x:Se,y:Ue,z:je}=N.projectTilePoint(J+we.x,_e+we.y,_.canonical),[Se,Ue,je]=rs(Se+ce,Ue+se,je+ye,p)):(t&&we._rotate(-d.angle),Se+=we.x,Ue+=we.y,je=0);const He=l.allowVerticalPlacement&&te.placedOrientation===o.bL.vertical?Math.PI/2:0;for(let Be=0;Be<he;Be++)o.bO(O,Se,Ue,je,He);I&&te.associatedIconIndex>=0&&(z[te.associatedIconIndex]={x:Se,y:Ue,z:je,angle:He})}else ws(he,O)}if(I){D.clear();const Y=l.icon.placedSymbolArray;for(let te=0;te<Y.length;te++){const J=Y.get(te),{numGlyphs:_e}=J,he=z[te];if(J.hidden||!he)ws(_e,D);else{const{x:pe,y:ce,z:se,angle:ye}=he;for(let Ce=0;Ce<_e;Ce++)o.bO(D,pe,ce,se,ye)}}l.icon.dynamicLayoutVertexBuffer.updateData(D)}l.text.dynamicLayoutVertexBuffer.updateData(O)}function Tu(l,t,n,c,d,p,_={}){const v=n.paint.get("icon-translate"),w=n.paint.get("text-translate"),I=n.paint.get("icon-translate-anchor"),C=n.paint.get("text-translate-anchor"),O=n.layout.get("icon-rotation-alignment"),D=n.layout.get("text-rotation-alignment"),z=n.layout.get("icon-pitch-alignment"),N=n.layout.get("text-pitch-alignment"),B=n.layout.get("icon-keep-upright"),H=n.layout.get("text-keep-upright"),q=n.paint.get("icon-color-saturation"),Y=n.paint.get("icon-color-contrast"),te=n.paint.get("icon-color-brightness-min"),J=n.paint.get("icon-color-brightness-max"),_e=n.layout.get("symbol-elevation-reference")==="sea",he=n.layout.get("icon-image-use-theme")==="none",pe=l.context,ce=pe.gl,se=l.transform,ye=O==="map",Ce=D==="map",Se=z==="map",Ue=N==="map",je=n.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Xe=!1;const ht=l.depthModeForSublayer(0,Bt.ReadOnly),ke=new Bt(l.context.gl.LEQUAL,Bt.ReadOnly,l.depthRangeFor3D),we=[o.aF(se.center.lng),o.aJ(se.center.lat)],He=n.layout.get("text-variable-anchor"),Be=se.projection.name==="globe",et=[],vt=[0,-1,0];for(const St of c){const _t=t.getTile(St),dt=_t.getBucket(n);if(!dt||dt.projection.name==="mercator"&&Be||dt.fullyClipped)continue;const kt=dt.projection.name==="globe",Dt=kt?o.aj(se.zoom):0,Tt=qs(St,dt.getProjection(),se),At=se.calculatePixelsToTileUnitsMatrix(_t),Wt=He&&dt.hasTextData(),ci=dt.hasIconTextFit()&&Wt&&dt.hasIconData(),Di=dt.getProjection().createInversionMatrix(se,St.canonical),er=(1<<_t.tileID.canonical.z)*o.al/l.transform.worldSize,Ft=or=>{let Gi=[0,0,0];if(or){const xi=l.style.directionalLight,Mr=l.style.ambientLight;xi&&Mr&&(Gi=ma(l.style,xi,Mr))}return Gi},Ji=or=>{se.depthOcclusionForSymbolsAndCircles&&(n.hasOcclusionOpacityProperties||l.terrain)&&(or.push("DEPTH_D24"),or.push("DEPTH_OCCLUSION"))},ai=or=>{n.lut&&!he&&(n.lut.texture||(n.lut.texture=new o.d$(l.context,n.lut.image,[n.lut.image.height,n.lut.image.height,n.lut.image.height],pe.gl.RGBA8)),pe.activeTexture.set(pe.gl.TEXTURE0+jn.LUT),n.lut.texture&&n.lut.texture.bind(pe.gl.LINEAR,pe.gl.CLAMP_TO_EDGE),or.push("APPLY_LUT_ON_GPU"))},nr=()=>{const or=ye&&n.layout.get("symbol-placement")!=="point",Gi=[];Ji(Gi),ai(Gi);const xi=or||ci,Mr=dt.elevationType==="road",sn=l.shadowRenderer,Br=Mr&&Se&&!!sn&&sn.enabled,vr=Ft(Br),mo=Mr&&Se&&!l.terrain?ke:ht,Xn=n.paint.get("icon-image-cross-fade");l.terrainRenderModeElevated()&&Se&&Gi.push("PITCH_WITH_MAP_TERRAIN"),kt&&(Gi.push("PROJECTION_GLOBE_VIEW"),xi&&Gi.push("PROJECTED_POS_ON_VIEWPORT")),Xn>0&&dt.hasAnySecondaryIcon&&Gi.push("ICON_TRANSITION"),!dt.icon.zOffsetVertexBuffer||Mr&&l.terrain||Gi.push("Z_OFFSET"),q===0&&Y===0&&te===0&&J===1||Gi.push("COLOR_ADJUSTMENT"),dt.sdfIcons&&Gi.push("RENDER_SDF"),Br&&Gi.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Mr&&Se&&!l.terrain&&dt.icon.orientationVertexBuffer&&Gi.push("ELEVATED_ROADS");const wn=dt.icon.programConfigurations.get(n.id),to=l.getOrCreateProgram("symbol",{config:wn,defines:Gi}),io=_t.imageAtlasTexture?_t.imageAtlasTexture.size:[0,0],$n=dt.iconSizeData,Zo=o.bK($n,se.zoom),hs=Se||!se.isOrthographic,So=so(Tt,_t.tileID.canonical,Se,ye,se,dt.getProjection(),At),tn=nu(Tt,_t.tileID.canonical,Se,ye,se,dt.getProjection(),At),ln=l.translatePosMatrix(tn,_t,v,I,!0),xr=l.translatePosMatrix(Tt,_t,v,I),dn=xi?wu:So,Wr=ye&&!Se&&!or;let Nr=vt;!Be&&!se.mercatorFromTransition||ye||(Nr=ga(se));const ds=kt?Nr:vt,zu=n.getColorAdjustmentMatrix(q,Y,te,J),Cs=Uh($n.kind,Zo,Wr,Se,l,xr,dn,ln,_e,!1,io,[0,0],0,St,Dt,we,Di,ds,dt.getProjection(),vr,er,zu,Xn,null),ku=_t.imageAtlasTexture?_t.imageAtlasTexture:null,Cc=n.layout.get("icon-size").constantOr(0)!==1||dt.iconsNeedLinear,ea=dt.sdfIcons||l.options.rotating||l.options.zooming||Cc||hs?ce.LINEAR:ce.NEAREST,Ia=dt.sdfIcons&&n.paint.get("icon-halo-width").constantOr(1)!==0,Mc=l.terrain&&Se&&or?o.bl(o.bC(),So):wu;if(or&&dt.icon){const ll=o.bV.getAtTileOffsetFunc(St,se.center.lat,se.worldSize,dt.getProjection()),Aa=uh(Tt,_t.tileID.canonical,Se,ye,se,dt.getProjection(),At),Ms=n.layout.get("icon-size-scale-range"),Ca=o.aA(l.scaleFactor,Ms[0],Ms[1]);Im(dt,Tt,l,!1,Aa,tn,Se,B,ll,St,Ca)}return{program:to,buffers:dt.icon,uniformValues:Cs,atlasTexture:ku,atlasTextureIcon:null,atlasInterpolation:ea,atlasInterpolationIcon:null,isSDF:dt.sdfIcons,hasHalo:Ia,depthMode:mo,tile:_t,renderWithShadows:Br,labelPlaneMatrixInv:Mc}},fr=()=>{const or=Ce&&n.layout.get("symbol-placement")!=="point",Gi=[],xi=or||He||ci,Mr=dt.elevationType==="road",sn=l.shadowRenderer,Br=Mr&&Ue&&!!sn&&sn.enabled,vr=Ft(Br),mo=Mr&&Ue&&!l.terrain?ke:ht;l.terrainRenderModeElevated()&&Ue&&Gi.push("PITCH_WITH_MAP_TERRAIN"),kt&&(Gi.push("PROJECTION_GLOBE_VIEW"),xi&&Gi.push("PROJECTED_POS_ON_VIEWPORT")),!dt.text.zOffsetVertexBuffer||Mr&&l.terrain||Gi.push("Z_OFFSET"),dt.iconsInText&&Gi.push("RENDER_TEXT_AND_SYMBOL"),Gi.push("RENDER_SDF"),Br&&Gi.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Mr&&Ue&&!l.terrain&&dt.text.orientationVertexBuffer&&Gi.push("ELEVATED_ROADS"),Ji(Gi);const Xn=dt.text.programConfigurations.get(n.id),wn=l.getOrCreateProgram("symbol",{config:Xn,defines:Gi});let to,io=[0,0],$n=null;const Zo=dt.textSizeData;dt.iconsInText&&(io=_t.imageAtlasTexture?_t.imageAtlasTexture.size:[0,0],$n=_t.imageAtlasTexture?_t.imageAtlasTexture:null,to=Ue||!se.isOrthographic||l.options.rotating||l.options.zooming||Zo.kind==="composite"||Zo.kind==="camera"?ce.LINEAR:ce.NEAREST);const hs=_t.glyphAtlasTexture?_t.glyphAtlasTexture.size:[0,0],So=n.layout.get("text-size-scale-range"),tn=o.aA(l.scaleFactor,So[0],So[1]),ln=o.bK(Zo,se.zoom,tn),xr=so(Tt,_t.tileID.canonical,Ue,Ce,se,dt.getProjection(),At),dn=nu(Tt,_t.tileID.canonical,Ue,Ce,se,dt.getProjection(),At),Wr=l.translatePosMatrix(dn,_t,w,C,!0),Nr=l.translatePosMatrix(Tt,_t,w,C),ds=xi?wu:xr,zu=Ce&&!Ue&&!or;let Cs=vt;!Be&&!se.mercatorFromTransition||Ce||(Cs=ga(se));const ku=Uh(Zo.kind,ln,zu,Ue,l,Nr,ds,Wr,_e,!0,hs,io,0,St,Dt,we,Di,kt?Cs:vt,dt.getProjection(),vr,er,null,null,tn),Cc=_t.glyphAtlasTexture?_t.glyphAtlasTexture:null,ea=ce.LINEAR,Ia=n.paint.get("text-halo-width").constantOr(1)!==0,Mc=l.terrain&&Ue&&or?o.bl(o.bC(),xr):wu;if(or&&dt.text){const ll=o.bV.getAtTileOffsetFunc(St,se.center.lat,se.worldSize,dt.getProjection()),Aa=uh(Tt,_t.tileID.canonical,Ue,Ce,se,dt.getProjection(),At);Im(dt,Tt,l,!0,Aa,dn,Ue,H,ll,St,tn)}return{program:wn,buffers:dt.text,uniformValues:ku,atlasTexture:Cc,atlasTextureIcon:$n,atlasInterpolation:ea,atlasInterpolationIcon:to,isSDF:!0,hasHalo:Ia,depthMode:mo,tile:_t,renderWithShadows:Br,labelPlaneMatrixInv:Mc}},cr=dt.icon.segments.get().length,Xi=dt.text.segments.get().length,vi=cr&&!_.onlyText?nr():null,ir=Xi&&!_.onlyIcons?fr():null,$r=n.paint.get("icon-opacity").constantOr(1),Rr=n.paint.get("text-opacity").constantOr(1);if(je&&dt.canOverlap){Xe=!0;const or=$r&&!_.onlyText?dt.icon.segments.get():[],Gi=Rr&&!_.onlyIcons?dt.text.segments.get():[];for(const xi of or)et.push({segments:new o.bg([xi]),sortKey:xi.sortKey,state:vi});for(const xi of Gi)et.push({segments:new o.bg([xi]),sortKey:xi.sortKey,state:ir})}else _.onlyText||et.push({segments:$r?dt.icon.segments:new o.bg([]),sortKey:0,state:vi}),_.onlyIcons||et.push({segments:Rr?dt.text.segments:new o.bg([]),sortKey:0,state:ir})}Xe&&et.sort(((St,_t)=>St.sortKey-_t.sortKey));for(const St of et){const _t=St.state;if(_t)if(l.terrain?l.terrain.setupElevationDraw(_t.tile,_t.program,{useDepthForOcclusion:se.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:_t.labelPlaneMatrixInv}):l.setupDepthForOcclusion(se.depthOcclusionForSymbolsAndCircles,_t.program),pe.activeTexture.set(ce.TEXTURE0),_t.atlasTexture&&_t.atlasTexture.bind(_t.atlasInterpolation,ce.CLAMP_TO_EDGE,!0),_t.atlasTextureIcon&&(pe.activeTexture.set(ce.TEXTURE1),_t.atlasTextureIcon&&_t.atlasTextureIcon.bind(_t.atlasInterpolationIcon,ce.CLAMP_TO_EDGE,!0)),_t.renderWithShadows&&l.shadowRenderer.setupShadows(_t.tile.tileID.toUnwrapped(),_t.program,"vector-tile"),l.uploadCommonLightUniforms(l.context,_t.program),_t.hasHalo){const dt=_t.uniformValues;dt.u_is_halo=1,Nf(_t.buffers,St.segments,n,l,_t.program,_t.depthMode,d,p,dt,2),dt.u_is_halo=0}else{if(_t.isSDF){const dt=_t.uniformValues;_t.hasHalo&&(dt.u_is_halo=1,Nf(_t.buffers,St.segments,n,l,_t.program,_t.depthMode,d,p,dt,1)),dt.u_is_halo=0}Nf(_t.buffers,St.segments,n,l,_t.program,_t.depthMode,d,p,_t.uniformValues,1)}}}function Nf(l,t,n,c,d,p,_,v,w,I){const C=[l.dynamicLayoutVertexBuffer,l.opacityVertexBuffer,l.iconTransitioningVertexBuffer,l.globeExtVertexBuffer,l.zOffsetVertexBuffer,l.orientationVertexBuffer];d.draw(c,c.context.gl.TRIANGLES,p,_,v,ti.disabled,w,n.id,l.layoutVertexBuffer,l.indexBuffer,t,n.paint,c.transform.zoom,l.programConfigurations.get(n.id),C,I)}function r_(l,t){const n=1<<l.canonical.z,c=(t.x*n-l.canonical.x-l.wrap*n)*o.al,d=(t.y*n-l.canonical.y)*o.al,p=o.e8(t.z,t.y);return o.d5(c,d,p)}function Gh(l,t,n,c,d){if(!n.layout||n.layout.get("fill-elevation-reference")==="none"||n.paint.get("fill-opacity").constantOr(1)===0)return;const p=l.context.gl,_=new Bt(l.context.gl.LEQUAL,Bt.ReadWrite,l.depthRangeFor3D),v=new Bt(l.context.gl.GREATER,Bt.ReadWrite,l.depthRangeFor3D),w=(function(z){let N=.01;return z.isOrthographic&&(N=o.ak(1e-4,N,o.d0(z.pitch>=Es?1:z.pitch/Es))),2*N})(l.transform),I=l.transform.getFreeCameraOptions().position,C="elevatedStructuresDepthReconstruct",O=l.getOrCreateProgram(C,{defines:["DEPTH_RECONSTRUCTION"]}),D=l.getOrCreateProgram(C);for(const z of c){const N=t.getTile(z),B=N.getBucket(n);if(!B)continue;const H=B.elevatedStructures;if(!H)continue;const q=B.elevationBufferData.heightRange,Y=r_(z.toUnwrapped(),I),te=l.translatePosMatrix(z.projMatrix,N,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));let J,_e,he,pe;if(d==="initialize"){if(!q||q.min>=1||H.depthSegments.segments[0].primitiveLength===0)continue;J=kl(te,Y,w,1,0),_e=_,he=H.depthSegments,pe=O}else if(d==="reset"){if(!q||q.min>=0||H.maskSegments.segments[0].primitiveLength===0)continue;J=kl(te,Y,0,0,1),_e=v,he=H.maskSegments,pe=O}else if(d==="geometry"){if(H.depthSegments.segments[0].primitiveLength===0)continue;J=kl(te,Y,w,1,0),_e=_,he=H.depthSegments,pe=D}pe.draw(l,p.TRIANGLES,_e,ri.disabled,_i.disabled,ti.disabled,J,n.id,H.vertexBuffer,H.indexBuffer,he,n.paint,l.transform.zoom)}}function qh(l,t,n,c){const{painter:d,sourceCache:p,layer:_,coords:v,colorMode:w,elevationType:I,terrainEnabled:C,pass:O}=l,D=d.context.gl,z=_.paint.get("fill-pattern"),N=_.paint.get("fill-pattern-cross-fade"),B=z.constantOr(null);let H=I;I!=="road"||t&&!C||(H="none");const q=H==="road",Y=l.painter.shadowRenderer,te=q&&!!Y&&Y.enabled,J=new Bt(d.context.gl.LEQUAL,Bt.ReadOnly,d.depthRangeFor3D);let _e=[0,0,0];if(te){const se=d.style.directionalLight,ye=d.style.ambientLight;se&&ye&&(_e=ma(d.style,se,ye))}const he=z&&z.constantOr(1),pe=d.terrain&&d.terrain.renderingToTexture,ce=(se,ye)=>{let Ce,Se,Ue,je,Xe;ye?(Ce=he&&!_.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Ue=D.LINES):(Ce=he?"fillPattern":"fill",Ue=D.TRIANGLES);for(const ht of v){const ke=p.getTile(ht);if(he&&!ke.patternsLoaded())continue;const we=ke.getBucket(_);if(!we)continue;const He=t?we.elevationBufferData:we.bufferData;if(He.isEmpty())continue;d.prepareDrawTile();const Be=He.programConfigurations.get(_.id),et=d.isTileAffectedByFog(ht),vt=[],St=[];q&&(vt.push("ELEVATED_ROADS"),St.push(He.elevatedLayoutVertexBuffer)),te&&vt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),pe&&n&&vt.push("USE_MRT1"),he&&(d.context.activeTexture.set(D.TEXTURE0),ke.imageAtlasTexture&&ke.imageAtlasTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),Be.updatePaintBuffers());let _t=!1;if(B&&ke.imageAtlas){const At=ke.imageAtlas,Wt=o.e3.from(B),ci=Wt.getPrimary().scaleSelf(o.o.devicePixelRatio).toString(),Di=Wt.getSecondary(),er=At.patternPositions.get(ci),Ft=Di?At.patternPositions.get(Di.scaleSelf(o.o.devicePixelRatio).toString()):null;_t=!!er&&!!Ft,er&&Be.setConstantPatternPositions(er,Ft)}N>0&&(_t||Be.getPatternTransitionVertexBuffer("fill-pattern"))&&vt.push("FILL_PATTERN_TRANSITION");const dt=d.getOrCreateProgram(Ce,{config:Be,overrideFog:et,defines:vt}),kt=d.translatePosMatrix(ht.projMatrix,ke,_.paint.get("fill-translate"),_.paint.get("fill-translate-anchor"));te&&Y.setupShadows(ke.tileID.toUnwrapped(),dt,"vector-tile");const Dt=_.paint.get("fill-emissive-strength");if(ye){je=He.lineIndexBuffer,Xe=He.lineSegments;const At=d.terrain&&d.terrain.renderingToTexture?d.terrain.drapeBufferSize:[D.drawingBufferWidth,D.drawingBufferHeight];Se=Ce==="fillOutlinePattern"&&he?zf(kt,Dt,d,ke,At,_e,N):$m(kt,Dt,At,_e)}else je=He.indexBuffer,Xe=He.triangleSegments,Se=he?Of(kt,Dt,d,ke,_e,N):Df(kt,Dt,_e);d.uploadCommonUniforms(d.context,dt,ht.toUnwrapped());let Tt=se;(I==="road"&&!C||I==="offset")&&(Tt=J),dt.draw(d,Ue,Tt,c||d.stencilModeForClipping(ht),w,ti.disabled,Se,_.id,He.layoutVertexBuffer,je,Xe,_.paint,d.transform.zoom,Be,St)}};d.renderPass===O&&ce(d.depthModeForSublayer(1,d.renderPass==="opaque"?Bt.ReadWrite:Bt.ReadOnly),!1),H==="none"&&d.renderPass==="translucent"&&_.paint.get("fill-antialias")&&ce(d.depthModeForSublayer(_.getPaintProperty("fill-outline-color")?2:0,Bt.ReadOnly),!0)}function Hh(l,t,n,c,d,p,_,v){n.resetLayerRenderingStats(l);const w=l.context,I=w.gl,C=l.transform,O=n.paint.get("fill-extrusion-pattern"),D=n.paint.get("fill-extrusion-pattern-cross-fade"),z=O.constantOr(null),N=O.constantOr(1),B=n.paint.get("fill-extrusion-opacity"),H=l.style.enable3dLights(),q=n.paint.get(H&&!N?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Y=[n.paint.get("fill-extrusion-ambient-occlusion-intensity"),q],te=n.layout.get("fill-extrusion-edge-radius"),J=te>0&&!n.paint.get("fill-extrusion-rounded-roof"),_e=J?0:te,he=C.projection.name==="globe"?o.eb():0,pe=C.projection.name==="globe",ce=pe?o.aj(C.zoom):0,se=[o.aF(C.center.lng),o.aJ(C.center.lat)],ye=n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Ce=n.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(ye?null:n.lut).toArray01().slice(0,3),Se=n.paint.get("fill-extrusion-flood-light-intensity"),Ue=n.paint.get("fill-extrusion-vertical-scale"),je=n.paint.get("fill-extrusion-line-width").constantOr(1)!==0,Xe=n.paint.get("fill-extrusion-height-alignment"),ht=n.paint.get("fill-extrusion-base-alignment"),ke=Wa(l,n.paint.get("fill-extrusion-cutoff-fade-range")),we=[];let He;pe&&we.push("PROJECTION_GLOBE_VIEW"),Y[0]>0&&we.push("FAUX_AO"),J&&we.push("ZERO_ROOF_RADIUS"),v&&we.push("HAS_CENTROID"),Se>0&&we.push("FLOOD_LIGHT"),ke.shouldRenderCutoff&&we.push("RENDER_CUTOFF"),je&&we.push("RENDER_WALL_MODE");const Be=l.renderPass==="shadow",et=l.shadowRenderer,vt=Be&&!!et,St=Be?ti.disabled:ti.backCCW;l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0);let _t=[0,0,0];if(et){const Dt=l.style.directionalLight,Tt=l.style.ambientLight;Dt&&Tt&&(_t=ma(l.style,Dt,Tt)),Be||(we.push("RENDER_SHADOWS","DEPTH_TEXTURE"),et.useNormalOffset&&we.push("NORMAL_OFFSET")),He=we.concat(["SHADOWS_SINGLE_CASCADE"])}const dt=vt?"fillExtrusionDepth":N?"fillExtrusionPattern":"fillExtrusion",kt=n.getLayerRenderingStats();for(const Dt of c){const Tt=t.getTile(Dt),At=Tt.getBucket(n);if(!At||At.projection.name!==C.projection.name)continue;let Wt=!1;et&&(Wt=et.getMaxCascadeForTile(Dt.toUnwrapped())===0);const ci=l.isTileAffectedByFog(Dt),Di=At.programConfigurations.get(n.id);let er=!1;if(z&&Tt.imageAtlas){const Xi=Tt.imageAtlas,vi=o.e3.from(z),ir=vi.getPrimary().scaleSelf(o.o.devicePixelRatio).toString(),$r=vi.getSecondary(),Rr=Xi.patternPositions.get(ir),or=$r?Xi.patternPositions.get($r.scaleSelf(o.o.devicePixelRatio).toString()):null;er=!!Rr&&!!or,Rr&&Di.setConstantPatternPositions(Rr,or)}D>0&&(er||Di.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&we.push("FILL_EXTRUSION_PATTERN_TRANSITION");const Ft=l.getOrCreateProgram(dt,{config:Di,defines:Wt?He:we,overrideFog:ci});if(l.terrain&&l.terrain.setupElevationDraw(Tt,Ft,{useMeterToDem:!0}),!At.centroidVertexBuffer){const Xi=Ft.getAttributeLocation(I,"a_centroid_pos");Xi!==-1&&I.vertexAttrib2f(Xi,0,0)}!Be&&et&&et.setupShadows(Tt.tileID.toUnwrapped(),Ft,"vector-tile"),N&&(l.context.activeTexture.set(I.TEXTURE0),Tt.imageAtlasTexture&&Tt.imageAtlasTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),Di.updatePaintBuffers());const Ji=n.paint.get("fill-extrusion-vertical-gradient"),ai=1/At.tileToMeter;let nr;if(Be&&et){if(va(Tt.tileID,At.maxHeight,l))continue;const Xi=et.calculateShadowPassMatrixFromTile(Tt.tileID.toUnwrapped());nr=Rf(Xi,_e,ai,Ue,Xe,ht)}else{const Xi=l.translatePosMatrix(Dt.expandedProjMatrix,Tt,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),vi=C.projection.createInversionMatrix(C,Dt.canonical);nr=N?Zm(Xi,l,Ji,B,Y,_e,ai,Dt,Tt,he,Xe,ht,ce,se,vi,Ce,Ue,D):Fh(Xi,l,Ji,B,Y,_e,ai,Dt,he,Xe,ht,ce,se,vi,Ce,Ue,Se,_t)}l.uploadCommonUniforms(w,Ft,Dt.toUnwrapped(),null,ke);let fr=At.segments;if(C.projection.name==="mercator"&&!Be&&(fr=At.getVisibleSegments(Tt.tileID,l.terrain,l.transform.getFrustum(0)),!fr.get().length))continue;if(kt)if(Be)for(const Xi of fr.get())kt.numRenderedVerticesInShadowPass+=Xi.primitiveLength;else for(const Xi of fr.get())kt.numRenderedVerticesInTransparentPass+=Xi.primitiveLength;const cr=[];(l.terrain||v)&&cr.push(At.centroidVertexBuffer),pe&&cr.push(At.layoutVertexExtBuffer),je&&cr.push(At.wallVertexBuffer),Ft.draw(l,w.gl.TRIANGLES,d,p,_,St,nr,n.id,At.layoutVertexBuffer,At.indexBuffer,fr,n.paint,l.transform.zoom,Di,cr)}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1)}class Vf{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function ya(l,t,n,c,d,p,_,v,w,I,C,O,D,z,N,B,H,q,Y,te){const J=t.context,_e=J.gl,he=t.transform,pe=t.transform.zoom,ce=[],se=l.translate,ye=l.translateAnchor,Ce=l.edgeRadius,Se=Wa(t,l.cutoffFadeRange);C==="clear"?(ce.push("CLEAR_SUBPASS"),te&&(ce.push("CLEAR_FROM_TEXTURE"),J.activeTexture.set(_e.TEXTURE0),te.bind(_e.LINEAR,_e.CLAMP_TO_EDGE))):C==="sdf"?ce.push("SDF_SUBPASS"):C==="emissive"&&(ce.push("USE_MRT1"),J.activeTexture.set(_e.TEXTURE0),te.bind(_e.LINEAR,_e.CLAMP_TO_EDGE)),q&&ce.push("HAS_CENTROID"),Se.shouldRenderCutoff&&ce.push("RENDER_CUTOFF");const Ue=(je,Xe,ht,ke,we)=>{let He=ce;Xe.groundRadiusBuffer!=null&&(He=ce.concat("HAS_ATTRIBUTE_a_flood_light_ground_radius"));const Be=Xe.programConfigurations.get(c.id),et=t.isTileAffectedByFog(je),vt=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:Be,defines:He,overrideFog:et}),St=gc(t,ke,O,I,we,[D,z*we],N,B,H,pe>=17?0:Ce*we,te?te.size[0]:0),_t=[];q&&_t.push(Xe.hiddenByLandmarkVertexBuffer),Xe.groundRadiusBuffer!=null&&_t.push(Xe.groundRadiusBuffer),t.uploadCommonUniforms(J,vt,je.toUnwrapped(),null,Se),vt.draw(t,J.gl.TRIANGLES,p,_,v,w,St,c.id,Xe.vertexBuffer,Xe.indexBuffer,ht,c.paint,pe,Be,_t)};for(const je of d){const Xe=n.getTile(je),ht=Xe.getBucket(c);if(!ht||ht.projection.name!==he.projection.name||!ht.groundEffect||ht.groundEffect&&!ht.groundEffect.hasData())continue;const ke=ht.groundEffect,we=1/ht.tileToMeter;{const He=t.translatePosMatrix(je.projMatrix,Xe,se,ye),Be=ke.getDefaultSegment();Ue(je,ke,Be,He,we)}if(Y)for(let He=0;He<4;He++){const Be=o.e9[He](je),et=n.getTile(Be);if(!et)continue;const vt=et.getBucket(c);if(!vt||vt.projection.name!==he.projection.name||!vt.groundEffect||vt.groundEffect&&!vt.groundEffect.hasData())continue;const St=vt.groundEffect;let _t,dt;He===0?(_t=[-o.al,0,0],dt=1):He===1?(_t=[o.al,0,0],dt=0):He===2?(_t=[0,-o.al,0],dt=3):(_t=[0,o.al,0],dt=2);const kt=St.regionSegments[dt];if(!kt)continue;const Dt=new Float32Array(16);o.br(Dt,je.projMatrix,_t),Ue(je,St,kt,t.translatePosMatrix(Dt,Xe,se,ye),we)}}}function Ey(l,t,n,c,d,p,_){c.centroidVertexArray.length===0&&c.createCentroidsBuffer();const v=p?p.findDEMTileFor(n):null;if(!(v&&v.dem||_))return;p&&v&&v.dem&&c.selfDEMTileTimestamp!==v.dem._timestamp&&(c.borderDoneWithNeighborZ=[-1,-1,-1,-1],c.selfDEMTileTimestamp=v.dem._timestamp);const w=q=>new o.P(Math.ceil((q+o.ed)*o.ee),0),I=q=>{const Y=t.getSource().minzoom,te=_e=>{const he=t.getTileByID(_e);if(he&&he.hasData())return he.getBucket(d)},J=[0,-1,1];for(const _e of J){if(q.overscaledZ+_e<Y)continue;const he=te(q.calculateScaledKey(q.overscaledZ+_e));if(he)return he}},C=[0,0,0],O=(q,Y)=>(C[0]=Math.min(q.min.y,Y.min.y),C[1]=Math.max(q.max.y,Y.max.y),C[2]=o.al-Y.min.x>q.max.x?Y.min.x-o.al:q.max.x,C),D=(q,Y)=>(C[0]=Math.min(q.min.x,Y.min.x),C[1]=Math.max(q.max.x,Y.max.x),C[2]=o.al-Y.min.y>q.max.y?Y.min.y-o.al:q.max.y,C),z=[(q,Y)=>O(q,Y),(q,Y)=>O(Y,q),(q,Y)=>D(q,Y),(q,Y)=>D(Y,q)],N=(q,Y,te,J,_e,he,pe)=>{if(!p)return 0;const ce=[[he?te:q,he?q:te,0],[he?te:Y,he?Y:te,0]],se=pe<0?o.al+pe:pe,ye=[he?se:(q+Y)/2,he?(q+Y)/2:se,0];return te===0&&pe<0||te!==0&&pe>0?p.getForTilePoints(_e,[ye],!0,J):ce.push(ye),p.getForTilePoints(n,ce,!0,v),Math.max(ce[0][2],ce[1][2],ye[2])/p.exaggeration()};for(let q=0;q<4;q++){const Y=c.borderFeatureIndices[q];if(Y.length===0)continue;const te=o.e9[q](n),J=I(te);if(!(J&&J instanceof o.ea))continue;const _e=p?p.findDEMTileFor(te):null;if(!(_e&&_e.dem||_)||(p&&_e&&_e.dem&&c.borderDEMTileTimestamp[q]!==_e.dem._timestamp&&(c.borderDoneWithNeighborZ[q]=-1,c.borderDEMTileTimestamp[q]=_e.dem._timestamp),c.borderDoneWithNeighborZ[q]===J.canonical.z))continue;J.centroidVertexArray.length===0&&J.createCentroidsBuffer();const he=(q<2?1:5)-q,pe=J.borderDoneWithNeighborZ[he]!==c.canonical.z,ce=J.borderFeatureIndices[he];let se=0;if(c.canonical.z!==J.canonical.z){for(const ye of Y)c.showCentroid(c.featuresOnBorder[ye]);if(pe)for(const ye of ce)J.showCentroid(J.featuresOnBorder[ye]);c.borderDoneWithNeighborZ[q]=J.canonical.z,J.borderDoneWithNeighborZ[he]=c.canonical.z}for(const ye of Y){const Ce=c.featuresOnBorder[ye],Se=c.centroidData[Ce.centroidDataIndex],Ue=Ce.borders[q];let je;for(;se<ce.length;){je=J.featuresOnBorder[ce[se]];const Xe=je.borders[he];if(Xe[1]>Ue[0]+3||Xe[0]>Ue[0]-3)break;J.showCentroid(je),se++}if(je&&se<ce.length){const Xe=se;let ht=0;for(;!(je.borders[he][0]>Ue[1]-3)&&(ht++,++se!==ce.length);)je=J.featuresOnBorder[ce[se]];je=J.featuresOnBorder[ce[Xe]];let ke=!1;if(ht>=1){const Be=je.borders[he];Math.abs(Ue[0]-Be[0])<3&&Math.abs(Ue[1]-Be[1])<3&&(ht=1,ke=!0,se=Xe+1)}else if(ht===0){c.showCentroid(Ce);continue}const we=J.centroidData[je.centroidDataIndex];_&&ke&&(((B=Se).flags|(H=we).flags)&o.ec?(B.flags|=o.ec,H.flags|=o.ec):(B.flags&=~o.ec,H.flags&=~o.ec));const He=Ce.intersectsCount()>1||je.intersectsCount()>1;if(ht>1)se=Xe,Se.centroidXY=we.centroidXY=new o.P(0,0);else if(_e&&_e.dem&&!He){const Be=z[q](Se,we),et=q%2?o.al-1:0,vt=N(Be[0],Math.min(o.al-1,Be[1]),et,_e,te,q<2,Be[2]);Se.centroidXY=we.centroidXY=w(vt)}else He?Se.centroidXY=we.centroidXY=new o.P(0,0):(Se.centroidXY=c.encodeBorderCentroid(Ce),we.centroidXY=J.encodeBorderCentroid(je));c.writeCentroidToBuffer(Se),J.writeCentroidToBuffer(we)}else c.showCentroid(Ce)}c.borderDoneWithNeighborZ[q]=J.canonical.z,J.borderDoneWithNeighborZ[he]=c.canonical.z}var B,H;(c.needsCentroidUpdate||!c.centroidVertexBuffer&&c.centroidVertexArray.length!==0)&&c.uploadCentroid(l)}const Lo=[1,0,0],Uf=[0,1,0],fo=[0,0,1];function va(l,t,n){const c=n.transform,d=n.shadowRenderer;if(!d)return!0;const p=l.toUnwrapped(),_=c.tileSize*d._cascades[n.currentShadowCascade].scale;let v=t;if(c.elevation){const B=c.elevation.getMinMaxForTile(l);B&&(v+=B.max)}const w=[...d.shadowDirection];w[2]=-w[2];const I=d.computeSimplifiedTileShadowVolume(p,v,_,w);if(!I)return!1;const C=[Lo,Uf,fo,w,[w[0],0,w[2]],[0,w[1],w[2]]],O=c.projection.name==="globe",D=c.scaleZoom(_),z=o.cB.fromInvProjectionMatrix(c.invProjMatrix,c.worldSize,D,!O),N=d.getCurrentCascadeFrustum();return z.intersectsPrecise(I.vertices,I.planes,C)===0||N.intersectsPrecise(I.vertices,I.planes,C)===0}function Eu(l){const{painter:t,source:n,layer:c,coords:d}=l;let p=l.defines;const _=t.context,v=t.renderPass==="shadow",w=t.renderPass==="light-beam",I=t.shadowRenderer,C=o.ef(t.transform.center.lat,t.transform.zoom),O=Wa(t,c.paint.get("building-cutoff-fade-range"));O.shouldRenderCutoff&&(p=p.concat("RENDER_CUTOFF")),l.floodLightIntensity>0&&(p=p.concat("FLOOD_LIGHT"));for(const D of d){const z=n.getTile(D),N=z.getBucket(c);if(!N)continue;I&&I.getMaxCascadeForTile(D.toUnwrapped())===0&&(p=p.concat("SHADOWS_SINGLE_CASCADE"));const B=N.programConfigurations.get(c.id);let H,q,Y,te=t.translatePosMatrix(D.expandedProjMatrix,z,[0,0],"map");if(te=o.cS(o.bC(),te,[1,1,l.verticalScale]),v&&I){if(va(z.tileID,N.maxHeight*C,t))continue;let _e=I.calculateShadowPassMatrixFromTile(z.tileID.toUnwrapped());_e=o.cS(o.bC(),_e,[1,1,l.verticalScale]),Y=tl(_e),H=q=t.getOrCreateProgram("buildingDepth",{config:B,defines:p,overrideFog:!1})}else if(w)H=q=t.getOrCreateProgram("buildingBloom",{config:B,defines:p,overrideFog:!1}),Y=Wm(te);else{const _e=t.transform.calculatePosMatrix(D.toUnwrapped(),t.transform.worldSize);o.cS(_e,_e,[1,1,l.verticalScale]);const he=o.bC();o.cS(he,_e,[1,-1,1/C]),o.bl(he,he),o.eg(he,he);const pe=t.transform.getFreeCameraOptions().position,ce=1<<D.canonical.z;if(Y=Bh(te,he,l.opacity,l.facadeAOIntensity,[((pe.x-D.wrap)*ce-D.canonical.x)*o.al,(pe.y*ce-D.canonical.y)*o.al,pe.z*ce*o.al],N.tileToMeter,l.facadeEmissiveChance,l.floodLightColor,l.floodLightIntensity),q=t.getOrCreateProgram("building",{config:B,defines:p,overrideFog:!1}),l.depthOnly===!0)H=q;else{const se=p.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);H=t.getOrCreateProgram("building",{config:B,defines:se,overrideFog:!1})}I&&(I.setupShadowsFromMatrix(_e,q,!0),H!==q&&I.setupShadowsFromMatrix(_e,H,!0))}const J=(_e,he)=>{if(w){const pe=_e.entranceBloom;he.draw(t,_.gl.TRIANGLES,l.depthMode,ri.disabled,l.blendMode,ti.disabled,Y,c.id,pe.layoutVertexBuffer,pe.indexBuffer,pe.segmentsBucket,c.paint,t.transform.zoom,B,[pe.layoutAttenuationBuffer,pe.layoutColorBuffer])}else{const pe=_e.segmentsBucket;let ce=[_e.layoutNormalBuffer,_e.layoutCentroidBuffer,_e.layoutColorBuffer,_e.layoutFloodLightDataBuffer];_e.layoutFacadePaintBuffer&&(ce=ce.concat([_e.layoutFacadeDataBuffer,_e.layoutFacadeVerticalRangeBuffer,_e.layoutFacadePaintBuffer])),he.draw(t,_.gl.TRIANGLES,l.depthMode,ri.disabled,l.blendMode,v?ti.disabled:ti.backCW,Y,c.id,_e.layoutVertexBuffer,_e.indexBuffer,pe,c.paint,t.transform.zoom,B,ce)}};t.uploadCommonUniforms(_,q,D.toUnwrapped(),null,O),N.buildingWithoutFacade&&J(N.buildingWithoutFacade,q),N.buildingWithFacade&&(H!==q&&t.uploadCommonUniforms(_,H,D.toUnwrapped(),null,O),J(N.buildingWithFacade,H))}}function Zh(l,t,n,c,d,p,_,v,w,I,C,O,D){const z=l.context.gl,N=l.depthModeForSublayer(1,Bt.ReadOnly,z.LEQUAL,!0),B=.1*(1-(H=C))+3*H;var H;const q=l._showOverdrawInspector,Y=O,te=new Vf;q||ya(te,l,t,n,c,N,new ri({func:z.ALWAYS,mask:255},255,255,z.KEEP,z.KEEP,z.REPLACE),new _i([z.ONE,z.ONE,z.ONE,z.ONE],o.ao.transparent,[!1,!1,!1,!0],z.MIN),ti.disabled,d,"sdf",p,_,v,w,I,B,Y,!1);{const J=q?ri.disabled:new ri({func:z.EQUAL,mask:255},255,255,z.KEEP,z.DECR,z.DECR),_e=q?l.colorModeForRenderPass():new _i([z.ONE_MINUS_DST_ALPHA,z.DST_ALPHA,z.ONE,z.ONE],o.ao.transparent,[!0,!0,!0,!0]);ya(te,l,t,n,c,N,J,_e,ti.disabled,d,"color",p,_,v,w,I,B,Y,!1)}}function $h(l){return[l[0]*o.eh,l[1]*o.eh,l[2]*o.eh,0]}function Su(l,t,n,c,d,p,_,v,w){const I=c.getSource(),C=n.globeSharedBuffers;if(!C)return;let O,D,z;if(t&&(O=c.getTile(t)),I instanceof o.aU?(D=I.texture,z=o.dK(0,0,n.transform)):O&&t&&(D=O.texture,z=o.dK(t.canonical.z,t.canonical.x,n.transform)),!D||!z)return;l||(z=o.cS(o.bC(),z,[1,-1,1]));const N=n.context,B=N.gl,H=d.paint.get("raster-resampling")==="nearest"?B.NEAREST:B.LINEAR,q=n.colorModeForDrapableLayerRenderPass(p),Y=_.defines;Y.push("GLOBE_POLES");const te=new Bt(B.LEQUAL,Bt.ReadWrite,n.depthRangeFor3D),J=Float32Array.from(n.transform.expandedFarZProjMatrix),_e=Float32Array.from(o.bk(o.dJ(new o.cD(0,0,0))));n.terrain&&n.terrain.prepareDrawTile(),N.activeTexture.set(B.TEXTURE0),D.bind(H,B.CLAMP_TO_EDGE),N.activeTexture.set(B.TEXTURE1),D.bind(H,B.CLAMP_TO_EDGE),"useMipmap"in D&&N.extTextureFilterAnisotropic&&n.transform.pitch>20&&B.texParameterf(B.TEXTURE_2D,N.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,N.extTextureFilterAnisotropicMax);const[he,pe,ce,se]=t?C.getPoleBuffers(t.canonical.z,!1):C.getPoleBuffers(0,!0),ye=d.paint.get("raster-elevation");let Ce;l?(Ce=he,n.renderDefaultNorthPole=ye!==0):(Ce=pe,n.renderDefaultSouthPole=ye!==0);const Se=$h(_.mix),Ue=((Xe,ht,ke,we,He,Be,et,vt,St,_t,dt,kt,Dt)=>Jm(Xe,ht,ke,new Float32Array(16),new Float32Array(9),[0,0],we,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Be,[0,0],vt,2,_t,dt,kt,1,0,Dt))(J,_e,z,o.aj(n.transform.zoom),0,d,0,ye,0,Se,_.offset,_.range,p),je=n.getOrCreateProgram("raster",{defines:Y});n.uploadCommonUniforms(N,je,null),je.draw(n,B.TRIANGLES,te,w,q,v,Ue,d.id,Ce,ce,se)}function n_(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,d=.2*l.height,p=t+d;return[t,n,(p-d-t)/c,(p-t)/c]}function xa(l,t,n,c){if(l)return t instanceof oo&&l instanceof sh?t.getTextureDescriptor(l,n,!0):{texture:l.texture,mix:$h(c.mix),offset:c.offset,buffer:0,tileSize:1}}var Ar=o.ei([{name:"a_index",type:"Int16",components:1}]);class Wh{constructor(t,n,c,d){const p={width:c[0],height:c[1],data:null},_=t.gl;this.targetColorTexture=new o.T(t,p,_.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new o.T(t,p,_.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(n,d),this.lastInvalidatedAt=0}updateParticleTexture(t,n){if(this.particleTextureDimension===n.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const c=this.context.gl,d=n.width*n.height;this.particleTexture0=new o.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new o.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1});const p=new o.ej;p.reserve(d);for(let _=0;_<d;_++)p.emplaceBack(_);this.particleIndexBuffer=this.context.createVertexBuffer(p,Ar.members,!0),this.particleSegment=o.bg.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=n.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=o.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function jf(l,t,n){if(!l)return null;const c=t.getTextureDescriptor(l,n,!0);if(!c)return null;let{texture:d,mix:p,offset:_,tileSize:v,buffer:w,format:I}=c;if(!d||!I)return null;let C=!1;return I==="uint32"&&(C=!0,p[3]=0,p=Nh(o.ek,p,[0,n.paint.get("raster-particle-max-speed")]),_=Vh(o.ek,_,[0,n.paint.get("raster-particle-max-speed")])),{texture:d,textureOffset:[w/(v+2*w),v/(v+2*w)],tileSize:v,scalarData:C,scale:p,offset:_,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[I]]}}function o_(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,d=.2*l.height,p=t+d;return[t,n,(p-d-t)/c,(p-t)/c]}const s_=new o.ao(1,0,0,1),a_=new o.ao(0,1,0,1),l_=new o.ao(0,0,1,1),Nl=new o.ao(1,0,1,1),Vl=new o.ao(0,1,1,1);function mt(l,t,n,c,d,p){for(let _=0;_<n.length;_++)if(d){const I=new o.ao(c.r*.8,c.g*.8,c.b*.8,1);xt(l,t,n[_],c,-1,-1,p),xt(l,t,n[_],c,-1,1,p),xt(l,t,n[_],c,1,1,p),xt(l,t,n[_],c,1,-1,p),xt(l,t,n[_],I,0,0,p)}else xt(l,t,n[_],c,0,0,p)}function xt(l,t,n,c,d,p,_){const v=l.context,w=l.transform,I=v.gl,C=w.projection.name==="globe",O=C?["PROJECTION_GLOBE_VIEW"]:[];let D=o.bz(n.projMatrix);if(C&&o.aj(w.zoom)>0){const Se=o.bj(n.canonical,w),Ue=o.el(Se);D=o.aB(new Float32Array(16),w.globeMatrix,Ue),o.aB(D,w.projMatrix,D)}const z=o.bC();z[12]+=2*d/(o.o.devicePixelRatio*w.width),z[13]+=2*p/(o.o.devicePixelRatio*w.height),o.aB(D,z,D);const N=l.getOrCreateProgram("debug",{defines:O}),B=t.getTileByID(n.key);l.terrain&&l.terrain.setupElevationDraw(B,N);const H=Bt.disabled,q=ri.disabled,Y=l.colorModeForRenderPass(),te="$debug";v.activeTexture.set(I.TEXTURE0),l.emptyTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),C?B._makeGlobeTileDebugBuffers(l.context,w):B._makeDebugTileBoundsBuffers(l.context,w.projection);const J=B._tileDebugBuffer||l.debugBuffer,_e=B._tileDebugIndexBuffer||l.debugIndexBuffer,he=B._tileDebugSegments||l.debugSegments;if(N.draw(l,I.LINE_STRIP,H,q,Y,ti.disabled,xu(D,c.toPremultipliedRenderColor(null)),te,J,_e,he,null,null,null,[B._globeTileDebugBorderBuffer]),_){const Se=B.latestRawTileData,Ue=Math.floor((Se&&Se.byteLength||0)/1024);let je=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(je+=` => ${n.overscaledZ}`),je+=` ${B.state}`,je+=` ${Ue}kb`,(function(Xe,ht){Xe.initDebugOverlayCanvas();const ke=Xe.debugOverlayCanvas,we=Xe.context.gl,He=Xe.debugOverlayCanvas.getContext("2d");He.clearRect(0,0,ke.width,ke.height),He.shadowColor="white",He.shadowBlur=2,He.lineWidth=1.5,He.strokeStyle="white",He.textBaseline="top",He.font="bold 36px Open Sans, sans-serif",He.fillText(ht,5,5),He.strokeText(ht,5,5),Xe.debugOverlayTexture.update(ke),Xe.debugOverlayTexture.bind(we.LINEAR,we.CLAMP_TO_EDGE)})(l,je)}const pe=t.getTile(n).tileSize,ce=512/Math.min(pe,512)*(n.overscaledZ/w.zoom)*.5,se=B._tileDebugTextBuffer||l.debugBuffer,ye=B._tileDebugTextIndexBuffer||l.quadTriangleIndexBuffer,Ce=B._tileDebugTextSegments||l.debugSegments;N.draw(l,I.TRIANGLES,H,q,_i.alphaBlended,ti.disabled,xu(D,o.ao.transparent.toPremultipliedRenderColor(null),ce),te,se,ye,Ce,null,null,null,[B._globeTileDebugTextBuffer])}function Ul(l,t,n,c){Re(l,0,t+n/2,l.transform.width,n,c)}function en(l,t,n,c){Re(l,t-n/2,0,n,l.transform.height,c)}function Re(l,t,n,c,d,p){const _=l.context,v=_.gl;v.enable(v.SCISSOR_TEST),v.scissor(t*o.o.devicePixelRatio,n*o.o.devicePixelRatio,c*o.o.devicePixelRatio,d*o.o.devicePixelRatio),_.clear({color:p}),v.disable(v.SCISSOR_TEST)}const c_=o.ei([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Xh}=c_;function Ys(l,t,n,c){l.emplaceBack(t,n,c)}class Yh{constructor(t){this.vertexArray=new o.em,this.indices=new o.b0,Ys(this.vertexArray,-1,-1,1),Ys(this.vertexArray,1,-1,1),Ys(this.vertexArray,-1,1,1),Ys(this.vertexArray,1,1,1),Ys(this.vertexArray,-1,-1,-1),Ys(this.vertexArray,1,-1,-1),Ys(this.vertexArray,-1,1,-1),Ys(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,Xh),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=o.bg.simpleSegment(0,0,36,12)}}function jl(l,t,n,c,d,p){const _=l.context.gl,v=t.paint.get("sky-atmosphere-color"),w=t.paint.get("sky-atmosphere-halo-color"),I=t.paint.get("sky-atmosphere-sun-intensity"),C=((O,D,z,N,B)=>({u_matrix_3f:O,u_sun_direction:D,u_sun_intensity:z,u_color_tint_r:[N.r,N.g,N.b,N.a],u_color_tint_m:[B.r,B.g,B.b,B.a],u_luminance:5e-5}))(o.eo(o.dO(),c),d,I,v.toPremultipliedRenderColor(null),w.toPremultipliedRenderColor(null));_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+p,t.skyboxTexture,0),n.draw(l,_.TRIANGLES,Bt.disabled,ri.disabled,_i.unblended,ti.frontCW,C,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const u_=o.ei([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class xc{constructor(t){const n=new o.ep;n.emplaceBack(-1,1,1,0,0),n.emplaceBack(1,1,1,1,0),n.emplaceBack(1,-1,1,1,1),n.emplaceBack(-1,-1,1,0,1);const c=new o.b0;c.emplaceBack(0,1,2),c.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(n,u_.members),this.indexBuffer=t.createIndexBuffer(c),this.segments=o.bg.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Sy=o.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Iy{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class h_{constructor(t){this.colorModeAlphaBlendedWriteRGB=new _i([1,Zs,1,Zs],o.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new _i([1,0,1,0],o.ao.transparent,[!1,!1,!1,!0]),this.params=new Iy,this.updateNeeded=!0}update(t){const n=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new xc(n);const c=this.params.sizeRange,d=this.params.intensityRange,p=(function(C){const O=o.eq(30),D=[];for(let z=0;z<C;++z){const N=2*Math.PI*O(),B=Math.acos(1-2*O())-.5*Math.PI;D.push(o.d5(Math.cos(B)*Math.cos(N),Math.cos(B)*Math.sin(N),Math.sin(B)))}return D})(this.params.starsCount),_=o.eq(300),v=new o.er,w=new o.b0;let I=0;for(let C=0;C<p.length;++C){const O=o.c5([],p[C],200),D=Math.max(0,1+.01*c*(1*_()-.5)),z=Math.max(0,1+.01*d*(1*_()-.5));v.emplaceBack(O[0],O[1],O[2],-1,-1,D,z),v.emplaceBack(O[0],O[1],O[2],1,-1,D,z),v.emplaceBack(O[0],O[1],O[2],1,1,D,z),v.emplaceBack(O[0],O[1],O[2],-1,1,D,z),w.emplaceBack(I+0,I+1,I+2),w.emplaceBack(I+0,I+2,I+3),I+=4}this.starsVx=n.createVertexBuffer(v,Sy.members),this.starsIdx=n.createIndexBuffer(w),this.starsSegments=o.bg.simpleSegment(0,0,v.length,w.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,n){const c=t.context,d=c.gl,p=t.transform,_=new Bt(d.LEQUAL,Bt.ReadOnly,[0,1]),v=o.aj(p.zoom),w=t.style.getLut(n.scope),I=n.properties.get("color-use-theme")==="none",C=n.properties.get("color").toNonPremultipliedRenderColor(I?null:w),O=n.properties.get("high-color-use-theme")==="none",D=n.properties.get("high-color").toNonPremultipliedRenderColor(O?null:w),z=n.properties.get("space-color-use-theme")==="none",N=n.properties.get("space-color").toNonPremultipliedRenderColor(z?null:w),B=5e-4,H=o.es(n.properties.get("horizon-blend"),0,1,B,.25),q=o.dE(t,c,p)&&H===B?p.worldSize/(2*Math.PI*1.025)-1:p.globeRadius,Y=t.frameCounter/1e3%1,te=o.ag(p.globeCenterInViewSpace),J=Math.sqrt(Math.pow(te,2)-Math.pow(q,2)),_e=Math.acos(J/te),he=pe=>{const ce=p.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];pe&&ce.push("ALPHA_PASS");const se=t.getOrCreateProgram("globeAtmosphere",{defines:ce}),ye=((Se,Ue,je,Xe,ht,ke,we,He,Be,et,vt,St)=>({u_frustum_tl:Se,u_frustum_tr:Ue,u_frustum_br:je,u_frustum_bl:Xe,u_horizon:ht,u_transition:ke,u_fadeout_range:we,u_atmosphere_fog_color:He.toArray01(),u_high_color:Be.toArray01(),u_space_color:et.toArray01(),u_temporal_offset:vt,u_horizon_angle:St}))(p.frustumCorners.TL,p.frustumCorners.TR,p.frustumCorners.BR,p.frustumCorners.BL,p.frustumCorners.horizon,v,H,C,D,N,Y,_e);t.uploadCommonUniforms(c,se);const Ce=this.atmosphereBuffer;Ce&&se.draw(t,d.TRIANGLES,_,ri.disabled,pe?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,ti.backCW,ye,pe?"atmosphere_glow_alpha":"atmosphere_glow",Ce.vertexBuffer,Ce.indexBuffer,Ce.segments)};he(!1),he(!0)}drawStars(t,n){const c=o.aA(n.properties.get("star-intensity"),0,1);if(c===0)return;const d=t.context,p=d.gl,_=t.transform,v=t.getOrCreateProgram("stars"),w=o.c7([]);o.c9(w,w,-_._pitch),o.c8(w,w,-_.angle),o.c9(w,w,o.an(_._center.lat)),o.et(w,w,-o.an(_._center.lng));const I=o.cc(new Float32Array(16),w),C=o.aB([],_.starsProjMatrix,I),O=o.eo([],I),D=o.eu([],O),z=[0,1,0];o.dQ(z,z,D),o.c5(z,z,this.params.sizeMultiplier);const N=[1,0,0];o.dQ(N,N,D),o.c5(N,N,this.params.sizeMultiplier);const B=(H=z,q=N,Y=c,{u_matrix:Float32Array.from(C),u_up:H,u_right:q,u_intensity_multiplier:Y});var H,q,Y;t.uploadCommonUniforms(d,v),this.starsVx&&this.starsIdx&&v.draw(t,p.TRIANGLES,Bt.disabled,ri.disabled,this.colorModeAlphaBlendedWriteRGB,ti.disabled,B,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class Jh{constructor(){this.visibleTiles=[]}updateBorders(t,n){const c=[],d=[],p=t._getRenderableCoordinates(!1,!0);for(const w of p){const I=t.getTile(w);if(!I.hasData())continue;const C=I.getBucket(n);C&&(C.isEmpty()||(c.push(w.key),d.push({bucket:C,tileID:w.canonical})))}let _=c.length!==this.visibleTiles.length;if(!_){c.sort();for(let w=0;w<c.length;w++)if(c[w]!==this.visibleTiles[w]){_=!0;break}}if(!_)return;const v=new Set;this.visibleTiles=c,d.sort(((w,I)=>w.tileID.z-I.tileID.z||w.tileID.x-I.tileID.x||w.tileID.y-I.tileID.y));for(const w of d){const I=new Array,C=new Array,O=w.bucket;for(const D of O.featuresOnBorder)v.has(D.featureId)?C.push(D.footprintIndex):(v.add(D.featureId),I.push(D.footprintIndex));O.updateFootprintHiddenFlags(I,o.ev,!1),O.updateFootprintHiddenFlags(C,o.ev,!0)}}}function Kh(l,t){const n=[...l],c=t.cameraWorldSizeForFog/t.worldSize,d=o.bA([]);return o.cS(d,d,[c,c,1]),o.aB(n,d,n),o.aB(n,t.worldToFogMatrix,n),n}function Qh(l,t,n,c,d){const p=n.material,_=c.context,{baseColorTexture:v,metallicRoughnessTexture:w}=p.pbrMetallicRoughness,{normalTexture:I,occlusionTexture:C,emissionTexture:O}=p;function D(N,B,H){if(N&&(l.push(B),_.activeTexture.set(_.gl.TEXTURE0+H),N.gfxTexture)){const{minFilter:q,magFilter:Y,wrapS:te,wrapT:J}=N.sampler;N.gfxTexture.bindExtraParam(q,Y,te,J)}}D(v,"HAS_TEXTURE_u_baseColorTexture",jn.BaseColor),D(w,"HAS_TEXTURE_u_metallicRoughnessTexture",jn.MetallicRoughness),D(I,"HAS_TEXTURE_u_normalTexture",jn.Normal),D(C,"HAS_TEXTURE_u_occlusionTexture",jn.Occlusion),D(O,"HAS_TEXTURE_u_emissionTexture",jn.Emission),d&&(d.texture||(d.texture=new o.d$(c.context,d.image,[d.image.height,d.image.height,d.image.height],_.gl.RGBA8)),_.activeTexture.set(_.gl.TEXTURE0+jn.LUT),d.texture&&d.texture.bind(_.gl.LINEAR,_.gl.CLAMP_TO_EDGE),l.push("APPLY_LUT_ON_GPU")),n.texcoordBuffer&&(l.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(n.texcoordBuffer)),n.colorBuffer&&(l.push(n.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(n.colorBuffer)),n.normalBuffer&&(l.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(n.normalBuffer)),n.pbrBuffer&&(l.push("HAS_ATTRIBUTE_a_pbr"),l.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(n.pbrBuffer)),p.alphaMode!=="OPAQUE"&&p.alphaMode!=="MASK"||l.push("UNPREMULT_TEXTURE_IN_SHADER"),p.defined||l.push("DIFFUSE_SHADED");const z=c.shadowRenderer;z&&(l.push("RENDER_SHADOWS","DEPTH_TEXTURE"),z.useNormalOffset&&l.push("NORMAL_OFFSET"))}function ed(l,t,n,c,d,p){const _=l.modelOpacity,v=t.context,w=new Bt(t.context.gl.LEQUAL,l.isLightMesh?Bt.ReadOnly:Bt.ReadWrite,t.depthRangeFor3D),I=t.transform,C=l.mesh,O=C.material,D=O.pbrMetallicRoughness,z=t.style.fog;let N;N=t.transform.projection.zAxisUnit==="pixels"?[...l.nodeModelMatrix]:o.aB([],c.zScaleMatrix,l.nodeModelMatrix),o.aB(N,c.negCameraPosMatrix,N);const B=o.bl([],N);o.eg(B,B);const H=n.paint.get("model-color-use-theme").constantOr("default")==="none",q=n.paint.get("model-emissive-strength").constantOr(0),Y=Fl(new Float32Array(l.worldViewProjection),new Float32Array(N),new Float32Array(B),null,t,_,D.baseColorFactor,O.emissiveFactor,D.metallicFactor,D.roughnessFactor,O,q,n,void 0,void 0,l.materialOverride,l.modelColor),te={defines:[]},J=[],_e=t.shadowRenderer;_e&&(_e.useNormalOffset=!1),Qh(te.defines,J,C,t,H?null:n.lut);let he=null;if(z){const se=Kh(l.nodeModelMatrix,t.transform);if(he=new Float32Array(se),I.projection.name!=="globe"){const ye=C.aabb.min,Ce=C.aabb.max,[Se,Ue]=z.getOpacityForBounds(se,ye[0],ye[1],Ce[0],Ce[1]);te.overrideFog=Se>=Je||Ue>=Je}}const pe=Wa(t,n.paint.get("model-cutoff-fade-range"));pe.shouldRenderCutoff&&te.defines.push("RENDER_CUTOFF");const ce=t.getOrCreateProgram("model",te);t.uploadCommonUniforms(v,ce,null,he,pe),t.renderPass!=="shadow"&&_e&&_e.setupShadowsFromMatrix(l.nodeModelMatrix,ce),ce.draw(t,v.gl.TRIANGLES,w,d,p,C.material.doubleSided?ti.disabled:ti.backCCW,Y,n.id,C.vertexBuffer,C.indexBuffer,C.segments,n.paint,t.transform.zoom,void 0,J)}function Iu(l,t){return l.style._importedAsBasemap?"basemap":t.scope}function Gl(l,t,n,c,d,p,_,v,w,I){const C=l.transform,O=!!t.isGeometryBloom&&t.isGeometryBloom;if(O&&l.renderPass==="shadow")return;const D=C.projection.name==="globe"?o.eD(n,C):[...n];o.aB(D,D,t.globalMatrix);const z=o.aB([],c,D);if(t.meshes)for(const N of t.meshes){const B=v.get(N.material.name);if(B&&B.opacity<=0)continue;if(N.material.alphaMode!=="BLEND"){_.push({mesh:N,depth:0,modelIndex:d,worldViewProjection:z,nodeModelMatrix:D,isLightMesh:O,materialOverride:B,modelOpacity:w,modelColor:I});continue}const H=o.af([],N.centroid,z);!C.isOrthographic&&H[2]<=0||p.push({mesh:N,depth:H[2],modelIndex:d,worldViewProjection:z,nodeModelMatrix:D,isLightMesh:O,materialOverride:B,modelOpacity:w,modelColor:I})}if(t.children)for(const N of t.children)Gl(l,N,n,c,d,p,_,v,w,I)}function Is(l,t,n,c){const d=n.shadowRenderer;if(!d)return;const p=d.getShadowPassDepthMode(),_=d.getShadowPassColorMode(),v=d.calculateShadowPassMatrixFromMatrix(t),w=Ff(v);n.getOrCreateProgram("modelDepth",{defines:n._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(n,n.context.gl.TRIANGLES,p,ri.disabled,_,ti.disabled,w,c.id,l.vertexBuffer,l.indexBuffer,l.segments,c.paint,n.transform.zoom,void 0,void 0)}function d_(l,t,n,c,d,p){for(const _ of d){const v=Object.assign({},c);v.part=_;const w={type:"Unknown",id:t,properties:v},I={orientation:l.paint.get("model-rotation").evaluate(w,n)};p.set(_,I)}}function f_(l,t,n,c,d,p){for(const _ of d){const v=Object.assign({},c);v.part=_;const w={type:"Unknown",id:t,properties:v},I={color:l.paint.get("model-color").evaluate(w,n),colorMix:l.paint.get("model-color-mix-intensity").evaluate(w,n),opacity:l.paint.get("model-opacity").evaluate(w,n),emissionStrength:l.paint.get("model-emissive-strength").evaluate(w,n)};p.set(_,I)}}function p_(l,t,n,c,d){let p=!1;for(const v of c)v.modelOpacity!==1&&(ed(v,l,t,d[v.modelIndex],ri.disabled,_i.disabled),p=!0);for(const v of c)ed(v,l,t,d[v.modelIndex],v.modelOpacity!==1?l.stencilModeFor3D():ri.disabled,l.colorModeForRenderPass());p&&l.resetStencilClippingMasks();const _=_i.additive;for(const v of n)ed(v,l,t,d[v.modelIndex],ri.disabled,v.isLightMesh?_:l.colorModeForRenderPass())}function m_(l,t,n){const c=t.updateZoomBasedPaintProperties(),d=(function(p,_,v){let w,I,C,O=p.terrain?p.terrain.exaggeration():0;if(p.terrain&&O>0){const D=p.terrain,z=D.findDEMTileFor(v);z&&z.dem?w=o.eF.create(D,v,z):O=0}if(O===0&&(_.terrainElevationMin=0,_.terrainElevationMax=0),O===_.validForExaggeration&&(O===0||w&&w._demTile&&w._demTile.tileID===_.validForDEMTile.id&&w._dem._timestamp===_.validForDEMTile.timestamp))return!1;for(const D in _.instancesPerModel){const z=_.instancesPerModel[D];for(let N=0;N<z.instancedDataArray.length;++N){const B=(w?O*w.getElevationAt(0|z.instancedDataArray.float32[16*N],0|z.instancedDataArray.float32[16*N+1],!0,!0):0)+z.instancesEvaluatedElevation[N];z.instancedDataArray.float32[16*N+6]=B,I=I?Math.min(_.terrainElevationMin,B):B,C=C?Math.max(_.terrainElevationMax,B):B}}return _.terrainElevationMin=I||0,_.terrainElevationMax=C||0,_.validForExaggeration=O,_.validForDEMTile=w&&w._demTile?{id:w._demTile.tileID,timestamp:w._dem._timestamp}:{id:void 0,timestamp:0},!0})(l,t,n);(c||d)&&(t.uploaded=!1,t.upload(l.context))}const Js={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new o.d9([0,0,0],[o.al,o.al,0])};function po(l,t){const n=1<<l.canonical.z,c=t.getFreeCameraOptions().position,d=t.elevation,p=l.canonical.x/n,_=(l.canonical.x+1)/n,v=l.canonical.y/n,w=(l.canonical.y+1)/n;let I=t._centerAltitude;if(d){const z=d.getMinMaxForTile(l);z&&z.max>I&&(I=z.max)}const C=o.aA(c.x,p,_)-c.x,O=o.aA(c.y,v,w)-c.y,D=o.cf(I,t.center.lat)-c.z;return t._zoomFromMercatorZ(Math.sqrt(C*C+O*O+D*D))}function __(l,t,n,c,d,p,_){const v=l.context,w=l.renderPass==="shadow",I=l.shadowRenderer,C=w&&I?I.getShadowPassDepthMode():new Bt(v.gl.LEQUAL,Bt.ReadWrite,l.depthRangeFor3D),O=l.isTileAffectedByFog(p),D=l.transform.projection.name==="globe";if(n.meshes)for(const z of n.meshes){const N=D?[]:["MODEL_POSITION_ON_GPU"],B=[];let H,q,Y;const te=!D&&c.instancedDataArray.length>20;te&&N.push("INSTANCED_ARRAYS");const J=Wa(l,t.paint.get("model-cutoff-fade-range"));if(J.shouldRenderCutoff&&N.push("RENDER_CUTOFF"),w&&I)H=l.getOrCreateProgram("modelDepth",{defines:N}),q=Ff(_.shadowTileMatrix,_.shadowTileMatrix,Float32Array.from(n.globalMatrix)),Y=I.getShadowPassColorMode();else{Qh(N,B,z,l,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),H=l.getOrCreateProgram("model",{defines:N,overrideFog:O});const he=z.material,pe=he.pbrMetallicRoughness,ce=t.paint.get("model-opacity").constantOr(1),se=t.paint.get("model-emissive-strength").constantOr(0);q=Fl(p.expandedProjMatrix,Float32Array.from(n.globalMatrix),new Float32Array(16),null,l,ce,pe.baseColorFactor,he.emissiveFactor,pe.metallicFactor,pe.roughnessFactor,he,se,t,d),I&&(_.shadowUniformsInitialized?H.setShadowUniformValues(v,I.getShadowUniformValues()):(I.setupShadows(p.toUnwrapped(),H,"model-tile"),_.shadowUniformsInitialized=!0)),Y=J.shouldRenderCutoff||ce<1||he.alphaMode!=="OPAQUE"?_i.alphaBlended:_i.unblended}l.uploadCommonUniforms(v,H,p.toUnwrapped(),null,J);const _e=z.material.doubleSided?ti.disabled:ti.backCCW;if(te)B.push(c.instancedDataBuffer),H.draw(l,v.gl.TRIANGLES,C,ri.disabled,Y,_e,q,t.id,z.vertexBuffer,z.indexBuffer,z.segments,t.paint,l.transform.zoom,void 0,B,c.instancedDataArray.length);else{const he=w?"u_instance":"u_normal_matrix";for(let pe=0;pe<c.instancedDataArray.length;++pe)q[he]=new Float32Array(c.instancedDataArray.arrayBuffer,64*pe,16),H.draw(l,v.gl.TRIANGLES,C,ri.disabled,Y,_e,q,t.id,z.vertexBuffer,z.indexBuffer,z.segments,t.paint,l.transform.zoom,void 0,B)}}if(n.children)for(const z of n.children)__(l,t,z,c,d,p,_)}const Au=[1,-1,1];function Ay(l,t,n,c){if(!n.modelManager)return!0;const d=n.modelManager;if(!n.shadowRenderer)return!0;const p=n.shadowRenderer,_=t.aabb;let v=!0,w=l.maxHeight;if(w===0){let C=0;for(const O in l.instancesPerModel){const D=d.getModel(O,c);D?C=Math.max(C,Math.max(Math.max(D.aabb.max[0],D.aabb.max[1]),D.aabb.max[2])):v=!1}w=l.maxScale*C*1.41+l.maxVerticalOffset,v&&(l.maxHeight=w)}_.max[2]=w,_.min[2]+=l.terrainElevationMin,_.max[2]+=l.terrainElevationMax,o.af(_.min,_.min,t.tileMatrix),o.af(_.max,_.max,t.tileMatrix);const I=_.intersects(p.getCurrentCascadeFrustum());return n.currentShadowCascade===0&&(l.isInsideFirstShadowMapFrustum=I===2),I===0}function Lr(l,t){const n=l.uniformValues.u_cutoff_params[0],c=l.uniformValues.u_cutoff_params[1],d=l.uniformValues.u_cutoff_params[2],p=l.uniformValues.u_cutoff_params[3];return c===n||p===d?1:o.aA(((t-n)/(c-n)-d)/(p-d),0,1)}function Ci(l,t,n,c){if(t.pitch<20)return 1;const d=t.getWorldToCameraMatrix();o.aB(d,d,l);const p=o.bU(n.min[0],n.min[1],n.min[2],1);let _=o.aC(o.eG(),p,d),v=_,w=_;p[1]=n.max[1],_=o.aC(o.eG(),p,d),v=_[1]<v[1]?_:v,w=_[1]>w[1]?_:w,p[0]=n.max[0],_=o.aC(o.eG(),p,d),v=_[1]<v[1]?_:v,w=_[1]>w[1]?_:w,p[1]=n.min[1],_=o.aC(o.eG(),p,d),v=_[1]<v[1]?_:v,w=_[1]>w[1]?_:w;const I=o.aA(c[0],0,1),C=100*t.pixelsPerMeter*o.aA(c[1],0,1),O=o.aA(c[2],0,1),D=o.eH(o.eG(),v,w,I),z=Math.tan(.5*t.fovX),N=-D[2]*z;if(C===0)return D[1]<-Math.abs(N)?O:1;const B=(-Math.abs(N)-D[1])/C,H=(Y,te,J)=>(1-J)*Y+J*te,q=o.aA(H(1,O,B),O,1);return H(1,q,o.aA((t.pitch-20)/20,0,1))}class g_{}class nl{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,n,c){{const O=this._storage.get(n.id);if(O)return O.lastUsedFrameIdx=t,O.buf}const d=c.gl,p=d.getBufferParameter(d.ELEMENT_ARRAY_BUFFER,d.BUFFER_SIZE),_=new ArrayBuffer(p),v=new Int16Array(_);d.getBufferSubData(d.ELEMENT_ARRAY_BUFFER,0,new Int16Array(_));const w=new o.eJ;for(let O=0;O<p/2;O+=3){const D=v[O],z=v[O+1],N=v[O+2];w.emplaceBack(D,z),w.emplaceBack(z,N),w.emplaceBack(N,D)}const I=c.bindVertexArrayOES.current,C=new g_;return C.buf=new Ss(c,w),C.lastUsedFrameIdx=t,this._storage.set(n.id,C),c.bindVertexArrayOES.set(I),C.buf}update(t){for(const[n,c]of this._storage)t-c.lastUsedFrameIdx>30&&(c.buf.destroy(),this._storage.delete(n))}destroy(){for(const[t,n]of this._storage)n.buf.destroy(),this._storage.delete(t)}}class bc{constructor(){this.occluderSize=30,this.depthOffset=-1e-4}}const wc=o.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class ba{constructor(t){this.revealStart=11,this.revealRange=2}}const Gf=o.ei([{type:"Float32",name:"a_pos_2f",components:2}]);class qf{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,n){const c=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const _=new o.eK,v=new o.b0;_.emplaceBack(-1,-1),_.emplaceBack(1,-1),_.emplaceBack(1,1),_.emplaceBack(-1,1),v.emplaceBack(0,1,2),v.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(_,Gf.members),this.vignetteIdx=t.context.createIndexBuffer(v)}const d=o.bg.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,c);const _={u_vignetteShape:(p={vignetteShape:[n.start,n.range,Math.pow(10,n.fadePower)],vignetteColor:[n.color.r,n.color.g,n.color.b,n.color.a*n.strength]}).vignetteShape,u_vignetteColor:p.vignetteColor};c.draw(t,t.context.gl.TRIANGLES,Bt.disabled,ri.disabled,_i.alphaBlended,ti.disabled,_,"vignette",this.vignetteVx,this.vignetteIdx,d)}var p}}class Hf{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,n){const c=t.getFreeCameraOptions().position,d=c.toAltitude(),p=c.toLngLat(),_=o.an(p.lng),v=o.an(p.lat),w=t.pixelsPerMeter/n,I=_*o.eM,C=o.eM*Math.log(Math.tan(Math.PI/4+v/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const O=-this._offsetYPrev+C,D=-this._elevationPrev+d;this._accumulatedOffsetX+=(-this._offsetXPrev+I)*w,this._accumulatedOffsetY+=O*w,this._accumulatedElevation+=D*w,this._offsetXPrev=I,this._offsetYPrev=C,this._elevationPrev=d}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function td(l,t){return[-(l[0]-Math.floor(l[0]/t)*t),-(l[1]-Math.floor(l[1]/t)*t),-(l[2]-Math.floor(l[2]/t)*t)]}function qo(l){const t=o.eq(1323123451230),n=[];for(let c=0;c<l;++c){const d=2*t()-1,p=2*t()-1,_=2*t()-1;n.push(o.d5(d,p,_))}return n}function To(l,t,n,c,d){const p=o.aA((d-n)/(c-n),0,1);return(1-p)*l+p*t}class ql{constructor(t){this._movement=new Hf,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new qf,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,n){const c=t.transform;this._movement.update(c,this._ppmScaleFactor);const d=c.starsProjMatrix,p=o.c7([]);o.c9(p,p,o.an(90)-c._pitch),o.c8(p,p,-c.angle);const _=o.cc(new Float32Array(16),p),v=o.eL(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),w=o.eg([],v),I=o.aB([],w,_),C=Date.now()/1e3;return this._accumulatedTimeFromStart+=(C-this._prevTime)*n,this._prevTime=C,{projectionMatrix:d,modelviewMatrix:I}}}class id extends ql{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new ba("Precipitation > Rain"),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=qo(this.particlesCount),d=new o.eN,p=new o.b0;let _=0;const v=o.eq(1323123451230);for(let w=0;w<c.length;++w){const I=c[w],C=[2*v()-1,v(),v(),v()];d.emplaceBack(I[0],I[1],I[2],-1,-1,...C),d.emplaceBack(I[0],I[1],I[2],1,-1,...C),d.emplaceBack(I[0],I[1],I[2],1,1,...C),d.emplaceBack(I[0],I[1],I[2],-1,1,...C),p.emplaceBack(_+0,_+1,_+2),p.emplaceBack(_+0,_+2,_+3),_+=4}this.particlesVx=n.createVertexBuffer(d,wc.members),this.particlesIdx=n.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const n=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(n.revealStart>c)return;const d=To(0,1,n.revealStart,n.revealStart+n.revealRange,c);if(!this.particlesVx||!this.particlesIdx)return;const p=structuredClone(this._params);let _=[-p.direction.x,p.direction.y,-100];o.aw(_,_);const v=structuredClone(this._vignetteParams);v.strength*=d,p.overrideStyleParameters||(p.intensity=t.style.rain.state.density,p.timeFactor=t.style.rain.state.intensity,p.color=structuredClone(t.style.rain.state.color),_=structuredClone(t.style.rain.state.direction),p.screenThinning.intensity=t.style.rain.state.centerThinning,p.dropletSizeX=t.style.rain.state.dropletSize[0],p.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],p.distortionStrength=100*t.style.rain.state.distortionStrength,v.strength=1,v.color=structuredClone(t.style.rain.state.vignetteColor));const w=this.updateOnRender(t,p.timeFactor),I=t.context,C=I.gl,O=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new o.T(I,{width:t.width,height:t.height,data:null},C.RGBA8)),p.distortionStrength>0&&(I.activeTexture.set(C.TEXTURE0),this.screenTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),C.copyTexSubImage2D(C.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const D=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(I,D),I.activeTexture.set(C.TEXTURE0),this.screenTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE);const z=[p.color.r,p.color.g,p.color.b,p.color.a],N=(B,H)=>{const q=td(this._movement.getPosition(),B),Y=p.dropletSizeX,te=p.dropletSizeX*p.dropletSizeYScale,J=t.width/2,_e=t.height/2,he=To(0,p.screenThinning.start,0,1,p.screenThinning.intensity),pe=To(.001,p.screenThinning.range,0,1,p.screenThinning.intensity),ce=To(0,p.screenThinning.particleOffset,0,1,p.screenThinning.intensity),se=(ye={modelview:w.modelviewMatrix,projection:w.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:q,velocityConeAperture:p.velocityConeAperture,velocity:p.velocity,boxSize:B,rainDropletSize:[Y,te],distortionStrength:p.distortionStrength,rainDirection:_,color:z,screenSize:[O.width,O.height],thinningCenterPos:[J,_e],thinningShape:[he,pe,Math.pow(10,p.screenThinning.fadePower)],thinningAffectedRatio:p.screenThinning.affectedRatio,thinningParticleOffset:ce,shapeDirectionalPower:p.shapeDirPower,shapeNormalPower:p.shapeNormalPower,mode:H?0:1},{u_modelview:Float32Array.from(ye.modelview),u_projection:Float32Array.from(ye.projection),u_time:ye.time,u_cam_pos:ye.camPos,u_texScreen:0,u_velocityConeAperture:ye.velocityConeAperture,u_velocity:ye.velocity,u_boxSize:ye.boxSize,u_rainDropletSize:ye.rainDropletSize,u_distortionStrength:ye.distortionStrength,u_rainDirection:ye.rainDirection,u_color:ye.color,u_screenSize:ye.screenSize,u_thinningCenterPos:ye.thinningCenterPos,u_thinningShape:ye.thinningShape,u_thinningAffectedRatio:ye.thinningAffectedRatio,u_thinningParticleOffset:ye.thinningParticleOffset,u_shapeDirectionalPower:ye.shapeDirectionalPower,u_shapeNormalPower:ye.shapeNormalPower,u_mode:ye.mode});var ye;const Ce=Math.round(p.intensity*this.particlesCount),Se=o.bg.simpleSegment(0,0,4*Ce,2*Ce);D.draw(t,C.TRIANGLES,Bt.disabled,ri.disabled,_i.alphaBlended,ti.disabled,se,"rain_particles",this.particlesVx,this.particlesIdx,Se)};p.distortionStrength>0&&N(p.boxSize,!0),N(p.boxSize,!1),this._vignette.draw(t,v)}}const Zf=o.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class $f extends ql{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new ba("Precipitation > Snow"),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=qo(this.particlesCount),d=new o.eO,p=new o.b0;let _=0;const v=o.eq(1323123451230);for(let w=0;w<c.length;++w){const I=c[w],C=v(),O=v(),D=v(),z=[w/c.length,C,O,D],N=[v(),v()];d.emplaceBack(I[0],I[1],I[2],-1,-1,...z,...N),d.emplaceBack(I[0],I[1],I[2],1,-1,...z,...N),d.emplaceBack(I[0],I[1],I[2],1,1,...z,...N),d.emplaceBack(I[0],I[1],I[2],-1,1,...z,...N),p.emplaceBack(_+0,_+1,_+2),p.emplaceBack(_+0,_+2,_+3),_+=4}this.particlesVx=n.createVertexBuffer(d,Zf.members),this.particlesIdx=n.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const n=structuredClone(this._params);let c=[-n.direction.x,n.direction.y,-100];o.aw(c,c);const d=structuredClone(this._vignetteParams),p=n.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},_=t.transform.zoom;if(p.revealStart>_)return;const v=To(0,1,p.revealStart,p.revealStart+p.revealRange,_);d.strength*=v,n.overrideStyleParameters||(n.intensity=t.style.snow.state.density,n.timeFactor=t.style.snow.state.intensity,n.color=structuredClone(t.style.snow.state.color),c=structuredClone(t.style.snow.state.direction),n.screenThinning.intensity=t.style.snow.state.centerThinning,n.billboardSize=2.79*t.style.snow.state.flakeSize,d.strength=1,d.color=structuredClone(t.style.snow.state.vignetteColor));const w=this.updateOnRender(t,n.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const I=t.context,C=I.gl,O=t.transform,D=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(I,D),((z,N,B)=>{const H=td(this._movement.getPosition(),z),q=O.width/2,Y=O.height/2,te=To(0,B.screenThinning.start,0,1,B.screenThinning.intensity),J=To(.001,B.screenThinning.range,0,1,B.screenThinning.intensity),_e=To(0,B.screenThinning.particleOffset,0,1,B.screenThinning.intensity),he=(pe={modelview:w.modelviewMatrix,projection:w.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:H,velocityConeAperture:B.velocityConeAperture,velocity:B.velocity,horizontalOscillationRadius:B.horizontalOscillationRadius,horizontalOscillationRate:B.horizontalOscillationRate,boxSize:z,billboardSize:1*B.billboardSize,simpleShapeParameters:[B.shapeFadeStart,B.shapeFadePower],screenSize:[O.width,O.height],thinningCenterPos:[q,Y],thinningShape:[te,J,Math.pow(10,B.screenThinning.fadePower)],thinningAffectedRatio:B.screenThinning.affectedRatio,thinningParticleOffset:_e,color:[B.color.r,B.color.g,B.color.b,B.color.a],direction:c},{u_modelview:Float32Array.from(pe.modelview),u_projection:Float32Array.from(pe.projection),u_time:pe.time,u_cam_pos:pe.camPos,u_velocityConeAperture:pe.velocityConeAperture,u_velocity:pe.velocity,u_horizontalOscillationRadius:pe.horizontalOscillationRadius,u_horizontalOscillationRate:pe.horizontalOscillationRate,u_boxSize:pe.boxSize,u_billboardSize:pe.billboardSize,u_simpleShapeParameters:pe.simpleShapeParameters,u_screenSize:pe.screenSize,u_thinningCenterPos:pe.thinningCenterPos,u_thinningShape:pe.thinningShape,u_thinningAffectedRatio:pe.thinningAffectedRatio,u_thinningParticleOffset:pe.thinningParticleOffset,u_particleColor:pe.color,u_direction:pe.direction});var pe;const ce=Math.round(B.intensity*this.particlesCount),se=o.bg.simpleSegment(0,0,4*ce,2*ce);this.particlesVx&&this.particlesIdx&&D.draw(t,C.TRIANGLES,Bt.disabled,ri.disabled,_i.alphaBlended,ti.disabled,he,"snow_particles",this.particlesVx,this.particlesIdx,se)})(n.boxSize,0,n),this._vignette.draw(t,d)}}const ol={symbol:function(l,t,n,c,d){if(l.renderPass!=="translucent")return;const p=ri.disabled,_=l.colorModeForRenderPass(),v=n.layout.get("text-variable-anchor"),w=n.layout.get("text-size-scale-range"),I=o.aA(l.scaleFactor,w[0],w[1]);v&&(function(D,z,N,B,H,q,Y,te){const J=z.transform,_e=H==="map",he=q==="map";for(const pe of D){const ce=B.getTile(pe),se=ce.getBucket(N);if(!se||!se.text||!se.text.segments.get().length)continue;const ye=o.bK(se.textSizeData,J.zoom,te),Ce=qs(pe,se.getProjection(),J),Se=J.calculatePixelsToTileUnitsMatrix(ce),Ue=so(Ce,ce.tileID.canonical,he,_e,J,se.getProjection(),Se),je=se.hasIconTextFit()&&se.hasIconData();ye&&Yt(se,_e,he,Y,J,Ue,pe,Math.pow(2,J.zoom-ce.tileID.overscaledZ),ye,je)}})(c,l,n,t,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),d,I);const C=n.paint.get("icon-opacity").constantOr(1)!==0,O=n.paint.get("text-opacity").constantOr(1)!==0;n.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(C||O)?Tu(l,t,n,c,p,_):(C&&Tu(l,t,n,c,p,_,{onlyIcons:!0}),O&&Tu(l,t,n,c,p,_,{onlyText:!0})),t.map.showCollisionBoxes&&(Lt(l,t,n,c,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),Lt(l,t,n,c,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(l,t,n,c){if(l.renderPass!=="translucent")return;const d=n.paint.get("circle-opacity"),p=n.paint.get("circle-stroke-width"),_=n.paint.get("circle-stroke-opacity"),v=n.layout.get("circle-sort-key").constantOr(1)!==void 0,w=n.paint.get("circle-emissive-strength");if(d.constantOr(1)===0&&(p.constantOr(1)===0||_.constantOr(1)===0))return;const I=l.context,C=I.gl,O=l.transform,D=!(!l.terrain||!l.terrain.enabled),z=n.layout.get("circle-elevation-reference"),N=l.depthModeForSublayer(0,Bt.ReadOnly),B=new Bt(l.context.gl.LEQUAL,Bt.ReadOnly,l.depthRangeFor3D),H=z==="none"||D?N:B,q=ri.disabled,Y=l.colorModeForDrapableLayerRenderPass(w),te=O.projection.name==="globe",J=[o.aF(O.center.lng),o.aJ(O.center.lat)],_e=[];for(let pe=0;pe<c.length;pe++){const ce=c[pe],se=t.getTile(ce),ye=se.getBucket(n);if(!ye||ye.projection.name!==O.projection.name)continue;const Ce=ye.programConfigurations.get(n.id),Se=ye.layoutVertexBuffer,Ue=ye.globeExtVertexBuffer,je=ye.indexBuffer,Xe=o.e0(n),ht=[Ue],ke=l.isTileAffectedByFog(ce);te&&Xe.push("PROJECTION_GLOBE_VIEW"),Xe.push("DEPTH_D24"),l.terrain&&O.depthOcclusionForSymbolsAndCircles&&Xe.push("DEPTH_OCCLUSION"),ye.hasElevation&&!l.terrain&&(Xe.push("ELEVATED_ROADS"),ht.push(ye.elevatedLayoutVertexBuffer));const we=l.getOrCreateProgram("circle",{config:Ce,defines:Xe,overrideFog:ke}),He=O.projection.createInversionMatrix(O,ce.canonical),Be={programConfiguration:Ce,program:we,layoutVertexBuffer:Se,dynamicBuffers:ht,indexBuffer:je,uniformValues:o.e1(l,ce,se,He,J,n),tile:se};if(v){const et=ye.segments.get();for(const vt of et)_e.push({segments:new o.bg([vt]),sortKey:vt.sortKey,state:Be})}else _e.push({segments:ye.segments,sortKey:0,state:Be})}v&&_e.sort(((pe,ce)=>pe.sortKey-ce.sortKey));const he={useDepthForOcclusion:O.depthOcclusionForSymbolsAndCircles};for(const pe of _e){const{programConfiguration:ce,program:se,layoutVertexBuffer:ye,dynamicBuffers:Ce,indexBuffer:Se,uniformValues:Ue,tile:je}=pe.state,Xe=pe.segments;l.terrain&&l.terrain.setupElevationDraw(je,se,he),l.uploadCommonUniforms(I,se,je.tileID.toUnwrapped()),se.draw(l,C.TRIANGLES,H,q,Y,ti.disabled,Ue,n.id,ye,Se,Xe,n.paint,O.zoom,ce,Ce)}},heatmap:function(l,t,n,c){if(n.paint.get("heatmap-opacity")!==0)if(l.renderPass==="offscreen"){const d=l.context,p=d.gl,_=ri.disabled,v=new _i([p.ONE,p.ONE,p.ONE,p.ONE],o.ao.transparent,[!0,!0,!0,!0]);(function(z,N,B,H){const q=z.gl,Y=N.width*H,te=N.height*H;z.activeTexture.set(q.TEXTURE1),z.viewport.set([0,0,Y,te]);let J=B.heatmapFbo;if(!J||J&&(J.width!==Y||J.height!==te)){J&&J.destroy();const _e=q.createTexture();q.bindTexture(q.TEXTURE_2D,_e),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_S,q.CLAMP_TO_EDGE),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_T,q.CLAMP_TO_EDGE),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MIN_FILTER,q.LINEAR),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MAG_FILTER,q.LINEAR),J=B.heatmapFbo=z.createFramebuffer(Y,te,1,null),(function(he,pe,ce,se,ye,Ce){const Se=he.gl;Se.texImage2D(Se.TEXTURE_2D,0,he.extRenderToTextureHalfFloat?Se.RGBA16F:Se.RGBA,ye,Ce,0,Se.RGBA,he.extRenderToTextureHalfFloat?Se.HALF_FLOAT:Se.UNSIGNED_BYTE,null),se.colorAttachment0.set(ce)})(z,0,_e,J,Y,te)}else q.bindTexture(q.TEXTURE_2D,J.colorAttachment0.get()),z.bindFramebuffer.set(J.framebuffer)})(d,l,n,l.transform.projection.name==="globe"?.5:.25),d.clear({color:o.ao.transparent});const w=l.transform,I=w.projection.name==="globe",C=I?["PROJECTION_GLOBE_VIEW"]:[],O=I?ti.frontCCW:ti.disabled,D=[o.aF(w.center.lng),o.aJ(w.center.lat)];for(let z=0;z<c.length;z++){const N=c[z];if(t.hasRenderableParent(N))continue;const B=t.getTile(N),H=B.getBucket(n);if(!H||H.projection.name!==w.projection.name)continue;const q=l.isTileAffectedByFog(N),Y=H.programConfigurations.get(n.id),te=l.getOrCreateProgram("heatmap",{config:Y,defines:C,overrideFog:q}),{zoom:J}=l.transform;l.terrain&&l.terrain.setupElevationDraw(B,te),l.uploadCommonUniforms(d,te,N.toUnwrapped());const _e=w.projection.createInversionMatrix(w,N.canonical);te.draw(l,p.TRIANGLES,Bt.disabled,_,v,O,Ym(l,N,B,_e,D,J,n.paint.get("heatmap-intensity")),n.id,H.layoutVertexBuffer,H.indexBuffer,H.segments,n.paint,l.transform.zoom,Y,I?[H.globeExtVertexBuffer]:null)}d.viewport.set([0,0,l.width,l.height])}else l.renderPass==="translucent"&&(l.context.setColorMode(l.colorModeForRenderPass()),(function(d,p){const _=d.context,v=_.gl,w=p.heatmapFbo;if(!w)return;_.activeTexture.set(v.TEXTURE0),v.bindTexture(v.TEXTURE_2D,w.colorAttachment0.get()),_.activeTexture.set(v.TEXTURE1);let I=p.colorRampTexture;I||(I=p.colorRampTexture=new o.T(_,p.colorRamp,v.RGBA8)),I.bind(v.LINEAR,v.CLAMP_TO_EDGE),d.getOrCreateProgram("heatmapTexture").draw(d,v.TRIANGLES,Bt.disabled,ri.disabled,d.colorModeForRenderPass(),ti.disabled,((C,O,D,z)=>({u_image:0,u_color_ramp:1,u_opacity:O.paint.get("heatmap-opacity")}))(0,p),p.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments,p.paint,d.transform.zoom)})(l,n))},line:function(l,t,n,c){if(l.renderPass!=="translucent")return;const d=n.paint.get("line-opacity"),p=n.paint.get("line-width");if(d.constantOr(1)===0||p.constantOr(1)===0)return;const _=n.paint.get("line-emissive-strength").isConstant(),v=n.paint.get("line-emissive-strength").constantOr(0),w=n.paint.get("line-occlusion-opacity"),I=n.layout.get("line-elevation-reference"),C=n.layout.get("line-width-unit")==="meters",O=I==="sea",D=!(!l.terrain||!l.terrain.enabled),z=l.context,N=z.gl;if(n.hasElevatedBuckets&&l.transform.projection.name==="globe")return;const B=n.layout.get("line-cross-slope"),H=B!==void 0,q=B<1,Y=l.colorModeForDrapableLayerRenderPass(_?v:null),te=l.terrain&&l.terrain.renderingToTexture,J=te?1:o.o.devicePixelRatio,_e=n.paint.get("line-dasharray"),he=_e.constantOr(1),pe=n.layout.get("line-cap"),ce=_e.constantOr(null),se=pe.constantOr(null),ye=n.paint.get("line-pattern"),Ce=ye.constantOr(1),Se=n.paint.get("line-pattern-cross-fade"),Ue=ye.constantOr(null),je=n.paint.get("line-opacity").constantOr(1);let Xe=!Ce&&je!==1||l.depthOcclusion&&w>0&&w<1;const ht=n.paint.get("line-gradient"),ke=Ce?"linePattern":"line",we=o.e2(n);let He;if(te&&l.terrain&&l.terrain.clipOrMaskOverlapStencilType()&&(Xe=!1),w!==0&&l.depthOcclusion){const St=n.paint._values["line-opacity"];St&&St.value&&St.value.kind==="constant"?He=St.value:o.w(`Occlusion opacity for layer ${n.id} is supported only when line-opacity isn't data-driven.`)}p.value.kind!=="constant"&&p.value.isLineProgressConstant===!1&&we.push("VARIABLE_LINE_WIDTH"),te&&(l.emissiveMode!=="dual-source-blending"||_?l.emissiveMode==="mrt-fallback"&&we.push("USE_MRT1"):we.push("DUAL_SOURCE_BLENDING"));const Be=(St,_t,dt,kt,Dt,Tt)=>{for(const At of St){const Wt=t.getTile(At);if(Ce&&!Wt.patternsLoaded())continue;const ci=Wt.getBucket(n);if(!ci||ci.elevationType!=="none"&&!Dt||ci.elevationType==="none"&&Dt)continue;l.prepareDrawTile();const Di=[..._t],er=l.shadowRenderer,Ft=ci.elevationType==="road"&&!!er&&er.enabled;let Ji=[0,0,0];if(Ft){const xi=l.style.directionalLight,Mr=l.style.ambientLight;xi&&Mr&&(Ji=ma(l.style,xi,Mr)),Di.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const ai=ci.programConfigurations.get(n.id);let nr=!1;if(Ue&&Wt.imageAtlas){const xi=o.e3.from(Ue),Mr=xi.getPrimary().scaleSelf(J).toString(),sn=Wt.imageAtlas.patternPositions.get(Mr),Br=xi.getSecondary(),vr=Br?Wt.imageAtlas.patternPositions.get(Br.scaleSelf(J).toString()):null;nr=!!sn&&!!vr,sn&&ai.setConstantPatternPositions(sn,vr)}Se>0&&(nr||ai.getPatternTransitionVertexBuffer("line-pattern"))&&Di.push("LINE_PATTERN_TRANSITION");const fr=l.isTileAffectedByFog(At),cr=l.getOrCreateProgram(ke,{config:ai,defines:Di,overrideFog:fr});if(!Ce&&ce&&se&&Wt.lineAtlas){const xi=Wt.lineAtlas.getDash(ce,se);xi&&ai.setConstantPatternPositions(xi)}Ft&&er.setupShadows(Wt.tileID.toUnwrapped(),cr,"vector-tile");let[Xi,vi]=n.paint.get("line-trim-offset");(se==="round"||se==="square")&&Xi!==vi&&(Xi===0&&(Xi-=1),vi===1&&(vi+=1));const ir=te?At.projMatrix:null,$r=C?1/ci.tileToMeter/o.ay(Wt,1,l.transform.zoom):1,Rr=C?1/ci.tileToMeter/o.ay(Wt,1,Math.floor(l.transform.zoom)):1,or=Ce?o.e4(l,Wt,n,ir,J,$r,Rr,[Xi,vi],Ji,Se):o.e5(l,Wt,n,ir,ci.lineClipsArray.length,J,$r,Rr,[Xi,vi],Ji);if(ht){const xi=ci.gradients[n.id];let Mr=xi.texture;if(n.gradientVersion!==xi.version){let sn=256;if(n.stepInterpolant){const Br=t.getSource().maxzoom,vr=At.canonical.z===Br?Math.ceil(1<<l.transform.maxZoom-At.canonical.z):1;sn=o.aA(o.e6(ci.maxLineLength/o.al*1024*vr),256,z.maxTextureSize)}xi.gradient=o.e7({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:sn,image:xi.gradient||void 0,clips:ci.lineClipsArray}),xi.texture?xi.texture.update(xi.gradient):xi.texture=new o.T(z,xi.gradient,N.RGBA8),xi.version=n.gradientVersion,Mr=xi.texture}z.activeTexture.set(N.TEXTURE1),Mr.bind(n.stepInterpolant?N.NEAREST:N.LINEAR,N.CLAMP_TO_EDGE)}he&&(z.activeTexture.set(N.TEXTURE0),Wt.lineAtlasTexture&&Wt.lineAtlasTexture.bind(N.LINEAR,N.REPEAT),ai.updatePaintBuffers()),Ce&&(z.activeTexture.set(N.TEXTURE0),Wt.imageAtlasTexture&&Wt.imageAtlasTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),ai.updatePaintBuffers()),Dt&&!O&&l.terrain.setupElevationDraw(Wt,cr),l.uploadCommonUniforms(z,cr,At.toUnwrapped());const Gi=xi=>{He!=null&&(He.value=je*w),cr.draw(l,N.TRIANGLES,dt,xi,Y,ti.disabled,or,n.id,ci.layoutVertexBuffer,ci.indexBuffer,ci.segments,n.paint,l.transform.zoom,ai,[ci.layoutVertexBuffer2,ci.patternVertexBuffer,ci.zOffsetVertexBuffer]),He!=null&&(He.value=je)};if(Xe&&!Dt){const xi=l.stencilModeForClipping(At).ref;xi===0&&te&&z.clear({stencil:0});const Mr={func:N.EQUAL,mask:255};or.u_alpha_discard_threshold=.8,Gi(new ri(Mr,xi,255,N.KEEP,N.KEEP,N.INVERT)),or.u_alpha_discard_threshold=0,Gi(new ri(Mr,xi,255,N.KEEP,N.KEEP,N.KEEP))}else or.u_alpha_discard_threshold=Xe&&Dt&&Tt?.8:0,Gi(Dt?kt:l.stencilModeForClipping(At))}};let et=l.depthModeForSublayer(0,Bt.ReadOnly);const vt=new Bt(l.depthOcclusion?N.GREATER:N.LEQUAL,Bt.ReadOnly,l.depthRangeFor3D);if(n.hasNonElevatedBuckets){const St=!te&&l.terrain;w!==0&&St?o.w(`Occlusion opacity for layer ${n.id} is supported on terrain only if the layer has line-z-offset enabled.`):St?o.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${n.id}.`):Be(c,we,et,ri.disabled,!1,!0)}if(n.hasElevatedBuckets){I==="hd-road-markup"?D||(et=vt,we.push("ELEVATED_ROADS")):(we.push("ELEVATED"),et=vt,H&&we.push(q?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),O&&we.push("ELEVATION_REFERENCE_SEA"));const St=Xe?l.stencilModeFor3D():ri.disabled;l.forceTerrainMode=!0,Be(c,we,et,St,!0,!0),Xe&&Be(c,we,et,St,!0,!1),l.forceTerrainMode=!1}Xe&&(l.resetStencilClippingMasks(),te&&z.clear({stencil:0})),w===0||l.depthOcclusion||te||l.layersWithOcclusionOpacity.push(l.currentLayer)},fill:function(l,t,n,c){const d=n.paint.get("fill-color"),p=n.paint.get("fill-opacity");if(p.constantOr(1)===0)return;const _=n.paint.get("fill-emissive-strength"),v=l.colorModeForDrapableLayerRenderPass(_),w=n.paint.get("fill-pattern"),I=l.opaquePassEnabledForLayer()&&!w.constantOr(1)&&d.constantOr(o.ao.transparent).a===1&&p.constantOr(0)===1?"opaque":"translucent";let C="none";n.layout.get("fill-elevation-reference")!=="none"?C="road":n.paint.get("fill-z-offset").constantOr(1)!==0&&(C="offset");const O=!(!l.terrain||!l.terrain.enabled),D={painter:l,sourceCache:t,layer:n,coords:c,colorMode:v,elevationType:C,terrainEnabled:O,pass:I};if(l.renderPass==="shadow")return void(l.shadowRenderer&&C==="road"&&!O&&(function(N){const{painter:B,sourceCache:H,layer:q,coords:Y}=N,te=B.context.gl,J=N.painter.shadowRenderer;for(const _e of Y){const he=H.getTile(_e),pe=he.getBucket(q);if(!pe)continue;const ce=pe.elevatedStructures;if(!ce||!ce.shadowCasterSegments||ce.shadowCasterSegments.segments[0].primitiveLength===0)continue;B.prepareDrawTile();const se=pe.bufferData.programConfigurations.get(q.id),ye=B.isTileAffectedByFog(_e),Ce=B.getOrCreateProgram("elevatedStructuresDepth",{config:se,overrideFog:ye}),Se=J.calculateShadowPassMatrixFromTile(he.tileID.toUnwrapped());B.uploadCommonUniforms(B.context,Ce,_e.toUnwrapped());const Ue={u_matrix:Se,u_depth_bias:0};Ce.draw(B,te.TRIANGLES,J.getShadowPassDepthMode(),ri.disabled,J.getShadowPassColorMode(),ti.disabled,Ue,q.id,ce.vertexBuffer,ce.indexBuffer,ce.shadowCasterSegments,q.paint,B.transform.zoom,se)}})(D));const z=l.emissiveMode==="mrt-fallback";if(C!=="offset"){if(qh(D,!1,z),C==="road"){const N=!O&&l.renderPass==="translucent";N&&Gh(l,t,n,c,"geometry"),qh(D,!0,z,ri.disabled),N&&(function(B){const{painter:H,sourceCache:q,layer:Y,coords:te,colorMode:J}=B,_e=H.context.gl,he=B.painter.shadowRenderer,pe=!!he&&he.enabled,ce=new Bt(H.context.gl.LEQUAL,Bt.ReadOnly,H.depthRangeFor3D);let se=[0,0,0];if(pe){const Ce=H.style.directionalLight,Se=H.style.ambientLight;Ce&&Se&&(se=ma(H.style,Ce,Se))}const ye=Ce=>{for(const Se of te){const Ue=q.getTile(Se),je=Ue.getBucket(Y);if(!je)continue;const Xe=je.elevatedStructures;if(!Xe)continue;let ht,ke;if(Ce?(ht=Xe.renderableBridgeSegments,ke=Xe.bridgeProgramConfigurations.get(Y.id)):(ht=Xe.renderableTunnelSegments,ke=Xe.tunnelProgramConfigurations.get(Y.id)),!ht||ht.segments[0].primitiveLength===0)continue;ke.updatePaintBuffers(),H.prepareDrawTile();const we=H.isTileAffectedByFog(Se),He=[];pe&&He.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Be=H.getOrCreateProgram("elevatedStructures",{config:ke,overrideFog:we,defines:He}),et=H.translatePosMatrix(Se.projMatrix,Ue,Y.paint.get("fill-translate"),Y.paint.get("fill-translate-anchor"));pe&&he.setupShadows(Ue.tileID.toUnwrapped(),Be,"vector-tile");const vt=el(et,se);H.uploadCommonUniforms(H.context,Be,Se.toUnwrapped()),Be.draw(H,_e.TRIANGLES,ce,ri.disabled,J,ti.backCCW,vt,Y.id,Xe.vertexBuffer,Xe.indexBuffer,ht,Y.paint,H.transform.zoom,ke,[Xe.vertexBufferNormal])}};ye(!0),ye(!1)})(D)}}else qh(D,!1,z,l.stencilModeFor3D())},"fill-extrusion":function(l,t,n,c){const d=n.paint.get("fill-extrusion-opacity"),p=l.context,_=p.gl,v=l.terrain,w=v&&v.renderingToTexture;if(d===0)return;const I=l.emissiveMode==="mrt-fallback",C=l.conflationActive&&l.style.isLayerClipped(n,t.getSource()),O=l.style.order.indexOf(n.fqid);if(C&&(function(D,z,N,B,H){for(const q of B){const Y=z.getTile(q).getBucket(N);Y&&(Y.updateReplacement(q,D.replacementSource,H),Y.uploadCentroid(D.context))}})(l,t,n,c,O),v||C)for(const D of c){const z=t.getTile(D).getBucket(n);z&&Ey(l.context,t,D,z,n,v,C)}if(l.renderPass==="shadow"&&l.shadowRenderer){const D=l.shadowRenderer;if(v&&d<.65&&n._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof o.ad)return;const z=D.getShadowPassDepthMode(),N=D.getShadowPassColorMode();Hh(l,t,n,c,z,ri.disabled,N,C)}else if(l.renderPass==="translucent"){const D=!n.paint.get("fill-extrusion-pattern").constantOr(1),z=n.paint.get("fill-extrusion-color").constantOr(o.ao.white);if(!w&&z.a!==0){const N=new Bt(l.context.gl.LEQUAL,Bt.ReadWrite,l.depthRangeFor3D);d===1&&D?Hh(l,t,n,c,N,ri.disabled,_i.unblended,C):(Hh(l,t,n,c,N,ri.disabled,_i.disabled,C),Hh(l,t,n,c,N,l.stencilModeFor3D(),l.colorModeForRenderPass(),C),l.resetStencilClippingMasks())}if(l.style.enable3dLights()&&D&&(!v&&l.transform.projection.name!=="globe"||w)){const N=n.paint.get("fill-extrusion-opacity"),B=n.paint.get("fill-extrusion-ambient-occlusion-intensity"),H=n.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),q=n.paint.get("fill-extrusion-flood-light-intensity"),Y=n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",te=n.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(Y?null:n.lut).toArray01().slice(0,3),J=B>0&&H>0,_e=q>0,he=(se,ye,Ce)=>(1-Ce)*se+Ce*ye,pe=new Vf;pe.translate=n.paint.get("fill-extrusion-translate"),pe.translateAnchor=n.paint.get("fill-extrusion-translate-anchor"),pe.edgeRadius=n.layout.get("fill-extrusion-edge-radius"),pe.cutoffFadeRange=n.paint.get("fill-extrusion-cutoff-fade-range");const ce=se=>{const ye=l.depthModeForSublayer(1,Bt.ReadOnly,_.LEQUAL,!0),Ce=n.paint.get(se?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Se=he(.1,3,Ce),Ue=l._showOverdrawInspector;if(!Ue){const je=new ri({func:_.ALWAYS,mask:255},255,255,_.KEEP,_.KEEP,_.REPLACE),Xe=new _i([_.ONE,_.ONE,_.ONE,_.ONE],o.ao.transparent,[!1,!1,!1,!0],_.MIN);ya(pe,l,t,n,c,ye,je,Xe,ti.disabled,se,"sdf",N,B,H,q,te,Se,C,!1)}{const je=Ue?ri.disabled:new ri({func:_.EQUAL,mask:255},255,255,_.KEEP,_.DECR,_.DECR),Xe=Ue?l.colorModeForRenderPass():new _i([_.ONE_MINUS_DST_ALPHA,_.DST_ALPHA,_.ONE,_.ONE],o.ao.transparent,[!0,!0,!0,!0]);ya(pe,l,t,n,c,ye,je,Xe,ti.disabled,se,"color",N,B,H,q,te,Se,C,!1)}};if(w){const se=()=>{const Ce=v.drapeBufferSize[0],Se=v.drapeBufferSize[1];let Ue=v.framebufferCopyTexture;return Ue&&(!Ue||Ue.size[0]===Ce&&Ue.size[1]===Se)||(Ue&&Ue.destroy(),Ue=v.framebufferCopyTexture=new o.T(p,new o.q({width:Ce,height:Se}),_.RGBA8)),Ue.bind(_.LINEAR,_.CLAMP_TO_EDGE),_.copyTexSubImage2D(_.TEXTURE_2D,0,0,0,0,0,Ce,Se),Ue},ye=(Ce,Se,Ue)=>{const je=l.depthModeForSublayer(1,Bt.ReadOnly,_.LEQUAL,!1),Xe=n.paint.get(Ce?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ht=he(.1,3,Xe);{const ke=new _i([_.ONE,_.ONE,_.ONE,_.ONE],o.ao.transparent,[!1,!1,!1,!0]);ya(pe,l,t,n,c,je,ri.disabled,ke,ti.disabled,Ce,"clear",N,B,H,q,te,ht,C,Se)}{const ke=new ri({func:_.ALWAYS,mask:255},255,255,_.KEEP,_.KEEP,_.REPLACE),we=new _i([_.ONE,_.ONE,_.ONE,_.ONE],o.ao.transparent,[!1,!1,!1,!0],_.MIN);ya(pe,l,t,n,c,je,ke,we,ti.disabled,Ce,"sdf",N,B,H,q,te,ht,C,Se)}I&&!Ce&&(Ue=se());{const ke=Ce?_.ZERO:_.ONE_MINUS_DST_ALPHA,we=new ri({func:_.EQUAL,mask:255},255,255,_.KEEP,_.DECR,_.DECR),He=new _i([ke,_.DST_ALPHA,_.ONE_MINUS_DST_ALPHA,_.ZERO],o.ao.transparent,[!0,!0,!0,!0]);ya(pe,l,t,n,c,je,we,He,ti.disabled,Ce,"color",N,B,H,q,te,ht,C,Se)}if(!I||Ce){const ke=new _i([_.ONE,_.ONE,_.ONE,Ce?_.ZERO:_.ONE],o.ao.transparent,[!1,!1,!1,!0],Ce?_.FUNC_ADD:_.MAX);ya(pe,l,t,n,c,je,ri.disabled,ke,ti.disabled,Ce,"clear",N,B,H,q,te,ht,C,Se,Ue)}else{_.drawBuffers([_.NONE,_.COLOR_ATTACHMENT1]);const ke=new ri({func:_.EQUAL,mask:255},254,255,_.KEEP,_.DECR,_.DECR),we=new _i([_.ONE,_.ONE,_.ONE,_.ONE],o.ao.transparent,[!0,!1,!1,!1],_.MAX);ya(pe,l,t,n,c,je,ke,we,ti.disabled,Ce,"emissive",N,B,H,q,te,ht,C,Se,Ue),_.drawBuffers([_.COLOR_ATTACHMENT0])}};if(J||_e){let Ce;l.prepareDrawTile(),I&&!J||(Ce=se()),J&&ye(!0,!1,Ce),_e&&ye(!1,!0,Ce)}}else J&&ce(!0),_e&&ce(!1),(J||_e)&&l.resetStencilClippingMasks()}}},building:function(l,t,n,c){l.currentLayer<l.firstLightBeamLayer&&(l.firstLightBeamLayer=l.currentLayer);const d=n.paint.get("building-ambient-occlusion-ground-intensity"),p=n.paint.get("building-ambient-occlusion-ground-radius"),_=n.paint.get("building-ambient-occlusion-ground-attenuation"),v=n.paint.get("building-opacity");if(v<=0)return;let w=d>0&&p>0,I=!0;const C=n.paint.get("building-vertical-scale");if(C<=0)return;l.shadowRenderer||(I=!1);const O=l.conflationActive&&l.style.isLayerClipped(n,t.getSource()),D=l.style.order.indexOf(n.fqid);if((function(z,N,B,H,q,Y){for(const te of Y){const J=N.getTile(te).getBucket(B);J&&(q&&J.updateReplacement(te,z.replacementSource,H),J.uploadUpdatedIndexBuffer(z.context))}})(l,t,n,D,O,c),(function(z,N,B,H){for(const q of H){const Y=N.getTile(q).getBucket(B);Y&&Y.needsEvaluation()&&Y.uploadUpdatedColorBuffer(z.context)}})(l,t,n,c),n.resetLayerRenderingStats(l),l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0),l.renderPass==="shadow"&&l.shadowRenderer){const z=l.shadowRenderer,N=[],B=z.getShadowPassDepthMode();Eu({painter:l,source:t,layer:n,coords:c,defines:N,blendMode:z.getShadowPassColorMode(),depthMode:B,opacity:v,verticalScale:C,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}else if(l.renderPass==="translucent"){let z=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];I&&(z=z.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),l.shadowRenderer&&l.shadowRenderer.useNormalOffset&&(z=z.concat("NORMAL_OFFSET"));const N=n.paint.get("building-facade-emissive-chance"),B=n.paint.get("building-ambient-occlusion-intensity"),H=n.paint.get("building-flood-light-intensity"),q=n.paint.get("building-flood-light-color-use-theme").constantOr("default")==="none",Y=n.paint.get("building-flood-light-color").toNonPremultipliedRenderColor(q?null:n.lut).toArray01().slice(0,3),te=n.paint.get("building-flood-light-ground-attenuation"),J=H>0,_e=new Bt(l.context.gl.LEQUAL,Bt.ReadWrite,l.depthRangeFor3D);v<1&&Eu({painter:l,source:t,layer:n,coords:c,defines:z,blendMode:_i.disabled,depthMode:_e,opacity:v,verticalScale:C,facadeEmissiveChance:N,facadeAOIntensity:B,floodLightIntensity:H,floodLightColor:Y,depthOnly:!0});const he=l.colorModeForRenderPass();Eu({painter:l,source:t,layer:n,coords:c,defines:z,blendMode:he,depthMode:_e,opacity:v,verticalScale:C,facadeEmissiveChance:N,facadeAOIntensity:B,floodLightIntensity:H,floodLightColor:Y}),w&&Zh(l,t,n,c,!0,v,d,p,H,Y,_,O),J&&Zh(l,t,n,c,!1,v,d,p,H,Y,te,O)}else if(l.renderPass==="light-beam"){const z=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],N=new Bt(l.context.gl.LEQUAL,Bt.ReadOnly,l.depthRangeFor3D);Eu({painter:l,source:t,layer:n,coords:c,defines:z,blendMode:_i.alphaBlended,depthMode:N,opacity:v,verticalScale:C,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1),l.resetStencilClippingMasks()},hillshade:function(l,t,n,c){if(l.renderPass!=="offscreen"&&l.renderPass!=="translucent"||l.style.disableElevatedTerrain)return;const d=l.context,p=l.terrain&&l.terrain.renderingToTexture,[_,v]=l.renderPass!=="translucent"||p?[{},c]:l.stencilConfigForOverlap(c);for(const w of v){const I=t.getTile(w);if(I.needsHillshadePrepare&&l.renderPass==="offscreen")py(l,I,n);else if(l.renderPass==="translucent"){const C=l.depthModeForSublayer(0,Bt.ReadOnly),O=n.paint.get("hillshade-emissive-strength"),D=l.colorModeForDrapableLayerRenderPass(O),z=p&&l.terrain?l.terrain.stencilModeForRTTOverlap(w):_[w.overscaledZ];fy(l,w,I,n,C,z,D)}}d.viewport.set([0,0,l.width,l.height]),l.resetStencilClippingMasks()},raster:function(l,t,n,c,d,p){if(l.renderPass!=="translucent"||n.paint.get("raster-opacity")===0)return;const _=l.transform.projection.name==="globe",v=n.paint.get("raster-elevation")!==0,w=v&&_;if(l.renderElevatedRasterBackface&&!w)return;const I=l.context,C=I.gl,O=t.getSource(),D=(function(he,pe,ce,se,ye){const Ce=pe.paint.get("raster-color"),Se=he.type==="raster-array",Ue=[],je=pe.paint.get("raster-resampling"),Xe=pe.paint.get("raster-color-mix");let ht=pe.paint.get("raster-color-range");const ke=[Xe[0],Xe[1],Xe[2],0],we=Xe[3];let He=je==="nearest"?se.NEAREST:se.LINEAR;if(Se&&(Ue.push("RASTER_ARRAY"),Ce||Ue.push("RASTER_COLOR"),je==="linear"&&Ue.push("RASTER_ARRAY_LINEAR"),He=se.NEAREST,!ht&&he.rasterLayers)){const Be=he.rasterLayers.find((({id:et})=>et===pe.sourceLayer));Be&&Be.fields&&Be.fields.range&&(ht=Be.fields.range)}if(ht=ht||[0,1],Ce){Ue.push("RASTER_COLOR"),ce.activeTexture.set(se.TEXTURE2),pe.updateColorRamp(ht);let Be=pe.colorRampTexture;Be||(Be=pe.colorRampTexture=new o.T(ce,pe.colorRamp,se.RGBA8)),Be.bind(se.LINEAR,se.CLAMP_TO_EDGE)}return ye&&Ue.push("USE_MRT1"),{mix:ke,range:ht,offset:we,defines:Ue,resampling:He}})(O,n,I,C,l.terrain&&l.terrain.renderingToTexture&&l.emissiveMode==="mrt-fallback");if(O instanceof o.aU&&!c.length&&!_)return;const z=n.paint.get("raster-emissive-strength"),N=l.colorModeForDrapableLayerRenderPass(z),B=l.terrain&&l.terrain.renderingToTexture,H=!l.options.moving,q=n.paint.get("raster-resampling")==="nearest"?C.NEAREST:C.LINEAR;if(O instanceof o.aU&&!c.length&&(O.onNorthPole||O.onSouthPole)){const he=v?l.stencilModeFor3D():ri.disabled;return void Su(!!O.onNorthPole,null,l,t,n,z,D,ti.disabled,he)}if(!c.length)return;const[Y,te]=O instanceof o.aU||B?[{},c]:l.stencilConfigForOverlap(c),J=te[te.length-1].overscaledZ;w&&D.defines.push("PROJECTION_GLOBE_VIEW"),v&&D.defines.push("RENDER_CUTOFF");const _e=(he,pe,ce)=>{for(const se of he){const ye=se.toUnwrapped(),Ce=t.getTile(se);if(B&&(!Ce||!Ce.hasData()))continue;I.activeTexture.set(C.TEXTURE0);const Se=xa(Ce,O,n,D);if(!Se||!Se.texture)continue;const{texture:Ue,mix:je,offset:Xe,tileSize:ht,buffer:ke}=Se;let we,He;B?(we=Bt.disabled,He=se.projMatrix):v?(we=new Bt(C.LEQUAL,Bt.ReadWrite,l.depthRangeFor3D),He=_?Float32Array.from(l.transform.expandedFarZProjMatrix):l.transform.calculateProjMatrix(ye,H)):(we=l.depthModeForSublayer(se.overscaledZ-J,n.paint.get("raster-opacity")===1?Bt.ReadWrite:Bt.ReadOnly,C.LESS),He=l.transform.calculateProjMatrix(ye,H));const Be=l.terrain&&B?l.terrain.stencilModeForRTTOverlap(se):Y[se.overscaledZ],et=p?0:n.paint.get("raster-fade-duration");Ce.registerFadeDuration(et);const vt=t.findLoadedParent(se,0),St=vu(Ce,vt,t,l.transform,et);let _t,dt;!St.isFading&&Ce.refreshedUponExpiration&&(Ce.refreshedUponExpiration=!1),l.terrain&&l.terrain.prepareDrawTile(),I.activeTexture.set(C.TEXTURE0),Ue.bind(q,C.CLAMP_TO_EDGE),I.activeTexture.set(C.TEXTURE1),vt?(vt.texture&&vt.texture.bind(q,C.CLAMP_TO_EDGE),_t=Math.pow(2,vt.tileID.overscaledZ-Ce.tileID.overscaledZ),dt=[Ce.tileID.canonical.x*_t%1,Ce.tileID.canonical.y*_t%1]):Ue.bind(q,C.CLAMP_TO_EDGE),"useMipmap"in Ue&&I.extTextureFilterAnisotropic&&l.transform.pitch>20&&C.texParameterf(C.TEXTURE_2D,I.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,I.extTextureFilterAnisotropicMax);const kt=l.transform;let Dt;const Tt=v?n_(kt):[0,0,0,0];let At,Wt,ci,Di,er,Ft=0;if(w&&O instanceof o.aU&&O.coordinates.length>3)At=Float32Array.from(o.bk(o.dJ(new o.cD(0,0,0)))),Wt=Float32Array.from(kt.globeMatrix),ci=Float32Array.from(o.dF(kt)),Di=[o.aF(kt.center.lng),o.aJ(kt.center.lat)],Dt=O.elevatedGlobePerspectiveTransform,er=O.elevatedGlobeGridMatrix||new Float32Array(9);else if(w){const fr=o.dG(se.canonical);Ft=o.dH(fr.getCenter().lat),At=Float32Array.from(o.bk(o.dJ(se.canonical))),Wt=Float32Array.from(kt.globeMatrix),ci=Float32Array.from(o.dF(kt)),Di=[o.aF(kt.center.lng),o.aJ(kt.center.lat)],Dt=[0,0],er=Float32Array.from(o.dI(se.canonical,fr,Ft,kt.worldSize/kt._pixelsPerMercatorPixel))}else Dt=O instanceof o.aU?O.perspectiveTransform:[0,0],At=new Float32Array(16),Wt=new Float32Array(9),ci=new Float32Array(16),Di=[0,0],er=new Float32Array(9);const Ji=Jm(He,At,Wt,ci,er,dt||[0,0],o.aj(l.transform.zoom),Di,Tt,_t||1,St,n,Dt,v?n.paint.get("raster-elevation"):0,2,je,Xe,D.range,ht,ke,z),ai=l.isTileAffectedByFog(se),nr=l.getOrCreateProgram("raster",{defines:D.defines,overrideFog:ai});if(l.uploadCommonUniforms(I,nr,ye),O instanceof o.aU){const fr=O.elevatedGlobeVertexBuffer,cr=O.elevatedGlobeIndexBuffer;if(B||!_)O.boundsBuffer&&O.boundsSegments&&nr.draw(l,C.TRIANGLES,we,ri.disabled,N,ti.disabled,Ji,n.id,O.boundsBuffer,l.quadTriangleIndexBuffer,O.boundsSegments);else if(fr&&cr){const Xi=kt.zoom<=o.c_?O.elevatedGlobeSegments:O.getSegmentsForLongitude(kt.center.lng);Xi&&nr.draw(l,C.TRIANGLES,we,ri.disabled,N,pe,Ji,n.id,fr,cr,Xi)}}else if(w){we=new Bt(C.LEQUAL,Bt.ReadOnly,l.depthRangeFor3D);const fr=l.globeSharedBuffers;if(fr){const[cr,Xi,vi]=fr.getGridBuffers(Ft,!1);nr.draw(l,C.TRIANGLES,we,ce||Be,l.colorModeForRenderPass(),pe,Ji,n.id,cr,Xi,vi)}}else{const{tileBoundsBuffer:fr,tileBoundsIndexBuffer:cr,tileBoundsSegments:Xi}=l.getTileBoundsBuffers(Ce);nr.draw(l,C.TRIANGLES,we,Be,N,ti.disabled,Ji,n.id,fr,cr,Xi)}}if(!(O instanceof o.aU)&&w)for(const se of he){const ye=se.canonical.y===(1<<se.canonical.z)-1;se.canonical.y===0&&Su(!0,se,l,t,n,z,D,pe,ce||ri.disabled),ye&&Su(!1,se,l,t,n,z,D,pe===ti.frontCW?ti.backCW:ti.frontCW,ce||ri.disabled)}};w?_e(te,l.renderElevatedRasterBackface?ti.backCW:ti.frontCW,l.stencilModeFor3D()):_e(te,ti.disabled,void 0),l.resetStencilClippingMasks()},"raster-particle":function(l,t,n,c,d,p){l.renderPass==="offscreen"&&(function(_,v,w,I){if(!I.length)return;const C=_.context,O=C.gl,D=v.getSource();if(!(D instanceof oo))return;const z=Math.ceil(Math.sqrt(w.paint.get("raster-particle-count")));let N=w.particlePositionRGBAImage;if(!N||N.width!==z){const te=(function(J){const _e=J*J,he=new Uint8Array(4*_e),pe=function(se){return se|=0,se=Math.imul(2747636419^se,2654435769),se=Math.imul(se^se>>>16,2654435769),((se=Math.imul(se^se>>>16,2654435769))>>>0)/4294967296},ce=1/1.1;for(let se=0;se<_e;se++){const ye=ce*(pe(2*se+0)+Xs),Ce=ce*(pe(2*se+1)+Xs),Se=255*ye%1,Ue=255*Ce%1,je=Se,Xe=Ce-Ue/255,ht=Ue;he[4*se+0]=255*(ye-Se/255),he[4*se+1]=255*je,he[4*se+2]=255*Xe,he[4*se+3]=255*ht}return he})(z);N=w.particlePositionRGBAImage=new o.q({width:z,height:z},te)}let B=w.particleFramebuffer;B?B.width!==z&&(B.destroy(),B=w.particleFramebuffer=C.createFramebuffer(z,z,1,null)):B=w.particleFramebuffer=C.createFramebuffer(z,z,1,null);const H=[];for(const te of I){const J=v.getTile(te);if(!(J instanceof sh))continue;const _e=jf(J,D,w);if(!_e)continue;const he=[J.tileSize,J.tileSize];let pe=w.tileFramebuffer;pe||(pe=w.tileFramebuffer=C.createFramebuffer(he[0],he[1],1,null));let ce=J.rasterParticleState;ce||(ce=J.rasterParticleState=new Wh(C,te,he,N));const se=ce.update(w.lastInvalidatedAt);ce.particleTextureDimension!==z&&ce.updateParticleTexture(te,N);const ye=ce.targetColorTexture;ce.targetColorTexture=ce.backgroundColorTexture,ce.backgroundColorTexture=ye;const Ce=ce.particleTexture0;ce.particleTexture0=ce.particleTexture1,ce.particleTexture1=Ce,H.push([te,_e,ce,se])}if(H.length===0)return;const q=o.o.now(),Y=w.previousDrawTimestamp?.001*(q-w.previousDrawTimestamp):.0167;if(w.previousDrawTimestamp=q,w.hasColorMap()){C.activeTexture.set(O.TEXTURE0+2);let te=w.colorRampTexture;te||(te=w.colorRampTexture=new o.T(C,w.colorRamp,O.RGBA8)),te.bind(O.LINEAR,O.CLAMP_TO_EDGE)}C.bindFramebuffer.set(w.tileFramebuffer.framebuffer),(function(te,J,_e){const he=te.context,pe=he.gl,ce=J.tileFramebuffer;he.activeTexture.set(pe.TEXTURE0);const se={u_texture:0,u_opacity:1.05*(Ce=J.paint.get("raster-particle-fade-opacity-factor"))/(Ce+.05)},ye=te.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Ce;for(const Se of _e){const[,,Ue,je]=Se;ce.colorAttachment0.set(Ue.targetColorTexture.texture),he.viewport.set([0,0,ce.width,ce.height]),he.clear({color:o.ao.transparent}),je&&(Ue.backgroundColorTexture.bind(pe.NEAREST,pe.CLAMP_TO_EDGE),ye.draw(te,pe.TRIANGLES,Bt.disabled,ri.disabled,_i.alphaBlended,ti.disabled,se,J.id,te.viewportBuffer,te.quadTriangleIndexBuffer,te.viewportSegments))}})(_,w,H),(function(te,J,_e,he){const pe=te.context,ce=pe.gl,se=_e.tileFramebuffer,ye=te.transform.projection.name==="globe",Ce=_e.paint.get("raster-particle-max-speed");for(const Se of he){const[Ue,je,Xe]=Se;pe.activeTexture.set(ce.TEXTURE0+0),je.texture.bind(ce.LINEAR,ce.CLAMP_TO_EDGE),se.colorAttachment0.set(Xe.targetColorTexture.texture);const ht=te.getOrCreateProgram("rasterParticleDraw",{defines:je.defines,overrideFog:!1});pe.activeTexture.set(ce.TEXTURE0+1);const ke=je.scalarData?[]:[0,1,2,3].map((Be=>o.e9[Be](Ue)));ke.push(Ue);const we=Ue.canonical.x,He=Ue.canonical.y;for(const Be of ke){const et=J.getTile(ye?Be.wrapped():Be);if(!et)continue;const vt=et.rasterParticleState;if(!vt)continue;const St=Be.canonical.x+(1<<Be.canonical.z)*(Be.wrap-Ue.wrap),_t=Be.canonical.y;vt.particleTexture0.bind(ce.NEAREST,ce.CLAMP_TO_EDGE);const dt=Ty(1,vt.particleTexture0.size[0],[St-we,_t-He],0,je.texture.size,2,Ce,je.textureOffset,je.scale,je.offset);ht.draw(te,ce.POINTS,Bt.disabled,ri.disabled,_i.alphaBlended,ti.disabled,dt,_e.id,vt.particleIndexBuffer,void 0,vt.particleSegment)}}})(_,v,w,H),C.bindFramebuffer.set(w.particleFramebuffer.framebuffer),(function(te,J,_e,he){const pe=te.context,ce=pe.gl,se=J.paint.get("raster-particle-max-speed"),ye=he*J.paint.get("raster-particle-speed-factor")*.15,Ce=(function(Ue){return Math.pow(Ue,6)})(.01+1*J.paint.get("raster-particle-reset-rate-factor")),Se=J.particleFramebuffer;pe.viewport.set([0,0,Se.width,Se.height]);for(const Ue of _e){const[,je,Xe]=Ue;pe.activeTexture.set(ce.TEXTURE0+0),je.texture.bind(ce.LINEAR,ce.CLAMP_TO_EDGE),pe.activeTexture.set(ce.TEXTURE0+1);const ht=Xe.particleTexture0;ht.bind(ce.NEAREST,ce.CLAMP_TO_EDGE);const ke=Qm(1,ht.size[0],0,je.texture.size,se,ye,Ce,je.textureOffset,je.scale,je.offset);Se.colorAttachment0.set(Xe.particleTexture1.texture),pe.clear({color:o.ao.transparent}),te.getOrCreateProgram("rasterParticleUpdate",{defines:je.defines}).draw(te,ce.TRIANGLES,Bt.disabled,ri.disabled,_i.unblended,ti.disabled,ke,J.id,te.viewportBuffer,te.quadTriangleIndexBuffer,te.viewportSegments)}})(_,w,H,Y)})(l,t,n,c),l.renderPass==="translucent"&&((function(_,v,w,I,C){const O=_.context,D=O.gl,z=v.getSource().tileSize,N=5*(1-o.ah(o.cL,o.cL+1,_.transform.zoom))*z+w.paint.get("raster-particle-elevation"),B=!_.options.moving,H=_.transform.projection.name==="globe";if(!I.length)return;const[q,Y]=_.stencilConfigForOverlap(I),te=[];H&&te.push("PROJECTION_GLOBE_VIEW");const J=_.stencilModeFor3D();for(const _e of Y){const he=_e.toUnwrapped(),pe=v.getTile(_e);if(!pe.rasterParticleState)continue;const ce=pe.rasterParticleState,se=100;pe.registerFadeDuration(se);const ye=v.findLoadedParent(_e,0),Ce=vu(pe,ye,v,_.transform,se);let Se,Ue;_.terrain&&_.terrain.prepareDrawTile(),O.activeTexture.set(D.TEXTURE0),ce.targetColorTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),O.activeTexture.set(D.TEXTURE1),ye&&ye.rasterParticleState?(ye.rasterParticleState.targetColorTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),Se=Math.pow(2,ye.tileID.overscaledZ-pe.tileID.overscaledZ),Ue=[pe.tileID.canonical.x*Se%1,pe.tileID.canonical.y*Se%1]):ce.targetColorTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE);const je=H?Float32Array.from(_.transform.expandedFarZProjMatrix):_.transform.calculateProjMatrix(he,B),Xe=_.transform,ht=o_(Xe),ke=o.dG(_e.canonical),we=o.dH(ke.getCenter().lat);let He,Be,et,vt,St;H?(He=Float32Array.from(o.bk(o.dJ(_e.canonical))),Be=Float32Array.from(Xe.globeMatrix),et=Float32Array.from(o.dF(Xe)),vt=[o.aF(Xe.center.lng),o.aJ(Xe.center.lat)],St=Float32Array.from(o.dI(_e.canonical,ke,we,Xe.worldSize/Xe._pixelsPerMercatorPixel))):(He=new Float32Array(16),Be=new Float32Array(9),et=new Float32Array(16),vt=[0,0],St=new Float32Array(9));const _t=wy(je,He,Be,et,St,Ue||[0,0],o.aj(_.transform.zoom),vt,ht,Se||1,Ce,N),dt=_.isTileAffectedByFog(_e),kt=_.getOrCreateProgram("rasterParticle",{defines:te,overrideFog:dt});if(_.uploadCommonUniforms(O,kt,he),H){const Dt=new Bt(D.LEQUAL,Bt.ReadOnly,_.depthRangeFor3D),Tt=0,At=_.globeSharedBuffers;if(At){const[Wt,ci,Di]=At.getGridBuffers(we,Tt!==0);kt.draw(_,D.TRIANGLES,Dt,J,_i.alphaBlended,_.renderElevatedRasterBackface?ti.frontCCW:ti.backCCW,_t,w.id,Wt,ci,Di)}}else{const Dt=_.depthModeForSublayer(0,Bt.ReadOnly),Tt=q[_e.overscaledZ],{tileBoundsBuffer:At,tileBoundsIndexBuffer:Wt,tileBoundsSegments:ci}=_.getTileBoundsBuffers(pe);kt.draw(_,D.TRIANGLES,Dt,Tt,_i.alphaBlended,ti.disabled,_t,w.id,At,Wt,ci)}}_.resetStencilClippingMasks()})(l,t,n,c),l.style.map.triggerRepaint())},background:function(l,t,n,c){const d=n.paint.get("background-color"),p=n.paint.get("background-color-use-theme").constantOr("default")==="none",_=n.paint.get("background-opacity"),v=n.paint.get("background-emissive-strength"),w=n.paint.get("background-pitch-alignment")==="viewport";if(_===0)return;const I=l.context,C=I.gl,O=l.transform,D=O.tileSize,z=n.paint.get("background-pattern");let N;if(z!==void 0&&(z===null||(N=l.imageManager.getPattern(o.I.from(z.toString()),n.scope,l.style.getLut(n.scope)),!N)))return;const B=!z&&d.a===1&&_===1&&l.opaquePassEnabledForLayer()?"opaque":"translucent";if(l.renderPass!==B)return;const H=ri.disabled,q=l.depthModeForSublayer(0,B==="opaque"?Bt.ReadWrite:Bt.ReadOnly),Y=l.colorModeForDrapableLayerRenderPass(v),te=z?"backgroundPattern":"background";let J,_e=c;_e||(J=l.getBackgroundTiles(),_e=Object.values(J).map((pe=>pe.tileID))),z&&(I.activeTexture.set(C.TEXTURE0),l.imageManager.bind(l.context,n.scope));const he=[];if(l.terrain&&l.terrain.renderingToTexture&&l.emissiveMode==="mrt-fallback"&&he.push("USE_MRT1"),w){const pe=l.getOrCreateProgram(te,{overrideFog:!1,overrideRtt:!0,defines:he}),ce=new Float32Array(o.bA([])),se=new o.aQ(0,0,0,0,0),ye=z?il(ce,v,_,l,0,n.scope,N,w,{tileID:se,tileSize:D}):bu(ce,v,_,d.toPremultipliedRenderColor(p?null:n.lut));pe.draw(l,C.TRIANGLES,q,H,Y,ti.disabled,ye,n.id,l.viewportBuffer,l.quadTriangleIndexBuffer,l.viewportSegments)}else for(const pe of _e){const ce=l.isTileAffectedByFog(pe),se=l.getOrCreateProgram(te,{overrideFog:ce,defines:he}),ye=pe.toUnwrapped(),Ce=c?pe.projMatrix:l.transform.calculateProjMatrix(ye);l.prepareDrawTile();const Se=t?t.getTile(pe):J?J[pe.key]:new Ml(pe,D,O.zoom,l),Ue=z?il(Ce,v,_,l,0,n.scope,N,w,{tileID:pe,tileSize:D}):bu(Ce,v,_,d.toPremultipliedRenderColor(p?null:n.lut));l.uploadCommonUniforms(I,se,ye);const{tileBoundsBuffer:je,tileBoundsIndexBuffer:Xe,tileBoundsSegments:ht}=l.getTileBoundsBuffers(Se);se.draw(l,C.TRIANGLES,q,H,Y,ti.disabled,Ue,n.id,je,Xe,ht)}},sky:function(l,t,n){const c=l._atmosphere?o.aj(l.transform.zoom):1,d=n.paint.get("sky-opacity")*c;if(d===0)return;const p=l.context,_=n.paint.get("sky-type"),v=new Bt(p.gl.LEQUAL,Bt.ReadOnly,[0,1]),w=l.frameCounter/1e3%1;_==="atmosphere"?l.renderPass==="offscreen"?n.needsSkyboxCapture(l)&&((function(I,C,O,D){const z=I.context,N=z.gl;let B=C.skyboxFbo;if(!B){B=C.skyboxFbo=z.createFramebuffer(32,32,1,null),C.skyboxGeometry=new Yh(z),C.skyboxTexture=z.gl.createTexture(),N.bindTexture(N.TEXTURE_CUBE_MAP,C.skyboxTexture),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MIN_FILTER,N.LINEAR),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MAG_FILTER,N.LINEAR);for(let te=0;te<6;++te)N.texImage2D(N.TEXTURE_CUBE_MAP_POSITIVE_X+te,0,N.RGBA,32,32,0,N.RGBA,N.UNSIGNED_BYTE,null)}z.bindFramebuffer.set(B.framebuffer),z.viewport.set([0,0,32,32]);const H=C.getCenter(I,!0),q=I.getOrCreateProgram("skyboxCapture"),Y=new Float64Array(16);o.bA(Y),o.en(Y,Y,.5*-Math.PI),jl(I,C,q,Y,H,0),o.bA(Y),o.en(Y,Y,.5*Math.PI),jl(I,C,q,Y,H,1),o.bA(Y),o.cU(Y,Y,.5*-Math.PI),jl(I,C,q,Y,H,2),o.bA(Y),o.cU(Y,Y,.5*Math.PI),jl(I,C,q,Y,H,3),o.bA(Y),jl(I,C,q,Y,H,4),o.bA(Y),o.en(Y,Y,Math.PI),jl(I,C,q,Y,H,5),z.viewport.set([0,0,I.width,I.height])})(l,n),n.markSkyboxValid(l)):l.renderPass==="sky"&&(function(I,C,O,D,z){const N=I.context,B=N.gl,H=I.transform,q=I.getOrCreateProgram("skybox");N.activeTexture.set(B.TEXTURE0),B.bindTexture(B.TEXTURE_CUBE_MAP,C.skyboxTexture);const Y=((te,J,_e,he,pe)=>({u_matrix:te,u_sun_direction:J,u_cubemap:0,u_opacity:he,u_temporal_offset:pe}))(H.skyboxMatrix,C.getCenter(I,!1),0,D,z);I.uploadCommonUniforms(N,q),q.draw(I,B.TRIANGLES,O,ri.disabled,I.colorModeForRenderPass(),ti.backCW,Y,"skybox",C.skyboxGeometry.vertexBuffer,C.skyboxGeometry.indexBuffer,C.skyboxGeometry.segment)})(l,n,v,d,w):_==="gradient"&&l.renderPass==="sky"&&(function(I,C,O,D,z){const N=I.context,B=N.gl,H=I.transform,q=I.getOrCreateProgram("skyboxGradient");C.skyboxGeometry||(C.skyboxGeometry=new Yh(N)),N.activeTexture.set(B.TEXTURE0);let Y=C.colorRampTexture;Y||(Y=C.colorRampTexture=new o.T(N,C.colorRamp,B.RGBA8)),Y.bind(B.LINEAR,B.CLAMP_TO_EDGE);const te=((J,_e,he,pe,ce)=>({u_matrix:J,u_color_ramp:0,u_center_direction:_e,u_radius:o.an(he),u_opacity:pe,u_temporal_offset:ce}))(H.skyboxMatrix,C.getCenter(I,!1),C.paint.get("sky-gradient-radius"),D,z);I.uploadCommonUniforms(N,q),q.draw(I,B.TRIANGLES,O,ri.disabled,I.colorModeForRenderPass(),ti.backCW,te,"skyboxGradient",C.skyboxGeometry.vertexBuffer,C.skyboxGeometry.indexBuffer,C.skyboxGeometry.segment)})(l,n,v,d,w)},custom:function(l,t,n,c){const d=l.context,p=n.implementation;if(!l.transform.projection.unsupportedLayers||!l.transform.projection.unsupportedLayers.includes("custom")||l.terrain&&(l.terrain.renderingToTexture||l.renderPass==="offscreen")&&n.isDraped(t)){if(l.renderPass==="offscreen"){const _=p.prerender;if(_){if(l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),l.transform.projection.name==="globe"){const v=l.transform.pointMerc;_.call(p,d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),o.aj(l.transform.zoom),[v.x,v.y],l.transform.pixelsPerMeterRatio)}else _.call(p,d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState()}}else if(l.renderPass==="translucent"){if(l.terrain&&l.terrain.renderingToTexture){const v=p.renderToTile;if(v){const w=c[0].canonical,I={x:w.x+c[0].wrap*(p.wrapTileId?0:1<<w.z),y:w.y,z:w.z};d.setDepthMode(Bt.disabled),d.setStencilMode(ri.disabled),d.setColorMode(l.colorModeForRenderPass()),l.setCustomLayerDefaults(),v.call(p,d.gl,I),d.setDirty(),l.setBaseState()}return}l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),d.setStencilMode(ri.disabled);const _=p.renderingMode==="3d"?new Bt(l.context.gl.LEQUAL,Bt.ReadWrite,l.depthRangeFor3D):l.depthModeForSublayer(0,Bt.ReadOnly);if(d.setDepthMode(_),l.transform.projection.name==="globe"){const v=l.transform.pointMerc;p.render(d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),o.aj(l.transform.zoom),[v.x,v.y],l.transform.pixelsPerMeterRatio)}else p.render(d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState(),d.bindFramebuffer.set(null)}}else o.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(l,t,n,c){if(l.renderPass==="opaque")return;const d=n.paint.get("model-opacity").constantOr(1),p=n.paint.get("model-elevation-reference"),_=p==="ground",v=p==="ground";if(d===0)return;const w=n.paint.get("model-cast-shadows");if(l.renderPass==="shadow"&&(!w||l.terrain&&d<.65&&n._transitionablePaint._values["model-opacity"].value.expression instanceof o.ad))return;const I=l.shadowRenderer,C=n.paint.get("model-receive-shadows");I&&(I.useNormalOffset=!0,C||(I.enabled=!1));const O=()=>{I&&(I.useNormalOffset=!0,C||(I.enabled=!0))},D=t.getSource();if(l.renderPass==="light-beam"&&D.type!=="batched-model")return;if(D.type==="vector"||D.type==="geojson")return(function(J,_e,he,pe,ce){const se=J.transform,ye=se.projection.name==="globe",Ce=se.getFreeCameraOptions().position;if(!J.modelManager)return;const Se=J.modelManager;he.modelManager=Se;const Ue=J.shadowRenderer;if(!he._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const je=he._unevaluatedLayout._values["model-id"],Xe=Object.assign({},he.layout.get("model-id").parameters),ht=J.style.order.indexOf(he.fqid),ke=he.paint.get("model-opacity").constantOr(1);for(const we of pe){const He=_e.getTile(we).getBucket(he);if(!He||He.projection.name!==se.projection.name)continue;const Be=He.getModelUris();if(Be&&!He.modelsRequested&&(Se.addModelsFromBucket(Be,ce),He.modelsRequested=!0),ye)Xe.zoom=we.overscaledZ;else{const Tt=po(we,se);Xe.zoom=Tt}const et=je.possiblyEvaluate(Xe);if(m_(J,He,we),Js.shadowUniformsInitialized=!1,Js.useSingleShadowCascade=!!Ue&&Ue.getMaxCascadeForTile(we.toUnwrapped())===0,J.renderPass==="shadow"&&Ue){if(J.currentShadowCascade===1&&He.isInsideFirstShadowMapFrustum)continue;const Tt=se.calculatePosMatrix(we.toUnwrapped(),se.worldSize);if(Js.tileMatrix.set(Tt),Js.shadowTileMatrix=Float32Array.from(Ue.calculateShadowPassMatrixFromMatrix(Tt)),Js.aabb.min=[0,0,0],Js.aabb.max[0]=Js.aabb.max[1]=o.al,Js.aabb.max[2]=0,Ay(He,Js,J,he.scope))continue}const vt=1<<we.canonical.z,St=[((Ce.x-we.wrap)*vt-we.canonical.x)*o.al,(Ce.y*vt-we.canonical.y)*o.al,Ce.z*vt*o.al];J.conflationActive&&Object.keys(He.instancesPerModel).length>0&&J.style.isLayerClipped(he,_e.getSource())&&He.updateReplacement(we,J.replacementSource,ht,he.scope)&&(He.uploaded=!1,He.upload(J.context));let _t=0;const dt=new Array,kt=new Array,Dt=new Array;for(let Tt in He.instancesPerModel){const At=He.instancesPerModel[Tt];At.features.length>0&&!ye&&(Tt=et.evaluate(At.features[0].feature,{}));const Wt=Se.getModel(Tt,ce);if(Wt||Se.hasURLBeenRequested(Tt)||He.modelUris.includes(Tt)||(He.modelUris.push(Tt),He.modelsRequested=!1),Wt&&Wt.uploaded)if(ye){const ci=o.c5([],[Ce.x,Ce.y,Ce.z],J.transform.worldSize);o.ew(ci,ci);for(let Di=0;Di<At.instancedDataArray.length;++Di){const er=[0,0,0],Ft=[1,1,1],Ji=o.ex(),ai=At.tileCoordinatesForInstance(Di),nr=At.transformForInstance(Di);o.ey(Ft,nr),o.ez(Ji,nr),o.eA(er,Ji);const fr=At.translationForInstance(Di),cr=new o.aT(0,0);o.eB(He.canonical,cr,ai.x,ai.y);const Xi=o.bC();o.eC(Xi,Wt,J.transform,cr,er,Ft,fr,!0,!1,!1);const vi=At.colorForInstance(Di),ir=o.bA([]),$r=o.ef(cr.lat,J.transform.zoom),Rr=o.bq([],[1,1,1/$r]);o.br(ir,ir,ci),Dt.push({zScaleMatrix:Rr,negCameraPosMatrix:ir});for(const or of Wt.nodes)Gl(J,or,Xi,J.transform.expandedFarZProjMatrix,_t,dt,kt,Wt.materialOverrides,ke,vi);++_t}}else for(const ci of Wt.nodes)__(J,he,ci,At,St,we,Js)}if(ye)if(J.renderPass==="shadow"){for(const Tt of kt)Is(Tt.mesh,Tt.nodeModelMatrix,J,he);for(const Tt of dt)Is(Tt.mesh,Tt.nodeModelMatrix,J,he)}else p_(J,he,dt,kt,Dt)}})(l,t,n,c,Iu(l,n)),void O();if(!D.loaded())return;if(D.type==="batched-model")return(function(J,_e,he,pe){he.resetLayerRenderingStats(J);const ce=J.context,se=J.transform,ye=J.style.fog,Ce=J.shadowRenderer;if(se.projection.name!=="mercator")return void o.w(`Drawing 3D landmark models for ${se.projection.name} projection is not yet implemented`);const Se=J.transform.getFreeCameraOptions().position,Ue=o.c5([],[Se.x,Se.y,Se.z],J.transform.worldSize),je=o.ew([],Ue),Xe=o.bA([]),ht=o.ef(se.center.lat,se.zoom),ke=o.bq([],[1,1,1/ht]);o.br(Xe,Xe,je);const we=he.paint.get("model-opacity").constantOr(1),He=new Bt(ce.gl.LEQUAL,Bt.ReadWrite,J.depthRangeFor3D),Be=new Bt(ce.gl.LEQUAL,Bt.ReadOnly,J.depthRangeFor3D),et=new o.d9([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),vt=J.renderPass==="shadow",St=vt&&Ce?Ce.getCurrentCascadeFrustum():se.getFrustum(se.scaleZoom(se.worldSize)),_t=he.paint.get("model-front-cutoff"),dt=_t[2]<1,kt=Wa(J,he.paint.get("model-cutoff-fade-range")),Dt=he.getLayerRenderingStats();(function(Tt,At,Wt,ci){const Di=Tt.terrain?Tt.terrain.exaggeration():0,er=Tt.transform.zoom;for(const Ft of ci){const Ji=At.getTile(Ft).getBucket(Wt);Ji&&(Ji.setFilter(Wt.filter),Tt.conflationActive&&Ji.updateReplacement(Ft,Tt.replacementSource),Ji.evaluateTransform(Tt,Wt),Tt.terrain&&Di>0&&Ji.elevationUpdate(Tt.terrain,Di,Ft,Wt.source),Ji.needsReEvaluation(Tt,er,Wt)&&Ji.evaluate(Wt))}})(J,_e,he,pe),(function(){let Tt,At,Wt;dt?(Tt=pe.length-1,At=-1,Wt=-1):(Tt=0,At=pe.length,Wt=1);const ci=new Float64Array(16),Di=o.cA(),er=new o.P(0,0);for(let Ft=Tt;Ft!==At;Ft+=Wt){const Ji=pe[Ft],ai=_e.getTile(Ji).getBucket(he);if(!ai||!ai.uploaded)continue;let nr=!1;Ce&&(nr=Ce.getMaxCascadeForTile(Ji.toUnwrapped())===0);const fr=se.calculatePosMatrix(Ji.toUnwrapped(),se.worldSize),cr=ai.modelTraits;!vt&&dt&&(o.bl(ci,fr),o.af(Di,Ue,ci),er.x=Di[0],er.y=Di[1]);const Xi=[];ai.setFilter(he.filter);for(const vi of ai.getNodesInfo()){if(vi.hiddenByReplacement||!vi.node.meshes)continue;const ir=vi.node;let $r=0;J.terrain&&ir.elevation&&($r=ir.elevation*J.terrain.exaggeration());const Rr=(()=>{const to=vi.aabb;return et.min=[...to.min],et.max=[...to.max],et.min[2]+=$r,et.max[2]+=$r,o.af(et.min,et.min,fr),o.af(et.max,et.max,fr),et})(),or=vi.evaluatedScale;if(or[0]<=1&&or[1]<=1&&or[2]<=1&&Rr.intersects(St)===0)continue;if(!vt&&dt){const to=.16666666666666666;vi.cameraCollisionOpacity=Ue[0]>Rr.min[0]&&Ue[0]<Rr.max[0]&&Ue[1]>Rr.min[1]&&Ue[1]<Rr.max[1]&&Ue[2]*ht<Rr.max[2]&&ir.footprint&&o.c0(er,ir.footprint)?Math.max(vi.cameraCollisionOpacity-to,0):Math.min(1,vi.cameraCollisionOpacity+to)}const Gi=[...fr],xi=1/o.d7(Ji.canonical),Mr=ir.anchor?ir.anchor[0]:0,sn=ir.anchor?ir.anchor[1]:0;o.br(Gi,Gi,[Mr*(or[0]-1)+vi.evaluatedTranslation[0]*xi,sn*(or[1]-1)+vi.evaluatedTranslation[1]*xi,$r+vi.evaluatedTranslation[2]]),o.cq(or,o.eE)||o.cS(Gi,Gi,or);const Br=o.aB([],Gi,ir.globalMatrix),vr=o.aB([],se.expandedFarZProjMatrix,Br),mo=o.aB([],se.expandedFarZProjMatrix,Gi),Xn=o.aC([],[Mr,sn,$r,1],vr)[2];ir.hidden=!1;let wn=we;vt||(dt&&(wn*=vi.cameraCollisionOpacity,wn*=Ci(Gi,se,vi.aabb,_t)),wn*=Lr(kt,Xn)),wn!==0?Xi.push({nodeInfo:vi,depth:Xn,opacity:wn,wvpForNode:vr,wvpForTile:mo,nodeModelMatrix:Br,tileModelMatrix:Gi}):ir.hidden=!0}vt||Xi.sort(((vi,ir)=>!dt||vi.opacity===1&&ir.opacity===1?vi.depth<ir.depth?-1:1:vi.opacity===1?-1:ir.opacity===1?1:vi.depth>ir.depth?-1:1));for(const vi of Xi){const ir=vi.nodeInfo,$r=ir.node;let Rr=o.aB([],ke,vi.tileModelMatrix);o.aB(Rr,Xe,Rr);const or=o.bl([],Rr);o.eg(or,or),o.cS(or,or,Au),Rr=o.aB(Rr,Rr,$r.globalMatrix);const Gi=J.renderPass==="light-beam",xi=he.paint.get("model-color-use-theme").constantOr("default")==="none",Mr=cr&o.eI.HasMapboxMeshFeatures,sn=Mr?0:ir.evaluatedRMEA[0][2];for(let Br=0;Br<$r.meshes.length;++Br){const vr=$r.meshes[Br],mo=Br===$r.lightMeshIndex;let Xn=vi.wvpForNode;if(mo){if(!Gi&&!J.terrain&&J.shadowRenderer){J.currentLayer<J.firstLightBeamLayer&&(J.firstLightBeamLayer=J.currentLayer);continue}Xn=vi.wvpForTile}else if(Gi)continue;const wn={defines:[]},to=[];if(!vt&&Ce&&(Ce.useNormalOffset=!!vr.normalBuffer),Qh(wn.defines,to,vr,J,xi?null:he.lut),Mr||wn.defines.push("DIFFUSE_SHADED"),nr&&wn.defines.push("SHADOWS_SINGLE_CASCADE"),Dt&&(vt?Dt.numRenderedVerticesInShadowPass+=vr.vertexArray.length:Dt.numRenderedVerticesInTransparentPass+=vr.vertexArray.length),vt){Is(vr,vi.nodeModelMatrix,J,he);continue}let io=null;if(ye){const ln=Kh(vi.nodeModelMatrix,J.transform);if(io=new Float32Array(ln),se.projection.name!=="globe"){const xr=vr.aabb.min,dn=vr.aabb.max,[Wr,Nr]=ye.getOpacityForBounds(ln,xr[0],xr[1],dn[0],dn[1]);wn.overrideFog=Wr>=Je||Nr>=Je}}const $n=vr.material;let Zo;$n.occlusionTexture&&$n.occlusionTexture.offsetScale&&(Zo=$n.occlusionTexture.offsetScale,wn.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const hs=J.getOrCreateProgram("model",wn);!vt&&Ce&&Ce.setupShadowsFromMatrix(vi.tileModelMatrix,hs,Ce.useNormalOffset),J.uploadCommonUniforms(ce,hs,null,io);const So=$n.pbrMetallicRoughness;So.metallicFactor=.9,So.roughnessFactor=.5;const tn=Fl(new Float32Array(Xn),new Float32Array(Rr),new Float32Array(or),new Float32Array($r.globalMatrix),J,vi.opacity,So.baseColorFactor,$n.emissiveFactor,So.metallicFactor,So.roughnessFactor,$n,sn,he,[0,0,0],Zo);!mo&&(ir.hasTranslucentParts||vi.opacity<1)&&hs.draw(J,ce.gl.TRIANGLES,He,ri.disabled,_i.disabled,ti.backCCW,tn,he.id,vr.vertexBuffer,vr.indexBuffer,vr.segments,he.paint,J.transform.zoom,void 0,to),hs.draw(J,ce.gl.TRIANGLES,mo?Be:He,ri.disabled,mo||vi.opacity<1||ir.hasTranslucentParts?_i.alphaBlended:_i.unblended,ti.backCCW,tn,he.id,vr.vertexBuffer,vr.indexBuffer,vr.segments,he.paint,J.transform.zoom,void 0,to)}}}})()})(l,t,n,c),void O();if(D.type!=="model")return;const z=D.getModels(),N=[],B=l.transform.getFreeCameraOptions().position,H=o.c5([],[B.x,B.y,B.z],l.transform.worldSize);o.ew(H,H);const q=[],Y=[];let te=0;for(const J of z){const _e=t.getFeatureState("",J.id),he={type:"Unknown",id:J.id,properties:J.featureProperties},pe=n.paint.get("model-rotation").evaluate(he,_e),ce=n.paint.get("model-scale").evaluate(he,_e),se=n.paint.get("model-translation").evaluate(he,_e),ye=n.paint.get("model-opacity").evaluate(he,_e);d_(n,J.id,_e,J.featureProperties,J.nodeOverrideNames,J.nodeOverrides),f_(n,J.id,_e,J.featureProperties,J.materialOverrideNames,J.materialOverrides),J.nodeOverrides.size>0&&J.computeBoundsAndApplyParent(),J.computeModelMatrix(l,pe,ce,se,v,_,!1);const Ce=o.bA([]),Se=o.ef(J.position.lat,l.transform.zoom),Ue=o.bq([],[1,1,1/Se]);o.br(Ce,Ce,H),N.push({zScaleMatrix:Ue,negCameraPosMatrix:Ce});for(const je of J.nodes)Gl(l,je,J.matrix,l.transform.expandedFarZProjMatrix,te,q,Y,J.materialOverrides,ye);te++}if(q.sort(((J,_e)=>_e.depth-J.depth)),l.renderPass!=="shadow")p_(l,n,q,Y,N),O();else{for(const J of Y)Is(J.mesh,J.nodeModelMatrix,l,n);for(const J of q)Is(J.mesh,J.nodeModelMatrix,l,n);O()}}},rd={line:function(l,t,n){if(l.hasElevatedBuckets=!1,l.hasNonElevatedBuckets=!1,l._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||l._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){const c=t.getVisibleCoordinates();for(const d of c){const p=t.getTile(d).getBucket(l);if(p&&(p.elevationType!=="none"?l.hasElevatedBuckets=!0:l.hasNonElevatedBuckets=!0,l.hasElevatedBuckets&&l.hasNonElevatedBuckets))break}}}else l.hasNonElevatedBuckets=!0},model:function(l,t,n){const c=t.getSource();if(!c.loaded())return;if(c.type==="vector"||c.type==="geojson")return void(n.modelManager&&n.modelManager.upload(n,Iu(n,l)));if(c.type==="batched-model"||c.type!=="model")return;const d=c.getModels();for(const p of d)p.upload(n.context)},raster:function(l,t,n){const c=t.getSource();if(!(c instanceof oo&&c.loaded()))return;const d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const p=l.paint.get("raster-array-band")||c.getInitialBand(d);if(p==null)return;const _=t.getIds().map((v=>t.getTileByID(v)));for(const v of _)v.updateNeeded(l.id,p)&&c.prepareTile(v,d,l.id,p)},"raster-particle":function(l,t,n){const c=t.getSource();if(!(c instanceof oo&&c.loaded()))return;const d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const p=l.paint.get("raster-particle-array-band")||c.getInitialBand(d);if(p==null)return;const _=t.getIds().map((v=>t.getTileByID(v)));for(const v of _)v.updateNeeded(l.id,p)&&c.prepareTile(v,d,l.id,p)}},Ho={fill:Gh},nd={fill:function(l,t,n,c){if(!n.layout||n.layout.get("fill-elevation-reference")==="none"||n.paint.get("fill-opacity").constantOr(1)===0)return;const d=l.context.gl,p=new Bt(d.LEQUAL,Bt.ReadOnly,l.depthRangeFor3D),_=new ri({func:d.ALWAYS,mask:255},255,255,d.KEEP,d.KEEP,d.REPLACE),v=l.transform.getFreeCameraOptions().position,w=l.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const I of c){const C=t.getTile(I),O=C.getBucket(n);if(!O)continue;const D=O.elevatedStructures;if(!D||D.depthSegments.segments[0].primitiveLength===0)continue;const z=r_(I.toUnwrapped(),v),N=l.translatePosMatrix(I.projMatrix,C,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor")),B=kl(N,z,0,1,0);w.draw(l,d.TRIANGLES,p,_,_i.disabled,ti.disabled,B,n.id,D.vertexBuffer,D.indexBuffer,D.depthSegments,n.paint,l.transform.zoom)}}};class od{constructor(t,n,c,d,p){this.context=new vc(t,n),this.transform=c,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this._timeStamp=o.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const _=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const w of _)this._debugParams.enabledLayers[w]=!0;for(const w of _);this.occlusionParams=new bc,this.setup(),this.numSublayers=Po.maxUnderzooming+Po.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new o.eP,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new ac(this),this._wireframeDebugCache=new nl,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const v=new o.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new o.T(this.context,v,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=d,this.worldview=p,this._forceEmissiveMode=!1,this.emissiveMode="constant"}updateTerrain(t,n){const c=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(c||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Lf(this,t));const d=this._terrain;this.transform.elevation=c?d:null,d.update(t,this.transform,n),this.transform.elevation&&!d.enabled&&(this.transform.elevation=null)}_updateFog(t){const n=t.fog;if(!n||this.transform.projection.name==="globe"||n.getOpacity(this.transform.pitch)<1||n.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[c,d]=n.getFovAdjustedRange(this.transform._fov);if(c>d)return void(this.transform.fogCullDistSq=null);const p=c+.78*(d-c);this.transform.fogCullDistSq=p*p}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new Lf(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,n){if(this.width=t*o.o.devicePixelRatio,this.height=n*o.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const c of this.style.order)this.style._mergedLayers[c].resize()}setup(){const t=this.context,n=new o.bd;n.emplaceBack(0,0),n.emplaceBack(o.al,0),n.emplaceBack(0,o.al),n.emplaceBack(o.al,o.al),this.tileExtentBuffer=t.createVertexBuffer(n,o.bf.members),this.tileExtentSegments=o.bg.simpleSegment(0,0,4,2);const c=new o.bd;c.emplaceBack(0,0),c.emplaceBack(o.al,0),c.emplaceBack(0,o.al),c.emplaceBack(o.al,o.al),this.debugBuffer=t.createVertexBuffer(c,o.bf.members),this.debugSegments=o.bg.simpleSegment(0,0,4,5);const d=new o.bd;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(-1,1),d.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(d,o.bf.members),this.viewportSegments=o.bg.simpleSegment(0,0,4,2);const p=new o.b1;p.emplaceBack(0,0,0,0),p.emplaceBack(o.al,0,o.al,0),p.emplaceBack(0,o.al,0,o.al),p.emplaceBack(o.al,o.al,o.al,o.al),this.mercatorBoundsBuffer=t.createVertexBuffer(p,o.bi.members),this.mercatorBoundsSegments=o.bg.simpleSegment(0,0,4,2);const _=new o.b0;_.emplaceBack(0,1,2),_.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(_);const v=new o.be;for(const I of[0,1,3,2,0])v.emplaceBack(I);this.debugIndexBuffer=t.createIndexBuffer(v),this.emptyTexture=new o.T(t,new o.q({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=o.bC();const w=this.context.gl;this.stencilClearMode=new ri({func:w.ALWAYS,mask:0},0,255,w.ZERO,w.ZERO,w.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,Bt.disabled,this.stencilClearMode,_i.disabled,ti.disabled,yu(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,n,c){if(!n||this.currentStencilSource===n.id||!t.isTileClipped()||!c||c.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let v=!1;for(const w of c)if(this._tileClippingMaskIDs[w.key]===void 0){v=!0;break}if(!v)return}this.currentStencilSource=n.id;const d=this.context,p=d.gl;this.nextStencilID+c.length>256&&this.clearStencil(),d.setColorMode(_i.disabled),d.setDepthMode(Bt.disabled);const _=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const v of c){const w=n.getTile(v),I=this._tileClippingMaskIDs[v.key]=this.nextStencilID++,{tileBoundsBuffer:C,tileBoundsIndexBuffer:O,tileBoundsSegments:D}=this.getTileBoundsBuffers(w);_.draw(this,p.TRIANGLES,Bt.disabled,new ri({func:p.ALWAYS,mask:0},I,255,p.KEEP,p.KEEP,p.REPLACE),_i.disabled,ti.disabled,yu(v.projMatrix),"$clipping",C,O,D)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new ri({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const n=this.context.gl;return new ri({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,c=t.sort(((_,v)=>v.overscaledZ-_.overscaledZ)),d=c[c.length-1].overscaledZ,p=c[0].overscaledZ-d+1;if(p>1){this.currentStencilSource=void 0,this.nextStencilID+p>256&&this.clearStencil();const _={};for(let v=0;v<p;v++)_[v+d]=new ri({func:n.GEQUAL,mask:255},v+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=p,[_,c]}return[{[d]:ri.disabled},c]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new _i([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new o.ao(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?_i.unblended:_i.alphaBlended}colorModeForDrapableLayerRenderPass(t){const n=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?t!=null&&this.emissiveMode!=="mrt-fallback"||this.emissiveMode==="constant"?new _i([n.ONE,n.ONE_MINUS_SRC_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_SRC_ALPHA],new o.ao(0,0,0,t??0),[!0,!0,!0,!0]):this.emissiveMode==="dual-source-blending"?new _i([n.ONE,n.ONE_MINUS_SRC_ALPHA,this.context.extBlendFuncExtended.SRC1_ALPHA_WEBGL,n.ONE_MINUS_SRC_ALPHA],o.ao.transparent,[!0,!0,!0,!0]):this.colorModeForRenderPass():this.colorModeForRenderPass()}depthModeForSublayer(t,n,c,d=!1){if(this.depthOcclusion)return new Bt(this.context.gl.GREATER,Bt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!d)return Bt.disabled;const p=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Bt(c||this.context.gl.LEQUAL,n,[p,p])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,n=Math.ceil(this.width),c=Math.ceil(this.height),d=this.context.bindFramebuffer.get(),p=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===n&&this.depthFBO.height===c||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),n!==0&&c!==0&&(this.depthFBO=new i_(this.context,n,c,0,"texture"),this.depthTexture=new o.T(this.context,{width:n,height:c,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(d),t.bindTexture(t.TEXTURE_2D,p),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,n,c,0,0,n,c,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((t,n)=>t+n/this._fpsHistory.length),0))}render(t,n){const c=o.o.now();this._dt=c-this._timeStamp,this._timeStamp=c,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=n;const d=this.style._mergedLayers,p=!(!this.terrain||!this.terrain.enabled),_=()=>this.style._getOrder(p).filter((ke=>{const we=d[ke];return!(we.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[we.type]}));let v=_(),w=!1,I=!1,C=null,O=0,D=!1;for(const ke of v){const we=d[ke];we.visibility!=="none"&&(we.type==="circle"?w=!0:we.type==="building"?(C=we,++O):we.type==="symbol"&&(we.hasOcclusionOpacityProperties?I=!0:w=!0))}this.updateEmissiveMode();let z=v.map((ke=>d[ke]));const N=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(o.o.now()),this.imageManager.beginFrame();for(const ke in N){const we=N[ke];we.used&&(we.prepare(this.context),we.getSource().usedInConflation&&++O)}let B=!1;for(const ke of z)ke.isHidden(this.transform.zoom)||(ke.type==="clip"&&(B=!0),this.prepareLayer(ke));const H={},q={},Y={},te={},J={};for(const ke in N){const we=N[ke];H[ke]=we.getVisibleCoordinates(),q[ke]=H[ke].slice().reverse(),Y[ke]=we.getVisibleCoordinates(!0).reverse(),te[ke]=we.getShadowCasterCoordinates(),J[ke]=we.sortCoordinatesByDistance(H[ke])}const _e=ke=>{const we=this.style.getLayerSourceCache(ke);return we&&we.used?we.getSource():null};if(O||B||this._clippingActiveLastFrame){const ke=[],we=[];let He=0;for(const Be of z)this.isSourceForClippingOrConflation(Be,_e(Be))&&(ke.push(Be),we.push(He)),He++;if(ke&&(B||ke.length>1)||this._clippingActiveLastFrame){B=!1;const Be=[];for(let et=0;et<ke.length;et++){const vt=ke[et],St=we[et],_t=this.style.getLayerSourceCache(vt);if(!_t||!_t.used||!_t.getSource().usedInConflation&&vt.type!=="clip"&&vt.type!=="building")continue;let dt=o.eQ,kt=o.b_.None;const Dt=[];let Tt=!0;if(vt.type==="building")dt=o.eS;else if(vt.type==="clip"){dt=St;for(const At of vt.layout.get("clip-layer-types"))kt|=At==="model"?o.b_.Model:At==="symbol"?o.b_.Symbol:o.b_.FillExtrusion;for(const At of vt.layout.get("clip-layer-scope"))Dt.push(At);vt.isHidden(this.transform.zoom)?Tt=!1:B=!0}Tt&&Be.push({layer:vt.fqid,cache:_t,order:dt,clipMask:kt,clipScope:Dt})}this.replacementSource.setSources(Be),D=!0}}this._clippingActiveLastFrame=B,D||this.replacementSource.clear(),this.conflationActive=D,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let ke=0;ke<z.length;ke++){const we=z[ke];if(we.visibility==="none")continue;const He=we.cutoffRange();if(this.longestCutoffRange=Math.max(He,this.longestCutoffRange),He>0){const Be=_e(we);Be&&(this.minCutoffZoom=Math.max(Be.minzoom,this.minCutoffZoom)),we.minzoom&&(this.minCutoffZoom=Math.max(we.minzoom,this.minCutoffZoom))}we.is3D(p)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=ke),this._lastOcclusionLayer=ke)}const he=this.style&&this.style.fog;he?(this._fogVisible=he.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=he.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Y),this.opaquePassCutoff=0,v=_(),z=v.map((ke=>d[ke])));const pe=this._shadowRenderer;if(pe){pe.updateShadowParameters(this.transform,this.style.directionalLight);for(const ke in N)for(const we of H[ke]){let He={min:0,max:0};this.terrain&&(He=this.terrain.getMinMaxForTile(we)||He),pe.addShadowReceiver(we.toUnwrapped(),He.min,He.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new o.eR(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new h_(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const ce=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),se=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(ce&&!this._snow&&(this._snow=new $f(this)),!ce&&this._snow&&(this._snow.destroy(),delete this._snow),se&&!this._rain&&(this._rain=new id(this)),!se&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),C){this.buildingTileBorderManager||(this.buildingTileBorderManager=new Jh);const ke=this.style.getLayerSourceCache(C);this.buildingTileBorderManager.updateBorders(ke,C)}if(!Gr.has(this.context.gl))return;this.renderPass="offscreen";for(const ke of z){const we=t.getLayerSourceCache(ke);if(!ke.hasOffscreenPass()||ke.isHidden(this.transform.zoom))continue;const He=we?q[we.id]:void 0;(ke.type==="custom"||ke.type==="raster"||ke.type==="raster-particle"||ke.isSky()||He&&He.length)&&this.renderLayer(this,we,ke,He)}this.depthRangeFor3D=[0,1-(z.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,te)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const ye=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Ce=(()=>{if(n.showOverdrawInspector)return o.ao.black;const ke=this.style.fog;if(ke&&this.transform.projection.supportsFog){const we=this.style.getLut(ke.scope);if(!ye){const He=ke.properties.get("color-use-theme")==="none",Be=ke.properties.get("color").toNonPremultipliedRenderColor(He?null:we).toArray01();return new o.ao(...Be)}if(ye){const He=ke.properties.get("space-color-use-theme")==="none",Be=ke.properties.get("space-color").toNonPremultipliedRenderColor(He?null:we).toArray01();return new o.ao(...Be)}}return o.ao.transparent})();if(this.context.clear({color:Ce,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ye&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=v.length-1;this.currentLayer>=0;this.currentLayer--){const ke=z[this.currentLayer],we=t.getLayerSourceCache(ke);if(ke.isSky())continue;const He=we?(ke.is3D(p)?J:q)[we.id]:void 0;this._renderTileClippingMasks(ke,we,He),this.renderLayer(this,we,ke,He)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ye&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||o.aj(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<v.length;this.currentLayer++){const ke=z[this.currentLayer],we=t.getLayerSourceCache(ke);ke.isSky()&&this.renderLayer(this,we,ke,we?q[we.id]:void 0)}function Se(ke,we){let He;return we&&(He=(ke.type==="symbol"?Y:ke.is3D(p)?J:q)[we.id]),He}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<v.length;){const ke=z[this.currentLayer];if(ke.type==="raster"||ke.type==="raster-particle"){const we=t.getLayerSourceCache(ke);this.renderLayer(this,we,ke,Se(ke,we))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ue=0;pe&&(Ue=pe.getShadowCastingLayerCount());let je=!1,Xe=-1;for(let ke=0;ke<v.length;++ke){const we=z[ke];we.isHidden(this.transform.zoom)||we.is3D(p)&&(Xe=ke)}I&&Xe===-1&&(w=!0);let ht=!1;for(;this.currentLayer<v.length;){const ke=z[this.currentLayer],we=t.getLayerSourceCache(ke);if(ke.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(ke)){if(ke.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!ht&&ke.is3D(p)&&!p){const He=this.currentLayer,Be=et=>{for(this.currentLayer=0;this.currentLayer<z.length;this.currentLayer++){const vt=z[this.currentLayer];if(Ho[vt.type]){const St=this.style.getLayerSourceCache(vt);Ho[vt.type](this,St,vt,Se(vt,St),et)}}};Be("initialize"),Be("reset"),this.currentLayer=He,ht=!0}if(w&&!je&&this.terrain&&!this.transform.isOrthographic&&(je=!0,this.blitDepth()),I&&Xe!==-1&&this.currentLayer===Xe+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(ke,we,we?H[we.id]:void 0),this.renderLayer(this,we,ke,Se(ke,we)),!this.terrain&&pe&&Ue>0&&ke.hasShadowPass()&&--Ue==0){{this.clearStencil(),this.resetStencilClippingMasks();const He=this.currentLayer;for(this.currentLayer=0;this.currentLayer<z.length;this.currentLayer++){const Be=z[this.currentLayer];if(nd[Be.type]){const et=this.style.getLayerSourceCache(Be);nd[Be.type](this,et,Be,Se(Be,et))}}this.currentLayer=He}if(pe.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const He=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=He;this.currentLayer++){const Be=z[this.currentLayer];if(!Be.hasLightBeamPass())continue;const et=t.getLayerSourceCache(Be);this.renderLayer(this,et,Be,et?q[et.id]:void 0)}this.currentLayer=He,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const He=this.currentLayer;this.depthOcclusion=!0;for(const Be of this.layersWithOcclusionOpacity){this.currentLayer=Be;const et=z[this.currentLayer],vt=t.getLayerSourceCache(et),St=vt?q[vt.id]:void 0;this.terrain||this._renderTileClippingMasks(et,vt,vt?H[vt.id]:void 0),this.renderLayer(this,vt,et,St)}this.depthOcclusion=!1,this.currentLayer=He,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let ke=null;z.forEach((we=>{const He=t.getLayerSourceCache(we);He&&!we.isHidden(this.transform.zoom)&&He.getVisibleCoordinates().length&&(!ke||ke.getSource().maxzoom<He.getSource().maxzoom)&&(ke=He)})),ke&&this.options.showTileBoundaries&&mt(this,ke,ke.getVisibleCoordinates(),o.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&mt(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new o.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&(function(ke){const we=ke.transform.padding;Ul(ke,ke.transform.height-(we.top||0),3,s_),Ul(ke,we.bottom||0,3,a_),en(ke,we.left||0,3,l_),en(ke,ke.transform.width-(we.right||0),3,Nl);const He=ke.transform.centerPoint;(function(Be,et,vt,St){Re(Be,et-1,vt-10,2,20,St),Re(Be,et-10,vt-1,20,2,St)})(ke,He.x,ke.transform.height-He.y,Vl)})(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),D||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:n}=this.transform.projection,c=!n||!n.includes(t.type);if(rd[t.type]&&(c||this.terrain&&t.type==="custom")){const d=this.style.getLayerSourceCache(t);rd[t.type](t,d,this)}this.gpuTimingEnd()}renderLayer(t,n,c,d){c.isHidden(this.transform.zoom)||(c.type==="background"||c.type==="sky"||c.type==="custom"||c.type==="model"||c.type==="raster"||c.type==="raster-particle"||d&&d.length)&&(this.id=c.id,this.gpuTimingStart(c),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(c.type)&&(!t.terrain||c.type!=="custom")||c.type==="clip"||ol[c.type](t,n,c,d,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const n=this.context.extTimerQuery,c=this.context.gl;let d=this.gpuTimers[t.id];d||(d=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:c.createQuery()}),d.calls++,c.beginQuery(n.TIME_ELAPSED_EXT,d.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,n=this.context.gl,c=n.createQuery();this.deferredRenderGpuTimeQueries.push(c),n.beginQuery(t.TIME_ELAPSED_EXT,c)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const n={};for(const c in t){const d=t[c],p=this.context.extTimerQuery,_=p.getQueryParameter(d.query,this.context.gl.QUERY_RESULT)/1e6;p.deleteQueryEXT(d.query),n[c]=_}return n}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const n=this.context.gl;let c=0;for(const d of t)c+=n.getQueryParameter(d,n.QUERY_RESULT)/1e6,n.deleteQuery(d);return c}translatePosMatrix(t,n,c,d,p){if(!c[0]&&!c[1])return t;const _=p?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(_){const I=Math.sin(_),C=Math.cos(_);c=[c[0]*C-c[1]*I,c[0]*I+c[1]*C]}const v=[p?c[0]:o.ay(n,c[0],this.transform.zoom),p?c[1]:o.ay(n,c[1],this.transform.zoom),0],w=new Float32Array(16);return o.br(w,t,v),w}saveTileTexture(t){if(t.context!==this.context)return;const n=t.size[0],c=this._tileTextures[n];c?c.push(t):this._tileTextures[n]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,n,c){const d=c===void 0?this.terrain&&this.terrain.renderingToTexture:c,p=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(p.push("LIGHTING_3D_MODE"),p.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):d||p.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||p.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(p.push("TERRAIN"),this.linearFloatFilteringSupported()&&p.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&p.push("GLOBE"),!this._fogVisible||d||n!==void 0&&!n||p.push("FOG","FOG_DITHERING"),d&&p.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&p.push("OVERDRAW_INSPECTOR"),p}getOrCreateProgram(t,n){this.cache=this.cache||{};const c=n&&n.defines||[],d=n&&n.config,p=this.currentGlobalDefines(t,n&&n.overrideFog,n&&n.overrideRtt).concat(c),_=qm.cacheKey(yf[t],t,p,d);return this.cache[_]||(this.cache[_]=new qm(this.context,t,yf[t],d,jh[t],p)),this.cache[_]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new o.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,n){if(this.style.enable3dLights()){const c=this.style.directionalLight,d=this.style.ambientLight;if(c&&d){const p=((_,v,w)=>{const I=_.properties.get("direction"),C=_.properties.get("color-use-theme")==="none",O=_.properties.get("color").toNonPremultipliedRenderColor(C?null:w.getLut(_.scope)).toArray01(),D=_.properties.get("intensity"),z=v.properties.get("color-use-theme")==="none",N=v.properties.get("color").toNonPremultipliedRenderColor(z?null:w.getLut(v.scope)).toArray01(),B=v.properties.get("intensity"),H=[I.x,I.y,I.z],q=o.dN(N,B),Y=o.dN(O,D);return{u_lighting_ambient_color:q,u_lighting_directional_dir:H,u_lighting_directional_color:Y,u_ground_radiance:_c(H,Y,q)}})(c,d,this.style);n.setLightsUniformValues(t,p)}}}uploadCommonUniforms(t,n,c,d,p){if(this.uploadCommonLightUniforms(t,n),this.terrain&&this.terrain.renderingToTexture)return;const _=this.style.fog;if(_){const v=_.getOpacity(this.transform.pitch),w=((I,C,O,D,z,N,B,H,q,Y,te,J)=>{const _e=I.transform,he=C.properties.get("color-use-theme")==="none",pe=C.properties.get("color").toNonPremultipliedRenderColor(he?null:I.style.getLut(C.scope)).toArray01();pe[3]=D;const ce=I.frameCounter/1e3%1,[se,ye]=C.properties.get("vertical-range");return{u_fog_matrix:O?_e.calculateFogTileMatrix(O):J||I.identityMat,u_fog_range:C.getFovAdjustedRange(_e._fov),u_fog_color:pe,u_fog_horizon_blend:C.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(se,ye),ye],u_fog_temporal_offset:ce,u_frustum_tl:z,u_frustum_tr:N,u_frustum_br:B,u_frustum_bl:H,u_globe_pos:q,u_globe_radius:Y,u_viewport:te,u_globe_transition:o.aj(_e.zoom),u_is_globe:+(_e.projection.name==="globe")}})(this,_,c,v,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*o.o.devicePixelRatio,this.transform.height*o.o.devicePixelRatio],d);n.setFogUniformValues(t,w)}p&&n.setCutoffUniformValues(t,p.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),n}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,n=this._backgroundTiles={},c=this.transform.coveringTiles({tileSize:512});for(const d of c)n[d.key]=t[d.key]||new Ml(d,512,this.transform.tileZoom,this,void 0,this.worldview);return n}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,n){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!n||n.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let n=this._cachedTileFogOpacities[t.key];return n||(this._cachedTileFogOpacities[t.key]=n=this.style.fog.getOpacityForTile(t)),n[0]>=Je||n[1]>=Je}setupDepthForOcclusion(t,n,c){const d=this.context,p=d.gl,_=!!c;var v;c||(c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),d.activeTexture.set(p.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),c.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],c.u_depth_range_unpack=[2/((v=this.depthRangeFor3D)[1]-v[0]),-1-2*v[0]/(v[1]-v[0])],c.u_occluder_half_size=.5*this.occlusionParams.occluderSize,c.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),d.activeTexture.set(p.TEXTURE0),_||n.setTerrainUniformValues(d,c)}updateEmissiveMode(){if(this._forceEmissiveMode)return;const t=this.style.hasDataDrivenEmissiveStrength();this.emissiveMode=t?this.context.extBlendFuncExtended?"dual-source-blending":"mrt-fallback":"constant"}}function sd(l,t){let n=!1,c=null;const d=()=>{c=null,n&&(l(),c=setTimeout(d,t),n=!1)};return()=>(n=!0,c||d(),c)}class Wf{constructor(t){this._hashName=t&&encodeURIComponent(t),o.aY(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=sd(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const n=xn(t);if(this._hashName){const c=this._hashName;let d=!1;const p=location.hash.slice(1).split("&").map((_=>{const v=_.split("=")[0];return v===c?(d=!0,`${v}=${n}`):_})).filter((_=>_));return d||p.push(`${c}=${n}`),`#${p.join("&")}`}return`#${n}`}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let n;return t.split("&").map((c=>c.split("="))).forEach((c=>{c[0]===this._hashName&&(n=c)})),(n&&n[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const n=this._getCurrentHash();if(n.length>=3&&!n.some((c=>isNaN(Number(c))))){const c=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(n[3]||0):t.getBearing();return t.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:c,pitch:+(n[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function xn(l,t){const n=l.getCenter(),c=Math.round(100*l.getZoom())/100,d=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),p=Math.pow(10,d),_=Math.round(n.lng*p)/p,v=Math.round(n.lat*p)/p,w=l.getBearing(),I=l.getPitch();let C=t?`/${_}/${v}/${c}`:`${c}/${v}/${_}`;return(w||I)&&(C+="/"+Math.round(10*w)/10),I&&(C+=`/${Math.round(I)}`),C}const Tc={linearity:.3,easing:o.eT(0,0,.3,1)},Xf=Object.assign({deceleration:2500,maxSpeed:1400},Tc),Yf=Object.assign({deceleration:20,maxSpeed:1400},Tc),Hl=Object.assign({deceleration:1e3,maxSpeed:360},Tc),Jf=Object.assign({deceleration:1e3,maxSpeed:90},Tc);class Kf{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:o.o.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=o.o.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const n={zoom:0,bearing:0,pitch:0,pan:new o.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:p}of this._inertiaBuffer)n.zoom+=p.zoomDelta||0,n.bearing+=p.bearingDelta||0,n.pitch+=p.pitchDelta||0,p.panDelta&&n.pan._add(p.panDelta),p.around&&(n.around=p.around),p.pinchAround&&(n.pinchAround=p.pinchAround);const c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(n.pan.mag()){const p=Ks(n.pan.mag(),c,Object.assign({},Xf,t||{}));d.offset=n.pan.mult(p.amount/n.pan.mag()),d.center=this._map.transform.center,Ec(d,p)}if(n.zoom){const p=Ks(n.zoom,c,Yf);d.zoom=this._map.transform.zoom+p.amount,Ec(d,p)}if(n.bearing){const p=Ks(n.bearing,c,Hl);d.bearing=this._map.transform.bearing+o.aA(p.amount,-179,179),Ec(d,p)}if(n.pitch){const p=Ks(n.pitch,c,Jf);d.pitch=this._map.transform.pitch+p.amount,Ec(d,p)}if(d.zoom||d.bearing){const p=n.pinchAround===void 0?n.around:n.pinchAround;d.around=p?this._map.unproject(p):this._map.getCenter()}return this.clear(),d.noMoveStart=!0,d}}function Ec(l,t){(!l.duration||l.duration<t.duration)&&(l.duration=t.duration,l.easing=t.easing)}function Ks(l,t,n){const{maxSpeed:c,linearity:d,deceleration:p}=n,_=o.aA(l*d/(t/1e3),-c,c),v=Math.abs(_)/(p*d);return{easing:n.easing,duration:1e3*v,amount:_*(v/2)}}class Eo extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c,d={}){const p=it(n.getCanvasContainer(),c),_=n.unproject(p);super(t,Object.assign({point:p,lngLat:_,originalEvent:c},d)),this._defaultPrevented=!1,this.target=n}}class sl extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c){const d=t==="touchend"?c.changedTouches:c.touches,p=jt(n.getCanvasContainer(),d),_=p.map((w=>n.unproject(w))),v=p.reduce(((w,I,C,O)=>w.add(I.div(O.length))),new o.P(0,0));super(t,{points:p,point:v,lngLats:_,lngLat:n.unproject(v),originalEvent:c}),this._defaultPrevented=!1}}class Qf extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n){super("wheel",{originalEvent:n}),this._defaultPrevented=!1}}class ad{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new Qf(this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new Eo(t.type,this._map,t))}mouseup(t){this._map.fire(new Eo(t.type,this._map,t))}preclick(t){const n=new MouseEvent("preclick",t);this._map.fire(new Eo(n.type,this._map,n))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||(this.preclick(t),this._map.fire(new Eo(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new Eo(t.type,this._map,t))}mouseover(t){this._map.fire(new Eo(t.type,this._map,t))}mouseout(t){this._map.fire(new Eo(t.type,this._map,t))}touchstart(t){return this._firePreventable(new sl(t.type,this._map,t))}touchmove(t){this._map.fire(new sl(t.type,this._map,t))}touchend(t){this._map.fire(new sl(t.type,this._map,t))}touchcancel(t){this._map.fire(new sl(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ep{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new Eo(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Eo("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new Eo(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ld{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&t.button===0&&(Ae(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const c=n,d=this._startPos,p=this._lastPos;if(!d||!p||p.equals(c)||!this._box&&c.dist(d)<this._clickTolerance)return;this._lastPos=c,this._box||(this._box=ge("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const _=Math.min(d.x,c.x),v=Math.max(d.x,c.x),w=Math.min(d.y,c.y),I=Math.max(d.y,c.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${_}px,${w}px)`,this._box.style.width=v-_+"px",this._box.style.height=I-w+"px")}))}mouseupWindow(t,n){if(!this._active)return;const c=this._startPos,d=n;if(c&&t.button===0){if(this.reset(),Ye(),c.x!==d.x||c.y!==d.y)return this._map.fire(new o.z("boxzoomend",{originalEvent:t})),{cameraAnimation:p=>p.fitScreenCoordinates(c,d,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),ze(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new o.z(t,{originalEvent:n}))}}function cd(l,t){const n={};for(let c=0;c<l.length;c++)n[l[c].identifier]=t[c];return n}class y_{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,n,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=(function(d){const p=new o.P(0,0);for(const _ of d)p._add(_);return p.div(d.length)})(n),this.touches=cd(c,n)))}touchmove(t,n,c){if(this.aborted||!this.centroid)return;const d=cd(c,n);for(const p in this.touches){const _=d[p];(!_||_.dist(this.touches[p])>30)&&(this.aborted=!0)}}touchend(t,n,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),c.length===0){const d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class ud{constructor(t){this.singleTap=new y_(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,n,c){this.singleTap.touchstart(t,n,c)}touchmove(t,n,c){this.singleTap.touchmove(t,n,c)}touchend(t,n,c){const d=this.singleTap.touchend(t,n,c);if(d){const p=t.timeStamp-this.lastTime<500,_=!this.lastTap||this.lastTap.dist(d)<30;if(p&&_||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class v_{constructor(){this._zoomIn=new ud({numTouches:1,numTaps:2}),this._zoomOut=new ud({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,c){this._zoomIn.touchstart(t,n,c),this._zoomOut.touchstart(t,n,c)}touchmove(t,n,c){this._zoomIn.touchmove(t,n,c),this._zoomOut.touchmove(t,n,c)}touchend(t,n,c){const d=this._zoomIn.touchend(t,n,c),p=this._zoomOut.touchend(t,n,c);return d?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:_=>_.easeTo({duration:300,zoom:_.getZoom()+1,around:_.unproject(d)},{originalEvent:t})}):p?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:_=>_.easeTo({duration:300,zoom:_.getZoom()-1,around:_.unproject(p)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const x_={0:1,2:2},tp={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class hd{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,n){return!1}_move(t,n){return{}}mousedown(t,n){if(this._lastPoint)return;const c=Rt(t);this._correctButton(t,c)&&(this._lastPoint=n,this._eventButton=c)}mousemoveWindow(t,n){const c=this._lastPoint;if(c){if(t.preventDefault(),this._eventButton!=null&&(function(d,p){const _=x_[p];return d.buttons===void 0||(d.buttons&_)!==_})(t,this._eventButton))this.reset();else if(this._moved||!(n.dist(c)<this._clickTolerance))return this._moved=!0,this._lastPoint=n,this._move(c,n)}}mouseupWindow(t){this._lastPoint&&Rt(t)===this._eventButton&&(this._moved&&Ye(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class b_ extends hd{mousedown(t,n){super.mousedown(t,n),this._lastPoint&&(this._active=!0)}_correctButton(t,n){return n===0&&!t.ctrlKey}_move(t,n){return{around:n,panDelta:n.sub(t)}}}class ip extends hd{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?tp[t.pitchRotateKey]:void 0}_correctButton(t,n){return this._pitchRotateKey?n===0&&t[this._pitchRotateKey]:n===0&&t.ctrlKey||n===2}_move(t,n){const c=.8*(n.x-t.x);if(c)return this._active=!0,{bearingDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class rp extends hd{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?tp[t.pitchRotateKey]:void 0}_correctButton(t,n){return this._pitchRotateKey?n===0&&t[this._pitchRotateKey]:n===0&&t.ctrlKey||n===2}_move(t,n){const c=-.5*(n.y-t.y);if(c)return this._active=!0,{pitchDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class w_{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=n.clickTolerance||1,this.reset(),o.aY(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new o.P(0,0)}touchstart(t,n,c){return this._calculateTransform(t,n,c)}touchmove(t,n,c){if(this._active&&!(c.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(c.length===1&&!o.eU())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,n,c)}}touchend(t,n,c){this._calculateTransform(t,n,c),this._active&&c.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,c){c.length>0&&(this._active=!0);const d=cd(c,n),p=new o.P(0,0),_=new o.P(0,0);let v=0;for(const I in d){const C=d[I],O=this._touches[I];O&&(p._add(C),_._add(C.sub(O)),v++,d[I]=C)}if(this._touches=d,v<this._minTouches||!_.mag())return;const w=_.div(v);return this._sum._add(w),this._sum.mag()<this._clickTolerance?void 0:{around:p.div(v),panDelta:w}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=ge("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class dd{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,n,c){return{}}touchstart(t,n,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,c){const d=this._firstTwoTouches;if(!d)return;t.preventDefault();const[p,_]=d,v=Cu(c,n,p),w=Cu(c,n,_);if(!v||!w)return;const I=this._aroundCenter?null:v.add(w).div(2);return this._move([v,w],I,t)}touchend(t,n,c){if(!this._firstTwoTouches)return;const[d,p]=this._firstTwoTouches,_=Cu(c,n,d),v=Cu(c,n,p);_&&v||(this._active&&Ye(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Cu(l,t,n){for(let c=0;c<l.length;c++)if(l[c].identifier===n)return t[c]}function T_(l,t){return Math.log2(l/t)}class Cy extends dd{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(T_(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:T_(this._distance,c),pinchAround:n}}}function E_(l,t){return 180*l.angleWith(t)/Math.PI}class Fr extends dd{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n){const c=this._vector;if(this._vector=t[0].sub(t[1]),c&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:E_(this._vector,c),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,c=this._startVector;if(!c)return!1;const d=E_(t,c);return Math.abs(d)<n}}function fd(l){return Math.abs(l.y)>Math.abs(l.x)}class My extends dd{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,fd(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,c){const d=this._lastPoints;if(!d)return;const p=t[0].sub(d[0]),_=t[1].sub(d[1]);return this._map._cooperativeGestures&&!o.eU()&&c.touches.length<3||(this._valid=this.gestureBeginsVertically(p,_,c.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(p.y+_.y)/2*-.5})}gestureBeginsVertically(t,n,c){if(this._valid!==void 0)return this._valid;const d=t.mag()>=2,p=n.mag()>=2;if(!d&&!p)return;if(!d||!p)return this._firstMove==null&&(this._firstMove=c),c-this._firstMove<100&&void 0;const _=t.y>0==n.y>0;return fd(t)&&fd(n)&&_}}const Py={panStep:100,bearingStep:15,pitchStep:10};class Ly{constructor(){const t=Py;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,c=0,d=0,p=0,_=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),p=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),p=1);break;case 38:t.shiftKey?d=1:(t.preventDefault(),_=-1);break;case 40:t.shiftKey?d=-1:(t.preventDefault(),_=1);break;default:return}return this._rotationDisabled&&(c=0,d=0),{cameraAnimation:v=>{const w=v.getZoom();v.easeTo({duration:300,easeId:"keyboardHandler",easing:Mu,zoom:n?Math.round(w)+n*(t.shiftKey?2:1):w,bearing:v.getBearing()+c*this._bearingStep,pitch:v.getPitch()+d*this._pitchStep,offset:[-p*this._panStep,-_*this._panStep],center:v.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Mu(l){return l*(2-l)}const np=4.000244140625,op=1/450;class pd{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._handler=n,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=op,o.aY(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||o.eU()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let n=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const c=o.o.now(),d=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,n!==0&&n%np==0?this._type="wheel":n!==0&&Math.abs(n)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=n,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(d*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=it(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:n,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const n=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const I=this._type==="wheel"&&Math.abs(this._delta)>np?this._wheelZoomRate:this._defaultZoomRate;let C=2/(1+Math.exp(-Math.abs(this._delta*I)));this._delta<0&&C!==0&&(C=1/C);const O=n(),D=Math.pow(2,O),z=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):D;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(z*C))),this._type==="wheel"&&(this._startZoom=O,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const c=typeof this._targetZoom=="number"?this._targetZoom:n(),d=this._startZoom,p=this._easing;let _,v=!1;if(this._type==="wheel"&&d&&p){const I=Math.min((o.o.now()-this._lastWheelEventTime)/200,1),C=p(I);_=o.ak(d,c,C),I<1?this._frameId||(this._frameId=!0):v=!0}else _=c,v=!0;this._active=!0,v&&(this._active=!1,this._finishTimeout=window.setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let w=_-n();return w*this._lastDelta<0&&(w=0),{noInertia:!0,needsRenderFrame:!v,zoomDelta:w,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=o.eV;if(this._prevEase){const c=this._prevEase,d=(o.o.now()-c.start)/c.duration,p=c.easing(d+.01)-c.easing(d),_=.27/Math.sqrt(p*p+1e-4)*.01,v=Math.sqrt(.0729-_*_);n=o.eT(_,v,.25,1)}return this._prevEase={start:o.o.now(),duration:t,easing:n},n}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=ge("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class wa{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class md{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,n){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:c.getZoom()+(t.shiftKey?-1:1),around:c.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class bn{constructor(){this._tap=new ud({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,n,c){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?c.length>0&&(this._swipePoint=n[0],this._swipeTouch=c[0].identifier):this._tap.touchstart(t,n,c))}touchmove(t,n,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;const d=n[0],p=d.y-this._swipePoint.y;return this._swipePoint=d,t.preventDefault(),this._active=!0,{zoomDelta:p/128}}}else this._tap.touchmove(t,n,c)}touchend(t,n,c){this._tapTime?this._swipePoint&&c.length===0&&this.reset():this._tap.touchend(t,n,c)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Qs{constructor(t,n,c){this._el=t,this._mousePan=n,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Pu{constructor(t,n,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class _d{constructor(t,n,c,d){this._el=t,this._touchZoom=n,this._touchRotate=c,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Lu=l=>l.zoom||l.drag||l.pitch||l.rotate;class Ry extends o.z{}class Ru{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,n){const c=o.av([],n,t);this.radius=o.ag(c[2]<0?o.eX([],c,this.constants):[c[0],c[1],0])}projectRay(t){o.eX(t,t,this.constants),o.aw(t,t),o.eY(t,t,this.constants);const n=o.c5([],t,this.radius);if(n[2]>0){const c=o.c5([],[0,0,1],o.bJ(n,[0,0,1])),d=o.c5([],o.aw([],[n[0],n[1],0]),this.radius),p=o.d8([],n,o.c5([],o.av([],o.d8([],d,c),n),2));n[0]=p[0],n[1]=p[1]}return n}}function gd(l){return l.panDelta&&l.panDelta.mag()||l.zoomDelta||l.bearingDelta||l.pitchDelta}class Dy{constructor(t,n){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Kf(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Ru,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(n),o.aY(["handleEvent","handleWindowEvent"],this);const c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(const[d,p,_]of this._listeners){const v=d===document?this.handleWindowEvent:this.handleEvent;d.addEventListener(p,v,_)}}destroy(){for(const[t,n,c]of this._listeners){const d=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(n,d,c)}}_addDefaultHandlers(t){const n=this._map,c=n.getCanvasContainer();this._add("mapEvent",new ad(n,t));const d=n.boxZoom=new ld(n,t);this._add("boxZoom",d);const p=new v_,_=new md;n.doubleClickZoom=new wa(_,p),this._add("tapZoom",p),this._add("clickZoom",_);const v=new bn;this._add("tapDragZoom",v);const w=n.touchPitch=new My(n);this._add("touchPitch",w);const I=new ip(t),C=new rp(t);n.dragRotate=new Pu(t,I,C),this._add("mouseRotate",I,["mousePitch"]),this._add("mousePitch",C,["mouseRotate"]);const O=new b_(t),D=new w_(n,t);n.dragPan=new Qs(c,O,D),this._add("mousePan",O),this._add("touchPan",D,["touchZoom","touchRotate"]);const z=new Fr,N=new Cy;n.touchZoomRotate=new _d(c,N,z,v),this._add("touchRotate",z,["touchPan","touchZoom"]),this._add("touchZoom",N,["touchPan","touchRotate"]),this._add("blockableMapEvent",new ep(n));const B=n.scrollZoom=new pd(n,this);this._add("scrollZoom",B,["mousePan"]);const H=n.keyboard=new Ly;this._add("keyboard",H);for(const q of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[q]&&n[q].enable(t[q])}_add(t,n,c){this._handlers.push({handlerName:t,handler:n,allowed:c}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Lu(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,n,c){for(const d in t)if(d!==c&&(!n||n.indexOf(d)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const n=[];for(const c of t)this._el.contains(c.target)&&n.push(c);return n}handleEvent(t,n){this._updatingCamera=!0;const c=t.type==="renderFrame",d=c?void 0:t,p={needsRenderFrame:!1},_={},v={},w=t.touches?this._getMapTouches(t.touches):void 0,I=w?jt(this._el,w):c?void 0:it(this._el,t);for(const{handlerName:D,handler:z,allowed:N}of this._handlers){if(!z.isEnabled())continue;let B;this._blockedByActive(v,N,D)?z.reset():z[n||t.type]&&(B=z[n||t.type](t,I,w),this.mergeHandlerResult(p,_,B,D,d),B&&B.needsRenderFrame&&this._triggerRenderFrame()),(B||z.isActive())&&(v[D]=z)}const C={};for(const D in this._previousActiveHandlers)v[D]||(C[D]=d);this._previousActiveHandlers=v,(Object.keys(C).length||gd(p))&&(this._changes.push([p,_,C]),this._triggerRenderFrame()),(Object.keys(v).length||gd(p))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:O}=p;O&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],O(this._map))}mergeHandlerResult(t,n,c,d,p){if(!c)return;Object.assign(t,c);const _={handlerName:d,originalEvent:c.originalEvent||p};c.zoomDelta!==void 0&&(n.zoom=_),c.panDelta!==void 0&&(n.drag=_),c.pitchDelta!==void 0&&(n.pitch=_),c.bearingDelta!==void 0&&(n.rotate=_)}_applyChanges(){const t={},n={},c={};for(const[d,p,_]of this._changes)d.panDelta&&(t.panDelta=(t.panDelta||new o.P(0,0))._add(d.panDelta)),d.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(t.around=d.around),d.aroundCoord!==void 0&&(t.aroundCoord=d.aroundCoord),d.pinchAround!==void 0&&(t.pinchAround=d.pinchAround),d.noInertia&&(t.noInertia=d.noInertia),Object.assign(n,p),Object.assign(c,_);this._updateMapTransform(t,n,c),this._changes=[]}_updateMapTransform(t,n,c){const d=this._map,p=d.transform,_=Y=>[Y.x,Y.y,Y.z];if((Y=>{const te=this._eventsInProgress.drag;return te&&!this._handlersById[te.handlerName].isActive()})()&&!gd(t)){const Y=p.zoom;p.cameraElevationReference="sea",this._originalZoom!=null&&p._orthographicProjectionAtLowPitch&&p.projection.name!=="globe"&&p.pitch===0?(p.cameraElevationReference="ground",p.zoom=this._originalZoom):(p.recenterOnTerrain(),p.cameraElevationReference="ground"),Y!==p.zoom&&this._map._update(!0)}if(p._isCameraConstrained&&d._stop(!0),!gd(t))return void this._fireEvents(n,c,!0);let{panDelta:v,zoomDelta:w,bearingDelta:I,pitchDelta:C,around:O,aroundCoord:D,pinchAround:z}=t;p._isCameraConstrained&&(w>0&&(w=0),p._isCameraConstrained=!1),z!==void 0&&(O=z),(w||(Y=>n[Y]&&!this._eventsInProgress[Y])("drag"))&&O&&(this._dragOrigin=_(p.pointCoordinate3D(O)),this._originalZoom=p.zoom,this._trackingEllipsoid.setup(p._camera.position,this._dragOrigin)),p.cameraElevationReference="sea",d._stop(!0),O=O||d.transform.centerPoint,I&&(p.bearing+=I),C&&(p.pitch+=C),p._updateCameraState();const N=[0,0,0];if(v)if(p.projection.name==="mercator"){const Y=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(O).dir),te=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(O.sub(v)).dir);N[0]=te[0]-Y[0],N[1]=te[1]-Y[1]}else{const Y=p.pointCoordinate(O);if(p.projection.name==="globe"){v=v.rotate(-p.angle);const te=p._pixelsPerMercatorPixel/p.worldSize;N[0]=-v.x*o.eW(o.a$(Y.y))*te,N[1]=-v.y*o.eW(p.center.lat)*te}else{const te=p.pointCoordinate(O.sub(v));Y&&te&&(N[0]=te.x-Y.x,N[1]=te.y-Y.y)}}const B=p.zoom,H=[0,0,0];if(w){const Y=_(D||p.pointCoordinate3D(O)),te={dir:o.aw([],o.av([],Y,p._camera.position))};if(te.dir[2]<0){const J=p.zoomDeltaToMovement(Y,w);o.c5(H,te.dir,J)}}const q=o.d8(N,N,H);p._translateCameraConstrained(q),w&&Math.abs(p.zoom-B)>1e-4&&p.recenterOnTerrain(),p.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,c,!0)}_fireEvents(t,n,c){const d=Lu(this._eventsInProgress),p=Lu(t),_={};for(const C in t){const{originalEvent:O}=t[C];this._eventsInProgress[C]||(_[`${C}start`]=O),this._eventsInProgress[C]=t[C]}!d&&p&&this._fireEvent("movestart",p.originalEvent);for(const C in _)this._fireEvent(C,_[C]);p&&this._fireEvent("move",p.originalEvent);for(const C in t){const{originalEvent:O}=t[C];this._fireEvent(C,O)}const v={};let w;for(const C in this._eventsInProgress){const{handlerName:O,originalEvent:D}=this._eventsInProgress[C];this._handlersById[O].isActive()||(delete this._eventsInProgress[C],w=n[O]||D,v[`${C}end`]=w)}for(const C in v)this._fireEvent(C,v[C]);const I=Lu(this._eventsInProgress);if(c&&(d||p)&&!I){this._updatingCamera=!0;const C=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),O=D=>D!==0&&-this._bearingSnap<D&&D<this._bearingSnap;C?(O(C.bearing||this._map.getBearing())&&(C.bearing=0),this._map.easeTo(C,{originalEvent:w})):(this._map.fire(new o.z("moveend",{originalEvent:w})),O(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new o.z(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((t=>{this._frameId=void 0,this.handleEvent(new Ry("renderFrame",{timeStamp:t})),this._applyChanges()}))}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const yd="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class sp extends o.E{constructor(t,n){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this._respectPrefersReducedMotion=n.respectPrefersReducedMotion!==!1,o.aY(["_renderFrameCallback"],this)}getCenter(){return new o.aT(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,c){return t=o.P.convert(t).mult(-1),this.panTo(this.transform.center,Object.assign({offset:t},n),c)}panTo(t,n,c){return this.easeTo(Object.assign({center:t},n),c)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,c){return this.easeTo(Object.assign({zoom:t},n),c)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,c){return this.easeTo(Object.assign({bearing:t},n),c)}resetNorth(t,n){return this.rotateTo(0,Object.assign({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=o.aI.convert(t);const c=n&&n.bearing||0,d=n&&n.pitch||0,p=t.getNorthWest(),_=t.getSouthEast();return this._cameraForBounds(this.transform,p,_,c,d,n)}_extendPadding(t){const n={top:0,right:0,bottom:0,left:0};return t==null?Object.assign({},n,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:Object.assign({},n,t)}_extendCameraOptions(t){return(t=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,n){const c=n.max[0]-n.min[0],d=n.max[1]-n.min[1];return c/d>t.aspect?c/(2*Math.tan(.5*t.fovX)*t.aspect):d/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,n,c,d,p,_){const v=t.clone(),w=this._extendCameraOptions(_);v.bearing=d,v.pitch=p;const I=o.aT.convert(n),C=o.aT.convert(c),O=.5*(I.lat+C.lat),D=.5*(I.lng+C.lng),z=o.eZ(O,D),N=o.aw([],z),B=o.aw([],o.bI([],N,[0,1,0])),H=o.bI([],B,N),q=[B[0],B[1],B[2],0,H[0],H[1],H[2],0,N[0],N[1],N[2],0,0,0,0,1],Y=[z,o.eZ(I.lat,I.lng),o.eZ(C.lat,I.lng),o.eZ(C.lat,C.lng),o.eZ(I.lat,C.lng),o.eZ(O,I.lng),o.eZ(O,C.lng),o.eZ(I.lat,D),o.eZ(C.lat,D)];let te=o.d9.fromPoints(Y.map((Be=>[o.bJ(B,Be),o.bJ(H,Be),o.bJ(N,Be)])));const J=o.af([],te.center,q);o.e_(J)===0&&o.e$(J,0,0,1),o.aw(J,J),o.c5(J,J,o.aD),v.center=o.f0(J);const _e=v.getWorldToCameraMatrix(),he=o.bl(new Float64Array(16),_e);te=o.d9.applyTransform(te,o.aB([],_e,q));const pe=this._extendAABB(te,v,w,d);if(!pe)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");te=pe,o.af(J,J,_e);const ce=.5*(te.max[2]-te.min[2]),se=this._minimumAABBFrustumDistance(v,te),ye=o.c5([],[0,0,1],ce),Ce=o.d8(ye,J,ye),Se=se+(v.pitch===0?0:o.bG(J,Ce)),Ue=v.globeCenterInViewSpace,je=o.av([],J,[Ue[0],Ue[1],Ue[2]]);o.aw(je,je),o.c5(je,je,Se);const Xe=o.d8([],J,je);o.af(Xe,Xe,he);const ht=o.eM/o.aD,ke=o.ag(Xe),we=o.cf(Math.max(ke*ht-o.eM,Number.EPSILON),0),He=Math.min(v.zoomFromMercatorZAdjusted(we),w.maxZoom);return He>.5*(o.c_+o.cL)?(v.setProjection({name:"mercator"}),v.zoom=He,this._cameraForBounds(v,n,c,d,p,_)):{center:v.center,zoom:He,bearing:d,pitch:p}}_extendAABB(t,n,c,d){const p=.5*((c.padding.left||0)+(c.padding.right||0)),_=.5*((c.padding.top||0)+(c.padding.bottom||0)),v=_,w=p,I=p,C=_,O=n.width-(w+I),D=n.height-(v+C),z=o.av([],t.max,t.min),N=Math.min(O/z[0],D/z[1]),B=Math.min(n.scaleZoom(n.scale*N),c.maxZoom);if(isNaN(B))return null;const H=n.scale/n.zoomScale(B),q=new o.d9([t.min[0]-w*H,t.min[1]-C*H,t.min[2]],[t.max[0]+I*H,t.max[1]+v*H,t.max[2]]),Y=(typeof c.offset.x=="number"&&typeof c.offset.y=="number"?new o.P(c.offset.x,c.offset.y):o.P.convert(c.offset)).rotate(-o.an(d));return q.center[0]-=Y.x*H,q.center[1]+=Y.y*H,q}queryTerrainElevation(t,n){const c=this.transform.elevation;return c?(n=Object.assign({},{exaggerated:!0},n),c.getAtPoint(o.ae.fromLngLat(t),null,n.exaggerated)):null}_cameraForBounds(t,n,c,d,p,_){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,n,c,d,p,_);const v=t.clone(),w=this._extendCameraOptions(_);v.bearing=d,v.pitch=p;const I=o.aT.convert(n),C=o.aT.convert(c),O=new o.aT(I.lng,C.lat),D=new o.aT(C.lng,I.lat),z=v.project(I),N=v.project(C),B=this.queryTerrainElevation(I),H=this.queryTerrainElevation(C),q=this.queryTerrainElevation(O),Y=this.queryTerrainElevation(D),te=[[z.x,z.y,Math.min(B||0,H||0,q||0,Y||0)],[N.x,N.y,Math.max(B||0,H||0,q||0,Y||0)]];let J=o.d9.fromPoints(te);const _e=v.getWorldToCameraMatrix(),he=o.bl(new Float64Array(16),_e);J=o.d9.applyTransform(J,_e);const pe=this._extendAABB(J,v,w,d);if(!pe)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");J=pe;const ce=.5*o.av([],J.max,J.min)[2],se=this._minimumAABBFrustumDistance(v,J),ye=[0,0,1,0];o.aC(ye,ye,_e),o.f1(ye,ye);const Ce=o.c5([],ye,se+ce),Se=o.d8([],J.center,Ce);o.af(J.center,J.center,he),o.af(Se,Se,he);const Ue=v.unproject(new o.P(J.center[0],J.center[1])),je=o.f2(v.projection,Ue),Xe=Math.pow(2,je),ht=Math.min(v._zoomFromMercatorZ(Se[2]*v.pixelsPerMeter*Xe/v.worldSize),w.maxZoom);return v.mercatorFromTransition&&ht<.5*(o.c_+o.cL)?(v.setProjection({name:"globe"}),v.zoom=ht,this._cameraForBounds(v,n,c,d,p,_)):{center:Ue,zoom:ht,bearing:d,pitch:p}}fitBounds(t,n,c){const d=this.cameraForBounds(t,n);return this._fitInternal(d,n,c)}fitScreenCoordinates(t,n,c,d,p){const _=o.P.convert(t),v=o.P.convert(n),w=new o.P(Math.min(_.x,v.x),Math.min(_.y,v.y)),I=new o.P(Math.max(_.x,v.x),Math.max(_.y,v.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(_,v))return this;const C=this.transform.pointLocation3D(w),O=this.transform.pointLocation3D(I),D=this.transform.pointLocation3D(new o.P(w.x,I.y)),z=this.transform.pointLocation3D(new o.P(I.x,w.y)),N=[Math.min(C.lng,O.lng,D.lng,z.lng),Math.min(C.lat,O.lat,D.lat,z.lat)],B=[Math.max(C.lng,O.lng,D.lng,z.lng),Math.max(C.lat,O.lat,D.lat,z.lat)],H=d&&d.pitch?d.pitch:this.getPitch(),q=this._cameraForBounds(this.transform,N,B,c,H,d);return this._fitInternal(q,d,p)}_fitInternal(t,n,c){return t?(n=Object.assign(t,n)).linear?this.easeTo(n,c):this.flyTo(n,c):this}jumpTo(t,n){this.stop();const c=t.preloadOnly?this.transform.clone():this.transform;let d=!1,p=!1,_=!1;"zoom"in t&&c.zoom!==+t.zoom&&(d=!0,c.zoom=+t.zoom),t.center!==void 0&&(c.center=o.aT.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(p=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(_=!0,c.pitch=+t.pitch);const v=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!c.isPaddingEqual(v))if(t.retainPadding===!1){const w=c.clone();w.padding=v,c.setLocationAtPoint(c.center,w.centerPoint)}else c.padding=v;return t.preloadOnly?(this._preloadTiles(c),this):(this.fire(new o.z("movestart",n)).fire(new o.z("move",n)),d&&this.fire(new o.z("zoomstart",n)).fire(new o.z("zoom",n)).fire(new o.z("zoomend",n)),p&&this.fire(new o.z("rotatestart",n)).fire(new o.z("rotate",n)).fire(new o.z("rotateend",n)),_&&this.fire(new o.z("pitchstart",n)).fire(new o.z("pitch",n)).fire(new o.z("pitchend",n)),this.fire(new o.z("moveend",n)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||o.w(yd),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,n){const c=this.transform;if(!c.projection.supportsFreeCamera)return o.w(yd),this;this.stop();const d=c.zoom,p=c.pitch,_=c.bearing;c.setFreeCameraOptions(t);const v=d!==c.zoom,w=p!==c.pitch,I=_!==c.bearing;return this.fire(new o.z("movestart",n)).fire(new o.z("move",n)),v&&this.fire(new o.z("zoomstart",n)).fire(new o.z("zoom",n)).fire(new o.z("zoomend",n)),I&&this.fire(new o.z("rotatestart",n)).fire(new o.z("rotate",n)).fire(new o.z("rotateend",n)),w&&this.fire(new o.z("pitchstart",n)).fire(new o.z("pitch",n)).fire(new o.z("pitchend",n)),this.fire(new o.z("moveend",n)),this}easeTo(t,n){this._stop(!1,t.easeId),((t=Object.assign({offset:[0,0],duration:500,easing:o.eV},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const c=this.transform,d=this.getZoom(),p=this.getBearing(),_=this.getPitch(),v=this.getPadding(),w="zoom"in t?+t.zoom:d,I="bearing"in t?this._normalizeBearing(t.bearing,p):p,C="pitch"in t?+t.pitch:_,O=this._extendPadding(t.padding),D=o.P.convert(t.offset);let z,N,B;if(c.projection.name==="globe"){const ye=o.ae.fromLngLat(c.center),Ce=D.rotate(-c.angle);ye.x+=Ce.x/c.worldSize,ye.y+=Ce.y/c.worldSize;const Se=ye.toLngLat(),Ue=o.aT.convert(t.center||Se);this._normalizeCenter(Ue),z=c.centerPoint.add(Ce),N=new o.P(ye.x,ye.y).mult(c.worldSize),B=new o.P(o.aF(Ue.lng),o.aJ(Ue.lat)).mult(c.worldSize).sub(N)}else{z=c.centerPoint.add(D);const ye=c.pointLocation(z),Ce=o.aT.convert(t.center||ye);this._normalizeCenter(Ce),N=c.project(ye),B=c.project(Ce).sub(N)}const H=c.zoomScale(w-d);let q,Y;t.around&&(q=o.aT.convert(t.around),Y=c.locationPoint(q));const te=this._zooming||w!==d,J=this._rotating||p!==I,_e=this._pitching||C!==_,he=!c.isPaddingEqual(O),pe=t.retainPadding===!1?c.clone():c,ce=ye=>Ce=>{if(te&&(ye.zoom=o.ak(d,w,Ce)),J&&(ye.bearing=o.ak(p,I,Ce)),_e&&(ye.pitch=o.ak(_,C,Ce)),he&&(pe.interpolatePadding(v,O,Ce),z=pe.centerPoint.add(D)),q)ye.setLocationAtPoint(q,Y);else{const Se=ye.zoomScale(ye.zoom-d),Ue=w>d?Math.min(2,H):Math.max(.5,H),je=Math.pow(Ue,1-Ce),Xe=ye.unproject(N.add(B.mult(Ce*je)).mult(Se));ye.setLocationAtPoint(ye.renderWorldCopies?Xe.wrap():Xe,z)}return t.preloadOnly||this._fireMoveEvents(n),ye};if(t.preloadOnly){const ye=this._emulate(ce,t.duration,c);return this._preloadTiles(ye),this}const se={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=te,this._rotating=J,this._pitching=_e,this._padding=he,this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,se),this._ease(ce(c),(ye=>{c.cameraElevationReference==="sea"&&c.recenterOnTerrain(),this._afterEase(n,ye)}),t),this}_prepareEase(t,n,c={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),n||c.moving||this.fire(new o.z("movestart",t)),this._zooming&&!c.zooming&&this.fire(new o.z("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new o.z("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new o.z("pitchstart",t))}_fireMoveEvents(t){this.fire(new o.z("move",t)),this._zooming&&this.fire(new o.z("zoom",t)),this._rotating&&this.fire(new o.z("rotate",t)),this._pitching&&this.fire(new o.z("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const c=this._zooming,d=this._rotating,p=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new o.z("zoomend",t)),d&&this.fire(new o.z("rotateend",t)),p&&this.fire(new o.z("pitchend",t)),this.fire(new o.z("moveend",t))}flyTo(t,n){if(this._prefersReducedMotion(t)){const Be=o.aH(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Be,n)}this.stop(),t=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:o.eV},t);const c=this.transform,d=this.getZoom(),p=this.getBearing(),_=this.getPitch(),v=this.getPadding(),w="zoom"in t?o.aA(+t.zoom,c.minZoom,c.maxZoom):d,I="bearing"in t?this._normalizeBearing(t.bearing,p):p,C="pitch"in t?+t.pitch:_,O=this._extendPadding(t.padding),D=c.zoomScale(w-d),z=o.P.convert(t.offset);let N=c.centerPoint.add(z);const B=c.pointLocation(N),H=o.aT.convert(t.center||B);this._normalizeCenter(H);const q=c.project(B),Y=c.project(H).sub(q);let te=t.curve;const J=Math.max(c.width,c.height),_e=J/D,he=Y.mag();if("minZoom"in t){const Be=o.aA(Math.min(t.minZoom,d,w),c.minZoom,c.maxZoom),et=J/c.zoomScale(Be-d);te=Math.sqrt(et/he*2)}const pe=te*te;function ce(Be){const et=(_e*_e-J*J+(Be?-1:1)*pe*pe*he*he)/(2*(Be?_e:J)*pe*he);return Math.log(Math.sqrt(et*et+1)-et)}function se(Be){return(Math.exp(Be)-Math.exp(-Be))/2}function ye(Be){return(Math.exp(Be)+Math.exp(-Be))/2}const Ce=ce(0);let Se=function(Be){return ye(Ce)/ye(Ce+te*Be)},Ue=function(Be){return J*((ye(Ce)*(se(et=Ce+te*Be)/ye(et))-se(Ce))/pe)/he;var et},je=(ce(1)-Ce)/te;if(Math.abs(he)<1e-6||!isFinite(je)){if(Math.abs(J-_e)<1e-6)return this.easeTo(t,n);const Be=_e<J?-1:1;je=Math.abs(Math.log(_e/J))/te,Ue=function(){return 0},Se=function(et){return Math.exp(Be*te*et)}}t.duration="duration"in t?+t.duration:1e3*je/("screenSpeed"in t?+t.screenSpeed/te:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const Xe=p!==I,ht=C!==_,ke=!c.isPaddingEqual(O),we=t.retainPadding===!1?c.clone():c,He=Be=>et=>{const vt=et*je,St=1/Se(vt);Be.zoom=et===1?w:d+Be.scaleZoom(St),Xe&&(Be.bearing=o.ak(p,I,et)),ht&&(Be.pitch=o.ak(_,C,et)),ke&&(we.interpolatePadding(v,O,et),N=we.centerPoint.add(z));const _t=et===1?H:Be.unproject(q.add(Y.mult(Ue(vt))).mult(St));return Be.setLocationAtPoint(Be.renderWorldCopies?_t.wrap():_t,N),Be._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(n),Be};if(t.preloadOnly){const Be=this._emulate(He,t.duration,c);return this._preloadTiles(Be),this}return this._zooming=!0,this._rotating=Xe,this._pitching=ht,this._padding=ke,this._prepareEase(n,!1),this._ease(He(c),(()=>this._afterEase(n)),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,n){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const c=this._onEaseEnd;this._onEaseEnd=void 0,c.call(this,n)}if(!t){const c=this.handlers;c&&c.stop(!1)}return this}_ease(t,n,c){c.animate===!1||c.duration===0?(t(1),n()):(this._easeStart=o.o.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((o.o.now()-this._easeStart)/this._easeOptions.duration,1),n=this._onEaseFrame;n&&n(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,n){t=o.bT(t,-180,180);const c=Math.abs(t-n);return Math.abs(t-360-n)<c&&(t-=360),Math.abs(t+360-n)<c&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(n.maxBounds||n.projection.name!=="globe"&&!n.renderWorldCopies)return;const c=t.lng-n.center.lng;t.lng+=c>180?-360:c<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&o.o.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,n,c){const d=Math.ceil(15*n/1e3),p=[],_=t(c.clone());for(let v=0;v<=d;v++){const w=_(v/d);p.push(w.clone())}return p}_preloadTiles(t,n){}}class Du{constructor(t={}){this.options=t,o.aY(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const n=this.options&&this.options.compact,c=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=ge("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=ge("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",c);const d=ge("span","mapboxgl-ctrl-icon",this._compactButton);return d.setAttribute("aria-hidden","true"),d.setAttribute("title",c),this._innerContainer=ge("div","mapboxgl-ctrl-attrib-inner",this._container),n&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),n===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const n=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||o.e.ACCESS_TOKEN}];if(t){const c=n.reduce(((d,p,_)=>(p.value&&(d+=`${p.key}=${p.value}${_<n.length-1?"&":""}`),d)),"?");t.href=`${o.e.FEEDBACK_URL}/${c}#${xn(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||(t.dataType!=="source"||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility")&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}const n=this._map.style._mergedSourceCaches;for(const d in n){const p=n[d];if(p.used){const _=p.getSource();_.attribution&&t.indexOf(_.attribution)<0&&t.push(_.attribution)}}t.sort(((d,p)=>d.length-p.length)),t=t.filter(((d,p)=>{for(let _=p+1;_<t.length;_++)if(t[_].indexOf(d)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const c=t.map((d=>(function(p){const _=new DOMParser().parseFromString(p,"text/html");return Array.from(_.body.querySelectorAll("*")).forEach((v=>{const w=v.textContent||"";if(v.tagName!=="A")return void v.replaceWith(_.createTextNode(w));const I=v.getAttribute("href");if(!I||!/^(https?:|mailto:)/i.test(I))return void v.replaceWith(_.createTextNode(w));const C=_.createElement("a");C.href=I,C.textContent=w,C.rel="noopener nofollow";const O=v.getAttribute("class");O&&(C.className=O),v.replaceWith(C)})),_.body.innerHTML})(d))).join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Ou{constructor(){o.aY(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=ge("div","mapboxgl-ctrl");const n=ge("a","mapboxgl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://www.mapbox.com/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const n in t){const c=t[n].getSource();if(c.hasOwnProperty("mapbox_logo")&&!c.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const n=t[0];this._map.getCanvasContainer().offsetWidth<250?n.classList.add("mapboxgl-compact"):n.classList.remove("mapboxgl-compact")}}}class Sc{constructor(){o.aY(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=ge("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("selector-update",(n=>this._onIndoorUpdate(n))),this._container}_createButton(t,n){const c=ge("button",t,this._container);return c.type="button",c.addEventListener("click",n),c}_createSeparator(){return ge("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(t,n){this._map&&(t.setAttribute("aria-label",n),t.textContent=n)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("selector-update",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return this._model=t,void(this._container.style.display="none");const n=this._model;this._model=t,this._container.style.display="inline-block",this._container.style.borderRadius="8px",n&&Array.from(this._container.children).forEach((c=>c.remove())),t.floors.length>0&&(this.addBuildingsToggleButton(),this.addCurrentFloors(t.floors,t.activeFloorsVisible),this._updateBuildingsButtonState())}addBuildingsToggleButton(){const t=this._createButton("mapboxgl-ctrl-buildings-toggle",(()=>{const n=this._map;this._model&&n&&n._setIndoorActiveFloorsVisibility(!this._model.activeFloorsVisible)}));ge("span","mapboxgl-ctrl-icon",t).setAttribute("aria-hidden","true"),t.classList.add("mapboxgl-ctrl-level-button","mapboxgl-ctrl-buildings-toggle"),this._model&&!this._model.activeFloorsVisible&&t.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(t),this._createSeparator()}_updateBuildingsButtonState(){const t=this._container.querySelector(".mapboxgl-ctrl-buildings-toggle");t&&this._model&&(this._model.activeFloorsVisible?t.classList.remove("mapboxgl-ctrl-level-button-selected"):t.classList.add("mapboxgl-ctrl-level-button-selected"))}addCurrentFloors(t,n){for(let c=0;c<t.length;c++){const d=t[c],p=this._createButton("mapboxgl-ctrl-level-button",(()=>{this._map._selectIndoorFloor(d.id)}));this._setButtonTitle(p,d.zIndex.toString()),this._model&&d.id===this._model.selectedFloorId&&n&&p.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(p),c<t.length-1&&this._createSeparator()}}}class Ta{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,c=n?this._queue.concat(n):this._queue;for(const d of c)if(d.id===t)return void(d.cancelled=!0)}run(t=0){const n=this._currentlyRunning=this._queue;this._queue=[];for(const c of n)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Ea{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const n=o.dD((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-n)+this._end*n}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,n,c){this._start=this.getValue(n),this._end=t,this._startTime=n,this._endTime=n+c}}const Sa={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use â + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class al extends o.z{constructor(t,n,c,d){const{point:p,lngLat:_,originalEvent:v,target:w}=t;super(t.type,{point:p,lngLat:_,originalEvent:v,target:w}),this.preventDefault=()=>{t.preventDefault()},this.id=n,this.interaction=c,this.feature=d}}class As{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,n){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const c=n.filter;let d=n.type;c&&this.filters.set(t,o.b6(c)),d==="mouseover"&&(d="mouseenter"),d==="mouseout"&&(d="mouseleave");const p=this.interactionsByType.get(d)||new Map;d==="mouseenter"||d==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,n)):p.size===0&&this.map.on(d,this.handleType),p.size===0&&this.interactionsByType.set(d,p),p.set(t,n),this.typeById.set(t,d)}get(t){const n=this.typeById.get(t);if(!n)return;const c=this.interactionsByType.get(n);return c?c.get(t):void 0}remove(t){const n=this.typeById.get(t);if(!n)return;this.typeById.delete(t),this.filters.delete(t);const c=this.interactionsByType.get(n);c&&(c.delete(t),n==="mouseenter"||n==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):c.size===0&&this.map.off(n,this.handleType))}queryTargets(t,n){const c=[];for(const[d,p]of n)p.target&&c.push({targetId:d,target:p.target,filter:this.filters.get(d)});return this.map.style.queryRenderedTargets(t,c,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const n=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());n.length&&(t.type="mouseenter",this.handleType(t,n));const c=new Map;for(const[d,{feature:p}]of this.prevHoveredFeatures)this.hoveredFeatures.has(d)||c.set(p.id,p);c.size&&(t.type="mouseleave",this.handleType(t,Array.from(c.values())))}handleOut(t){const n=Array.from(this.hoveredFeatures.values()).map((({feature:c})=>c));n.length&&(t.type="mouseleave",this.handleType(t,n)),this.hoveredFeatures.clear()}handleType(t,n){const c=t.type==="mouseenter";if(c&&!this.interactionsByType.has(t.type))return void o.w("mouseenter interaction required for mouseleave to work.");const d=Array.from(this.interactionsByType.get(t.type)).reverse(),p=!!n;n=n||this.queryTargets(t.point,d);let _=!1;const v=new Set;for(const w of n){for(const[I,C]of d){if(!C.target)continue;const O=w.variants?w.variants[I]:null;if(O){for(const D of O){if(rc(D,w,v,I))continue;const z=new o.dx(w,D),N=Al(D,w,I);p&&z.id!==void 0&&(z.state=this.map.getFeatureState(z));const B=c?this.prevHoveredFeatures.get(N):null,H=new al(t,I,C,z),q=B?B.stop:C.handler(H);if(c&&this.hoveredFeatures.set(N,{feature:w,stop:q}),q!==!1){_=!0;break}}if(_)break}}if(_)break}if(!_)for(const[w,I]of d){const{handler:C,target:O}=I;if(!O&&C(new al(t,w,I,null))!==!1)break}}}function Oy(l,t){if(Array.isArray(l)&&Array.isArray(t)){const n=new Set(l),c=new Set(t);return n.size===c.size&&l.every((d=>c.has(d)))}return o.by(l,t)}const zy={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},ky={showCompass:!0,showZoom:!0,visualizePitch:!1};class Fy{constructor(t,n,c=!1){this._clickTolerance=10,this.element=n,this.mouseRotate=new ip({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,c&&(this.mousePitch=new rp({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),o.aY(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),n.addEventListener("mousedown",this.mousedown),n.addEventListener("touchstart",this.touchstart,{passive:!1}),n.addEventListener("touchmove",this.touchmove),n.addEventListener("touchend",this.touchend),n.addEventListener("touchcancel",this.reset)}down(t,n){this.mouseRotate.mousedown(t,n),this.mousePitch&&this.mousePitch.mousedown(t,n),Ae()}move(t,n){const c=this.map,d=this.mouseRotate.mousemoveWindow(t,n),p=d&&d.bearingDelta;if(p&&c.setBearing(c.getBearing()+p),this.mousePitch){const _=this.mousePitch.mousemoveWindow(t,n),v=_&&_.pitchDelta;v&&c.setPitch(c.getPitch()+v)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){ze(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(Object.assign({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),it(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,it(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=jt(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=jt(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function ap(l,t,n){if(l=new o.aT(l.lng,l.lat),t){const c=new o.aT(l.lng-360,l.lat),d=new o.aT(l.lng+360,l.lat),p=360*Math.ceil(Math.abs(l.lng-n.center.lng)/360),_=n.locationPoint3D(l).distSqr(t),v=t.x<0||t.y<0||t.x>n.width||t.y>n.height;n.locationPoint3D(c).distSqr(t)<_&&(v||Math.abs(c.lng-n.center.lng)<p)?l=c:n.locationPoint3D(d).distSqr(t)<_&&(v||Math.abs(d.lng-n.center.lng)<p)&&(l=d)}for(;Math.abs(l.lng-n.center.lng)>180;){const c=n.locationPoint3D(l);if(c.x>=0&&c.y>=0&&c.x<=n.width&&c.y<=n.height)break;l.lng>n.center.lng?l.lng-=360:l.lng+=360}return l}const eo={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},ls={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class vd extends o.E{constructor(t,n){super(),(t instanceof HTMLElement||n)&&(t=Object.assign({element:t},n)),o.aY(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:c="center",color:d="#3FB1CE",scale:p=1,draggable:_=!1,clickTolerance:v=0,rotation:w=ls.rotation,rotationAlignment:I=ls.rotationAlignment,pitchAlignment:C=ls.pitchAlignment,occludedOpacity:O=ls.occludedOpacity,altitude:D=ls.altitude}=t||{};this._anchor=c,this._color=d,this._scale=p,this._draggable=_,this._clickTolerance=v,this._rotation=w,this._rotationAlignment=I,this._pitchAlignment=C,this._occludedOpacity=O,this._altitude=D,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=o.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=o.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(B=>{B.preventDefault()})),this._element.addEventListener("mousedown",(B=>{B.preventDefault()}));const z=this._element.classList;for(const B in eo)z.remove(`mapboxgl-marker-anchor-${B}`);z.add(`mapboxgl-marker-anchor-${this._anchor}`);const N=t&&t.className?t.className.trim().split(/\s+/):[];z.add(...N),this._popup=null}_createDefaultMarker(){const t=ge("div"),n=K("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){const c=K("radialGradient",{id:"shadowGradient"},K("defs",{},n));K("stop",{offset:"10%","stop-opacity":.4},c),K("stop",{offset:"100%","stop-opacity":.05},c),K("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},n)}return K("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},n),K("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},n),K("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},n),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=o.aT.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||ls.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const d=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const n=t.code,c=t.charCode||t.keyCode;n!=="Space"&&n!=="Enter"&&c!==32&&c!==13||this.togglePopup()}_onMapClick(t){const n=t.originalEvent.target,c=this._element;this._popup&&(n===c||c.contains(n))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,n=this._pos;if(!t||!n)return!1;const c=t.unproject(n,this._altitude),d=t.getFreeCameraOptions();if(!d.position)return!1;const p=d.position.toLngLat();return p.distanceTo(c)<.9*p.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const n=this._pos;if(!n||n.x<0||n.x>t.transform.width||n.y<0||n.y>t.transform.height)return void this._clearFadeTimer();const c=t.unproject(n,this._altitude);let d;t._showingGlobe()&&o.f5(t.transform,this._lngLat)?d=0:(d=1-t._queryFogOpacity(c),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(d*=this._occludedOpacity)),this._element.style.opacity=`${d}`,this._element.style.pointerEvents=d>0?"auto":"none",this._popup&&this._popup._setOpacity(d),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const n=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${eo[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${n.x}px,${n.y}px)
        `}_calculateXYTransform(){const t=this._pos,n=this._map,c=this.getPitchAlignment();if(!n||!t||c!=="map")return"";if(!n._showingGlobe()){const w=n.getPitch();return w?`rotateX(${w}deg)`:""}const d=o.cX(o.f6(n.transform,this._lngLat)),p=t.sub(o.f7(n.transform)),_=Math.abs(p.x)+Math.abs(p.y);if(_===0)return"";const v=d/_;return`rotateX(${-p.y*v}deg) rotateY(${p.x*v}deg)`}_calculateZTransform(){const t=this._pos,n=this._map;if(!n||!t)return"";let c=0;const d=this.getRotationAlignment();if(d==="map")if(n._showingGlobe()){const p=n.project(new o.aT(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),_=n.project(new o.aT(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(p);c=o.cX(Math.atan2(_.y,_.x))-90}else c=-n.getBearing();else if(d==="horizon"){const p=o.ah(4,6,n.getZoom()),_=o.f7(n.transform);_.y+=p*n.transform.height;const v=t.sub(_),w=o.cX(Math.atan2(v.y,v.x));c=(w>90?w-270:w+90)*(1-p)}return c+=this._rotation,c?`rotateZ(${c}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);const n=this._map;n&&(n.transform.renderWorldCopies&&(this._lngLat=ap(this._lngLat,this._pos,n.transform)),this._pos=n.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),n._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(n._showingGlobe()||n.getTerrain()||n.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(t){return this._offset=o.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const n=this._map;if(!n)return;const c=this._pointerdownPos,d=this._positionDelta;if(c&&d){if(!this._isDragging){const p=this._clickTolerance||n._clickTolerance;if(t.point.dist(c)<p)return;this._isDragging=!0}this._pos=t.point.sub(d),this._lngLat=n.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new o.z("dragstart"))),this.fire(new o.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new o.z("dragend")),this._state="inactive"}_addDragHandler(t){const n=this._map,c=this._pos;n&&c&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(c),this._pointerdownPos=t.point,this._state="pending",n.on("mousemove",this._onMove),n.on("touchmove",this._onMove),n.once("mouseup",this._onUp),n.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const n=this._map;return n&&(t?(n.on("mousedown",this._addDragHandler),n.on("touchstart",this._addDragHandler)):(n.off("mousedown",this._addDragHandler),n.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||ls.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||ls.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||ls.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||ls.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const By={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Ic={maxWidth:100,unit:"metric"},lp={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},cs={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},us=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Zl(l=new o.P(0,0),t="bottom"){if(typeof l=="number"){const n=Math.round(Math.sqrt(.5*Math.pow(l,2)));switch(t){case"top":return new o.P(0,l);case"top-left":return new o.P(n,n);case"top-right":return new o.P(-n,n);case"bottom":return new o.P(0,-l);case"bottom-left":return new o.P(n,-n);case"bottom-right":return new o.P(-n,-n);case"left":return new o.P(l,0);case"right":return new o.P(-l,0)}return new o.P(0,0)}return l instanceof o.P||Array.isArray(l)?o.P.convert(l):o.P.convert(l[t]||[0,0])}return{version:G,supported:oe.supported,setRTLTextPlugin:o.fb,getRTLTextPluginStatus:o.fa,Map:class extends sp{constructor(l){ee.mark(Z.create);const t=l;if((l=Object.assign({},zy,l)).minZoom!=null&&l.maxZoom!=null&&l.minZoom>l.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(l.minPitch!=null&&l.maxPitch!=null&&l.minPitch>l.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(l.minPitch!=null&&l.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(l.maxPitch!=null&&l.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(l.antialias&&o.f3(window)&&(l.antialias=!1,o.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new hf(l.minZoom,l.maxZoom,l.minPitch,l.maxPitch,l.renderWorldCopies,null,null),l),this._repaint=!!l.repaint,this._interactive=l.interactive,this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._failIfMajorPerformanceCaveat=l.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=l.preserveDrawingBuffer,this._antialias=l.antialias,this._trackResize=l.trackResize,this._bearingSnap=l.bearingSnap,this._refreshExpiredTiles=l.refreshExpiredTiles,this._fadeDuration=l.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=l.crossSourceCollisions,this._collectResourceTiming=l.collectResourceTiming,this._language=this._parseLanguage(l.language),this._worldview=l.worldview,this._renderTaskQueue=new Ta,this._domRenderTaskQueue=new Ta,this._controls=[],this._markers=[],this._popups=[],this._mapId=o.b2(),this._locale=Object.assign({},Sa,l.locale),this._clickTolerance=l.clickTolerance,this._cooperativeGestures=l.cooperativeGestures,this._performanceMetricsCollection=l.performanceMetricsCollection,this._tessellationStep=l.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=l.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Ea(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=l.scaleFactor,this._requestManager=new Ai(l.transformRequest,l.accessToken,l.testMode),this._silenceAuthErrors=!!l.testMode,this._contextCreateOptions=l.contextCreateOptions?Object.assign({},l.contextCreateOptions):{},typeof l.container=="string"){const n=document.getElementById(l.container);if(!n)throw new Error(`Container '${l.container.toString()}' not found.`);this._container=n}else{if(!(l.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=l.container}if(this._container.childNodes.length>0&&o.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),l.maxBounds&&this.setMaxBounds(l.maxBounds),this._spriteFormat=l.spriteFormat,o.aY(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Dy(this,l),this._localFontFamily=l.localFontFamily,this._localIdeographFontFamily=l.localIdeographFontFamily,(l.style||!l.testMode)&&this.setStyle(l.style||o.e.DEFAULT_STYLE,{config:l.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),l.projection&&this.setProjection(l.projection),l.hash&&(this._hash=new Wf(typeof l.hash=="string"&&l.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:l.center,zoom:l.zoom,bearing:l.bearing,pitch:l.pitch});const n=l.bounds;n&&(this.resize(),this.fitBounds(n,Object.assign({},l.fitBoundsOptions,{duration:0})))}this.resize(),l.attributionControl&&this.addControl(new Du({customAttribution:l.customAttribution})),this._logoControl=new Ou,this.addControl(this._logoControl,l.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent(),this._postStyleWithAppearanceEvent(),this._setupIndoor()})),this.on("data",(n=>{this._update(n.dataType==="style"),this.fire(new o.z(`${n.dataType}data`,n))})),this.on("dataloading",(n=>{this.fire(new o.z(`${n.dataType}dataloading`,n))})),this._interactions=new As(this)}_getMapId(){return this._mapId}addControl(l,t){if(t===void 0&&(t=l.getDefaultPosition?l.getDefaultPosition():"top-right"),!l||!l.onAdd)return this.fire(new o.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=l.onAdd(this);this._controls.push(l);const c=this._controlPositions[t];return t.indexOf("bottom")!==-1?c.insertBefore(n,c.firstChild):c.appendChild(n),this}removeControl(l){if(!l||!l.onRemove)return this.fire(new o.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(l);return t>-1&&this._controls.splice(t,1),l.onRemove(this),this}hasControl(l){return this._controls.indexOf(l)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(l){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new o.z("movestart",l)).fire(new o.z("move",l)),this.fire(new o.z("resize",l)),t&&this.fire(new o.z("moveend",l)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(l){return this.transform.setMaxBounds(o.aI.convert(l)),this._update()}setMinZoom(l){if((l=l??-2)>=-2&&l<=this.transform.maxZoom)return this.transform.minZoom=l,this._update(),this.getZoom()<l?this.setZoom(l):this.fire(new o.z("zoomstart")).fire(new o.z("zoom")).fire(new o.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(l){if((l=l??22)>=this.transform.minZoom)return this.transform.maxZoom=l,this._update(),this.getZoom()>l?this.setZoom(l):this.fire(new o.z("zoomstart")).fire(new o.z("zoom")).fire(new o.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(l){if((l=l??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(l>=0&&l<=this.transform.maxPitch)return this.transform.minPitch=l,this._update(),this.getPitch()<l?this.setPitch(l):this.fire(new o.z("pitchstart")).fire(new o.z("pitch")).fire(new o.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(l){if((l=l??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(l>=this.transform.minPitch)return this.transform.maxPitch=l,this._update(),this.getPitch()>l?this.setPitch(l):this.fire(new o.z("pitchstart")).fire(new o.z("pitch")).fire(new o.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(l){return this._scaleFactor=l,this.painter.scaleFactor=l,this._scaleFactorChanged=!0,this.style._updateFilteredLayers((t=>t.type==="symbol")),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(l){return this.transform.renderWorldCopies=l,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(l){return l==="auto"?navigator.language:Array.isArray(l)?l.length===0?void 0:l.map((t=>t==="auto"?navigator.language:t)):l}setLanguage(l){const t=this._parseLanguage(l);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const n of this._controls)n._setLanguage&&n._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(l){return this.style&&l!==this._worldview?(this._worldview=l,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(l){return this._lazyInitEmptyStyle(),l?typeof l=="string"&&(l={name:l}):l=null,this._useExplicitProjection=!!l,this._prioritizeAndUpdateProjection(l,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const l=this.transform,t=l.projection.name;let n;t==="globe"&&l.zoom>=o.cL?(l.setMercatorFromTransition(),n=!0):t==="mercator"&&l.zoom<o.cL&&(l.setProjection({name:"globe"}),n=!0),n&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(l,t){return this._updateProjection(l||t||{name:"mercator"})}_updateProjection(l){let t;const n=this.transform.mercatorFromTransition;t=l.name==="globe"&&this.transform.zoom>=o.cL?this.transform.setMercatorFromTransition():this.transform.setProjection(l),this.style.applyProjectionUpdate();const c=this.transform.getProjection().name==="mercator"&&n!==this.transform.mercatorFromTransition;return(t||c)&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(l,t){return this.transform.locationPoint3D(o.aT.convert(l),t)}unproject(l,t){return this.transform.pointLocation3D(o.P.convert(l),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(l,t,n){const c=d=>{let p=[];if(Array.isArray(t)){const _=t.filter((v=>this.getLayer(v)));p=_.length?this.queryRenderedFeatures(d,{layers:_}):[]}else p=this.queryRenderedFeatures(d,{target:t});return p};if(l==="mouseenter"||l==="mouseover"){let d=!1;return{listener:n,targets:t,delegates:{mousemove:_=>{const v=c(_.point);v.length?d||(d=!0,n.call(this,new Eo(l,this,_.originalEvent,{features:v}))):d=!1},mouseout:()=>{d=!1}}}}if(l==="mouseleave"||l==="mouseout"){let d=!1;return{listener:n,targets:t,delegates:{mousemove:v=>{c(v.point).length?d=!0:d&&(d=!1,n.call(this,new Eo(l,this,v.originalEvent)))},mouseout:v=>{d&&(d=!1,n.call(this,new Eo(l,this,v.originalEvent)))}}}}{const d=p=>{const _=c(p.point);_.length&&(p.features=_,n.call(this,p),delete p.features)};return{listener:n,targets:t,delegates:{[l]:d}}}}on(l,t,n){if(typeof t=="function"||n===void 0)return super.on(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[l]=this._delegatedListeners[l]||[],this._delegatedListeners[l].push(c);for(const d in c.delegates)this.on(d,c.delegates[d]);return this}once(l,t,n){if(typeof t=="function"||n===void 0)return super.once(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);for(const d in c.delegates)this.once(d,c.delegates[d]);return this}off(l,t,n){if(typeof t=="function"||n===void 0)return super.off(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._delegatedListeners?this._delegatedListeners[l]:void 0;return c&&(d=>{for(let p=0;p<d.length;p++){const _=d[p];if(_.listener===n&&Oy(_.targets,t)){for(const v in _.delegates)this.off(v,_.delegates[v]);return d.splice(p,1),this}}})(c),this}queryRenderedFeatures(l,t){if(!this.style)return[];if(l===void 0||l instanceof o.P||Array.isArray(l)||t!==void 0||(t=l,l=void 0),l=l||[[0,0],[this.transform.width,this.transform.height]],!t){const p=this.style.queryRenderedFeatures(l,void 0,this.transform),_=this.style.queryRenderedFeatureset(l,void 0,this.transform);return p.concat(_)}let n=!0;if(t.target&&(n=this._isTargetValid(t.target),n&&!t.layers))return this.style.queryRenderedFeatureset(l,t,this.transform);let c=!0;if(t.layers&&Array.isArray(t.layers)){for(const p of t.layers)if(!this._isValidId(p)){c=!1;break}if(c&&!t.target)return this.style.queryRenderedFeatures(l,t,this.transform)}let d=[];return c&&(d=d.concat(this.style.queryRenderedFeatures(l,t,this.transform))),n&&(d=d.concat(this.style.queryRenderedFeatureset(l,t,this.transform))),d}querySourceFeatures(l,t){return!l||typeof l=="string"&&!this._isValidId(l)?[]:this.style.querySourceFeatures(l,t)}queryRasterValue(l,t,n){return this._isValidId(l)?this.style.queryRasterValue(l,t,n):Promise.resolve(null)}isPointOnSurface(l){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&o.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(o.P.convert(l))}addInteraction(l,t){return this._interactions.add(l,t),this}removeInteraction(l){return this._interactions.remove(l),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(l){return this._cooperativeGestures=l,this}setStyle(l,t){return t=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&l&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(l,((n,c)=>{if(n){const d=typeof n=="string"?n:n instanceof Error?n.message:n.error;o.w(`Unable to perform style diff: ${d}. Rebuilding the style from scratch.`),this._updateStyle(l,t)}else c&&this._update(!0)}),(()=>this._postStyleLoadEvent())),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(l,t))}_getUIString(l){const t=this._locale[l];if(t==null)throw new Error(`Missing UI string '${l}'`);return t}_updateStyle(l,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),l){const n=Object.assign({},t);t&&t.config&&(n.initialConfig=t.config,delete n.config),this.style=new as(this,n).load(l),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new as(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(o.w("There is no style added to the map."),!1)}_isValidId(l){return l==null?(this.fire(new o.y(new Error("IDs can't be empty."))),!1):!o.dr(l)||(this.fire(new o.y(new Error(`IDs can't contain special symbols: "${l}".`))),!1)}_isTargetValid(l){return"featuresetId"in l?this._isValidId("importId"in l?l.importId:l.featuresetId):"layerId"in l&&this._isValidId(l.layerId)}_areTargetsValid(l){if(Array.isArray(l)){for(const t of l)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(l)}addSource(l,t){return this._isValidId(l)?(this._lazyInitEmptyStyle(),this.style.addSource(l,t),this._update(!0)):this}isSourceLoaded(l){return!!this._isValidId(l)&&!!this.style&&this.style._isSourceCacheLoaded(l)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(l,t,n){this._lazyInitEmptyStyle(),this.style.addSourceType(l,t,n)}removeSource(l){return this._isValidId(l)?(this.style.removeSource(l),this._updateTerrain(),this._update(!0)):this}getSource(l){return this._isValidId(l)?this.style.getOwnSource(l):null}addImage(l,t,{pixelRatio:n=1,sdf:c=!1,stretchX:d,stretchY:p,content:_}={}){this._lazyInitEmptyStyle();const v=o.I.from(l);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:w,height:I,data:C}=o.o.getImageData(t);this.style.addImage(v,{data:new o.q({width:w,height:I},C),pixelRatio:n,stretchX:d,stretchY:p,content:_,sdf:c,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new o.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:w,height:I}=t,C=t;this.style.addImage(v,{data:new o.q({width:w,height:I},new Uint8Array(C.data)),pixelRatio:n,stretchX:d,stretchY:p,content:_,sdf:c,usvg:!1,version:0,userImage:C}),C.onAdd&&C.onAdd(this,l)}}updateImage(l,t){this._lazyInitEmptyStyle();const n=o.I.from(l),c=this.style.getImage(n);if(!c)return void this.fire(new o.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const d=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?o.o.getImageData(t):t,{width:p,height:_,data:v}=d;if(p===void 0||_===void 0)return void this.fire(new o.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(p!==(c.usvg?c.icon.usvg_tree.width:c.data.width)||_!==(c.usvg?c.icon.usvg_tree.height:c.data.height))return void this.fire(new o.y(new Error(`The width and height of the updated image (${p}, ${_})
                must be that same as the previous version of the image
                (${c.data.width}, ${c.data.height})`)));const w=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let I=!1;c.usvg?(c.data=new o.q({width:p,height:_},new Uint8Array(v)),c.usvg=!1,c.icon=void 0,I=!0):c.data.replace(v,w),this.style.updateImage(n,c,I)}hasImage(l){return l?!!this.style&&!!this.style.getImage(o.I.from(l)):(this.fire(new o.y(new Error("Missing required image id"))),!1)}removeImage(l){this.style.removeImage(o.I.from(l))}loadImage(l,t){o.n(this._requestManager.transformRequest(l,o.R.Image),((n,c)=>{t(n,c instanceof HTMLImageElement?o.o.getImageData(c):c)}))}listImages(){return this.style.listImages().map((l=>l.name))}addModel(l,t){this._lazyInitEmptyStyle(),this.style.addModel(l,t)}hasModel(l){return l?this.style.hasModel(l):(this.fire(new o.y(new Error("Missing required model id"))),!1)}removeModel(l){this.style.removeModel(l)}listModels(){return this.style.listModels()}addLayer(l,t){return this._isValidId(l.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(l,t),this._update(!0)):this}getSlot(l){const t=this.getLayer(l);return t&&t.slot||null}setSlot(l,t){return this.style.setSlot(l,t),this.style.mergeLayers(),this._update(!0)}addImport(l,t){return this.style.addImport(l,t).catch((n=>this.fire(new o.y(new Error("Failed to add import",n))))),this}updateImport(l,t){return typeof t!="string"&&t.id!==l?(this.removeImport(l),this.addImport(t)):(this.style.updateImport(l,t),this._update(!0))}removeImport(l){return this.style.removeImport(l),this}moveImport(l,t){return this.style.moveImport(l,t),this._update(!0)}moveLayer(l,t){return this._isValidId(l)?(this.style.moveLayer(l,t),this._update(!0)):this}removeLayer(l){return this._isValidId(l)?(this.style.removeLayer(l),this._update(!0)):this}getLayer(l){if(!this._isValidId(l))return null;const t=this.style.getOwnLayer(l);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(l,t,n){return this._isValidId(l)?(this.style.setLayerZoomRange(l,t,n),this._update(!0)):this}setFilter(l,t,n={}){return this._isValidId(l)?(this.style.setFilter(l,t,n),this._update(!0)):this}getFilter(l){return this._isValidId(l)?this.style.getFilter(l):null}setPaintProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setPaintProperty(l,t,n,c),this._update(!0)):this}getPaintProperty(l,t){return this._isValidId(l)?this.style.getPaintProperty(l,t):null}setLayoutProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setLayoutProperty(l,t,n,c),this._update(!0)):this}getLayoutProperty(l,t){return this._isValidId(l)?this.style.getLayoutProperty(l,t):null}setLayerProperty(l,t,n,c={}){return this._isValidId(l)?(t==="appearances"&&this._postAddingAppearancesToStyleEvent(),this.style.setLayerProperty(l,t,n,c),this._update(!0)):this}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(l){return this.style.setGlyphsUrl(l),this._update(!0)}getSchema(l){return this.style.getSchema(l)}setSchema(l,t){return this.style.setSchema(l,t),this._update(!0)}getConfig(l){return this.style.getConfig(l)}setConfig(l,t){return this.style.setConfig(l,t),this._update(!0)}getConfigProperty(l,t){return this.style.getConfigProperty(l,t)}setConfigProperty(l,t,n){return this.style.setConfigProperty(l,t,n),this._update(!0)}getFeaturesetDescriptors(l){return this.style.getFeaturesetDescriptors(l)}setLights(l){if(this._lazyInitEmptyStyle(),l&&l.length===1&&l[0].type==="flat"){const t=l[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(l),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const l=this.style.getLights()||[];return l.length===0&&l.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),l}setLight(l,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:l}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(l){return this._lazyInitEmptyStyle(),!l&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(l),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(l){return this._lazyInitEmptyStyle(),this.style.setFog(l),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(l){return this._lazyInitEmptyStyle(),this.style.setSnow(l),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(l){return this._lazyInitEmptyStyle(),this.style.setRain(l),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(l){return this._lazyInitEmptyStyle(),this.style.setColorTheme(l),this._update(!0)}setImportColorTheme(l,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(l,t),this._update(!0)}setCamera(l){return this.style.setCamera(l),this._triggerCameraUpdate(l)}_triggerCameraUpdate(l){return this._update(this.transform.setOrthographicProjectionAtLowPitch(l["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(l){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(o.aT.convert(l),this.transform):0}setFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.setFeatureState(l,t),this._update())}removeFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.removeFeatureState(l,t),this._update())}getFeatureState(l){return l.source&&!this._isValidId(l.source)?null:this.style.getFeatureState(l)}_selectIndoorFloor(l){this.indoor.selectFloor(l)}_setIndoorActiveFloorsVisibility(l){this.indoor.setActiveFloorsVisibility(l)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new Sc),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const l=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let n,c,d,p=this._container;for(;p&&(!c||!d);){const _=window.getComputedStyle(p).transform;_&&_!=="none"&&(n=_.match(/matrix.*\((.+)\)/)[1].split(", "),n[0]&&n[0]!=="0"&&n[0]!=="1"&&(c=n[0]),n[3]&&n[3]!=="0"&&n[3]!=="1"&&(d=n[3])),p=p.parentElement}this._containerWidth=c?Math.abs(l/c):l,this._containerHeight=d?Math.abs(t/d):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&o.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupIndoor(){this.style.isIndoorEnabled()&&(this.indoor=new Rm(this.style),this.on("load",(()=>{this._addIndoorControl(),this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds()),this.on("move",(()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())})),this.on("idle",(()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())}))})))}_setupContainer(){const l=this._container;l.classList.add("mapboxgl-map"),(this._missingCSSCanary=ge("div","mapboxgl-canary",l)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=ge("div","mapboxgl-canvas-container",l);this._canvas=ge("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const n=this._controlContainer=ge("div","mapboxgl-control-container",l),c=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach((d=>{c[d]=ge("div",`mapboxgl-ctrl-${d}`,n)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(l,t){const n=o.o.devicePixelRatio||1;this._canvas.width=n*Math.ceil(l),this._canvas.height=n*Math.ceil(t),this._canvas.style.width=`${l}px`,this._canvas.style.height=`${t}px`}_addMarker(l){this._markers.push(l)}_removeMarker(l){const t=this._markers.indexOf(l);t!==-1&&this._markers.splice(t,1)}_addPopup(l){this._popups.push(l)}_removePopup(l){const t=this._popups.indexOf(l);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const l=Object.assign({},oe.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",l);t?(Jr(t,!0),this.painter=new od(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._worldview),this.on("data",(n=>{n.dataType==="source"&&this.painter.setTileLoadedFlag(!0)})),o.k.testSupport(t)):this.fire(new o.y(new Error("Failed to initialize WebGL")))}_contextLost(l){l.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new o.z("webglcontextlost",{originalEvent:l}))}_contextRestored(l){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new o.z("webglcontextrestored",{originalEvent:l}))}_onMapScroll(l){if(l.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(l){return this.style?(this._styleDirty=this._styleDirty||l,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(l){return this._update(),this._renderTaskQueue.add(l)}_cancelRenderFrame(l){this._renderTaskQueue.remove(l)}_requestDomTask(l){!this.loaded()||this.loaded()&&!this.isMoving()?l():this._domRenderTaskQueue.add(l)}_render(l){let t;this.fire(new o.z("renderstart")),++this._frameId;const n=this.painter.context.extTimerQuery,c=o.o.now(),d=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=d.createQuery(),d.beginQuery(n.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(l),this._domRenderTaskQueue.run(l),this._removed)return;this._updateProjectionTransition();const p=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const I=this.transform.zoom,C=this.transform.pitch,O=o.o.now(),D=new o.ac(I,{now:O,fadeDuration:p,pitch:C,transition:this.style.transition,worldview:this._worldview});this.style.update(D)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let _=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),_=this._updateAverageElevation(c),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):_=this._updateAverageElevation(c);const v=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,p,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),v&&(this._placementDirty=v.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:p,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new o.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,ee.mark(Z.load),this.fire(new o.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const I=o.o.now()-c;d.endQuery(n.TIME_ELAPSED_EXT),setTimeout((()=>{const C=d.getQueryParameter(t,d.QUERY_RESULT)/1e6;d.deleteQuery(t),this.fire(new o.z("gpu-timing-frame",{cpuTime:I,gpuTime:C}))}),50)}if(this.listens("gpu-timing-layer")){const I=this.painter.collectGpuTimers();setTimeout((()=>{const C=this.painter.queryGpuTimers(I);this.fire(new o.z("gpu-timing-layer",{layerTimes:C}))}),50)}if(this.listens("gpu-timing-deferred-render")){const I=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const C=this.painter.queryGpuTimeDeferredRender(I);this.fire(new o.z("gpu-timing-deferred-render",{gpuTime:C}))}),50)}const w=this._sourcesDirty||this._styleDirty||this._placementDirty||_;if(w||this._repaint)this.triggerRepaint();else{const I=this.idle();if(I&&(_=this._updateAverageElevation(c,!0)),_)this.triggerRepaint();else if(this._triggerFrame(!1),I&&(this.fire(new o.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const C=this._calculateSpeedIndex();this.fire(new o.z("speedindexcompleted",{speedIndex:C})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||w||(this._fullyLoaded=!0,ee.mark(Z.fullLoad),this._performanceMetricsCollection&&kr(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(l){for(const t of this._markers)l&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!l||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(l,t=!1){const n=d=>(this.transform.averageElevation=d,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&n(0);const c=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(c||(t||l-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(l)){const d=this.transform.averageElevation;let p=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(p)?p=0:this._averageElevationLastSampledAt=l;const _=Math.abs(d-p);if(_>1){if(this._isInitialLoad||c)return this._averageElevation.jumpTo(p),n(p);this._averageElevation.easeTo(p,l,300)}else if(_>1e-4)return this._averageElevation.jumpTo(p),n(p)}return!!this._averageElevation.isEasing(l)&&n(this._averageElevation.getValue(l))}_authenticate(){yo(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(l=>{if(l&&(l.message===Pt||l.status===401)){const t=this.painter.context.gl;Jr(t,!1),this._logoControl instanceof Ou&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new o.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),ii(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&si(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_postStyleWithAppearanceEvent(){this.style.globalId&&this.style.hasAppearances()&&ui(this._requestManager._customAccessToken)}_postAddingAppearancesToStyleEvent(){wr(this._requestManager._customAccessToken)}_updateTerrain(){const l=this._isDragging();this.painter.updateTerrain(this.style,l)}_calculateSpeedIndex(){const l=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const n=this.painter.context.gl,c=n.createFramebuffer();function d(p){n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,p,0);const _=new Uint8Array(n.drawingBufferWidth*n.drawingBufferHeight*4);return n.readPixels(0,0,n.drawingBufferWidth,n.drawingBufferHeight,n.RGBA,n.UNSIGNED_BYTE,_),_}return n.bindFramebuffer(n.FRAMEBUFFER,c),this._canvasPixelComparison(d(l),t.canvasCopies.map(d),t.timeStamps)}_canvasPixelComparison(l,t,n){let c=n[1]-n[0];const d=l.length/4;for(let p=0;p<t.length;p++){const _=t[p];let v=0;for(let w=0;w<_.length;w+=4)_[w]===l[w]&&_[w+1]===l[w+1]&&_[w+2]===l[w+2]&&_[w+3]===l[w+3]&&(v+=1);c+=(n[p+2]-n[p+1])*(1-v/d)}return c}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor&&this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const l=this.painter.context.gl.getExtension("WEBGL_lose_context");l&&l.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Gr.delete(this.painter.context.gl),Rn.remove(),qn.remove(),this._removed=!0,this.fire(new o.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(l){this._renderNextFrame=this._renderNextFrame||l,this.style&&!this._frame&&(this._frame=o.o.frame((t=>{const n=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,n&&this._render(t)})))}_preloadTiles(l){const t=this.style?this.style.getSourceCaches():[];return o.bw(t,((n,c)=>n._preloadTiles(l,c)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(l){this._trackResize&&this.resize({originalEvent:l})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(l){this._showTileBoundaries!==l&&(this._showTileBoundaries=l,this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(l){this._showParseStatus!==l&&(this._showParseStatus=l,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(l){this._showTerrainWireframe!==l&&(this._showTerrainWireframe=l,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(l){this._showLayers2DWireframe!==l&&(this._showLayers2DWireframe=l,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(l){this._showLayers3DWireframe!==l&&(this._showLayers3DWireframe=l,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(l){this._speedIndexTiming!==l&&(this._speedIndexTiming=l,this._update())}get showPadding(){return!!this._showPadding}set showPadding(l){this._showPadding!==l&&(this._showPadding=l,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(l){this._showCollisionBoxes!==l&&(this._showCollisionBoxes=l,this.style&&l?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(l){this._showOverdrawInspector!==l&&(this._showOverdrawInspector=l,this._update())}get repaint(){return!!this._repaint}set repaint(l){this._repaint!==l&&(this._repaint=l,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(l){this._vertices=l,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(l){this._showTileAABBs!==l&&(this._showTileAABBs=l,l&&this._update())}_setCacheLimits(l,t){o.f4(l,t)}get version(){return G}},NavigationControl:class{constructor(l={}){this.options=Object.assign({},ky,l),this._container=ge("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this.options.showZoom&&(o.aY(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(t=>{this._map&&this._map.zoomIn({},{originalEvent:t})})),ge("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(t=>{this._map&&this._map.zoomOut({},{originalEvent:t})})),ge("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(o.aY(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(t=>{const n=this._map;n&&(this.options.visualizePitch?n.resetNorthPitch({},{originalEvent:t}):n.resetNorth({},{originalEvent:t}))})),this._compassIcon=ge("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const l=this._map;if(!l)return;const t=l.getZoom(),n=t===l.getMaxZoom(),c=t===l.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())}_rotateCompassArrow(){const l=this._map;if(!l)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(l.transform.pitch*(Math.PI/180)),.5)}) rotateX(${l.transform.pitch}deg) rotateZ(${l.transform.angle*(180/Math.PI)}deg)`:`rotate(${l.transform.angle*(180/Math.PI)}deg)`;l._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=t)}))}onAdd(l){return this._map=l,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),l.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&l.on("pitch",this._rotateCompassArrow),l.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Fy(l,this._compass,this.options.visualizePitch)),this._container}onRemove(){const l=this._map;l&&(this._container.remove(),this.options.showZoom&&l.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&l.off("pitch",this._rotateCompassArrow),l.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(l,t){const n=ge("button",l,this._container);return n.type="button",n.addEventListener("click",t),n}_setButtonTitle(l,t){if(!this._map)return;const n=this._map._getUIString(`NavigationControl.${t}`);l.setAttribute("aria-label",n),l.firstElementChild&&l.firstElementChild.setAttribute("title",n)}},GeolocateControl:class extends o.E{constructor(l={}){super();const t=navigator.geolocation;this.options=Object.assign({geolocation:t},By,l),o.aY(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=sd(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(l){return this._map=l,this._container=ge("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(l){const t=(n=!!this.options.geolocation)=>{this._supportsGeolocation=n,l(n)};this._supportsGeolocation!==void 0?l(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then((n=>t(n.state!=="denied"))).catch((()=>t())):t()}_isOutOfMapMaxBounds(l){const t=this._map.getMaxBounds(),n=l.coords;return!!t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(l){if(this._map){if(this._isOutOfMapMaxBounds(l))return this._setErrorState(),this.fire(new o.z("outofmaxbounds",l)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=l,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(l),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(l),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.z("geolocate",Object.assign({coords:l.coords,timestamp:l.timestamp},l.toJSON?{toJSON:l.toJSON.bind(l)}:{}))),this._finish()}}_updateCamera(l){const t=new o.aT(l.coords.longitude,l.coords.latitude),n=l.coords.accuracy,c=this._map.getBearing(),d=Object.assign({bearing:c},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(n),d,{geolocateSource:!0})}_updateMarker(l){if(l){const t=new o.aT(l.coords.longitude,l.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=l.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const l=this._map.transform,t=o.cf(1,l._center.lat)*l.worldSize,n=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${n}px`,this._circleElement.style.height=`${n}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(l){if(this._map){if(this.options.trackUserLocation)if(l.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(l.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.z("error",l)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(l){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this._geolocateButton=ge("button","mapboxgl-ctrl-geolocate",this._container),ge("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",l===!1){o.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=ge("div","mapboxgl-user-location"),this._dotElement.appendChild(ge("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(ge("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new vd({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=ge("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new vd({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new o.z("trackuserlocationend")))}))}}_onDeviceOrientation(l){this._userLocationDotMarker&&(l.webkitCompassHeading?this._heading=l.webkitCompassHeading:l.absolute===!0&&(this._heading=-1*l.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return o.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new o.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new o.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new o.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let l;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(l={maximumAge:6e5,timeout:0},this._noTimeout=!0):(l=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,l),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const l=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then((t=>{t==="granted"&&l()})).catch(console.error):l()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Du,ScaleControl:class{constructor(l={}){this.options=Object.assign({},Ic,l),o.aY(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const l=this.options.maxWidth||100,t=this._map,n=t._containerHeight/2,c=t._containerWidth/2-l/2,d=t.unproject([c,n]),p=t.unproject([c+l,n]),_=d.distanceTo(p);if(this.options.unit==="imperial"){const v=3.2808*_;v>5280?this._setScale(l,v/5280,"mile"):this._setScale(l,v,"foot")}else this.options.unit==="nautical"?this._setScale(l,_/1852,"nautical-mile"):_>=1e3?this._setScale(l,_/1e3,"kilometer"):this._setScale(l,_,"meter")}_setScale(l,t,n){this._map._requestDomTask((()=>{const c=(function(p){const _=Math.pow(10,`${Math.floor(p)}`.length-1);let v=p/_;return v=v>=10?10:v>=5?5:v>=3?3:v>=2?2:v>=1?1:(function(w){const I=Math.pow(10,Math.ceil(-Math.log(w)/Math.LN10));return Math.round(w*I)/I})(v),_*v})(t),d=c/t;this._container.innerHTML=n!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:n}).format(c):`${c}&nbsp;${lp[n]}`,this._container.style.width=l*d+"px"}))}onAdd(l){return this._map=l,this._language=l.getLanguage(),this._container=ge("div","mapboxgl-ctrl mapboxgl-ctrl-scale",l.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(l){this._language=l,this._update()}setUnit(l){this.options.unit=l,this._update()}},FullscreenControl:class{constructor(l={}){this._fullscreen=!1,l&&l.container&&(l.container instanceof HTMLElement?this._container=l.container:o.w("Full screen control 'container' must be a DOM element.")),o.aY(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(l){return this._map=l,this._container||(this._container=this._map.getContainer()),this._controlContainer=ge("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",o.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const l=this._fullscreenButton=ge("button","mapboxgl-ctrl-fullscreen",this._controlContainer);ge("span","mapboxgl-ctrl-icon",l).setAttribute("aria-hidden","true"),l.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const l=this._getTitle();this._fullscreenButton.setAttribute("aria-label",l),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",l)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:Sc,Popup:class extends o.E{constructor(l){super(),this.options=Object.assign(Object.create(cs),l),this._altitude=this.options.altitude,o.aY(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(l&&l.className?l.className.trim().split(/\s+/):[])}addTo(l){return this._map&&this.remove(),this._map=l,this.options.closeOnClick&&l.on("preclick",this._onClose),this.options.closeOnMove&&l.on("move",this._onClose),l.on("remove",this.remove),this._update(),l._addPopup(this),this._focusFirstElement(),this._trackPointer?(l.on("mousemove",this._onMouseEvent),l.on("mouseup",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")):l.on("move",this._update),this.fire(new o.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const l=this._map;return l&&(l.off("move",this._update),l.off("move",this._onClose),l.off("preclick",this._onClose),l.off("click",this._onClose),l.off("remove",this.remove),l.off("mousemove",this._onMouseEvent),l.off("mouseup",this._onMouseEvent),l.off("drag",this._onMouseEvent),l._canvasContainer&&l._canvasContainer.classList.remove("mapboxgl-track-pointer"),l._removePopup(this),this._map=void 0),this.fire(new o.z("close")),this}getLngLat(){return this._lngLat}setLngLat(l){this._lngLat=o.aT.convert(l),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(l){return this._altitude=l,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const l=this._map;return l&&(l.off("move",this._update),l.on("mousemove",this._onMouseEvent),l.on("drag",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(l){return this.setDOMContent(document.createTextNode(l))}setHTML(l){const t=document.createDocumentFragment(),n=document.createElement("body");let c;for(n.innerHTML=l;c=n.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(l){return this.options.maxWidth=l,this._update(),this}setDOMContent(l){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=ge("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(l),this.options.closeButton){const n=this._closeButton=ge("button","mapboxgl-popup-close-button",t);n.type="button",n.setAttribute("aria-label","Close popup"),n.innerHTML='<span aria-hidden="true">&#215;</span>',n.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(l){return this._classList.add(l),this._updateClassList(),this}removeClassName(l){return this._classList.delete(l),this._updateClassList(),this}setOffset(l){return this.options.offset=l,this._update(),this}toggleClassName(l){let t;return this._classList.delete(l)?t=!1:(this._classList.add(l),t=!0),this._updateClassList(),t}_onMouseEvent(l){this._update(l.point)}_getAnchor(l){if(this.options.anchor)return this.options.anchor;const t=this._map,n=this._container,c=this._pos;if(!t||!n||!c)return"bottom";const d=n.offsetWidth,p=n.offsetHeight,_=c.x<d/2,v=c.x>t.transform.width-d/2;if(c.y+l<p)return _?"top-left":v?"top-right":"top";if(c.y>t.transform.height-p){if(_)return"bottom-left";if(v)return"bottom-right"}return _?"left":v?"right":"bottom"}_updateClassList(){const l=this._container;if(!l)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),l.className=t.join(" ")}_update(l){const t=this._map,n=this._content;if(!t||!this._lngLat&&!this._trackPointer||!n)return;let c=this._container;if(c||(c=this._container=ge("div","mapboxgl-popup",t.getContainer()),this._tip=ge("div","mapboxgl-popup-tip",c),c.appendChild(n)),this.options.maxWidth&&c.style.maxWidth!==this.options.maxWidth&&(c.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=ap(this._lngLat,this._pos,t.transform)),!this._trackPointer||l){const d=this._pos=this._trackPointer&&l instanceof o.P?l:t.project(this._lngLat,this._altitude),p=Zl(this.options.offset),_=this._anchor=this._getAnchor(p.y),v=Zl(this.options.offset,_),w=d.add(v).round();t._requestDomTask((()=>{this._container&&_&&(this._container.style.transform=`${eo[_]} translate(${w.x}px,${w.y}px)`)}))}if(!this._marker&&t._showingGlobe()){const d=o.f5(t.transform,this._lngLat)?0:1;this._setOpacity(d)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const l=this._container.querySelector(us);l&&l.focus()}_onClose(){this.remove()}_setOpacity(l){this._container&&(this._container.style.opacity=`${l}`),this._content&&(this._content.style.pointerEvents=l?"auto":"none")}},Marker:vd,Style:as,LngLat:o.aT,LngLatBounds:o.aI,Point:o.P,MercatorCoordinate:o.ae,FreeCameraOptions:ho,Evented:o.E,config:o.e,prewarm:o.f9,clearPrewarmedResources:o.f8,get accessToken(){return o.e.ACCESS_TOKEN},set accessToken(l){o.e.ACCESS_TOKEN=l},get baseApiUrl(){return o.e.API_URL},set baseApiUrl(l){o.e.API_URL=l},get workerCount(){return o.fi.workerCount},set workerCount(l){o.fi.workerCount=l},get maxParallelImageRequests(){return o.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(l){o.e.MAX_PARALLEL_IMAGE_REQUESTS=l},clearStorage(l){o.fh(l)},get workerUrl(){return o.fg.workerUrl},set workerUrl(l){o.fg.workerUrl=l},get workerClass(){return o.fg.workerClass},set workerClass(l){o.fg.workerClass=l},get workerParams(){return o.fg.workerParams},set workerParams(l){o.fg.workerParams=l},get dracoUrl(){return o.ff()},set dracoUrl(l){o.fe(l)},get meshoptUrl(){return o.fd()},set meshoptUrl(l){o.fc(l)},setNow:o.o.setNow,restoreNow:o.o.restoreNow}}));var k=M;return k}))})(Pg)),Pg.exports}var mM=pM();const nm=Ku(mM),LE="pk.eyJ1Ijoib2V0Ym9zdG9uIiwiYSI6ImNtbGExbzQ0MTA5MmkzZW4wZTR4OTh6YzUifQ.OfY3qzwoSTDPYmVJP_NlyA",wx="https://smart-curb-api-726931983438.us-east4.run.app",Jl=13,ix=250,Og=[-71.21060396634394,42.23174784259396,-70.7944899306811,42.55900946262469],RE=[{title:"Show available parking",open:!0,options:[{label:"Include spots requiring residential permits",id:"permitted",value:!1,type:"checkbox"},{label:"Include spots requiring payment",id:"paid",value:!1,type:"checkbox"}]},{title:"Highlight special zones",open:!0,options:[{label:"Accessible",id:"accessible",value:!1,type:"toggle"},{label:"Loading Zones",id:"loadingZone",value:!1,type:"toggle"}]}],Tx=[{label:"Sunday",value:"sun"},{label:"Monday",value:"mon"},{label:"Tuesday",value:"tue"},{label:"Wednesday",value:"wed"},{label:"Thursday",value:"thu"},{label:"Friday",value:"fri"},{label:"Saturday",value:"sat"}],DE=[{label:"12:00 AM",value:0},{label:"12:30 AM",value:.5},{label:"1:00 AM",value:1},{label:"1:30 AM",value:1.5},{label:"2:00 AM",value:2},{label:"2:30 AM",value:2.5},{label:"3:00 AM",value:3},{label:"3:30 AM",value:3.5},{label:"4:00 AM",value:4},{label:"4:30 AM",value:4.5},{label:"5:00 AM",value:5},{label:"5:30 AM",value:5.5},{label:"6:00 AM",value:6},{label:"6:30 AM",value:6.5},{label:"7:00 AM",value:7},{label:"7:30 AM",value:7.5},{label:"8:00 AM",value:8},{label:"8:30 AM",value:8.5},{label:"9:00 AM",value:9},{label:"9:30 AM",value:9.5},{label:"10:00 AM",value:10},{label:"10:30 AM",value:10.5},{label:"11:00 AM",value:11},{label:"11:30 AM",value:11.5},{label:"12:00 PM",value:12},{label:"12:30 PM",value:12.5},{label:"1:00 PM",value:13},{label:"1:30 PM",value:13.5},{label:"2:00 PM",value:14},{label:"2:30 PM",value:14.5},{label:"3:00 PM",value:15},{label:"3:30 PM",value:15.5},{label:"4:00 PM",value:16},{label:"4:30 PM",value:16.5},{label:"5:00 PM",value:17},{label:"5:30 PM",value:17.5},{label:"6:00 PM",value:18},{label:"6:30 PM",value:18.5},{label:"7:00 PM",value:19},{label:"7:30 PM",value:19.5},{label:"8:00 PM",value:20},{label:"8:30 PM",value:20.5},{label:"9:00 PM",value:21},{label:"9:30 PM",value:21.5},{label:"10:00 PM",value:22},{label:"10:30 PM",value:22.5},{label:"11:00 PM",value:23},{label:"11:30 PM",value:23.5},{label:"12:00 AM",value:24,hide:!0}],s0={curbZoneDasharray:[1,0],notAllowedCurbZoneDasharray:[.5,2],areaSelectionDasharray:[2,2]},Bc={curbZoneWidth:5,notAllowedCurbZoneWidth:3,selectedCurbZoneStroke:8,selectedCurbZoneWidth:4,curbZoneEmphasisOutline:12,curbZoneEmphasisWidth:8,areaSelectionOutline:2},hn={parkingAllowed:"#51ACFF",parkingAllowedPermitted:"#216CFF",parkingAllowedPaid:"#216CFF",parkingAllowedPermittedPaid:"#216CFF",parkingAllowedLight:"#99ceff",parkingAllowedPermittedLight:"#699eff",parkingAllowedPaidLight:"#699eff",parkingAllowedPermittedPaidLight:"#699eff",parkingNotAllowed:"#f58433",parkingNotAllowedLight:"#f9b685",loading:"#e22214",accessible:"#1871BD",loadingIconFill:"hsl(359, 95%, 75%)",loadingIconStroke:"hsl(0, 0%, 20%)",accessibleIconFill:"hsl(197, 71%, 73%)",accessibleIconStroke:"hsl(0, 0%, 20%)",highlightColor:"#FFEE00",hoverHighlightColor:"#FFEE00",highlightColorStroke:"#000000"},qd=m=>m.trim().replace(/^['"]+/,"").replace(/['"]+$/,""),OE=m=>{let y=m.map(b=>b.options).flat();return y=y.reduce((b,S)=>{const{value:M,id:R}=S;return b[R]=M,b},{}),y},_M=m=>({sun:"Sunday",mon:"Monday",tue:"Tuesday",wed:"Wednesday",thu:"Thursday",fri:"Friday",sat:"Saturday"})[m],gM=m=>{let y={sun:"Sunday",mon:"Monday",tue:"Tuesday",wed:"Wednesday",thu:"Thursday",fri:"Friday",sat:"Saturday"};return y=Object.fromEntries(Object.entries(y).map(([b,S])=>[S,b])),y[m]},zg=m=>{if(!m)return null;if(m==="23:59")return 24;const y=m.split(":").map(Number),b=y[1]==="30"?.5:0;return y[0]+b},yM=m=>{let y="";if(m===0)y="12:00 AM";else if(m===.5)y="12:30 AM";else{let b=`${m}`.split("."),S=`${Number(b[0])>12.5?Number(b[0])-12:b[0]}:${b[1]==="5"?"30":"00"}`;S=`${S} ${Number(b[0])>11.5?"PM":"AM"}`,y=S}return y};let Zt=ka({map:null,draw:null,isDrawing:!1,position:{center:[-71.05774,42.36453],zoom:12}}),gr=ka({radius:null,type:null,selected:null}),ko=ka({results:null}),Hd=ka({current:RE}),Oo=ka({id:null,geometry:null,properties:null,policies:null}),rn=ka({day:"mon",time:9,useCurrentTime:!0}),hm=ka({loading:!1});const fs={CANVAS:"mapboxgl-canvas",CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},na={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},Bn={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},ps={POLYGON:"polygon",LINE:"line_string",POINT:"point"},qi={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},Ur={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select"},es={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},_m={MOVE:"move",CHANGE_PROPERTIES:"change_properties",CHANGE_COORDINATES:"change_coordinates"},Bo={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},go={ACTIVE:"true",INACTIVE:"false"},zE=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],vM=-90,rx=-85,xM=90,nx=85,bM=-270,wM=270,kE=Object.freeze(Object.defineProperty({__proto__:null,LAT_MAX:xM,LAT_MIN:vM,LAT_RENDERED_MAX:nx,LAT_RENDERED_MIN:rx,LNG_MAX:wM,LNG_MIN:bM,activeStates:go,classes:fs,cursors:Bn,events:es,geojsonTypes:qi,interactions:zE,meta:Bo,modes:Ur,sources:na,types:ps,updateActions:_m},Symbol.toStringTag,{value:"Module"}));function Hg(m){return function(y){const b=y.featureTarget;return!b||!b.properties?!1:b.properties.meta===m}}function FE(m){return!m.originalEvent||!m.originalEvent.shiftKey?!1:m.originalEvent.button===0}function Qu(m){return!m.featureTarget||!m.featureTarget.properties?!1:m.featureTarget.properties.active===go.ACTIVE&&m.featureTarget.properties.meta===Bo.FEATURE}function Ex(m){return!m.featureTarget||!m.featureTarget.properties?!1:m.featureTarget.properties.active===go.INACTIVE&&m.featureTarget.properties.meta===Bo.FEATURE}function Zg(m){return m.featureTarget===void 0}function Sx(m){return!m.featureTarget||!m.featureTarget.properties?!1:m.featureTarget.properties.meta===Bo.FEATURE}function gm(m){const y=m.featureTarget;return!y||!y.properties?!1:y.properties.meta===Bo.VERTEX}function kg(m){return m.originalEvent?m.originalEvent.shiftKey===!0:!1}function $g(m){return m.key==="Escape"||m.keyCode===27}function Wg(m){return m.key==="Enter"||m.keyCode===13}function ox(m){return m.key==="Backspace"||m.keyCode===8}function sx(m){return m.key==="Delete"||m.keyCode===46}function BE(m){return m.key==="1"||m.keyCode===49}function NE(m){return m.key==="2"||m.keyCode===50}function VE(m){return m.key==="3"||m.keyCode===51}function UE(m){const y=m.key||String.fromCharCode(m.keyCode);return y>="0"&&y<="9"}function TM(){return!0}const EM=Object.freeze(Object.defineProperty({__proto__:null,isActiveFeature:Qu,isBackspaceKey:ox,isDeleteKey:sx,isDigit1Key:BE,isDigit2Key:NE,isDigit3Key:VE,isDigitKey:UE,isEnterKey:Wg,isEscapeKey:$g,isFeature:Sx,isInactiveFeature:Ex,isOfMetaType:Hg,isShiftDown:kg,isShiftMousedown:FE,isTrue:TM,isVertex:gm,noTarget:Zg},Symbol.toStringTag,{value:"Module"}));var yg={},Jp={},q2;function SM(){return q2||(q2=1,Jp.RADIUS=6378137,Jp.FLATTENING=1/298.257223563,Jp.POLAR_RADIUS=63567523142e-4),Jp}var H2;function IM(){if(H2)return yg;H2=1;var m=SM();yg.geometry=y,yg.ring=S;function y(R){var k=0,o;switch(R.type){case"Polygon":return b(R.coordinates);case"MultiPolygon":for(o=0;o<R.coordinates.length;o++)k+=b(R.coordinates[o]);return k;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(o=0;o<R.geometries.length;o++)k+=y(R.geometries[o]);return k}}function b(R){var k=0;if(R&&R.length>0){k+=Math.abs(S(R[0]));for(var o=1;o<R.length;o++)k-=Math.abs(S(R[o]))}return k}function S(R){var k,o,G,Z,ee,ie,re,ue=0,oe=R.length;if(oe>2){for(re=0;re<oe;re++)re===oe-2?(Z=oe-2,ee=oe-1,ie=0):re===oe-1?(Z=oe-1,ee=0,ie=1):(Z=re,ee=re+1,ie=re+2),k=R[Z],o=R[ee],G=R[ie],ue+=(M(G[0])-M(k[0]))*Math.sin(M(o[1]));ue=ue*m.RADIUS*m.RADIUS/2}return ue}function M(R){return R*Math.PI/180}return yg}var AM=IM();const CM=Ku(AM),Z2={Point:0,LineString:1,MultiLineString:1,Polygon:2};function MM(m,y){const b=Z2[m.geometry.type]-Z2[y.geometry.type];return b===0&&m.geometry.type===qi.POLYGON?m.area-y.area:b}function jE(m){return m.map(y=>(y.geometry.type===qi.POLYGON&&(y.area=CM.geometry({type:qi.FEATURE,property:{},geometry:y.geometry})),y)).sort(MM).map(y=>(delete y.area,y))}function GE(m,y=0){return[[m.point.x-y,m.point.y-y],[m.point.x+y,m.point.y+y]]}function aa(m){if(this._items={},this._nums={},this._length=m?m.length:0,!!m)for(let y=0,b=m.length;y<b;y++)this.add(m[y]),m[y]!==void 0&&(typeof m[y]=="string"?this._items[m[y]]=y:this._nums[m[y]]=y)}aa.prototype.add=function(m){return this.has(m)?this:(this._length++,typeof m=="string"?this._items[m]=this._length:this._nums[m]=this._length,this)};aa.prototype.delete=function(m){return this.has(m)===!1?this:(this._length--,delete this._items[m],delete this._nums[m],this)};aa.prototype.has=function(m){return typeof m!="string"&&typeof m!="number"?!1:this._items[m]!==void 0||this._nums[m]!==void 0};aa.prototype.values=function(){const m=[];return Object.keys(this._items).forEach(y=>{m.push({k:y,v:this._items[y]})}),Object.keys(this._nums).forEach(y=>{m.push({k:JSON.parse(y),v:this._nums[y]})}),m.sort((y,b)=>y.v-b.v).map(y=>y.k)};aa.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};const PM=[Bo.FEATURE,Bo.MIDPOINT,Bo.VERTEX],Xd={click:LM,touch:RM};function LM(m,y,b){return qE(m,y,b,b.options.clickBuffer)}function RM(m,y,b){return qE(m,y,b,b.options.touchBuffer)}function qE(m,y,b,S){if(b.map===null)return[];const M=m?GE(m,S):y,R={};b.options.styles&&(R.layers=b.options.styles.map(Z=>Z.id).filter(Z=>b.map.getLayer(Z)!=null));const k=b.map.queryRenderedFeatures(M,R).filter(Z=>PM.indexOf(Z.properties.meta)!==-1),o=new aa,G=[];return k.forEach(Z=>{const ee=Z.properties.id;o.has(ee)||(o.add(ee),G.push(Z))}),jE(G)}function Lg(m,y){const b=Xd.click(m,null,y),S={mouse:Bn.NONE};return b[0]&&(S.mouse=b[0].properties.active===go.ACTIVE?Bn.MOVE:Bn.POINTER,S.feature=b[0].properties.meta),y.events.currentModeName().indexOf("draw")!==-1&&(S.mouse=Bn.ADD),y.ui.queueMapClasses(S),y.ui.updateMapClasses(),b[0]}function Ix(m,y){const b=m.x-y.x,S=m.y-y.y;return Math.sqrt(b*b+S*S)}const DM=4,OM=12,zM=500;function ax(m,y,b={}){const S=b.fineTolerance!=null?b.fineTolerance:DM,M=b.grossTolerance!=null?b.grossTolerance:OM,R=b.interval!=null?b.interval:zM;m.point=m.point||y.point,m.time=m.time||y.time;const k=Ix(m.point,y.point);return k<S||k<M&&y.time-m.time<R}const kM=25,FM=250;function lx(m,y,b={}){const S=b.tolerance!=null?b.tolerance:kM,M=b.interval!=null?b.interval:FM;return m.point=m.point||y.point,m.time=m.time||y.time,Ix(m.point,y.point)<S&&y.time-m.time<M}const cx=function(m,y){const b={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},S={on(R,k,o){if(b[R]===void 0)throw new Error(`Invalid event type: ${R}`);b[R].push({selector:k,fn:o})},render(R){y.store.featureChanged(R)}},M=function(R,k){const o=b[R];let G=o.length;for(;G--;){const Z=o[G];if(Z.selector(k)){Z.fn.call(S,k)||y.store.render(),y.ui.updateMapClasses();break}}};return m.start.call(S),{render:m.render,stop(){m.stop&&m.stop()},trash(){m.trash&&(m.trash(),y.store.render())},combineFeatures(){m.combineFeatures&&m.combineFeatures()},uncombineFeatures(){m.uncombineFeatures&&m.uncombineFeatures()},drag(R){M("drag",R)},click(R){M("click",R)},mousemove(R){M("mousemove",R)},mousedown(R){M("mousedown",R)},mouseup(R){M("mouseup",R)},mouseout(R){M("mouseout",R)},keydown(R){M("keydown",R)},keyup(R){M("keyup",R)},touchstart(R){M("touchstart",R)},touchmove(R){M("touchmove",R)},touchend(R){M("touchend",R)},tap(R){M("tap",R)}}};let BM=(m,y=21)=>(b=y)=>{let S="",M=b|0;for(;M--;)S+=m[Math.random()*m.length|0];return S};const NM=BM("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",32);function Ax(){return NM()}const ts=function(m,y){this.ctx=m,this.properties=y.properties||{},this.coordinates=y.geometry.coordinates,this.id=y.id||Ax(),this.type=y.geometry.type};ts.prototype.changed=function(){this.ctx.store.featureChanged(this.id)};ts.prototype.incomingCoords=function(m){this.setCoordinates(m)};ts.prototype.setCoordinates=function(m){this.coordinates=m,this.changed()};ts.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))};ts.prototype.setProperty=function(m,y){this.properties[m]=y};ts.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:qi.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))};ts.prototype.internal=function(m){const y={id:this.id,meta:Bo.FEATURE,"meta:type":this.type,active:go.INACTIVE,mode:m};if(this.ctx.options.userProperties)for(const b in this.properties)y[`user_${b}`]=this.properties[b];return{type:qi.FEATURE,properties:y,geometry:{coordinates:this.getCoordinates(),type:this.type}}};const Wc=function(m,y){ts.call(this,m,y)};Wc.prototype=Object.create(ts.prototype);Wc.prototype.isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"};Wc.prototype.updateCoordinate=function(m,y,b){arguments.length===3?this.coordinates=[y,b]:this.coordinates=[m,y],this.changed()};Wc.prototype.getCoordinate=function(){return this.getCoordinates()};const _l=function(m,y){ts.call(this,m,y)};_l.prototype=Object.create(ts.prototype);_l.prototype.isValid=function(){return this.coordinates.length>1};_l.prototype.addCoordinate=function(m,y,b){this.changed();const S=parseInt(m,10);this.coordinates.splice(S,0,[y,b])};_l.prototype.getCoordinate=function(m){const y=parseInt(m,10);return JSON.parse(JSON.stringify(this.coordinates[y]))};_l.prototype.removeCoordinate=function(m){this.changed(),this.coordinates.splice(parseInt(m,10),1)};_l.prototype.updateCoordinate=function(m,y,b){const S=parseInt(m,10);this.coordinates[S]=[y,b],this.changed()};const Bs=function(m,y){ts.call(this,m,y),this.coordinates=this.coordinates.map(b=>b.slice(0,-1))};Bs.prototype=Object.create(ts.prototype);Bs.prototype.isValid=function(){return this.coordinates.length===0?!1:this.coordinates.every(m=>m.length>2)};Bs.prototype.incomingCoords=function(m){this.coordinates=m.map(y=>y.slice(0,-1)),this.changed()};Bs.prototype.setCoordinates=function(m){this.coordinates=m,this.changed()};Bs.prototype.addCoordinate=function(m,y,b){this.changed();const S=m.split(".").map(R=>parseInt(R,10));this.coordinates[S[0]].splice(S[1],0,[y,b])};Bs.prototype.removeCoordinate=function(m){this.changed();const y=m.split(".").map(S=>parseInt(S,10)),b=this.coordinates[y[0]];b&&(b.splice(y[1],1),b.length<3&&this.coordinates.splice(y[0],1))};Bs.prototype.getCoordinate=function(m){const y=m.split(".").map(S=>parseInt(S,10)),b=this.coordinates[y[0]];return JSON.parse(JSON.stringify(b[y[1]]))};Bs.prototype.getCoordinates=function(){return this.coordinates.map(m=>m.concat([m[0]]))};Bs.prototype.updateCoordinate=function(m,y,b){this.changed();const S=m.split("."),M=parseInt(S[0],10),R=parseInt(S[1],10);this.coordinates[M]===void 0&&(this.coordinates[M]=[]),this.coordinates[M][R]=[y,b]};const VM={MultiPoint:Wc,MultiLineString:_l,MultiPolygon:Bs},Xg=(m,y,b,S,M)=>{const R=b.split("."),k=parseInt(R[0],10),o=R[1]?R.slice(1).join("."):null;return m[k][y](o,S,M)},Ko=function(m,y){if(ts.call(this,m,y),delete this.coordinates,this.model=VM[y.geometry.type],this.model===void 0)throw new TypeError(`${y.geometry.type} is not a valid type`);this.features=this._coordinatesToFeatures(y.geometry.coordinates)};Ko.prototype=Object.create(ts.prototype);Ko.prototype._coordinatesToFeatures=function(m){const y=this.model.bind(this);return m.map(b=>new y(this.ctx,{id:Ax(),type:qi.FEATURE,properties:{},geometry:{coordinates:b,type:this.type.replace("Multi","")}}))};Ko.prototype.isValid=function(){return this.features.every(m=>m.isValid())};Ko.prototype.setCoordinates=function(m){this.features=this._coordinatesToFeatures(m),this.changed()};Ko.prototype.getCoordinate=function(m){return Xg(this.features,"getCoordinate",m)};Ko.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(m=>m.type===qi.POLYGON?m.getCoordinates():m.coordinates)))};Ko.prototype.updateCoordinate=function(m,y,b){Xg(this.features,"updateCoordinate",m,y,b),this.changed()};Ko.prototype.addCoordinate=function(m,y,b){Xg(this.features,"addCoordinate",m,y,b),this.changed()};Ko.prototype.removeCoordinate=function(m){Xg(this.features,"removeCoordinate",m),this.changed()};Ko.prototype.getFeatures=function(){return this.features};function Pr(m){this.map=m.map,this.drawConfig=JSON.parse(JSON.stringify(m.options||{})),this._ctx=m}Pr.prototype.setSelected=function(m){return this._ctx.store.setSelected(m)};Pr.prototype.setSelectedCoordinates=function(m){this._ctx.store.setSelectedCoordinates(m),m.reduce((y,b)=>(y[b.feature_id]===void 0&&(y[b.feature_id]=!0,this._ctx.store.get(b.feature_id).changed()),y),{})};Pr.prototype.getSelected=function(){return this._ctx.store.getSelected()};Pr.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()};Pr.prototype.isSelected=function(m){return this._ctx.store.isSelected(m)};Pr.prototype.getFeature=function(m){return this._ctx.store.get(m)};Pr.prototype.select=function(m){return this._ctx.store.select(m)};Pr.prototype.deselect=function(m){return this._ctx.store.deselect(m)};Pr.prototype.deleteFeature=function(m,y={}){return this._ctx.store.delete(m,y)};Pr.prototype.addFeature=function(m,y={}){return this._ctx.store.add(m,y)};Pr.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()};Pr.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()};Pr.prototype.setActionableState=function(m={}){const y={trash:m.trash||!1,combineFeatures:m.combineFeatures||!1,uncombineFeatures:m.uncombineFeatures||!1};return this._ctx.events.actionable(y)};Pr.prototype.changeMode=function(m,y={},b={}){return this._ctx.events.changeMode(m,y,b)};Pr.prototype.fire=function(m,y){return this._ctx.events.fire(m,y)};Pr.prototype.updateUIClasses=function(m){return this._ctx.ui.queueMapClasses(m)};Pr.prototype.activateUIButton=function(m){return this._ctx.ui.setActiveButton(m)};Pr.prototype.featuresAt=function(m,y,b="click"){if(b!=="click"&&b!=="touch")throw new Error("invalid buffer type");return Xd[b](m,y,this._ctx)};Pr.prototype.newFeature=function(m){const y=m.geometry.type;return y===qi.POINT?new Wc(this._ctx,m):y===qi.LINE_STRING?new _l(this._ctx,m):y===qi.POLYGON?new Bs(this._ctx,m):new Ko(this._ctx,m)};Pr.prototype.isInstanceOf=function(m,y){if(m===qi.POINT)return y instanceof Wc;if(m===qi.LINE_STRING)return y instanceof _l;if(m===qi.POLYGON)return y instanceof Bs;if(m==="MultiFeature")return y instanceof Ko;throw new Error(`Unknown feature class: ${m}`)};Pr.prototype.doRender=function(m){return this._ctx.store.featureChanged(m)};Pr.prototype.onSetup=function(){};Pr.prototype.onDrag=function(){};Pr.prototype.onClick=function(){};Pr.prototype.onMouseMove=function(){};Pr.prototype.onMouseDown=function(){};Pr.prototype.onMouseUp=function(){};Pr.prototype.onMouseOut=function(){};Pr.prototype.onKeyUp=function(){};Pr.prototype.onKeyDown=function(){};Pr.prototype.onTouchStart=function(){};Pr.prototype.onTouchMove=function(){};Pr.prototype.onTouchEnd=function(){};Pr.prototype.onTap=function(){};Pr.prototype.onStop=function(){};Pr.prototype.onTrash=function(){};Pr.prototype.onCombineFeature=function(){};Pr.prototype.onUncombineFeature=function(){};Pr.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};const HE={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},UM=Object.keys(HE);function jM(m){const y=Object.keys(m);return function(b,S={}){let M={};const R=y.reduce((o,G)=>(o[G]=m[G],o),new Pr(b));function k(o){return G=>R[o](M,G)}return{start(){M=R.onSetup(S),UM.forEach(o=>{const G=HE[o];let Z=()=>!1;m[G]&&(Z=()=>!0),this.on(o,Z,k(G))})},stop(){R.onStop(M)},trash(){R.onTrash(M)},combineFeatures(){R.onCombineFeatures(M)},uncombineFeatures(){R.onUncombineFeatures(M)},render(o,G){R.toDisplayFeatures(M,o,G)}}}}function GM(m){const y=Object.keys(m.options.modes).reduce((re,ue)=>(re[ue]=jM(m.options.modes[ue]),re),{});let b={},S={};const M={};let R=null,k=null;M.drag=function(re,ue){ue({point:re.point,time:new Date().getTime()})?(m.ui.queueMapClasses({mouse:Bn.DRAG}),k.drag(re)):re.originalEvent.stopPropagation()},M.mousedrag=function(re){M.drag(re,ue=>!ax(b,ue))},M.touchdrag=function(re){M.drag(re,ue=>!lx(S,ue))},M.mousemove=function(re){if((re.originalEvent.buttons!==void 0?re.originalEvent.buttons:re.originalEvent.which)===1)return M.mousedrag(re);const oe=Lg(re,m);re.featureTarget=oe,k.mousemove(re)},M.mousedown=function(re){b={time:new Date().getTime(),point:re.point};const ue=Lg(re,m);re.featureTarget=ue,k.mousedown(re)},M.mouseup=function(re){const ue=Lg(re,m);re.featureTarget=ue,ax(b,{point:re.point,time:new Date().getTime()})?k.click(re):k.mouseup(re)},M.mouseout=function(re){k.mouseout(re)},M.touchstart=function(re){if(!m.options.touchEnabled)return;S={time:new Date().getTime(),point:re.point};const ue=Xd.touch(re,null,m)[0];re.featureTarget=ue,k.touchstart(re)},M.touchmove=function(re){if(m.options.touchEnabled)return k.touchmove(re),M.touchdrag(re)},M.touchend=function(re){if(re.originalEvent.preventDefault(),!m.options.touchEnabled)return;const ue=Xd.touch(re,null,m)[0];re.featureTarget=ue,lx(S,{time:new Date().getTime(),point:re.point})?k.tap(re):k.touchend(re)};const o=re=>{const ue=ox(re),oe=sx(re),ge=UE(re);return!(ue||oe||ge)};M.keydown=function(re){(re.srcElement||re.target).classList.contains(fs.CANVAS)&&((ox(re)||sx(re))&&m.options.controls.trash?(re.preventDefault(),k.trash()):o(re)?k.keydown(re):BE(re)&&m.options.controls.point?G(Ur.DRAW_POINT):NE(re)&&m.options.controls.line_string?G(Ur.DRAW_LINE_STRING):VE(re)&&m.options.controls.polygon&&G(Ur.DRAW_POLYGON))},M.keyup=function(re){o(re)&&k.keyup(re)},M.zoomend=function(){m.store.changeZoom()},M.data=function(re){if(re.dataType==="style"){const{setup:ue,map:oe,options:ge,store:K}=m;ge.styles.some(Le=>oe.getLayer(Le.id))||(ue.addLayers(),K.setDirty(),K.render())}};function G(re,ue,oe={}){k.stop();const ge=y[re];if(ge===void 0)throw new Error(`${re} is not valid`);R=re;const K=ge(m,ue);k=cx(K,m),oe.silent||m.map.fire(es.MODE_CHANGE,{mode:re}),m.store.setDirty(),m.store.render()}const Z={trash:!1,combineFeatures:!1,uncombineFeatures:!1};function ee(re){let ue=!1;Object.keys(re).forEach(oe=>{if(Z[oe]===void 0)throw new Error("Invalid action type");Z[oe]!==re[oe]&&(ue=!0),Z[oe]=re[oe]}),ue&&m.map.fire(es.ACTIONABLE,{actions:Z})}return{start(){R=m.options.defaultMode,k=cx(y[R](m),m)},changeMode:G,actionable:ee,currentModeName(){return R},currentModeRender(re,ue){return k.render(re,ue)},fire(re,ue){m.map&&m.map.fire(re,ue)},addEventListeners(){m.map.on("mousemove",M.mousemove),m.map.on("mousedown",M.mousedown),m.map.on("mouseup",M.mouseup),m.map.on("data",M.data),m.map.on("touchmove",M.touchmove),m.map.on("touchstart",M.touchstart),m.map.on("touchend",M.touchend),m.container.addEventListener("mouseout",M.mouseout),m.options.keybindings&&(m.container.addEventListener("keydown",M.keydown),m.container.addEventListener("keyup",M.keyup))},removeEventListeners(){m.map.off("mousemove",M.mousemove),m.map.off("mousedown",M.mousedown),m.map.off("mouseup",M.mouseup),m.map.off("data",M.data),m.map.off("touchmove",M.touchmove),m.map.off("touchstart",M.touchstart),m.map.off("touchend",M.touchend),m.container.removeEventListener("mouseout",M.mouseout),m.options.keybindings&&(m.container.removeEventListener("keydown",M.keydown),m.container.removeEventListener("keyup",M.keyup))},trash(re){k.trash(re)},combineFeatures(){k.combineFeatures()},uncombineFeatures(){k.uncombineFeatures()},getMode(){return R}}}function ym(m){return[].concat(m).filter(y=>y!==void 0)}function qM(){const m=this;if(!(m.ctx.map&&m.ctx.map.getSource(na.HOT)!==void 0))return G();const b=m.ctx.events.currentModeName();m.ctx.ui.queueMapClasses({mode:b});let S=[],M=[];m.isDirty?M=m.getAllIds():(S=m.getChangedIds().filter(Z=>m.get(Z)!==void 0),M=m.sources.hot.filter(Z=>Z.properties.id&&S.indexOf(Z.properties.id)===-1&&m.get(Z.properties.id)!==void 0).map(Z=>Z.properties.id)),m.sources.hot=[];const R=m.sources.cold.length;m.sources.cold=m.isDirty?[]:m.sources.cold.filter(Z=>{const ee=Z.properties.id||Z.properties.parent;return S.indexOf(ee)===-1});const k=R!==m.sources.cold.length||M.length>0;S.forEach(Z=>o(Z,"hot")),M.forEach(Z=>o(Z,"cold"));function o(Z,ee){const re=m.get(Z).internal(b);m.ctx.events.currentModeRender(re,ue=>{ue.properties.mode=b,m.sources[ee].push(ue)})}k&&m.ctx.map.getSource(na.COLD).setData({type:qi.FEATURE_COLLECTION,features:m.sources.cold}),m.ctx.map.getSource(na.HOT).setData({type:qi.FEATURE_COLLECTION,features:m.sources.hot}),G();function G(){m.isDirty=!1,m.clearChangedIds()}}function In(m){this._features={},this._featureIds=new aa,this._selectedFeatureIds=new aa,this._selectedCoordinates=[],this._changedFeatureIds=new aa,this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=m,this.sources={hot:[],cold:[]};let y;this.render=()=>{y||(y=requestAnimationFrame(()=>{y=null,qM.call(this),this._emitSelectionChange&&(this.ctx.events.fire(es.SELECTION_CHANGE,{features:this.getSelected().map(b=>b.toGeoJSON()),points:this.getSelectedCoordinates().map(b=>({type:qi.FEATURE,properties:{},geometry:{type:qi.POINT,coordinates:b.coordinates}}))}),this._emitSelectionChange=!1),this.ctx.events.fire(es.RENDER,{})}))},this.isDirty=!1}In.prototype.createRenderBatch=function(){const m=this.render;let y=0;return this.render=function(){y++},()=>{this.render=m,y>0&&this.render()}};In.prototype.setDirty=function(){return this.isDirty=!0,this};In.prototype.featureCreated=function(m,y={}){if(this._changedFeatureIds.add(m),(y.silent!=null?y.silent:this.ctx.options.suppressAPIEvents)!==!0){const S=this.get(m);this.ctx.events.fire(es.CREATE,{features:[S.toGeoJSON()]})}return this};In.prototype.featureChanged=function(m,y={}){return this._changedFeatureIds.add(m),(y.silent!=null?y.silent:this.ctx.options.suppressAPIEvents)!==!0&&this.ctx.events.fire(es.UPDATE,{action:y.action?y.action:_m.CHANGE_COORDINATES,features:[this.get(m).toGeoJSON()]}),this};In.prototype.getChangedIds=function(){return this._changedFeatureIds.values()};In.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this};In.prototype.getAllIds=function(){return this._featureIds.values()};In.prototype.add=function(m,y={}){return this._features[m.id]=m,this._featureIds.add(m.id),this.featureCreated(m.id,{silent:y.silent}),this};In.prototype.delete=function(m,y={}){const b=[];return ym(m).forEach(S=>{this._featureIds.has(S)&&(this._featureIds.delete(S),this._selectedFeatureIds.delete(S),y.silent||b.indexOf(this._features[S])===-1&&b.push(this._features[S].toGeoJSON()),delete this._features[S],this.isDirty=!0)}),b.length&&this.ctx.events.fire(es.DELETE,{features:b}),ZE(this,y),this};In.prototype.get=function(m){return this._features[m]};In.prototype.getAll=function(){return Object.keys(this._features).map(m=>this._features[m])};In.prototype.select=function(m,y={}){return ym(m).forEach(b=>{this._selectedFeatureIds.has(b)||(this._selectedFeatureIds.add(b),this._changedFeatureIds.add(b),y.silent||(this._emitSelectionChange=!0))}),this};In.prototype.deselect=function(m,y={}){return ym(m).forEach(b=>{this._selectedFeatureIds.has(b)&&(this._selectedFeatureIds.delete(b),this._changedFeatureIds.add(b),y.silent||(this._emitSelectionChange=!0))}),ZE(this,y),this};In.prototype.clearSelected=function(m={}){return this.deselect(this._selectedFeatureIds.values(),{silent:m.silent}),this};In.prototype.setSelected=function(m,y={}){return m=ym(m),this.deselect(this._selectedFeatureIds.values().filter(b=>m.indexOf(b)===-1),{silent:y.silent}),this.select(m.filter(b=>!this._selectedFeatureIds.has(b)),{silent:y.silent}),this};In.prototype.setSelectedCoordinates=function(m){return this._selectedCoordinates=m,this._emitSelectionChange=!0,this};In.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this};In.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()};In.prototype.getSelected=function(){return this.getSelectedIds().map(m=>this.get(m))};In.prototype.getSelectedCoordinates=function(){return this._selectedCoordinates.map(y=>({coordinates:this.get(y.feature_id).getCoordinate(y.coord_path)}))};In.prototype.isSelected=function(m){return this._selectedFeatureIds.has(m)};In.prototype.setFeatureProperty=function(m,y,b,S={}){this.get(m).setProperty(y,b),this.featureChanged(m,{silent:S.silent,action:_m.CHANGE_PROPERTIES})};function ZE(m,y={}){const b=m._selectedCoordinates.filter(S=>m._selectedFeatureIds.has(S.feature_id));m._selectedCoordinates.length!==b.length&&!y.silent&&(m._emitSelectionChange=!0),m._selectedCoordinates=b}In.prototype.storeMapConfig=function(){zE.forEach(m=>{this.ctx.map[m]&&(this._mapInitialConfig[m]=this.ctx.map[m].isEnabled())})};In.prototype.restoreMapConfig=function(){Object.keys(this._mapInitialConfig).forEach(m=>{this._mapInitialConfig[m]?this.ctx.map[m].enable():this.ctx.map[m].disable()})};In.prototype.getInitialConfigValue=function(m){return this._mapInitialConfig[m]!==void 0?this._mapInitialConfig[m]:!0};const HM=["mode","feature","mouse"];function ZM(m){const y={};let b=null,S={mode:null,feature:null,mouse:null},M={mode:null,feature:null,mouse:null};function R(){k({mode:null,feature:null,mouse:null}),o()}function k(ue){M=Object.assign(M,ue)}function o(){if(!m.container)return;const ue=[],oe=[];HM.forEach(ge=>{M[ge]!==S[ge]&&(ue.push(`${ge}-${S[ge]}`),M[ge]!==null&&oe.push(`${ge}-${M[ge]}`))}),ue.length>0&&m.container.classList.remove(...ue),oe.length>0&&m.container.classList.add(...oe),S=Object.assign(S,M)}function G(ue,oe={}){const ge=document.createElement("button");return ge.className=`${fs.CONTROL_BUTTON} ${oe.className}`,ge.setAttribute("title",oe.title),oe.container.appendChild(ge),ge.addEventListener("click",K=>{if(K.preventDefault(),K.stopPropagation(),K.target===b){Z(),oe.onDeactivate();return}ee(ue),oe.onActivate()},!0),ge}function Z(){b&&(b.classList.remove(fs.ACTIVE_BUTTON),b=null)}function ee(ue){Z();const oe=y[ue];oe&&oe&&ue!=="trash"&&(oe.classList.add(fs.ACTIVE_BUTTON),b=oe)}function ie(){const ue=m.options.controls,oe=document.createElement("div");return oe.className=`${fs.CONTROL_GROUP} ${fs.CONTROL_BASE}`,ue&&(ue[ps.POINT]&&(y[ps.POINT]=G(ps.POINT,{container:oe,className:fs.CONTROL_BUTTON_POINT,title:`Marker tool ${m.options.keybindings?"(1)":""}`,onActivate:()=>m.events.changeMode(Ur.DRAW_POINT),onDeactivate:()=>m.events.trash()})),ue[ps.LINE]&&(y[ps.LINE]=G(ps.LINE,{container:oe,className:fs.CONTROL_BUTTON_LINE,title:`LineString tool ${m.options.keybindings?"(2)":""}`,onActivate:()=>m.events.changeMode(Ur.DRAW_LINE_STRING),onDeactivate:()=>m.events.trash()})),ue[ps.POLYGON]&&(y[ps.POLYGON]=G(ps.POLYGON,{container:oe,className:fs.CONTROL_BUTTON_POLYGON,title:`Polygon tool ${m.options.keybindings?"(3)":""}`,onActivate:()=>m.events.changeMode(Ur.DRAW_POLYGON),onDeactivate:()=>m.events.trash()})),ue.trash&&(y.trash=G("trash",{container:oe,className:fs.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:()=>{m.events.trash()}})),ue.combine_features&&(y.combine_features=G("combineFeatures",{container:oe,className:fs.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:()=>{m.events.combineFeatures()}})),ue.uncombine_features&&(y.uncombine_features=G("uncombineFeatures",{container:oe,className:fs.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:()=>{m.events.uncombineFeatures()}}))),oe}function re(){Object.keys(y).forEach(ue=>{const oe=y[ue];oe.parentNode&&oe.parentNode.removeChild(oe),delete y[ue]})}return{setActiveButton:ee,queueMapClasses:k,updateMapClasses:o,clearMapClasses:R,addButtons:ie,removeButtons:re}}function $M(m){let y=null,b=null;const S={onRemove(){return m.map.off("load",S.connect),clearInterval(b),S.removeLayers(),m.store.restoreMapConfig(),m.ui.removeButtons(),m.events.removeEventListeners(),m.ui.clearMapClasses(),m.boxZoomInitial&&m.map.boxZoom.enable(),m.map=null,m.container=null,m.store=null,y&&y.parentNode&&y.parentNode.removeChild(y),y=null,this},connect(){m.map.off("load",S.connect),clearInterval(b),S.addLayers(),m.store.storeMapConfig(),m.events.addEventListeners()},onAdd(M){if(m.map=M,m.events=GM(m),m.ui=ZM(m),m.container=M.getContainer(),m.store=new In(m),y=m.ui.addButtons(),m.options.boxSelect){m.boxZoomInitial=M.boxZoom.isEnabled(),M.boxZoom.disable();const R=M.dragPan.isEnabled();M.dragPan.disable(),M.dragPan.enable(),R||M.dragPan.disable()}return M.loaded()?S.connect():(M.on("load",S.connect),b=setInterval(()=>{M.loaded()&&S.connect()},16)),m.events.start(),y},addLayers(){m.map.addSource(na.COLD,{data:{type:qi.FEATURE_COLLECTION,features:[]},type:"geojson"}),m.map.addSource(na.HOT,{data:{type:qi.FEATURE_COLLECTION,features:[]},type:"geojson"}),m.options.styles.forEach(M=>{m.map.addLayer(M)}),m.store.setDirty(!0),m.store.render()},removeLayers(){m.options.styles.forEach(M=>{m.map.getLayer(M.id)&&m.map.removeLayer(M.id)}),m.map.getSource(na.COLD)&&m.map.removeSource(na.COLD),m.map.getSource(na.HOT)&&m.map.removeSource(na.HOT)}};return m.setup=S,S}const a0="#3bb2d0",Kp="#fbb03b",$2="#fff",$E=[{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"]],paint:{"fill-color":["case",["==",["get","active"],"true"],Kp,a0],"fill-opacity":.1}},{id:"gl-draw-lines",type:"line",filter:["any",["==","$type","LineString"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":["case",["==",["get","active"],"true"],Kp,a0],"line-dasharray":["case",["==",["get","active"],"true"],[.2,2],[2,0]],"line-width":2}},{id:"gl-draw-point-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":$2}},{id:"gl-draw-point-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":["case",["==",["get","active"],"true"],Kp,a0]}},{id:"gl-draw-vertex-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":$2}},{id:"gl-draw-vertex-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":Kp}},{id:"gl-draw-midpoint",type:"circle",filter:["all",["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":Kp}}];function Vc(m,y){this.x=m,this.y=y}Vc.prototype={clone(){return new Vc(this.x,this.y)},add(m){return this.clone()._add(m)},sub(m){return this.clone()._sub(m)},multByPoint(m){return this.clone()._multByPoint(m)},divByPoint(m){return this.clone()._divByPoint(m)},mult(m){return this.clone()._mult(m)},div(m){return this.clone()._div(m)},rotate(m){return this.clone()._rotate(m)},rotateAround(m,y){return this.clone()._rotateAround(m,y)},matMult(m){return this.clone()._matMult(m)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(m){return this.x===m.x&&this.y===m.y},dist(m){return Math.sqrt(this.distSqr(m))},distSqr(m){const y=m.x-this.x,b=m.y-this.y;return y*y+b*b},angle(){return Math.atan2(this.y,this.x)},angleTo(m){return Math.atan2(this.y-m.y,this.x-m.x)},angleWith(m){return this.angleWithSep(m.x,m.y)},angleWithSep(m,y){return Math.atan2(this.x*y-this.y*m,this.x*m+this.y*y)},_matMult(m){const y=m[0]*this.x+m[1]*this.y,b=m[2]*this.x+m[3]*this.y;return this.x=y,this.y=b,this},_add(m){return this.x+=m.x,this.y+=m.y,this},_sub(m){return this.x-=m.x,this.y-=m.y,this},_mult(m){return this.x*=m,this.y*=m,this},_div(m){return this.x/=m,this.y/=m,this},_multByPoint(m){return this.x*=m.x,this.y*=m.y,this},_divByPoint(m){return this.x/=m.x,this.y/=m.y,this},_unit(){return this._div(this.mag()),this},_perp(){const m=this.y;return this.y=this.x,this.x=-m,this},_rotate(m){const y=Math.cos(m),b=Math.sin(m),S=y*this.x-b*this.y,M=b*this.x+y*this.y;return this.x=S,this.y=M,this},_rotateAround(m,y){const b=Math.cos(m),S=Math.sin(m),M=y.x+b*(this.x-y.x)-S*(this.y-y.y),R=y.y+S*(this.x-y.x)+b*(this.y-y.y);return this.x=M,this.y=R,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Vc};Vc.convert=function(m){if(m instanceof Vc)return m;if(Array.isArray(m))return new Vc(+m[0],+m[1]);if(m.x!==void 0&&m.y!==void 0)return new Vc(+m.x,+m.y);throw new Error("Expected [x, y] or {x, y} point format")};function Cx(m,y){const b=y.getBoundingClientRect();return new Vc(m.clientX-b.left-(y.clientLeft||0),m.clientY-b.top-(y.clientTop||0))}function Yd(m,y,b,S){return{type:qi.FEATURE,properties:{meta:Bo.VERTEX,parent:m,coord_path:b,active:S?go.ACTIVE:go.INACTIVE},geometry:{type:qi.POINT,coordinates:y}}}var Ls=63710088e-1,WE={centimeters:Ls*100,centimetres:Ls*100,degrees:360/(2*Math.PI),feet:Ls*3.28084,inches:Ls*39.37,kilometers:Ls/1e3,kilometres:Ls/1e3,meters:Ls,metres:Ls,miles:Ls/1609.344,millimeters:Ls*1e3,millimetres:Ls*1e3,nauticalmiles:Ls/1852,radians:1,yards:Ls*1.0936};function fl(m,y,b={}){const S={type:"Feature"};return(b.id===0||b.id)&&(S.id=b.id),b.bbox&&(S.bbox=b.bbox),S.properties=y||{},S.geometry=m,S}function Jo(m,y,b={}){if(!m)throw new Error("coordinates is required");if(!Array.isArray(m))throw new Error("coordinates must be an Array");if(m.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!ux(m[0])||!ux(m[1]))throw new Error("coordinates must contain numbers");return fl({type:"Point",coordinates:m},y,b)}function XE(m,y,b={}){for(const M of m){if(M.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(M[M.length-1].length!==M[0].length)throw new Error("First and last Position are not equivalent.");for(let R=0;R<M[M.length-1].length;R++)if(M[M.length-1][R]!==M[0][R])throw new Error("First and last Position are not equivalent.")}return fl({type:"Polygon",coordinates:m},y,b)}function dm(m,y,b={}){if(m.length<2)throw new Error("coordinates must be an array of two or more positions");return fl({type:"LineString",coordinates:m},y,b)}function No(m,y={}){const b={type:"FeatureCollection"};return y.id&&(b.id=y.id),y.bbox&&(b.bbox=y.bbox),b.features=m,b}function WM(m,y="kilometers"){const b=WE[y];if(!b)throw new Error(y+" units is invalid");return m*b}function XM(m,y="kilometers"){const b=WE[y];if(!b)throw new Error(y+" units is invalid");return m/b}function fm(m){return m%(2*Math.PI)*180/Math.PI}function Ds(m){return m%360*Math.PI/180}function ux(m){return!isNaN(m)&&m!==null&&!Array.isArray(m)}function YM(m){return m!==null&&typeof m=="object"&&!Array.isArray(m)}function qc(m,y,b){if(m!==null)for(var S,M,R,k,o,G,Z,ee=0,ie=0,re,ue=m.type,oe=ue==="FeatureCollection",ge=ue==="Feature",K=oe?m.features.length:1,Te=0;Te<K;Te++){Z=oe?m.features[Te].geometry:ge?m.geometry:m,re=Z?Z.type==="GeometryCollection":!1,o=re?Z.geometries.length:1;for(var Le=0;Le<o;Le++){var Oe=0,Ae=0;if(k=re?Z.geometries[Le]:Z,k!==null){G=k.coordinates;var ze=k.type;switch(ee=0,ze){case null:break;case"Point":if(y(G,ie,Te,Oe,Ae)===!1)return!1;ie++,Oe++;break;case"LineString":case"MultiPoint":for(S=0;S<G.length;S++){if(y(G[S],ie,Te,Oe,Ae)===!1)return!1;ie++,ze==="MultiPoint"&&Oe++}ze==="LineString"&&Oe++;break;case"Polygon":case"MultiLineString":for(S=0;S<G.length;S++){for(M=0;M<G[S].length-ee;M++){if(y(G[S][M],ie,Te,Oe,Ae)===!1)return!1;ie++}ze==="MultiLineString"&&Oe++,ze==="Polygon"&&Ae++}ze==="Polygon"&&Oe++;break;case"MultiPolygon":for(S=0;S<G.length;S++){for(Ae=0,M=0;M<G[S].length;M++){for(R=0;R<G[S][M].length-ee;R++){if(y(G[S][M][R],ie,Te,Oe,Ae)===!1)return!1;ie++}Ae++}Oe++}break;case"GeometryCollection":for(S=0;S<k.geometries.length;S++)if(qc(k.geometries[S],y)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function Zc(m,y){if(m.type==="Feature")y(m,0);else if(m.type==="FeatureCollection")for(var b=0;b<m.features.length&&y(m.features[b],b)!==!1;b++);}function JM(m,y,b){var S=b;return Zc(m,function(M,R){R===0&&b===void 0?S=M:S=y(S,M,R)}),S}function KM(m,y){var b,S,M,R,k,o,G,Z,ee,ie,re=0,ue=m.type==="FeatureCollection",oe=m.type==="Feature",ge=ue?m.features.length:1;for(b=0;b<ge;b++){for(o=ue?m.features[b].geometry:oe?m.geometry:m,Z=ue?m.features[b].properties:oe?m.properties:{},ee=ue?m.features[b].bbox:oe?m.bbox:void 0,ie=ue?m.features[b].id:oe?m.id:void 0,G=o?o.type==="GeometryCollection":!1,k=G?o.geometries.length:1,M=0;M<k;M++){if(R=G?o.geometries[M]:o,R===null){if(y(null,re,Z,ee,ie)===!1)return!1;continue}switch(R.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(y(R,re,Z,ee,ie)===!1)return!1;break}case"GeometryCollection":{for(S=0;S<R.geometries.length;S++)if(y(R.geometries[S],re,Z,ee,ie)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}re++}}function Yg(m,y){KM(m,function(b,S,M,R,k){var o=b===null?null:b.type;switch(o){case null:case"Point":case"LineString":case"Polygon":return y(fl(b,M,{bbox:R,id:k}),S,0)===!1?!1:void 0}var G;switch(o){case"MultiPoint":G="Point";break;case"MultiLineString":G="LineString";break;case"MultiPolygon":G="Polygon";break}for(var Z=0;Z<b.coordinates.length;Z++){var ee=b.coordinates[Z],ie={type:G,coordinates:ee};if(y(fl(ie,M),S,Z)===!1)return!1}})}function QM(m,y){Yg(m,function(b,S,M){var R=0;if(b.geometry){var k=b.geometry.type;if(!(k==="Point"||k==="MultiPoint")){var o,G=0,Z=0,ee=0;if(qc(b,function(ie,re,ue,oe,ge){if(o===void 0||S>G||oe>Z||ge>ee){o=ie,G=S,Z=oe,ee=ge,R=0;return}var K=dm([o,ie],b.properties);if(y(K,S,M,ge,R)===!1)return!1;R++,o=ie})===!1)return!1}}})}function eP(m,y,b){var S=b,M=!1;return QM(m,function(R,k,o,G,Z){M===!1&&b===void 0?S=R:S=y(S,R,k,o,G,Z),M=!0}),S}function YE(m){if(!m)throw new Error("geojson is required");switch(m.type){case"Feature":return JE(m);case"FeatureCollection":return tP(m);case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return Mx(m);default:throw new Error("unknown GeoJSON type")}}function JE(m){const y={type:"Feature"};return Object.keys(m).forEach(b=>{switch(b){case"type":case"properties":case"geometry":return;default:y[b]=m[b]}}),y.properties=KE(m.properties),m.geometry==null?y.geometry=null:y.geometry=Mx(m.geometry),y}function KE(m){const y={};return m&&Object.keys(m).forEach(b=>{const S=m[b];typeof S=="object"?S===null?y[b]=null:Array.isArray(S)?y[b]=S.map(M=>M):y[b]=KE(S):y[b]=S}),y}function tP(m){const y={type:"FeatureCollection"};return Object.keys(m).forEach(b=>{switch(b){case"type":case"features":return;default:y[b]=m[b]}}),y.features=m.features.map(b=>JE(b)),y}function Mx(m){const y={type:m.type};return m.bbox&&(y.bbox=m.bbox),m.type==="GeometryCollection"?(y.geometries=m.geometries.map(b=>Mx(b)),y):(y.coordinates=QE(m.coordinates),y)}function QE(m){const y=m;return typeof y[0]!="object"?y.slice():y.map(b=>QE(b))}function W2(m,y={}){return eS(m,"mercator",y)}function iP(m,y={}){return eS(m,"wgs84",y)}function eS(m,y,b={}){b=b||{};var S=b.mutate;if(!m)throw new Error("geojson is required");return Array.isArray(m)&&ux(m[0])?m=y==="mercator"?X2(m):Y2(m):(S!==!0&&(m=YE(m)),qc(m,function(M){var R=y==="mercator"?X2(M):Y2(M);M[0]=R[0],M[1]=R[1]})),m}function X2(m){var y=Math.PI/180,b=6378137,S=20037508342789244e-9,M=Math.abs(m[0])<=180?m[0]:m[0]-rP(m[0])*360,R=[b*M*y,b*Math.log(Math.tan(Math.PI*.25+.5*m[1]*y))];return R[0]>S&&(R[0]=S),R[0]<-S&&(R[0]=-S),R[1]>S&&(R[1]=S),R[1]<-S&&(R[1]=-S),R}function Y2(m){var y=180/Math.PI,b=6378137;return[m[0]*y/b,(Math.PI*.5-2*Math.atan(Math.exp(-m[1]/b)))*y]}function rP(m){return m<0?-1:m>0?1:0}function tS(m,y,b){const S=y.geometry.coordinates,M=b.geometry.coordinates;if(S[1]>nx||S[1]<rx||M[1]>nx||M[1]<rx)return null;const R=W2(S),k=W2(M),o=ie=>Number(ie.toFixed(8)),G=(ie,re)=>(ie+re)/2,Z=iP([G(R[0],k[0]),G(R[1],k[1])]),ee=[o(Z[0]),o(Z[1])];return{type:qi.FEATURE,properties:{meta:Bo.MIDPOINT,parent:m,lng:ee[0],lat:ee[1],coord_path:b.properties.coord_path},geometry:{type:qi.POINT,coordinates:ee}}}function Jg(m,y={},b=null){const{type:S,coordinates:M}=m.geometry,R=m.properties&&m.properties.id;let k=[];S===qi.POINT?k.push(Yd(R,M,b,G(b))):S===qi.POLYGON?M.forEach((ee,ie)=>{o(ee,b!==null?`${b}.${ie}`:String(ie))}):S===qi.LINE_STRING?o(M,b):S.indexOf(qi.MULTI_PREFIX)===0&&Z();function o(ee,ie){let re="",ue=null;ee.forEach((oe,ge)=>{const K=ie!=null?`${ie}.${ge}`:String(ge),Te=Yd(R,oe,K,G(K));if(y.midpoints&&ue){const Oe=tS(R,ue,Te);Oe&&k.push(Oe)}ue=Te;const Le=JSON.stringify(oe);re!==Le&&k.push(Te),ge===0&&(re=Le)})}function G(ee){return y.selectedPaths?y.selectedPaths.indexOf(ee)!==-1:!1}function Z(){const ee=S.replace(qi.MULTI_PREFIX,"");M.forEach((ie,re)=>{const ue={type:qi.FEATURE,properties:m.properties,geometry:{type:ee,coordinates:ie}};k=k.concat(Jg(ue,y,re))})}return k}const Fa={enable(m){setTimeout(()=>{!m.map||!m.map.doubleClickZoom||!m._ctx||!m._ctx.store||!m._ctx.store.getInitialConfigValue||m._ctx.store.getInitialConfigValue("doubleClickZoom")&&m.map.doubleClickZoom.enable()},0)},disable(m){setTimeout(()=>{!m.map||!m.map.doubleClickZoom||m.map.doubleClickZoom.disable()},0)}},{LAT_MIN:vg,LAT_MAX:xg,LAT_RENDERED_MIN:J2,LAT_RENDERED_MAX:K2,LNG_MIN:Q2,LNG_MAX:eT}=kE;function nP(m){const y={Point:0,LineString:1,Polygon:2,MultiPoint:1,MultiLineString:2,MultiPolygon:3}[m.geometry.type],b=[m.geometry.coordinates].flat(y),S=b.map(o=>o[0]),M=b.map(o=>o[1]),R=o=>Math.min.apply(null,o),k=o=>Math.max.apply(null,o);return[R(S),R(M),k(S),k(M)]}function Px(m,y){let b=vg,S=xg,M=vg,R=xg,k=eT,o=Q2;m.forEach(Z=>{const ee=nP(Z),ie=ee[1],re=ee[3],ue=ee[0],oe=ee[2];ie>b&&(b=ie),re<S&&(S=re),re>M&&(M=re),ie<R&&(R=ie),ue<k&&(k=ue),oe>o&&(o=oe)});const G=y;return b+G.lat>K2&&(G.lat=K2-b),M+G.lat>xg&&(G.lat=xg-M),S+G.lat<J2&&(G.lat=J2-S),R+G.lat<vg&&(G.lat=vg-R),k+G.lng<=Q2&&(G.lng+=Math.ceil(Math.abs(G.lng)/360)*360),o+G.lng>=eT&&(G.lng-=Math.ceil(Math.abs(G.lng)/360)*360),G}function Lx(m,y){const b=Px(m.map(S=>S.toGeoJSON()),y);m.forEach(S=>{const M=S.getCoordinates(),R=Z=>{const ee={lng:Z[0]+b.lng,lat:Z[1]+b.lat};return[ee.lng,ee.lat]},k=Z=>Z.map(ee=>R(ee)),o=Z=>Z.map(ee=>k(ee));let G;S.type===qi.POINT?G=R(M):S.type===qi.LINE_STRING||S.type===qi.MULTI_POINT?G=M.map(R):S.type===qi.POLYGON||S.type===qi.MULTI_LINE_STRING?G=M.map(k):S.type===qi.MULTI_POLYGON&&(G=M.map(o)),S.incomingCoords(G)})}const yn={};yn.onSetup=function(m){const y={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initialDragPanState:this.map.dragPan.isEnabled(),initiallySelectedFeatureIds:m.featureIds||[]};return this.setSelected(y.initiallySelectedFeatureIds.filter(b=>this.getFeature(b)!==void 0)),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),y};yn.fireUpdate=function(){this.fire(es.UPDATE,{action:_m.MOVE,features:this.getSelected().map(m=>m.toGeoJSON())})};yn.fireActionable=function(){const m=this.getSelected(),y=m.filter(R=>this.isInstanceOf("MultiFeature",R));let b=!1;if(m.length>1){b=!0;const R=m[0].type.replace("Multi","");m.forEach(k=>{k.type.replace("Multi","")!==R&&(b=!1)})}const S=y.length>0,M=m.length>0;this.setActionableState({combineFeatures:b,uncombineFeatures:S,trash:M})};yn.getUniqueIds=function(m){return m.length?m.map(b=>b.properties.id).filter(b=>b!==void 0).reduce((b,S)=>(b.add(S),b),new aa).values():[]};yn.stopExtendedInteractions=function(m){m.boxSelectElement&&(m.boxSelectElement.parentNode&&m.boxSelectElement.parentNode.removeChild(m.boxSelectElement),m.boxSelectElement=null),(m.canDragMove||m.canBoxSelect)&&m.initialDragPanState===!0&&this.map.dragPan.enable(),m.boxSelecting=!1,m.canBoxSelect=!1,m.dragMoving=!1,m.canDragMove=!1};yn.onStop=function(){Fa.enable(this)};yn.onMouseMove=function(m,y){return Sx(y)&&m.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(m),!0};yn.onMouseOut=function(m){return m.dragMoving?this.fireUpdate():!0};yn.onTap=yn.onClick=function(m,y){if(Zg(y))return this.clickAnywhere(m,y);if(Hg(Bo.VERTEX)(y))return this.clickOnVertex(m,y);if(Sx(y))return this.clickOnFeature(m,y)};yn.clickAnywhere=function(m){const y=this.getSelectedIds();y.length&&(this.clearSelectedFeatures(),y.forEach(b=>this.doRender(b))),Fa.enable(this),this.stopExtendedInteractions(m)};yn.clickOnVertex=function(m,y){this.changeMode(Ur.DIRECT_SELECT,{featureId:y.featureTarget.properties.parent,coordPath:y.featureTarget.properties.coord_path,startPos:y.lngLat}),this.updateUIClasses({mouse:Bn.MOVE})};yn.startOnActiveFeature=function(m,y){this.stopExtendedInteractions(m),this.map.dragPan.disable(),this.doRender(y.featureTarget.properties.id),m.canDragMove=!0,m.dragMoveLocation=y.lngLat};yn.clickOnFeature=function(m,y){Fa.disable(this),this.stopExtendedInteractions(m);const b=kg(y),S=this.getSelectedIds(),M=y.featureTarget.properties.id,R=this.isSelected(M);if(!b&&R&&this.getFeature(M).type!==qi.POINT)return this.changeMode(Ur.DIRECT_SELECT,{featureId:M});R&&b?(this.deselect(M),this.updateUIClasses({mouse:Bn.POINTER}),S.length===1&&Fa.enable(this)):!R&&b?(this.select(M),this.updateUIClasses({mouse:Bn.MOVE})):!R&&!b&&(S.forEach(k=>this.doRender(k)),this.setSelected(M),this.updateUIClasses({mouse:Bn.MOVE})),this.doRender(M)};yn.onMouseDown=function(m,y){if(m.initialDragPanState=this.map.dragPan.isEnabled(),Qu(y))return this.startOnActiveFeature(m,y);if(this.drawConfig.boxSelect&&FE(y))return this.startBoxSelect(m,y)};yn.startBoxSelect=function(m,y){this.stopExtendedInteractions(m),this.map.dragPan.disable(),m.boxSelectStartLocation=Cx(y.originalEvent,this.map.getContainer()),m.canBoxSelect=!0};yn.onTouchStart=function(m,y){if(Qu(y))return this.startOnActiveFeature(m,y)};yn.onDrag=function(m,y){if(m.canDragMove)return this.dragMove(m,y);if(this.drawConfig.boxSelect&&m.canBoxSelect)return this.whileBoxSelect(m,y)};yn.whileBoxSelect=function(m,y){m.boxSelecting=!0,this.updateUIClasses({mouse:Bn.ADD}),m.boxSelectElement||(m.boxSelectElement=document.createElement("div"),m.boxSelectElement.classList.add(fs.BOX_SELECT),this.map.getContainer().appendChild(m.boxSelectElement));const b=Cx(y.originalEvent,this.map.getContainer()),S=Math.min(m.boxSelectStartLocation.x,b.x),M=Math.max(m.boxSelectStartLocation.x,b.x),R=Math.min(m.boxSelectStartLocation.y,b.y),k=Math.max(m.boxSelectStartLocation.y,b.y),o=`translate(${S}px, ${R}px)`;m.boxSelectElement.style.transform=o,m.boxSelectElement.style.WebkitTransform=o,m.boxSelectElement.style.width=`${M-S}px`,m.boxSelectElement.style.height=`${k-R}px`};yn.dragMove=function(m,y){m.dragMoving=!0,y.originalEvent.stopPropagation();const b={lng:y.lngLat.lng-m.dragMoveLocation.lng,lat:y.lngLat.lat-m.dragMoveLocation.lat};Lx(this.getSelected(),b),m.dragMoveLocation=y.lngLat};yn.onTouchEnd=yn.onMouseUp=function(m,y){if(m.dragMoving)this.fireUpdate();else if(m.boxSelecting){const b=[m.boxSelectStartLocation,Cx(y.originalEvent,this.map.getContainer())],S=this.featuresAt(null,b,"click"),M=this.getUniqueIds(S).filter(R=>!this.isSelected(R));M.length&&(this.select(M),M.forEach(R=>this.doRender(R)),this.updateUIClasses({mouse:Bn.MOVE}))}this.stopExtendedInteractions(m)};yn.toDisplayFeatures=function(m,y,b){y.properties.active=this.isSelected(y.properties.id)?go.ACTIVE:go.INACTIVE,b(y),this.fireActionable(),!(y.properties.active!==go.ACTIVE||y.geometry.type===qi.POINT)&&Jg(y).forEach(b)};yn.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()};yn.onCombineFeatures=function(){const m=this.getSelected();if(m.length===0||m.length<2)return;const y=[],b=[],S=m[0].type.replace("Multi","");for(let M=0;M<m.length;M++){const R=m[M];if(R.type.replace("Multi","")!==S)return;R.type.includes("Multi")?R.getCoordinates().forEach(k=>{y.push(k)}):y.push(R.getCoordinates()),b.push(R.toGeoJSON())}if(b.length>1){const M=this.newFeature({type:qi.FEATURE,properties:b[0].properties,geometry:{type:`Multi${S}`,coordinates:y}});this.addFeature(M),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([M.id]),this.fire(es.COMBINE_FEATURES,{createdFeatures:[M.toGeoJSON()],deletedFeatures:b})}this.fireActionable()};yn.onUncombineFeatures=function(){const m=this.getSelected();if(m.length===0)return;const y=[],b=[];for(let S=0;S<m.length;S++){const M=m[S];this.isInstanceOf("MultiFeature",M)&&(M.getFeatures().forEach(R=>{this.addFeature(R),R.properties=M.properties,y.push(R.toGeoJSON()),this.select([R.id])}),this.deleteFeature(M.id,{silent:!0}),b.push(M.toGeoJSON()))}y.length>1&&this.fire(es.UNCOMBINE_FEATURES,{createdFeatures:y,deletedFeatures:b}),this.fireActionable()};const iS=Hg(Bo.VERTEX),rS=Hg(Bo.MIDPOINT),vn={};vn.fireUpdate=function(){this.fire(es.UPDATE,{action:_m.CHANGE_COORDINATES,features:this.getSelected().map(m=>m.toGeoJSON())})};vn.fireActionable=function(m){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:m.selectedCoordPaths.length>0})};vn.startDragging=function(m,y){m.initialDragPanState==null&&(m.initialDragPanState=this.map.dragPan.isEnabled()),this.map.dragPan.disable(),m.canDragMove=!0,m.dragMoveLocation=y.lngLat};vn.stopDragging=function(m){m.canDragMove&&m.initialDragPanState===!0&&this.map.dragPan.enable(),m.initialDragPanState=null,m.dragMoving=!1,m.canDragMove=!1,m.dragMoveLocation=null};vn.onVertex=function(m,y){this.startDragging(m,y);const b=y.featureTarget.properties,S=m.selectedCoordPaths.indexOf(b.coord_path);!kg(y)&&S===-1?m.selectedCoordPaths=[b.coord_path]:kg(y)&&S===-1&&m.selectedCoordPaths.push(b.coord_path);const M=this.pathsToCoordinates(m.featureId,m.selectedCoordPaths);this.setSelectedCoordinates(M)};vn.onMidpoint=function(m,y){this.startDragging(m,y);const b=y.featureTarget.properties;m.feature.addCoordinate(b.coord_path,b.lng,b.lat),this.fireUpdate(),m.selectedCoordPaths=[b.coord_path]};vn.pathsToCoordinates=function(m,y){return y.map(b=>({feature_id:m,coord_path:b}))};vn.onFeature=function(m,y){m.selectedCoordPaths.length===0?this.startDragging(m,y):this.stopDragging(m)};vn.dragFeature=function(m,y,b){Lx(this.getSelected(),b),m.dragMoveLocation=y.lngLat};vn.dragVertex=function(m,y,b){const S=m.selectedCoordPaths.map(k=>m.feature.getCoordinate(k)),M=S.map(k=>({type:qi.FEATURE,properties:{},geometry:{type:qi.POINT,coordinates:k}})),R=Px(M,b);for(let k=0;k<S.length;k++){const o=S[k];m.feature.updateCoordinate(m.selectedCoordPaths[k],o[0]+R.lng,o[1]+R.lat)}};vn.clickNoTarget=function(){this.changeMode(Ur.SIMPLE_SELECT)};vn.clickInactive=function(){this.changeMode(Ur.SIMPLE_SELECT)};vn.clickActiveFeature=function(m){m.selectedCoordPaths=[],this.clearSelectedCoordinates(),m.feature.changed()};vn.onSetup=function(m){const y=m.featureId,b=this.getFeature(y);if(!b)throw new Error("You must provide a featureId to enter direct_select mode");if(b.type===qi.POINT)throw new TypeError("direct_select mode doesn't handle point features");const S={featureId:y,feature:b,dragMoveLocation:m.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:m.coordPath?[m.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(y,S.selectedCoordPaths)),this.setSelected(y),Fa.disable(this),this.setActionableState({trash:!0}),S};vn.onStop=function(){Fa.enable(this),this.clearSelectedCoordinates()};vn.toDisplayFeatures=function(m,y,b){m.featureId===y.properties.id?(y.properties.active=go.ACTIVE,b(y),Jg(y,{map:this.map,midpoints:!0,selectedPaths:m.selectedCoordPaths}).forEach(b)):(y.properties.active=go.INACTIVE,b(y)),this.fireActionable(m)};vn.onTrash=function(m){m.selectedCoordPaths.sort((y,b)=>b.localeCompare(y,"en",{numeric:!0})).forEach(y=>m.feature.removeCoordinate(y)),this.fireUpdate(),m.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(m),m.feature.isValid()===!1&&(this.deleteFeature([m.featureId]),this.changeMode(Ur.SIMPLE_SELECT,{}))};vn.onMouseMove=function(m,y){const b=Qu(y),S=iS(y),M=rS(y),R=m.selectedCoordPaths.length===0;return b&&R?this.updateUIClasses({mouse:Bn.MOVE}):S&&!R?this.updateUIClasses({mouse:Bn.MOVE}):this.updateUIClasses({mouse:Bn.NONE}),(S||b||M)&&m.dragMoving&&this.fireUpdate(),this.stopDragging(m),!0};vn.onMouseOut=function(m){return m.dragMoving&&this.fireUpdate(),!0};vn.onTouchStart=vn.onMouseDown=function(m,y){if(iS(y))return this.onVertex(m,y);if(Qu(y))return this.onFeature(m,y);if(rS(y))return this.onMidpoint(m,y)};vn.onDrag=function(m,y){if(m.canDragMove!==!0)return;m.dragMoving=!0,y.originalEvent.stopPropagation();const b={lng:y.lngLat.lng-m.dragMoveLocation.lng,lat:y.lngLat.lat-m.dragMoveLocation.lat};m.selectedCoordPaths.length>0?this.dragVertex(m,y,b):this.dragFeature(m,y,b),m.dragMoveLocation=y.lngLat};vn.onClick=function(m,y){if(Zg(y))return this.clickNoTarget(m,y);if(Qu(y))return this.clickActiveFeature(m,y);if(Ex(y))return this.clickInactive(m,y);this.stopDragging(m)};vn.onTap=function(m,y){if(Zg(y))return this.clickNoTarget(m,y);if(Qu(y))return this.clickActiveFeature(m,y);if(Ex(y))return this.clickInactive(m,y)};vn.onTouchEnd=vn.onMouseUp=function(m){m.dragMoving&&this.fireUpdate(),this.stopDragging(m)};const pl={};pl.onSetup=function(){const m=this.newFeature({type:qi.FEATURE,properties:{},geometry:{type:qi.POINT,coordinates:[]}});return this.addFeature(m),this.clearSelectedFeatures(),this.updateUIClasses({mouse:Bn.ADD}),this.activateUIButton(ps.POINT),this.setActionableState({trash:!0}),{point:m}};pl.stopDrawingAndRemove=function(m){this.deleteFeature([m.point.id],{silent:!0}),this.changeMode(Ur.SIMPLE_SELECT)};pl.onTap=pl.onClick=function(m,y){this.updateUIClasses({mouse:Bn.MOVE}),m.point.updateCoordinate("",y.lngLat.lng,y.lngLat.lat),this.fire(es.CREATE,{features:[m.point.toGeoJSON()]}),this.changeMode(Ur.SIMPLE_SELECT,{featureIds:[m.point.id]})};pl.onStop=function(m){this.activateUIButton(),m.point.getCoordinate().length||this.deleteFeature([m.point.id],{silent:!0})};pl.toDisplayFeatures=function(m,y,b){const S=y.properties.id===m.point.id;if(y.properties.active=S?go.ACTIVE:go.INACTIVE,!S)return b(y)};pl.onTrash=pl.stopDrawingAndRemove;pl.onKeyUp=function(m,y){if($g(y)||Wg(y))return this.stopDrawingAndRemove(m,y)};function Fg(m,y){return m.lngLat?m.lngLat.lng===y[0]&&m.lngLat.lat===y[1]:!1}const Ba={};Ba.onSetup=function(){const m=this.newFeature({type:qi.FEATURE,properties:{},geometry:{type:qi.POLYGON,coordinates:[[]]}});return this.addFeature(m),this.clearSelectedFeatures(),Fa.disable(this),this.updateUIClasses({mouse:Bn.ADD}),this.activateUIButton(ps.POLYGON),this.setActionableState({trash:!0}),{polygon:m,currentVertexPosition:0}};Ba.clickAnywhere=function(m,y){if(m.currentVertexPosition>0&&Fg(y,m.polygon.coordinates[0][m.currentVertexPosition-1]))return this.changeMode(Ur.SIMPLE_SELECT,{featureIds:[m.polygon.id]});this.updateUIClasses({mouse:Bn.ADD}),m.polygon.updateCoordinate(`0.${m.currentVertexPosition}`,y.lngLat.lng,y.lngLat.lat),m.currentVertexPosition++,m.polygon.updateCoordinate(`0.${m.currentVertexPosition}`,y.lngLat.lng,y.lngLat.lat)};Ba.clickOnVertex=function(m){return this.changeMode(Ur.SIMPLE_SELECT,{featureIds:[m.polygon.id]})};Ba.onMouseMove=function(m,y){m.polygon.updateCoordinate(`0.${m.currentVertexPosition}`,y.lngLat.lng,y.lngLat.lat),gm(y)&&this.updateUIClasses({mouse:Bn.POINTER})};Ba.onTap=Ba.onClick=function(m,y){return gm(y)?this.clickOnVertex(m,y):this.clickAnywhere(m,y)};Ba.onKeyUp=function(m,y){$g(y)?(this.deleteFeature([m.polygon.id],{silent:!0}),this.changeMode(Ur.SIMPLE_SELECT)):Wg(y)&&this.changeMode(Ur.SIMPLE_SELECT,{featureIds:[m.polygon.id]})};Ba.onStop=function(m){this.updateUIClasses({mouse:Bn.NONE}),Fa.enable(this),this.activateUIButton(),this.getFeature(m.polygon.id)!==void 0&&(m.polygon.removeCoordinate(`0.${m.currentVertexPosition}`),m.polygon.isValid()?this.fire(es.CREATE,{features:[m.polygon.toGeoJSON()]}):(this.deleteFeature([m.polygon.id],{silent:!0}),this.changeMode(Ur.SIMPLE_SELECT,{},{silent:!0})))};Ba.toDisplayFeatures=function(m,y,b){const S=y.properties.id===m.polygon.id;if(y.properties.active=S?go.ACTIVE:go.INACTIVE,!S)return b(y);if(y.geometry.coordinates.length===0)return;const M=y.geometry.coordinates[0].length;if(!(M<3)){if(y.properties.meta=Bo.FEATURE,b(Yd(m.polygon.id,y.geometry.coordinates[0][0],"0.0",!1)),M>3){const R=y.geometry.coordinates[0].length-3;b(Yd(m.polygon.id,y.geometry.coordinates[0][R],`0.${R}`,!1))}if(M<=4){const R=[[y.geometry.coordinates[0][0][0],y.geometry.coordinates[0][0][1]],[y.geometry.coordinates[0][1][0],y.geometry.coordinates[0][1][1]]];if(b({type:qi.FEATURE,properties:y.properties,geometry:{coordinates:R,type:qi.LINE_STRING}}),M===3)return}return b(y)}};Ba.onTrash=function(m){this.deleteFeature([m.polygon.id],{silent:!0}),this.changeMode(Ur.SIMPLE_SELECT)};const Na={};Na.onSetup=function(m){m=m||{};const y=m.featureId;let b,S,M="forward";if(y){if(b=this.getFeature(y),!b)throw new Error("Could not find a feature with the provided featureId");let R=m.from;if(R&&R.type==="Feature"&&R.geometry&&R.geometry.type==="Point"&&(R=R.geometry),R&&R.type==="Point"&&R.coordinates&&R.coordinates.length===2&&(R=R.coordinates),!R||!Array.isArray(R))throw new Error("Please use the `from` property to indicate which point to continue the line from");const k=b.coordinates.length-1;if(b.coordinates[k][0]===R[0]&&b.coordinates[k][1]===R[1])S=k+1,b.addCoordinate(S,...b.coordinates[k]);else if(b.coordinates[0][0]===R[0]&&b.coordinates[0][1]===R[1])M="backwards",S=0,b.addCoordinate(S,...b.coordinates[0]);else throw new Error("`from` should match the point at either the start or the end of the provided LineString")}else b=this.newFeature({type:qi.FEATURE,properties:{},geometry:{type:qi.LINE_STRING,coordinates:[]}}),S=0,this.addFeature(b);return this.clearSelectedFeatures(),Fa.disable(this),this.updateUIClasses({mouse:Bn.ADD}),this.activateUIButton(ps.LINE),this.setActionableState({trash:!0}),{line:b,currentVertexPosition:S,direction:M}};Na.clickAnywhere=function(m,y){if(m.currentVertexPosition>0&&Fg(y,m.line.coordinates[m.currentVertexPosition-1])||m.direction==="backwards"&&Fg(y,m.line.coordinates[m.currentVertexPosition+1]))return this.changeMode(Ur.SIMPLE_SELECT,{featureIds:[m.line.id]});this.updateUIClasses({mouse:Bn.ADD}),m.line.updateCoordinate(m.currentVertexPosition,y.lngLat.lng,y.lngLat.lat),m.direction==="forward"?(m.currentVertexPosition++,m.line.updateCoordinate(m.currentVertexPosition,y.lngLat.lng,y.lngLat.lat)):m.line.addCoordinate(0,y.lngLat.lng,y.lngLat.lat)};Na.clickOnVertex=function(m){return this.changeMode(Ur.SIMPLE_SELECT,{featureIds:[m.line.id]})};Na.onMouseMove=function(m,y){m.line.updateCoordinate(m.currentVertexPosition,y.lngLat.lng,y.lngLat.lat),gm(y)&&this.updateUIClasses({mouse:Bn.POINTER})};Na.onTap=Na.onClick=function(m,y){if(gm(y))return this.clickOnVertex(m,y);this.clickAnywhere(m,y)};Na.onKeyUp=function(m,y){Wg(y)?this.changeMode(Ur.SIMPLE_SELECT,{featureIds:[m.line.id]}):$g(y)&&(this.deleteFeature([m.line.id],{silent:!0}),this.changeMode(Ur.SIMPLE_SELECT))};Na.onStop=function(m){Fa.enable(this),this.activateUIButton(),this.getFeature(m.line.id)!==void 0&&(m.line.removeCoordinate(`${m.currentVertexPosition}`),m.line.isValid()?this.fire(es.CREATE,{features:[m.line.toGeoJSON()]}):(this.deleteFeature([m.line.id],{silent:!0}),this.changeMode(Ur.SIMPLE_SELECT,{},{silent:!0})))};Na.onTrash=function(m){this.deleteFeature([m.line.id],{silent:!0}),this.changeMode(Ur.SIMPLE_SELECT)};Na.toDisplayFeatures=function(m,y,b){const S=y.properties.id===m.line.id;if(y.properties.active=S?go.ACTIVE:go.INACTIVE,!S)return b(y);y.geometry.coordinates.length<2||(y.properties.meta=Bo.FEATURE,b(Yd(m.line.id,y.geometry.coordinates[m.direction==="forward"?y.geometry.coordinates.length-2:1],`${m.direction==="forward"?y.geometry.coordinates.length-2:1}`,!1)),b(y))};const nS={simple_select:yn,direct_select:vn,draw_point:pl,draw_polygon:Ba,draw_line_string:Na},oP={defaultMode:Ur.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:$E,modes:nS,controls:{},userProperties:!1,suppressAPIEvents:!0},sP={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},aP={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function tT(m,y){return m.map(b=>b.source?b:Object.assign({},b,{id:`${b.id}.${y}`,source:y==="hot"?na.HOT:na.COLD}))}function lP(m={}){let y=Object.assign({},m);return m.controls||(y.controls={}),m.displayControlsDefault===!1?y.controls=Object.assign({},aP,m.controls):y.controls=Object.assign({},sP,m.controls),y=Object.assign({},oP,y),y.styles=tT(y.styles,"cold").concat(tT(y.styles,"hot")),y}var l0,iT;function cP(){return iT||(iT=1,l0=function m(y,b){if(y===b)return!0;if(y&&b&&typeof y=="object"&&typeof b=="object"){if(y.constructor!==b.constructor)return!1;var S,M,R;if(Array.isArray(y)){if(S=y.length,S!=b.length)return!1;for(M=S;M--!==0;)if(!m(y[M],b[M]))return!1;return!0}if(y.constructor===RegExp)return y.source===b.source&&y.flags===b.flags;if(y.valueOf!==Object.prototype.valueOf)return y.valueOf()===b.valueOf();if(y.toString!==Object.prototype.toString)return y.toString()===b.toString();if(R=Object.keys(y),S=R.length,S!==Object.keys(b).length)return!1;for(M=S;M--!==0;)if(!Object.prototype.hasOwnProperty.call(b,R[M]))return!1;for(M=S;M--!==0;){var k=R[M];if(!m(y[k],b[k]))return!1}return!0}return y!==y&&b!==b}),l0}var uP=cP();const rT=Ku(uP);var c0,nT;function hP(){if(nT)return c0;nT=1,c0=y;var m={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"};function y(b){if(!b||!b.type)return null;var S=m[b.type];if(!S)return null;if(S==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:b}]};if(S==="feature")return{type:"FeatureCollection",features:[b]};if(S==="featurecollection")return b}return c0}var dP=hP();const fP=Ku(dP);function oS(m,y){return m.length!==y.length?!1:JSON.stringify(m.map(b=>b).sort())===JSON.stringify(y.map(b=>b).sort())}const pP={Polygon:Bs,LineString:_l,Point:Wc,MultiPolygon:Ko,MultiLineString:Ko,MultiPoint:Ko};function mP(m,y){y.modes=Ur;const b=m.options.suppressAPIEvents!==void 0?!!m.options.suppressAPIEvents:!0;return y.getFeatureIdsAt=function(S){return Xd.click({point:S},null,m).map(R=>R.properties.id)},y.getSelectedIds=function(){return m.store.getSelectedIds()},y.getSelected=function(){return{type:qi.FEATURE_COLLECTION,features:m.store.getSelectedIds().map(S=>m.store.get(S)).map(S=>S.toGeoJSON())}},y.getSelectedPoints=function(){return{type:qi.FEATURE_COLLECTION,features:m.store.getSelectedCoordinates().map(S=>({type:qi.FEATURE,properties:{},geometry:{type:qi.POINT,coordinates:S.coordinates}}))}},y.set=function(S){if(S.type===void 0||S.type!==qi.FEATURE_COLLECTION||!Array.isArray(S.features))throw new Error("Invalid FeatureCollection");const M=m.store.createRenderBatch();let R=m.store.getAllIds().slice();const k=y.add(S),o=new aa(k);return R=R.filter(G=>!o.has(G)),R.length&&y.delete(R),M(),k},y.add=function(S){const R=JSON.parse(JSON.stringify(fP(S))).features.map(k=>{if(k.id=k.id||Ax(),k.geometry===null)throw new Error("Invalid geometry: null");if(m.store.get(k.id)===void 0||m.store.get(k.id).type!==k.geometry.type){const o=pP[k.geometry.type];if(o===void 0)throw new Error(`Invalid geometry type: ${k.geometry.type}.`);const G=new o(m,k);m.store.add(G,{silent:b})}else{const o=m.store.get(k.id),G=o.properties;o.properties=k.properties,rT(G,k.properties)||m.store.featureChanged(o.id,{silent:b}),rT(o.getCoordinates(),k.geometry.coordinates)||o.incomingCoords(k.geometry.coordinates)}return k.id});return m.store.render(),R},y.get=function(S){const M=m.store.get(S);if(M)return M.toGeoJSON()},y.getAll=function(){return{type:qi.FEATURE_COLLECTION,features:m.store.getAll().map(S=>S.toGeoJSON())}},y.delete=function(S){return m.store.delete(S,{silent:b}),y.getMode()===Ur.DIRECT_SELECT&&!m.store.getSelectedIds().length?m.events.changeMode(Ur.SIMPLE_SELECT,void 0,{silent:b}):m.store.render(),y},y.deleteAll=function(){return m.store.delete(m.store.getAllIds(),{silent:b}),y.getMode()===Ur.DIRECT_SELECT?m.events.changeMode(Ur.SIMPLE_SELECT,void 0,{silent:b}):m.store.render(),y},y.changeMode=function(S,M={}){return S===Ur.SIMPLE_SELECT&&y.getMode()===Ur.SIMPLE_SELECT?(oS(M.featureIds||[],m.store.getSelectedIds())||(m.store.setSelected(M.featureIds,{silent:b}),m.store.render()),y):(S===Ur.DIRECT_SELECT&&y.getMode()===Ur.DIRECT_SELECT&&M.featureId===m.store.getSelectedIds()[0]||m.events.changeMode(S,M,{silent:b}),y)},y.getMode=function(){return m.events.getMode()},y.trash=function(){return m.events.trash({silent:b}),y},y.combineFeatures=function(){return m.events.combineFeatures({silent:b}),y},y.uncombineFeatures=function(){return m.events.uncombineFeatures({silent:b}),y},y.setFeatureProperty=function(S,M,R){return m.store.setFeatureProperty(S,M,R,{silent:b}),y},y}const _P=Object.freeze(Object.defineProperty({__proto__:null,CommonSelectors:EM,ModeHandler:cx,StringSet:aa,constrainFeatureMovement:Px,createMidPoint:tS,createSupplementaryPoints:Jg,createVertex:Yd,doubleClickZoom:Fa,euclideanDistance:Ix,featuresAt:Xd,getFeatureAtAndSetCursors:Lg,isClick:ax,isEventAtCoordinates:Fg,isTap:lx,mapEventToBoundingBox:GE,moveFeatures:Lx,sortFeatures:jE,stringSetsAreEqual:oS,theme:$E,toDenseArray:ym},Symbol.toStringTag,{value:"Module"})),gP=function(m,y){m=lP(m);const b={options:m};y=mP(b,y),b.api=y;const S=$M(b);return y.onAdd=S.onAdd,y.onRemove=S.onRemove,y.types=ps,y.options=m,y};function pm(m){gP(m,this)}pm.modes=nS;pm.constants=kE;pm.lib=_P;var bg={},oT;function yP(){if(oT)return bg;oT=1,Object.defineProperty(bg,"__esModule",{value:!0});var m={enable:function(S){setTimeout(function(){!S.map||!S.map.doubleClickZoom||!S._ctx||!S._ctx.store||!S._ctx.store.getInitialConfigValue||S._ctx.store.getInitialConfigValue("doubleClickZoom")&&S.map.doubleClickZoom.enable()},0)},disable:function(S){setTimeout(function(){!S.map||!S.map.doubleClickZoom||S.map.doubleClickZoom.disable()},0)}},y={onSetup:function(S){var M=this.newFeature({type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[]]}});return this.addFeature(M),this.clearSelectedFeatures(),m.disable(this),this.updateUIClasses({mouse:"add"}),this.setActionableState({trash:!0}),{rectangle:M}},onTap:function(S,M){S.startPoint&&this.onMouseMove(S,M),this.onClick(S,M)},onClick:function(S,M){S.startPoint&&S.startPoint[0]!==M.lngLat.lng&&S.startPoint[1]!==M.lngLat.lat&&(this.updateUIClasses({mouse:"pointer"}),S.endPoint=[M.lngLat.lng,M.lngLat.lat],this.changeMode("simple_select",{featuresId:S.rectangle.id}));var R=[M.lngLat.lng,M.lngLat.lat];S.startPoint=R},onMouseMove:function(S,M){S.startPoint&&(S.rectangle.updateCoordinate("0.0",S.startPoint[0],S.startPoint[1]),S.rectangle.updateCoordinate("0.1",M.lngLat.lng,S.startPoint[1]),S.rectangle.updateCoordinate("0.2",M.lngLat.lng,M.lngLat.lat),S.rectangle.updateCoordinate("0.3",S.startPoint[0],M.lngLat.lat),S.rectangle.updateCoordinate("0.4",S.startPoint[0],S.startPoint[1]))},onKeyUp:function(S,M){if(M.keyCode===27)return this.changeMode("simple_select")},onStop:function(S){m.enable(this),this.updateUIClasses({mouse:"none"}),this.activateUIButton(),this.getFeature(S.rectangle.id)!==void 0&&(S.rectangle.removeCoordinate("0.4"),S.rectangle.isValid()?this.map.fire("draw.create",{features:[S.rectangle.toGeoJSON()]}):(this.deleteFeature([S.rectangle.id],{silent:!0}),this.changeMode("simple_select",{},{silent:!0})))},toDisplayFeatures:function(S,M,R){var k=M.properties.id===S.rectangle.id;if(M.properties.active=k?"true":"false",!k)return R(M);if(S.startPoint)return R(M)},onTrash:function(S){this.deleteFeature([S.rectangle.id],{silent:!0}),this.changeMode("simple_select")}};return bg.default=y,bg}var vP=yP();const xP=Ku(vP),Rx=async({url:m,method:y="GET",body:b})=>{let S=[];try{S=await(await fetch(m,{method:y,headers:{Accept:"application/json","Content-Type":"application/json"},...b&&{body:b}})).json()}catch(M){console.warn(`Request failed: ${M}`)}return S},sS=async(m,y,b,S)=>{let{curb_policy_ids:M,curb_zone_id:R}=y;if(M=M.filter(Boolean),!M||!M.length)return{zoneProperties:y};const k={zoneId:R,canPark:!1,permitted:!1,accessible:!1,loadingZone:!1,maxStay:null,paid:!1},o=m.sort((G,Z)=>G.priority-Z.priority);for(const G of o){let{rules:Z=[],time_spans:ee=[]}=G??{};Z=Array.isArray(Z)?Z.filter(Boolean):[],ee=Array.isArray(ee)?ee.filter(Boolean):[];for(const ie of Z){let{activity:re=null,purposes:ue=[],user_classes:oe=[],max_stay:ge,max_stay_unit:K,rate:Te=null}=ie??{};ue||(ue=[]),oe||(oe=[]),ue=ue.map(qd),oe=oe.map(qd);for(const Le of ee){let{days_of_week:Oe=null,time_of_day_start:Ae=null,time_of_day_end:ze=null}=Le??{};if(Oe!==null&&(Oe=Oe.map(qd)),Ae=zg(Ae),Ae===24&&(Ae=0),ze=zg(ze),ze===0&&(ze=24),!!re&&re==="parking"){if(k.canPark=!0,ue&&Array.isArray(ue)&&ue.some(Ye=>["permit","disabled_parking_permit"].includes(Ye))&&(k.permitted=!0),oe&&(oe.includes("accessible")&&(k.accessible=!0),oe.length>1&&!oe.includes("car")&&(k.canPark=!1)),k.canPark&&Oe&&(k.canPark=Oe.includes(b)),k.canPark&&Ae!==null&&Ae!==ze&&(k.canPark=S>=Ae&&S<=ze),k.canPark&&ge&&K){let Ye=K==="hour"?ge*60:ge;k.maxStay=Ye}k.canPark&&Te&&(k.paid=!0)}else{const Ye=Oe&&Oe.includes(b),it=Ae&&ze&&S>=Ae&&S<=ze;k.canPark&&Oe&&(k.canPark=!Ye),k.canPark&&Ae!==null&&Ae!==ze&&(k.canPark=!it),re==="loading"&&Ye&&it&&(k.loadingZone=!0)}}}}return k.maxStay===null&&delete k.maxStay,{...y,...k}},Dx=async m=>{const y=`${wx}/curbs/policies?ids=${m.join(",")}`,b=await Rx({url:y,method:"GET"});return b?b.data.policies:[]},bP=async(m,y,b,S)=>{if(!m.data)return null;let{zones:M}=m.data;return M=await Promise.all(M.map(async R=>{let k={...R};delete k.geometry;const{curb_policy_ids:o}=R,G=o.map(ee=>y[ee]);return k=await sS(G,k,b,S),{type:"Feature",properties:k,geometry:R?.geometry}})),{type:"FeatureCollection",features:M}},wP=async(m,y,b,S,M,R)=>{hm.loading=!0;let k,o;const G=`${wx}/curbs/zones?min_lng=${m}&min_lat=${y}&max_lng=${b}&max_lat=${S}`;o=await Rx({url:G,method:"GET"});let Z=(o?.data?.zones??[]).map(ie=>ie?.curb_policy_ids??[]).flat();Z=[...new Set(Z)],k=await Dx(Z),k=k.reduce((ie,re)=>(ie[re?.curb_policy_id]=re,ie),{});const ee=await bP(o,k,M,R);return hm.loading=!1,ee},TP=async(m,y,b,S,M)=>{hm.loading=!0;const R=`${wx}/curbs/zones?lng=${m}&lat=${y}&radius=${b}`,k=await Rx({url:R,method:"GET"});let o=(k?.data?.zones??[]).map(ie=>ie?.curb_policy_ids??[]).flat();o=[...new Set(o)];let G=await Dx(o);G=G.reduce((ie,re)=>(ie[re?.curb_policy_id]=re,ie),{});const ee=await(async ie=>{if(!ie.data)return null;let{zones:re}=ie.data;return re=await Promise.all(re.map(async ue=>{let oe={...ue};delete oe.geometry;const{curb_policy_ids:ge}=ue,K=ge.map(Le=>G[Le]);return oe=await sS(K,oe,S,M),{type:"Feature",properties:oe,geometry:ue?.geometry}})),{type:"FeatureCollection",features:re}})(k);return hm.loading=!1,ee};var EP=ks('<svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18.8242 0.439331C19.41 -0.146455 20.3595 -0.146455 20.9453 0.439331C21.531 1.02513 21.5311 1.97468 20.9453 2.56042L12.8135 10.6923L20.9453 18.8241C21.531 19.4099 21.5311 20.3594 20.9453 20.9452C20.3596 21.5309 19.41 21.5309 18.8242 20.9452L10.6924 12.8134L2.56055 20.9452C1.9748 21.5309 1.02525 21.5309 0.439453 20.9452C-0.146333 20.3594 -0.146333 19.4099 0.439453 18.8241L8.57129 10.6923L0.439453 2.56042C-0.14633 1.97464 -0.146323 1.02512 0.439453 0.439331C1.02524 -0.146455 1.97476 -0.146455 2.56055 0.439331L10.6924 8.57117L18.8242 0.439331Z" fill="black"></path></svg>');function Ox(m){var y=EP();gi(m,y)}var SP=Zi('<div class="NoZonesModal svelte-21g6pp" role="alertdialog"><button class="background svelte-21g6pp"></button> <div class="modal svelte-21g6pp"><p>No curb zones found within selected area.</p> <p>Please select a different area.</p> <button class="close-button svelte-21g6pp"><!></button></div></div>');function IP(m,y){var b=SP(),S=Ht(b);S.__click=function(...o){y.onClose?.apply(this,o)};var M=zi(S,2),R=zi(Ht(M),4);R.__click=function(...o){y.onClose?.apply(this,o)};var k=Ht(R);Ox(k),Ut(R),Ut(M),Ut(b),gi(m,b)}Fs(["click"]);function Os(m){if(!m)throw new Error("coord is required");if(!Array.isArray(m)){if(m.type==="Feature"&&m.geometry!==null&&m.geometry.type==="Point")return[...m.geometry.coordinates];if(m.type==="Point")return[...m.coordinates]}if(Array.isArray(m)&&m.length>=2&&!Array.isArray(m[0])&&!Array.isArray(m[1]))return[...m];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Wu(m){if(Array.isArray(m))return m;if(m.type==="Feature"){if(m.geometry!==null)return m.geometry.coordinates}else if(m.coordinates)return m.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function Bg(m){return m.type==="Feature"?m.geometry:m}function sT(m,y){return m.type==="FeatureCollection"?"FeatureCollection":m.type==="GeometryCollection"?"GeometryCollection":m.type==="Feature"&&m.geometry!==null?m.geometry.type:m.type}function aS(m,y,b={}){if(b.final===!0)return AP(m,y);const S=Os(m),M=Os(y),R=Ds(S[0]),k=Ds(M[0]),o=Ds(S[1]),G=Ds(M[1]),Z=Math.sin(k-R)*Math.cos(G),ee=Math.cos(o)*Math.sin(G)-Math.sin(o)*Math.cos(G)*Math.cos(k-R);return fm(Math.atan2(Z,ee))}function AP(m,y){let b=aS(y,m);return b=(b+180)%360,b}function lS(m,y,b,S={}){const M=Os(m),R=Ds(M[0]),k=Ds(M[1]),o=Ds(b),G=XM(y,S.units),Z=Math.asin(Math.sin(k)*Math.cos(G)+Math.cos(k)*Math.sin(G)*Math.cos(o)),ee=R+Math.atan2(Math.sin(o)*Math.sin(G)*Math.cos(k),Math.cos(G)-Math.sin(k)*Math.sin(Z)),ie=fm(ee),re=fm(Z);return M[2]!==void 0?Jo([ie,re,M[2]],S.properties):Jo([ie,re],S.properties)}function Zd(m,y,b={}){var S=Os(m),M=Os(y),R=Ds(M[1]-S[1]),k=Ds(M[0]-S[0]),o=Ds(S[1]),G=Ds(M[1]),Z=Math.pow(Math.sin(R/2),2)+Math.pow(Math.sin(k/2),2)*Math.cos(o)*Math.cos(G);return WM(2*Math.atan2(Math.sqrt(Z),Math.sqrt(1-Z)),b.units)}function CP(m,y,b={}){const M=Bg(m).coordinates;let R=0;for(let k=0;k<M.length&&!(y>=R&&k===M.length-1);k++)if(R>=y){const o=y-R;if(o){const G=aS(M[k],M[k-1])-180;return lS(M[k],o,G,b)}else return Jo(M[k])}else R+=Zd(M[k],M[k+1],b);return Jo(M[M.length-1])}var MP=CP;function sa(m,y={}){if(m.bbox!=null&&y.recompute!==!0)return m.bbox;const b=[1/0,1/0,-1/0,-1/0];return qc(m,S=>{b[0]>S[0]&&(b[0]=S[0]),b[1]>S[1]&&(b[1]=S[1]),b[2]<S[0]&&(b[2]=S[0]),b[3]<S[1]&&(b[3]=S[1])}),b}function PP(m,y={}){const b=Number(m[0]),S=Number(m[1]),M=Number(m[2]),R=Number(m[3]);if(m.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");const k=[b,S];return XE([[k,[M,S],[M,R],[b,R],k]],y.properties,{bbox:m,id:y.id})}var cS=PP;const Ql=11102230246251565e-32,Do=134217729,LP=(3+8*Ql)*Ql;function u0(m,y,b,S,M){let R,k,o,G,Z=y[0],ee=S[0],ie=0,re=0;ee>Z==ee>-Z?(R=Z,Z=y[++ie]):(R=ee,ee=S[++re]);let ue=0;if(ie<m&&re<b)for(ee>Z==ee>-Z?(k=Z+R,o=R-(k-Z),Z=y[++ie]):(k=ee+R,o=R-(k-ee),ee=S[++re]),R=k,o!==0&&(M[ue++]=o);ie<m&&re<b;)ee>Z==ee>-Z?(k=R+Z,G=k-R,o=R-(k-G)+(Z-G),Z=y[++ie]):(k=R+ee,G=k-R,o=R-(k-G)+(ee-G),ee=S[++re]),R=k,o!==0&&(M[ue++]=o);for(;ie<m;)k=R+Z,G=k-R,o=R-(k-G)+(Z-G),Z=y[++ie],R=k,o!==0&&(M[ue++]=o);for(;re<b;)k=R+ee,G=k-R,o=R-(k-G)+(ee-G),ee=S[++re],R=k,o!==0&&(M[ue++]=o);return(R!==0||ue===0)&&(M[ue++]=R),ue}function RP(m,y){let b=y[0];for(let S=1;S<m;S++)b+=y[S];return b}function vm(m){return new Float64Array(m)}const DP=(3+16*Ql)*Ql,OP=(2+12*Ql)*Ql,zP=(9+64*Ql)*Ql*Ql,Ud=vm(4),aT=vm(8),lT=vm(12),cT=vm(16),Yo=vm(4);function kP(m,y,b,S,M,R,k){let o,G,Z,ee,ie,re,ue,oe,ge,K,Te,Le,Oe,Ae,ze,Fe,Ye,it;const jt=m-M,Rt=b-M,li=y-R,Xt=S-R;Ae=jt*Xt,re=Do*jt,ue=re-(re-jt),oe=jt-ue,re=Do*Xt,ge=re-(re-Xt),K=Xt-ge,ze=oe*K-(Ae-ue*ge-oe*ge-ue*K),Fe=li*Rt,re=Do*li,ue=re-(re-li),oe=li-ue,re=Do*Rt,ge=re-(re-Rt),K=Rt-ge,Ye=oe*K-(Fe-ue*ge-oe*ge-ue*K),Te=ze-Ye,ie=ze-Te,Ud[0]=ze-(Te+ie)+(ie-Ye),Le=Ae+Te,ie=Le-Ae,Oe=Ae-(Le-ie)+(Te-ie),Te=Oe-Fe,ie=Oe-Te,Ud[1]=Oe-(Te+ie)+(ie-Fe),it=Le+Te,ie=it-Le,Ud[2]=Le-(it-ie)+(Te-ie),Ud[3]=it;let Pt=RP(4,Ud),Ai=OP*k;if(Pt>=Ai||-Pt>=Ai||(ie=m-jt,o=m-(jt+ie)+(ie-M),ie=b-Rt,Z=b-(Rt+ie)+(ie-M),ie=y-li,G=y-(li+ie)+(ie-R),ie=S-Xt,ee=S-(Xt+ie)+(ie-R),o===0&&G===0&&Z===0&&ee===0)||(Ai=zP*k+LP*Math.abs(Pt),Pt+=jt*ee+Xt*o-(li*Z+Rt*G),Pt>=Ai||-Pt>=Ai))return Pt;Ae=o*Xt,re=Do*o,ue=re-(re-o),oe=o-ue,re=Do*Xt,ge=re-(re-Xt),K=Xt-ge,ze=oe*K-(Ae-ue*ge-oe*ge-ue*K),Fe=G*Rt,re=Do*G,ue=re-(re-G),oe=G-ue,re=Do*Rt,ge=re-(re-Rt),K=Rt-ge,Ye=oe*K-(Fe-ue*ge-oe*ge-ue*K),Te=ze-Ye,ie=ze-Te,Yo[0]=ze-(Te+ie)+(ie-Ye),Le=Ae+Te,ie=Le-Ae,Oe=Ae-(Le-ie)+(Te-ie),Te=Oe-Fe,ie=Oe-Te,Yo[1]=Oe-(Te+ie)+(ie-Fe),it=Le+Te,ie=it-Le,Yo[2]=Le-(it-ie)+(Te-ie),Yo[3]=it;const rr=u0(4,Ud,4,Yo,aT);Ae=jt*ee,re=Do*jt,ue=re-(re-jt),oe=jt-ue,re=Do*ee,ge=re-(re-ee),K=ee-ge,ze=oe*K-(Ae-ue*ge-oe*ge-ue*K),Fe=li*Z,re=Do*li,ue=re-(re-li),oe=li-ue,re=Do*Z,ge=re-(re-Z),K=Z-ge,Ye=oe*K-(Fe-ue*ge-oe*ge-ue*K),Te=ze-Ye,ie=ze-Te,Yo[0]=ze-(Te+ie)+(ie-Ye),Le=Ae+Te,ie=Le-Ae,Oe=Ae-(Le-ie)+(Te-ie),Te=Oe-Fe,ie=Oe-Te,Yo[1]=Oe-(Te+ie)+(ie-Fe),it=Le+Te,ie=it-Le,Yo[2]=Le-(it-ie)+(Te-ie),Yo[3]=it;const Li=u0(rr,aT,4,Yo,lT);Ae=o*ee,re=Do*o,ue=re-(re-o),oe=o-ue,re=Do*ee,ge=re-(re-ee),K=ee-ge,ze=oe*K-(Ae-ue*ge-oe*ge-ue*K),Fe=G*Z,re=Do*G,ue=re-(re-G),oe=G-ue,re=Do*Z,ge=re-(re-Z),K=Z-ge,Ye=oe*K-(Fe-ue*ge-oe*ge-ue*K),Te=ze-Ye,ie=ze-Te,Yo[0]=ze-(Te+ie)+(ie-Ye),Le=Ae+Te,ie=Le-Ae,Oe=Ae-(Le-ie)+(Te-ie),Te=Oe-Fe,ie=Oe-Te,Yo[1]=Oe-(Te+ie)+(ie-Fe),it=Le+Te,ie=it-Le,Yo[2]=Le-(it-ie)+(Te-ie),Yo[3]=it;const di=u0(Li,lT,4,Yo,cT);return cT[di-1]}function FP(m,y,b,S,M,R){const k=(y-R)*(b-M),o=(m-M)*(S-R),G=k-o,Z=Math.abs(k+o);return Math.abs(G)>=DP*Z?G:-kP(m,y,b,S,M,R,Z)}function BP(m,y){var b,S,M=0,R,k,o,G,Z,ee,ie,re=m[0],ue=m[1],oe=y.length;for(b=0;b<oe;b++){S=0;var ge=y[b],K=ge.length-1;if(ee=ge[0],ee[0]!==ge[K][0]&&ee[1]!==ge[K][1])throw new Error("First and last coordinates in a ring must be the same");for(k=ee[0]-re,o=ee[1]-ue,S;S<K;S++){if(ie=ge[S+1],G=ie[0]-re,Z=ie[1]-ue,o===0&&Z===0){if(G<=0&&k>=0||k<=0&&G>=0)return 0}else if(Z>=0&&o<=0||Z<=0&&o>=0){if(R=FP(k,G,o,Z,0,0),R===0)return 0;(R>0&&Z>0&&o<=0||R<0&&Z<=0&&o>0)&&M++}ee=ie,o=Z,k=G}}return M%2!==0}function ec(m,y,b={}){if(!m)throw new Error("point is required");if(!y)throw new Error("polygon is required");const S=Os(m),M=Bg(y),R=M.type,k=y.bbox;let o=M.coordinates;if(k&&NP(S,k)===!1)return!1;R==="Polygon"&&(o=[o]);let G=!1;for(var Z=0;Z<o.length;++Z){const ee=BP(S,o[Z]);if(ee===0)return!b.ignoreBoundary;ee&&(G=!0)}return G}function NP(m,y){return y[0]<=m[0]&&y[1]<=m[1]&&y[2]>=m[0]&&y[3]>=m[1]}var VP=ec;function Ng(m,y,b={}){const S=Os(m),M=Wu(y);for(let R=0;R<M.length-1;R++){let k=!1;if(b.ignoreEndVertices&&(R===0&&(k="start"),R===M.length-2&&(k="end"),R===0&&R+1===M.length-1&&(k="both")),UP(M[R],M[R+1],S,k,typeof b.epsilon>"u"?null:b.epsilon))return!0}return!1}function UP(m,y,b,S,M){const R=b[0],k=b[1],o=m[0],G=m[1],Z=y[0],ee=y[1],ie=b[0]-o,re=b[1]-G,ue=Z-o,oe=ee-G,ge=ie*oe-re*ue;if(M!==null){if(Math.abs(ge)>M)return!1}else if(ge!==0)return!1;if(Math.abs(ue)===Math.abs(oe)&&Math.abs(ue)===0)return S?!1:b[0]===m[0]&&b[1]===m[1];if(S){if(S==="start")return Math.abs(ue)>=Math.abs(oe)?ue>0?o<R&&R<=Z:Z<=R&&R<o:oe>0?G<k&&k<=ee:ee<=k&&k<G;if(S==="end")return Math.abs(ue)>=Math.abs(oe)?ue>0?o<=R&&R<Z:Z<R&&R<=o:oe>0?G<=k&&k<ee:ee<k&&k<=G;if(S==="both")return Math.abs(ue)>=Math.abs(oe)?ue>0?o<R&&R<Z:Z<R&&R<o:oe>0?G<k&&k<ee:ee<k&&k<G}else return Math.abs(ue)>=Math.abs(oe)?ue>0?o<=R&&R<=Z:Z<=R&&R<=o:oe>0?G<=k&&k<=ee:ee<=k&&k<=G;return!1}function jP(m,y,b,S,M){uS(m,y,b||0,S||m.length-1,M||GP)}function uS(m,y,b,S,M){for(;S>b;){if(S-b>600){var R=S-b+1,k=y-b+1,o=Math.log(R),G=.5*Math.exp(2*o/3),Z=.5*Math.sqrt(o*G*(R-G)/R)*(k-R/2<0?-1:1),ee=Math.max(b,Math.floor(y-k*G/R+Z)),ie=Math.min(S,Math.floor(y+(R-k)*G/R+Z));uS(m,y,ee,ie,M)}var re=m[y],ue=b,oe=S;for(Qp(m,b,y),M(m[S],re)>0&&Qp(m,b,S);ue<oe;){for(Qp(m,ue,oe),ue++,oe--;M(m[ue],re)<0;)ue++;for(;M(m[oe],re)>0;)oe--}M(m[b],re)===0?Qp(m,b,oe):(oe++,Qp(m,oe,S)),oe<=y&&(b=oe+1),y<=oe&&(S=oe-1)}}function Qp(m,y,b){var S=m[y];m[y]=m[b],m[b]=S}function GP(m,y){return m<y?-1:m>y?1:0}let qP=class{constructor(y=9){this._maxEntries=Math.max(4,y),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(y){let b=this.data;const S=[];if(!Tg(y,b))return S;const M=this.toBBox,R=[];for(;b;){for(let k=0;k<b.children.length;k++){const o=b.children[k],G=b.leaf?M(o):o;Tg(y,G)&&(b.leaf?S.push(o):d0(y,G)?this._all(o,S):R.push(o))}b=R.pop()}return S}collides(y){let b=this.data;if(!Tg(y,b))return!1;const S=[];for(;b;){for(let M=0;M<b.children.length;M++){const R=b.children[M],k=b.leaf?this.toBBox(R):R;if(Tg(y,k)){if(b.leaf||d0(y,k))return!0;S.push(R)}}b=S.pop()}return!1}load(y){if(!(y&&y.length))return this;if(y.length<this._minEntries){for(let S=0;S<y.length;S++)this.insert(y[S]);return this}let b=this._build(y.slice(),0,y.length-1,0);if(!this.data.children.length)this.data=b;else if(this.data.height===b.height)this._splitRoot(this.data,b);else{if(this.data.height<b.height){const S=this.data;this.data=b,b=S}this._insert(b,this.data.height-b.height-1,!0)}return this}insert(y){return y&&this._insert(y,this.data.height-1),this}clear(){return this.data=Gd([]),this}remove(y,b){if(!y)return this;let S=this.data;const M=this.toBBox(y),R=[],k=[];let o,G,Z;for(;S||R.length;){if(S||(S=R.pop(),G=R[R.length-1],o=k.pop(),Z=!0),S.leaf){const ee=HP(y,S.children,b);if(ee!==-1)return S.children.splice(ee,1),R.push(S),this._condense(R),this}!Z&&!S.leaf&&d0(S,M)?(R.push(S),k.push(o),o=0,G=S,S=S.children[0]):G?(o++,S=G.children[o],Z=!1):S=null}return this}toBBox(y){return y}compareMinX(y,b){return y.minX-b.minX}compareMinY(y,b){return y.minY-b.minY}toJSON(){return this.data}fromJSON(y){return this.data=y,this}_all(y,b){const S=[];for(;y;)y.leaf?b.push(...y.children):S.push(...y.children),y=S.pop();return b}_build(y,b,S,M){const R=S-b+1;let k=this._maxEntries,o;if(R<=k)return o=Gd(y.slice(b,S+1)),jd(o,this.toBBox),o;M||(M=Math.ceil(Math.log(R)/Math.log(k)),k=Math.ceil(R/Math.pow(k,M-1))),o=Gd([]),o.leaf=!1,o.height=M;const G=Math.ceil(R/k),Z=G*Math.ceil(Math.sqrt(k));uT(y,b,S,Z,this.compareMinX);for(let ee=b;ee<=S;ee+=Z){const ie=Math.min(ee+Z-1,S);uT(y,ee,ie,G,this.compareMinY);for(let re=ee;re<=ie;re+=G){const ue=Math.min(re+G-1,ie);o.children.push(this._build(y,re,ue,M-1))}}return jd(o,this.toBBox),o}_chooseSubtree(y,b,S,M){for(;M.push(b),!(b.leaf||M.length-1===S);){let R=1/0,k=1/0,o;for(let G=0;G<b.children.length;G++){const Z=b.children[G],ee=h0(Z),ie=WP(y,Z)-ee;ie<k?(k=ie,R=ee<R?ee:R,o=Z):ie===k&&ee<R&&(R=ee,o=Z)}b=o||b.children[0]}return b}_insert(y,b,S){const M=S?y:this.toBBox(y),R=[],k=this._chooseSubtree(M,this.data,b,R);for(k.children.push(y),sm(k,M);b>=0&&R[b].children.length>this._maxEntries;)this._split(R,b),b--;this._adjustParentBBoxes(M,R,b)}_split(y,b){const S=y[b],M=S.children.length,R=this._minEntries;this._chooseSplitAxis(S,R,M);const k=this._chooseSplitIndex(S,R,M),o=Gd(S.children.splice(k,S.children.length-k));o.height=S.height,o.leaf=S.leaf,jd(S,this.toBBox),jd(o,this.toBBox),b?y[b-1].children.push(o):this._splitRoot(S,o)}_splitRoot(y,b){this.data=Gd([y,b]),this.data.height=y.height+1,this.data.leaf=!1,jd(this.data,this.toBBox)}_chooseSplitIndex(y,b,S){let M,R=1/0,k=1/0;for(let o=b;o<=S-b;o++){const G=om(y,0,o,this.toBBox),Z=om(y,o,S,this.toBBox),ee=XP(G,Z),ie=h0(G)+h0(Z);ee<R?(R=ee,M=o,k=ie<k?ie:k):ee===R&&ie<k&&(k=ie,M=o)}return M||S-b}_chooseSplitAxis(y,b,S){const M=y.leaf?this.compareMinX:ZP,R=y.leaf?this.compareMinY:$P,k=this._allDistMargin(y,b,S,M),o=this._allDistMargin(y,b,S,R);k<o&&y.children.sort(M)}_allDistMargin(y,b,S,M){y.children.sort(M);const R=this.toBBox,k=om(y,0,b,R),o=om(y,S-b,S,R);let G=wg(k)+wg(o);for(let Z=b;Z<S-b;Z++){const ee=y.children[Z];sm(k,y.leaf?R(ee):ee),G+=wg(k)}for(let Z=S-b-1;Z>=b;Z--){const ee=y.children[Z];sm(o,y.leaf?R(ee):ee),G+=wg(o)}return G}_adjustParentBBoxes(y,b,S){for(let M=S;M>=0;M--)sm(b[M],y)}_condense(y){for(let b=y.length-1,S;b>=0;b--)y[b].children.length===0?b>0?(S=y[b-1].children,S.splice(S.indexOf(y[b]),1)):this.clear():jd(y[b],this.toBBox)}};function HP(m,y,b){if(!b)return y.indexOf(m);for(let S=0;S<y.length;S++)if(b(m,y[S]))return S;return-1}function jd(m,y){om(m,0,m.children.length,y,m)}function om(m,y,b,S,M){M||(M=Gd(null)),M.minX=1/0,M.minY=1/0,M.maxX=-1/0,M.maxY=-1/0;for(let R=y;R<b;R++){const k=m.children[R];sm(M,m.leaf?S(k):k)}return M}function sm(m,y){return m.minX=Math.min(m.minX,y.minX),m.minY=Math.min(m.minY,y.minY),m.maxX=Math.max(m.maxX,y.maxX),m.maxY=Math.max(m.maxY,y.maxY),m}function ZP(m,y){return m.minX-y.minX}function $P(m,y){return m.minY-y.minY}function h0(m){return(m.maxX-m.minX)*(m.maxY-m.minY)}function wg(m){return m.maxX-m.minX+(m.maxY-m.minY)}function WP(m,y){return(Math.max(y.maxX,m.maxX)-Math.min(y.minX,m.minX))*(Math.max(y.maxY,m.maxY)-Math.min(y.minY,m.minY))}function XP(m,y){const b=Math.max(m.minX,y.minX),S=Math.max(m.minY,y.minY),M=Math.min(m.maxX,y.maxX),R=Math.min(m.maxY,y.maxY);return Math.max(0,M-b)*Math.max(0,R-S)}function d0(m,y){return m.minX<=y.minX&&m.minY<=y.minY&&y.maxX<=m.maxX&&y.maxY<=m.maxY}function Tg(m,y){return y.minX<=m.maxX&&y.minY<=m.maxY&&y.maxX>=m.minX&&y.maxY>=m.minY}function Gd(m){return{children:m,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function uT(m,y,b,S,M){const R=[y,b];for(;R.length;){if(b=R.pop(),y=R.pop(),b-y<=S)continue;const k=y+Math.ceil((b-y)/S/2)*S;jP(m,k,y,b,M),R.push(y,k,k,b)}}function f0(m){var y;if(m.bbox)y=m.bbox;else if(Array.isArray(m)&&m.length===4)y=m;else if(Array.isArray(m)&&m.length===6)y=[m[0],m[1],m[3],m[4]];else if(m.type==="Feature")y=sa(m);else if(m.type==="FeatureCollection")y=sa(m);else throw new Error("invalid geojson");return{minX:y[0],minY:y[1],maxX:y[2],maxY:y[3]}}var YP=class{constructor(m=9){this.tree=new qP(m),this.tree.toBBox=f0}insert(m){if(m.type!=="Feature")throw new Error("invalid feature");return m.bbox=m.bbox?m.bbox:sa(m),this.tree.insert(m),this}load(m){var y=[];return Array.isArray(m)?m.forEach(function(b){if(b.type!=="Feature")throw new Error("invalid features");b.bbox=b.bbox?b.bbox:sa(b),y.push(b)}):Zc(m,function(b){if(b.type!=="Feature")throw new Error("invalid features");b.bbox=b.bbox?b.bbox:sa(b),y.push(b)}),this.tree.load(y),this}remove(m,y){if(m.type!=="Feature")throw new Error("invalid feature");return m.bbox=m.bbox?m.bbox:sa(m),this.tree.remove(m,y),this}clear(){return this.tree.clear(),this}search(m){var y=this.tree.search(f0(m));return No(y)}collides(m){return this.tree.collides(f0(m))}all(){const m=this.tree.all();return No(m)}toJSON(){return this.tree.toJSON()}fromJSON(m){return this.tree.fromJSON(m),this}};function hS(m){return new YP(m)}function JP(m,y){if(y=y??{},!YM(y))throw new Error("options is invalid");var b=y.precision,S=y.coordinates,M=y.mutate;if(b=b==null||isNaN(b)?6:b,S=S==null||isNaN(S)?3:S,!m)throw new Error("<geojson> is required");if(typeof b!="number")throw new Error("<precision> must be a number");if(typeof S!="number")throw new Error("<coordinates> must be a number");(M===!1||M===void 0)&&(m=JSON.parse(JSON.stringify(m)));var R=Math.pow(10,b);return qc(m,function(k){KP(k,R,S)}),m}function KP(m,y,b){m.length>b&&m.splice(b,m.length);for(var S=0;S<m.length;S++)m[S]=Math.round(m[S]*y)/y;return m}function QP(m){if(!m)throw new Error("geojson is required");const y=[];return Yg(m,b=>{eL(b,y)}),No(y)}function eL(m,y){let b=[];const S=m.geometry;if(S!==null){switch(S.type){case"Polygon":b=Wu(S);break;case"LineString":b=[Wu(S)]}b.forEach(M=>{tL(M,m.properties).forEach(k=>{k.id=y.length,y.push(k)})})}}function tL(m,y){const b=[];return m.reduce((S,M)=>{const R=dm([S,M],y);return R.bbox=iL(S,M),b.push(R),M}),b}function iL(m,y){const b=m[0],S=m[1],M=y[0],R=y[1],k=b<M?b:M,o=S<R?S:R,G=b>M?b:M,Z=S>R?S:R;return[k,o,G,Z]}class dS{constructor(y=[],b=rL){if(this.data=y,this.length=this.data.length,this.compare=b,this.length>0)for(let S=(this.length>>1)-1;S>=0;S--)this._down(S)}push(y){this.data.push(y),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const y=this.data[0],b=this.data.pop();return this.length--,this.length>0&&(this.data[0]=b,this._down(0)),y}peek(){return this.data[0]}_up(y){const{data:b,compare:S}=this,M=b[y];for(;y>0;){const R=y-1>>1,k=b[R];if(S(M,k)>=0)break;b[y]=k,y=R}b[y]=M}_down(y){const{data:b,compare:S}=this,M=this.length>>1,R=b[y];for(;y<M;){let k=(y<<1)+1,o=b[k];const G=k+1;if(G<this.length&&S(b[G],o)<0&&(k=G,o=b[G]),S(o,R)>=0)break;b[y]=o,y=k}b[y]=R}}function rL(m,y){return m<y?-1:m>y?1:0}function fS(m,y){return m.p.x>y.p.x?1:m.p.x<y.p.x?-1:m.p.y!==y.p.y?m.p.y>y.p.y?1:-1:1}function nL(m,y){return m.rightSweepEvent.p.x>y.rightSweepEvent.p.x?1:m.rightSweepEvent.p.x<y.rightSweepEvent.p.x?-1:m.rightSweepEvent.p.y!==y.rightSweepEvent.p.y?m.rightSweepEvent.p.y<y.rightSweepEvent.p.y?1:-1:1}class hT{constructor(y,b,S,M){this.p={x:y[0],y:y[1]},this.featureId=b,this.ringId=S,this.eventId=M,this.otherEvent=null,this.isLeftEndpoint=null}isSamePoint(y){return this.p.x===y.p.x&&this.p.y===y.p.y}}function oL(m,y){if(m.type==="FeatureCollection"){const b=m.features;for(let S=0;S<b.length;S++)dT(b[S],y)}else dT(m,y)}let Eg=0,Sg=0,Ig=0;function dT(m,y){const b=m.type==="Feature"?m.geometry:m;let S=b.coordinates;(b.type==="Polygon"||b.type==="MultiLineString")&&(S=[S]),b.type==="LineString"&&(S=[[S]]);for(let M=0;M<S.length;M++)for(let R=0;R<S[M].length;R++){let k=S[M][R][0],o=null;Sg=Sg+1;for(let G=0;G<S[M][R].length-1;G++){o=S[M][R][G+1];const Z=new hT(k,Eg,Sg,Ig),ee=new hT(o,Eg,Sg,Ig+1);Z.otherEvent=ee,ee.otherEvent=Z,fS(Z,ee)>0?(ee.isLeftEndpoint=!0,Z.isLeftEndpoint=!1):(Z.isLeftEndpoint=!0,ee.isLeftEndpoint=!1),y.push(Z),y.push(ee),k=o,Ig=Ig+1}}Eg=Eg+1}class sL{constructor(y){this.leftSweepEvent=y,this.rightSweepEvent=y.otherEvent}}function aL(m,y){if(m===null||y===null||m.leftSweepEvent.ringId===y.leftSweepEvent.ringId&&(m.rightSweepEvent.isSamePoint(y.leftSweepEvent)||m.rightSweepEvent.isSamePoint(y.leftSweepEvent)||m.rightSweepEvent.isSamePoint(y.rightSweepEvent)||m.leftSweepEvent.isSamePoint(y.leftSweepEvent)||m.leftSweepEvent.isSamePoint(y.rightSweepEvent)))return!1;const b=m.leftSweepEvent.p.x,S=m.leftSweepEvent.p.y,M=m.rightSweepEvent.p.x,R=m.rightSweepEvent.p.y,k=y.leftSweepEvent.p.x,o=y.leftSweepEvent.p.y,G=y.rightSweepEvent.p.x,Z=y.rightSweepEvent.p.y,ee=(Z-o)*(M-b)-(G-k)*(R-S),ie=(G-k)*(S-o)-(Z-o)*(b-k),re=(M-b)*(S-o)-(R-S)*(b-k);if(ee===0)return!1;const ue=ie/ee,oe=re/ee;if(ue>=0&&ue<=1&&oe>=0&&oe<=1){const ge=b+ue*(M-b),K=S+ue*(R-S);return[ge,K]}return!1}function lL(m,y){y=y||!1;const b=[],S=new dS([],nL);for(;m.length;){const M=m.pop();if(M.isLeftEndpoint){const R=new sL(M);for(let k=0;k<S.data.length;k++){const o=S.data[k];if(y&&o.leftSweepEvent.featureId===M.featureId)continue;const G=aL(R,o);G!==!1&&b.push(G)}S.push(R)}else M.isLeftEndpoint===!1&&S.pop()}return b}function cL(m,y){const b=new dS([],fS);return oL(m,b),lL(b,y)}var uL=cL;function hL(m,y,b={}){const{removeDuplicates:S=!0,ignoreSelfIntersections:M=!0}=b;let R=[];m.type==="FeatureCollection"?R=R.concat(m.features):m.type==="Feature"?R.push(m):(m.type==="LineString"||m.type==="Polygon"||m.type==="MultiLineString"||m.type==="MultiPolygon")&&R.push(fl(m)),y.type==="FeatureCollection"?R=R.concat(y.features):y.type==="Feature"?R.push(y):(y.type==="LineString"||y.type==="Polygon"||y.type==="MultiLineString"||y.type==="MultiPolygon")&&R.push(fl(y));const k=uL(No(R),M);let o=[];if(S){const G={};k.forEach(Z=>{const ee=Z.join(",");G[ee]||(G[ee]=!0,o.push(Z))})}else o=k;return No(o.map(G=>Jo(G)))}var dL=Object.defineProperty,fL=Object.defineProperties,pL=Object.getOwnPropertyDescriptors,fT=Object.getOwnPropertySymbols,mL=Object.prototype.hasOwnProperty,_L=Object.prototype.propertyIsEnumerable,pT=(m,y,b)=>y in m?dL(m,y,{enumerable:!0,configurable:!0,writable:!0,value:b}):m[y]=b,gL=(m,y)=>{for(var b in y||(y={}))mL.call(y,b)&&pT(m,b,y[b]);if(fT)for(var b of fT(y))_L.call(y,b)&&pT(m,b,y[b]);return m},yL=(m,y)=>fL(m,pL(y));function vL(m,y,b={}){if(!m||!y)throw new Error("lines and inputPoint are required arguments");const S=Os(y);let M=Jo([1/0,1/0],{lineStringIndex:-1,segmentIndex:-1,totalDistance:-1,lineDistance:-1,segmentDistance:-1,pointDistance:1/0,multiFeatureIndex:-1,index:-1,location:-1,dist:1/0}),R=0,k=0,o=-1;return Yg(m,function(G,Z,ee){o!==ee&&(o=ee,k=0);const ie=Wu(G),re=ie.length-2;for(let ue=0;ue<ie.length-1;ue++){const oe=Jo(ie[ue]),ge=Os(oe),K=Jo(ie[ue+1]),Te=Os(K),Le=Zd(oe,K,b);let Oe,Ae;Te[0]===S[0]&&Te[1]===S[1]?[Oe,Ae]=[Te,!0]:ge[0]===S[0]&&ge[1]===S[1]?[Oe,Ae]=[ge,!1]:[Oe,Ae]=wL(ge,Te,S);const ze=Zd(y,Oe,b);if(ze<M.properties.pointDistance){const Fe=Zd(oe,Oe,b);M=Jo(Oe,{lineStringIndex:ee,segmentIndex:Ae&&ue+1<=re?ue+1:ue,totalDistance:R+Fe,lineDistance:k+Fe,segmentDistance:Fe,pointDistance:ze,multiFeatureIndex:-1,index:-1,location:-1,dist:1/0}),M.properties=yL(gL({},M.properties),{multiFeatureIndex:M.properties.lineStringIndex,index:M.properties.segmentIndex,location:M.properties.totalDistance,dist:M.properties.pointDistance})}R+=Le,k+=Le}}),M}function Zu(m,y){const[b,S,M]=m,[R,k,o]=y;return b*R+S*k+M*o}function em(m,y){const[b,S,M]=m,[R,k,o]=y;return[S*o-M*k,M*R-b*o,b*k-S*R]}function xL(m){return Math.sqrt(Math.pow(m[0],2)+Math.pow(m[1],2)+Math.pow(m[2],2))}function mT(m){const y=xL(m);return[m[0]/y,m[1]/y,m[2]/y]}function p0(m){const y=Ds(m[1]),b=Ds(m[0]);return[Math.cos(y)*Math.cos(b),Math.cos(y)*Math.sin(b),Math.sin(y)]}function bL(m){const[y,b,S]=m,M=Math.min(Math.max(S,-1),1),R=fm(Math.asin(M));return[fm(Math.atan2(b,y)),R]}function wL(m,y,b){const S=p0(m),M=p0(y),R=p0(b),k=em(S,M);if(k[0]===0&&k[1]===0&&k[2]===0)return Zu(S,M)>0?[[...y],!0]:[[...b],!1];const o=em(k,R);if(o[0]===0&&o[1]===0&&o[2]===0)return[[...y],!0];const G=em(o,k),Z=mT(G),ee=[-Z[0],-Z[1],-Z[2]],ie=Zu(R,Z)>Zu(R,ee)?Z:ee,re=mT(k),ue=Zu(em(S,ie),re),oe=Zu(em(ie,M),re);return ue>=0&&oe>=0?[bL(ie),!1]:Zu(S,R)>Zu(M,R)?[[...m],!1]:[[...y],!0]}function pS(m,y){if(!m)throw new Error("line is required");if(!y)throw new Error("splitter is required");const b=sT(m),S=sT(y);if(b!=="LineString")throw new Error("line must be LineString");if(S==="FeatureCollection")throw new Error("splitter cannot be a FeatureCollection");if(S==="GeometryCollection")throw new Error("splitter cannot be a GeometryCollection");var M=JP(y,{precision:7});switch(m.type!=="Feature"&&(m=fl(m)),S){case"Point":return hx(m,M);case"MultiPoint":return _T(m,M);case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":return _T(m,hL(m,M,{ignoreSelfIntersections:!0}))}}function _T(m,y){var b=[],S=hS();return Yg(y,function(M){if(b.forEach(function(o,G){o.id=G}),!b.length)b=hx(m,M).features,S.load(No(b));else{var R=S.search(M);if(R.features.length){var k=mS(M,R);b=b.filter(function(o){return o.id!==k.id}),S.remove(k),Zc(hx(k,M),function(o){b.push(o),S.insert(o)})}}}),No(b)}function hx(m,y){var b=[],S=Wu(m)[0],M=Wu(m)[m.geometry.coordinates.length-1];if(m0(S,Os(y))||m0(M,Os(y)))return No([m]);var R=hS(),k=QP(m);R.load(k);var o=R.search(y);if(!o.features.length)return No([m]);var G=mS(y,o),Z=[S],ee=JM(k,function(ie,re,ue){var oe=Wu(re)[1],ge=Os(y);return ue===G.id?(ie.push(ge),b.push(dm(ie)),m0(ge,oe)?[ge]:[ge,oe]):(ie.push(oe),ie)},Z);return ee.length>1&&b.push(dm(ee)),No(b)}function mS(m,y){if(!y.features.length)throw new Error("lines must contain features");if(y.features.length===1)return y.features[0];var b,S=1/0;return Zc(y,function(M){var R=vL(M,m),k=R.properties.dist;k<S&&(b=M,S=k)}),b}function m0(m,y){return m[0]===y[0]&&m[1]===y[1]}function gT(m,y){var b=Bg(m),S=Bg(y),M=b.type,R=S.type;switch(M){case"Point":switch(R){case"MultiPoint":return TL(b,S);case"LineString":return Ng(b,S,{ignoreEndVertices:!0});case"Polygon":case"MultiPolygon":return ec(b,S,{ignoreBoundary:!0});default:throw new Error("feature2 "+R+" geometry not supported")}case"MultiPoint":switch(R){case"MultiPoint":return EL(b,S);case"LineString":return SL(b,S);case"Polygon":case"MultiPolygon":return IL(b,S);default:throw new Error("feature2 "+R+" geometry not supported")}case"LineString":switch(R){case"LineString":return AL(b,S);case"Polygon":case"MultiPolygon":return ML(b,S);default:throw new Error("feature2 "+R+" geometry not supported")}case"Polygon":switch(R){case"Polygon":case"MultiPolygon":return PL(b,S);default:throw new Error("feature2 "+R+" geometry not supported")}default:throw new Error("feature1 "+M+" geometry not supported")}}function TL(m,y){var b,S=!1;for(b=0;b<y.coordinates.length;b++)if(gS(y.coordinates[b],m.coordinates)){S=!0;break}return S}function EL(m,y){for(var b=0;b<m.coordinates.length;b++){for(var S=!1,M=0;M<y.coordinates.length;M++)gS(m.coordinates[b],y.coordinates[M])&&(S=!0);if(!S)return!1}return!0}function SL(m,y){for(var b=!1,S=0;S<m.coordinates.length;S++){if(!Ng(m.coordinates[S],y))return!1;b||(b=Ng(m.coordinates[S],y,{ignoreEndVertices:!0}))}return b}function IL(m,y){for(var b=!0,S=!1,M=0;M<m.coordinates.length;M++){if(S=ec(m.coordinates[M],y),!S){b=!1;break}S=ec(m.coordinates[M],y,{ignoreBoundary:!0})}return b&&S}function AL(m,y){for(var b=0;b<m.coordinates.length;b++)if(!Ng(m.coordinates[b],y))return!1;return!0}function CL(m,y){const b=m.coordinates,S=[];for(let M=0;M<b.length-1;M++){const R=dm([b[M],b[M+1]]),k=pS(R,fl(y));k.features.length===0?S.push(R):S.push(...k.features)}return No(S)}function ML(m,y){const b=sa(y),S=sa(m);if(!_S(b,S))return!1;for(const k of m.coordinates)if(!ec(k,y))return!1;let M=!1;const R=CL(m,y);for(const k of R.features){const o=LL(k.geometry.coordinates[0],k.geometry.coordinates[1]);if(!ec(o,y))return!1;!M&&ec(o,y,{ignoreBoundary:!0})&&(M=!0)}return M}function PL(m,y){var b=sa(m),S=sa(y);if(!_S(S,b))return!1;for(var M=0;M<m.coordinates[0].length;M++)if(!ec(m.coordinates[0][M],y))return!1;return!0}function _S(m,y){return!(m[0]>y[0]||m[2]<y[2]||m[1]>y[1]||m[3]<y[3])}function gS(m,y){return m[0]===y[0]&&m[1]===y[1]}function LL(m,y){return[(m[0]+y[0])/2,(m[1]+y[1])/2]}function RL(m,y={}){const b=sa(m),S=(b[0]+b[2])/2,M=(b[1]+b[3])/2;return Jo([S,M],y.properties,y)}function DL(m,y,b={}){const S=b.steps||64,M=b.properties?b.properties:!Array.isArray(m)&&m.type==="Feature"&&m.properties?m.properties:{},R=[];for(let k=0;k<S;k++)R.push(lS(m,y,k*-360/S,b).geometry.coordinates);return R.push(R[0]),XE([R],M)}var OL=DL;function zL(m){const y=[];return m.type==="FeatureCollection"?Zc(m,function(b){qc(b,function(S){y.push(Jo(S,b.properties))})}):m.type==="Feature"?qc(m,function(b){y.push(Jo(b,m.properties))}):qc(m,function(b){y.push(Jo(b))}),No(y)}function kL(m,y={}){return eP(m,(b,S)=>{const M=S.geometry.coordinates;return b+Zd(M[0],M[1],y)},0)}var FL=kL,BL=Object.defineProperty,NL=Object.defineProperties,VL=Object.getOwnPropertyDescriptors,yT=Object.getOwnPropertySymbols,UL=Object.prototype.hasOwnProperty,jL=Object.prototype.propertyIsEnumerable,vT=(m,y,b)=>y in m?BL(m,y,{enumerable:!0,configurable:!0,writable:!0,value:b}):m[y]=b,xT=(m,y)=>{for(var b in y||(y={}))UL.call(y,b)&&vT(m,b,y[b]);if(yT)for(var b of yT(y))jL.call(y,b)&&vT(m,b,y[b]);return m},bT=(m,y)=>NL(m,VL(y));function GL(m,y,b={}){if(!m)throw new Error("targetPoint is required");if(!y)throw new Error("points is required");let S=1/0,M=0;Zc(y,(k,o)=>{const G=Zd(m,k,b);G<S&&(M=o,S=G)});const R=YE(y.features[M]);return bT(xT({},R),{properties:bT(xT({},R.properties),{featureIndex:M,distanceToPoint:S})})}function qL(m){const y=HL(m),b=RL(y);let S=!1,M=0;for(;!S&&M<y.features.length;){const R=y.features[M].geometry;let k,o,G,Z,ee,ie,re=!1;if(R.type==="Point")b.geometry.coordinates[0]===R.coordinates[0]&&b.geometry.coordinates[1]===R.coordinates[1]&&(S=!0);else if(R.type==="MultiPoint"){let ue=!1,oe=0;for(;!ue&&oe<R.coordinates.length;)b.geometry.coordinates[0]===R.coordinates[oe][0]&&b.geometry.coordinates[1]===R.coordinates[oe][1]&&(S=!0,ue=!0),oe++}else if(R.type==="LineString"){let ue=0;for(;!re&&ue<R.coordinates.length-1;)k=b.geometry.coordinates[0],o=b.geometry.coordinates[1],G=R.coordinates[ue][0],Z=R.coordinates[ue][1],ee=R.coordinates[ue+1][0],ie=R.coordinates[ue+1][1],wT(k,o,G,Z,ee,ie)&&(re=!0,S=!0),ue++}else if(R.type==="MultiLineString"){let ue=0;for(;ue<R.coordinates.length;){re=!1;let oe=0;const ge=R.coordinates[ue];for(;!re&&oe<ge.length-1;)k=b.geometry.coordinates[0],o=b.geometry.coordinates[1],G=ge[oe][0],Z=ge[oe][1],ee=ge[oe+1][0],ie=ge[oe+1][1],wT(k,o,G,Z,ee,ie)&&(re=!0,S=!0),oe++;ue++}}else(R.type==="Polygon"||R.type==="MultiPolygon")&&ec(b,R)&&(S=!0);M++}if(S)return b;{const R=No([]);for(let k=0;k<y.features.length;k++)R.features=R.features.concat(zL(y.features[k]).features);return Jo(GL(b,R).geometry.coordinates)}}function HL(m){return m.type!=="FeatureCollection"?m.type!=="Feature"?No([fl(m)]):No([m]):m}function wT(m,y,b,S,M,R){const k=Math.sqrt((M-b)*(M-b)+(R-S)*(R-S)),o=Math.sqrt((m-b)*(m-b)+(y-S)*(y-S)),G=Math.sqrt((M-m)*(M-m)+(R-y)*(R-y));return k===o+G}var ZL=Zi('<div id="map" class="Map svelte-c20cna"><!></div>');function $L(m,y){Co(y,!0);const b={onSetup(){return{start:null,rectangle:null}},onMouseDown(ii,Si){ii.start=Si.lngLat,ii.rectangle=this.newFeature({type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[[0,0],[0,0],[0,0],[0,0],[0,0]]]}}),this.addFeature(ii.rectangle)},onDrag(ii,Si){if(!ii.start||!ii.rectangle)return;const si=ii.start,Ti=Si.lngLat;if(!Ti)return;const ui=[[si.lng,si.lat],[Ti.lng,si.lat],[Ti.lng,Ti.lat],[si.lng,Ti.lat],[si.lng,si.lat]];ui.some(ki=>ki.includes(void 0))||ii.rectangle.setCoordinates([ui])},onMouseUp(ii){ii.rectangle&&(this.map.fire("draw.create",{features:[ii.rectangle.toGeoJSON()]}),this.changeMode("simple_select"))},toDisplayFeatures(ii,Si,si){si(Si)}};let S=ao(!1);const M=150,R=(ii,Si)=>{!ii||!ii.isStyleLoaded()?setTimeout(()=>R(ii,Si),M):Si()};nm.accessToken=LE;let k=ao(null),o=ao(null);const G={"line-join":"round","line-cap":"round"},Z=["!=",["get","selectionOnly"],!0],ee=Xr(()=>OE(Hd.current)),ie=(ii,Si,si,Ti)=>["case",["all",["has","permitted"],["==",["get","permitted"],!0],["has","paid"],["==",["get","paid"],!0]],ii,["all",["has","permitted"],["==",["get","permitted"],!0]],Si,["all",["has","paid"],["==",["get","paid"],!0]],si,Ti],re=(ii,Si,si,Ti,ui)=>ii&&Si?["case",["to-boolean",["get","accessible"]],Ti,["to-boolean",["get","loadingZone"]],si,ui]:Si?["case",["to-boolean",["get","accessible"]],Ti,ui]:ii?["case",["to-boolean",["get","loadingZone"]],si,ui]:ui,ue=(ii,Si)=>ii&&Si?["to-boolean",["get","canPark"]]:ii?["all",["to-boolean",["get","canPark"]],["!",["to-boolean",["get","paid"]]]]:Si?["all",["to-boolean",["get","canPark"]],["!",["to-boolean",["get","permitted"]]]]:["all",["to-boolean",["get","canPark"]],["!",["to-boolean",["get","permitted"]]],["!",["to-boolean",["get","paid"]]]],oe=Xr(()=>{const{paid:ii,permitted:Si}=nt(ee);return["case",ue(Si,ii),Bc.curbZoneWidth,Bc.notAllowedCurbZoneWidth]}),ge=Xr(()=>{const{paid:ii,permitted:Si}=nt(ee);return["case",ue(Si,ii),s0.curbZoneDasharray,s0.notAllowedCurbZoneDasharray]}),K=Xr(()=>{const{paid:ii,permitted:Si,accessible:si,loadingZone:Ti}=nt(ee);let ui=ie(hn.parkingAllowedPermittedPaid,hn.parkingAllowedPermitted,hn.parkingAllowedPaid,hn.parkingAllowed),ki=ie(hn.parkingAllowedPermittedPaidLight,hn.parkingAllowedPermittedLight,hn.parkingAllowedPaidLight,hn.parkingAllowedLight),wr=hn.parkingNotAllowed,Hn=ue(Si,ii);return(Ti||si)&&(ui=re(Ti,si,hn.loading,hn.accessible,ki),wr=hn.parkingNotAllowedLight),["case",["boolean",["feature-state","hover"],!1],hn.hoverHighlightColor,Hn,ui,wr]}),Te=Xr(()=>{const{accessible:ii,loadingZone:Si}=nt(ee);let si="transparent",Ti="#ffffff";return re(Si,ii,Ti,Ti,si)}),Le=Xr(()=>{const{accessible:ii,loadingZone:Si}=nt(ee);return["case",["boolean",["feature-state","hover"],!1],hn.hoverHighlightColor,re(Si,ii,hn.loading,hn.accessible,"transparent")]}),Oe=Xr(()=>{const{accessible:ii,loadingZone:Si}=nt(ee);let si="none";return Si&&ii?si=["case",["to-boolean",["get","accessible"]],["image","wheelchair 24x24",{params:{"color-2":hn.accessibleIconFill,"color-1":hn.accessibleIconStroke}}],["image","loading 24x24",{params:{"color-2":hn.loadingIconFill,"color-1":hn.loadingIconStroke}}]]:ii?si=["image","wheelchair 24x24",{params:{"color-2":hn.accessibleIconFill,"color-1":hn.accessibleIconStroke}}]:Si&&(si=["image","loading 24x24",{params:{"color-2":hn.loadingIconFill,"color-1":hn.loadingIconStroke}}]),si}),Ae=Xr(()=>{const{accessible:ii,loadingZone:Si}=nt(ee);let si=!1;return Si&&ii?si=["any",["to-boolean",["get","accessible"]],["to-boolean",["get","loadingZone"]]]:ii?si=["to-boolean",["get","accessible"]]:Si&&(si=["to-boolean",["get","loadingZone"]]),si}),ze=ME(()=>{const ii=Zt.map.getCenter(),Si=Zt.map.getZoom();Zt.position={center:ii,zoom:Si}},ix);qg(()=>{Zt.map=new nm.Map({attributionControl:!1,container:"map",style:"mapbox://styles/oetboston/cmla1zirs007d01st6h9kg2ij",center:Zt.position.center,zoom:Zt.position.zoom,maxBounds:[Og.slice(0,2),Og.slice(2)],maxZoom:17}),Zt.map.addControl(new nm.AttributionControl({customAttribution:'Designed by <a href="https://stamen.com">Stamen</a>'}));const ii=pm.modes;ii.draw_rectangle=xP,ii.draw_drag_rectangle=b,Zt.draw=new pm({modes:ii}),Zt.map.addControl(Zt.draw,"top-left"),Zt.map.on("move",ze),Zt.map.on("load",()=>{Zt.map.dragRotate.disable(),Zt.map.touchZoomRotate.disableRotation(),Zt.map.touchPitch.disable(),Zt.map.keyboard.disable()})});const Fe="_selectedarea",Ye="_selectedarea_outline",it="_curbzones",jt="_curb_zones_layer",Rt="_curb_zones_emphasis_layer",li="_curb_zones_emphasis_outline_layer",Xt="_curb_zones_symbol_layer",Pt="_selectedcurbzone",Ai="_selectedcurbzone_layer",rr="_selectedcurbzone_stroke_layer",Li="_selectedcurbzone_endpoint",di="_selectedcurbzone_endpoint_layer",Bi="_selectedcurbzone_stroke_endpoint_layer",jr=ii=>{Zt.map.getLayer(Ai)&&(Zt.map.removeLayer(Ai),Zt.map.removeLayer(rr),Zt.map.removeSource(Pt),Zt.map.removeLayer(di),Zt.map.removeLayer(Bi),Zt.map.removeSource(Li));const{geometry:Si,properties:si}=ii;Oo.geometry=Si,Oo.properties=si;const ui={type:"geojson",data:Si};Zt.map.addSource(Pt,ui);const wr={type:"geojson",data:{type:"FeatureCollection",features:[Si.coordinates[0],Si.coordinates[Si.coordinates.length-1]].map(Jr=>({type:"Feature",properties:{},geometry:{coordinates:Jr,type:"Point"}}))}};Zt.map.addSource(Li,wr);const Hn={id:rr,minzoom:Jl,type:"line",source:Pt,layout:G,paint:{"line-color":hn.highlightColorStroke,"line-width":Bc.selectedCurbZoneStroke}};Zt.map.addLayer(Hn);const kr={id:Bi,minzoom:Jl,type:"circle",source:Li,paint:{"circle-radius":6,"circle-color":hn.highlightColorStroke}};Zt.map.addLayer(kr);const Rn={id:Ai,minzoom:Jl,type:"line",source:Pt,layout:G,paint:{"line-color":hn.highlightColor,"line-width":Bc.selectedCurbZoneWidth}};Zt.map.addLayer(Rn);const yo={id:di,minzoom:Jl,type:"circle",source:Li,paint:{"circle-radius":4,"circle-color":hn.highlightColor}};Zt.map.addLayer(yo);let{curb_policy_ids:Gr="[]"}=si;Gr=JSON.parse(Gr),Gr&&Gr.length?Dx(Gr).then(Jr=>{Oo.policies=Jr}):Oo.policies=[]},Ln=(ii,Si)=>{Zt.map.on("mouseenter",ii,si=>{si.features.length>0&&(nt(o)!==null&&Zt.map.setFeatureState({source:Si,id:nt(o)},{hover:!1}),Yr(o,si.features[0].id,!0),Zt.map.setFeatureState({source:Si,id:nt(o)},{hover:!0}))}),Zt.map.on("mouseleave",ii,()=>{nt(o)!==null&&Zt.map.setFeatureState({source:Si,id:nt(o)},{hover:!1}),Yr(o,null)})},Nn=async(ii,Si,si)=>{let Ti=null;if(ii==="area"){const{min_lng:ki,min_lat:wr,max_lng:Hn,max_lat:kr}=gr.selected.geometry.coordinates[0].reduce((Rn,yo)=>{const[Gr,Jr]=yo;return Gr<Rn.min_lng&&(Rn.min_lng=Gr),Gr>Rn.max_lng&&(Rn.max_lng=Gr),Jr<Rn.min_lat&&(Rn.min_lat=Jr),Jr>Rn.max_lat&&(Rn.max_lat=Jr),Rn},{min_lng:1/0,min_lat:1/0,max_lng:-1/0,max_lat:-1/0});Ti=()=>wP(ki,wr,Hn,kr,Si,si)}else if(ii==="radius"){const[ki,wr]=ko.results,Hn=gr.radius*160934.4;Ti=()=>TP(ki,wr,Hn,Si,si)}if(!Ti)return;await Ti().then(ki=>{if(!ki||!ki.features.length){Yr(S,!0);return}const wr=JSON.parse(JSON.stringify(gr.selected));let Hn=[];Zc(JSON.parse(JSON.stringify(ki)),Gr=>{const{properties:Jr}=Gr;if(gT(Gr,wr)){const Kr={...Gr,properties:{...Jr,innerLine:!0}};Hn.push(Kr)}else{let Kr=pS(Gr,wr);const yl={...Gr,properties:{...Jr,selectionOnly:!0}};Hn.push(yl),Zc(Kr,Vo=>{Vo.properties=Jr;let _s=qL(Vo);gT(_s,wr)&&Hn.push(Vo)})}});const kr=No(Hn),Rn={type:"geojson",data:kr,generateId:!0},yo=Zt.map.getSource(it);if(yo)yo.setData(kr);else{Zt.map.addSource(it,Rn);const Gr={id:jt,minzoom:Jl,type:"line",source:it,filter:Z,layout:G,paint:{"line-color":nt(K),"line-width":nt(oe),"line-dasharray":nt(ge)}};Zt.map.addLayer(Gr);const Jr={id:li,minzoom:Jl,type:"line",source:it,layout:G,paint:{"line-color":nt(Te),"line-width":Bc.curbZoneEmphasisOutline}};Zt.map.addLayer(Jr);const Kr={id:Rt,minzoom:Jl,type:"line",source:it,filter:Z,layout:G,paint:{"line-color":nt(Le),"line-width":Bc.curbZoneEmphasisWidth}};Zt.map.addLayer(Kr),Ln(Rt,it);const yl={id:Xt,minzoom:Jl,type:"symbol",source:it,filter:Z,filter:nt(Ae),layout:{"symbol-placement":"line-center","icon-rotation-alignment":"viewport","icon-image":nt(Oe)},paint:{}};Zt.map.addLayer(yl),Zt.map.on("click",jt,Vo=>{if(!Vo.features?.length)return;const _s=Vo.features[0],Ns=Zt.map.querySourceFeatures(it,{filter:["all",["any",["==","selectionOnly",!0],["==","innerLine",!0]],["==","curb_zone_id",_s?.properties?.curb_zone_id]]});jr(Ns[0])})}});const ui=ra(()=>Oo.id);if(ui){const ki=()=>{const wr=Zt.map.querySourceFeatures(it,{filter:["all",["any",["==","selectionOnly",!0],["==","innerLine",!0]],["==","curb_zone_id",ui]]})?.[0];wr&&(jr(wr),Oo.id=null)};R(Zt.map,ki)}};ms(()=>{gr.type,gr.selected;const ii=()=>{const Si=Zt.map.getSource(Fe);if(gr.selected&&gr.type==="area"&&!Si){const Ti={type:"geojson",data:gr.selected};Zt.map.addSource(Fe,Ti);const ui={id:Ye,type:"line",source:Fe,layout:{},paint:{"line-color":"#58585b","line-width":Bc.areaSelectionOutline,"line-dasharray":s0.areaSelectionDasharray}};Zt.map.addLayer(ui);const ki=ra(()=>rn.day),wr=ra(()=>rn.time);Nn("area",ki,wr)}};R(Zt.map,ii)}),ms(()=>{gr.type,gr.selected;const ii=()=>{const Si=Zt.map.getSource(Fe);if(gr.selected&&gr.type==="radius"){const si=gr.selected;if(Si)Si.setData(si);else{const ki={type:"geojson",data:si};Zt.map.addSource(Fe,ki);const wr={id:Ye,type:"line",source:Fe,layout:{},paint:{"line-color":"#58585b","line-width":Bc.areaSelectionOutline,"line-dasharray":[2,2]}};Zt.map.addLayer(wr)}const Ti=ra(()=>rn.day),ui=ra(()=>rn.time);Nn("radius",Ti,ui)}};R(Zt.map,ii)}),ms(()=>{const ii=rn.day,Si=rn.time,si=ra(()=>Zt.map),Ti=ra(()=>gr.type);si.isStyleLoaded()&&Ti&&(ii||Si)&&Nn(Ti,rn.day,rn.time)}),ms(()=>{nt(ee)&&Zt.map.getLayer(jt)&&(Zt.map.setPaintProperty(jt,"line-color",nt(K)),Zt.map.setPaintProperty(jt,"line-width",nt(oe)),Zt.map.setPaintProperty(jt,"line-dasharray",nt(ge))),nt(ee)&&Zt.map.getLayer(li)&&Zt.map.setPaintProperty(li,"line-color",nt(Te)),nt(ee)&&Zt.map.getLayer(Rt)&&Zt.map.setPaintProperty(Rt,"line-color",nt(Le)),nt(ee)&&Zt.map.getLayer(Xt)&&(Zt.map.setFilter(Xt,nt(Ae)),Zt.map.setLayoutProperty(Xt,"icon-image",nt(Oe)))}),ms(()=>{const ii=gr.selected;Zt.map.isStyleLoaded()&&!ii&&(Zt.map.removeLayer(Ye),Zt.map.removeSource(Fe),Zt.map.getLayer(jt)&&(Zt.map.removeLayer(jt),Zt.map.getLayer(Rt)&&(Zt.map.removeLayer(Rt),Zt.map.getLayer(li)&&(Zt.map.removeLayer(li),Zt.map.getLayer(Xt)&&Zt.map.removeLayer(Xt))),Zt.map.removeSource(it)),Zt.map.getLayer(Ai)&&(Zt.map.removeLayer(Ai),Zt.map.removeLayer(rr),Zt.map.removeSource(Pt),Zt.map.removeLayer(di),Zt.map.removeLayer(Bi),Zt.map.removeSource(Li),Oo.geometry=null,Oo.properties=null,Oo.policies=null))}),ms(()=>{if(ko?.results&&!nt(k)){const ii=ko.results;Yr(k,new nm.Marker({color:"#58585b"}).setLngLat(ii).addTo(Zt.map),!0),Zt.map.flyTo({center:ii,zoom:16})}else!ko?.results&&nt(k)&&(nt(k).remove(),Yr(k,null))});var An=ZL(),yr=Ht(An);{var qn=ii=>{IP(ii,{onClose:()=>Yr(S,!1)})};Fn(yr,ii=>{nt(S)&&ii(qn)})}Ut(An),gi(m,An),Mo()}const WL="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFsAAACNCAYAAADYUQarAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAxuSURBVHgB7V1rbBTXGb2zD7/WLwipQXGRS7BKUppWwRECRAuRGmoH+NEAFRKg0jZuK7UkKk2bKmogosWoikBqEVWoEKkaKdRuGloojwaEkxJQGyAPMKQJNSEJDxtsYu+u9zW7k3O8u8Rer9de78w1Zu6RP93Z3fHuzJk73/1e945mGEaDEGIqJCbGBoxYLBb0+Xx+h8NhJF4bTqczhHPp1jTNi1ZH2wW5gX16otFop8fj8WJfHyQECdfV1UXb29tjixYtiq5fv17KuWs4sFNo7+NBi7EFI81ro8/7JDCakGBCPoG0QS719PR8gIvxPrZbCwsLP0LrrampCZ08eTIqLOp4JPtNtF/htrj9QRKTF0RPSA/kMuQMLsAxt9t9HPIBiPeDeF2Y2QlJNiRq2Bs8/wjED7kMtbQ7EAisxnZlbW1tvjCrIxqK7HQg8dT9b2JseBLEVy1dujRP5IikGqHOdgiFVFDtBMHR++FweFt+fv7foOc7xQh1uiI4M8hPEQi+D0Q/i+3nQPxX6+vr3WIEUD07O+jgqzUYDD4DC2Y3LkJPNv+sCM4OLhBcDaK3YPuHIL4km39WZGcPWiafgzwNeQyEFw/3HxXZI0cZZC3kuyC8YDj/oMjODeWQX8IZ+ua8efNcQ+2sBsjcEQOH70QikeWwWP4nMniciuDc4cCg+SWXy/VTkO7JuKNQMANuRBe/FQqF5mVSJ0qNmAeGPA6il69MeJkDoAg2D06QPAuD5SzEUZzpdlA921xEIC+0tbX9ZOLEif7UDxXB5oIxk6+Xl5dXijRh2SFtQxPACFk7JCCsywYx5lyQaF0J4a08GgmRCmiLmTNmzGhF8iHS9wMZZDMH+BRyhIdF/ORNJQBBIQFLwAMpha07CYH/6qKiohnQnzX4uELEL4JM0vN0XZ9VUlLSKOJq5TMY1icPukFI7WCDhknQkLR10OyaOnVqPn6zFDINgf9fgPxziWSALJDL1yETBhylIYFsv99fZzHZaS8AU1qwfe/FMfwFEjDk4SJ+d5pIuaOkDJC4rUZDdxr79+8PwYU+h+3H0cNfFvEErwyUILMzSaTwawdrxID+vgp9/gy2zwg59THMV1ZArcnv2bcAjDlz5rQicbsT22FhPchrudfrtSXZgjUgyLAcEPEaEatBkgdwayenxujs7LyKweuskKe7+8FWHuTChQsjiF2cFxL0dqIOsf97wka4du1aDCRcEdaTze8fMDbYLjYCEzAqrIcOj7ltypQp/S6qHQNRMkIUYdxB7U1NTf1Uia3IrqysZEh5gLNhMkhwh9vtviJSAm8yrvItgyNHjuQjKMbCfytDB1QdrPvuFilk26ln9xbXQJfeI6w9bx0Wz4nq6upg6ge2IRvxZRdIeAibE4W1IVcf9PW/z58/H0n9wC5qRDt69GglglLfEfH4tlVgDcmZgoKCd0SaRIkdejYHxXEg4OcISH1ZWHvOCN0HX5o+ffoAfS3EbU42Y+i0PmBbr8PLVSKeNrMKnLX2Li7o31taWiLp95CUPBDWWgA3wYwN9LMbv1uO312I9qAhJ3HA8/wBf3uwY5NRytCNrMXylStXHmptbTU14YtbVsMJOqqqqgQcCPeECRM8CKNOxjk9gDwkL/BMyDhh/R3MwNZeyKPo2dcH20nGAJkHA/8bO3bsuBOjdM4nDdONLndv5hwZoGJ85Xi8Ho8E61147/MIo7JlOS97mIy7ib36AmLXDVu2bOnMtKOsIh0GZayISSSz9Y4+IjsF147E8mNr1659afv27ZFMO6qKqNxAlcHBdyfUR2ConW3lrpsIjj1XIRsgfxoO0YTqzdmDg+E5DMQ/FvEePewZY4rs4YMBJjorTeFweHldXd0/QHQwmy9QamRokOQAooVvw9Tc5vF4/tnQ0NDd3NycdbZHkZ0eJJLqguuTnALJL8LdP4AcZjtIHnGyWJH92ZIYybVJWFd9Abb7q1AX+0HyW7W1tV25kJyEIjteytwKYaTuJOQ/kPNwlrpWrVoVgWdqmn+gBsi4qvg/5DTkXUiHiPdwB8ILDsZahElQTk3/VXXo6XItqY+gRlqYcUEM/CTCDReQefGtWLEikst6Uors9IglhO53Nzgi8Ydg6r2CANd7y5Yt849IvRhqJZ3hgPwwTHsF8iKskzq047JVMapnZw+qG/b2ZoSOt8Ja+S96vH84/6jIHjlIOgNRz0O2gvAhy9oUwSMHzWZm6h9Hh92JJMb9Q63MoMjOHQXo1Q8iafH83r1752ciXBbZSffXKkmuMjlaS5xyKvU9iJtsA+HzRnM6NafFvYFsxmWYTQ6ktcyeeMrjZhqMy08wez4ewqWEWB/CuS0yJ5/yYp+NRCLf37hx4xupNrmshO/K+fPnv3Ls2DGrcoLJWb1u/FYJzqkCTskXYSnMhNs9G+9PhhQJOXcyzcTX0NNXQz4UfetHDDmlDLVmur1DQONtnChn8EAm4/cfRXvckDcXMoSQ7Ga0Rf2OzJBAdldX18OjMOn0JhLEV0I2QW4YctCWOrPZFtYIJ+zjlv4Ym79JSJewHnfk5eX9qLGxsSz5hq1MPy5kjuY56PMdwvr5kLRQ5iKmMjdpDtrOzgYBPiQFtuI2Z/zaalOxGIP0Uhbh84UdnRqjpqbmEvTpC8L63u2CNTQXF/cLgrP1hA3R0tLC2VyHRLz2w2rcqev6HAzSTru66zEMXh9DlbQI62f7uuHMzTlx4oTbtrEROFkhDF5Mg1mtt8nxdEiZbclOzPa9KOSQXQEXvsK2ZMNKoOPBoL+MR8YUg+y7bB1iBdnMMcog24XfmmBrsmGR0NmQEREkz/Ylm1NEYP/SlZYVfrWnnU2UlpY6MUDeLeQ5doZty88QWy+CHuW8SCkc4MIGbdmzGVuHGpmOOMm9Qk7P1hHfbrNlz163bh1TaMtF/JkFMhCGqdlmu57NcCcGxgex+YiIT9+zGjQtP3G5XJdtRTaJ3rdv3wOIi/waL+8QckCyL0A6bEE2dTQGwyIQvaiwsPCPeIu6WpbJp3u93lOIxQSk6GzcQkZTU5OQCRK8Z88eJ6JteQg4TUN2ZjWIXoaPuPqvzImpQThPr6PVZZQyeEOh0Lc3bdp0EATk7BrjO/oRhdi0hqCSxqU4S0pKnLt27XJWVFQUcOFZxCPu93g8C7Db10T8EVU5P9MxSzD+chqWz8MIs16SQbYPveoJ2JmHQUDO7jHMNRLmcLvdIhAIMBNSju9nrQh77CScVBVaOitsWbDD/UfL6gqjE/xu8eLFv2pubg7KIJshTE6gH9Ys2CHAC5W8YElhfo/lAn3nrydfjzbaQPYj8FaPYzsm44r3BmGE/aDjjvsXVBvn6vTGzNVsMevQwZKJDRs2+JJvqGJ4a8Cs/R8gT/WdlaAINh+0QM7CAtsm4s90vwlFtvnogKnXsGbNmgvo1f1MXaVGzAV7Mp9i/dt0k5oUweYhBNkF+f1gs8cU2eYgDMtjN5wsPkS5Y7CdFNm5Iwii/wpP9meIvVxO1dN9oezskYOkMhSxA0RvwnZ7JqIJRfbIwNlpLK5/FkT/GSSnXXs1FYrs7EBCe2DBverz+RrginMq9bDLjpXOHh5IcohVryD5Sb/fv3rz5s3HsiE6/i1qVYZMIC/syS3Ijj8NZ+Xu+vr6EectlVMzEMl1Rrzg5m304peRaeJaUZfwXnioQTAT7K6zSRzJ5YDHonhO23sP9vJrSAofRnsWucNuPpdMmFCAmSR7NJ7XaAWMDG1yhTO27LlMZnRCPVxEjvIsSH4LucLTSKN9uGTJEn9xcbFu5mJcBMnmw4zbRPwKyyifNRM8Xq4a2begPfmoKcaRSSi9u+vQt11o22Gq8Vz55Dw6INfgiHQtWLAggpSdjuSwnouaGAoalT5+oFCMQeBWj+H4SWhvD2SBO259DvpR5CIZq0je/vrs2bMNzjYoKyuL8TFUjY2NMSuJTQfTnxY9Chhrd6OCgoKCgoKCgoKCgoKCgoKCLaF1fW/B+NJu95iM+o0V9DgdRlE0/4ZLXNfWdTsiDxnCoY/eurG3LzT+RUW4Ky/8hEtzaFUxw6gG0SoHaQEY/0XUvMfQRZmLL7X4m7dLauzWg0aSXYZDYzWDULAcUVW+IBWKbIlQZEuEIlsiFNkSociWCEW2RCiyJUKRLRGKbIlQZEuEIlsiFNkSociWCAcCrSqObTFIsNMphEtDHsGhaUiJGSonZhEcQosZuqG5IiJ6wDCMNsPQYr0ZBQVzga7scMZ03Wm0fgpk7BeAFRbTcQAAAABJRU5ErkJggg==";var XL=Zi('<div class="TopBar svelte-1h259us"><div class="boston-app-title svelte-1h259us">Boston Curb Map</div> <div class="right-container svelte-1h259us"><button class="info-button svelte-1h259us">info</button> <div class="boston-logo svelte-1h259us"><img alt="Boston logo" class="svelte-1h259us"/></div></div></div>');function YL(m,y){var b=XL(),S=zi(Ht(b),2),M=Ht(S);M.__click=function(...o){y.onClickInfo?.apply(this,o)};var R=zi(M,2),k=Ht(R);Ut(R),Ut(S),Ut(b),Sn(()=>Hc(k,"src",WL)),gi(m,b)}Fs(["click"]);var JL=Zi('<div role="menu"><!></div>'),KL=Zi('<div class="button-container svelte-1vsqdzt"><!> <button> </button></div>');function _0(m,y){const b=Nc(y,"children",3,null),S=Nc(y,"theme",3,"dark");let M=ao(0);var R=KL(),k=Ht(R);{var o=ee=>{var ie=JL(),re=Ht(ie);ZC(re,b),Ut(ie),Sn(()=>Ao(ie,1,Fo(["menu-container",{right:y.position==="right",open:y.open,light:S()==="light"}]),"svelte-1vsqdzt")),gi(ee,ie)};Fn(k,ee=>{y.open&&b()&&ee(o)})}var G=zi(k,2);G.__click=function(...ee){y.setOpen?.apply(this,ee)};var Z=Ht(G,!0);Ut(G),Ut(R),Sn(()=>{Dg(R,`--button-height: ${nt(M)??""}px`),Ao(G,1,Fo(["MenuButton",{open:y.open,disabled:y.disabled}]),"svelte-1vsqdzt"),Qo(Z,y.label)}),tx(G,"clientHeight",ee=>Yr(M,ee)),gi(m,R)}Fs(["click"]);const QL="abscissae",eR="addenda",tR="adulthood",iR="advice",rR="afreets",nR="afrits",oR="agenda",sR="aid",aR="aircraft",lR="albinos",cR="alcohol",uR="algae",hR="altos",dR="alumnae",fR="alumni",pR="alveoli",mR="amoebas",_R="ammo",gR="analyses",yR="analytics",vR="anathemas",xR="anime",bR="antennas",wR="antitheses",TR="aphelia",ER="apparatuses",SR="appendixes",IR="aquariums",AR="archipelagos",CR="armadillos",MR="asyndetons",PR="athletics",LR="audio",RR="auroras",DR="automatons",OR="axes",zR="bacilli",kR="bacteria",FR="bacula",BR="barracks",NR="bases",VR="bassos",UR="beaus",jR="beefs",GR="blood",qR="bemas",HR="biceps",ZR="bison",$R="bream",WR="breeches",XR="britches",YR="brothers",JR="buffalo",KR="bureaus",QR="businessmen",eD="butter",tD="cactuses",iD="calves",rD="cash",nD="candelabra",oD="cantos",sD="cantus",aD="carcinomas",lD="carp",cD="censuses",uD="chapeaus",hD="charismas",dD="chairmen",fD="chassis",pD="cherubs",mD="chess",_D="children",gD="clippers",yD="clitorises",vD="clothes",xD="clothing",bD="cloacae",wD="cod",TD="codices",ED="commerce",SD="coitus",ID="commandos",AD="compendiums",CD="concertos",MD="consortia",PD="contraltos",LD="contretemps",RD="cooperation",DD="corps",OD="corpora",zD="cortices",kD="crania",FD="crescendos",BD="crises",ND="criteria",VD="curricula",UD="cyclopses",jD="cystomata",GD="data",qD="data",HD="debris",ZD="deer",$D="desiderata",WD="diabetes",XD="diagnoses",YD="dicta",JD="dice",KD="digestion",QD="dingoes",eO="diplomas",tO="dittos",iO="djinn",rO="dogmata",nO="dramas",oO="dwarfs",sO="dynamos",aO="economics",lO="echoes",cO="edemas",uO="efreets",hO="eland",dO="elves",fO="elk",pO="ellipses",mO="embargoes",_O="embryos",gO="emphases",yO="emporia",vO="encomia",xO="enigmas",bO="equipment",wO="ephemerides",TO="errata",EO="excretion",SO="expertise",IO="extrema",AO="fezzes",CO="fiascos",MO="fibulae",PO="firmware",LO="fish",RO="flounder",DO="focuses",OO="feet",zO="fun",kO="foramina",FO="formulas",BO="forums",NO="fungi",VO="gallows",UO="garbage",jO="ganglia",GO="generalissimos",qO="genies",HO="gentlemen",ZO="genera",$O="ghettos",WO="glomeruli",XO="geese",YO="goyim",JO="graffiti",KO="graffiti",QO="grouse",e5="guano",t5="gummata",i5="gymnasiums",r5="halves",n5="hamuli",o5="hardware",s5="health",a5="headquarters",l5="heroes",c5="herpes",u5="highjinks",h5="hijinks",d5="hiatuses",f5="hippopotamuses",p5="homework",m5="honoraria",_5="hooves",g5="housework",y5="hovercraft",v5="humeri",x5="hyperbata",b5="hyperbolae",w5="hypotheses",T5="ilia",E5="impetuses",S5="incubi",I5="indexes",A5="information",C5="infernos",M5="innings",P5="interregna",L5="interstitia",R5="jackanapes",D5="jeans",O5="jumbos",z5="kakapo",k5="knives",F5="kudos",B5="labour",N5="lacunas",V5="larvae",U5="leaves",j5="lemmas",G5="librettos",q5="lives",H5="lingos",Z5="literature",$5="loaves",W5="loculi",X5="loci",Y5="looies",J5="lice",K5="lumbagos",Q5="lumina",ez="lustra",tz="lymphomata",iz="machinery",rz="mackerel",nz="magmas",oz="mail",sz="magnetos",az="men",lz="manga",cz="manifestos",uz="matrices",hz="maxima",dz="means",fz="measles",pz="medicos",mz="media",_z="melismas",gz="memoranda",yz="menisci",vz="mews",xz="miasmas",bz="millennia",wz="minima",Tz="minutiae",Ez="momenta",Sz="mongooses",Iz="moose",Az="mud",Cz="mice",Mz="mumps",Pz="music",Lz="murices",Rz="mythoi",Dz="nebulas",Oz="nemeses",zz="neuroses",kz="news",Fz="nexuses",Bz="nimbuses",Nz="noumena",Vz="novas",Uz="nucleoli",jz="nuclei",Gz="oases",qz="occipita",Hz="octavos",Zz="octopuses",$z="oedemas",Wz="offspring",Xz="omphaloi",Yz="optima",Jz="opuses",Kz="organons",Qz="ova",e4="oxen",t4="parabolas",i4="paralyses",r4="parentheses",n4="passersby",o4="pennies",s4="personnel",a4="perihelia",l4="people",c4="phalanges",u4="phenomena",h4="photos",d4="physics",f4="phyla",p4="pike",m4="pincers",_4="plankton",g4="plateaus",y4="platypuses",v4="plexuses",x4="pliers",b4="police",w4="policemen",T4="politics",E4="pollution",S4="polyhedra",I4="pontifices",A4="potatoes",C4="premises",M4="pros",P4="proceedings",L4="prognoses",R4="prolegomena",D4="prospectuses",O4="quanta",z4="quartos",k4="quizzes",F4="rabies",B4="rain",N4="radii",V4="referendums",U4="reindeer",j4="research",G4="rhinos",q4="rice",H4="roofs",Z4="rostrums",$4="salmon",W4="sarcomas",X4="sarcophagi",Y4="savings",J4="scarves",K4="schemas",Q4="scissors",ek="scrota",tk="sewage",ik="selves",rk="seminomas",nk="shambles",ok="seraphs",sk="series",ak="shears",lk="sheep",ck="shelves",uk="shrimp",hk="silices",dk="simplexes",fk="simulacra",pk="software",mk="sinuses",_k="soliloquies",gk="solos",yk="somas",vk="sopranos",xk="spacecraft",bk="spokesmen",wk="species",Tk="spectra",Ek="specula",Sk="sphinxes",Ik="squid",Ak="stadiums",Ck="staffs",Mk="stairs",Pk="stamens",Lk="statuses",Rk="stigmas",Dk="stimuli",Ok="stomas",zk="strata",kk="styluses",Fk="succubi",Bk="swine",Nk="syconia",Vk="syllabuses",Uk="symposiums",jk="synopses",Gk="syntheses",qk="tennis",Hk="tableaus",Zk="tempos",$k="thanks",Wk="testes",Xk="those",Yk="theses",Jk="thieves",Kk="thrombi",Qk="tibias",eF="tomatoes",tF="teeth",iF="torpedoes",rF="tornadoes",nF="tori",oF="traffic",sF="transportation",aF="trapezia",lF="traumas",cF="triceps",uF="trilbies",hF="trout",dF="tuna",fF="ultimatums",pF="umbilici",mF="upstairs",_F="uteruses",gF="vacuums",yF="vela",vF="vertebrae",xF="vertices",bF="vetoes",wF="viscera",TF="wealth",EF="welfare",SF="vitae",IF="volcanoes",AF="vortices",CF="watercraft",MF="wharves",PF="whiting",LF="wives",RF="wildebeest",DF="wildlife",OF="wolves",zF="women",kF={abscissa:QL,addendum:eR,adulthood:tR,advice:iR,afreet:rR,afrit:nR,agendum:oR,aid:sR,aircraft:aR,albino:lR,alcohol:cR,alga:uR,alto:hR,alumna:dR,alumnus:fR,alveolus:pR,amoeba:mR,ammo:_R,analysis:gR,analytics:yR,anathema:vR,anime:xR,antenna:bR,antithesis:wR,aphelion:TR,apparatus:ER,appendix:SR,aquarium:IR,archipelago:AR,armadillo:CR,asyndeton:MR,athletics:PR,audio:LR,aurora:RR,automaton:DR,axis:OR,bacillus:zR,bacterium:kR,baculum:FR,barracks:BR,basis:NR,basso:VR,beau:UR,beef:jR,blood:GR,bema:qR,biceps:HR,bison:ZR,bream:$R,breeches:WR,britches:XR,brother:YR,buffalo:JR,bureau:KR,businessman:QR,butter:eD,cactus:tD,calf:iD,cash:rD,candelabrum:nD,canto:oD,cantus:sD,carcinoma:aD,carp:lD,census:cD,chapeau:uD,charisma:hD,chairman:dD,chassis:fD,cherub:pD,chess:mD,child:_D,chÃ¢teau:"chÃ¢teaus",clippers:gD,clitoris:yD,clothes:vD,clothing:xD,cloaca:bD,cod:wD,codex:TD,commerce:ED,coitus:SD,commando:ID,compendium:AD,concerto:CD,consortium:MD,contralto:PD,contretemps:LD,cooperation:RD,corps:DD,corpus:OD,cortex:zD,cranium:kD,crescendo:FD,crisis:BD,criterion:ND,curriculum:VD,cyclops:UD,cystoma:jD,data:GD,datum:qD,debris:HD,deer:ZD,desideratum:$D,diabetes:WD,diagnosis:XD,dictum:YD,die:JD,digestion:KD,dingo:QD,diploma:eO,ditto:tO,djinni:iO,dogma:rO,drama:nO,dwarf:oO,dynamo:sO,economics:aO,echo:lO,edema:cO,efreet:uO,eland:hO,elf:dO,elk:fO,ellipsis:pO,embargo:mO,embryo:_O,emphasis:gO,emporium:yO,encomium:vO,enigma:xO,equipment:bO,ephemeris:wO,erratum:TO,excretion:EO,expertise:SO,extremum:IO,"faux pas":"faux pas",fez:AO,fiasco:CO,fibula:MO,firmware:PO,fish:LO,flounder:RO,focus:DO,foot:OO,fun:zO,foramen:kO,formula:FO,forum:BO,fungus:NO,gallows:VO,garbage:UO,ganglion:jO,generalissimo:GO,genie:qO,gentleman:HO,genus:ZO,ghetto:$O,glomerulus:WO,goose:XO,goy:YO,graffiti:JO,graffito:KO,grouse:QO,guano:e5,gumma:t5,gymnasium:i5,half:r5,hamulus:n5,hardware:o5,health:s5,headquarters:a5,hero:l5,herpes:c5,highjinks:u5,hijinks:h5,hiatus:d5,hippopotamus:f5,homework:p5,honorarium:m5,hoof:_5,housework:g5,hovercraft:y5,humerus:v5,hyperbaton:x5,hyperbola:b5,hypothesis:w5,ilium:T5,impetus:E5,incubus:S5,index:I5,information:A5,inferno:C5,innings:M5,interregnum:P5,interstitium:L5,jackanapes:R5,jeans:D5,jumbo:O5,kakapo:z5,knife:k5,kudos:F5,labour:B5,lacuna:N5,larva:V5,leaf:U5,lemma:j5,libretto:G5,life:q5,lingo:H5,literature:Z5,loaf:$5,loculus:W5,locus:X5,looey:Y5,louse:J5,lumbago:K5,lumen:Q5,lustrum:ez,lymphoma:tz,machinery:iz,mackerel:rz,magma:nz,mail:oz,magneto:sz,man:az,manga:lz,manifesto:cz,matrix:uz,maximum:hz,means:dz,measles:fz,medico:pz,medium:mz,melisma:_z,memorandum:gz,meniscus:yz,mews:vz,miasma:xz,millennium:bz,minimum:wz,minutia:Tz,momentum:Ez,mongoose:Sz,moose:Iz,mud:Az,mouse:Cz,mumps:Mz,music:Pz,murex:Lz,mythos:Rz,nebula:Dz,nemesis:Oz,neurosis:zz,news:kz,nexus:Fz,nimbus:Bz,noumenon:Nz,nova:Vz,nucleolus:Uz,nucleus:jz,oasis:Gz,occiput:qz,octavo:Hz,octopus:Zz,oedema:$z,offspring:Wz,omphalos:Xz,optimum:Yz,opus:Jz,organon:Kz,ovum:Qz,ox:e4,parabola:t4,paralysis:i4,parenthesis:r4,passerby:n4,penny:o4,personnel:s4,perihelion:a4,person:l4,phalanx:c4,phenomenon:u4,photo:h4,physics:d4,phylum:f4,pike:p4,pincers:m4,plankton:_4,plateau:g4,platypus:y4,plexus:v4,pliers:x4,police:b4,policeman:w4,politics:T4,pollution:E4,polyhedron:S4,pontifex:I4,potato:A4,premises:C4,pro:M4,proceedings:P4,prognosis:L4,prolegomenon:R4,prospectus:D4,quantum:O4,quarto:z4,quiz:k4,rabies:F4,rain:B4,radius:N4,referendum:V4,reindeer:U4,research:j4,rhino:G4,rice:q4,roof:H4,rostrum:Z4,salmon:$4,sarcoma:W4,sarcophagus:X4,savings:Y4,scarf:J4,schema:K4,scissors:Q4,scrotum:ek,"sea bass":"sea bass",sewage:tk,self:ik,seminoma:rk,shambles:nk,seraph:ok,series:sk,shears:ak,sheep:lk,shelf:ck,shrimp:uk,silex:hk,simplex:dk,simulacrum:fk,software:pk,sinus:mk,soliloquy:_k,solo:gk,soma:yk,soprano:vk,spacecraft:xk,spokesman:bk,species:wk,spectrum:Tk,speculum:Ek,sphinx:Sk,squid:Ik,stadium:Ak,staff:Ck,stairs:Mk,stamen:Pk,status:Lk,stigma:Rk,stimulus:Dk,stoma:Ok,stratum:zk,stylus:kk,succubus:Fk,swine:Bk,syconium:Nk,syllabus:Vk,symposium:Uk,synopsis:jk,synthesis:Gk,tennis:qk,tableau:Hk,tempo:Zk,thanks:$k,testis:Wk,that:Xk,thesis:Yk,thief:Jk,this:"these",thrombus:Kk,tibia:Qk,tomato:eF,tooth:tF,torpedo:iF,tornado:rF,torus:nF,traffic:oF,transportation:sF,trapezium:aF,trauma:lF,triceps:cF,trilby:uF,trout:hF,tuna:dF,ultimatum:fF,umbilicus:pF,upstairs:mF,uterus:_F,vacuum:gF,velum:yF,vertebra:vF,vertex:xF,veto:bF,viscus:wF,wealth:TF,welfare:EF,vita:SF,volcano:IF,vortex:AF,watercraft:CF,wharf:MF,whiting:PF,wife:LF,wildebeest:RF,wildlife:DF,wolf:OF,woman:zF},TT=new Map(Object.entries(kF));function dx(m,y,b){if(typeof y=="number"&&(b=y),TT.has(m.toLowerCase())){y=TT.get(m.toLowerCase());const S=m.charAt(0);S===S.toUpperCase()&&(y=S+y.slice(1)),m===m.toUpperCase()&&(y=y.toUpperCase())}else typeof y!="string"&&(y=(m.replace(/(?:s|x|z|ch|sh)$/i,"$&e").replace(/([^aeiou])y$/i,"$1ie")+"s").replace(/i?e?s$/i,S=>m.slice(-1)===m.slice(-1).toLowerCase()?S.toLowerCase():S.toUpperCase()));return Math.abs(b)===1?m:y}var FF=ks('<svg width="20" height="12" viewBox="0 0 20 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.9425 10.9393C10.3567 11.5251 9.40696 11.5251 8.82117 10.9394L0.442315 2.56067C-0.502647 1.61573 0.1666 -5.87071e-07 1.50296 -4.70242e-07L18.2603 9.94733e-07C19.5967 1.11156e-06 20.2659 1.6157 19.321 2.56065L10.9425 10.9393Z" fill="black"></path></svg>');function yS(m){var y=FF();gi(m,y)}var BF=ks('<svg width="14" height="11" viewBox="0 0 14 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 4.78947L5.13793 9L13 1" stroke="black" stroke-width="2" stroke-linecap="round"></path></svg>');function NF(m){var y=BF();gi(m,y)}var g0,ET;function Kd(){if(ET)return g0;ET=1,g0=y;var m=Object.prototype.hasOwnProperty;function y(){for(var b={},S=0;S<arguments.length;S++){var M=arguments[S];for(var R in M)m.call(M,R)&&(b[R]=M[R])}return b}return g0}var y0={exports:{}},ST;function VF(){return ST||(ST=1,(function(m,y){(function(){var b={};m.exports=b,b.simpleFilter=function(S,M){return M.filter(function(R){return b.test(S,R)})},b.test=function(S,M){return b.match(S,M)!==null},b.match=function(S,M,R){R=R||{};var k=0,o=[],G=M.length,Z=0,ee=0,ie=R.pre||"",re=R.post||"",ue=R.caseSensitive&&M||M.toLowerCase(),oe;S=R.caseSensitive&&S||S.toLowerCase();for(var ge=0;ge<G;ge++)oe=M[ge],ue[ge]===S[k]?(oe=ie+oe+re,k+=1,ee+=1+ee):ee=0,Z+=ee,o[o.length]=oe;return k===S.length?(Z=ue===S?1/0:Z,{rendered:o.join(""),score:Z}):null},b.filter=function(S,M,R){return!M||M.length===0?[]:typeof S!="string"?M:(R=R||{},M.reduce(function(k,o,G,Z){var ee=o;R.extract&&(ee=R.extract(o));var ie=b.match(S,ee,R);return ie!=null&&(k[k.length]={string:ie.rendered,score:ie.score,index:G,original:o}),k},[]).sort(function(k,o){var G=o.score-k.score;return G||k.index-o.index}))}})()})(y0)),y0.exports}var v0,IT;function UF(){if(IT)return v0;IT=1;var m=function(y){return this.component=y,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,y.el.parentNode.insertBefore(this.wrapper,y.el.nextSibling),this};return m.prototype.show=function(){this.element.style.display="block"},m.prototype.hide=function(){this.element.style.display="none"},m.prototype.add=function(y){this.items.push(y)},m.prototype.clear=function(){this.items=[],this.active=0},m.prototype.isEmpty=function(){return!this.items.length},m.prototype.isVisible=function(){return this.element.style.display==="block"},m.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var y=0;y<this.items.length;y++)this.drawItem(this.items[y],this.active===y);this.show()},m.prototype.drawItem=function(y,b){var S=document.createElement("li"),M=document.createElement("a");b&&(S.className+=" active"),M.innerHTML=y.string,S.appendChild(M),this.element.appendChild(S),S.addEventListener("mousedown",(function(){this.selectingListItem=!0}).bind(this)),S.addEventListener("mouseup",(function(){this.handleMouseUp.call(this,y)}).bind(this))},m.prototype.handleMouseUp=function(y){this.selectingListItem=!1,this.component.value(y.original),this.clear(),this.draw()},m.prototype.move=function(y){this.active=y,this.draw()},m.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)},m.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)},m.prototype.drawError=function(y){var b=document.createElement("li");b.innerHTML=y,this.element.appendChild(b),this.show()},v0=m,v0}var x0,AT;function jF(){if(AT)return x0;AT=1;var m=Kd(),y=VF(),b=UF(),S=function(M,R,k){return k=k||{},this.options=m({minLength:2,limit:5,filter:!0,hideOnBlur:!0},k),this.el=M,this.data=R||[],this.list=new b(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",(function(o){this.handleKeyUp(o.keyCode)}).bind(this),!1),this.el.addEventListener("keydown",(function(o){this.handleKeyDown(o)}).bind(this)),this.el.addEventListener("focus",(function(){this.handleFocus()}).bind(this)),this.el.addEventListener("blur",(function(){this.handleBlur()}).bind(this)),this.el.addEventListener("paste",(function(o){this.handlePaste(o)}).bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};return S.prototype.handleKeyUp=function(M){M===40||M===38||M===27||M===13||M===9||this.handleInputChange(this.el.value)},S.prototype.handleKeyDown=function(M){switch(M.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&M.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}},S.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()},S.prototype.handlePaste=function(M){if(M.clipboardData)this.handleInputChange(M.clipboardData.getData("Text"));else{var R=this;setTimeout(function(){R.handleInputChange(M.target.value)},100)}},S.prototype.handleInputChange=function(M){if(this.query=this.normalize(M),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates((function(R){for(var k=0;k<R.length&&(this.list.add(R[k]),k!==this.options.limit-1);k++);this.list.draw()}).bind(this))},S.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1},S.prototype.update=function(M){this.data=M,this.handleKeyUp()},S.prototype.clear=function(){this.data=[],this.list.clear()},S.prototype.normalize=function(M){return M=M.toLowerCase(),M},S.prototype.match=function(M,R){return M.indexOf(R)>-1},S.prototype.value=function(M){if(this.selected=M,this.el.value=this.getItemValue(M),document.createEvent){var R=document.createEvent("HTMLEvents");R.initEvent("change",!0,!1),this.el.dispatchEvent(R)}else this.el.fireEvent("onchange")},S.prototype.getCandidates=function(M){var R={pre:"<strong>",post:"</strong>",extract:(function(o){return this.getItemValue(o)}).bind(this)},k;this.options.filter?(k=y.filter(this.query,this.data,R),k=k.map((function(o){return{original:o.original,string:this.render(o.original,o.string)}}).bind(this))):k=this.data.map((function(o){var G=this.render(o);return{original:o,string:G}}).bind(this)),M(k)},S.prototype.getItemValue=function(M){return M},S.prototype.render=function(M,R){if(R)return R;for(var k=M.original?this.getItemValue(M.original):this.getItemValue(M),o=this.normalize(k),G=o.lastIndexOf(this.query);G>-1;){var Z=G+this.query.length;k=k.slice(0,G)+"<strong>"+k.slice(G,Z)+"</strong>"+k.slice(Z),G=o.slice(0,G).lastIndexOf(this.query)}return k},S.prototype.renderError=function(M){this.list.drawError(M)},x0=S,x0}var b0,CT;function GF(){if(CT)return b0;CT=1;var m=jF();return b0=m,typeof window<"u"&&(window.Suggestions=m),b0}var w0,MT;function qF(){if(MT)return w0;MT=1;var m="Expected a function",y=NaN,b="[object Symbol]",S=/^\s+|\s+$/g,M=/^[-+]0x[0-9a-f]+$/i,R=/^0b[01]+$/i,k=/^0o[0-7]+$/i,o=parseInt,G=typeof oa=="object"&&oa&&oa.Object===Object&&oa,Z=typeof self=="object"&&self&&self.Object===Object&&self,ee=G||Z||Function("return this")(),ie=Object.prototype,re=ie.toString,ue=Math.max,oe=Math.min,ge=function(){return ee.Date.now()};function K(ze,Fe,Ye){var it,jt,Rt,li,Xt,Pt,Ai=0,rr=!1,Li=!1,di=!0;if(typeof ze!="function")throw new TypeError(m);Fe=Ae(Fe)||0,Te(Ye)&&(rr=!!Ye.leading,Li="maxWait"in Ye,Rt=Li?ue(Ae(Ye.maxWait)||0,Fe):Rt,di="trailing"in Ye?!!Ye.trailing:di);function Bi(si){var Ti=it,ui=jt;return it=jt=void 0,Ai=si,li=ze.apply(ui,Ti),li}function jr(si){return Ai=si,Xt=setTimeout(An,Fe),rr?Bi(si):li}function Ln(si){var Ti=si-Pt,ui=si-Ai,ki=Fe-Ti;return Li?oe(ki,Rt-ui):ki}function Nn(si){var Ti=si-Pt,ui=si-Ai;return Pt===void 0||Ti>=Fe||Ti<0||Li&&ui>=Rt}function An(){var si=ge();if(Nn(si))return yr(si);Xt=setTimeout(An,Ln(si))}function yr(si){return Xt=void 0,di&&it?Bi(si):(it=jt=void 0,li)}function qn(){Xt!==void 0&&clearTimeout(Xt),Ai=0,it=Pt=jt=Xt=void 0}function ii(){return Xt===void 0?li:yr(ge())}function Si(){var si=ge(),Ti=Nn(si);if(it=arguments,jt=this,Pt=si,Ti){if(Xt===void 0)return jr(Pt);if(Li)return Xt=setTimeout(An,Fe),Bi(Pt)}return Xt===void 0&&(Xt=setTimeout(An,Fe)),li}return Si.cancel=qn,Si.flush=ii,Si}function Te(ze){var Fe=typeof ze;return!!ze&&(Fe=="object"||Fe=="function")}function Le(ze){return!!ze&&typeof ze=="object"}function Oe(ze){return typeof ze=="symbol"||Le(ze)&&re.call(ze)==b}function Ae(ze){if(typeof ze=="number")return ze;if(Oe(ze))return y;if(Te(ze)){var Fe=typeof ze.valueOf=="function"?ze.valueOf():ze;ze=Te(Fe)?Fe+"":Fe}if(typeof ze!="string")return ze===0?ze:+ze;ze=ze.replace(S,"");var Ye=R.test(ze);return Ye||k.test(ze)?o(ze.slice(2),Ye?2:8):M.test(ze)?y:+ze}return w0=K,w0}var Ag={exports:{}},PT;function HF(){if(PT)return Ag.exports;PT=1;var m=typeof Reflect=="object"?Reflect:null,y=m&&typeof m.apply=="function"?m.apply:function(ze,Fe,Ye){return Function.prototype.apply.call(ze,Fe,Ye)},b;m&&typeof m.ownKeys=="function"?b=m.ownKeys:Object.getOwnPropertySymbols?b=function(ze){return Object.getOwnPropertyNames(ze).concat(Object.getOwnPropertySymbols(ze))}:b=function(ze){return Object.getOwnPropertyNames(ze)};function S(Ae){console&&console.warn&&console.warn(Ae)}var M=Number.isNaN||function(ze){return ze!==ze};function R(){R.init.call(this)}Ag.exports=R,Ag.exports.once=Te,R.EventEmitter=R,R.prototype._events=void 0,R.prototype._eventsCount=0,R.prototype._maxListeners=void 0;var k=10;function o(Ae){if(typeof Ae!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof Ae)}Object.defineProperty(R,"defaultMaxListeners",{enumerable:!0,get:function(){return k},set:function(Ae){if(typeof Ae!="number"||Ae<0||M(Ae))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+Ae+".");k=Ae}}),R.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},R.prototype.setMaxListeners=function(ze){if(typeof ze!="number"||ze<0||M(ze))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+ze+".");return this._maxListeners=ze,this};function G(Ae){return Ae._maxListeners===void 0?R.defaultMaxListeners:Ae._maxListeners}R.prototype.getMaxListeners=function(){return G(this)},R.prototype.emit=function(ze){for(var Fe=[],Ye=1;Ye<arguments.length;Ye++)Fe.push(arguments[Ye]);var it=ze==="error",jt=this._events;if(jt!==void 0)it=it&&jt.error===void 0;else if(!it)return!1;if(it){var Rt;if(Fe.length>0&&(Rt=Fe[0]),Rt instanceof Error)throw Rt;var li=new Error("Unhandled error."+(Rt?" ("+Rt.message+")":""));throw li.context=Rt,li}var Xt=jt[ze];if(Xt===void 0)return!1;if(typeof Xt=="function")y(Xt,this,Fe);else for(var Pt=Xt.length,Ai=oe(Xt,Pt),Ye=0;Ye<Pt;++Ye)y(Ai[Ye],this,Fe);return!0};function Z(Ae,ze,Fe,Ye){var it,jt,Rt;if(o(Fe),jt=Ae._events,jt===void 0?(jt=Ae._events=Object.create(null),Ae._eventsCount=0):(jt.newListener!==void 0&&(Ae.emit("newListener",ze,Fe.listener?Fe.listener:Fe),jt=Ae._events),Rt=jt[ze]),Rt===void 0)Rt=jt[ze]=Fe,++Ae._eventsCount;else if(typeof Rt=="function"?Rt=jt[ze]=Ye?[Fe,Rt]:[Rt,Fe]:Ye?Rt.unshift(Fe):Rt.push(Fe),it=G(Ae),it>0&&Rt.length>it&&!Rt.warned){Rt.warned=!0;var li=new Error("Possible EventEmitter memory leak detected. "+Rt.length+" "+String(ze)+" listeners added. Use emitter.setMaxListeners() to increase limit");li.name="MaxListenersExceededWarning",li.emitter=Ae,li.type=ze,li.count=Rt.length,S(li)}return Ae}R.prototype.addListener=function(ze,Fe){return Z(this,ze,Fe,!1)},R.prototype.on=R.prototype.addListener,R.prototype.prependListener=function(ze,Fe){return Z(this,ze,Fe,!0)};function ee(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function ie(Ae,ze,Fe){var Ye={fired:!1,wrapFn:void 0,target:Ae,type:ze,listener:Fe},it=ee.bind(Ye);return it.listener=Fe,Ye.wrapFn=it,it}R.prototype.once=function(ze,Fe){return o(Fe),this.on(ze,ie(this,ze,Fe)),this},R.prototype.prependOnceListener=function(ze,Fe){return o(Fe),this.prependListener(ze,ie(this,ze,Fe)),this},R.prototype.removeListener=function(ze,Fe){var Ye,it,jt,Rt,li;if(o(Fe),it=this._events,it===void 0)return this;if(Ye=it[ze],Ye===void 0)return this;if(Ye===Fe||Ye.listener===Fe)--this._eventsCount===0?this._events=Object.create(null):(delete it[ze],it.removeListener&&this.emit("removeListener",ze,Ye.listener||Fe));else if(typeof Ye!="function"){for(jt=-1,Rt=Ye.length-1;Rt>=0;Rt--)if(Ye[Rt]===Fe||Ye[Rt].listener===Fe){li=Ye[Rt].listener,jt=Rt;break}if(jt<0)return this;jt===0?Ye.shift():ge(Ye,jt),Ye.length===1&&(it[ze]=Ye[0]),it.removeListener!==void 0&&this.emit("removeListener",ze,li||Fe)}return this},R.prototype.off=R.prototype.removeListener,R.prototype.removeAllListeners=function(ze){var Fe,Ye,it;if(Ye=this._events,Ye===void 0)return this;if(Ye.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):Ye[ze]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete Ye[ze]),this;if(arguments.length===0){var jt=Object.keys(Ye),Rt;for(it=0;it<jt.length;++it)Rt=jt[it],Rt!=="removeListener"&&this.removeAllListeners(Rt);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(Fe=Ye[ze],typeof Fe=="function")this.removeListener(ze,Fe);else if(Fe!==void 0)for(it=Fe.length-1;it>=0;it--)this.removeListener(ze,Fe[it]);return this};function re(Ae,ze,Fe){var Ye=Ae._events;if(Ye===void 0)return[];var it=Ye[ze];return it===void 0?[]:typeof it=="function"?Fe?[it.listener||it]:[it]:Fe?K(it):oe(it,it.length)}R.prototype.listeners=function(ze){return re(this,ze,!0)},R.prototype.rawListeners=function(ze){return re(this,ze,!1)},R.listenerCount=function(Ae,ze){return typeof Ae.listenerCount=="function"?Ae.listenerCount(ze):ue.call(Ae,ze)},R.prototype.listenerCount=ue;function ue(Ae){var ze=this._events;if(ze!==void 0){var Fe=ze[Ae];if(typeof Fe=="function")return 1;if(Fe!==void 0)return Fe.length}return 0}R.prototype.eventNames=function(){return this._eventsCount>0?b(this._events):[]};function oe(Ae,ze){for(var Fe=new Array(ze),Ye=0;Ye<ze;++Ye)Fe[Ye]=Ae[Ye];return Fe}function ge(Ae,ze){for(;ze+1<Ae.length;ze++)Ae[ze]=Ae[ze+1];Ae.pop()}function K(Ae){for(var ze=new Array(Ae.length),Fe=0;Fe<ze.length;++Fe)ze[Fe]=Ae[Fe].listener||Ae[Fe];return ze}function Te(Ae,ze){return new Promise(function(Fe,Ye){function it(Rt){Ae.removeListener(ze,jt),Ye(Rt)}function jt(){typeof Ae.removeListener=="function"&&Ae.removeListener("error",it),Fe([].slice.call(arguments))}Oe(Ae,ze,jt,{once:!0}),ze!=="error"&&Le(Ae,it,{once:!0})})}function Le(Ae,ze,Fe){typeof Ae.on=="function"&&Oe(Ae,"error",ze,Fe)}function Oe(Ae,ze,Fe,Ye){if(typeof Ae.on=="function")Ye.once?Ae.once(ze,Fe):Ae.on(ze,Fe);else if(typeof Ae.addEventListener=="function")Ae.addEventListener(ze,function it(jt){Ye.once&&Ae.removeEventListener(ze,it),Fe(jt)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof Ae)}return Ag.exports}var T0,LT;function ZF(){return LT||(LT=1,T0={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}}),T0}var E0,RT;function $F(){if(RT)return E0;RT=1;function m(S){var M=S.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return M?{key:M[1],value:M[2]}:null}function y(S){var M=S.match(/<?([^>]*)>(.*)/);if(!M)return null;var R=M[1],k=M[2].split(";"),o=null,G=k.reduce(function(Z,ee){var ie=m(ee);return ie?ie.key==="rel"?(o||(o=ie.value),Z):(Z[ie.key]=ie.value,Z):Z},{});return o?{url:R,rel:o,params:G}:null}function b(S){return S?S.split(/,\s*</).reduce(function(M,R){var k=y(R);if(!k)return M;var o=k.rel.split(/\s+/);return o.forEach(function(G){M[G]||(M[G]={url:k.url,params:k.params})}),M},{}):{}}return E0=b,E0}var S0,DT;function WF(){if(DT)return S0;DT=1;var m=$F();function y(b,S){this.request=b,this.headers=S.headers,this.rawBody=S.body,this.statusCode=S.statusCode;try{this.body=JSON.parse(S.body||"{}")}catch{this.body=S.body}this.links=m(this.headers.link)}return y.prototype.hasNextPage=function(){return!!this.links.next},y.prototype.nextPage=function(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null},S0=y,S0}var I0,OT;function Kg(){return OT||(OT=1,I0={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"}),I0}var A0,zT;function XF(){if(zT)return A0;zT=1;var m=Kg();function y(b){var S=b.type||m.ERROR_HTTP,M;if(b.body)try{M=JSON.parse(b.body)}catch{M=b.body}else M=null;var R=b.message||null;R||(typeof M=="string"?R=M:M&&typeof M.message=="string"?R=M.message:S===m.ERROR_REQUEST_ABORTED&&(R="Request aborted")),this.message=R,this.type=S,this.statusCode=b.statusCode||null,this.request=b.request,this.body=M}return A0=y,A0}var C0,kT;function YF(){if(kT)return C0;kT=1;function m(b){var S=b.indexOf(":"),M=b.substring(0,S).trim().toLowerCase(),R=b.substring(S+1).trim();return{name:M,value:R}}function y(b){var S={};return b&&b.trim().split(/[\r|\n]+/).forEach(function(M){var R=m(M);S[R.name]=R.value}),S}return C0=y,C0}var M0,FT;function JF(){if(FT)return M0;FT=1;var m=WF(),y=XF(),b=Kg(),S=YF(),M={};function R(ie){var re=M[ie.id];re&&(re.abort(),delete M[ie.id])}function k(ie,re){return new m(ie,{body:re.response,headers:S(re.getAllResponseHeaders()),statusCode:re.status})}function o(ie){var re=ie.total,ue=ie.loaded,oe=100*ue/re;return{total:re,transferred:ue,percent:oe}}function G(ie,re){return new Promise(function(ue,oe){re.onprogress=function(Te){ie.emitter.emit(b.EVENT_PROGRESS_DOWNLOAD,o(Te))};var ge=ie.file;ge&&(re.upload.onprogress=function(Te){ie.emitter.emit(b.EVENT_PROGRESS_UPLOAD,o(Te))}),re.onerror=function(Te){oe(Te)},re.onabort=function(){var Te=new y({request:ie,type:b.ERROR_REQUEST_ABORTED});oe(Te)},re.onload=function(){if(delete M[ie.id],re.status<200||re.status>=400){var Te=new y({request:ie,body:re.response,statusCode:re.status});oe(Te);return}ue(re)};var K=ie.body;typeof K=="string"?re.send(K):K?re.send(JSON.stringify(K)):ge?re.send(ge):re.send(),M[ie.id]=re}).then(function(ue){return k(ie,ue)})}function Z(ie,re){var ue=ie.url(re),oe=new window.XMLHttpRequest;return oe.open(ie.method,ue),Object.keys(ie.headers).forEach(function(ge){oe.setRequestHeader(ge,ie.headers[ge])}),oe}function ee(ie){return Promise.resolve().then(function(){var re=Z(ie,ie.client.accessToken);return G(ie,re)})}return M0={browserAbort:R,sendRequestXhr:G,browserSend:ee,createRequestXhr:Z},M0}var am={exports:{}};var KF=am.exports,BT;function QF(){return BT||(BT=1,(function(m,y){(function(b){var S=y,M=m&&m.exports==S&&m,R=typeof oa=="object"&&oa;(R.global===R||R.window===R)&&(b=R);var k=function(oe){this.message=oe};k.prototype=new Error,k.prototype.name="InvalidCharacterError";var o=function(oe){throw new k(oe)},G="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Z=/[\t\n\f\r ]/g,ee=function(oe){oe=String(oe).replace(Z,"");var ge=oe.length;ge%4==0&&(oe=oe.replace(/==?$/,""),ge=oe.length),(ge%4==1||/[^+a-zA-Z0-9/]/.test(oe))&&o("Invalid character: the string to be decoded is not correctly encoded.");for(var K=0,Te,Le,Oe="",Ae=-1;++Ae<ge;)Le=G.indexOf(oe.charAt(Ae)),Te=K%4?Te*64+Le:Le,K++%4&&(Oe+=String.fromCharCode(255&Te>>(-2*K&6)));return Oe},ie=function(oe){oe=String(oe),/[^\0-\xFF]/.test(oe)&&o("The string to be encoded contains characters outside of the Latin1 range.");for(var ge=oe.length%3,K="",Te=-1,Le,Oe,Ae,ze,Fe=oe.length-ge;++Te<Fe;)Le=oe.charCodeAt(Te)<<16,Oe=oe.charCodeAt(++Te)<<8,Ae=oe.charCodeAt(++Te),ze=Le+Oe+Ae,K+=G.charAt(ze>>18&63)+G.charAt(ze>>12&63)+G.charAt(ze>>6&63)+G.charAt(ze&63);return ge==2?(Le=oe.charCodeAt(Te)<<8,Oe=oe.charCodeAt(++Te),ze=Le+Oe,K+=G.charAt(ze>>10)+G.charAt(ze>>4&63)+G.charAt(ze<<2&63)+"="):ge==1&&(ze=oe.charCodeAt(Te),K+=G.charAt(ze>>2)+G.charAt(ze<<4&63)+"=="),K},re={encode:ie,decode:ee,version:"0.1.0"};if(S&&!S.nodeType)if(M)M.exports=re;else for(var ue in re)re.hasOwnProperty(ue)&&(S[ue]=re[ue]);else b.base64=re})(KF)})(am,am.exports)),am.exports}var P0,NT;function vS(){if(NT)return P0;NT=1;var m=QF(),y={};function b(R){if(y[R])return y[R];var k=R.split("."),o=k[0],G=k[1];if(!G)throw new Error("Invalid token");var Z=S(G),ee={usage:o,user:Z.u};return M(Z,"a")&&(ee.authorization=Z.a),M(Z,"exp")&&(ee.expires=Z.exp*1e3),M(Z,"iat")&&(ee.created=Z.iat*1e3),M(Z,"scopes")&&(ee.scopes=Z.scopes),M(Z,"client")&&(ee.client=Z.client),M(Z,"ll")&&(ee.lastLogin=Z.ll),M(Z,"iu")&&(ee.impersonator=Z.iu),y[R]=ee,ee}function S(R){try{return JSON.parse(m.decode(R))}catch{throw new Error("Invalid token")}}function M(R,k){return Object.prototype.hasOwnProperty.call(R,k)}return P0=b,P0}var L0={exports:{}},VT;function eB(){return VT||(VT=1,(function(m){var y=Object.prototype.hasOwnProperty,b="~";function S(){}Object.create&&(S.prototype=Object.create(null),new S().__proto__||(b=!1));function M(G,Z,ee){this.fn=G,this.context=Z,this.once=ee||!1}function R(G,Z,ee,ie,re){if(typeof ee!="function")throw new TypeError("The listener must be a function");var ue=new M(ee,ie||G,re),oe=b?b+Z:Z;return G._events[oe]?G._events[oe].fn?G._events[oe]=[G._events[oe],ue]:G._events[oe].push(ue):(G._events[oe]=ue,G._eventsCount++),G}function k(G,Z){--G._eventsCount===0?G._events=new S:delete G._events[Z]}function o(){this._events=new S,this._eventsCount=0}o.prototype.eventNames=function(){var Z=[],ee,ie;if(this._eventsCount===0)return Z;for(ie in ee=this._events)y.call(ee,ie)&&Z.push(b?ie.slice(1):ie);return Object.getOwnPropertySymbols?Z.concat(Object.getOwnPropertySymbols(ee)):Z},o.prototype.listeners=function(Z){var ee=b?b+Z:Z,ie=this._events[ee];if(!ie)return[];if(ie.fn)return[ie.fn];for(var re=0,ue=ie.length,oe=new Array(ue);re<ue;re++)oe[re]=ie[re].fn;return oe},o.prototype.listenerCount=function(Z){var ee=b?b+Z:Z,ie=this._events[ee];return ie?ie.fn?1:ie.length:0},o.prototype.emit=function(Z,ee,ie,re,ue,oe){var ge=b?b+Z:Z;if(!this._events[ge])return!1;var K=this._events[ge],Te=arguments.length,Le,Oe;if(K.fn){switch(K.once&&this.removeListener(Z,K.fn,void 0,!0),Te){case 1:return K.fn.call(K.context),!0;case 2:return K.fn.call(K.context,ee),!0;case 3:return K.fn.call(K.context,ee,ie),!0;case 4:return K.fn.call(K.context,ee,ie,re),!0;case 5:return K.fn.call(K.context,ee,ie,re,ue),!0;case 6:return K.fn.call(K.context,ee,ie,re,ue,oe),!0}for(Oe=1,Le=new Array(Te-1);Oe<Te;Oe++)Le[Oe-1]=arguments[Oe];K.fn.apply(K.context,Le)}else{var Ae=K.length,ze;for(Oe=0;Oe<Ae;Oe++)switch(K[Oe].once&&this.removeListener(Z,K[Oe].fn,void 0,!0),Te){case 1:K[Oe].fn.call(K[Oe].context);break;case 2:K[Oe].fn.call(K[Oe].context,ee);break;case 3:K[Oe].fn.call(K[Oe].context,ee,ie);break;case 4:K[Oe].fn.call(K[Oe].context,ee,ie,re);break;default:if(!Le)for(ze=1,Le=new Array(Te-1);ze<Te;ze++)Le[ze-1]=arguments[ze];K[Oe].fn.apply(K[Oe].context,Le)}}return!0},o.prototype.on=function(Z,ee,ie){return R(this,Z,ee,ie,!1)},o.prototype.once=function(Z,ee,ie){return R(this,Z,ee,ie,!0)},o.prototype.removeListener=function(Z,ee,ie,re){var ue=b?b+Z:Z;if(!this._events[ue])return this;if(!ee)return k(this,ue),this;var oe=this._events[ue];if(oe.fn)oe.fn===ee&&(!re||oe.once)&&(!ie||oe.context===ie)&&k(this,ue);else{for(var ge=0,K=[],Te=oe.length;ge<Te;ge++)(oe[ge].fn!==ee||re&&!oe[ge].once||ie&&oe[ge].context!==ie)&&K.push(oe[ge]);K.length?this._events[ue]=K.length===1?K[0]:K:k(this,ue)}return this},o.prototype.removeAllListeners=function(Z){var ee;return Z?(ee=b?b+Z:Z,this._events[ee]&&k(this,ee)):(this._events=new S,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=b,o.EventEmitter=o,m.exports=o})(L0)),L0.exports}var R0,UT;function tB(){if(UT)return R0;UT=1;function m(k){return k.map(encodeURIComponent).join(",")}function y(k){return Array.isArray(k)?m(k):encodeURIComponent(String(k))}function b(k,o,G){if(G===!1||G===null)return k;var Z=/\?/.test(k)?"&":"?",ee=encodeURIComponent(o);return G!==void 0&&G!==""&&G!==!0&&(ee+="="+y(G)),""+k+Z+ee}function S(k,o){if(!o)return k;var G=k;return Object.keys(o).forEach(function(Z){var ee=o[Z];ee!==void 0&&(Array.isArray(ee)&&(ee=ee.filter(function(ie){return ie!=null}).join(",")),G=b(G,Z,ee))}),G}function M(k,o){if(!o||k.slice(0,4)==="http")return k;var G=k[0]==="/"?"":"/";return""+o.replace(/\/$/,"")+G+k}function R(k,o){return o?k.replace(/\/:([a-zA-Z0-9]+)/g,function(G,Z){var ee=o[Z];if(ee===void 0)throw new Error("Unspecified route parameter "+Z);var ie=y(ee);return"/"+ie}):k}return R0={appendQueryObject:S,appendQueryParam:b,prependOrigin:M,interpolateRouteParams:R},R0}var D0,jT;function iB(){if(jT)return D0;jT=1;var m=vS(),y=Kd(),b=eB(),S=tB(),M=Kg(),R=1;function k(o,G){if(!o)throw new Error("MapiRequest requires a client");if(!G||!G.path||!G.method)throw new Error("MapiRequest requires an options object with path and method properties");var Z={};G.body&&(Z["content-type"]="application/json");var ee=y(Z,G.headers),ie=Object.keys(ee).reduce(function(re,ue){return re[ue.toLowerCase()]=ee[ue],re},{});this.id=R++,this._options=G,this.emitter=new b,this.client=o,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=G.path,this.method=G.method,this.origin=G.origin||o.origin,this.query=G.query||{},this.params=G.params||{},this.body=G.body||null,this.file=G.file||null,this.encoding=G.encoding||"utf8",this.sendFileAs=G.sendFileAs||null,this.headers=ie}return k.prototype.url=function(G){var Z=S.prependOrigin(this.path,this.origin);Z=S.appendQueryObject(Z,this.query);var ee=this.params,ie=G??this.client.accessToken;if(ie){Z=S.appendQueryParam(Z,"access_token",ie);var re=m(ie).user;ee=y({ownerId:re},ee)}return Z=S.interpolateRouteParams(Z,ee),Z},k.prototype.send=function(){var G=this;if(G.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return G.sent=!0,G.client.sendRequest(G).then(function(Z){return G.response=Z,G.emitter.emit(M.EVENT_RESPONSE,Z),Z},function(Z){throw G.error=Z,G.emitter.emit(M.EVENT_ERROR,Z),Z})},k.prototype.abort=function(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))},k.prototype.eachPage=function(G){var Z=this;function ee(ue){function oe(){delete Z._nextPageRequest;var ge=ue.nextPage();ge&&(Z._nextPageRequest=ge,re(ge))}G(null,ue,oe)}function ie(ue){G(ue,null,function(){})}function re(ue){ue.send().then(ee,ie)}re(this)},k.prototype.clone=function(){return this._extend()},k.prototype._extend=function(G){var Z=y(this._options,G);return new k(this.client,Z)},D0=k,D0}var O0,GT;function xS(){if(GT)return O0;GT=1;var m=vS(),y=iB(),b=Kg();function S(M){if(!M||!M.accessToken)throw new Error("Cannot create a client without an access token");m(M.accessToken),this.accessToken=M.accessToken,this.origin=M.origin||b.API_ORIGIN}return S.prototype.createRequest=function(R){return new y(this,R)},O0=S,O0}var z0,qT;function bS(){if(qT)return z0;qT=1;var m=JF(),y=xS();function b(M){y.call(this,M)}b.prototype=Object.create(y.prototype),b.prototype.constructor=b,b.prototype.sendRequest=m.browserSend,b.prototype.abortRequest=m.browserAbort;function S(M){return new b(M)}return z0=S,z0}var k0,HT;function rB(){if(HT)return k0;HT=1;var m=bS();return k0=m,k0}var F0,ZT;function nB(){if(ZT)return F0;ZT=1;var m=Object.prototype.toString;return F0=function(y){var b;return m.call(y)==="[object Object]"&&(b=Object.getPrototypeOf(y),b===null||b===Object.getPrototypeOf({}))},F0}var B0,$T;function oB(){if($T)return B0;$T=1;var m=nB(),y=Kd(),b="value",S=`
  `,M={};M.assert=function(oe,ge){return ge=ge||{},function(K){var Te=k(oe,K);if(Te){var Le=o(Te,ge);throw ge.apiName&&(Le=ge.apiName+": "+Le),new Error(Le)}}},M.shape=function(ge){var K=ue(ge);return function(Le){var Oe=k(M.plainObject,Le);if(Oe)return Oe;for(var Ae,ze,Fe=[],Ye=0;Ye<K.length;Ye++)Ae=K[Ye].key,ze=K[Ye].value,Oe=k(ze,Le[Ae]),Oe&&Fe.push([Ae].concat(Oe));return Fe.length<2?Fe[0]:function(it){Fe=Fe.map(function(li){var Xt=li[0],Pt=o(li,it).split(`
`).join(S);return"- "+Xt+": "+Pt});var jt=it.path.join("."),Rt=jt===b?"":" of "+jt;return"The following properties"+Rt+" have invalid values:"+S+Fe.join(S)}}},M.strictShape=function(ge){var K=M.shape(ge);return function(Le){var Oe=K(Le);if(Oe)return Oe;var Ae=Object.keys(Le).reduce(function(ze,Fe){return ge[Fe]===void 0&&ze.push(Fe),ze},[]);if(Ae.length!==0)return function(){return"The following keys are invalid: "+Ae.join(", ")}}},M.arrayOf=function(ge){return R(ge)},M.tuple=function(){var ge=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return R(ge)};function R(oe){var ge=Array.isArray(oe),K=function(Te){return ge?oe[Te]:oe};return function(Le){var Oe=k(M.plainArray,Le);if(Oe)return Oe;if(ge&&Le.length!==oe.length)return"an array with "+oe.length+" items";for(var Ae=0;Ae<Le.length;Ae++)if(Oe=k(K(Ae),Le[Ae]),Oe)return[Ae].concat(Oe)}}M.required=function(ge){function K(Te){return Te==null?function(Le){return ie(Le,re(Le.path)?"cannot be undefined/null.":"is required.")}:ge.apply(this,arguments)}return K.__required=!0,K},M.oneOfType=function(){var ge=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(Te){var Le=ge.map(function(Oe){return k(Oe,Te)}).filter(Boolean);if(Le.length===ge.length)return Le.every(function(Oe){return Oe.length===1&&typeof Oe[0]=="string"})?G(Le.map(function(Oe){return Oe[0]})):Le.reduce(function(Oe,Ae){return Ae.length>Oe.length?Ae:Oe})}},M.equal=function(ge){return function(Te){if(Te!==ge)return JSON.stringify(ge)}},M.oneOf=function(){var ge=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),K=ge.map(function(Te){return M.equal(Te)});return M.oneOfType.apply(this,K)},M.range=function(ge){var K=ge[0],Te=ge[1];return function(Oe){var Ae=k(M.number,Oe);if(Ae||Oe<K||Oe>Te)return"number between "+K+" & "+Te+" (inclusive)"}},M.any=function(){},M.boolean=function(ge){if(typeof ge!="boolean")return"boolean"},M.number=function(ge){if(typeof ge!="number")return"number"},M.plainArray=function(ge){if(!Array.isArray(ge))return"array"},M.plainObject=function(ge){if(!m(ge))return"object"},M.string=function(ge){if(typeof ge!="string")return"string"},M.func=function(ge){if(typeof ge!="function")return"function"};function k(oe,ge){if(!(ge==null&&!oe.hasOwnProperty("__required"))){var K=oe(ge);if(K)return Array.isArray(K)?K:[K]}}function o(oe,ge){var K=oe.length,Te=oe[K-1],Le=oe.slice(0,K-1);return Le.length===0&&(Le=[b]),ge=y(ge,{path:Le}),typeof Te=="function"?Te(ge):ie(ge,Z(Te))}function G(oe){return oe.length<2?oe[0]:oe.length===2?oe.join(" or "):oe.slice(0,-1).join(", ")+", or "+oe.slice(-1)}function Z(oe){return"must be "+ee(oe)+"."}function ee(oe){return/^an? /.test(oe)?oe:/^[aeiou]/i.test(oe)?"an "+oe:/^[a-z]/i.test(oe)?"a "+oe:oe}function ie(oe,ge){var K=re(oe.path),Te=oe.path.join(".")+" "+ge,Le=K?"Item at position ":"";return Le+Te}function re(oe){return typeof oe[oe.length-1]=="number"||typeof oe[0]=="number"}function ue(oe){return Object.keys(oe||{}).map(function(ge){return{key:ge,value:oe[ge]}})}return M.validate=k,M.processMessage=o,B0=M,B0}var N0,WT;function sB(){if(WT)return N0;WT=1;var m=Kd(),y=oB();function b(k){if(typeof window<"u")return k instanceof oa.Blob||k instanceof oa.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof k=="string"||k.pipe!==void 0))return"Filename or Readable stream"}function S(k,o){return y.assert(y.strictShape(k),o)}function M(k){var o="date";if(typeof k=="boolean")return o;try{var G=new Date(k);if(G.getTime&&isNaN(G.getTime()))return o}catch{return o}}function R(k){return y.tuple(y.number,y.number)(k)}return N0=m(y,{file:b,date:M,coordinates:R,assertShape:S}),N0}var V0,XT;function aB(){if(XT)return V0;XT=1;function m(y,b){var S=function(M,R){return b.indexOf(M)!==-1&&R!==void 0};return typeof b=="function"&&(S=b),Object.keys(y).filter(function(M){return S(M,y[M])}).reduce(function(M,R){return M[R]=y[R],M},{})}return V0=m,V0}var U0,YT;function lB(){if(YT)return U0;YT=1;function m(y,b){return Object.keys(y).reduce(function(S,M){return S[M]=b(M,y[M]),S},{})}return U0=m,U0}var j0,JT;function cB(){if(JT)return j0;JT=1;var m=lB();function y(b){return m(b,function(S,M){return typeof M=="boolean"?JSON.stringify(M):M})}return j0=y,j0}var G0,KT;function uB(){if(KT)return G0;KT=1;var m=xS(),y=bS();function b(S){return function(M){var R;m.prototype.isPrototypeOf(M)?R=M:R=y(M);var k=Object.create(S);return k.client=R,k}}return G0=b,G0}var q0,QT;function hB(){if(QT)return q0;QT=1;var m=Kd(),y=sB(),b=aB(),S=cB(),M=uB(),R={},k=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];return R.forwardGeocode=function(o){y.assertShape({query:y.required(y.string),mode:y.oneOf("mapbox.places","mapbox.places-permanent"),countries:y.arrayOf(y.string),proximity:y.oneOf(y.coordinates,"ip"),types:y.arrayOf(y.oneOf(k)),autocomplete:y.boolean,bbox:y.arrayOf(y.number),limit:y.number,language:y.arrayOf(y.string),routing:y.boolean,fuzzyMatch:y.boolean,worldview:y.string,session_token:y.string})(o),o.mode=o.mode||"mapbox.places";var G=S(m({country:o.countries},b(o,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:b(o,["mode","query"]),query:G})},R.reverseGeocode=function(o){y.assertShape({query:y.required(y.coordinates),mode:y.oneOf("mapbox.places","mapbox.places-permanent"),countries:y.arrayOf(y.string),types:y.arrayOf(y.oneOf(k)),bbox:y.arrayOf(y.number),limit:y.number,language:y.arrayOf(y.string),reverseMode:y.oneOf("distance","score"),routing:y.boolean,worldview:y.string,session_token:y.string})(o),o.mode=o.mode||"mapbox.places";var G=S(m({country:o.countries},b(o,["country","types","bbox","limit","language","reverseMode","routing","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:b(o,["mode","query"]),query:G})},q0=M(R),q0}let dB="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",wS=m=>crypto.getRandomValues(new Uint8Array(m)),TS=(m,y,b)=>{let S=(2<<Math.log(m.length-1)/Math.LN2)-1,M=-~(1.6*S*y/m.length);return(R=y)=>{let k="";for(;;){let o=b(M),G=M|0;for(;G--;)if(k+=m[o[G]&S]||"",k.length===R)return k}}},fB=(m,y=21)=>TS(m,y,wS),pB=(m=21)=>crypto.getRandomValues(new Uint8Array(m)).reduce((y,b)=>(b&=63,b<36?y+=b.toString(36):b<62?y+=(b-26).toString(36).toUpperCase():b>62?y+="-":y+="_",y),"");const mB=Object.freeze(Object.defineProperty({__proto__:null,customAlphabet:fB,customRandom:TS,nanoid:pB,random:wS,urlAlphabet:dB},Symbol.toStringTag,{value:"Module"})),_B=uM(mB);var H0,eE;function gB(){if(eE)return H0;eE=1;var m=_B.nanoid;function y(b){this.origin=b.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=b.accessToken,this.version="0.3.0",this.pluginSessionID=this.generateSessionID(),this.sessionIncrementer=0,this.userAgent=this.getUserAgent(),this.options=b,this.send=this.send.bind(this),this.countries=b.countries?b.countries.split(","):null,this.types=b.types?b.types.split(","):null,this.bbox=b.bbox?b.bbox:null,this.language=b.language?b.language.split(","):null,this.limit=b.limit?+b.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(b),this.eventQueue=new Array,this.flushInterval=b.flushInterval||1e3,this.maxQueueSize=b.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}return y.prototype={select:function(b,S){var M=this.getEventPayload("search.select",S,{selectedFeature:b});if(M&&!(M.resultIndex===this.lastSentIndex&&M.queryString===this.lastSentInput||M.resultIndex==-1))return this.lastSentIndex=M.resultIndex,this.lastSentInput=M.queryString,this.push(M)},start:function(b){var S=this.getEventPayload("search.start",b);if(S)return this.push(S)},keyevent:function(b,S){if(b.key&&!(b.metaKey||[9,27,37,39,13,38,40].indexOf(b.keyCode)!==-1)){var M=this.getEventPayload("search.keystroke",S,{key:b.key});if(M)return this.push(M)}},send:function(b,S){if(!this.enableEventLogging)return S?S():void 0;var M=this.getRequestOptions(b);this.request(M,(function(R){if(R)return this.handleError(R,S);if(S)return S()}).bind(this))},getRequestOptions:function(b){Array.isArray(b)||(b=[b]);var S={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(b)};return S},getEventPayload:function(b,S,M={}){if(b==="search.select"&&!M.selectedFeature||b==="search.keystroke"&&!M.key)return null;var R;if(!S.options.proximity)R=null;else if(typeof S.options.proximity=="object")R=[S.options.proximity.longitude,S.options.proximity.latitude];else if(S.options.proximity==="ip"){var k=S._headers?S._headers["ip-proximity"]:null;k&&typeof k=="string"?R=k.split(",").map(parseFloat):R=[999,999]}else R=S.options.proximity;var o=S._map?S._map.getZoom():void 0,G={event:b,version:this.getEventSchemaVersion(b),created:+new Date,sessionIdentifier:this.getSessionId(),country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:S.options.autocomplete,fuzzyMatch:S.options.fuzzyMatch,proximity:R,limit:S.options.limit,routing:S.options.routing,worldview:S.options.worldview,mapZoom:o,keyboardLocale:this.locale};if(b==="search.select"?G.queryString=S.inputString:b!="search.select"&&S._inputEl?G.queryString=S._inputEl.value:G.queryString=S.inputString,["search.keystroke","search.select"].includes(b)&&(G.path="geocoding/v5/mapbox.places"),b==="search.keystroke"&&M.key)G.lastAction=M.key;else if(b==="search.select"&&M.selectedFeature){var Z=M.selectedFeature,ee=this.getSelectedIndex(Z,S);if(G.resultIndex=ee,G.resultPlaceName=Z.place_name,G.resultId=Z.id,Z.properties&&(G.resultMapboxId=Z.properties.mapbox_id),S._typeahead){var ie=S._typeahead.data;ie&&ie.length>0&&(G.suggestionIds=this.getSuggestionIds(ie),G.suggestionNames=this.getSuggestionNames(ie),G.suggestionTypes=this.getSuggestionTypes(ie),G.suggestionSources=this.getSuggestionSources(ie))}}return this.validatePayload(G)?G:null},request:function(b,S){var M=new XMLHttpRequest;M.onreadystatechange=function(){if(this.readyState==4)return this.status==204?S(null):S(this.statusText)},M.open(b.method,b.host+"/"+b.path,!0);for(var R in b.headers){var k=b.headers[R];M.setRequestHeader(R,k)}M.send(b.body)},handleError:function(b,S){if(S)return S(b)},generateSessionID:function(){return m()},getSessionId:function(){return this.pluginSessionID+"."+this.sessionIncrementer},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(b,S){if(S._typeahead){var M=S._typeahead.data,R=b.id,k=M.map(function(G){return G.id}),o=k.indexOf(R);return o}},getSuggestionIds:function(b){return b.map(function(S){return S.properties?S.properties.mapbox_id||"":S.id||""})},getSuggestionNames:function(b){return b.map(function(S){return S.place_name||""})},getSuggestionTypes:function(b){return b.map(function(S){return S.place_type&&Array.isArray(S.place_type)&&S.place_type[0]||""})},getSuggestionSources:function(b){return b.map(function(S){return S._source||""})},getEventSchemaVersion:function(b){return["search.keystroke","search.select"].includes(b)?"2.2":"2.0"},validatePayload:function(b){if(!b||!b.event)return!1;var S=["event","created","sessionIdentifier","queryString"],M=["event","created","sessionIdentifier","queryString","lastAction"],R=["event","created","sessionIdentifier","queryString","resultIndex","path","suggestionIds"],k=b.event;return k==="search.start"?this.objectHasRequiredProps(b,S):k==="search.keystroke"?this.objectHasRequiredProps(b,M):k==="search.select"?this.objectHasRequiredProps(b,R):!0},objectHasRequiredProps:function(b,S){return S.every(function(M){return M==="queryString"?typeof b[M]=="string"&&b[M].length>0:b[M]!==void 0})},shouldEnableLogging:function(b){return!(b.enableEventLogging===!1||b.origin&&b.origin!=="https://api.mapbox.com")},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(b,S){this.eventQueue.push(b),(this.eventQueue.length>=this.maxQueueSize||S)&&this.flush()},remove:function(){this.flush()}},H0=y,H0}var Z0,tE;function yB(){if(tE)return Z0;tE=1;var m={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"×××¤×©",ja:"ãµã¼ã",lv:"MeklÄt",pt:"Procurar",sr:"ÐÑÐµÑÑÐ°Ð³Ð°",zh:"æç´¢",cs:"VyhledÃ¡vÃ¡nÃ­",hu:"KeresÃ©s",ka:"á«áááá",nb:"SÃ¸ke",sk:"VyhÄ¾adÃ¡vanie",th:"à¸à¹à¸à¸«à¸²",fi:"Hae",is:"Leita",ko:"ìì",pl:"Szukaj",sl:"Iskanje",fa:"Ø¬Ø³ØªØ¬Ù",ru:"ÐÐ¾Ð¸ÑÐº"};return Z0={placeholder:m},Z0}var Rg={exports:{}},vB=Rg.exports,iE;function xB(){return iE||(iE=1,(function(m){(function(y,b,S){m.exports?m.exports=S():y[b]=S()})(vB,"subtag",function(){var y="",b=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function S(G){return G.match(b)||[]}function M(G){return S(G).filter(function(Z,ee){return Z&&ee})}function R(G){return G=S(G),{language:G[1]||y,extlang:G[2]||y,script:G[3]||y,region:G[4]||y}}function k(G,Z,ee){Object.defineProperty(G,Z,{value:ee,enumerable:!0})}function o(G,Z,ee){function ie(re){return S(re)[G]||y}k(ie,"pattern",Z),k(R,ee,ie)}return o(1,/^[a-zA-Z]{2,3}$/,"language"),o(2,/^[a-zA-Z]{3}$/,"extlang"),o(3,/^[a-zA-Z]{4}$/,"script"),o(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),k(R,"split",M),R})})(Rg)),Rg.exports}var $0,rE;function bB(){if(rE)return $0;rE=1;function m(){}return m.prototype={isSupport:function(){return!!window.navigator.geolocation},getCurrentPosition:function(){const y={enableHighAccuracy:!0};return new Promise(function(b,S){window.navigator.geolocation.getCurrentPosition(b,S,y)})}},$0=m,$0}var W0,nE;function wB(){if(nE)return W0;nE=1;function m(S,M){const R=y(S),k=["address","street","place","country"];var o;if(typeof M=="function")return M(R);const G=k.indexOf(M);return G===-1?o=k:o=k.slice(G),o.reduce(function(Z,ee){return R[ee]?(Z!==""&&(Z=Z+", "),Z+R[ee]):Z},"")}function y(S){const M=S.address||"",R=S.text||"",k=S.place_name||"",G={address:k.split(",")[0],houseNumber:M,street:R,placeName:k};return S.context.forEach(function(Z){const ee=Z.id.split(".")[0];G[ee]=Z.text}),G}return W0={transformFeatureToGeolocationText:m,getAddressInfo:y,REVERSE_GEOCODE_COORD_RGX:/^[ ]*(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)[ ]*$/},W0}var X0,oE;function TB(){if(oE)return X0;oE=1;var m=GF(),y=qF(),b=Kd(),S=HF().EventEmitter,M=ZF(),R=rB(),k=hB(),o=gB(),G=yB(),Z=xB(),ee=bB(),ie=wB();const re={FORWARD:0,LOCAL:1,REVERSE:2};function ue(){var K=document.createElement("div");return K.className="mapboxgl-ctrl-geocoder--powered-by",K.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',K}function oe(K){this._eventEmitter=new S,this.options=b({},this.options,K),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new ee}function ge(K){return K?String(K).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}return oe.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",useBrowserFocus:!1,getItemValue:function(K){return K.place_name},render:function(K){var Te=ge(K.place_name).split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+Te[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+Te.splice(1,Te.length).join(",")+"</div></div>"}},_headers:{},addTo:function(K){function Te(Le,Oe){if(!document.body.contains(Oe))throw new Error("Element provided to #addTo() exists, but is not in the DOM");const Ae=Le.onAdd();Oe.appendChild(Ae)}if(K._controlContainer)K.addControl(this);else if(K instanceof HTMLElement)Te(this,K);else if(typeof K=="string"){const Le=document.querySelectorAll(K);if(Le.length===0)throw new Error("Element ",K,"not found.");if(Le.length>1)throw new Error("Geocoder can only be added to a single html element");Te(this,Le[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(K){if(K&&typeof K!="string"&&(this._map=K),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=k(R({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new o(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this),this._onSuggestionItemFocus=this._onSuggestionItemFocus.bind(this),this._onSuggestionItemKeyDown=this._onSuggestionItemKeydown.bind(this);var Te=this.container=document.createElement("div");Te.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var Le=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",y(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",(function(Xt){this.eventManager.keyevent(Xt,this)}).bind(this));var Oe=document.createElement("div");Oe.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var Ae=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(Ae),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),Oe.appendChild(this._clearEl),Oe.appendChild(this._loadingEl),Te.appendChild(Le),Te.appendChild(this._inputEl),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var ze=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(ze),Oe.appendChild(this._geolocateEl),this._showGeolocateButton()}var Fe=this._typeahead=new m(this._inputEl,[],{hideOnBlur:!this.options.useBrowserFocus,filter:!1,minLength:this.options.minLength,limit:this.options.limit});Te.insertBefore(Oe,Fe.list.wrapper),this.setRenderFunction(this.options.render),Fe.getItemValue=this.options.getItemValue;const Ye=this._typeahead.handleKeyDown.bind(this._typeahead),it=this._typeahead.handleKeyUp.bind(this._typeahead);this._typeahead.handleKeyUp,this.options.useBrowserFocus&&(this._typeahead.handleKeyDown=(function(Xt){if(!(Xt.keyCode===9&&!Fe.list.isEmpty())){if(Xt.keyCode===40){this._typeahead.list.active=0,this._typeahead.list.element.querySelectorAll("li").forEach(function(Pt){Pt.classList.remove("active")}),this._typeahead.list.element.querySelectorAll("li")[0].classList.add("active"),this._typeahead.list.element.querySelectorAll("li")[0].focus();return}else if(Xt.keyCode===38){this._typeahead.list.active=Fe.list.items.length-1,this._typeahead.list.element.querySelectorAll("li").forEach(function(Pt){Pt.classList.remove("active")}),this._typeahead.list.element.querySelectorAll("li")[this._typeahead.list.active].classList.add("active"),this._typeahead.list.element.querySelectorAll("li")[this._typeahead.list.active].focus();return}Ye(Xt)}}).bind(this),this._typeahead.handleKeyUp=function(Xt){if(Xt&&Xt.keyCode===16){Xt.preventDefault();return}it(Xt)});var jt=Fe.list.draw,Rt=this._footerNode=ue(),li=this;return Fe.list.draw=function(){li.options.useBrowserFocus&&Fe.list.element.querySelectorAll("li").forEach(function(Xt){Xt.removeEventListener("focus",li._onSuggestionItemFocus),Xt.removeEventListener("keydown",li._onSuggestionItemKeyDown)}),jt.call(this),li.options.useBrowserFocus&&Fe.list.element.querySelectorAll("li").forEach((function(Xt,Pt){Pt===0&&Xt.focus(),Xt.setAttribute("data-index",Pt),Xt.tabIndex=0,Xt.addEventListener("focus",this._onSuggestionItemFocus),Xt.addEventListener("keydown",this._onSuggestionItemKeyDown)}).bind(li)),Rt.addEventListener("mousedown",(function(){this.selectingListItem=!0}).bind(this)),Rt.addEventListener("mouseup",(function(){this.selectingListItem=!1}).bind(this)),this.element.appendChild(Rt)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),Te},_onSuggestionItemKeydown(K){const Te=K.keyCode;if(Te!==9){if(Te===13){K.preventDefault();const Le=this._typeahead.list.element.querySelector(".active");if(Le){const Oe=Le.getAttribute("data-index"),Ae=this._typeahead.list.items[Oe];Ae&&(this._typeahead.value(Ae.original),this._typeahead.list.hide())}}else if(Te===38||Te===40){const Le=this._typeahead.list.element.querySelectorAll("li");if(Le.length>0){if(Te===38)if(this._typeahead.list.active>0)K.preventDefault(),this._typeahead.list.active--;else{this._typeahead.el.focus();return}else if(Te===40)if(K.preventDefault(),this._typeahead.list.active<Le.length-1)this._typeahead.list.active++;else return;Le.forEach(function(Ae){Ae.classList.remove("active")});const Oe=Le[this._typeahead.list.active];Oe&&(Oe.classList.add("active"),Oe.focus())}}}},_onSuggestionItemFocus(K){this._typeahead.list.active=K.target.getAttribute("data-index"),this._typeahead.list.element.querySelectorAll("li").forEach(function(Te){Te.classList.remove("active")}),K.target.classList.add("active")},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then((function(K){this._hideLoadingIcon();const Te={geometry:{type:"Point",coordinates:[K.coords.longitude,K.coords.latitude]}};this._handleMarker(Te),this._fly(Te),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(Te),this._showClearButton(),this.fresh=!1;const Le={limit:1,language:[this.options.language],query:Te.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){const Oe=Te.geometry.coordinates[0]+","+Te.geometry.coordinates[1];this._setInputValue(Oe),this._eventEmitter.emit("result",{result:Te})}else this.geocoderService.reverseGeocode(Le).send().then((function(Oe){const Ae=Oe.body.features[0];if(Ae){const ze=ie.transformFeatureToGeolocationText(Ae,this.options.addressAccuracy);this._setInputValue(ze),Ae.user_coordinates=Te.geometry.coordinates,this._eventEmitter.emit("result",{result:Ae})}else this._eventEmitter.emit("result",{result:{user_coordinates:Te.geometry.coordinates}})}).bind(this))}).bind(this)).catch((function(K){K.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}).bind(this))},createIcon:function(K,Te){var Le=document.createElementNS("http://www.w3.org/2000/svg","svg");return Le.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+K),Le.setAttribute("viewBox","0 0 18 18"),Le.setAttribute("xml:space","preserve"),Le.setAttribute("width",18),Le.setAttribute("height",18),Le.innerHTML=Te,Le},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(K){this._inputEl.value=K,setTimeout((function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}).bind(this),1)},_onPaste:function(K){var Te=(K.clipboardData||window.clipboardData).getData("text");Te.length>=this.options.minLength&&this._geocode(Te)},_onKeyDown:function(K){var Te=27,Le=9;if(K.keyCode===Te&&this.options.clearAndBlurOnEsc)return this._clear(K),this._inputEl.blur();var Oe=K.target&&K.target.shadowRoot?K.target.shadowRoot.activeElement:K.target,Ae=Oe?Oe.value:"";if(!Ae)return this.fresh=!0,K.keyCode!==Le&&this.clear(K),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(K.metaKey||[Le,Te,37,39,13,38,40].indexOf(K.keyCode)!==-1)&&Oe.value.length>=this.options.minLength&&this._geocode(Oe.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(K){this.options.clearOnBlur&&this._clearOnBlur(K),this.options.collapsed&&this._collapse()},_onChange:function(){var K=this._typeahead.selected;K&&JSON.stringify(K)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(K),this.options.marker&&this._mapboxgl&&this._handleMarker(K),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(K),this._eventEmitter.emit("result",{result:K}),this.eventManager.select(K,this))},_fly:function(K){var Te;if(K.properties&&M[K.properties.short_code])Te=b({},this.options.flyTo),this._map&&this._map.fitBounds(M[K.properties.short_code].bbox,Te);else if(K.bbox){var Le=K.bbox;Te=b({},this.options.flyTo),this._map&&this._map.fitBounds([[Le[0],Le[1]],[Le[2],Le[3]]],Te)}else{var Oe={zoom:this.options.zoom};Te=b({},Oe,this.options.flyTo),K.center?Te.center=K.center:K.geometry&&K.geometry.type&&K.geometry.type==="Point"&&K.geometry.coordinates&&(Te.center=K.geometry.coordinates),this._map&&this._map.flyTo(Te)}},_requestType:function(K,Te){var Le;return K.localGeocoderOnly?Le=re.LOCAL:K.reverseGeocode&&ie.REVERSE_GEOCODE_COORD_RGX.test(Te)?Le=re.REVERSE:Le=re.FORWARD,Le},_setupConfig:function(K,Te){const Le=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],Oe=/[\s,]+/;var Ae=this,ze=Le.reduce(function(Ye,it){if(Ae.options[it]===void 0||Ae.options[it]===null)return Ye;["countries","types","language"].indexOf(it)>-1?Ye[it]=Ae.options[it].split(Oe):Ye[it]=Ae.options[it];const jt=typeof Ae.options[it].longitude=="number"&&typeof Ae.options[it].latitude=="number";if(it==="proximity"&&jt){const Rt=Ae.options[it].longitude,li=Ae.options[it].latitude;Ye[it]=[Rt,li]}return Ye},{});switch(K){case re.REVERSE:{var Fe=Te.split(Oe).map(function(Ye){return parseFloat(Ye,10)});Ae.options.flipCoordinates||Fe.reverse(),ze.types&&ze.types[0],ze=b(ze,{query:Fe,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(Ye){Ye in ze&&delete ze[Ye]})}break;case re.FORWARD:{const Ye=Te.trim();/^(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)?$/.test(Ye)&&(Te=Te.replace(/,/g," ")),ze=b(ze,{query:Te})}break}return ze.session_token=this.eventManager.getSessionId(),ze},_geocode:function(K){this.inputString=K,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:K});const Te=this._requestType(this.options,K),Le=this._setupConfig(Te,K);var Oe;switch(Te){case re.LOCAL:Oe=Promise.resolve();break;case re.FORWARD:Oe=this.geocoderService.forwardGeocode(Le).send();break;case re.REVERSE:Oe=this.geocoderService.reverseGeocode(Le).send();break}var Ae=this.options.localGeocoder?this.options.localGeocoder(K)||[]:[],ze=[],Fe=null;return Oe.catch((function(Ye){Fe=Ye}).bind(this)).then((function(Ye){this._hideLoadingIcon();var it={};return Ye?Ye.statusCode=="200"&&(it=Ye.body,it.request=Ye.request,it.headers=Ye.headers,this._headers=Ye.headers):it={type:"FeatureCollection",features:[]},it.config=Le,this.fresh&&(this.eventManager.start(this),this.fresh=!1),it.features&&it.features.length&&it.features.map(function(jt){jt._source="mapbox"}),it.features=it.features?Ae.concat(it.features):Ae,this.options.externalGeocoder?(ze=this.options.externalGeocoder(K,it.features)||Promise.resolve([]),ze.then(function(jt){return it.features=it.features?jt.concat(it.features):jt,it},function(){return it})):it}).bind(this)).then((function(Ye){if(Fe)throw Fe;this.options.filter&&Ye.features.length&&(Ye.features=Ye.features.filter(this.options.filter)),Ye.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",Ye),this._typeahead.update(Ye.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",Ye))}).bind(this)).catch((function(Ye){this._hideLoadingIcon(),this._hideAttribution(),Ae.length&&this.options.localGeocoder||ze.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(Ae)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:Ae}),this._eventEmitter.emit("error",{error:Ye})}).bind(this)),Oe},_clear:function(K){K&&K.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this.eventManager.sessionIncrementer++,this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(K){this._clear(K),this._inputEl.focus(),this.options.useBrowserFocus&&this._typeahead.list.hide()},_clearOnBlur:function(K){var Te=this;K.relatedTarget&&Te._clear(K)},_onQueryResult:function(K){var Te=K.body;if(Te.features.length){var Le=Te.features[0];this._typeahead.selected=Le,this._inputEl.value=Le.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var K=this._map.getCenter().wrap();this.setProximity({longitude:K.lng,latitude:K.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(K){return this._geocode(K).then(this._onQueryResult),this},_renderError:function(){var K="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(K)},_renderLocationError:function(){var K="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(K)},_renderNoResults:function(){var K="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(K)},_renderUserDeniedGeolocationError:function(){var K="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(K)},_renderMessage:function(K){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(K)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var K=this.options.language.split(",")[0],Te=Z.language(K),Le=G.placeholder[Te];if(Le)return Le}return"Search"},setInput:function(K,Te){return Te===void 0&&(Te=!1),this._inputEl.value=K,this._typeahead.selected=null,this._typeahead.clear(),K.length>=this.options.minLength&&(Te?this._geocode(K):this._onChange()),this},setProximity:function(K,Te=!0){return this.options.proximity=K,Te&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(K){return K&&typeof K=="function"&&(this._typeahead.render=K),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(K){var Te=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=K||this.options.language||Te,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(K){return this.options.zoom=K,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(K){return this.options.flyTo=K,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(K){return this.options.placeholder=K||this._getPlaceholderText(),this._inputEl.placeholder=this.options.placeholder,this._inputEl.setAttribute("aria-label",this.options.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(K){return this.options.bbox=K,this},getCountries:function(){return this.options.countries},setCountries:function(K){return this.options.countries=K,this},getTypes:function(){return this.options.types},setTypes:function(K){return this.options.types=K,this},getMinLength:function(){return this.options.minLength},setMinLength:function(K){return this.options.minLength=K,this._typeahead&&(this._typeahead.options.minLength=K),this},getLimit:function(){return this.options.limit},setLimit:function(K){return this.options.limit=K,this._typeahead&&(this._typeahead.options.limit=K),this},getFilter:function(){return this.options.filter},setFilter:function(K){return this.options.filter=K,this},setOrigin:function(K){return this.options.origin=K,this.geocoderService=k(R({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(K){return this.options.accessToken=K,this.geocoderService=k(R({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(K){return this.options.autocomplete=K,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(K){return this.options.fuzzyMatch=K,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(K){return this.options.routing=K,this},getRouting:function(){return this.options.routing},setWorldview:function(K){return this.options.worldview=K,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(K){if(this._map){this._removeMarker();var Te={color:"#4668F2"},Le=b({},Te,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(Le),K.center?this.mapMarker.setLngLat(K.center).addTo(this._map):K.geometry&&K.geometry.type&&K.geometry.type==="Point"&&K.geometry.coordinates&&this.mapMarker.setLngLat(K.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(K,Te){return this._eventEmitter.on(K,Te),this},off:function(K,Te){return this._eventEmitter.removeListener(K,Te),this.eventManager.remove(),this}},X0=oe,X0}var EB=TB();const SB=Ku(EB);var IB=ks('<svg width="46" height="46" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M24.3535 8.17871C24.3403 8.17752 24.3267 8.17694 24.3135 8.17578C31.4701 8.80159 37.1737 14.4919 37.8203 21.6426H46V24.3486H37.8213C37.1798 31.4901 31.4943 37.1765 24.3535 37.8203V46H21.6475V37.8203C14.5063 37.1769 8.82022 31.4903 8.17871 24.3486H0V21.6426H8.17969C8.82622 14.4926 14.5289 8.80254 21.6846 8.17578C21.6722 8.17687 21.6598 8.1776 21.6475 8.17871V0H24.3535V8.17871ZM22.6582 37.8789L23 37.8828C22.8795 37.8828 22.7594 37.8808 22.6396 37.8779C22.6458 37.8781 22.652 37.8788 22.6582 37.8789ZM23 37.8828C23.1195 37.8828 23.2386 37.8809 23.3574 37.8779C23.2387 37.8807 23.1194 37.8828 23 37.8828ZM23 10.8232C16.2752 10.8233 10.8233 16.2752 10.8232 23C10.8232 29.7248 16.2752 35.1767 23 35.1768C29.7249 35.1768 35.1768 29.7249 35.1768 23C35.1767 16.2751 29.7249 10.8232 23 10.8232ZM23 15.333C27.2342 15.333 30.667 18.7658 30.667 23C30.667 27.2342 27.2342 30.667 23 30.667C18.7658 30.667 15.333 27.2342 15.333 23C15.333 18.7658 18.7658 15.333 23 15.333ZM23 18.0391C20.2602 18.0391 18.0391 20.2602 18.0391 23C18.0391 25.7398 20.2602 27.9609 23 27.9609C25.7398 27.9609 27.9609 25.7398 27.9609 23C27.9609 20.2602 25.7398 18.0391 23 18.0391ZM37.8652 23.6973C37.8682 23.6339 37.8708 23.5704 37.873 23.5068C37.8709 23.5704 37.8682 23.6339 37.8652 23.6973ZM37.873 22.4932C37.8707 22.4267 37.8684 22.3602 37.8652 22.2939C37.8683 22.3602 37.8708 22.4266 37.873 22.4932ZM22.4902 8.12598C22.4257 8.12821 22.3612 8.13074 22.2969 8.13379C22.3612 8.1308 22.4257 8.12815 22.4902 8.12598ZM23.7021 8.13379C23.6394 8.13082 23.5766 8.12914 23.5137 8.12695C23.5766 8.12909 23.6394 8.13088 23.7021 8.13379ZM23.3604 8.12109C23.3538 8.12093 23.3473 8.12124 23.3408 8.12109L23 8.11719C23.1204 8.11719 23.2406 8.11825 23.3604 8.12109Z" fill="black"></path></svg>');function AB(m){var y=IB();gi(m,y)}var CB=Zi('<div class="error svelte-1wah7ro"> </div>'),MB=Zi('<div class="Search svelte-1wah7ro"><div><div id="geocoder" class="svelte-1wah7ro"></div> <button aria-label="User Location Button" class="user-location-button svelte-1wah7ro"><!></button></div> <!></div>');function PB(m,y){Co(y,!0);let b=ao(null),S=ao(null);const M=ue=>{const oe=Jo(ue),ge=cS(Og);return VP(oe,ge)},R=ue=>{const oe=document.getElementsByClassName("mapboxgl-ctrl-geocoder--input")[0];oe.value=ue;const ge=document.getElementsByClassName("mapboxgl-ctrl-geocoder mapboxgl-ctrl")[0],K=document.getElementsByClassName("mapboxgl-ctrl-geocoder--button")[0],Te=()=>K.style.display="block",Le=()=>K.style.display="none";ge.addEventListener("mouseenter",Te),ge.addEventListener("mouseleave",Le),nt(b).on("clear",()=>{ge.removeEventListener("mouseenter",Te),ge.removeEventListener("mouseleave",Le)})},k=()=>{function ue(oe){const ge=oe?.coords?.latitude,K=oe?.coords?.longitude;if(!ge||!K)return;if(!M([K,ge])){Yr(S,"Your location is outside of the designated region."),setTimeout(()=>Yr(S,null),3e3);return}ko.results=[K,ge];const Le=`${ge},${K}`;R(Le)}navigator.geolocation?navigator.geolocation.getCurrentPosition(ue,oe=>console.error(oe)):alert("Geolocation is not supported by this browser.")};qg(()=>{if(Yr(b,new SB({accessToken:LE,mapboxgl:nm,bbox:Og}),!0),nt(b).addTo("#geocoder"),nt(b).on("result",ue=>{ko.results=ue.result?.center}),nt(b).on("clear",()=>{ko.results=null}),ko.results){const[ue,oe]=ko.results,ge=`${oe},${ue}`;R(ge)}});var o=MB(),G=Ht(o),Z=zi(Ht(G),2);Z.__click=k;var ee=Ht(Z);AB(ee),Ut(Z),Ut(G);var ie=zi(G,2);{var re=ue=>{var oe=CB(),ge=Ht(oe,!0);Ut(oe),Sn(()=>Qo(ge,nt(S))),gi(ue,oe)};Fn(ie,ue=>{nt(S)&&ue(re)})}Ut(o),Sn(()=>Ao(G,1,Fo(["search-container",{disabled:gr?.type==="radius"&&!!gr?.selected}]),"svelte-1wah7ro")),gi(m,o),Mo()}Fs(["click"]);var LB=ks('<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 29V28.333C0 27.5046 0.671573 26.833 1.5 26.833C2.32843 26.833 3 27.5046 3 28.333V32C1.34315 32 0 30.6569 0 29ZM4.0835 29C4.68189 29 5.16699 29.4851 5.16699 30.0835V30.5C5.16699 31.3284 4.49542 32 3.66699 32H3V30.0835C3 29.4851 3.4851 29 4.0835 29ZM12.333 29C13.1614 29 13.833 29.6716 13.833 30.5C13.833 31.3284 13.1614 32 12.333 32H11C10.1716 32 9.5 31.3284 9.5 30.5C9.5 29.6716 10.1716 29 11 29H12.333ZM21 29C21.8284 29 22.5 29.6716 22.5 30.5C22.5 31.3284 21.8284 32 21 32H19.667C18.8386 32 18.167 31.3284 18.167 30.5C18.167 29.6716 18.8386 29 19.667 29H21ZM27.9165 29C28.5149 29 29 29.4851 29 30.0835V32H28.333C27.5046 32 26.833 31.3284 26.833 30.5V30.0835C26.833 29.4851 27.3181 29 27.9165 29ZM32 29C32 30.6569 30.6569 32 29 32V28.333C29 27.5046 29.6716 26.833 30.5 26.833C31.3284 26.833 32 27.5046 32 28.333V29ZM1.5 18.167C2.32843 18.167 3 18.8386 3 19.667V21C3 21.8284 2.32843 22.5 1.5 22.5C0.671573 22.5 0 21.8284 0 21V19.667C0 18.8386 0.671573 18.167 1.5 18.167ZM30.5 18.167C31.3284 18.167 32 18.8386 32 19.667V21C32 21.8284 31.3284 22.5 30.5 22.5C29.6716 22.5 29 21.8284 29 21V19.667C29 18.8386 29.6716 18.167 30.5 18.167ZM1.5 9.5C2.32843 9.5 3 10.1716 3 11V12.333C3 13.1614 2.32843 13.833 1.5 13.833C0.671573 13.833 0 13.1614 0 12.333V11C0 10.1716 0.671573 9.5 1.5 9.5ZM30.5 9.5C31.3284 9.5 32 10.1716 32 11V12.333C32 13.1614 31.3284 13.833 30.5 13.833C29.6716 13.833 29 13.1614 29 12.333V11C29 10.1716 29.6716 9.5 30.5 9.5ZM0 3C0 1.34315 1.34315 0 3 0H3.66699C4.49542 0 5.16699 0.671573 5.16699 1.5V1.9165C5.16699 2.5149 4.68189 3 4.0835 3C3.4851 3 3 3.4851 3 4.0835C3 4.68189 2.5149 5.16699 1.9165 5.16699H1.5C0.671573 5.16699 0 4.49542 0 3.66699V3ZM32 3.66699C32 4.49542 31.3284 5.16699 30.5 5.16699H30.0835C29.4851 5.16699 29 4.68189 29 4.0835C29 3.4851 28.5149 3 27.9165 3C27.3181 3 26.833 2.5149 26.833 1.9165V1.5C26.833 0.671573 27.5046 0 28.333 0H29C30.6569 0 32 1.34315 32 3V3.66699ZM12.333 0C13.1614 0 13.833 0.671573 13.833 1.5C13.833 2.32843 13.1614 3 12.333 3H11C10.1716 3 9.5 2.32843 9.5 1.5C9.5 0.671573 10.1716 0 11 0H12.333ZM21 0C21.8284 0 22.5 0.671573 22.5 1.5C22.5 2.32843 21.8284 3 21 3H19.667C18.8386 3 18.167 2.32843 18.167 1.5C18.167 0.671573 18.8386 0 19.667 0H21Z" fill="black"></path></svg>');function RB(m){var y=LB();gi(m,y)}var DB=Zi('<div class="select-area-button-container svelte-11gtm73"><button aria-label="Select area by selection"><div class="select-area-icon-container area svelte-11gtm73"><!></div></button> <div class="select-area-button-label svelte-11gtm73">Select by area</div></div>');function OB(m,y){Co(y,!0);let b=ao(ka(gr?.type==="area"&&!!gr.selected));const S=Z=>{gr.selected=Z?.features?.[0],gr.type="area"},M=()=>{gr?.selected||(Yr(b,!0),Zt.isDrawing=!0,Zt.map.dragPan.disable(),Zt.draw.changeMode("draw_drag_rectangle"),Zt.map.on("draw.create",Z=>{S(Z),Zt.isDrawing=!1,Zt.map.dragPan.enable(),Zt.draw.deleteAll()}))};ms(()=>{(gr.type!=="area"||!gr.selected)&&Yr(b,!1)});var R=DB(),k=Ht(R);k.__click=M;var o=Ht(k),G=Ht(o);RB(G),Ut(o),Ut(k),Wd(2),Ut(R),Sn(()=>Ao(k,1,Fo(["select-area-button",{active:nt(b),disabled:gr.type==="radius"}]),"svelte-11gtm73")),gi(m,R),Mo()}Fs(["click"]);var zB=ks('<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5815 38.3428C17.6886 37.5219 18.4412 36.9499 19.2684 36.9847C19.5108 36.9949 19.7548 37 20 37V40C19.624 40 19.2505 39.9893 18.8797 39.9684C18.0532 39.922 17.4745 39.1637 17.5815 38.3428ZM22.418 38.3433C22.5248 39.1639 21.9461 39.9219 21.1198 39.9684C20.7492 39.9893 20.3758 40 20 40V37C20.2451 37 20.4889 36.9949 20.7312 36.9847C21.5585 36.9499 22.3112 37.5222 22.418 38.3433ZM8.73863 34.6773C9.24332 34.0211 10.1811 33.9043 10.8793 34.3491C11.2867 34.6087 11.7057 34.8513 12.1355 35.0759C12.8693 35.4596 13.2361 36.331 12.919 37.096C12.6019 37.8611 11.7213 38.2293 10.9823 37.8552C10.3146 37.5173 9.6685 37.143 9.04646 36.735C8.35389 36.2807 8.23366 35.3338 8.73863 34.6773ZM31.2611 34.6776C31.7657 35.334 31.6454 36.2804 30.9531 36.7346C30.331 37.1428 29.6847 37.5172 29.0169 37.8552C28.2779 38.2292 27.3973 37.8609 27.0803 37.0956C26.7636 36.3308 27.1304 35.4598 27.864 35.0762C28.2939 34.8515 28.7131 34.6088 29.1206 34.3492C29.8188 33.9044 30.7566 34.0213 31.2611 34.6776ZM2.90407 27.0803C3.66911 26.7635 4.54025 27.1305 4.9239 27.8642C5.14851 28.2938 5.39102 28.7128 5.65049 29.1201C6.09544 29.8185 5.97839 30.7567 5.32172 31.2613C4.6651 31.7658 3.71859 31.6454 3.26437 30.953C2.85636 30.3311 2.48206 29.685 2.14414 29.0175C1.7699 28.2781 2.13844 27.3972 2.90407 27.0803ZM37.0956 27.0803C37.8609 27.3973 38.2292 28.2779 37.8552 29.0169C37.5172 29.6847 37.1428 30.331 36.7346 30.9531C36.2804 31.6454 35.334 31.7657 34.6776 31.2611C34.0213 30.7566 33.9044 29.8188 34.3492 29.1206C34.6088 28.7131 34.8515 28.2939 35.0762 27.864C35.4598 27.1304 36.3308 26.7636 37.0956 27.0803ZM0 20C0 19.6242 0.0105166 19.2509 0.0311503 18.8802C0.0771753 18.0534 0.835529 17.4745 1.65664 17.5815C2.47782 17.6886 3.05006 18.4415 3.01531 19.2689C3.00514 19.5112 3 19.7549 3 20C3 20.2449 3.00513 20.4885 3.01529 20.7307C3.05003 21.5582 2.47755 22.3112 1.65619 22.418C0.835264 22.5248 0.077226 21.9459 0.0311734 21.1193C0.0105306 20.7488 0 20.3756 0 20ZM40 20C40 20.3758 39.9893 20.7492 39.9684 21.1198C39.9219 21.9461 39.1639 22.5248 38.3433 22.418C37.5222 22.3112 36.9499 21.5585 36.9847 20.7312C36.9949 20.4889 37 20.2451 37 20C37 19.7548 36.9949 19.5108 36.9847 19.2684C36.9499 18.4412 37.5219 17.6886 38.3428 17.5815C39.1637 17.4745 39.922 18.0532 39.9684 18.8797C39.9893 19.2505 40 19.624 40 20ZM5.32201 8.73846C5.97857 9.24321 6.09549 10.1814 5.65052 10.8799C5.39115 11.287 5.14872 11.7058 4.92418 12.1352C4.54039 12.8692 3.66887 13.2362 2.90368 12.9191C2.13821 12.6019 1.76986 11.721 2.14406 10.9818C2.48191 10.3143 2.8561 9.6684 3.264 9.04657C3.71836 8.3539 4.66527 8.23356 5.32201 8.73846ZM34.6773 8.73863C35.3338 8.23366 36.2807 8.35389 36.735 9.04646C37.143 9.6685 37.5173 10.3146 37.8552 10.9823C38.2293 11.7213 37.8611 12.6019 37.096 12.919C36.331 13.2361 35.4596 12.8693 35.0759 12.1355C34.8513 11.7057 34.6087 11.2867 34.3491 10.8793C33.9043 10.1811 34.0211 9.24332 34.6773 8.73863ZM12.9191 2.90368C13.2362 3.66887 12.8692 4.54039 12.1352 4.92418C11.7058 5.14872 11.287 5.39115 10.8799 5.65052C10.1814 6.09549 9.24321 5.97857 8.73846 5.32201C8.23356 4.66527 8.3539 3.71836 9.04657 3.264C9.6684 2.8561 10.3143 2.4819 10.9818 2.14406C11.721 1.76986 12.6019 2.13821 12.9191 2.90368ZM27.0803 2.90407C27.3972 2.13844 28.2781 1.7699 29.0175 2.14414C29.685 2.48206 30.3311 2.85636 30.953 3.26437C31.6454 3.71859 31.7658 4.6651 31.2613 5.32172C30.7567 5.97839 29.8185 6.09544 29.1201 5.65049C28.7128 5.39102 28.2938 5.14851 27.8642 4.9239C27.1305 4.54025 26.7635 3.66911 27.0803 2.90407ZM20 0C20.3756 0 20.7488 0.0105306 21.1193 0.0311734C21.9459 0.077226 22.5248 0.835264 22.418 1.65619C22.3112 2.47755 21.5582 3.05003 20.7307 3.01529C20.4885 3.00513 20.2449 3 20 3C19.7549 3 19.5112 3.00513 19.2689 3.01531C18.4415 3.05006 17.6886 2.47782 17.5815 1.65664C17.4745 0.835529 18.0534 0.0771753 18.8802 0.0311503C19.2509 0.0105166 19.6242 0 20 0Z" fill="black"></path><path d="M20 10C23.866 10 27 13.134 27 17C27 18.2752 26.6575 19.4699 26.0618 20.4996C26.0617 20.4998 26.0618 20.5 26.062 20.5C26.0622 20.5 26.0624 20.5002 26.0623 20.5004L21.732 28.0002C20.9622 29.3335 19.0378 29.3335 18.268 28.0002L13.9377 20.5004C13.9376 20.5002 13.9378 20.5 13.938 20.5C13.9382 20.5 13.9383 20.4998 13.9382 20.4996C13.3425 19.4699 13 18.2752 13 17C13 13.134 16.134 10 20 10ZM20 13.8887C18.2818 13.8887 16.8887 15.2818 16.8887 17C16.8887 18.7182 18.2818 20.1113 20 20.1113C21.7182 20.1113 23.1113 18.7182 23.1113 17C23.1113 15.2818 21.7182 13.8887 20 13.8887Z" fill="black"></path></svg>');function kB(m){var y=zB();gi(m,y)}const Vg=Math.min,Xu=Math.max,Ug=Math.round,Cg=Math.floor,dl=m=>({x:m,y:m}),FB={left:"right",right:"left",bottom:"top",top:"bottom"},BB={start:"end",end:"start"};function sE(m,y,b){return Xu(m,Vg(y,b))}function Qg(m,y){return typeof m=="function"?m(y):m}function Yu(m){return m.split("-")[0]}function ey(m){return m.split("-")[1]}function ES(m){return m==="x"?"y":"x"}function SS(m){return m==="y"?"height":"width"}const NB=new Set(["top","bottom"]);function Uc(m){return NB.has(Yu(m))?"y":"x"}function IS(m){return ES(Uc(m))}function VB(m,y,b){b===void 0&&(b=!1);const S=ey(m),M=IS(m),R=SS(M);let k=M==="x"?S===(b?"end":"start")?"right":"left":S==="start"?"bottom":"top";return y.reference[R]>y.floating[R]&&(k=jg(k)),[k,jg(k)]}function UB(m){const y=jg(m);return[fx(m),y,fx(y)]}function fx(m){return m.replace(/start|end/g,y=>BB[y])}const aE=["left","right"],lE=["right","left"],jB=["top","bottom"],GB=["bottom","top"];function qB(m,y,b){switch(m){case"top":case"bottom":return b?y?lE:aE:y?aE:lE;case"left":case"right":return y?jB:GB;default:return[]}}function HB(m,y,b,S){const M=ey(m);let R=qB(Yu(m),b==="start",S);return M&&(R=R.map(k=>k+"-"+M),y&&(R=R.concat(R.map(fx)))),R}function jg(m){return m.replace(/left|right|bottom|top/g,y=>FB[y])}function ZB(m){return{top:0,right:0,bottom:0,left:0,...m}}function $B(m){return typeof m!="number"?ZB(m):{top:m,right:m,bottom:m,left:m}}function Gg(m){const{x:y,y:b,width:S,height:M}=m;return{width:S,height:M,top:b,left:y,right:y+S,bottom:b+M,x:y,y:b}}function cE(m,y,b){let{reference:S,floating:M}=m;const R=Uc(y),k=IS(y),o=SS(k),G=Yu(y),Z=R==="y",ee=S.x+S.width/2-M.width/2,ie=S.y+S.height/2-M.height/2,re=S[o]/2-M[o]/2;let ue;switch(G){case"top":ue={x:ee,y:S.y-M.height};break;case"bottom":ue={x:ee,y:S.y+S.height};break;case"right":ue={x:S.x+S.width,y:ie};break;case"left":ue={x:S.x-M.width,y:ie};break;default:ue={x:S.x,y:S.y}}switch(ey(y)){case"start":ue[k]-=re*(b&&Z?-1:1);break;case"end":ue[k]+=re*(b&&Z?-1:1);break}return ue}async function WB(m,y){var b;y===void 0&&(y={});const{x:S,y:M,platform:R,rects:k,elements:o,strategy:G}=m,{boundary:Z="clippingAncestors",rootBoundary:ee="viewport",elementContext:ie="floating",altBoundary:re=!1,padding:ue=0}=Qg(y,m),oe=$B(ue),K=o[re?ie==="floating"?"reference":"floating":ie],Te=Gg(await R.getClippingRect({element:(b=await(R.isElement==null?void 0:R.isElement(K)))==null||b?K:K.contextElement||await(R.getDocumentElement==null?void 0:R.getDocumentElement(o.floating)),boundary:Z,rootBoundary:ee,strategy:G})),Le=ie==="floating"?{x:S,y:M,width:k.floating.width,height:k.floating.height}:k.reference,Oe=await(R.getOffsetParent==null?void 0:R.getOffsetParent(o.floating)),Ae=await(R.isElement==null?void 0:R.isElement(Oe))?await(R.getScale==null?void 0:R.getScale(Oe))||{x:1,y:1}:{x:1,y:1},ze=Gg(R.convertOffsetParentRelativeRectToViewportRelativeRect?await R.convertOffsetParentRelativeRectToViewportRelativeRect({elements:o,rect:Le,offsetParent:Oe,strategy:G}):Le);return{top:(Te.top-ze.top+oe.top)/Ae.y,bottom:(ze.bottom-Te.bottom+oe.bottom)/Ae.y,left:(Te.left-ze.left+oe.left)/Ae.x,right:(ze.right-Te.right+oe.right)/Ae.x}}const XB=async(m,y,b)=>{const{placement:S="bottom",strategy:M="absolute",middleware:R=[],platform:k}=b,o=R.filter(Boolean),G=await(k.isRTL==null?void 0:k.isRTL(y));let Z=await k.getElementRects({reference:m,floating:y,strategy:M}),{x:ee,y:ie}=cE(Z,S,G),re=S,ue={},oe=0;for(let K=0;K<o.length;K++){var ge;const{name:Te,fn:Le}=o[K],{x:Oe,y:Ae,data:ze,reset:Fe}=await Le({x:ee,y:ie,initialPlacement:S,placement:re,strategy:M,middlewareData:ue,rects:Z,platform:{...k,detectOverflow:(ge=k.detectOverflow)!=null?ge:WB},elements:{reference:m,floating:y}});ee=Oe??ee,ie=Ae??ie,ue={...ue,[Te]:{...ue[Te],...ze}},Fe&&oe<=50&&(oe++,typeof Fe=="object"&&(Fe.placement&&(re=Fe.placement),Fe.rects&&(Z=Fe.rects===!0?await k.getElementRects({reference:m,floating:y,strategy:M}):Fe.rects),{x:ee,y:ie}=cE(Z,re,G)),K=-1)}return{x:ee,y:ie,placement:re,strategy:M,middlewareData:ue}},YB=function(m){return m===void 0&&(m={}),{name:"flip",options:m,async fn(y){var b,S;const{placement:M,middlewareData:R,rects:k,initialPlacement:o,platform:G,elements:Z}=y,{mainAxis:ee=!0,crossAxis:ie=!0,fallbackPlacements:re,fallbackStrategy:ue="bestFit",fallbackAxisSideDirection:oe="none",flipAlignment:ge=!0,...K}=Qg(m,y);if((b=R.arrow)!=null&&b.alignmentOffset)return{};const Te=Yu(M),Le=Uc(o),Oe=Yu(o)===o,Ae=await(G.isRTL==null?void 0:G.isRTL(Z.floating)),ze=re||(Oe||!ge?[jg(o)]:UB(o)),Fe=oe!=="none";!re&&Fe&&ze.push(...HB(o,ge,oe,Ae));const Ye=[o,...ze],it=await G.detectOverflow(y,K),jt=[];let Rt=((S=R.flip)==null?void 0:S.overflows)||[];if(ee&&jt.push(it[Te]),ie){const Ai=VB(M,k,Ae);jt.push(it[Ai[0]],it[Ai[1]])}if(Rt=[...Rt,{placement:M,overflows:jt}],!jt.every(Ai=>Ai<=0)){var li,Xt;const Ai=(((li=R.flip)==null?void 0:li.index)||0)+1,rr=Ye[Ai];if(rr&&(!(ie==="alignment"?Le!==Uc(rr):!1)||Rt.every(Bi=>Uc(Bi.placement)===Le?Bi.overflows[0]>0:!0)))return{data:{index:Ai,overflows:Rt},reset:{placement:rr}};let Li=(Xt=Rt.filter(di=>di.overflows[0]<=0).sort((di,Bi)=>di.overflows[1]-Bi.overflows[1])[0])==null?void 0:Xt.placement;if(!Li)switch(ue){case"bestFit":{var Pt;const di=(Pt=Rt.filter(Bi=>{if(Fe){const jr=Uc(Bi.placement);return jr===Le||jr==="y"}return!0}).map(Bi=>[Bi.placement,Bi.overflows.filter(jr=>jr>0).reduce((jr,Ln)=>jr+Ln,0)]).sort((Bi,jr)=>Bi[1]-jr[1])[0])==null?void 0:Pt[0];di&&(Li=di);break}case"initialPlacement":Li=o;break}if(M!==Li)return{reset:{placement:Li}}}return{}}}},JB=new Set(["left","top"]);async function KB(m,y){const{placement:b,platform:S,elements:M}=m,R=await(S.isRTL==null?void 0:S.isRTL(M.floating)),k=Yu(b),o=ey(b),G=Uc(b)==="y",Z=JB.has(k)?-1:1,ee=R&&G?-1:1,ie=Qg(y,m);let{mainAxis:re,crossAxis:ue,alignmentAxis:oe}=typeof ie=="number"?{mainAxis:ie,crossAxis:0,alignmentAxis:null}:{mainAxis:ie.mainAxis||0,crossAxis:ie.crossAxis||0,alignmentAxis:ie.alignmentAxis};return o&&typeof oe=="number"&&(ue=o==="end"?oe*-1:oe),G?{x:ue*ee,y:re*Z}:{x:re*Z,y:ue*ee}}const QB=function(m){return m===void 0&&(m=0),{name:"offset",options:m,async fn(y){var b,S;const{x:M,y:R,placement:k,middlewareData:o}=y,G=await KB(y,m);return k===((b=o.offset)==null?void 0:b.placement)&&(S=o.arrow)!=null&&S.alignmentOffset?{}:{x:M+G.x,y:R+G.y,data:{...G,placement:k}}}}},e6=function(m){return m===void 0&&(m={}),{name:"shift",options:m,async fn(y){const{x:b,y:S,placement:M,platform:R}=y,{mainAxis:k=!0,crossAxis:o=!1,limiter:G={fn:Te=>{let{x:Le,y:Oe}=Te;return{x:Le,y:Oe}}},...Z}=Qg(m,y),ee={x:b,y:S},ie=await R.detectOverflow(y,Z),re=Uc(Yu(M)),ue=ES(re);let oe=ee[ue],ge=ee[re];if(k){const Te=ue==="y"?"top":"left",Le=ue==="y"?"bottom":"right",Oe=oe+ie[Te],Ae=oe-ie[Le];oe=sE(Oe,oe,Ae)}if(o){const Te=re==="y"?"top":"left",Le=re==="y"?"bottom":"right",Oe=ge+ie[Te],Ae=ge-ie[Le];ge=sE(Oe,ge,Ae)}const K=G.fn({...y,[ue]:oe,[re]:ge});return{...K,data:{x:K.x-b,y:K.y-S,enabled:{[ue]:k,[re]:o}}}}}};function ty(){return typeof window<"u"}function Qd(m){return AS(m)?(m.nodeName||"").toLowerCase():"#document"}function zs(m){var y;return(m==null||(y=m.ownerDocument)==null?void 0:y.defaultView)||window}function gl(m){var y;return(y=(AS(m)?m.ownerDocument:m.document)||window.document)==null?void 0:y.documentElement}function AS(m){return ty()?m instanceof Node||m instanceof zs(m).Node:!1}function Va(m){return ty()?m instanceof Element||m instanceof zs(m).Element:!1}function ml(m){return ty()?m instanceof HTMLElement||m instanceof zs(m).HTMLElement:!1}function uE(m){return!ty()||typeof ShadowRoot>"u"?!1:m instanceof ShadowRoot||m instanceof zs(m).ShadowRoot}const t6=new Set(["inline","contents"]);function xm(m){const{overflow:y,overflowX:b,overflowY:S,display:M}=Ua(m);return/auto|scroll|overlay|hidden|clip/.test(y+S+b)&&!t6.has(M)}const i6=new Set(["table","td","th"]);function r6(m){return i6.has(Qd(m))}const n6=[":popover-open",":modal"];function iy(m){return n6.some(y=>{try{return m.matches(y)}catch{return!1}})}const o6=["transform","translate","scale","rotate","perspective"],s6=["transform","translate","scale","rotate","perspective","filter"],a6=["paint","layout","strict","content"];function zx(m){const y=kx(),b=Va(m)?Ua(m):m;return o6.some(S=>b[S]?b[S]!=="none":!1)||(b.containerType?b.containerType!=="normal":!1)||!y&&(b.backdropFilter?b.backdropFilter!=="none":!1)||!y&&(b.filter?b.filter!=="none":!1)||s6.some(S=>(b.willChange||"").includes(S))||a6.some(S=>(b.contain||"").includes(S))}function l6(m){let y=$c(m);for(;ml(y)&&!Jd(y);){if(zx(y))return y;if(iy(y))return null;y=$c(y)}return null}function kx(){return typeof CSS>"u"||!CSS.supports?!1:CSS.supports("-webkit-backdrop-filter","none")}const c6=new Set(["html","body","#document"]);function Jd(m){return c6.has(Qd(m))}function Ua(m){return zs(m).getComputedStyle(m)}function ry(m){return Va(m)?{scrollLeft:m.scrollLeft,scrollTop:m.scrollTop}:{scrollLeft:m.scrollX,scrollTop:m.scrollY}}function $c(m){if(Qd(m)==="html")return m;const y=m.assignedSlot||m.parentNode||uE(m)&&m.host||gl(m);return uE(y)?y.host:y}function CS(m){const y=$c(m);return Jd(y)?m.ownerDocument?m.ownerDocument.body:m.body:ml(y)&&xm(y)?y:CS(y)}function mm(m,y,b){var S;y===void 0&&(y=[]),b===void 0&&(b=!0);const M=CS(m),R=M===((S=m.ownerDocument)==null?void 0:S.body),k=zs(M);if(R){const o=px(k);return y.concat(k,k.visualViewport||[],xm(M)?M:[],o&&b?mm(o):[])}return y.concat(M,mm(M,[],b))}function px(m){return m.parent&&Object.getPrototypeOf(m.parent)?m.frameElement:null}function MS(m){const y=Ua(m);let b=parseFloat(y.width)||0,S=parseFloat(y.height)||0;const M=ml(m),R=M?m.offsetWidth:b,k=M?m.offsetHeight:S,o=Ug(b)!==R||Ug(S)!==k;return o&&(b=R,S=k),{width:b,height:S,$:o}}function Fx(m){return Va(m)?m:m.contextElement}function $d(m){const y=Fx(m);if(!ml(y))return dl(1);const b=y.getBoundingClientRect(),{width:S,height:M,$:R}=MS(y);let k=(R?Ug(b.width):b.width)/S,o=(R?Ug(b.height):b.height)/M;return(!k||!Number.isFinite(k))&&(k=1),(!o||!Number.isFinite(o))&&(o=1),{x:k,y:o}}const u6=dl(0);function PS(m){const y=zs(m);return!kx()||!y.visualViewport?u6:{x:y.visualViewport.offsetLeft,y:y.visualViewport.offsetTop}}function h6(m,y,b){return y===void 0&&(y=!1),!b||y&&b!==zs(m)?!1:y}function Ju(m,y,b,S){y===void 0&&(y=!1),b===void 0&&(b=!1);const M=m.getBoundingClientRect(),R=Fx(m);let k=dl(1);y&&(S?Va(S)&&(k=$d(S)):k=$d(m));const o=h6(R,b,S)?PS(R):dl(0);let G=(M.left+o.x)/k.x,Z=(M.top+o.y)/k.y,ee=M.width/k.x,ie=M.height/k.y;if(R){const re=zs(R),ue=S&&Va(S)?zs(S):S;let oe=re,ge=px(oe);for(;ge&&S&&ue!==oe;){const K=$d(ge),Te=ge.getBoundingClientRect(),Le=Ua(ge),Oe=Te.left+(ge.clientLeft+parseFloat(Le.paddingLeft))*K.x,Ae=Te.top+(ge.clientTop+parseFloat(Le.paddingTop))*K.y;G*=K.x,Z*=K.y,ee*=K.x,ie*=K.y,G+=Oe,Z+=Ae,oe=zs(ge),ge=px(oe)}}return Gg({width:ee,height:ie,x:G,y:Z})}function ny(m,y){const b=ry(m).scrollLeft;return y?y.left+b:Ju(gl(m)).left+b}function LS(m,y){const b=m.getBoundingClientRect(),S=b.left+y.scrollLeft-ny(m,b),M=b.top+y.scrollTop;return{x:S,y:M}}function d6(m){let{elements:y,rect:b,offsetParent:S,strategy:M}=m;const R=M==="fixed",k=gl(S),o=y?iy(y.floating):!1;if(S===k||o&&R)return b;let G={scrollLeft:0,scrollTop:0},Z=dl(1);const ee=dl(0),ie=ml(S);if((ie||!ie&&!R)&&((Qd(S)!=="body"||xm(k))&&(G=ry(S)),ml(S))){const ue=Ju(S);Z=$d(S),ee.x=ue.x+S.clientLeft,ee.y=ue.y+S.clientTop}const re=k&&!ie&&!R?LS(k,G):dl(0);return{width:b.width*Z.x,height:b.height*Z.y,x:b.x*Z.x-G.scrollLeft*Z.x+ee.x+re.x,y:b.y*Z.y-G.scrollTop*Z.y+ee.y+re.y}}function f6(m){return Array.from(m.getClientRects())}function p6(m){const y=gl(m),b=ry(m),S=m.ownerDocument.body,M=Xu(y.scrollWidth,y.clientWidth,S.scrollWidth,S.clientWidth),R=Xu(y.scrollHeight,y.clientHeight,S.scrollHeight,S.clientHeight);let k=-b.scrollLeft+ny(m);const o=-b.scrollTop;return Ua(S).direction==="rtl"&&(k+=Xu(y.clientWidth,S.clientWidth)-M),{width:M,height:R,x:k,y:o}}const hE=25;function m6(m,y){const b=zs(m),S=gl(m),M=b.visualViewport;let R=S.clientWidth,k=S.clientHeight,o=0,G=0;if(M){R=M.width,k=M.height;const ee=kx();(!ee||ee&&y==="fixed")&&(o=M.offsetLeft,G=M.offsetTop)}const Z=ny(S);if(Z<=0){const ee=S.ownerDocument,ie=ee.body,re=getComputedStyle(ie),ue=ee.compatMode==="CSS1Compat"&&parseFloat(re.marginLeft)+parseFloat(re.marginRight)||0,oe=Math.abs(S.clientWidth-ie.clientWidth-ue);oe<=hE&&(R-=oe)}else Z<=hE&&(R+=Z);return{width:R,height:k,x:o,y:G}}const _6=new Set(["absolute","fixed"]);function g6(m,y){const b=Ju(m,!0,y==="fixed"),S=b.top+m.clientTop,M=b.left+m.clientLeft,R=ml(m)?$d(m):dl(1),k=m.clientWidth*R.x,o=m.clientHeight*R.y,G=M*R.x,Z=S*R.y;return{width:k,height:o,x:G,y:Z}}function dE(m,y,b){let S;if(y==="viewport")S=m6(m,b);else if(y==="document")S=p6(gl(m));else if(Va(y))S=g6(y,b);else{const M=PS(m);S={x:y.x-M.x,y:y.y-M.y,width:y.width,height:y.height}}return Gg(S)}function RS(m,y){const b=$c(m);return b===y||!Va(b)||Jd(b)?!1:Ua(b).position==="fixed"||RS(b,y)}function y6(m,y){const b=y.get(m);if(b)return b;let S=mm(m,[],!1).filter(o=>Va(o)&&Qd(o)!=="body"),M=null;const R=Ua(m).position==="fixed";let k=R?$c(m):m;for(;Va(k)&&!Jd(k);){const o=Ua(k),G=zx(k);!G&&o.position==="fixed"&&(M=null),(R?!G&&!M:!G&&o.position==="static"&&!!M&&_6.has(M.position)||xm(k)&&!G&&RS(m,k))?S=S.filter(ee=>ee!==k):M=o,k=$c(k)}return y.set(m,S),S}function v6(m){let{element:y,boundary:b,rootBoundary:S,strategy:M}=m;const k=[...b==="clippingAncestors"?iy(y)?[]:y6(y,this._c):[].concat(b),S],o=k[0],G=k.reduce((Z,ee)=>{const ie=dE(y,ee,M);return Z.top=Xu(ie.top,Z.top),Z.right=Vg(ie.right,Z.right),Z.bottom=Vg(ie.bottom,Z.bottom),Z.left=Xu(ie.left,Z.left),Z},dE(y,o,M));return{width:G.right-G.left,height:G.bottom-G.top,x:G.left,y:G.top}}function x6(m){const{width:y,height:b}=MS(m);return{width:y,height:b}}function b6(m,y,b){const S=ml(y),M=gl(y),R=b==="fixed",k=Ju(m,!0,R,y);let o={scrollLeft:0,scrollTop:0};const G=dl(0);function Z(){G.x=ny(M)}if(S||!S&&!R)if((Qd(y)!=="body"||xm(M))&&(o=ry(y)),S){const ue=Ju(y,!0,R,y);G.x=ue.x+y.clientLeft,G.y=ue.y+y.clientTop}else M&&Z();R&&!S&&M&&Z();const ee=M&&!S&&!R?LS(M,o):dl(0),ie=k.left+o.scrollLeft-G.x-ee.x,re=k.top+o.scrollTop-G.y-ee.y;return{x:ie,y:re,width:k.width,height:k.height}}function Y0(m){return Ua(m).position==="static"}function fE(m,y){if(!ml(m)||Ua(m).position==="fixed")return null;if(y)return y(m);let b=m.offsetParent;return gl(m)===b&&(b=b.ownerDocument.body),b}function DS(m,y){const b=zs(m);if(iy(m))return b;if(!ml(m)){let M=$c(m);for(;M&&!Jd(M);){if(Va(M)&&!Y0(M))return M;M=$c(M)}return b}let S=fE(m,y);for(;S&&r6(S)&&Y0(S);)S=fE(S,y);return S&&Jd(S)&&Y0(S)&&!zx(S)?b:S||l6(m)||b}const w6=async function(m){const y=this.getOffsetParent||DS,b=this.getDimensions,S=await b(m.floating);return{reference:b6(m.reference,await y(m.floating),m.strategy),floating:{x:0,y:0,width:S.width,height:S.height}}};function T6(m){return Ua(m).direction==="rtl"}const E6={convertOffsetParentRelativeRectToViewportRelativeRect:d6,getDocumentElement:gl,getClippingRect:v6,getOffsetParent:DS,getElementRects:w6,getClientRects:f6,getDimensions:x6,getScale:$d,isElement:Va,isRTL:T6};function OS(m,y){return m.x===y.x&&m.y===y.y&&m.width===y.width&&m.height===y.height}function S6(m,y){let b=null,S;const M=gl(m);function R(){var o;clearTimeout(S),(o=b)==null||o.disconnect(),b=null}function k(o,G){o===void 0&&(o=!1),G===void 0&&(G=1),R();const Z=m.getBoundingClientRect(),{left:ee,top:ie,width:re,height:ue}=Z;if(o||y(),!re||!ue)return;const oe=Cg(ie),ge=Cg(M.clientWidth-(ee+re)),K=Cg(M.clientHeight-(ie+ue)),Te=Cg(ee),Oe={rootMargin:-oe+"px "+-ge+"px "+-K+"px "+-Te+"px",threshold:Xu(0,Vg(1,G))||1};let Ae=!0;function ze(Fe){const Ye=Fe[0].intersectionRatio;if(Ye!==G){if(!Ae)return k();Ye?k(!1,Ye):S=setTimeout(()=>{k(!1,1e-7)},1e3)}Ye===1&&!OS(Z,m.getBoundingClientRect())&&k(),Ae=!1}try{b=new IntersectionObserver(ze,{...Oe,root:M.ownerDocument})}catch{b=new IntersectionObserver(ze,Oe)}b.observe(m)}return k(!0),R}function I6(m,y,b,S){S===void 0&&(S={});const{ancestorScroll:M=!0,ancestorResize:R=!0,elementResize:k=typeof ResizeObserver=="function",layoutShift:o=typeof IntersectionObserver=="function",animationFrame:G=!1}=S,Z=Fx(m),ee=M||R?[...Z?mm(Z):[],...mm(y)]:[];ee.forEach(Te=>{M&&Te.addEventListener("scroll",b,{passive:!0}),R&&Te.addEventListener("resize",b)});const ie=Z&&o?S6(Z,b):null;let re=-1,ue=null;k&&(ue=new ResizeObserver(Te=>{let[Le]=Te;Le&&Le.target===Z&&ue&&(ue.unobserve(y),cancelAnimationFrame(re),re=requestAnimationFrame(()=>{var Oe;(Oe=ue)==null||Oe.observe(y)})),b()}),Z&&!G&&ue.observe(Z),ue.observe(y));let oe,ge=G?Ju(m):null;G&&K();function K(){const Te=Ju(m);ge&&!OS(ge,Te)&&b(),ge=Te,oe=requestAnimationFrame(K)}return b(),()=>{var Te;ee.forEach(Le=>{M&&Le.removeEventListener("scroll",b),R&&Le.removeEventListener("resize",b)}),ie?.(),(Te=ue)==null||Te.disconnect(),ue=null,G&&cancelAnimationFrame(oe)}}const A6=QB,C6=e6,M6=YB,P6=(m,y,b)=>{const S=new Map,M={platform:E6,...b},R={...M.platform,_c:S};return XB(m,y,{...M,platform:R})};function L6(m,y){if(!y)return;let b,S;function M(o){y=o,b&&(b.textContent=y)}function R(){b=document.createElement("div"),b.textContent=y,b.classList.add("simple-tooltip"),document.body.appendChild(b),S=I6(m,b,()=>{P6(m,b,{placement:"top",middleware:[A6(8),M6(),C6()]}).then(({x:o,y:G})=>{Object.assign(b.style,{left:`${o}px`,top:`${G}px`})})})}function k(){S&&S(),b&&b.remove()}return m.addEventListener("mouseenter",R),m.addEventListener("mouseleave",k),{update:M,destroy(){m.removeEventListener("mouseenter",R),m.removeEventListener("mouseleave",k),S&&S(),b&&b.remove()}}}var R6=Zi('<div><button aria-label="Select area by radius" id="select-radius-button"><div><!></div></button></div>'),D6=Zi('<div class="radius-input-container svelte-ohdq0y"><input class="number-input svelte-ohdq0y" type="number" max="10" min="0"/> mi</div>'),O6=Zi('<div class="select-radius-button-label svelte-ohdq0y">Select by radius</div>'),z6=Zi('<div class="select-radius-button-container svelte-ohdq0y"><!> <!></div>');function k6(m,y){Co(y,!0);let b=ao(!1),S=ao(.1),M=Xr(()=>!ko?.results||gr.type==="area");const R=()=>{Yr(b,!0),Zt.isDrawing=!0},k=ue=>{const oe=ko.results;Yr(S,ue,!0);const ge={steps:64,units:"miles"},K=OL(oe,nt(S),ge);gr.selected=K,gr.type="radius",gr.radius=nt(S),Zt.isDrawing=!1};ms(()=>{nt(b)?k(nt(S)):Yr(S,.1)}),ms(()=>{(gr.type!=="radius"||!gr.selected)&&Yr(b,!1)}),qg(()=>{gr.type==="radius"&&gr.radius&&ko.results&&!gr.selected&&(Yr(b,!0),Yr(S,gr.radius,!0),k(nt(S)))});let o=Xr(()=>nt(M)?"You need to search for an address on the map before setting a radius.":null);var G=z6(),Z=Ht(G);EE(Z,()=>nt(o),ue=>{var oe=R6(),ge=Ht(oe);ge.__click=R;var K=Ht(ge),Te=Ht(K);kB(Te),Ut(K),Ut(ge),Ut(oe),QC(oe,(Le,Oe)=>L6?.(Le,Oe),()=>nt(o)),Sn(()=>{Ao(ge,1,Fo(["select-radius-button",{active:nt(b),disabled:nt(M)}]),"svelte-ohdq0y"),Ao(K,1,Fo(["select-radius-icon-container area",{disabled:nt(M)}]),"svelte-ohdq0y")}),gi(ue,oe)});var ee=zi(Z,2);{var ie=ue=>{var oe=D6(),ge=Ht(oe);AE(ge),Hc(ge,"step",.1),ge.__change=K=>k(K.target.value),Wd(),Ut(oe),Sn(()=>sM(ge,nt(S))),gi(ue,oe)},re=ue=>{var oe=O6();gi(ue,oe)};Fn(ee,ue=>{nt(b)?ue(ie):ue(re,!1)})}Ut(G),gi(m,G),Mo()}Fs(["click","change"]);var Rs=CE(()=>gr),F6=Zi("<button><div>Remove selection</div> <div><!></div></button>");function B6(m,y){Co(y,!1);const b=()=>{Rs(Rs().selected=null),Rs(Rs().type=null),Rs(Rs().policies=null),Rs(Rs().data=null),Rs().radius&&delete Rs().radius};mE();var S=F6();S.__click=b;var M=Ht(S),R=zi(M,2),k=Ht(R);Ox(k),Ut(R),Ut(S),Sn(()=>{Ao(S,1,Fo(["RemoveSelectionButton",{invisible:!Rs().selected}]),"svelte-1k1dna"),Ao(M,1,Fo(["RemoveSelectionButton-text",{invisible:!Rs().selected}]),"svelte-1k1dna"),Ao(R,1,Fo(["RemoveSelectionButton-icon",{invisible:!Rs().selected}]),"svelte-1k1dna")}),gi(m,S),Mo()}Fs(["click"]);var N6=ks('<svg width="100" height="20" viewBox="0 0 100 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="20" transform="matrix(1 0 0 -1 0 20)" fill="white"></rect><path d="M10 10L52.2591 10L65.5482 10L77.7741 10L90 10" stroke="#F9B685" stroke-width="5" stroke-linecap="round"></path><path d="M26 10L51.8837 10L60.0233 10L67.5116 10L75 10" stroke="#1871BD" stroke-width="8" stroke-linecap="round"></path><path d="M43.3333 2H56.6667C57.4053 2 58 2.59467 58 3.33333V16.6667C58 17.4053 57.4053 18 56.6667 18H43.3333C42.5947 18 42 17.4053 42 16.6667V3.33333C42 2.59467 42.5947 2 43.3333 2Z" fill="black" stroke="black"></path><path d="M43.3333 2.44443H56.6667C57.1591 2.44443 57.5556 2.84087 57.5556 3.33331V16.6666C57.5556 17.1591 57.1591 17.5555 56.6667 17.5555H43.3333C42.8409 17.5555 42.4445 17.1591 42.4445 16.6666V3.33331C42.4445 2.84087 42.8409 2.44443 43.3333 2.44443Z" fill="#87CEEB"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M52.6602 3.57385C52.9293 3.38466 53.2905 3.2771 53.6774 3.34629C53.9433 3.39387 54.1547 3.50914 54.3265 3.66754C54.583 3.90395 54.7525 4.23639 54.7615 4.63792C54.7792 5.42487 54.16 6.04987 53.316 5.99643C52.9136 5.97097 52.6231 5.79504 52.3925 5.5213C52.2373 5.33709 52.1397 5.15465 52.0913 4.85876C51.9984 4.2904 52.3207 3.8125 52.6602 3.57385ZM45.8876 9.75081C46.4077 9.25815 47.0311 8.88222 47.8485 8.71348C47.903 8.70224 47.9682 8.70679 48.0158 8.68674C48.0706 8.66356 48.1618 8.52311 48.1965 8.48599C48.8248 7.81108 49.4067 7.11117 50.0168 6.42477C49.6542 6.19849 49.2746 5.98914 48.8992 5.77563C48.4593 6.14253 48.0504 6.53933 47.6076 6.9267C47.4064 7.10263 47.0684 7.29712 46.7041 7.14754C46.3999 7.02263 46.1687 6.71927 46.1955 6.31102C46.2178 5.96987 46.48 5.78697 46.6974 5.58825C47.1426 5.18117 47.6009 4.76365 48.0626 4.36354C48.2209 4.22644 48.3687 4.06487 48.6114 4.00884C48.6399 4.00226 48.6854 4.01296 48.7051 3.97538C48.7153 4.00795 48.8095 3.9827 48.8791 3.98878C49.0847 4.0067 49.2608 4.13396 49.4279 4.22971C50.2569 4.7048 51.0995 5.19248 51.9375 5.66854C52.1001 5.76094 52.2672 5.85958 52.4327 5.96301C52.5989 6.06697 52.7875 6.13958 52.9346 6.25076C53.2295 6.47373 53.3642 6.9715 53.1956 7.35501C53.0915 7.59177 52.882 7.77442 52.7137 7.97069C52.3264 8.4226 51.9073 8.88955 51.5092 9.34928C52.3456 9.31561 53.2897 9.25296 54.0991 9.18868C54.2198 9.2061 54.3591 9.18032 54.5073 9.20873C54.904 9.28493 55.1882 9.62398 55.143 10.1189C55.0341 11.3142 54.9459 12.5903 54.8486 13.8532C54.8219 14.1998 54.8062 14.4508 54.6277 14.6563C54.4416 14.8705 54.0716 15.0257 53.731 14.8838C53.4491 14.7663 53.2097 14.5085 53.2156 14.1275C53.2185 13.9446 53.2502 13.7429 53.2625 13.5453C53.3168 12.6747 53.4148 11.6989 53.47 10.855C53.1544 10.8555 52.7464 10.8991 52.4059 10.9086C52.7218 11.5581 52.9193 12.5216 52.7472 13.4717C52.5951 14.3111 52.1962 15.018 51.6965 15.5128C51.3435 15.1765 51.0036 14.8271 50.6525 14.4889C50.9217 14.1947 51.1615 13.7978 51.2682 13.3512C51.3771 12.8956 51.3675 12.4247 51.2348 11.9726C50.863 10.8771 50.0113 10.111 48.6248 10.0854C48.2894 10.0792 47.9303 10.1848 47.6611 10.3062C47.3751 10.4353 47.1425 10.5874 46.9183 10.7747C46.569 10.4391 46.2393 10.084 45.8876 9.75081ZM50.1773 14.9038C50.4563 15.1467 50.7156 15.422 50.9804 15.6868C51.0675 15.7739 51.1708 15.846 51.2347 15.9478C50.527 16.4946 49.5511 16.8724 48.3637 16.7977C47.9297 16.7704 47.543 16.6523 47.1926 16.53C47.0852 16.4926 46.9819 16.4363 46.8848 16.3896C46.6692 16.2856 46.4564 16.1736 46.2758 16.0415C46.0906 15.906 45.9298 15.7483 45.7671 15.5932C45.1634 15.0169 44.6727 14.0763 44.6027 13.0099C44.5687 12.4924 44.6395 11.9 44.7968 11.4373C44.9572 10.9654 45.1862 10.5806 45.4526 10.2126C45.7213 10.4481 45.9689 10.7144 46.2289 10.9689C46.3178 11.0559 46.4131 11.1412 46.4899 11.2366C46.525 11.271 46.4597 11.3325 46.4364 11.3704C46.24 11.6896 46.0946 12.0968 46.0616 12.5751C46.0231 13.1335 46.1799 13.6511 46.4096 14.0339C46.6262 14.3949 46.9269 14.7208 47.3064 14.9575C47.6828 15.1922 48.1659 15.3596 48.6917 15.359C49.3057 15.3582 49.7814 15.1579 50.1773 14.9038Z" fill="black"></path></svg>');function V6(m){var y=N6();gi(m,y)}var U6=ks('<svg width="100" height="20" viewBox="0 0 100 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="20" transform="matrix(1 0 0 -1 0 20)" fill="white"></rect><path d="M10 10L52.2591 10L65.5482 10L77.7741 10L90 10" stroke="#F9B685" stroke-width="5" stroke-linecap="round"></path><path d="M26 10L51.8837 10L60.0233 10L67.5116 10L75 10" stroke="#E22214" stroke-width="8" stroke-linecap="round"></path><path d="M43.3333 2H56.6667C57.4053 2 58 2.59467 58 3.33333V16.6667C58 17.4053 57.4053 18 56.6667 18H43.3333C42.5947 18 42 17.4053 42 16.6667V3.33333C42 2.59467 42.5947 2 43.3333 2Z" fill="black" stroke="black"></path><path d="M43.3333 2.44443H56.6667C57.1591 2.44443 57.5556 2.84087 57.5556 3.33332V16.6667C57.5556 17.1591 57.1591 17.5555 56.6667 17.5555H43.3333C42.8409 17.5555 42.4445 17.1591 42.4445 16.6667V3.33332C42.4445 2.84087 42.8409 2.44443 43.3333 2.44443Z" fill="#BDA2D5"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M46.8512 10.1743L44.8027 12.605L46.2392 13.7826L48.2883 11.3245L46.8512 10.1743Z" fill="black"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M47.4901 15.1418C47.4901 15.6382 47.9159 16.0311 48.422 16.0311C48.9004 16.0311 49.3257 15.6382 49.3257 15.1418C49.3257 14.6454 48.9005 14.2525 48.422 14.2525C47.916 14.2526 47.4901 14.6454 47.4901 15.1418Z" fill="black"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M53.5036 6.93273C53.3967 6.64472 53.1311 6.3313 52.8914 6.14836C52.6517 5.96542 52.3061 5.83353 52.1733 5.78181C52.0137 5.72998 52.0397 5.54704 52.1465 5.46769C52.2533 5.31173 52.3061 5.12866 52.3061 4.94576C52.306 4.42282 51.8808 4.00444 51.3221 4.00444C50.7894 4.00444 50.3635 4.42282 50.3635 4.94548C50.3635 5.31144 50.5765 5.65035 50.9222 5.80788C51.055 5.8596 51.1351 5.99082 51.0825 6.06958C51.0023 6.14823 50.8688 6.38238 50.8688 6.56602C50.8688 6.74896 51.1619 7.97731 51.1619 8.49995C51.1619 9.04956 51.0023 9.65017 50.8963 9.80832C50.7627 9.99126 50.6566 10.0169 50.4963 10.0955L49.459 10.6438L46.3192 14.3315L44.589 12.8929L44.0044 13.6248L46.4787 15.7172L50.3376 11.1934C50.71 11.0891 51.4275 10.8012 51.9068 10.2515C51.9068 10.2515 51.9868 10.6174 52.0135 10.8012C52.0396 10.9586 52.0135 12.1341 52.0135 12.3695C52.0135 12.6049 52.093 13.7825 52.1464 14.0435C52.1998 14.2775 52.3326 15.2448 52.3326 15.2448C52.3326 15.2448 51.6144 15.6632 51.4809 15.7172C51.3747 15.7952 51.2947 16.0038 51.5877 16.0038H53.3438L53.3438 11.6107L54.1421 13.5454L54.9931 15.2988L54.2222 15.7427C54.0619 15.8208 54.036 16.0038 54.3016 16.0038H56.0311V15.3769L54.6484 9.80828L53.5302 6.93248H53.5036L53.5036 6.93273Z" fill="black"></path><path d="M43.3333 2H56.6667C57.4053 2 58 2.59467 58 3.33333V16.6667C58 17.4053 57.4053 18 56.6667 18H43.3333C42.5947 18 42 17.4053 42 16.6667V3.33333C42 2.59467 42.5947 2 43.3333 2Z" fill="black" stroke="black"></path><path d="M43.3333 2.44443H56.6667C57.1591 2.44443 57.5556 2.84087 57.5556 3.33332V16.6666C57.5556 17.1591 57.1591 17.5555 56.6667 17.5555H43.3333C42.8409 17.5555 42.4445 17.1591 42.4445 16.6666V3.33332C42.4445 2.84087 42.8409 2.44443 43.3333 2.44443Z" fill="#FC8385"></path><path d="M50.5051 4.00444H44.1852C43.7136 4.00444 43.3363 4.43204 43.3363 4.96656V10.6859H51.3541V4.96656C51.3541 4.45874 50.9768 4.00444 50.5051 4.00444Z" fill="black"></path><path d="M55.2415 6.84863H52.083V11.5734H43.3363V13.4108C43.3363 14.1983 43.8222 14.1983 43.8222 14.1983H44.7941C44.7941 12.0222 46.677 12.0222 46.677 12.0222C48.6207 12.0222 48.6815 14.1983 48.6815 14.1983H51.4898C51.4898 12.0222 53.3585 12.0222 53.3585 12.0222C55.3022 12.0222 55.2415 14.1983 55.2415 14.1983H56.2133C56.6993 14.1983 56.6993 13.9358 56.6993 13.9358V8.68604C56.6993 7.37361 55.2415 6.84863 55.2415 6.84863ZM55.7274 10.7859H54.5126C54.5126 9.73599 53.7837 9.73599 53.7837 9.73599H52.8119V7.89858H54.7556C55.7274 7.89858 55.7274 8.68604 55.7274 8.68604V10.7859Z" fill="black"></path><path d="M46.677 12.6904C45.942 12.6904 45.3407 13.2917 45.3407 14.0267C45.3407 14.7617 45.942 15.363 46.677 15.363C47.412 15.363 48.0133 14.7617 48.0133 14.0267C48.0133 13.2917 47.412 12.6904 46.677 12.6904Z" fill="black"></path><path d="M53.3585 12.6904C52.6235 12.6904 52.0222 13.2917 52.0222 14.0267C52.0222 14.7617 52.6235 15.363 53.3585 15.363C54.0935 15.363 54.6948 14.7617 54.6948 14.0267C54.6948 13.2917 54.0935 12.6904 53.3585 12.6904Z" fill="black"></path><path d="M43.3333 2H56.6667C57.4053 2 58 2.59467 58 3.33333V16.6667C58 17.4053 57.4053 18 56.6667 18H43.3333C42.5947 18 42 17.4053 42 16.6667V3.33333C42 2.59467 42.5947 2 43.3333 2Z" fill="black" stroke="black"></path><path d="M43.3333 2.44443H56.6667C57.1591 2.44443 57.5556 2.84087 57.5556 3.33332V16.6666C57.5556 17.1591 57.1591 17.5555 56.6667 17.5555H43.3333C42.8409 17.5555 42.4445 17.1591 42.4445 16.6666V3.33332C42.4445 2.84087 42.8409 2.44443 43.3333 2.44443Z" fill="#FC8385"></path><path d="M50.5051 4.00444H44.1852C43.7136 4.00444 43.3363 4.43204 43.3363 4.96656V10.0178H51.3541V4.96656C51.3541 4.45874 50.9768 4.00444 50.5051 4.00444Z" fill="black"></path><path d="M55.363 6.67702H52.0222V10.6859H43.3363V13.4108C43.3363 14.1983 43.8222 14.1983 43.8222 14.1983H44.7941C44.7941 12.0222 46.677 12.0222 46.677 12.0222C48.6207 12.0222 48.6815 14.1983 48.6815 14.1983H51.4898C51.4898 12.0222 53.3585 12.0222 53.3585 12.0222C55.3022 12.0222 55.2415 14.1983 55.2415 14.1983H56.2133C56.6993 14.1983 56.6993 13.6926 56.6993 13.6926V10.0178L55.363 6.67702ZM55.363 9.34962H53.0245V7.67925H54.6948L55.363 9.34962Z" fill="black"></path><path d="M46.677 12.6904C45.942 12.6904 45.3407 13.2917 45.3407 14.0267C45.3407 14.7617 45.942 15.363 46.677 15.363C47.412 15.363 48.0133 14.7617 48.0133 14.0267C48.0133 13.2917 47.412 12.6904 46.677 12.6904Z" fill="black"></path><path d="M53.3585 12.6904C52.6235 12.6904 52.0222 13.2917 52.0222 14.0267C52.0222 14.7617 52.6235 15.363 53.3585 15.363C54.0935 15.363 54.6948 14.7617 54.6948 14.0267C54.6948 13.2917 54.0935 12.6904 53.3585 12.6904Z" fill="black"></path><path d="M43.3333 2H56.6667C57.4053 2 58 2.59467 58 3.33333V16.6667C58 17.4053 57.4053 18 56.6667 18H43.3333C42.5947 18 42 17.4053 42 16.6667V3.33333C42 2.59467 42.5947 2 43.3333 2Z" fill="black" stroke="black"></path><path d="M43.3333 2.44443H56.6667C57.1591 2.44443 57.5556 2.84087 57.5556 3.33332V16.6666C57.5556 17.1591 57.1591 17.5555 56.6667 17.5555H43.3333C42.8409 17.5555 42.4445 17.1591 42.4445 16.6666V3.33332C42.4445 2.84087 42.8409 2.44443 43.3333 2.44443Z" fill="#FC8385"></path><path d="M50.5051 4.67259H44.1852C43.7136 4.67259 43.3363 5.05268 43.3363 5.5278V10.0178H51.3541V5.5278C51.3541 5.07641 50.9768 4.67259 50.5051 4.67259Z" fill="black"></path><path d="M55.363 6.67702H52.0222V10.6859H43.3363V13.4108C43.3363 14.1983 43.8222 14.1983 43.8222 14.1983H44.7941C44.7941 12.0222 46.677 12.0222 46.677 12.0222C48.6207 12.0222 48.6815 14.1983 48.6815 14.1983H51.4898C51.4898 12.0222 53.3585 12.0222 53.3585 12.0222C55.3022 12.0222 55.2415 14.1983 55.2415 14.1983H56.2133C56.6993 14.1983 56.6993 13.6926 56.6993 13.6926V10.0178L55.363 6.67702ZM55.363 9.34962H53.0245V7.67925H54.6948L55.363 9.34962Z" fill="black"></path><path d="M46.677 12.6904C45.942 12.6904 45.3407 13.2917 45.3407 14.0267C45.3407 14.7617 45.942 15.363 46.677 15.363C47.412 15.363 48.0133 14.7617 48.0133 14.0267C48.0133 13.2917 47.412 12.6904 46.677 12.6904Z" fill="black"></path><path d="M53.3585 12.6904C52.6235 12.6904 52.0222 13.2917 52.0222 14.0267C52.0222 14.7617 52.6235 15.363 53.3585 15.363C54.0935 15.363 54.6948 14.7617 54.6948 14.0267C54.6948 13.2917 54.0935 12.6904 53.3585 12.6904Z" fill="black"></path></svg>');function j6(m){var y=U6();gi(m,y)}var G6=ks('<svg width="100" height="20" viewBox="0 0 100 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="20" transform="matrix(1 0 0 -1 0 20)" fill="white"></rect><path d="M10 10L96 10" stroke="#F58433" stroke-width="5" stroke-linecap="round" stroke-dasharray="1 8"></path></svg>');function q6(m){var y=G6();gi(m,y)}var H6=ks('<svg width="100" height="20" viewBox="0 0 100 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="20" transform="matrix(1 0 0 -1 0 20)" fill="white"></rect><path d="M10 10L96 10" stroke="#F9B685" stroke-width="5" stroke-linecap="round" stroke-dasharray="1 8"></path></svg>');function Z6(m){var y=H6();gi(m,y)}var $6=ks('<svg width="100" height="20" viewBox="0 0 100 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="20" fill="white"></rect><path d="M10 9L52.2582 9.28747L65.5469 9.37787L77.7725 9.46104L89.9981 9.54421" stroke="#51ACFF" stroke-width="6" stroke-linecap="round"></path></svg>');function W6(m){var y=$6();gi(m,y)}var X6=ks('<svg width="100" height="20" viewBox="0 0 100 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="20" fill="white"></rect><path d="M10 10L52.2582 10.2875L65.5469 10.3779L77.7725 10.461L89.9981 10.5442" stroke="#99CEFF" stroke-width="6" stroke-linecap="round"></path></svg>');function Y6(m){var y=X6();gi(m,y)}var J6=Zi('<div class="legend-icon svelte-pswzrf"><!></div>'),K6=Zi('<div class="legend-icon svelte-pswzrf"><!></div>'),Q6=Zi('<div class="legend-icon svelte-pswzrf"><!></div>'),eN=Zi('<div class="legend-icon svelte-pswzrf"><!></div>'),tN=Zi('<div class="legend-item svelte-pswzrf"><div class="legend-text svelte-pswzrf">Accessible parking:</div> <div class="legend-icon svelte-pswzrf"><!></div></div>'),iN=Zi('<div class="legend-item svelte-pswzrf"><div class="legend-text svelte-pswzrf">Loading zones:</div> <div class="legend-icon svelte-pswzrf"><!></div></div>'),rN=Zi('<div class="Legend svelte-pswzrf"><div class="legend-item svelte-pswzrf"><div class="legend-text svelte-pswzrf">Parking allowed with currently selected time and filters:</div> <!></div> <div class="legend-item svelte-pswzrf"><div class="legend-text svelte-pswzrf">Parking not allowed with current filters:</div> <!></div> <!> <!></div>');function nN(m,y){Co(y,!0);const b=Xr(()=>OE(Hd.current)),S=Xr(()=>nt(b).accessible),M=Xr(()=>nt(b).loadingZone);var R=rN(),k=Ht(R),o=zi(Ht(k),2);{var G=Le=>{var Oe=J6(),Ae=Ht(Oe);W6(Ae),Ut(Oe),gi(Le,Oe)},Z=Le=>{var Oe=K6(),Ae=Ht(Oe);Y6(Ae),Ut(Oe),gi(Le,Oe)};Fn(o,Le=>{!nt(S)&&!nt(M)?Le(G):Le(Z,!1)})}Ut(k);var ee=zi(k,2),ie=zi(Ht(ee),2);{var re=Le=>{var Oe=Q6(),Ae=Ht(Oe);q6(Ae),Ut(Oe),gi(Le,Oe)},ue=Le=>{var Oe=eN(),Ae=Ht(Oe);Z6(Ae),Ut(Oe),gi(Le,Oe)};Fn(ie,Le=>{!nt(S)&&!nt(M)?Le(re):Le(ue,!1)})}Ut(ee);var oe=zi(ee,2);{var ge=Le=>{var Oe=tN(),Ae=zi(Ht(Oe),2),ze=Ht(Ae);V6(ze),Ut(Ae),Ut(Oe),gi(Le,Oe)};Fn(oe,Le=>{nt(S)&&Le(ge)})}var K=zi(oe,2);{var Te=Le=>{var Oe=iN(),Ae=zi(Ht(Oe),2),ze=Ht(Ae);j6(ze),Ut(Ae),Ut(Oe),gi(Le,Oe)};Fn(K,Le=>{nt(M)&&Le(Te)})}Ut(R),gi(m,R),Mo()}var oN=Zi('<div class="SelectAreaMenu-section svelte-39j9u"><div class="section-title-container svelte-39j9u"><div class="section-title svelte-39j9u">Legend</div></div> <!></div>'),sN=Zi(`<div class="walking-time svelte-39j9u"><div class="walking-time-statement"> <sup>*</sup></div> <div class="walking-time-caveat"><sup>*</sup>Approximate walking time only. Actual walking time will be longer due to the
				street grid</div></div>`),aN=Zi('<div class="SelectAreaMenu svelte-39j9u"><div class="SelectAreaMenu-section svelte-39j9u"><div class="section-title svelte-39j9u">Search for an Address</div> <div class="search-container"><!></div></div> <div class="SelectAreaMenu-section svelte-39j9u"><div class="section-title-container svelte-39j9u"><div class="section-title svelte-39j9u">Select Area</div> <!></div> <div class="select-area-buttons svelte-39j9u"><!> <!></div></div> <!> <!></div>');function lN(m,y){Co(y,!0);const b=20,S=Xr(()=>!!ko?.results),M=Xr(()=>gr?.radius?Number(gr?.radius):null),R=Xr(()=>nt(M)?nt(M)*b:0),k=Xr(()=>`Locations within ${nt(M)} ${dx("mile",nt(M))} (about ${nt(R)} ${dx("minute",nt(R))} walking time)`);var o=aN(),G=Ht(o),Z=zi(Ht(G),2),ee=Ht(Z);PB(ee,{}),Ut(Z),Ut(G);var ie=zi(G,2),re=Ht(ie),ue=zi(Ht(re),2);B6(ue,{}),Ut(re);var oe=zi(re,2),ge=Ht(oe);{var K=Fe=>{k6(Fe,{})};Fn(ge,Fe=>{nt(S)&&Fe(K)})}var Te=zi(ge,2);OB(Te,{}),Ut(oe),Ut(ie);var Le=zi(ie,2);{var Oe=Fe=>{var Ye=oN(),it=zi(Ht(Ye),2);nN(it,{}),Ut(Ye),gi(Fe,Ye)};Fn(Le,Fe=>{gr?.selected&&Fe(Oe)})}var Ae=zi(Le,2);{var ze=Fe=>{var Ye=sN(),it=Ht(Ye),jt=Ht(it,!0);Wd(),Ut(it),Wd(2),Ut(Ye),Sn(()=>Qo(jt,nt(k))),gi(Fe,Ye)};Fn(Ae,Fe=>{gr?.type==="radius"&&Fe(ze)})}Ut(o),gi(m,o),Mo()}var cN=Zi('<div class="checkbox-label svelte-9mcw37"> </div>'),uN=Zi('<button class="Checkbox svelte-9mcw37"><div class="checkbox-box svelte-9mcw37"><!></div> <!></button>');function zS(m,y){var b=uN();b.__click=function(...G){y.setValue?.apply(this,G)};var S=Ht(b),M=Ht(S);{var R=G=>{NF(G)};Fn(M,G=>{y.value&&G(R)})}Ut(S);var k=zi(S,2);{var o=G=>{var Z=cN(),ee=Ht(Z,!0);Ut(Z),Sn(()=>Qo(ee,y.label)),gi(G,Z)};Fn(k,G=>{y.label&&G(o)})}Ut(b),gi(m,b)}Fs(["click"]);var hN=Zi('<div class="toggle-label svelte-aw96os"> </div>'),dN=Zi('<div class="Toggle svelte-aw96os"><label class="switch svelte-aw96os"><input type="checkbox" class="svelte-aw96os"/> <span class="slider svelte-aw96os"></span></label> <!></div>');function fN(m,y){var b=dN(),S=Ht(b),M=Ht(S);AE(M),M.__change=function(...o){y.onToggle?.apply(this,o)},Wd(2),Ut(S);var R=zi(S,2);{var k=o=>{var G=hN(),Z=Ht(G,!0);Ut(G),Sn(()=>Qo(Z,y.label)),gi(o,G)};Fn(R,o=>{y.label&&o(k)})}Ut(b),Sn(()=>aM(M,y.value)),gi(m,b)}Fs(["change"]);var $u=CE(()=>Hd),pN=Zi('<div class="curb-use-options svelte-3c1fen"></div>'),mN=Zi('<div class="curb-use-section svelte-3c1fen"><button class="curb-use-title svelte-3c1fen"><div><!></div> </button> <!></div>'),_N=Zi('<div class="Filters svelte-3c1fen"></div>');function gN(m,y){Co(y,!1);const b=R=>{$u($u().current=$u().current.map(k=>k?.title===R?{...k,open:!k.open}:k))},S=(R,k)=>{$u($u().current=$u().current.map(o=>o?.title===R?{...o,options:o.options.map(G=>G?.label===k?{...G,value:!G.value}:G)}:o))};mE();var M=_N();Gc(M,5,()=>$u().current,jc,(R,k)=>{var o=mN(),G=Ht(o);G.__click=()=>b(nt(k)?.title);var Z=Ht(G),ee=Ht(Z);yS(ee),Ut(Z);var ie=zi(Z);Ut(G);var re=zi(G,2);{var ue=oe=>{var ge=pN();Gc(ge,5,()=>nt(k)?.options,jc,(K,Te)=>{var Le=_x(),Oe=um(Le);{var Ae=Fe=>{{let Ye=tm(()=>nt(Te)?.label),it=tm(()=>nt(Te)?.value);fN(Fe,{get label(){return nt(Ye)},get value(){return nt(it)},onToggle:()=>S(nt(k)?.title,nt(Te)?.label)})}},ze=Fe=>{{let Ye=tm(()=>nt(Te)?.label),it=tm(()=>nt(Te)?.value);zS(Fe,{get label(){return nt(Ye)},get value(){return nt(it)},setValue:()=>S(nt(k)?.title,nt(Te)?.label)})}};Fn(Oe,Fe=>{nt(Te).type==="toggle"?Fe(Ae):Fe(ze,!1)})}gi(K,Le)}),Ut(ge),gi(oe,ge)};Fn(re,oe=>{nt(k)?.open&&oe(ue)})}Ut(o),Sn(()=>{Ao(Z,1,Fo(["caret",{closed:!nt(k)?.open}]),"svelte-3c1fen"),Qo(ie,` ${nt(k)?.title??""}`)}),gi(R,o)}),Ut(M),gi(m,M),Mo()}Fs(["click"]);var yN=Zi('<option class="svelte-kgylqb"> </option>'),vN=Zi('<div class="Dropdown svelte-kgylqb"><select></select> <div><!></div></div>');function mx(m,y){Co(y,!0);var b=vN(),S=Ht(b);S.__change=o=>y.onChange(o.target.value),Gc(S,21,()=>y.options,jc,(o,G)=>{var Z=yN(),ee=Ht(Z,!0);Ut(Z);var ie={};Sn(()=>{Qo(ee,nt(G).label),ie!==(ie=nt(G).value)&&(Z.value=(Z.__value=nt(G).value)??"")}),gi(o,Z)}),Ut(S);var M;rM(S);var R=zi(S,2),k=Ht(R);yS(k),Ut(R),Ut(b),Sn(()=>{Ao(S,1,Fo(["",{disabled:y.disabled}]),"svelte-kgylqb"),M!==(M=y.value)&&(S.value=(S.__value=y.value)??"",IE(S,y.value)),Ao(R,1,Fo(["Dropdown-icon",{disabled:y.disabled}]),"svelte-kgylqb")}),gi(m,b),Mo()}Fs(["change"]);var xN=Zi('<div class="TimeSelector svelte-g8oebw"><div class="section-title svelte-g8oebw">Day of week</div> <!> <div class="section-title svelte-g8oebw">Time of day</div> <!> <div class="local-time-container svelte-g8oebw"><!> Use current local time (EST)</div></div>');function bN(m,y){Co(y,!0);let b=Xr(()=>rn.useCurrentTime);const S=Xr(()=>DE.filter(ee=>!ee?.hide)),M=()=>{rn.useCurrentTime=!rn.useCurrentTime};var R=xN(),k=zi(Ht(R),2);mx(k,{get options(){return Tx},get value(){return rn.day},onChange:ee=>rn.day=ee,get disabled(){return nt(b)}});var o=zi(k,4);mx(o,{get options(){return nt(S)},get value(){return rn.time},onChange:ee=>rn.time=Number(ee),get disabled(){return nt(b)}});var G=zi(o,2),Z=Ht(G);zS(Z,{get value(){return nt(b)},setValue:M}),Wd(),Ut(G),Ut(R),gi(m,R),Mo()}const pE=Tx.map(m=>m.value),wN=m=>{const y=JSON.parse(JSON.stringify(m));if(!y||!y.length)return;let b=[];const S=y.sort((M,R)=>R.priority-M.priority);for(const M of S){let{rules:R=[],time_spans:k=[]}=M??{};R=Array.isArray(R)?R.filter(Boolean):[],k=Array.isArray(k)?k.filter(Boolean):[];for(const o of R){let{activity:G=null,purposes:Z=[],user_classes:ee=[],max_stay:ie,max_stay_unit:re}=o??{};Z||(Z=[]),ee||(ee=[]),Z=Z.map(qd),ee=ee.map(qd);for(const ue of k){let{days_of_week:oe=null,time_of_day_start:ge=null,time_of_day_end:K=null,designated_period:Te}=ue??{};oe!=null?oe=oe.map(qd):oe=pE,ge=zg(ge),ge===24&&(ge=0),K=zg(K),K===0&&(K=24);let Le={policyId:M?.curb_policy_id};ie&&(Le.maxStay=`${ie} ${dx(re,ie)}`),Le.priority=M?.priority??0,Le.days=oe,Le.start=ge===null?0:ge,Le.end=K===null?24:K,Le.activity=G,Le.purposes=Z,Le.designatedPeriod=Te,b.push(Le)}}}return b=pE.reduce((M,R)=>{let k=b.filter(o=>o.days.includes(R));return k=k.sort((o,G)=>G.priority-o.priority).map(o=>{const G=JSON.parse(JSON.stringify(o));return delete G.days,G}),M[R]=k,M},{}),b};var TN=Zi("<div> </div>"),EN=Zi('<div role="application" class="event-block svelte-1oznmde"></div>'),SN=Zi('<div class="calendar-container svelte-1oznmde"><div class="calendar-container-inner svelte-1oznmde"><div class="time-sidebar svelte-1oznmde"></div> <div class="main-calendar svelte-1oznmde"><div class="main-calendar-inner svelte-1oznmde"></div> <!></div></div></div>'),IN=Zi('<div class="Calendar svelte-1oznmde"><!> <!></div>');function AN(m,y){Co(y,!0);const b=0,S=24,M=Xr(()=>wN(y.policies)),R=Xr(()=>!nt(M)||!rn?.day?null:nt(M)[rn?.day]),k=Xr(()=>{if(!nt(R))return null;const Oe=nt(R).reduce((Ae,ze)=>(Ae[ze.policyId]||(Ae[ze.policyId]={priority:ze.priority,items:[]}),Ae[ze.policyId].items.push(ze),Ae),{});return Object.values(Oe).sort((Ae,ze)=>Ae.priority-ze.priority).map(Ae=>Ae.items)});let o=ao(0);const G=(Oe,Ae)=>{let ze=Math.max(b,Oe);return(Math.min(S,Ae)-ze)*2*nt(o)},Z=Oe=>(Math.max(b,Oe)-b)*2*nt(o)+nt(o)/2;let ee=ao(0);const ie=Oe=>nt(ee)/Oe-1,re=(Oe,Ae)=>(ie(Oe)+1)*Ae,ue=Oe=>{switch(Oe){case"parking":return hn.parkingAllowed;case"loading":return hn.loading;default:return hn.parkingNotAllowed}},oe=Xr(()=>DE.filter(Ae=>Ae.value>=b&&Ae.value<=S));ms(()=>{nt(R)&&y.policies&&document.getElementById("9:00 AM").scrollIntoView()});var ge=IN(),K=Ht(ge);mx(K,{get options(){return Tx},get value(){return rn.day},onChange:Oe=>rn.day=Oe});var Te=zi(K,2);{var Le=Oe=>{var Ae=SN(),ze=Ht(Ae),Fe=Ht(ze);Gc(Fe,21,()=>nt(oe),jc,(Rt,li)=>{var Xt=TN(),Pt=Ht(Xt,!0);Ut(Xt),Sn(Ai=>{Hc(Xt,"id",`${nt(li).label}`),Ao(Xt,1,Ai,"svelte-1oznmde"),Qo(Pt,nt(li).label)},[()=>Fo(["time",{hide:nt(li)?.hide||Math.round(nt(li).value)!==nt(li).value}])]),tx(Xt,"clientHeight",Ai=>Yr(o,Ai)),gi(Rt,Xt)}),Ut(Fe);var Ye=zi(Fe,2),it=Ht(Ye),jt=zi(it,2);Gc(jt,17,()=>nt(k),jc,(Rt,li,Xt,Pt)=>{var Ai=_x(),rr=um(Ai);Gc(rr,17,()=>nt(li),jc,(Li,di)=>{var Bi=EN();Sn(jr=>Dg(Bi,jr),[()=>`background-color: ${ue(nt(di).activity)}; transform: translate(${re(nt(k).length,Xt)}px, ${Z(nt(di).start)}px); height: ${G(nt(di).start,nt(di).end)}px; width: ${ie(nt(k).length)}px`]),k2("mouseenter",Bi,()=>y.setHighlightedPolicyId(nt(di)?.policyId)),k2("mouseleave",Bi,()=>y.setHighlightedPolicyId(null)),gi(Li,Bi)}),gi(Rt,Ai)}),Ut(Ye),Ut(ze),Ut(Ae),Sn(()=>Dg(it,`padding: ${nt(o)/2}px 0px; height: calc(100% - ${nt(o)}px); transform: translate(0px, ${nt(o)/2}px)`)),tx(Ye,"clientWidth",Rt=>Yr(ee,Rt)),gi(Oe,Ae)};Fn(Te,Oe=>{nt(R)&&Oe(Le)})}Ut(ge),gi(m,ge),Mo()}var CN=Zi('<li class="svelte-ygzkja"><div class="policy-container svelte-ygzkja"><div> </div> <div class="last-updated svelte-ygzkja"> </div></div></li>'),MN=Zi('<div class="title svelte-ygzkja">Calendar</div> <!>',1),PN=Zi('<div class="Policies svelte-ygzkja"><div class="title svelte-ygzkja">Policies</div> <ul class="policies-list-container svelte-ygzkja"></ul> <!></div>');function LN(m,y){Co(y,!0);let b=ao(null);const S=Z=>{Yr(b,Z,!0)},M=Xr(()=>JSON.parse(JSON.stringify(y.policies))?.sort((Z,ee)=>Z.priority-ee.priority)),R=Z=>{const ee=new Date(Z),re={timeZone:"America/New_York",year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0};return ee.toLocaleString("en-US",re)};ms(()=>{if(nt(b)){const Z=document.getElementById(nt(b));Z&&Z.scrollIntoView({behavior:"smooth",block:"center"})}});var k=PN(),o=zi(Ht(k),2);Gc(o,21,()=>nt(M),jc,(Z,ee)=>{var ie=CN(),re=Ht(ie),ue=Ht(re),oe=Ht(ue,!0);Ut(ue);var ge=zi(ue,2),K=Ht(ge);Ut(ge),Ut(re),Ut(ie),Sn(Te=>{Hc(ie,"id",nt(ee)?.curb_policy_id),Ao(ue,1,Fo(["policy-text",{highlighted:nt(b)===nt(ee)?.curb_policy_id}]),"svelte-ygzkja"),Qo(oe,nt(ee)?.description??"No policy description provided."),Qo(K,`Last updated ${Te??""}`)},[()=>R(nt(ee)?.published_date)]),gi(Z,ie)}),Ut(o);var G=zi(o,2);EE(G,()=>y.curbZoneId,Z=>{var ee=_x(),ie=um(ee);{var re=ue=>{var oe=MN(),ge=zi(um(oe),2);AN(ge,{get policies(){return y.policies},setHighlightedPolicyId:S}),gi(ue,oe)};Fn(ie,ue=>{y.policies&&y.policies.length&&ue(re)})}gi(Z,ee)}),Ut(k),gi(m,k),Mo()}var RN=Zi('<li class="svelte-1n3jfo3"><div class="section svelte-1n3jfo3"><div class="list-item-key svelte-1n3jfo3"> </div> <div class="list-item-value svelte-1n3jfo3"> </div></div></li>'),DN=Zi('<div class="AdditionalInfo svelte-1n3jfo3"><div class="title svelte-1n3jfo3">Additional info</div> <ul class="info-list-container svelte-1n3jfo3"></ul></div>');function ON(m,y){Co(y,!0);const b=Xr(()=>{const R=y.properties?.jurisdiction_type?y.properties.jurisdiction_type.charAt(0).toUpperCase()+y.properties.jurisdiction_type.slice(1):null;let k=[];R&&(k=k.concat([{key:"Jurisdiction",value:R}]));const o=y.properties?.available?"Available":"Unavailable",G=y.properties?.num_spaces??0,Z=y.properties?.parking_angle,ee=y.properties?.street_side,ie=y.properties?.median,re=y.properties?.entire_roadway,ue=[{key:"Parking",value:o},...y.properties?.num_spaces||y.properties?.num_spaces===0?[{key:"Available spaces",value:G}]:[],...Z?[{key:"Parking angle",value:Z}]:[],...ee?[{key:"Street side",value:ee?"Yes":"No"}]:[],...ie?[{key:"Median",value:ie?"Yes":"No"}]:[],...re?[{key:"Entire roadway",value:re?"Yes":"No"}]:[]];return k=k.concat(ue),k});var S=DN(),M=zi(Ht(S),2);Gc(M,21,()=>nt(b),jc,(R,k)=>{var o=RN(),G=Ht(o),Z=Ht(G),ee=Ht(Z);Ut(Z);var ie=zi(Z,2),re=Ht(ie,!0);Ut(ie),Ut(G),Ut(o),Sn(()=>{Qo(ee,`${nt(k)?.key??""}:`),Qo(re,nt(k)?.value)}),gi(R,o)}),Ut(M),Ut(S),gi(m,S),Mo()}var zN=ks('<svg width="42" height="42" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.9785 5.52492C19.9785 6.35334 19.3069 7.02492 18.4785 7.02492H8C5.23858 7.02492 3 9.26349 3 12.0249V33.0249C3 35.7863 5.23858 38.0249 8 38.0249H29C31.7614 38.0249 34 35.7863 34 33.0249V22.5249C34 21.6965 34.6716 21.0249 35.5 21.0249C36.3284 21.0249 37 21.6965 37 22.5249V33.0249C37 37.305 33.6389 40.7997 29.4121 41.0142L29 41.0249H8L7.58789 41.0142C3.49764 40.8066 0.218304 37.5273 0.0107422 33.437L0 33.0249V12.0249C0 7.60664 3.58172 4.02492 8 4.02492H18.4785C19.3069 4.02492 19.9785 4.69649 19.9785 5.52492Z" fill="black"></path><path d="M39.0415 0C40.146 3.5403e-05 41.0412 0.895239 41.0412 1.99979V14.4998C41.0411 15.3281 40.3697 15.9997 39.5414 15.9997C38.7131 15.9997 38.0417 15.3281 38.0416 14.4998V4.84893L14.5462 28.3443C13.9604 28.9301 13.0106 28.93 12.4248 28.3443C11.839 27.7586 11.839 26.8088 12.4248 26.223L35.6482 2.99968H26.5414C25.7131 2.99968 25.0417 2.32812 25.0416 1.49984C25.0416 0.671413 25.713 0 26.5414 0H39.0415Z" fill="black"></path></svg>');function kN(m){var y=zN();gi(m,y)}var FN=Zi('<div class="PoliciesWrapper svelte-1856mk1"><div class="panels svelte-1856mk1"><button>Policies</button> <button>Additional info</button> <a class="panel-button streetview svelte-1856mk1" target="_blank">Street view <div class="link-out-icon svelte-1856mk1"><!></div></a></div> <!></div>');function BN(m,y){Co(y,!0);const b=Xr(()=>Oo.policies),S=Xr(()=>Oo.geometry),M=Xr(()=>Oo.properties);let R=Xr(()=>nt(M)?.curb_zone_id),k=ao("policies");const o=Xr(()=>{if(!nt(S))return null;const Oe={type:"Feature",geometry:nt(S)},Ae=FL(Oe,{units:"kilometers"});return MP(Oe,Ae/2,{units:"kilometers"}).geometry.coordinates}),G=Xr(()=>nt(o)?`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${nt(o)[1]},${nt(o)[0]}&heading=-45&pitch=0&fov=80`:null);var Z=FN(),ee=Ht(Z),ie=Ht(ee);ie.__click=()=>Yr(k,"policies");var re=zi(ie,2);re.__click=()=>Yr(k,"additional_info");var ue=zi(re,2),oe=zi(Ht(ue)),ge=Ht(oe);kN(ge),Ut(oe),Ut(ue),Ut(ee);var K=zi(ee,2);{var Te=Oe=>{LN(Oe,{get policies(){return nt(b)},get curbZoneId(){return nt(R)}})},Le=Oe=>{ON(Oe,{get properties(){return nt(M)}})};Fn(K,Oe=>{nt(k)==="policies"?Oe(Te):Oe(Le,!1)})}Ut(Z),Sn(()=>{Ao(ie,1,Fo(["panel-button",{active:nt(k)==="policies"}]),"svelte-1856mk1"),Ao(re,1,Fo(["panel-button",{active:nt(k)==="additional_info"}]),"svelte-1856mk1"),Hc(ue,"href",nt(G))}),gi(m,Z),Mo()}Fs(["click"]);const NN="/curb-atlas/_app/immutable/assets/low_res_digital_seal.5btuT0mZ.png";var VN=Zi('<div class="current-time-note svelte-cj3pec">Using current local time (EST)</div>'),UN=Zi('<div class="timeContainer svelte-cj3pec"><div class="day svelte-cj3pec"> </div> <div class="time svelte-cj3pec"> </div> <!></div>');function jN(m,y){Co(y,!0),ka(rn.day),ka(rn.time);let b=Xr(()=>rn.useCurrentTime),S=ao(null),M=ao(null),R=ao(null);const k=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],o=()=>{const ge=new Date,K={hour:"numeric",minute:"2-digit",timeZone:"America/New_York",hour12:!0},Te={hour:"numeric",minute:"2-digit",timeZone:"America/New_York",hour12:!1};Yr(M,ge.toLocaleTimeString("en-US",K),!0);const Le=ge.getDay();Yr(S,k[Le],!0);let Oe=ge.toLocaleTimeString("en-US",Te);Oe=Number(Oe.split(":")[0]),Oe===24&&(Oe=0);let Ae=ge.getMinutes();if(Ae===0||Ae===30){let Fe=Oe+(Ae===30?.5:0);rn.day=gM(nt(S)),rn.time=Fe}};ms(()=>{if(nt(b)){o();const K=60-new Date().getSeconds();K>0?setTimeout(()=>{o(),Yr(R,setInterval(o,6e4),!0)},K*1e3):Yr(R,setInterval(o,6e4),!0)}else nt(R)&&clearInterval(nt(R)),Yr(M,null),Yr(S,null)});var G=UN(),Z=Ht(G),ee=Ht(Z,!0);Ut(Z);var ie=zi(Z,2),re=Ht(ie,!0);Ut(ie);var ue=zi(ie,2);{var oe=ge=>{var K=VN();gi(ge,K)};Fn(ue,ge=>{nt(b)&&ge(oe)})}Ut(G),Sn((ge,K)=>{Qo(ee,ge),Qo(re,K)},[()=>nt(S)??_M(rn.day),()=>nt(M)??yM(rn.time)]),gi(m,G),Mo()}var GN=Zi("<div></div>");function qN(m,y){let b=Nc(y,"color",8,"#FF3E00"),S=Nc(y,"unit",8,"px"),M=Nc(y,"duration",8,"0.75s"),R=Nc(y,"size",8,"60"),k=Nc(y,"pause",8,!1);var o=GN();let G;Sn(()=>{G=Ao(o,1,"circle svelte-7w2xrx",null,G,{"pause-animation":k()}),Dg(o,`--size: ${R()??""}${S()??""}; --color: ${b()??""}; --duration: ${M()??""}`)}),gi(m,o)}var HN=Zi('<div class="loader svelte-li6gfl"><div class="container svelte-li6gfl"><!> <div class="text svelte-li6gfl"> </div></div></div>');function ZN(m,y){let b=Nc(y,"helperText",8);var S=HN(),M=Ht(S),R=Ht(M);qN(R,{size:"100",color:"white",unit:"px"});var k=zi(R,2),o=Ht(k,!0);Ut(k),Ut(M),Ut(S),Sn(()=>Qo(o,b()??"loading")),gi(m,S)}var $N=Zi('<div class="zoom-prompt svelte-1jr28bl">Zoom in to see or select curb zones</div>'),WN=Zi(`<div class="info-modal-screen-container svelte-1jr28bl"><button class="info-modal-backdrop svelte-1jr28bl"></button> <div class="info-modal svelte-1jr28bl" role="dialog"><button class="close-button svelte-1jr28bl"><!></button> <div class="info-modal-title svelte-1jr28bl">Chinatown Curb Map Demo</div> <div class="info-modal-body svelte-1jr28bl"><p>The data you see may be incomplete, outdated, or inaccurate. <strong>This tool is for informational purposes only and does not constitute official City
								of Boston guidance on parking or curb regulations.</strong> Always refer to posted signage when making parking decisions.</p> <p>For any questions or feedback - please reach out to us at <strong><a href="mailto:oet@boston.gov">oet@boston.gov</a></strong>.</p></div> <div class="info-modal-logo-container svelte-1jr28bl"><div class="info-modal-logo svelte-1jr28bl"><img alt="Boston Digital Seal" class="svelte-1jr28bl"/></div></div></div></div>`),XN=Zi('<div class="Frame svelte-1jr28bl"><div class="top-bar" role="banner"><!></div> <div class="map-container svelte-1jr28bl" role="main"><!> <!> <div class="top-left svelte-1jr28bl" role="navigation"><!></div> <div class="top-right svelte-1jr28bl"><!></div> <div class="bottom-row svelte-1jr28bl"><div class="button-container svelte-1jr28bl"><div class="button-container-section svelte-1jr28bl"><!> <!></div> <div class="button-container-section svelte-1jr28bl"><!></div></div></div> <!></div> <!></div>');function YN(m,y){Co(y,!0);let b=ao(!0),S=Xr(()=>Zt?.position?.zoom<Jl),M=ao(ka({filters:!1,time:!1,policies:!1})),R=Xr(()=>!!Oo?.policies);const k=Pt=>{Yr(M,Object.fromEntries(Object.entries(nt(M)).map(([Ai,rr])=>Ai===Pt?[Ai,!rr]:[Ai,!1])),!0)};ms(()=>{nt(R)?ra(()=>{nt(M).policies=!0}):ra(()=>{nt(M).policies=!1})});var o=XN(),G=Ht(o),Z=Ht(G);YL(Z,{onClickInfo:()=>Yr(b,!nt(b))}),Ut(G);var ee=zi(G,2),ie=Ht(ee);$L(ie,{});var re=zi(ie,2);{var ue=Pt=>{var Ai=$N();gi(Pt,Ai)};Fn(re,Pt=>{nt(S)&&Pt(ue)})}var oe=zi(re,2),ge=Ht(oe);lN(ge,{}),Ut(oe);var K=zi(oe,2),Te=Ht(K);jN(Te,{}),Ut(K);var Le=zi(K,2),Oe=Ht(Le),Ae=Ht(Oe),ze=Ht(Ae);_0(ze,{label:"Set Filters",setOpen:()=>k("filters"),get open(){return nt(M).filters},children:(Pt,Ai)=>{gN(Pt,{})},$$slots:{default:!0}});var Fe=zi(ze,2);_0(Fe,{label:"Set Time",setOpen:()=>k("time"),get open(){return nt(M).time},children:(Pt,Ai)=>{bN(Pt,{})},$$slots:{default:!0}}),Ut(Ae);var Ye=zi(Ae,2),it=Ht(Ye);{let Pt=Xr(()=>!nt(R));_0(it,{label:"See Policies",setOpen:()=>k("policies"),get open(){return nt(M).policies},position:"right",get disabled(){return nt(Pt)},theme:"light",children:(Ai,rr)=>{BN(Ai,{})},$$slots:{default:!0}})}Ut(Ye),Ut(Oe),Ut(Le);var jt=zi(Le,2);{var Rt=Pt=>{var Ai=WN(),rr=Ht(Ai);rr.__click=()=>Yr(b,!1);var Li=zi(rr,2),di=Ht(Li);di.__click=()=>Yr(b,!1);var Bi=Ht(di);Ox(Bi),Ut(di);var jr=zi(di,6),Ln=Ht(jr),Nn=Ht(Ln);Ut(Ln),Ut(jr),Ut(Li),Ut(Ai),Sn(()=>Hc(Nn,"src",NN)),gi(Pt,Ai)};Fn(jt,Pt=>{nt(b)&&Pt(Rt)})}Ut(ee);var li=zi(ee,2);{var Xt=Pt=>{ZN(Pt,{})};Fn(li,Pt=>{hm.loading&&Pt(Xt)})}Ut(o),gi(m,o),Mo()}Fs(["click"]);var JN=Zi('<div class="beta-banner svelte-pcijk"><span class="beta-tag svelte-pcijk">BETA</span> <span class="beta-text svelte-pcijk">This map is still in development. See something missing?</span> <a class="beta-link svelte-pcijk" href="mailto:emergingtechnology@boston.gov?subject=Curb%20Atlas%20Feedback">Share Your Feedback</a></div>');function KN(m){var y=JN();gi(m,y)}const kS=["geocoder","filter","selectedArea","time","position"],QN=m=>{const y=m.replace("#","");return decodeURIComponent(y).split("&").reduce((M,R)=>{let[k,o]=R.split("=");return kS.includes(k)&&(o=JSON.parse(o)),M[k]=o,M},{})},e8=m=>{const{mapState:y,geocoderState:b,filterState:S,selectedAreaState:M,selectedCurbZoneState:R,timeState:k}=m,o=JSON.stringify(RE)===JSON.stringify(S?.current);let G={geocoder:b?.results,...!o&&{filter:S?.current},...M?.type&&{selectedArea:{type:M?.type,...M?.type==="area"&&{bbox:sa(M?.selected)},...M?.type==="radius"&&{radius:M?.radius}}},time:k,...R?.properties?.curb_zone_id&&{selectedCurbZone:R?.properties?.curb_zone_id},position:y?.position};G=Object.fromEntries(Object.entries(G).map(([ee,ie])=>ie?[ee,ie]:!1).filter(Boolean));const Z=Object.entries(G).map(([ee,ie])=>{const re=kS.includes(ee)?JSON.stringify(ie):ie;return`${ee}=${encodeURIComponent(re)}`}).join("&");window.location.replace(`${window.location.pathname}#${Z}`)};var t8=Zi("<!> <!>",1),i8=Zi('<div class="App svelte-nejbyb"><!></div>');function r8(m,y){Co(y,!0);let b=ao(!1);const S=ME(()=>{e8({selectedAreaState:gr,geocoderState:ko,filterState:Hd,selectedCurbZoneState:Oo,timeState:rn,mapState:Zt})},ix);ms(()=>{gr.selected,ko.results,Hd.current,Oo.properties,rn.day,rn.time,rn.useCurrentTime,Zt.position,ra(()=>nt(b))&&S()}),qg(()=>{const o=QN(window.location.hash);if(o?.geocoder&&(ko.results=o?.geocoder),o?.filter&&(Hd.current=o?.filter),o?.time){const{time:G,day:Z,useCurrentTime:ee}=o?.time;rn.time=G,rn.day=Z,rn.useCurrentTime=ee}if(o?.selectedCurbZone&&(Oo.id=o?.selectedCurbZone),o?.selectedArea){let{type:G}=o?.selectedArea;switch(gr.type=G,G){case"area":{const Z=o?.selectedArea?.bbox,ee=cS(Z);gr.selected=ee;break}case"radius":{gr.radius=o?.selectedArea?.radius;break}}}o?.position&&(Zt.position=o?.position),setTimeout(()=>Yr(b,!0),ix)});var M=i8(),R=Ht(M);{var k=o=>{var G=t8(),Z=um(G);KN(Z);var ee=zi(Z,2);YN(ee,{}),gi(o,G)};Fn(R,o=>{nt(b)&&o(k)})}Ut(M),gi(m,M),Mo()}var n8=Zi('<meta name="description" content="Boston Curb Atlas - Chinatown Preview"/>'),o8=Zi("<div><!></div>");function m8(m){var y=o8();KC("1uha8ag",S=>{var M=n8();vx(()=>{HC.title="Boston Curb Atlas - Chinatown Preview"}),gi(S,M)});var b=Ht(y);r8(b,{}),Ut(y),gi(m,y)}export{m8 as component};
